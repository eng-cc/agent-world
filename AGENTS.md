## 开发工作流
1. 拿到仓库时先阅读开发日志和项目管理文档，了解现状
  1.1 设计文档写在当前设计涉及的最外层文件夹的 doc 文件夹下，格式为 md
  1.2 项目管理文档也写在当前设计涉及的最外层文件夹的 doc 文件夹下，文件名为 设计文档名称.project.md
  1.3 设计文档至少包含:目标、范围、接口/数据、里程碑、风险（可简要）
  1.4 项目管理文档至少包含:任务拆解、依赖、状态（可简要）
2. 如果是新功能要先写设计文档，再根据设计文档拆解项目管理文档(拆成具体任务)
3. 根据拆解好的任务写代码、跑测试，每次完成一个任务
4. 每次改完代码必须回顾设计文档和项目管理文档，并更新项目管理文档
5. 检查单个rust代码文件不能超过1200行，单个md文档不能超过500行，需要择机拆分模块和文件夹
6. 每个任务(指项目文档里拆解的任务)完成后都需要写任务日志，跑测试，并提交到git
  6.1 任务日志写在当前设计涉及的最外层文件夹的 doc/devlog 文件夹下,文件名为年-月-日.md
  6.2 任务日志应包含:日期(需要每次任务确认下当前日期)、完成内容、遗留事项；日志需要保障符合当天实际，后续不能修改
  6.3 每个任务一个commit，及时提交
7. 只要当前项目管理文档中还有后续任务就不要中断，开始下一个任务即可

## 工程架构
- 本仓库内所有新功能必须包含:设计文档、项目管理文档、代码
- third_party下面的代码只可读，不能写
- 执行cargo命令需要如下形式 env -u RUSTC_WRAPPER cargo check
- 所有代码和功能(包括UI)应该都是可以被测试的，单元测试或者模拟闭环测试都可以

## Agent 专用：UI 截图闭环调试（给 Codex 用，优先脚本）
- 目标：在无法直接“看实时窗口”时，完成 `运行程序 -> 保存截图 -> 读取截图 -> 继续调试` 的闭环。
- 适用场景：`agent_world_viewer` 可视化问题定位（黑屏、布局、相机交互、文本状态等）。
- 说明：此流程主要给 agent 使用，人类开发者可忽略。

### 标准流程（优先使用脚本）
1) 一键脚本（默认会先清空 `.tmp/`）：
   `./scripts/capture-viewer-frame.sh`
2) 可选参数：
   `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 8`

### 手动流程（Xvfb + ffmpeg）
1) 启动 live server（示例）：
   `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --tick-ms 300`
2) 启动虚拟显示：
   `Xvfb :100 -screen 0 1280x800x24`
3) 启动 viewer（使用同一 DISPLAY）：
   `DISPLAY=:100 env -u RUSTC_WRAPPER cargo run -p agent_world_viewer -- 127.0.0.1:5023`
4) 抓图（root 或窗口区域）：
   - root：`ffmpeg -y -f x11grab -video_size 1280x800 -i :100.0 -frames:v 1 .tmp/screens/root.png`
   - 窗口：先用 `xwininfo -root -tree` 找窗口坐标，再用 `ffmpeg -f x11grab -i :100.0+X,Y ...`
5) agent 读取图片并分析，再继续改代码。

### 推荐约定
- 临时产物统一放在 `.tmp/screens/`（日志、截图、窗口几何）；默认每次新调试前由脚本清空 `.tmp/`。
- 每次调试结束清理后台进程（viewer/server/Xvfb），避免端口或 DISPLAY 冲突。
- 若截图全黑，优先排查：
  - 抓图时机过早（应用未首帧渲染）
  - 抓到错误窗口/错误坐标
  - 图形后端为软件渲染导致首帧慢（可适当延长等待）
- 若能拿到截图但无法自动输入，允许先用“静态多帧截图 + 日志”定位，再决定是否加程序内调试面板。
