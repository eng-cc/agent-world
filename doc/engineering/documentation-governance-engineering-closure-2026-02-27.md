# 文档治理工程化全量优化（2026-02-27）

## 目标
- 将当前“依赖人工约定”的文档治理升级为“可自动检查、可持续执行、可在 CI 门禁生效”的工程化机制。
- 全量清理非归档文档中的环境相关绝对路径，统一为仓库相对路径口径，降低跨机器协作成本。
- 为设计文档/项目管理文档建立最小结构约束（必备章节）与行数约束检查，防止后续文档再次漂移。

## 范围

### In Scope
- 新增文档治理检查脚本（shell），支持本地与 CI 执行。
- 检查规则覆盖：
  - 设计文档必备章节：`目标`、`范围`、`接口/数据`、`里程碑`、`风险`
  - 项目管理文档必备章节：`任务拆解`、`依赖`、`状态`
  - 非归档非 devlog 文档禁止出现指向本仓库的绝对路径（如 `<ABS_ROOT>/agent-world/...`）
  - 非归档非 devlog 文档单文件行数上限 500
- 全量修复非归档文档中的历史绝对路径。
- 将文档治理检查接入 `scripts/ci-tests.sh`，并同步 `testing-manual.md`。

### Out of Scope
- 不修改 `doc/devlog/` 历史记录内容（遵循任务日志“后续不改”原则）。
- 不清理 `doc/**/archive/` 历史归档文档（仅作为历史保留）。
- 不在本轮引入外部 lint 框架（如 Node/Python 依赖），保持仓库原生 shell 可执行。

## 接口/数据

### 新增脚本接口
- `scripts/doc-governance-check.sh`
  - 默认模式：执行全量检查，发现问题即非零退出。
  - 输出：按规则分组列出违规文件与行号，最终返回统一失败摘要。

### 检查数据源
- 文档集合：`doc/**/*.md`（排除 `doc/devlog/**` 与 `doc/**/archive/**`）。
- 设计文档集合：存在同名 `.project.md` 配对的设计文档。
- 项目文档集合：`doc/**/*.project.md`（排除 archive）。

### 关键正则口径
- 绝对路径违规：仅针对用户主目录下的环境相关绝对路径前缀（如 `<ABS_HOME>/...`）。
- 章节检查：使用标题关键字匹配，兼容常见空格变体（如 `接口 / 数据`）。

## 里程碑
- M0：完成设计文档与项目管理文档建档。
- M1：落地文档治理检查脚本并本地验证。
- M2：完成非归档文档绝对路径全量修复。
- M3：接入 CI 测试脚本与手册，形成持续门禁。
- M4：回归验证、项目文档收口与 devlog 记录完成。

## 风险
- 历史文档命名/格式多样，章节关键字匹配可能出现误报；需通过白名单与正则收敛控制。
- 批量替换路径存在误替换风险；需先统计再执行，并以 `git diff` 复核。
- 接入 CI 后会提升门禁严格度，短期内可能暴露更多历史问题；需一次性清理后再固化规则。
