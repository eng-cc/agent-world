# 2026-02-23

- 时刻：2026-02-23 00:05:39 CST
- 完成内容：完成“Runtime 节点高度/Slot 递进与复制补洞数值语义硬化（15 点清单第三阶段）”T2（快照恢复边界与测试）。
  - `PosNodeEngine::restore_state_snapshot` 改为 `Result` 返回：
    - `committed_height + 1` 改为受检后继值，越界时返回 `NodeError::Replication`。
    - 保持“先计算校验、后状态写入”，保证溢出失败时不出现半恢复状态。
  - `NodeRuntime::start` 在读取到 snapshot 后对恢复错误显式失败并停止启动流程。
  - 新增测试：
    - `pos_engine_restore_state_snapshot_rejects_overflow_without_partial_state`
    - `runtime_start_fails_when_pos_state_snapshot_height_overflows`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node pos_engine_restore_state_snapshot_rejects_overflow_without_partial_state -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_start_fails_when_pos_state_snapshot_height_overflows -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T3：完成阶段回归收口并关闭 phase3 文档状态。

- 时刻：2026-02-23 00:08:48 CST
- 完成内容：完成“Runtime 节点高度/Slot 递进与复制补洞数值语义硬化（15 点清单第三阶段）”T3（回归与收口）。
  - Phase3 关键改造（高度/slot 递进 + 快照恢复）在提交门禁中完成 required-tier 全量回归并通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（第三阶段任务闭环完成）。

- 时刻：2026-02-23 00:22:57 CST
- 完成内容：完成“Runtime Replication Writer Epoch/Sequence 数值语义硬化（15 点清单第四阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase4.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase4.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 replication writer 位置递进的受检溢出语义改造与边界测试。

- 时刻：2026-02-23 00:26:25 CST
- 完成内容：完成“Runtime Replication Writer Epoch/Sequence 数值语义硬化（15 点清单第四阶段）”T1（writer 递进显式溢出语义）。
  - `ReplicationRuntime::next_local_record_position` 改为 `Result`：
    - 同 writer 的 `sequence + 1` 改为受检后继值；
    - writer 切换时 `writer_epoch + 1` 改为受检后继值；
    - 无 guard writer 场景的 `sequence + 1` 改为受检后继值。
  - `build_local_commit_message` 对 writer 位置计算错误改为显式透传，拒绝静默饱和。
  - `recent_replicated_content_hashes` 去除不必要饱和减法，使用确定安全的递减语义。
  - 新增 replication 单测：
    - `next_local_record_position_rejects_sequence_overflow_for_existing_writer`
    - `next_local_record_position_rejects_writer_epoch_overflow_on_writer_switch`
    - `next_local_record_position_rejects_sequence_overflow_without_guard_writer`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node next_local_record_position_rejects_sequence_overflow_for_existing_writer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node next_local_record_position_rejects_writer_epoch_overflow_on_writer_switch -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node next_local_record_position_rejects_sequence_overflow_without_guard_writer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T2：完成阶段回归收口并关闭 phase4 文档状态。

- 时刻：2026-02-23 00:28:30 CST
- 完成内容：完成“Runtime Replication Writer Epoch/Sequence 数值语义硬化（15 点清单第四阶段）”T2（回归与收口）。
  - phase4 关键改造（writer `epoch/sequence` 递进显式溢出语义）已在提交门禁中通过 required-tier 全量回归。
  - 回写设计文档状态：M0~M2 全部完成。
  - 回写项目管理文档状态：T0~T2 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（第四阶段任务闭环完成）。

- 时刻：2026-02-23 00:34:22 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase5.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase5.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `sequencer_mainloop` 高度/slot 递进的受检溢出语义改造与测试。

- 时刻：2026-02-23 00:36:48 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T1（Sequencer 递进显式溢出语义）。
  - `sequencer_mainloop` 中 `next_slot` 递进改为受检后继值，溢出时返回 `WorldError::DistributedValidationFailed`。
  - `apply_finalized_status` 改为可失败接口：`Committed/Rejected` 的 `next_height` 递进改为受检后继值，拒绝静默饱和。
  - 新增 sequencer 单测：
    - `sequencer_tick_rejects_slot_overflow_without_partial_state`
    - `sequencer_tick_rejects_height_overflow_without_partial_state`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus sequencer_mainloop::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `lease` 的 term/ttl 递进受检语义改造与边界测试。

- 时刻：2026-02-23 00:40:13 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T2（Lease 递进显式溢出语义）。
  - `lease::try_acquire` 中 `next_term` 与 `expires_at_ms` 递进改为受检语义，越界返回拒绝决策并保持状态不变。
  - `lease::renew` 的 `expires_at_ms` 递进改为受检语义，越界时拒绝续租且不污染现有 lease。
  - 新增 lease 单测：
    - `try_acquire_rejects_term_overflow_without_mutation`
    - `try_acquire_rejects_expiry_overflow_without_mutation`
    - `renew_rejects_expiry_overflow_without_mutation`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus lease::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：完成 phase5 回归收口并关闭文档状态。

- 时刻：2026-02-23 00:43:04 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T3（回归与收口）。
  - `agent_world_consensus` 定向回归通过，phase5 新增边界用例全部通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第五阶段任务闭环完成）。

- 时刻：2026-02-23 00:47:49 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase6.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase6.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 membership 协调器 lease 到期时间受检加法改造与溢出测试。

- 时刻：2026-02-23 00:51:44 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T1（coordinator lease 受检加法）。
  - `InMemoryMembershipRevocationScheduleCoordinator::acquire` 的 `expires_at_ms` 从 `saturating_add` 改为受检加法，溢出返回 `WorldError::DistributedValidationFailed`。
  - `StoreBackedMembershipRevocationScheduleCoordinator::acquire` 的 `expires_at_ms` 从 `saturating_add` 改为受检加法，溢出返回 `WorldError::DistributedValidationFailed`。
  - 新增统一错误语义 helper：`membership revocation coordinator lease expiry overflow`。
  - 新增边界测试：
    - `in_memory_schedule_coordinator_rejects_expiry_overflow_without_mutation`
    - `store_backed_schedule_coordinator_rejects_expiry_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus in_memory_schedule_coordinator_rejects_expiry_overflow_without_mutation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus store_backed_schedule_coordinator_rejects_expiry_overflow_without_mutation -- --nocapture`
- 遗留事项：
  - 执行 T2：收口 phase6 范围内 `as_millis() as i64` 窄化转换并补边界测试。

- 时刻：2026-02-23 00:57:42 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T2（时间源窄化受检转换）。
  - 收口 phase6 范围内 `as_millis() as i64` 风险点（consensus/net/node）：
    - `crates/agent_world_net/src/dht.rs`
    - `crates/agent_world_net/src/provider_cache.rs`
    - `crates/agent_world_net/src/gateway.rs`
    - `crates/agent_world_net/src/index_store.rs`
    - `crates/agent_world_net/src/dht_cache.rs`
    - `crates/agent_world_net/src/libp2p_net.rs`
    - `crates/agent_world_consensus/src/dht.rs`
    - `crates/agent_world_node/src/runtime_util.rs`
  - 统一改为受检转换 + 上限夹逼语义（`i64::try_from(duration.as_millis()).unwrap_or(i64::MAX)`），避免隐式窄化截断。
  - 新增超大 `Duration` 边界测试：
    - `agent_world_net::util::tests::duration_millis_to_i64_saturating_clamps_overflow_to_i64_max`
    - `agent_world_consensus::dht::tests::duration_millis_to_i64_saturating_clamps_on_overflow`
    - `agent_world_node::runtime_util::tests::duration_millis_to_i64_saturating_clamps_on_overflow`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net util::tests::duration_millis_to_i64_saturating_clamps_overflow_to_i64_max -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus dht::tests::duration_millis_to_i64_saturating_clamps_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_util::tests::duration_millis_to_i64_saturating_clamps_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T3：完成 phase6 回归收口并关闭文档状态。

- 时刻：2026-02-23 01:00:53 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T3（回归与收口）。
  - `agent_world_consensus`、`agent_world_net`、`agent_world_node` 定向回归通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 无（第六阶段任务闭环完成）。

- 时刻：2026-02-23 01:05:37 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase7.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase7.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 PoS 超多数比率判定从饱和乘法到无溢出判定的三处同步改造。

- 时刻：2026-02-23 01:10:23 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T1（比率判定去饱和化）。
  - `agent_world_proto::distributed_pos::required_supermajority_stake` 将 `numerator.saturating_mul(2) <= denominator` 改为 `numerator <= denominator / 2`。
  - `agent_world_consensus::PosConsensus::new` 同步改为无溢出比率判定。
  - `agent_world_node::pos_validation::validated_pos_state` 同步改为无溢出比率判定。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto required_supermajority_rounds_up -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus pos::tests::pos_commit_requires_supermajority_stake -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_action_payload::config_rejects_invalid_pos_config -- --nocapture`
- 遗留事项：
  - 执行 T2：补齐超大分母/分子边界用例，验证 proto/consensus/node 三层一致性。

- 时刻：2026-02-23 01:16:37 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T2（边界测试补齐）。
  - 新增 `denominator = u64::MAX`、`numerator = denominator / 2 + 1` 边界用例，验证“略大于 1/2”不会被误拒绝：
    - `agent_world_proto::distributed_pos::tests::required_supermajority_accepts_extreme_ratio_just_above_half`
    - `agent_world_consensus::pos::tests::pos_accepts_extreme_supermajority_ratio_just_above_half`
    - `agent_world_node::tests_action_payload::config_accepts_extreme_supermajority_ratio_just_above_half`
  - 三层行为一致性确认：上述输入在 proto/consensus/node 均可通过校验，未出现乘法溢出导致的误拒绝。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto required_supermajority_accepts_extreme_ratio_just_above_half -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus pos::tests::pos_accepts_extreme_supermajority_ratio_just_above_half -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_action_payload::config_accepts_extreme_supermajority_ratio_just_above_half -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 phase7 回归测试并完成文档收口。

- 时刻：2026-02-23 01:19:51 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T3（回归与收口）。
  - 执行 `agent_world_proto`、`agent_world_consensus`、`agent_world_node` 回归测试并全部通过（`agent_world_node --lib` 首轮出现单测波动，定向复跑与二次全量复跑均通过）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`（首轮 1 例波动失败）
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests::runtime_replication_storage_challenge_gate_blocks_on_local_probe_failure -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`（二次全量复跑通过）
- 遗留事项：
  - 无（第七阶段任务闭环完成）。

- 时刻：2026-02-23 01:23:54 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase8.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase8.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `with_retry_failure` 重试计数与回退时间的受检递进改造并补边界测试。

- 时刻：2026-02-23 01:27:28 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T1（重试递进受检语义）。
  - `MembershipRevocationPendingAlert::with_retry_failure` 从饱和递进改为受检递进：
    - `attempt` 使用 `checked_add`，越界返回 `WorldError::DistributedValidationFailed`；
    - `next_retry_at_ms` 使用 `checked_add`，越界返回 `WorldError::DistributedValidationFailed`。
  - `membership_recovery/mod.rs` ACK 重试路径接线可失败语义，越界失败直接透传错误，避免静默夹逼继续执行。
  - 新增边界测试：
    - `membership_recovery::types::tests::with_retry_failure_rejects_attempt_overflow`
    - `membership_recovery::types::tests::with_retry_failure_rejects_retry_timestamp_overflow`
    - `membership_recovery_tests::emit_revocation_reconcile_alerts_with_ack_retry_rejects_retry_timestamp_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::types::tests::with_retry_failure_rejects_attempt_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::types::tests::with_retry_failure_rejects_retry_timestamp_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus emit_revocation_reconcile_alerts_with_ack_retry_rejects_retry_timestamp_overflow_without_mutation -- --nocapture`
- 遗留事项：
  - 执行 T2：完成自适应策略阈值/比率去饱和化改造与大整数边界测试。

- 时刻：2026-02-23 01:32:07 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T2（自适应策略阈值/比率去饱和化）。
  - `membership_recovery/replay.rs` 中高风险乘法判定去饱和化：
    - `high_backlog` 与 `retry_backlog vs capacity_backlog` 的 `*2` 阈值比较改为基于 `u128` 的无溢出比较；
    - `ratio_per_mille` 从 `saturating_mul(1000)` 改为 `u128` 精确计算后受检收窄，避免先饱和后除法导致的比率失真。
  - 新增边界测试：
    - `membership_recovery::replay::tests::ratio_per_mille_handles_extreme_values_without_saturation_distortion`
    - `membership_recovery::replay::tests::exceeds_double_handles_extreme_values_without_overflow`
    - `membership_dead_letter_replay_tests::recommend_replay_policy_uses_large_ratio_without_saturation_distortion`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::replay::tests::ratio_per_mille_handles_extreme_values_without_saturation_distortion -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::replay::tests::exceeds_double_handles_extreme_values_without_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus recommend_replay_policy_uses_large_ratio_without_saturation_distortion -- --nocapture`
- 遗留事项：
  - 执行 T3：完成 phase8 回归测试与文档收口。

- 时刻：2026-02-23 01:35:01 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T3（回归与收口）。
  - `agent_world_consensus` 回归测试通过（包含 phase8 新增边界用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第八阶段任务闭环完成）。

- 时刻：2026-02-23 01:40:58 CST
- 完成内容：完成“Runtime Governance Drill/Retention 时间算术数值语义硬化（15 点清单第九阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase9.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase9.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 governance drill/retention 时间算术受检语义改造与边界测试。

- 时刻：2026-02-23 01:44:17 CST
- 完成内容：完成“Runtime Governance Drill/Retention 时间算术数值语义硬化（15 点清单第九阶段）”T1（调度与保留时间算术受检化）。
  - `membership_recovery/replay_archive.rs`：
    - drill schedule 的 `elapsed` 与 `next_due_at_ms` 计算改为受检算术，溢出返回 `WorldError::DistributedValidationFailed`；
    - audit retention 的 `age` 计算改为受检减法，溢出显式失败。
  - 新增边界测试并验证失败不污染状态：
    - `membership_dead_letter_replay_archive_tests::governance_audit_archive_prune_rejects_age_overflow_without_mutation`
    - `membership_dead_letter_replay_archive_tests::governance_recovery_drill_schedule_rejects_next_due_overflow_without_mutation`
    - 保持行为回归：`membership_dead_letter_replay_archive_tests::governance_recovery_drill_schedule_executes_when_due_and_persists_state`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_audit_archive_prune_rejects_age_overflow_without_mutation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_recovery_drill_schedule_rejects_next_due_overflow_without_mutation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_recovery_drill_schedule_executes_when_due_and_persists_state -- --nocapture`
- 遗留事项：
  - 执行 T2：运行 phase9 回归测试并完成文档收口。

- 时刻：2026-02-23 01:47:06 CST
- 完成内容：完成“Runtime Governance Drill/Retention 时间算术数值语义硬化（15 点清单第九阶段）”T2（回归与收口）。
  - `agent_world_consensus` 定向回归测试通过（包含 phase9 新增边界用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T2 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第九阶段任务闭环完成）。

- 时刻：2026-02-23 01:50:34 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase10.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase10.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 tiered offload/drill alert 时间差与计数路径的受检算术改造及边界测试。

- 时刻：2026-02-23 01:54:42 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T1（Tiered Offload/Drill Alert 受检化）。
  - `membership_recovery/replay_archive_tiered.rs`：
    - tiered offload 的 `now_ms - audited_at_ms` 改为受检减法，溢出显式返回 `WorldError::DistributedValidationFailed`；
    - drill alert 的 silence/cooldown 时间差改为受检减法，拒绝极端边界时间回退；
    - `plan_governance_audit_tiered_offload` / `evaluate_recovery_drill_alert_reasons` 改为可失败返回并沿调用链透传。
  - 去除不必要的 `saturating_add/sub` 计数语义，改为在既有边界约束下的确定性递减/递增。
  - 新增边界测试并验证失败不污染状态：
    - `governance_audit_tiered_offload_rejects_age_overflow_without_mutation`
    - `governance_recovery_drill_alert_rejects_silence_age_overflow_without_mutation`
    - `governance_recovery_drill_alert_rejects_cooldown_age_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_audit_tiered_offload_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_recovery_drill_alert_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_archive_tiered_offload_drill_alert_orchestration_runs_end_to_end -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `replay_audit` 的 rollback streak 与 rollback alert 时间差受检算术改造及边界测试。

- 时刻：2026-02-23 02:00:41 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T2（Rollback Audit/Governance 受检化）。
  - `membership_recovery/replay_audit.rs`：
    - `apply_dead_letter_replay_rollback_governance_policy` 的 `rollback_streak` 从饱和递进改为受检加法，越界显式返回 `WorldError::DistributedValidationFailed`；
    - `emit_dead_letter_replay_rollback_alert_if_needed` 的 rollback window/cooldown 时间差从饱和减法改为受检减法，拒绝极端时间边界失真。
  - 新增边界测试并验证失败不污染关键状态：
    - `run_with_audit_rejects_rollback_window_age_overflow_without_mutating_alert_state`
    - `run_with_audit_rejects_cooldown_age_overflow_without_mutating_alert_state`
    - `run_with_governance_archive_rejects_rollback_streak_overflow_without_mutation`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_with_audit_rejects_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_with_governance_archive_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_with_audit_emits_rollback_alert_and_honors_cooldown -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase10 文档收口。

- 时刻：2026-02-23 02:04:01 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T3（回归与收口）。
  - `agent_world_consensus` 定向回归测试通过（包含 phase10 新增边界用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第十阶段任务闭环完成）。

- 时刻：2026-02-23 02:06:53 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase11.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase11.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 replay 调度间隔与 policy cooldown 时间门控受检算术改造及边界测试。

- 时刻：2026-02-23 02:09:52 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T1（调度与策略冷却门控受检化）。
  - `membership_recovery/replay.rs`：
    - `run_revocation_dead_letter_replay_schedule_with_state_store` 的 interval gate 从 `saturating_sub` 改为受检减法；
    - `recommend_revocation_dead_letter_replay_policy_with_adaptive_guard` 的 policy cooldown 从 `saturating_sub` 改为受检减法；
    - 时间差溢出统一返回 `WorldError::DistributedValidationFailed`，包含 `now_ms/last_replay_at_ms` 上下文。
  - 新增边界测试并验证失败不污染 replay state：
    - `run_replay_schedule_with_state_store_rejects_interval_overflow_without_mutation`
    - `recommend_guarded_policy_rejects_cooldown_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_replay_schedule_with_state_store_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus recommend_guarded_policy_ -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 rollback cooldown 门控受检算术改造并补 persistence 侧边界测试。

- 时刻：2026-02-23 02:14:49 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T2（rollback 冷却门控受检化）。
  - `membership_recovery/replay.rs`：
    - `should_rollback_to_stable_policy` 从布尔返回升级为 `Result<bool, WorldError>`；
    - rollback cooldown 时间差从 `saturating_sub` 改为受检减法，溢出统一返回 `WorldError::DistributedValidationFailed` 并携带 `now_ms/last_rollback_at_ms` 上下文；
    - 持久化调用链 `recommend_revocation_dead_letter_replay_policy_with_persistence_and_rollback_guard` 透传错误，确保失败发生在 `save_policy_state` 前。
  - 新增 persistence 边界测试并验证失败不污染 policy state：
    - `recommend_with_persistence_rejects_rollback_cooldown_overflow_without_partial_update`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus recommend_with_persistence_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_coordinated_replay_with_persisted_guarded_policy_reports_rollback -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase11 文档收口。

- 时刻：2026-02-23 02:18:00 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T3（回归与收口）。
  - `agent_world_consensus` 定向回归测试通过（包含 phase11 新增 rollback cooldown overflow 用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第十一阶段任务闭环完成）。

- 时刻：2026-02-23 02:21:36 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase12.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase12.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `run_revocation_dead_letter_replay_schedule` 时间门控受检算术改造与边界测试。

- 时刻：2026-02-23 02:24:30 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T1（调度时间门控受检化）。
  - `membership_recovery/mod.rs`：
    - `run_revocation_dead_letter_replay_schedule` 的 interval gate 从 `saturating_sub` 改为受检减法；
    - 时间差溢出统一返回 `WorldError::DistributedValidationFailed`，包含 `now_ms/last_replay_at_ms` 上下文。
  - 新增边界测试并验证失败不污染状态：
    - `run_revocation_dead_letter_replay_schedule_rejects_interval_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_revocation_dead_letter_replay_schedule_ -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 recovery 计数/容量受检算术改造并补边界测试。

- 时刻：2026-02-23 02:29:54 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T2（recovery 计数/容量受检化）。
  - `membership_recovery/mod.rs`：
    - `emit_revocation_reconcile_alerts_with_recovery_and_ack_retry_with_dead_letter` 中 buffered capacity 与关键计数字段累加从饱和语义改为受检语义；
    - 新增统一 helper：`checked_usize_add`/`checked_usize_increment`，越界统一返回 `WorldError::DistributedValidationFailed`；
    - `archive_dead_letter` 调整为“先受检递进、后 append”，避免 overflow 时 dead-letter 发生部分写入。
  - 新增模块内边界测试并验证失败不污染 dead-letter 状态：
    - `membership_recovery::tests::checked_usize_add_rejects_overflow`
    - `membership_recovery::tests::archive_dead_letter_rejects_dead_lettered_overflow_without_mutation`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus emit_revocation_reconcile_alerts_with_ack_retry_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_revocation_dead_letter_replay_schedule_ -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase12 文档收口。

- 时刻：2026-02-23 02:34:26 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T3（回归与收口）。
  - `agent_world_consensus --lib` 回归通过（171 tests passed）。
  - 清理 `membership_recovery/mod.rs` 的 unused import warning（将 `MembershipRevocationAlertSeverity` 仅保留在 `#[cfg(test)]` 测试模块内）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 进入第十三阶段（继续 15 点清单）。

- 时刻：2026-02-23 02:38:55 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase13.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase13.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `schedule_due` 与 `deduplicate_revocation_alerts` 时间门控受检算术改造并补边界测试。

- 时刻：2026-02-23 02:41:38 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T1（调度与 dedup 时间门控受检化）。
  - `membership_reconciliation.rs`：
    - `schedule_due` 从布尔返回升级为 `Result<bool, WorldError>`，时间差从 `saturating_sub` 改为受检减法；
    - `deduplicate_revocation_alerts` 的 suppress window 时间差从 `saturating_sub` 改为受检减法；
    - 新增统一时间差 helper，溢出统一返回 `WorldError::DistributedValidationFailed` 并带 `now_ms/last_run_ms` 上下文。
  - 新增边界测试并验证失败不污染状态：
    - `run_revocation_reconcile_schedule_rejects_interval_overflow_without_mutation`
    - `deduplicate_revocation_alerts_rejects_suppress_window_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_reconciliation_tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `reconcile_revocations_with_policy` 关键计数受检改造并补 overflow 测试。

- 时刻：2026-02-23 02:45:48 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T2（对账报告计数受检化）。
  - `membership_reconciliation.rs`：
    - `reconcile_revocations_with_policy` 的 `rejected/in_sync/diverged/merged` 累加从饱和语义改为受检语义；
    - 新增 `checked_usize_add` / `checked_usize_increment`，越界统一返回 `WorldError::DistributedValidationFailed`。
  - 新增模块内边界测试：
    - `membership_reconciliation::tests::checked_usize_add_rejects_overflow`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_reconciliation -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase13 文档收口。

- 时刻：2026-02-23 02:48:28 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T3（回归与收口）。
  - `agent_world_consensus --lib` 回归通过（174 tests passed）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 进入第十四阶段（继续 15 点清单）。

- 时刻：2026-02-23 02:51:38 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase14.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase14.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `membership.rs` 的同步报告计数受检算术改造并补 overflow 测试。

- 时刻：2026-02-23 02:53:37 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T1（Membership Sync 计数受检化）。
  - `membership.rs`：
    - `sync_key_revocations`、`sync_key_revocations_with_policy`、`sync_membership_directory` 的关键计数累加从饱和语义改为受检语义；
    - 新增 `checked_usize_add` / `checked_usize_increment`，越界统一返回 `WorldError::DistributedValidationFailed`。
  - 新增模块内边界测试：
    - `membership::tests::checked_usize_add_rejects_overflow`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `mempool.rs` payload 累加受检改造并补 overflow 测试。

- 时刻：2026-02-23 02:57:14 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T2（Mempool payload 累加受检化）。
  - `mempool.rs`：
    - `take_batch_with_rules` 的 `total_bytes + size_bytes` 从饱和语义改为受检语义；
    - 新增 `checked_usize_add`，越界统一返回 `WorldError::DistributedValidationFailed`。
  - 新增模块内边界测试：
    - `mempool::tests::checked_usize_add_rejects_overflow`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus mempool::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase14 文档收口。

- 时刻：2026-02-23 03:00:55 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T3（回归与收口）。
  - `agent_world_consensus --lib` 回归通过（176 tests passed）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 进入第十五阶段（继续 15 点清单）。

- 时刻：2026-02-23 03:05:33 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase15.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase15.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 federated 聚合扫描计数受检算术改造并补 overflow 测试。

- 时刻：2026-02-23 03:09:39 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T1（federated 聚合扫描计数受检化）。
  - `membership_recovery/replay_archive_federated.rs`：
    - `query_revocation_dead_letter_replay_rollback_governance_audit_archive_aggregated` 的 `scanned_hot/scanned_cold` 累加从 `saturating_add` 改为 `checked_usize_add`；
    - 新增 `checked_usize_add` helper，溢出统一返回 `WorldError::DistributedValidationFailed`；
    - 新增模块内边界测试：`membership_recovery::replay_archive_federated::tests::checked_usize_add_rejects_overflow`。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus replay_archive_federated::tests::checked_usize_add_rejects_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_audit_aggregate_query_filters_levels_and_min_time -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 composite sequence cursor 偏移递进受检算术改造并补 overflow 测试。

- 时刻：2026-02-23 03:12:49 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T2（复合游标偏移计数受检化）。
  - `membership_recovery/replay_archive_federated.rs`：
    - `query_revocation_dead_letter_replay_rollback_governance_recovery_drill_alert_events_incremental_since_composite_sequence_cursor` 的 `node_event_offset` 递进从 `saturating_add` 改为 `checked_usize_increment`；
    - 新增 `checked_usize_increment` helper，溢出统一返回 `WorldError::DistributedValidationFailed`；
    - 新增模块内边界测试：`membership_recovery::replay_archive_federated::tests::checked_usize_increment_rejects_overflow`。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus replay_archive_federated::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_dead_letter_replay_archive_tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase15 文档收口。

- 时刻：2026-02-23 03:15:31 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T3（回归与收口）。
  - 执行 `agent_world_consensus --lib` 回归并通过（178 tests passed）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第十五阶段任务闭环完成，15 点清单全部落地）。

- 时刻：2026-02-23 14:32:46 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-experience-overhaul.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-experience-overhaul.project.md`。
  - 项目状态初始化：VGRO0 完成，VGRO1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VGRO1：实现体验模式资源与环境变量解析（Player/Director）。

- 时刻：2026-02-23 14:46:14 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO1（体验模式资源与环境变量解析）。
  - 新增 `ViewerExperienceMode` 资源（`Player` / `Director`），默认值为 `Player`。
  - 启动流程接入 `AGENT_WORLD_VIEWER_EXPERIENCE_MODE` 解析：支持 `player` 与 `director`，非法值回落默认。
  - `run_ui` 已注入体验模式资源，为后续默认布局与模块策略切换提供统一入口。
  - 项目文档状态更新：VGRO1 完成，VGRO2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer parse_experience_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_experience_mode_is_player -- --nocapture`
- 遗留事项：
  - 执行 VGRO2：按 `Player/Director` 模式覆盖右侧面板默认布局与模块默认可见性。

- 时刻：2026-02-23 14:50:18 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO2（按模式覆盖默认布局与模块可见性）。
  - 启动流程按 `ViewerExperienceMode` 计算默认 UI 策略：
    - `Player`：右侧面板默认隐藏（`panel_hidden = true`）。
    - `Director`：保持既有面板默认行为。
  - 右侧模块默认可见性切换为模式化策略：
    - `Player` 默认关闭 `controls/chat/overlay/diagnosis/timeline/details`，保留 `overview/event_link` 作为轻量入口。
    - `Director` 保持当前默认模块组合。
  - 模块可见性资源加载改为接收外部默认值，确保“模式只影响默认值，已持久化偏好仍优先”。
  - 项目文档状态更新：VGRO2 完成，VGRO3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_right_panel_layout_state_matches_experience_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_module_visibility_state_player_is_lightweight -- --nocapture`
- 遗留事项：
  - 执行 VGRO3：提升 Player 模式入口可发现性（提示文案与入口行为）。

- 时刻：2026-02-23 14:56:12 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO3（Player 模式入口可发现性增强）。
  - 右上角面板入口从单按钮升级为引导卡片：显示当前体验模式、入口说明与快捷键提示。
  - 新增 `Tab` 快捷键用于开关右侧面板（在非文本输入状态下生效），降低新用户发现入口成本。
  - 面板可见时顶部控制区显示当前体验模式标识，降低“当前处于哪种体验”认知负担。
  - 新增并接线本地化文案：模式名称、入口提示、快捷键提示（中/英文）。
  - 项目文档状态更新：VGRO3 完成，VGRO4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer i18n::tests::copyable_toggle_label_is_localized -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer show_chat_panel_requires_expanded_top_and_visibility_enabled -- --nocapture`
- 遗留事项：
  - 执行 VGRO4：补充/更新测试并执行 viewer 回归，验证模式化默认与入口行为。

- 时刻：2026-02-23 15:08:58 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO4（测试补充与 viewer 回归验收）。
  - 回归中发现并修复快捷键细节：面板快捷键判定从“全局键盘输入占用”细化为“仅聊天输入框聚焦时禁用”，降低 `Tab` 被 UI 焦点吞掉的概率。
  - 执行 Web 闭环 smoke（S6）并核验关键语义：
    - `window.__AW_TEST__` 可用。
    - `getState()` 返回 `connectionStatus=connected` 与数值 `tick`。
    - DOM 检查 `canvasCount=1`（画布存在）。
    - console 仅 warning，无 error。
  - 产物截图：
    - `output/playwright/viewer/viewer-web-vgro4.png`
    - `output/playwright/viewer/viewer-web-vgro4-domcheck.png`
    - `output/playwright/viewer/viewer-web-vgro4-tab-open.png`
    - `output/playwright/viewer/viewer-web-vgro4-tab-toggle-fixed.png`
  - 项目文档状态更新：VGRO4 完成，VGRO5 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer show_chat_panel_requires_expanded_top_and_visibility_enabled -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" eval '() => ({ title: document.title, canvasCount: document.querySelectorAll("canvas").length, hasTestApi: typeof window.__AW_TEST__ === "object" })'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vgro4-tab-toggle-fixed.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 执行 VGRO5：回顾设计/项目文档并完成收口状态回写。

- 时刻：2026-02-23 15:11:26 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO5（文档回顾与收口）。
  - 回顾并更新设计文档里程碑状态：M1~M5 全部标记完成。
  - 补充设计文档“当前结论”：明确默认 Player 体验、Director 回退路径、Web 闭环验收结论。
  - 回写项目管理文档状态：VGRO0~VGRO5 全部完成，项目收口。
- 测试：
  - 文档收口任务（无新增代码测试；VGRO4 已完成 required-tier + Web 闭环验收）。
- 遗留事项：
  - 无（Viewer 发行体验改造闭环完成）。

- 时刻：2026-02-23 15:22:09 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase2.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase2.project.md`。
  - 项目状态初始化：VRI0 完成，VRI1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI1：实现事件驱动情绪反馈（toast/正负反馈层级）。

- 时刻：2026-02-23 15:28:23 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI1（事件驱动情绪反馈）。
  - `egui_right_panel` 新增 Player 模式反馈 toast 管线：
    - 事件增量同步（避免首次加载历史事件洪泛）；
    - 正向/告警/信息三级反馈色阶；
    - 队列限长（最多 3 条）+ 生命周期与淡出。
  - 反馈渲染改为场景顶部浮层，右侧主面板隐藏时也可显示，确保“世界动作有回响”。
  - 新增单测覆盖：
    - `feedback_tone_for_event_maps_warning_positive_and_info`
    - `push_feedback_toast_clamps_queue_and_removes_oldest`
    - `sync_feedback_toasts_skips_history_then_tracks_new_events_only`
  - 项目文档状态更新：VRI1 完成，VRI2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer show_chat_panel_requires_expanded_top_and_visibility_enabled -- --nocapture`
- 遗留事项：
  - 执行 VRI2：实现 Player 新手引导层与“下一步目标”提示。

- 时刻：2026-02-23 15:38:59 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI2（Player 新手引导与下一步目标）。
  - 新增 Player 引导体系：
    - 左上角新手引导卡（按步骤可关闭，步骤变化后自动恢复）；
    - 左下角“下一步目标”常驻提示（连接/开面板/选目标/推进任务四阶段）。
  - 新增引导状态与阶段判定逻辑：`ConnectionStatus`、面板显隐、当前选择共同决定当前目标。
  - 右侧面板代码拆分：
    - 新增 `egui_right_panel_player_experience.rs`（反馈与引导逻辑）；
    - 新增 `egui_right_panel_layout.rs`（布局与快捷键计算）；
    - `egui_right_panel.rs` 降至 1199 行，满足单文件行数约束。
  - 新增/更新单测覆盖：
    - `resolve_player_guide_step_prioritizes_connection_panel_and_selection`
    - `player_onboarding_visibility_tracks_dismissed_step_only`
    - 保持 `feedback_*` 与布局函数测试通过（拆分后回归）。
  - 项目文档状态更新：VRI2 完成，VRI3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_guide_step_prioritizes_connection_panel_and_selection -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_onboarding_visibility_tracks_dismissed_step_only -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer adaptive_panel_width_clamps_to_bounds -- --nocapture`
- 遗留事项：
  - 执行 VRI3：实现 Player 轻量 HUD 与风格收敛。

- 时刻：2026-02-23 15:46:22 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI3（Player 轻量 HUD 与风格收敛）。
  - 新增 Player 紧凑 HUD（顶部浮层）：展示连接状态、Tick、事件数、当前目标与当前阶段目标，强化“玩”的主反馈路径。
  - HUD 支持阶段色彩联动和轻微脉冲高亮，提升状态可读性与视觉活力。
  - 右上角面板入口卡增加 Player 模式动态描边与色彩风格收敛，减少“工具面板感”。
  - 新增 `PlayerHudSnapshot` 纯计算层，UI 展示与数据计算解耦，便于测试。
  - 继续拆分右侧面板工具函数：新增 `egui_right_panel_text_utils.rs`，`egui_right_panel.rs` 保持在 1197 行以内。
  - 新增单测覆盖：
    - `build_player_hud_snapshot_formats_connected_selected_state`
    - `build_player_hud_snapshot_uses_unselected_fallback_text`
  - 项目文档状态更新：VRI3 完成，VRI4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_onboarding_visibility_tracks_dismissed_step_only -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer adaptive_panel_width_clamps_to_bounds -- --nocapture`
- 遗留事项：
  - 执行 VRI4：完成回归测试与 Web 闭环验收，并收口文档状态。

- 时刻：2026-02-23 15:54:06 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI4（回归 + Web 闭环 + 文档收口）。
  - 执行真实 Web 闭环验收（Playwright）：
    - `window.__AW_TEST__.getState()` 可用，状态为 `connectionStatus=connected`；
    - 页面基础语义正常（`title` 正确，`canvasCount=1`，`hasTestApi=true`）；
    - `Tab` 面板切换链路可用，HUD/引导与面板状态在实际页面可观察。
  - 新增验收截图：
    - `output/playwright/viewer/viewer-web-vri4-player-hud-hidden.png`
    - `output/playwright/viewer/viewer-web-vri4-player-hud-panel-open.png`
    - `output/playwright/viewer/viewer-web-vri4-player-hud-panel-closed-again.png`
  - 回写设计文档里程碑状态：M1~M5 全部完成，并补充验收结论。
  - 回写项目管理文档状态：VRI0~VRI4 全部完成，第二阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer truncate_observe_text_supports_multibyte_chars -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer event_row_preview_limit_uses_constant -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5033 --web-bind 127.0.0.1:5111 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4273`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh open \"http://127.0.0.1:4273/?ws=ws://127.0.0.1:5111&test_api=1\"`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => window.__AW_TEST__ ? window.__AW_TEST__.getState() : null'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => ({ title: document.title, canvasCount: document.querySelectorAll(\"canvas\").length, hasTestApi: typeof window.__AW_TEST__ === \"object\" })'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh press Tab`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh screenshot --filename output/playwright/viewer/viewer-web-vri4-player-hud-panel-open.png`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh console`
- 遗留事项：
  - 无（Viewer 第二阶段沉浸与引导改造闭环完成）。

- 时刻：2026-02-23 16:48:57 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase3.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase3.project.md`。
  - 项目状态初始化：VRI3P0 完成，VRI3P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI3P1：实现 Player 里程碑成就反馈（解锁弹层/防重入/淡出）。

- 时刻：2026-02-23 16:54:34 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P1（Player 里程碑成就反馈）。
  - `egui_right_panel_player_experience` 新增里程碑成就系统：
    - 成就状态：已解锁集合 + 弹层队列；
    - 触发里程碑：连接成功、展开面板、首次选中目标、首次收到世界事件；
    - 防重入：已解锁里程碑不重复入队；
    - 视觉反馈：右上角里程碑弹层，带自动淡出与队列上限。
  - `egui_right_panel` 接入成就同步与渲染，Player 模式下与 HUD/引导层协同显示。
  - 新增单测覆盖：
    - `sync_player_achievements_unlocks_milestones_without_reentry`
    - `sync_player_achievements_clamps_popup_queue_and_expires`
  - 项目文档状态更新：VRI3P1 完成，VRI3P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_guide_step_prioritizes_connection_panel_and_selection -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
- 遗留事项：
  - 执行 VRI3P2：实现 Agent 事件气泡反馈（增量事件驱动/队列管理）。

- 时刻：2026-02-23 17:03:17 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P2（Agent 事件气泡反馈）。
  - `egui_right_panel_player_experience` 新增 Agent 事件气泡管线：
    - 事件增量游标（首帧跳过历史事件）；
    - 事件到气泡短句映射（移动/采集/开采/精炼/建造/配方/拒绝）；
    - 队列上限 + 生命周期淡出 + 右下角浮层渲染。
  - 将气泡同步与渲染接入 `render_player_experience_layers`，与里程碑成就/HUD/引导层协同。
  - 按文件行数约束拆分新增测试模块：`egui_right_panel_player_chatter_tests.rs`。
  - 新增单测覆盖：
    - `sync_agent_chatter_bubbles_skips_history_then_tracks_new_events_only`
    - `sync_agent_chatter_bubbles_clamps_queue_and_expires`
  - 项目文档状态更新：VRI3P2 完成，VRI3P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_agent_chatter_bubbles_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
- 遗留事项：
  - 执行 VRI3P3：回归测试 + Web 闭环验收 + 第三阶段文档收口。

- 时刻：2026-02-23 17:20:12 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P3（回归 + Web 闭环 + 文档收口）。
  - 执行第三阶段回归测试与真实 Web 闭环验收（Playwright）：
    - `window.__AW_TEST__.getState()` 可访问，`connectionStatus=connected`；
    - 页面基础语义正常（`title` 正确，`canvasCount=1`，`hasTestApi=true`）；
    - `Tab` 面板切换可用，Player HUD/引导层与右侧面板切换可观察；
    - 通过 `window.__AW_TEST__.select(\"first_agent\")` 验证目标选择链路可用。
  - 新增第三阶段验收截图：
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-hidden.png`
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-panel-open.png`
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-panel-closed.png`
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-selected-achievement-open-panel.png`
  - 回写第三阶段设计文档：补充里程碑状态与验收结论。
  - 回写项目管理文档：VRI3P0~VRI3P3 全部完成，第三阶段收口。
  - 观察备注：本次 live Web 会话中 `tick/eventCount` 保持 0，未在同次验收画面直接观察到事件气泡触发；对应增量事件与队列逻辑由 `sync_agent_chatter_bubbles_*` 单测覆盖。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_agent_chatter_bubbles_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- power_bootstrap --bind 127.0.0.1:5033 --web-bind 127.0.0.1:5111 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4273`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh open \"http://127.0.0.1:4273/?ws=ws://127.0.0.1:5111&test_api=1\"`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => window.__AW_TEST__ ? window.__AW_TEST__.getState() : null'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => ({ title: document.title, canvasCount: document.querySelectorAll(\"canvas\").length, hasTestApi: typeof window.__AW_TEST__ === \"object\" })'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh press Tab`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh screenshot --filename output/playwright/viewer/viewer-web-vri3p3-player-overlays-panel-open.png`
- 遗留事项：
  - 无（第三阶段闭环完成）。

- 时刻：2026-02-23 17:32:40 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase4.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase4.project.md`。
  - 项目状态初始化：VRI4P0 完成，VRI4P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI4P1：实现 Player 场景氛围层（背景层次/呼吸光晕/边缘发光）。

- 时刻：2026-02-23 17:36:42 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P1（Player 场景氛围层）。
  - `egui_right_panel_player_experience` 新增 Player 氛围层：
    - 新增 `build_player_atmosphere_snapshot`（纯计算）：输出顶/底透明度、光晕位置与半径；
    - 新增 `render_player_atmosphere`：渲染顶部/底部氛围层与动态光晕；
    - 在 `render_player_experience_layers` 中接入氛围层，统一由 Player 体验层管理。
  - 新增单测模块：`egui_right_panel_player_atmosphere_tests.rs`。
  - 新增单测覆盖：
    - `build_player_atmosphere_snapshot_clamps_expected_ranges`
    - `build_player_atmosphere_snapshot_changes_over_time`
  - 项目文档状态更新：VRI4P1 完成，VRI4P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_atmosphere_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_agent_chatter_bubbles_ -- --nocapture`
- 遗留事项：
  - 执行 VRI4P2：实现 Player 引导与目标卡片过渡动效（淡入/位移/脉冲）。

- 时刻：2026-02-23 17:43:44 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P2（Player 引导与目标卡片过渡动效）。
  - 新增动效状态模块：`egui_right_panel_player_card_motion.rs`。
  - 引导卡与目标卡接入过渡参数：淡入（alpha）、位移（slide）、脉冲（pulse）。
  - 在 `render_player_experience_layers` 中按引导步骤同步过渡状态，步骤变化时重启动效。
  - 新增单测模块：`egui_right_panel_player_card_motion_tests.rs`。
  - 新增单测覆盖：
    - `player_card_transition_fades_in_and_settles_slide_distance`
    - `player_card_transition_restarts_entry_when_guide_step_changes`
  - 项目文档状态更新：VRI4P2 完成，VRI4P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_card_transition_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_onboarding_visibility_tracks_dismissed_step_only -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI4P3：回归测试 + Web 闭环验收 + 第四阶段文档收口。

- 时刻：2026-02-23 17:50:56 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P3（回归 + Web 闭环 + 文档收口）。
  - 执行第四阶段回归：`agent_world_viewer` 全量单测与 wasm 编译检查通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用，`getState()` 返回 `tick/connectionStatus`；
    - `runSteps + sendControl("pause") + Tab` 面板切换链路可用；
    - console 结果 `Errors: 0`（2 条 warning）。
  - 新增第四阶段验收截图：
    - `output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-open.png`
    - `output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-hidden.png`
  - 回写第四阶段设计文档验收结论，回写项目管理文档状态（VRI4P0~VRI4P3 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" snapshot`
  - `bash "$PWCLI" eval '() => typeof window.__AW_TEST__ === "object"'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.4")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.sendControl("pause")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-open.png`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-hidden.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 无（第四阶段闭环完成）。

- 时刻：2026-02-23 18:15:44 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase5.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase5.project.md`。
  - 项目状态初始化：VRI5P0 完成，VRI5P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI5P1：实现 Player 右侧面板沉浸式结构重构（边缘呼出入口 + 面板宽度预算约束）。

- 时刻：2026-02-23 18:20:12 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P1（Player 右侧面板沉浸式结构重构）。
  - 新增隐藏态入口模块：`egui_right_panel_player_entry.rs`，将右上入口卡从主文件拆出。
  - Player 模式隐藏态新增边缘呼出提示（Edge Drawer），保留快捷键提示与按钮入口。
  - 新增 Player 模式右侧主面板宽度预算函数：`player_main_panel_max_width_for_layout`，默认限制主面板占比，保障主场景视野。
  - `egui_right_panel.rs` 接入新入口模块与 Player 宽度预算逻辑。
  - 新增单测：`player_main_panel_max_width_for_layout_keeps_world_first_budget`。
  - 项目文档状态更新：VRI5P1 完成，VRI5P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_main_panel_max_width_for_layout_keeps_world_first_budget -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer adaptive_main_panel_max_width_for_layout_respects_interaction_budget -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI5P2：实现新手任务闭环提示增强，并拆分 `egui_right_panel_player_experience.rs` 至合规行数。

- 时刻：2026-02-23 18:26:43 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P2（新手任务闭环提示增强 + 模块拆分）。
  - 新增引导模块：`egui_right_panel_player_guide.rs`。
    - 抽离引导文案与配色；
    - 新增 `build_player_guide_progress_snapshot`，统一计算 4 步闭环进度。
  - `egui_right_panel_player_experience.rs` 接入进度视图：
    - 目标卡与引导卡显示“引导进度 x/4”；
    - 逐步状态行（`✓ / ▶ / ·`）可视化当前阶段与已完成阶段。
  - 新增单测模块：`egui_right_panel_player_guide_progress_tests.rs`。
  - 新增单测：`build_player_guide_progress_snapshot_tracks_step_completion`。
  - 文件约束处理：`egui_right_panel_player_experience.rs` 从 1221 行拆分至 1187 行（<=1200）。
  - 项目文档状态更新：VRI5P2 完成，VRI5P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_guide_progress_snapshot_tracks_step_completion -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_guide_step_prioritizes_connection_panel_and_selection -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI5P3：回归测试 + Web 闭环验收 + 第五阶段文档收口。

- 时刻：2026-02-23 18:31:56 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P3（回归 + Web 闭环 + 文档收口）。
  - 执行第五阶段回归：`agent_world_viewer` 全量单测与 wasm 编译检查通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用；`getState()` 返回 `tick/connectionStatus`；
    - `runSteps + sendControl("pause") + Tab` 链路可用；
    - console 结果 `Errors: 0`（warning 1 条）。
  - 新增第五阶段验收截图：
    - `output/playwright/viewer/viewer-web-vri5p3-player-edge-hidden.png`
    - `output/playwright/viewer/viewer-web-vri5p3-player-edge-open.png`
  - 回写第五阶段设计文档验收结论，回写项目管理文档状态（VRI5P0~VRI5P3 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5026 --web-bind 127.0.0.1:5014 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4175`
  - `bash "$PWCLI" open "http://127.0.0.1:4175/?ws=ws://127.0.0.1:5014&test_api=1"`
  - `bash "$PWCLI" snapshot`
  - `bash "$PWCLI" eval '() => typeof window.__AW_TEST__ === "object"'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.5")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.sendControl("pause")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri5p3-player-edge-hidden.png`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri5p3-player-edge-open.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 无（第五阶段闭环完成）。

- 时刻：2026-02-23 19:20:03 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase6.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase6.project.md`。
  - 项目状态初始化：VRI6P0 完成，VRI6P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI6P1：实现 Player 电影化开场层（连接后短时叙事覆盖 + 自动淡出）。

- 时刻：2026-02-23 19:23:33 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P1（Player 电影化开场层）。
  - 在 `egui_right_panel_player_guide.rs` 新增电影化开场能力：
    - 新增 `player_cinematic_intro_alpha`，按 Tick 计算开场淡入/停留/淡出曲线；
    - 新增 `render_player_cinematic_intro`，在 Player 模式渲染短时叙事开场层（低遮挡、自动淡出）。
  - 在 `egui_right_panel_player_experience.rs` 接入电影化开场渲染链。
  - 新增单测模块：`egui_right_panel_player_cinematic_tests.rs`。
  - 新增单测覆盖：
    - `player_cinematic_intro_alpha_requires_connected_status`
    - `player_cinematic_intro_alpha_fades_and_expires_by_tick`
  - 项目文档状态更新：VRI6P1 完成，VRI6P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_cinematic_intro_alpha_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_guide_progress_snapshot_tracks_step_completion -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P2：实现任务驱动 HUD（主任务/步骤进度/当前动作提示）。

- 时刻：2026-02-23 19:27:32 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P2（任务驱动 HUD）。
  - 在 `egui_right_panel_player_guide.rs` 新增任务闭环快照与渲染：
    - 新增 `PlayerMissionLoopSnapshot` 与 `build_player_mission_loop_snapshot`；
    - 新增 `render_player_mission_hud`，显示主任务标题、当前目标、步骤进度条与动作按钮。
  - 在 `egui_right_panel_player_experience.rs` 接入 `render_player_mission_hud`。
  - 新增单测模块：`egui_right_panel_player_mission_tests.rs`。
  - 新增单测覆盖：
    - `build_player_mission_loop_snapshot_open_panel_requires_open_action`
    - `build_player_mission_loop_snapshot_reports_progress_and_objective`
  - 项目文档状态更新：VRI6P2 完成，VRI6P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_mission_loop_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_cinematic_intro_alpha_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P3：实现任务推进奖励反馈强化（完成态文本与视觉层级）。

- 时刻：2026-02-23 19:30:28 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P3（任务推进奖励反馈强化）。
  - 在 `egui_right_panel_player_guide.rs` 新增奖励反馈快照：
    - 新增 `PlayerRewardFeedbackSnapshot` 与 `build_player_reward_feedback_snapshot`；
    - 按任务完成步数输出推进态/完成态文案与层级。
  - 将奖励反馈层接入 `render_player_mission_hud`：
    - 任务推进态显示 `Progress Reward / Momentum Building`；
    - 闭环完成态显示 `Reward / Loop Completed`，并提升视觉强调。
  - 新增单测模块：`egui_right_panel_player_reward_tests.rs`。
  - 新增单测覆盖：
    - `build_player_reward_feedback_snapshot_marks_completion_on_four_steps`
    - `build_player_reward_feedback_snapshot_shows_momentum_before_completion`
  - 项目文档状态更新：VRI6P3 完成，VRI6P4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_reward_feedback_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_mission_loop_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P4：实现 Player 小地图卡片（位置缩略 + 选中高亮联动）。

- 时刻：2026-02-23 19:36:11 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P4（Player 小地图卡片）。
  - 在 `egui_right_panel_player_guide.rs` 新增小地图数据与渲染链：
    - 新增 `PlayerMiniMapPoint`；
    - 新增 `resolve_selected_location_id_for_minimap`（位置/Agent 选中联动）；
    - 新增 `build_player_minimap_points`（位置坐标归一化）；
    - 新增小地图渲染卡片（右下角锚点、位置点、选中高亮与计数文案）。
  - `render_player_mission_hud` 接入小地图卡片渲染。
  - 为行数约束收敛，将 `render_player_guide_progress_lines` 从 `player_experience` 抽回 `player_guide` 模块。
  - 新增单测模块：`egui_right_panel_player_minimap_tests.rs`。
  - 新增单测覆盖：
    - `build_player_minimap_points_normalizes_and_marks_selected`
    - `resolve_selected_location_id_for_minimap_follows_selection_kind`
  - 项目文档状态更新：VRI6P4 完成，VRI6P5 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_minimap_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_selected_location_id_for_minimap_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P5：回归测试 + Web 闭环验收 + 文档收口。

- 时刻：2026-02-23 19:42:39 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P5（回归 + Web 闭环 + 文档收口）。
  - 执行第六阶段回归：`agent_world_viewer` 全量单测与 wasm 编译检查通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用；
    - `runSteps + sendControl("pause") + Tab` 链路可用；
    - `getState()` 返回 `tick/connectionStatus`；
    - console 结果 `Errors: 0`（Warnings: 4）。
  - 新增第六阶段验收截图：
    - `output/playwright/viewer/phase6/phase6-cinematic.png`
    - `output/playwright/viewer/phase6/phase6-panel-open.png`
    - `output/playwright/viewer/phase6/phase6-panel-hidden.png`
    - `output/playwright/viewer/phase6/phase6-mission-minimap.png`
  - 回写第六阶段设计文档验收结论，回写项目管理文档状态（VRI6P0~VRI6P5 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" snapshot`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("wait=1.0")'`
  - `bash "$PWCLI" eval '() => typeof window.__AW_TEST__ === "object"'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.3")'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.sendControl("pause")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/phase6/phase6-mission-minimap.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 无（第六阶段闭环完成）。

- 时刻：2026-02-23 20:04:12 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase7.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase7.project.md`。
  - 项目状态初始化：VRI7P0 完成，VRI7P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI7P1：实现 Player 布局预设（任务/指挥/情报）与快捷切换条。

- 时刻：2026-02-23 20:08:30 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P1（Player 布局预设与快捷切换条）。
  - 在 `egui_right_panel_player_guide.rs` 新增 Player 布局预设能力：
    - 新增 `PlayerLayoutPreset`（Mission / Command / Intel）；
    - 新增 `resolve_player_layout_preset` 与 `apply_player_layout_preset`（预设判定与应用）；
    - 新增 `render_player_layout_preset_strip`（顶部快捷切换条）。
  - 在 `egui_right_panel_player_experience.rs` 接入布局切换条渲染链。
  - 在 `egui_right_panel.rs` 将 `module_visibility` 透传至 Player 体验层。
  - 新增单测模块：`egui_right_panel_player_layout_tests.rs`。
  - 新增单测覆盖：
    - `apply_player_layout_preset_command_opens_panel_and_enables_chat`
    - `apply_player_layout_preset_mission_reduces_non_essential_sections`
    - `resolve_player_layout_preset_tracks_command_and_intel_state`
  - 项目文档状态更新：VRI7P1 完成，VRI7P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_layout_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_layout_preset_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI7P2：实现隐藏状态“直接指挥”入口，并接入指挥预设联动。

- 时刻：2026-02-23 20:11:30 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P2（隐藏态直接指挥入口）。
  - 在 `egui_right_panel_player_entry.rs` 增强隐藏态入口：
    - 新增 `activate_player_command_entry`，统一切换到 Command 预设；
    - 主入口卡新增“直接指挥 / Command Now”按钮；
    - 右侧边缘呼出卡新增“指挥 / Command”按钮。
  - 在 `egui_right_panel.rs` 透传 `module_visibility` 给隐藏态入口，支持入口按钮直接修改模块显隐。
  - 新增单测模块：`egui_right_panel_player_entry_tests.rs`。
  - 新增单测覆盖：
    - `activate_player_command_entry_opens_panel_and_switches_to_command_layout`
  - 项目文档状态更新：VRI7P2 完成，VRI7P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer activate_player_command_entry_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_layout_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI7P3：调整 Player 默认模块可见性与面板宽度预算（世界优先）。

- 时刻：2026-02-23 20:16:41 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P3（Player 默认可指挥 + 世界优先宽度预算）。
  - 在 `app_bootstrap.rs` 调整 Player 默认模块可见性：
    - `show_chat` 默认改为 `true`，确保玩家展开面板即可直接进入指挥链路。
  - 在 `egui_right_panel_layout.rs` 新增 Player 专用宽度预算：
    - 新增 `player_chat_panel_max_width_for_side_layout`；
    - 新增 Player 总宽度预算比例与主面板沉浸上限比例；
    - `player_main_panel_max_width_for_layout` 改为使用 Player 专用预算。
  - 在 `egui_right_panel.rs` 接入 Player 专用聊天侧栏宽度预算，避免宽屏场景下右侧面板可拖拽到过度挤占世界视野。
  - 补充/更新单测：
    - `player_chat_panel_max_width_for_side_layout_keeps_world_first_budget`
    - `player_main_panel_max_width_for_layout_keeps_world_first_budget`
    - `default_module_visibility_state_player_is_lightweight`
  - 项目文档状态更新：VRI7P3 完成，VRI7P4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer world_first_budget -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_module_visibility_state_player_is_lightweight -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI7P4：执行回归与 Web 闭环验收并完成文档收口。

- 时刻：2026-02-23 20:22:05 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P4（回归 + Web 闭环 + 文档收口）。
  - 执行 `agent_world_viewer` 回归与 wasm 检查并通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用；
    - `runSteps` / `sendControl("pause")` / `Tab` 展开收起链路可用；
    - `getState()` 返回 `connectionStatus/tick/selectedKind` 等字段，采样状态为已连接。
  - Console 结果：`Total messages: 12 (Errors: 0, Warnings: 2)`。
  - 产出 phase7 验收截图：
    - `output/playwright/viewer/phase7/phase7-hidden-default.png`
    - `output/playwright/viewer/phase7/phase7-hidden-focused.png`
    - `output/playwright/viewer/phase7/phase7-panel-open-command-default.png`
    - `output/playwright/viewer/phase7/phase7-panel-open-paused.png`
    - `output/playwright/viewer/phase7/phase7-panel-hidden-after-toggle.png`
  - 回写第七阶段设计文档与项目管理文档状态（VRI7P0~VRI7P4 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash \"$PWCLI\" open \"http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1\"`
  - `bash \"$PWCLI\" snapshot`
  - `bash \"$PWCLI\" eval '() => typeof window.__AW_TEST__ === \"object\"'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.runSteps(\"mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.6\")'`
  - `bash \"$PWCLI\" press Tab`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.sendControl(\"pause\")'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.getState()'`
  - `bash \"$PWCLI\" console`
  - `bash \"$PWCLI\" screenshot --filename output/playwright/viewer/phase7/phase7-panel-open-command-default.png`
- 遗留事项：
  - 无（第七阶段闭环完成）。

- 时刻：2026-02-23 20:28:29 CST
- 完成内容：完成“Viewer 发行体验改造（第八阶段：信息分层减负与焦点收敛）”VRI8P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase8.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase8.project.md`。
  - 项目状态初始化：VRI8P0 完成，VRI8P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI8P1：收敛“下一步目标卡”与“新手引导卡”共存策略，去除重复提示。
