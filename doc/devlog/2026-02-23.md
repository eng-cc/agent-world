# 2026-02-23

- 时刻：2026-02-23 00:05:39 CST
- 完成内容：完成“Runtime 节点高度/Slot 递进与复制补洞数值语义硬化（15 点清单第三阶段）”T2（快照恢复边界与测试）。
  - `PosNodeEngine::restore_state_snapshot` 改为 `Result` 返回：
    - `committed_height + 1` 改为受检后继值，越界时返回 `NodeError::Replication`。
    - 保持“先计算校验、后状态写入”，保证溢出失败时不出现半恢复状态。
  - `NodeRuntime::start` 在读取到 snapshot 后对恢复错误显式失败并停止启动流程。
  - 新增测试：
    - `pos_engine_restore_state_snapshot_rejects_overflow_without_partial_state`
    - `runtime_start_fails_when_pos_state_snapshot_height_overflows`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node pos_engine_restore_state_snapshot_rejects_overflow_without_partial_state -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_start_fails_when_pos_state_snapshot_height_overflows -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T3：完成阶段回归收口并关闭 phase3 文档状态。

- 时刻：2026-02-23 00:08:48 CST
- 完成内容：完成“Runtime 节点高度/Slot 递进与复制补洞数值语义硬化（15 点清单第三阶段）”T3（回归与收口）。
  - Phase3 关键改造（高度/slot 递进 + 快照恢复）在提交门禁中完成 required-tier 全量回归并通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（第三阶段任务闭环完成）。

- 时刻：2026-02-23 00:22:57 CST
- 完成内容：完成“Runtime Replication Writer Epoch/Sequence 数值语义硬化（15 点清单第四阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase4.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase4.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 replication writer 位置递进的受检溢出语义改造与边界测试。

- 时刻：2026-02-23 00:26:25 CST
- 完成内容：完成“Runtime Replication Writer Epoch/Sequence 数值语义硬化（15 点清单第四阶段）”T1（writer 递进显式溢出语义）。
  - `ReplicationRuntime::next_local_record_position` 改为 `Result`：
    - 同 writer 的 `sequence + 1` 改为受检后继值；
    - writer 切换时 `writer_epoch + 1` 改为受检后继值；
    - 无 guard writer 场景的 `sequence + 1` 改为受检后继值。
  - `build_local_commit_message` 对 writer 位置计算错误改为显式透传，拒绝静默饱和。
  - `recent_replicated_content_hashes` 去除不必要饱和减法，使用确定安全的递减语义。
  - 新增 replication 单测：
    - `next_local_record_position_rejects_sequence_overflow_for_existing_writer`
    - `next_local_record_position_rejects_writer_epoch_overflow_on_writer_switch`
    - `next_local_record_position_rejects_sequence_overflow_without_guard_writer`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node next_local_record_position_rejects_sequence_overflow_for_existing_writer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node next_local_record_position_rejects_writer_epoch_overflow_on_writer_switch -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node next_local_record_position_rejects_sequence_overflow_without_guard_writer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T2：完成阶段回归收口并关闭 phase4 文档状态。

- 时刻：2026-02-23 00:28:30 CST
- 完成内容：完成“Runtime Replication Writer Epoch/Sequence 数值语义硬化（15 点清单第四阶段）”T2（回归与收口）。
  - phase4 关键改造（writer `epoch/sequence` 递进显式溢出语义）已在提交门禁中通过 required-tier 全量回归。
  - 回写设计文档状态：M0~M2 全部完成。
  - 回写项目管理文档状态：T0~T2 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（第四阶段任务闭环完成）。

- 时刻：2026-02-23 00:34:22 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase5.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase5.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `sequencer_mainloop` 高度/slot 递进的受检溢出语义改造与测试。

- 时刻：2026-02-23 00:36:48 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T1（Sequencer 递进显式溢出语义）。
  - `sequencer_mainloop` 中 `next_slot` 递进改为受检后继值，溢出时返回 `WorldError::DistributedValidationFailed`。
  - `apply_finalized_status` 改为可失败接口：`Committed/Rejected` 的 `next_height` 递进改为受检后继值，拒绝静默饱和。
  - 新增 sequencer 单测：
    - `sequencer_tick_rejects_slot_overflow_without_partial_state`
    - `sequencer_tick_rejects_height_overflow_without_partial_state`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus sequencer_mainloop::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `lease` 的 term/ttl 递进受检语义改造与边界测试。

- 时刻：2026-02-23 00:40:13 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T2（Lease 递进显式溢出语义）。
  - `lease::try_acquire` 中 `next_term` 与 `expires_at_ms` 递进改为受检语义，越界返回拒绝决策并保持状态不变。
  - `lease::renew` 的 `expires_at_ms` 递进改为受检语义，越界时拒绝续租且不污染现有 lease。
  - 新增 lease 单测：
    - `try_acquire_rejects_term_overflow_without_mutation`
    - `try_acquire_rejects_expiry_overflow_without_mutation`
    - `renew_rejects_expiry_overflow_without_mutation`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus lease::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：完成 phase5 回归收口并关闭文档状态。

- 时刻：2026-02-23 00:43:04 CST
- 完成内容：完成“Runtime Sequencer 主循环与 Lease 递进数值语义硬化（15 点清单第五阶段）”T3（回归与收口）。
  - `agent_world_consensus` 定向回归通过，phase5 新增边界用例全部通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第五阶段任务闭环完成）。

- 时刻：2026-02-23 00:47:49 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase6.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase6.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 membership 协调器 lease 到期时间受检加法改造与溢出测试。

- 时刻：2026-02-23 00:51:44 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T1（coordinator lease 受检加法）。
  - `InMemoryMembershipRevocationScheduleCoordinator::acquire` 的 `expires_at_ms` 从 `saturating_add` 改为受检加法，溢出返回 `WorldError::DistributedValidationFailed`。
  - `StoreBackedMembershipRevocationScheduleCoordinator::acquire` 的 `expires_at_ms` 从 `saturating_add` 改为受检加法，溢出返回 `WorldError::DistributedValidationFailed`。
  - 新增统一错误语义 helper：`membership revocation coordinator lease expiry overflow`。
  - 新增边界测试：
    - `in_memory_schedule_coordinator_rejects_expiry_overflow_without_mutation`
    - `store_backed_schedule_coordinator_rejects_expiry_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus in_memory_schedule_coordinator_rejects_expiry_overflow_without_mutation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus store_backed_schedule_coordinator_rejects_expiry_overflow_without_mutation -- --nocapture`
- 遗留事项：
  - 执行 T2：收口 phase6 范围内 `as_millis() as i64` 窄化转换并补边界测试。

- 时刻：2026-02-23 00:57:42 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T2（时间源窄化受检转换）。
  - 收口 phase6 范围内 `as_millis() as i64` 风险点（consensus/net/node）：
    - `crates/agent_world_net/src/dht.rs`
    - `crates/agent_world_net/src/provider_cache.rs`
    - `crates/agent_world_net/src/gateway.rs`
    - `crates/agent_world_net/src/index_store.rs`
    - `crates/agent_world_net/src/dht_cache.rs`
    - `crates/agent_world_net/src/libp2p_net.rs`
    - `crates/agent_world_consensus/src/dht.rs`
    - `crates/agent_world_node/src/runtime_util.rs`
  - 统一改为受检转换 + 上限夹逼语义（`i64::try_from(duration.as_millis()).unwrap_or(i64::MAX)`），避免隐式窄化截断。
  - 新增超大 `Duration` 边界测试：
    - `agent_world_net::util::tests::duration_millis_to_i64_saturating_clamps_overflow_to_i64_max`
    - `agent_world_consensus::dht::tests::duration_millis_to_i64_saturating_clamps_on_overflow`
    - `agent_world_node::runtime_util::tests::duration_millis_to_i64_saturating_clamps_on_overflow`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net util::tests::duration_millis_to_i64_saturating_clamps_overflow_to_i64_max -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus dht::tests::duration_millis_to_i64_saturating_clamps_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_util::tests::duration_millis_to_i64_saturating_clamps_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T3：完成 phase6 回归收口并关闭文档状态。

- 时刻：2026-02-23 01:00:53 CST
- 完成内容：完成“Runtime Membership 协调租约与时间源窄化数值语义硬化（15 点清单第六阶段）”T3（回归与收口）。
  - `agent_world_consensus`、`agent_world_net`、`agent_world_node` 定向回归通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 无（第六阶段任务闭环完成）。

- 时刻：2026-02-23 01:05:37 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase7.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase7.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 PoS 超多数比率判定从饱和乘法到无溢出判定的三处同步改造。

- 时刻：2026-02-23 01:10:23 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T1（比率判定去饱和化）。
  - `agent_world_proto::distributed_pos::required_supermajority_stake` 将 `numerator.saturating_mul(2) <= denominator` 改为 `numerator <= denominator / 2`。
  - `agent_world_consensus::PosConsensus::new` 同步改为无溢出比率判定。
  - `agent_world_node::pos_validation::validated_pos_state` 同步改为无溢出比率判定。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto required_supermajority_rounds_up -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus pos::tests::pos_commit_requires_supermajority_stake -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_action_payload::config_rejects_invalid_pos_config -- --nocapture`
- 遗留事项：
  - 执行 T2：补齐超大分母/分子边界用例，验证 proto/consensus/node 三层一致性。

- 时刻：2026-02-23 01:16:37 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T2（边界测试补齐）。
  - 新增 `denominator = u64::MAX`、`numerator = denominator / 2 + 1` 边界用例，验证“略大于 1/2”不会被误拒绝：
    - `agent_world_proto::distributed_pos::tests::required_supermajority_accepts_extreme_ratio_just_above_half`
    - `agent_world_consensus::pos::tests::pos_accepts_extreme_supermajority_ratio_just_above_half`
    - `agent_world_node::tests_action_payload::config_accepts_extreme_supermajority_ratio_just_above_half`
  - 三层行为一致性确认：上述输入在 proto/consensus/node 均可通过校验，未出现乘法溢出导致的误拒绝。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto required_supermajority_accepts_extreme_ratio_just_above_half -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus pos::tests::pos_accepts_extreme_supermajority_ratio_just_above_half -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_action_payload::config_accepts_extreme_supermajority_ratio_just_above_half -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 phase7 回归测试并完成文档收口。

- 时刻：2026-02-23 01:19:51 CST
- 完成内容：完成“Runtime PoS 超多数比率边界数值语义硬化（15 点清单第七阶段）”T3（回归与收口）。
  - 执行 `agent_world_proto`、`agent_world_consensus`、`agent_world_node` 回归测试并全部通过（`agent_world_node --lib` 首轮出现单测波动，定向复跑与二次全量复跑均通过）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`（首轮 1 例波动失败）
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests::runtime_replication_storage_challenge_gate_blocks_on_local_probe_failure -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`（二次全量复跑通过）
- 遗留事项：
  - 无（第七阶段任务闭环完成）。

- 时刻：2026-02-23 01:23:54 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase8.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase8.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `with_retry_failure` 重试计数与回退时间的受检递进改造并补边界测试。

- 时刻：2026-02-23 01:27:28 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T1（重试递进受检语义）。
  - `MembershipRevocationPendingAlert::with_retry_failure` 从饱和递进改为受检递进：
    - `attempt` 使用 `checked_add`，越界返回 `WorldError::DistributedValidationFailed`；
    - `next_retry_at_ms` 使用 `checked_add`，越界返回 `WorldError::DistributedValidationFailed`。
  - `membership_recovery/mod.rs` ACK 重试路径接线可失败语义，越界失败直接透传错误，避免静默夹逼继续执行。
  - 新增边界测试：
    - `membership_recovery::types::tests::with_retry_failure_rejects_attempt_overflow`
    - `membership_recovery::types::tests::with_retry_failure_rejects_retry_timestamp_overflow`
    - `membership_recovery_tests::emit_revocation_reconcile_alerts_with_ack_retry_rejects_retry_timestamp_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::types::tests::with_retry_failure_rejects_attempt_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::types::tests::with_retry_failure_rejects_retry_timestamp_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus emit_revocation_reconcile_alerts_with_ack_retry_rejects_retry_timestamp_overflow_without_mutation -- --nocapture`
- 遗留事项：
  - 执行 T2：完成自适应策略阈值/比率去饱和化改造与大整数边界测试。

- 时刻：2026-02-23 01:32:07 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T2（自适应策略阈值/比率去饱和化）。
  - `membership_recovery/replay.rs` 中高风险乘法判定去饱和化：
    - `high_backlog` 与 `retry_backlog vs capacity_backlog` 的 `*2` 阈值比较改为基于 `u128` 的无溢出比较；
    - `ratio_per_mille` 从 `saturating_mul(1000)` 改为 `u128` 精确计算后受检收窄，避免先饱和后除法导致的比率失真。
  - 新增边界测试：
    - `membership_recovery::replay::tests::ratio_per_mille_handles_extreme_values_without_saturation_distortion`
    - `membership_recovery::replay::tests::exceeds_double_handles_extreme_values_without_overflow`
    - `membership_dead_letter_replay_tests::recommend_replay_policy_uses_large_ratio_without_saturation_distortion`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::replay::tests::ratio_per_mille_handles_extreme_values_without_saturation_distortion -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::replay::tests::exceeds_double_handles_extreme_values_without_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus recommend_replay_policy_uses_large_ratio_without_saturation_distortion -- --nocapture`
- 遗留事项：
  - 执行 T3：完成 phase8 回归测试与文档收口。

- 时刻：2026-02-23 01:35:01 CST
- 完成内容：完成“Runtime Membership Dead-Letter Replay 重试计数与比率阈值数值语义硬化（15 点清单第八阶段）”T3（回归与收口）。
  - `agent_world_consensus` 回归测试通过（包含 phase8 新增边界用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第八阶段任务闭环完成）。

- 时刻：2026-02-23 01:40:58 CST
- 完成内容：完成“Runtime Governance Drill/Retention 时间算术数值语义硬化（15 点清单第九阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase9.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase9.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 governance drill/retention 时间算术受检语义改造与边界测试。

- 时刻：2026-02-23 01:44:17 CST
- 完成内容：完成“Runtime Governance Drill/Retention 时间算术数值语义硬化（15 点清单第九阶段）”T1（调度与保留时间算术受检化）。
  - `membership_recovery/replay_archive.rs`：
    - drill schedule 的 `elapsed` 与 `next_due_at_ms` 计算改为受检算术，溢出返回 `WorldError::DistributedValidationFailed`；
    - audit retention 的 `age` 计算改为受检减法，溢出显式失败。
  - 新增边界测试并验证失败不污染状态：
    - `membership_dead_letter_replay_archive_tests::governance_audit_archive_prune_rejects_age_overflow_without_mutation`
    - `membership_dead_letter_replay_archive_tests::governance_recovery_drill_schedule_rejects_next_due_overflow_without_mutation`
    - 保持行为回归：`membership_dead_letter_replay_archive_tests::governance_recovery_drill_schedule_executes_when_due_and_persists_state`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_audit_archive_prune_rejects_age_overflow_without_mutation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_recovery_drill_schedule_rejects_next_due_overflow_without_mutation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_recovery_drill_schedule_executes_when_due_and_persists_state -- --nocapture`
- 遗留事项：
  - 执行 T2：运行 phase9 回归测试并完成文档收口。

- 时刻：2026-02-23 01:47:06 CST
- 完成内容：完成“Runtime Governance Drill/Retention 时间算术数值语义硬化（15 点清单第九阶段）”T2（回归与收口）。
  - `agent_world_consensus` 定向回归测试通过（包含 phase9 新增边界用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T2 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第九阶段任务闭环完成）。

- 时刻：2026-02-23 01:50:34 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase10.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase10.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 tiered offload/drill alert 时间差与计数路径的受检算术改造及边界测试。

- 时刻：2026-02-23 01:54:42 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T1（Tiered Offload/Drill Alert 受检化）。
  - `membership_recovery/replay_archive_tiered.rs`：
    - tiered offload 的 `now_ms - audited_at_ms` 改为受检减法，溢出显式返回 `WorldError::DistributedValidationFailed`；
    - drill alert 的 silence/cooldown 时间差改为受检减法，拒绝极端边界时间回退；
    - `plan_governance_audit_tiered_offload` / `evaluate_recovery_drill_alert_reasons` 改为可失败返回并沿调用链透传。
  - 去除不必要的 `saturating_add/sub` 计数语义，改为在既有边界约束下的确定性递减/递增。
  - 新增边界测试并验证失败不污染状态：
    - `governance_audit_tiered_offload_rejects_age_overflow_without_mutation`
    - `governance_recovery_drill_alert_rejects_silence_age_overflow_without_mutation`
    - `governance_recovery_drill_alert_rejects_cooldown_age_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_audit_tiered_offload_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_recovery_drill_alert_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_archive_tiered_offload_drill_alert_orchestration_runs_end_to_end -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `replay_audit` 的 rollback streak 与 rollback alert 时间差受检算术改造及边界测试。

- 时刻：2026-02-23 02:00:41 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T2（Rollback Audit/Governance 受检化）。
  - `membership_recovery/replay_audit.rs`：
    - `apply_dead_letter_replay_rollback_governance_policy` 的 `rollback_streak` 从饱和递进改为受检加法，越界显式返回 `WorldError::DistributedValidationFailed`；
    - `emit_dead_letter_replay_rollback_alert_if_needed` 的 rollback window/cooldown 时间差从饱和减法改为受检减法，拒绝极端时间边界失真。
  - 新增边界测试并验证失败不污染关键状态：
    - `run_with_audit_rejects_rollback_window_age_overflow_without_mutating_alert_state`
    - `run_with_audit_rejects_cooldown_age_overflow_without_mutating_alert_state`
    - `run_with_governance_archive_rejects_rollback_streak_overflow_without_mutation`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_with_audit_rejects_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_with_governance_archive_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_with_audit_emits_rollback_alert_and_honors_cooldown -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase10 文档收口。

- 时刻：2026-02-23 02:04:01 CST
- 完成内容：完成“Runtime Governance Tiered Offload 与 Rollback Audit 算术语义硬化（15 点清单第十阶段）”T3（回归与收口）。
  - `agent_world_consensus` 定向回归测试通过（包含 phase10 新增边界用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第十阶段任务闭环完成）。

- 时刻：2026-02-23 02:06:53 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase11.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase11.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 replay 调度间隔与 policy cooldown 时间门控受检算术改造及边界测试。

- 时刻：2026-02-23 02:09:52 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T1（调度与策略冷却门控受检化）。
  - `membership_recovery/replay.rs`：
    - `run_revocation_dead_letter_replay_schedule_with_state_store` 的 interval gate 从 `saturating_sub` 改为受检减法；
    - `recommend_revocation_dead_letter_replay_policy_with_adaptive_guard` 的 policy cooldown 从 `saturating_sub` 改为受检减法；
    - 时间差溢出统一返回 `WorldError::DistributedValidationFailed`，包含 `now_ms/last_replay_at_ms` 上下文。
  - 新增边界测试并验证失败不污染 replay state：
    - `run_replay_schedule_with_state_store_rejects_interval_overflow_without_mutation`
    - `recommend_guarded_policy_rejects_cooldown_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_replay_schedule_with_state_store_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus recommend_guarded_policy_ -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 rollback cooldown 门控受检算术改造并补 persistence 侧边界测试。

- 时刻：2026-02-23 02:14:49 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T2（rollback 冷却门控受检化）。
  - `membership_recovery/replay.rs`：
    - `should_rollback_to_stable_policy` 从布尔返回升级为 `Result<bool, WorldError>`；
    - rollback cooldown 时间差从 `saturating_sub` 改为受检减法，溢出统一返回 `WorldError::DistributedValidationFailed` 并携带 `now_ms/last_rollback_at_ms` 上下文；
    - 持久化调用链 `recommend_revocation_dead_letter_replay_policy_with_persistence_and_rollback_guard` 透传错误，确保失败发生在 `save_policy_state` 前。
  - 新增 persistence 边界测试并验证失败不污染 policy state：
    - `recommend_with_persistence_rejects_rollback_cooldown_overflow_without_partial_update`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus recommend_with_persistence_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_coordinated_replay_with_persisted_guarded_policy_reports_rollback -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase11 文档收口。

- 时刻：2026-02-23 02:18:00 CST
- 完成内容：完成“Runtime Membership Replay 调度/冷却时间门控算术语义硬化（15 点清单第十一阶段）”T3（回归与收口）。
  - `agent_world_consensus` 定向回归测试通过（包含 phase11 新增 rollback cooldown overflow 用例）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第十一阶段任务闭环完成）。

- 时刻：2026-02-23 02:21:36 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase12.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase12.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `run_revocation_dead_letter_replay_schedule` 时间门控受检算术改造与边界测试。

- 时刻：2026-02-23 02:24:30 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T1（调度时间门控受检化）。
  - `membership_recovery/mod.rs`：
    - `run_revocation_dead_letter_replay_schedule` 的 interval gate 从 `saturating_sub` 改为受检减法；
    - 时间差溢出统一返回 `WorldError::DistributedValidationFailed`，包含 `now_ms/last_replay_at_ms` 上下文。
  - 新增边界测试并验证失败不污染状态：
    - `run_revocation_dead_letter_replay_schedule_rejects_interval_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_revocation_dead_letter_replay_schedule_ -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 recovery 计数/容量受检算术改造并补边界测试。

- 时刻：2026-02-23 02:29:54 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T2（recovery 计数/容量受检化）。
  - `membership_recovery/mod.rs`：
    - `emit_revocation_reconcile_alerts_with_recovery_and_ack_retry_with_dead_letter` 中 buffered capacity 与关键计数字段累加从饱和语义改为受检语义；
    - 新增统一 helper：`checked_usize_add`/`checked_usize_increment`，越界统一返回 `WorldError::DistributedValidationFailed`；
    - `archive_dead_letter` 调整为“先受检递进、后 append”，避免 overflow 时 dead-letter 发生部分写入。
  - 新增模块内边界测试并验证失败不污染 dead-letter 状态：
    - `membership_recovery::tests::checked_usize_add_rejects_overflow`
    - `membership_recovery::tests::archive_dead_letter_rejects_dead_lettered_overflow_without_mutation`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus emit_revocation_reconcile_alerts_with_ack_retry_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus run_revocation_dead_letter_replay_schedule_ -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase12 文档收口。

- 时刻：2026-02-23 02:34:26 CST
- 完成内容：完成“Runtime Membership Recovery 调度门控与计数聚合算术语义硬化（15 点清单第十二阶段）”T3（回归与收口）。
  - `agent_world_consensus --lib` 回归通过（171 tests passed）。
  - 清理 `membership_recovery/mod.rs` 的 unused import warning（将 `MembershipRevocationAlertSeverity` 仅保留在 `#[cfg(test)]` 测试模块内）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 进入第十三阶段（继续 15 点清单）。

- 时刻：2026-02-23 02:38:55 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase13.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase13.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `schedule_due` 与 `deduplicate_revocation_alerts` 时间门控受检算术改造并补边界测试。

- 时刻：2026-02-23 02:41:38 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T1（调度与 dedup 时间门控受检化）。
  - `membership_reconciliation.rs`：
    - `schedule_due` 从布尔返回升级为 `Result<bool, WorldError>`，时间差从 `saturating_sub` 改为受检减法；
    - `deduplicate_revocation_alerts` 的 suppress window 时间差从 `saturating_sub` 改为受检减法；
    - 新增统一时间差 helper，溢出统一返回 `WorldError::DistributedValidationFailed` 并带 `now_ms/last_run_ms` 上下文。
  - 新增边界测试并验证失败不污染状态：
    - `run_revocation_reconcile_schedule_rejects_interval_overflow_without_mutation`
    - `deduplicate_revocation_alerts_rejects_suppress_window_overflow_without_mutation`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_reconciliation_tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `reconcile_revocations_with_policy` 关键计数受检改造并补 overflow 测试。

- 时刻：2026-02-23 02:45:48 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T2（对账报告计数受检化）。
  - `membership_reconciliation.rs`：
    - `reconcile_revocations_with_policy` 的 `rejected/in_sync/diverged/merged` 累加从饱和语义改为受检语义；
    - 新增 `checked_usize_add` / `checked_usize_increment`，越界统一返回 `WorldError::DistributedValidationFailed`。
  - 新增模块内边界测试：
    - `membership_reconciliation::tests::checked_usize_add_rejects_overflow`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_reconciliation -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase13 文档收口。

- 时刻：2026-02-23 02:48:28 CST
- 完成内容：完成“Runtime Membership Reconciliation 调度门控与对账计数算术语义硬化（15 点清单第十三阶段）”T3（回归与收口）。
  - `agent_world_consensus --lib` 回归通过（174 tests passed）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 进入第十四阶段（继续 15 点清单）。

- 时刻：2026-02-23 02:51:38 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase14.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase14.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 `membership.rs` 的同步报告计数受检算术改造并补 overflow 测试。

- 时刻：2026-02-23 02:53:37 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T1（Membership Sync 计数受检化）。
  - `membership.rs`：
    - `sync_key_revocations`、`sync_key_revocations_with_policy`、`sync_membership_directory` 的关键计数累加从饱和语义改为受检语义；
    - 新增 `checked_usize_add` / `checked_usize_increment`，越界统一返回 `WorldError::DistributedValidationFailed`。
  - 新增模块内边界测试：
    - `membership::tests::checked_usize_add_rejects_overflow`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 `mempool.rs` payload 累加受检改造并补 overflow 测试。

- 时刻：2026-02-23 02:57:14 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T2（Mempool payload 累加受检化）。
  - `mempool.rs`：
    - `take_batch_with_rules` 的 `total_bytes + size_bytes` 从饱和语义改为受检语义；
    - 新增 `checked_usize_add`，越界统一返回 `WorldError::DistributedValidationFailed`。
  - 新增模块内边界测试：
    - `mempool::tests::checked_usize_add_rejects_overflow`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus mempool::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase14 文档收口。

- 时刻：2026-02-23 03:00:55 CST
- 完成内容：完成“Runtime Membership Sync 与 Mempool 批处理计数算术语义硬化（15 点清单第十四阶段）”T3（回归与收口）。
  - `agent_world_consensus --lib` 回归通过（176 tests passed）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 进入第十五阶段（继续 15 点清单）。

- 时刻：2026-02-23 03:05:33 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase15.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase15.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 federated 聚合扫描计数受检算术改造并补 overflow 测试。

- 时刻：2026-02-23 03:09:39 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T1（federated 聚合扫描计数受检化）。
  - `membership_recovery/replay_archive_federated.rs`：
    - `query_revocation_dead_letter_replay_rollback_governance_audit_archive_aggregated` 的 `scanned_hot/scanned_cold` 累加从 `saturating_add` 改为 `checked_usize_add`；
    - 新增 `checked_usize_add` helper，溢出统一返回 `WorldError::DistributedValidationFailed`；
    - 新增模块内边界测试：`membership_recovery::replay_archive_federated::tests::checked_usize_add_rejects_overflow`。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus replay_archive_federated::tests::checked_usize_add_rejects_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus governance_audit_aggregate_query_filters_levels_and_min_time -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 composite sequence cursor 偏移递进受检算术改造并补 overflow 测试。

- 时刻：2026-02-23 03:12:49 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T2（复合游标偏移计数受检化）。
  - `membership_recovery/replay_archive_federated.rs`：
    - `query_revocation_dead_letter_replay_rollback_governance_recovery_drill_alert_events_incremental_since_composite_sequence_cursor` 的 `node_event_offset` 递进从 `saturating_add` 改为 `checked_usize_increment`；
    - 新增 `checked_usize_increment` helper，溢出统一返回 `WorldError::DistributedValidationFailed`；
    - 新增模块内边界测试：`membership_recovery::replay_archive_federated::tests::checked_usize_increment_rejects_overflow`。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus replay_archive_federated::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_dead_letter_replay_archive_tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：运行 `agent_world_consensus --lib` 回归并完成 phase15 文档收口。

- 时刻：2026-02-23 03:15:31 CST
- 完成内容：完成“Runtime Membership Recovery Federated 聚合扫描与游标计数算术语义硬化（15 点清单第十五阶段）”T3（回归与收口）。
  - 执行 `agent_world_consensus --lib` 回归并通过（178 tests passed）。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（第十五阶段任务闭环完成，15 点清单全部落地）。

- 时刻：2026-02-23 14:32:46 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-experience-overhaul.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-experience-overhaul.project.md`。
  - 项目状态初始化：VGRO0 完成，VGRO1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VGRO1：实现体验模式资源与环境变量解析（Player/Director）。

- 时刻：2026-02-23 14:46:14 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO1（体验模式资源与环境变量解析）。
  - 新增 `ViewerExperienceMode` 资源（`Player` / `Director`），默认值为 `Player`。
  - 启动流程接入 `AGENT_WORLD_VIEWER_EXPERIENCE_MODE` 解析：支持 `player` 与 `director`，非法值回落默认。
  - `run_ui` 已注入体验模式资源，为后续默认布局与模块策略切换提供统一入口。
  - 项目文档状态更新：VGRO1 完成，VGRO2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer parse_experience_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_experience_mode_is_player -- --nocapture`
- 遗留事项：
  - 执行 VGRO2：按 `Player/Director` 模式覆盖右侧面板默认布局与模块默认可见性。

- 时刻：2026-02-23 14:50:18 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO2（按模式覆盖默认布局与模块可见性）。
  - 启动流程按 `ViewerExperienceMode` 计算默认 UI 策略：
    - `Player`：右侧面板默认隐藏（`panel_hidden = true`）。
    - `Director`：保持既有面板默认行为。
  - 右侧模块默认可见性切换为模式化策略：
    - `Player` 默认关闭 `controls/chat/overlay/diagnosis/timeline/details`，保留 `overview/event_link` 作为轻量入口。
    - `Director` 保持当前默认模块组合。
  - 模块可见性资源加载改为接收外部默认值，确保“模式只影响默认值，已持久化偏好仍优先”。
  - 项目文档状态更新：VGRO2 完成，VGRO3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_right_panel_layout_state_matches_experience_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_module_visibility_state_player_is_lightweight -- --nocapture`
- 遗留事项：
  - 执行 VGRO3：提升 Player 模式入口可发现性（提示文案与入口行为）。

- 时刻：2026-02-23 14:56:12 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO3（Player 模式入口可发现性增强）。
  - 右上角面板入口从单按钮升级为引导卡片：显示当前体验模式、入口说明与快捷键提示。
  - 新增 `Tab` 快捷键用于开关右侧面板（在非文本输入状态下生效），降低新用户发现入口成本。
  - 面板可见时顶部控制区显示当前体验模式标识，降低“当前处于哪种体验”认知负担。
  - 新增并接线本地化文案：模式名称、入口提示、快捷键提示（中/英文）。
  - 项目文档状态更新：VGRO3 完成，VGRO4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer i18n::tests::copyable_toggle_label_is_localized -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer show_chat_panel_requires_expanded_top_and_visibility_enabled -- --nocapture`
- 遗留事项：
  - 执行 VGRO4：补充/更新测试并执行 viewer 回归，验证模式化默认与入口行为。

- 时刻：2026-02-23 15:08:58 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO4（测试补充与 viewer 回归验收）。
  - 回归中发现并修复快捷键细节：面板快捷键判定从“全局键盘输入占用”细化为“仅聊天输入框聚焦时禁用”，降低 `Tab` 被 UI 焦点吞掉的概率。
  - 执行 Web 闭环 smoke（S6）并核验关键语义：
    - `window.__AW_TEST__` 可用。
    - `getState()` 返回 `connectionStatus=connected` 与数值 `tick`。
    - DOM 检查 `canvasCount=1`（画布存在）。
    - console 仅 warning，无 error。
  - 产物截图：
    - `output/playwright/viewer/viewer-web-vgro4.png`
    - `output/playwright/viewer/viewer-web-vgro4-domcheck.png`
    - `output/playwright/viewer/viewer-web-vgro4-tab-open.png`
    - `output/playwright/viewer/viewer-web-vgro4-tab-toggle-fixed.png`
  - 项目文档状态更新：VGRO4 完成，VGRO5 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer show_chat_panel_requires_expanded_top_and_visibility_enabled -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" eval '() => ({ title: document.title, canvasCount: document.querySelectorAll("canvas").length, hasTestApi: typeof window.__AW_TEST__ === "object" })'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vgro4-tab-toggle-fixed.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 执行 VGRO5：回顾设计/项目文档并完成收口状态回写。

- 时刻：2026-02-23 15:11:26 CST
- 完成内容：完成“Viewer 发行体验改造（游戏化优先）”VGRO5（文档回顾与收口）。
  - 回顾并更新设计文档里程碑状态：M1~M5 全部标记完成。
  - 补充设计文档“当前结论”：明确默认 Player 体验、Director 回退路径、Web 闭环验收结论。
  - 回写项目管理文档状态：VGRO0~VGRO5 全部完成，项目收口。
- 测试：
  - 文档收口任务（无新增代码测试；VGRO4 已完成 required-tier + Web 闭环验收）。
- 遗留事项：
  - 无（Viewer 发行体验改造闭环完成）。

- 时刻：2026-02-23 15:22:09 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase2.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase2.project.md`。
  - 项目状态初始化：VRI0 完成，VRI1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI1：实现事件驱动情绪反馈（toast/正负反馈层级）。

- 时刻：2026-02-23 15:28:23 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI1（事件驱动情绪反馈）。
  - `egui_right_panel` 新增 Player 模式反馈 toast 管线：
    - 事件增量同步（避免首次加载历史事件洪泛）；
    - 正向/告警/信息三级反馈色阶；
    - 队列限长（最多 3 条）+ 生命周期与淡出。
  - 反馈渲染改为场景顶部浮层，右侧主面板隐藏时也可显示，确保“世界动作有回响”。
  - 新增单测覆盖：
    - `feedback_tone_for_event_maps_warning_positive_and_info`
    - `push_feedback_toast_clamps_queue_and_removes_oldest`
    - `sync_feedback_toasts_skips_history_then_tracks_new_events_only`
  - 项目文档状态更新：VRI1 完成，VRI2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer show_chat_panel_requires_expanded_top_and_visibility_enabled -- --nocapture`
- 遗留事项：
  - 执行 VRI2：实现 Player 新手引导层与“下一步目标”提示。

- 时刻：2026-02-23 15:38:59 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI2（Player 新手引导与下一步目标）。
  - 新增 Player 引导体系：
    - 左上角新手引导卡（按步骤可关闭，步骤变化后自动恢复）；
    - 左下角“下一步目标”常驻提示（连接/开面板/选目标/推进任务四阶段）。
  - 新增引导状态与阶段判定逻辑：`ConnectionStatus`、面板显隐、当前选择共同决定当前目标。
  - 右侧面板代码拆分：
    - 新增 `egui_right_panel_player_experience.rs`（反馈与引导逻辑）；
    - 新增 `egui_right_panel_layout.rs`（布局与快捷键计算）；
    - `egui_right_panel.rs` 降至 1199 行，满足单文件行数约束。
  - 新增/更新单测覆盖：
    - `resolve_player_guide_step_prioritizes_connection_panel_and_selection`
    - `player_onboarding_visibility_tracks_dismissed_step_only`
    - 保持 `feedback_*` 与布局函数测试通过（拆分后回归）。
  - 项目文档状态更新：VRI2 完成，VRI3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_guide_step_prioritizes_connection_panel_and_selection -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_onboarding_visibility_tracks_dismissed_step_only -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer adaptive_panel_width_clamps_to_bounds -- --nocapture`
- 遗留事项：
  - 执行 VRI3：实现 Player 轻量 HUD 与风格收敛。

- 时刻：2026-02-23 15:46:22 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI3（Player 轻量 HUD 与风格收敛）。
  - 新增 Player 紧凑 HUD（顶部浮层）：展示连接状态、Tick、事件数、当前目标与当前阶段目标，强化“玩”的主反馈路径。
  - HUD 支持阶段色彩联动和轻微脉冲高亮，提升状态可读性与视觉活力。
  - 右上角面板入口卡增加 Player 模式动态描边与色彩风格收敛，减少“工具面板感”。
  - 新增 `PlayerHudSnapshot` 纯计算层，UI 展示与数据计算解耦，便于测试。
  - 继续拆分右侧面板工具函数：新增 `egui_right_panel_text_utils.rs`，`egui_right_panel.rs` 保持在 1197 行以内。
  - 新增单测覆盖：
    - `build_player_hud_snapshot_formats_connected_selected_state`
    - `build_player_hud_snapshot_uses_unselected_fallback_text`
  - 项目文档状态更新：VRI3 完成，VRI4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_onboarding_visibility_tracks_dismissed_step_only -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer adaptive_panel_width_clamps_to_bounds -- --nocapture`
- 遗留事项：
  - 执行 VRI4：完成回归测试与 Web 闭环验收，并收口文档状态。

- 时刻：2026-02-23 15:54:06 CST
- 完成内容：完成“Viewer 发行体验改造（第二阶段：沉浸与引导）”VRI4（回归 + Web 闭环 + 文档收口）。
  - 执行真实 Web 闭环验收（Playwright）：
    - `window.__AW_TEST__.getState()` 可用，状态为 `connectionStatus=connected`；
    - 页面基础语义正常（`title` 正确，`canvasCount=1`，`hasTestApi=true`）；
    - `Tab` 面板切换链路可用，HUD/引导与面板状态在实际页面可观察。
  - 新增验收截图：
    - `output/playwright/viewer/viewer-web-vri4-player-hud-hidden.png`
    - `output/playwright/viewer/viewer-web-vri4-player-hud-panel-open.png`
    - `output/playwright/viewer/viewer-web-vri4-player-hud-panel-closed-again.png`
  - 回写设计文档里程碑状态：M1~M5 全部完成，并补充验收结论。
  - 回写项目管理文档状态：VRI0~VRI4 全部完成，第二阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer truncate_observe_text_supports_multibyte_chars -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer event_row_preview_limit_uses_constant -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5033 --web-bind 127.0.0.1:5111 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4273`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh open \"http://127.0.0.1:4273/?ws=ws://127.0.0.1:5111&test_api=1\"`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => window.__AW_TEST__ ? window.__AW_TEST__.getState() : null'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => ({ title: document.title, canvasCount: document.querySelectorAll(\"canvas\").length, hasTestApi: typeof window.__AW_TEST__ === \"object\" })'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh press Tab`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh screenshot --filename output/playwright/viewer/viewer-web-vri4-player-hud-panel-open.png`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh console`
- 遗留事项：
  - 无（Viewer 第二阶段沉浸与引导改造闭环完成）。

- 时刻：2026-02-23 16:48:57 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase3.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase3.project.md`。
  - 项目状态初始化：VRI3P0 完成，VRI3P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI3P1：实现 Player 里程碑成就反馈（解锁弹层/防重入/淡出）。

- 时刻：2026-02-23 16:54:34 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P1（Player 里程碑成就反馈）。
  - `egui_right_panel_player_experience` 新增里程碑成就系统：
    - 成就状态：已解锁集合 + 弹层队列；
    - 触发里程碑：连接成功、展开面板、首次选中目标、首次收到世界事件；
    - 防重入：已解锁里程碑不重复入队；
    - 视觉反馈：右上角里程碑弹层，带自动淡出与队列上限。
  - `egui_right_panel` 接入成就同步与渲染，Player 模式下与 HUD/引导层协同显示。
  - 新增单测覆盖：
    - `sync_player_achievements_unlocks_milestones_without_reentry`
    - `sync_player_achievements_clamps_popup_queue_and_expires`
  - 项目文档状态更新：VRI3P1 完成，VRI3P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_guide_step_prioritizes_connection_panel_and_selection -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
- 遗留事项：
  - 执行 VRI3P2：实现 Agent 事件气泡反馈（增量事件驱动/队列管理）。

- 时刻：2026-02-23 17:03:17 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P2（Agent 事件气泡反馈）。
  - `egui_right_panel_player_experience` 新增 Agent 事件气泡管线：
    - 事件增量游标（首帧跳过历史事件）；
    - 事件到气泡短句映射（移动/采集/开采/精炼/建造/配方/拒绝）；
    - 队列上限 + 生命周期淡出 + 右下角浮层渲染。
  - 将气泡同步与渲染接入 `render_player_experience_layers`，与里程碑成就/HUD/引导层协同。
  - 按文件行数约束拆分新增测试模块：`egui_right_panel_player_chatter_tests.rs`。
  - 新增单测覆盖：
    - `sync_agent_chatter_bubbles_skips_history_then_tracks_new_events_only`
    - `sync_agent_chatter_bubbles_clamps_queue_and_expires`
  - 项目文档状态更新：VRI3P2 完成，VRI3P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_agent_chatter_bubbles_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
- 遗留事项：
  - 执行 VRI3P3：回归测试 + Web 闭环验收 + 第三阶段文档收口。

- 时刻：2026-02-23 17:20:12 CST
- 完成内容：完成“Viewer 发行体验改造（第三阶段：情绪闭环与世界活性）”VRI3P3（回归 + Web 闭环 + 文档收口）。
  - 执行第三阶段回归测试与真实 Web 闭环验收（Playwright）：
    - `window.__AW_TEST__.getState()` 可访问，`connectionStatus=connected`；
    - 页面基础语义正常（`title` 正确，`canvasCount=1`，`hasTestApi=true`）；
    - `Tab` 面板切换可用，Player HUD/引导层与右侧面板切换可观察；
    - 通过 `window.__AW_TEST__.select(\"first_agent\")` 验证目标选择链路可用。
  - 新增第三阶段验收截图：
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-hidden.png`
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-panel-open.png`
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-panel-closed.png`
    - `output/playwright/viewer/viewer-web-vri3p3-player-overlays-selected-achievement-open-panel.png`
  - 回写第三阶段设计文档：补充里程碑状态与验收结论。
  - 回写项目管理文档：VRI3P0~VRI3P3 全部完成，第三阶段收口。
  - 观察备注：本次 live Web 会话中 `tick/eventCount` 保持 0，未在同次验收画面直接观察到事件气泡触发；对应增量事件与队列逻辑由 `sync_agent_chatter_bubbles_*` 单测覆盖。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_agent_chatter_bubbles_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer feedback_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- power_bootstrap --bind 127.0.0.1:5033 --web-bind 127.0.0.1:5111 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4273`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh open \"http://127.0.0.1:4273/?ws=ws://127.0.0.1:5111&test_api=1\"`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => window.__AW_TEST__ ? window.__AW_TEST__.getState() : null'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh eval '() => ({ title: document.title, canvasCount: document.querySelectorAll(\"canvas\").length, hasTestApi: typeof window.__AW_TEST__ === \"object\" })'`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh press Tab`
  - `bash /Users/scc/.codex/skills/playwright/scripts/playwright_cli.sh screenshot --filename output/playwright/viewer/viewer-web-vri3p3-player-overlays-panel-open.png`
- 遗留事项：
  - 无（第三阶段闭环完成）。

- 时刻：2026-02-23 17:32:40 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase4.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase4.project.md`。
  - 项目状态初始化：VRI4P0 完成，VRI4P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI4P1：实现 Player 场景氛围层（背景层次/呼吸光晕/边缘发光）。

- 时刻：2026-02-23 17:36:42 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P1（Player 场景氛围层）。
  - `egui_right_panel_player_experience` 新增 Player 氛围层：
    - 新增 `build_player_atmosphere_snapshot`（纯计算）：输出顶/底透明度、光晕位置与半径；
    - 新增 `render_player_atmosphere`：渲染顶部/底部氛围层与动态光晕；
    - 在 `render_player_experience_layers` 中接入氛围层，统一由 Player 体验层管理。
  - 新增单测模块：`egui_right_panel_player_atmosphere_tests.rs`。
  - 新增单测覆盖：
    - `build_player_atmosphere_snapshot_clamps_expected_ranges`
    - `build_player_atmosphere_snapshot_changes_over_time`
  - 项目文档状态更新：VRI4P1 完成，VRI4P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_atmosphere_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_player_achievements_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_agent_chatter_bubbles_ -- --nocapture`
- 遗留事项：
  - 执行 VRI4P2：实现 Player 引导与目标卡片过渡动效（淡入/位移/脉冲）。

- 时刻：2026-02-23 17:43:44 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P2（Player 引导与目标卡片过渡动效）。
  - 新增动效状态模块：`egui_right_panel_player_card_motion.rs`。
  - 引导卡与目标卡接入过渡参数：淡入（alpha）、位移（slide）、脉冲（pulse）。
  - 在 `render_player_experience_layers` 中按引导步骤同步过渡状态，步骤变化时重启动效。
  - 新增单测模块：`egui_right_panel_player_card_motion_tests.rs`。
  - 新增单测覆盖：
    - `player_card_transition_fades_in_and_settles_slide_distance`
    - `player_card_transition_restarts_entry_when_guide_step_changes`
  - 项目文档状态更新：VRI4P2 完成，VRI4P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_card_transition_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_onboarding_visibility_tracks_dismissed_step_only -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI4P3：回归测试 + Web 闭环验收 + 第四阶段文档收口。

- 时刻：2026-02-23 17:50:56 CST
- 完成内容：完成“Viewer 发行体验改造（第四阶段：场景活化与交互动效）”VRI4P3（回归 + Web 闭环 + 文档收口）。
  - 执行第四阶段回归：`agent_world_viewer` 全量单测与 wasm 编译检查通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用，`getState()` 返回 `tick/connectionStatus`；
    - `runSteps + sendControl("pause") + Tab` 面板切换链路可用；
    - console 结果 `Errors: 0`（2 条 warning）。
  - 新增第四阶段验收截图：
    - `output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-open.png`
    - `output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-hidden.png`
  - 回写第四阶段设计文档验收结论，回写项目管理文档状态（VRI4P0~VRI4P3 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" snapshot`
  - `bash "$PWCLI" eval '() => typeof window.__AW_TEST__ === "object"'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.4")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.sendControl("pause")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-open.png`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri4p3-player-overlays-panel-hidden.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 无（第四阶段闭环完成）。

- 时刻：2026-02-23 18:15:44 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase5.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase5.project.md`。
  - 项目状态初始化：VRI5P0 完成，VRI5P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI5P1：实现 Player 右侧面板沉浸式结构重构（边缘呼出入口 + 面板宽度预算约束）。

- 时刻：2026-02-23 18:20:12 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P1（Player 右侧面板沉浸式结构重构）。
  - 新增隐藏态入口模块：`egui_right_panel_player_entry.rs`，将右上入口卡从主文件拆出。
  - Player 模式隐藏态新增边缘呼出提示（Edge Drawer），保留快捷键提示与按钮入口。
  - 新增 Player 模式右侧主面板宽度预算函数：`player_main_panel_max_width_for_layout`，默认限制主面板占比，保障主场景视野。
  - `egui_right_panel.rs` 接入新入口模块与 Player 宽度预算逻辑。
  - 新增单测：`player_main_panel_max_width_for_layout_keeps_world_first_budget`。
  - 项目文档状态更新：VRI5P1 完成，VRI5P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_main_panel_max_width_for_layout_keeps_world_first_budget -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer adaptive_main_panel_max_width_for_layout_respects_interaction_budget -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI5P2：实现新手任务闭环提示增强，并拆分 `egui_right_panel_player_experience.rs` 至合规行数。

- 时刻：2026-02-23 18:26:43 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P2（新手任务闭环提示增强 + 模块拆分）。
  - 新增引导模块：`egui_right_panel_player_guide.rs`。
    - 抽离引导文案与配色；
    - 新增 `build_player_guide_progress_snapshot`，统一计算 4 步闭环进度。
  - `egui_right_panel_player_experience.rs` 接入进度视图：
    - 目标卡与引导卡显示“引导进度 x/4”；
    - 逐步状态行（`✓ / ▶ / ·`）可视化当前阶段与已完成阶段。
  - 新增单测模块：`egui_right_panel_player_guide_progress_tests.rs`。
  - 新增单测：`build_player_guide_progress_snapshot_tracks_step_completion`。
  - 文件约束处理：`egui_right_panel_player_experience.rs` 从 1221 行拆分至 1187 行（<=1200）。
  - 项目文档状态更新：VRI5P2 完成，VRI5P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_guide_progress_snapshot_tracks_step_completion -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_guide_step_prioritizes_connection_panel_and_selection -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_hud_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI5P3：回归测试 + Web 闭环验收 + 第五阶段文档收口。

- 时刻：2026-02-23 18:31:56 CST
- 完成内容：完成“Viewer 发行体验改造（第五阶段：沉浸式布局与新手闭环）”VRI5P3（回归 + Web 闭环 + 文档收口）。
  - 执行第五阶段回归：`agent_world_viewer` 全量单测与 wasm 编译检查通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用；`getState()` 返回 `tick/connectionStatus`；
    - `runSteps + sendControl("pause") + Tab` 链路可用；
    - console 结果 `Errors: 0`（warning 1 条）。
  - 新增第五阶段验收截图：
    - `output/playwright/viewer/viewer-web-vri5p3-player-edge-hidden.png`
    - `output/playwright/viewer/viewer-web-vri5p3-player-edge-open.png`
  - 回写第五阶段设计文档验收结论，回写项目管理文档状态（VRI5P0~VRI5P3 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5026 --web-bind 127.0.0.1:5014 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4175`
  - `bash "$PWCLI" open "http://127.0.0.1:4175/?ws=ws://127.0.0.1:5014&test_api=1"`
  - `bash "$PWCLI" snapshot`
  - `bash "$PWCLI" eval '() => typeof window.__AW_TEST__ === "object"'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.5")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.sendControl("pause")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri5p3-player-edge-hidden.png`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/viewer-web-vri5p3-player-edge-open.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 无（第五阶段闭环完成）。

- 时刻：2026-02-23 19:20:03 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase6.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase6.project.md`。
  - 项目状态初始化：VRI6P0 完成，VRI6P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI6P1：实现 Player 电影化开场层（连接后短时叙事覆盖 + 自动淡出）。

- 时刻：2026-02-23 19:23:33 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P1（Player 电影化开场层）。
  - 在 `egui_right_panel_player_guide.rs` 新增电影化开场能力：
    - 新增 `player_cinematic_intro_alpha`，按 Tick 计算开场淡入/停留/淡出曲线；
    - 新增 `render_player_cinematic_intro`，在 Player 模式渲染短时叙事开场层（低遮挡、自动淡出）。
  - 在 `egui_right_panel_player_experience.rs` 接入电影化开场渲染链。
  - 新增单测模块：`egui_right_panel_player_cinematic_tests.rs`。
  - 新增单测覆盖：
    - `player_cinematic_intro_alpha_requires_connected_status`
    - `player_cinematic_intro_alpha_fades_and_expires_by_tick`
  - 项目文档状态更新：VRI6P1 完成，VRI6P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_cinematic_intro_alpha_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_guide_progress_snapshot_tracks_step_completion -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P2：实现任务驱动 HUD（主任务/步骤进度/当前动作提示）。

- 时刻：2026-02-23 19:27:32 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P2（任务驱动 HUD）。
  - 在 `egui_right_panel_player_guide.rs` 新增任务闭环快照与渲染：
    - 新增 `PlayerMissionLoopSnapshot` 与 `build_player_mission_loop_snapshot`；
    - 新增 `render_player_mission_hud`，显示主任务标题、当前目标、步骤进度条与动作按钮。
  - 在 `egui_right_panel_player_experience.rs` 接入 `render_player_mission_hud`。
  - 新增单测模块：`egui_right_panel_player_mission_tests.rs`。
  - 新增单测覆盖：
    - `build_player_mission_loop_snapshot_open_panel_requires_open_action`
    - `build_player_mission_loop_snapshot_reports_progress_and_objective`
  - 项目文档状态更新：VRI6P2 完成，VRI6P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_mission_loop_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_cinematic_intro_alpha_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P3：实现任务推进奖励反馈强化（完成态文本与视觉层级）。

- 时刻：2026-02-23 19:30:28 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P3（任务推进奖励反馈强化）。
  - 在 `egui_right_panel_player_guide.rs` 新增奖励反馈快照：
    - 新增 `PlayerRewardFeedbackSnapshot` 与 `build_player_reward_feedback_snapshot`；
    - 按任务完成步数输出推进态/完成态文案与层级。
  - 将奖励反馈层接入 `render_player_mission_hud`：
    - 任务推进态显示 `Progress Reward / Momentum Building`；
    - 闭环完成态显示 `Reward / Loop Completed`，并提升视觉强调。
  - 新增单测模块：`egui_right_panel_player_reward_tests.rs`。
  - 新增单测覆盖：
    - `build_player_reward_feedback_snapshot_marks_completion_on_four_steps`
    - `build_player_reward_feedback_snapshot_shows_momentum_before_completion`
  - 项目文档状态更新：VRI6P3 完成，VRI6P4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_reward_feedback_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_mission_loop_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P4：实现 Player 小地图卡片（位置缩略 + 选中高亮联动）。

- 时刻：2026-02-23 19:36:11 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P4（Player 小地图卡片）。
  - 在 `egui_right_panel_player_guide.rs` 新增小地图数据与渲染链：
    - 新增 `PlayerMiniMapPoint`；
    - 新增 `resolve_selected_location_id_for_minimap`（位置/Agent 选中联动）；
    - 新增 `build_player_minimap_points`（位置坐标归一化）；
    - 新增小地图渲染卡片（右下角锚点、位置点、选中高亮与计数文案）。
  - `render_player_mission_hud` 接入小地图卡片渲染。
  - 为行数约束收敛，将 `render_player_guide_progress_lines` 从 `player_experience` 抽回 `player_guide` 模块。
  - 新增单测模块：`egui_right_panel_player_minimap_tests.rs`。
  - 新增单测覆盖：
    - `build_player_minimap_points_normalizes_and_marks_selected`
    - `resolve_selected_location_id_for_minimap_follows_selection_kind`
  - 项目文档状态更新：VRI6P4 完成，VRI6P5 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_minimap_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_selected_location_id_for_minimap_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI6P5：回归测试 + Web 闭环验收 + 文档收口。

- 时刻：2026-02-23 19:42:39 CST
- 完成内容：完成“Viewer 发行体验改造（第六阶段：任务驱动与电影化首屏）”VRI6P5（回归 + Web 闭环 + 文档收口）。
  - 执行第六阶段回归：`agent_world_viewer` 全量单测与 wasm 编译检查通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用；
    - `runSteps + sendControl("pause") + Tab` 链路可用；
    - `getState()` 返回 `tick/connectionStatus`；
    - console 结果 `Errors: 0`（Warnings: 4）。
  - 新增第六阶段验收截图：
    - `output/playwright/viewer/phase6/phase6-cinematic.png`
    - `output/playwright/viewer/phase6/phase6-panel-open.png`
    - `output/playwright/viewer/phase6/phase6-panel-hidden.png`
    - `output/playwright/viewer/phase6/phase6-mission-minimap.png`
  - 回写第六阶段设计文档验收结论，回写项目管理文档状态（VRI6P0~VRI6P5 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" snapshot`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("wait=1.0")'`
  - `bash "$PWCLI" eval '() => typeof window.__AW_TEST__ === "object"'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.3")'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.sendControl("pause")'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/phase6/phase6-mission-minimap.png`
  - `bash "$PWCLI" console`
- 遗留事项：
  - 无（第六阶段闭环完成）。

- 时刻：2026-02-23 20:04:12 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase7.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase7.project.md`。
  - 项目状态初始化：VRI7P0 完成，VRI7P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI7P1：实现 Player 布局预设（任务/指挥/情报）与快捷切换条。

- 时刻：2026-02-23 20:08:30 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P1（Player 布局预设与快捷切换条）。
  - 在 `egui_right_panel_player_guide.rs` 新增 Player 布局预设能力：
    - 新增 `PlayerLayoutPreset`（Mission / Command / Intel）；
    - 新增 `resolve_player_layout_preset` 与 `apply_player_layout_preset`（预设判定与应用）；
    - 新增 `render_player_layout_preset_strip`（顶部快捷切换条）。
  - 在 `egui_right_panel_player_experience.rs` 接入布局切换条渲染链。
  - 在 `egui_right_panel.rs` 将 `module_visibility` 透传至 Player 体验层。
  - 新增单测模块：`egui_right_panel_player_layout_tests.rs`。
  - 新增单测覆盖：
    - `apply_player_layout_preset_command_opens_panel_and_enables_chat`
    - `apply_player_layout_preset_mission_reduces_non_essential_sections`
    - `resolve_player_layout_preset_tracks_command_and_intel_state`
  - 项目文档状态更新：VRI7P1 完成，VRI7P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_layout_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer resolve_player_layout_preset_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI7P2：实现隐藏状态“直接指挥”入口，并接入指挥预设联动。

- 时刻：2026-02-23 20:11:30 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P2（隐藏态直接指挥入口）。
  - 在 `egui_right_panel_player_entry.rs` 增强隐藏态入口：
    - 新增 `activate_player_command_entry`，统一切换到 Command 预设；
    - 主入口卡新增“直接指挥 / Command Now”按钮；
    - 右侧边缘呼出卡新增“指挥 / Command”按钮。
  - 在 `egui_right_panel.rs` 透传 `module_visibility` 给隐藏态入口，支持入口按钮直接修改模块显隐。
  - 新增单测模块：`egui_right_panel_player_entry_tests.rs`。
  - 新增单测覆盖：
    - `activate_player_command_entry_opens_panel_and_switches_to_command_layout`
  - 项目文档状态更新：VRI7P2 完成，VRI7P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer activate_player_command_entry_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_layout_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI7P3：调整 Player 默认模块可见性与面板宽度预算（世界优先）。

- 时刻：2026-02-23 20:16:41 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P3（Player 默认可指挥 + 世界优先宽度预算）。
  - 在 `app_bootstrap.rs` 调整 Player 默认模块可见性：
    - `show_chat` 默认改为 `true`，确保玩家展开面板即可直接进入指挥链路。
  - 在 `egui_right_panel_layout.rs` 新增 Player 专用宽度预算：
    - 新增 `player_chat_panel_max_width_for_side_layout`；
    - 新增 Player 总宽度预算比例与主面板沉浸上限比例；
    - `player_main_panel_max_width_for_layout` 改为使用 Player 专用预算。
  - 在 `egui_right_panel.rs` 接入 Player 专用聊天侧栏宽度预算，避免宽屏场景下右侧面板可拖拽到过度挤占世界视野。
  - 补充/更新单测：
    - `player_chat_panel_max_width_for_side_layout_keeps_world_first_budget`
    - `player_main_panel_max_width_for_layout_keeps_world_first_budget`
    - `default_module_visibility_state_player_is_lightweight`
  - 项目文档状态更新：VRI7P3 完成，VRI7P4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer world_first_budget -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_module_visibility_state_player_is_lightweight -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI7P4：执行回归与 Web 闭环验收并完成文档收口。

- 时刻：2026-02-23 20:22:05 CST
- 完成内容：完成“Viewer 发行体验改造（第七阶段：整体布局重构与指挥优先）”VRI7P4（回归 + Web 闭环 + 文档收口）。
  - 执行 `agent_world_viewer` 回归与 wasm 检查并通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）：
    - `window.__AW_TEST__` 可用；
    - `runSteps` / `sendControl("pause")` / `Tab` 展开收起链路可用；
    - `getState()` 返回 `connectionStatus/tick/selectedKind` 等字段，采样状态为已连接。
  - Console 结果：`Total messages: 12 (Errors: 0, Warnings: 2)`。
  - 产出 phase7 验收截图：
    - `output/playwright/viewer/phase7/phase7-hidden-default.png`
    - `output/playwright/viewer/phase7/phase7-hidden-focused.png`
    - `output/playwright/viewer/phase7/phase7-panel-open-command-default.png`
    - `output/playwright/viewer/phase7/phase7-panel-open-paused.png`
    - `output/playwright/viewer/phase7/phase7-panel-hidden-after-toggle.png`
  - 回写第七阶段设计文档与项目管理文档状态（VRI7P0~VRI7P4 全部完成）。
  - 清理后台 `world_viewer_live` 与 `run-viewer-web.sh` 进程，避免端口残留。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash \"$PWCLI\" open \"http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1\"`
  - `bash \"$PWCLI\" snapshot`
  - `bash \"$PWCLI\" eval '() => typeof window.__AW_TEST__ === \"object\"'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.runSteps(\"mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.6\")'`
  - `bash \"$PWCLI\" press Tab`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.sendControl(\"pause\")'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.getState()'`
  - `bash \"$PWCLI\" console`
  - `bash \"$PWCLI\" screenshot --filename output/playwright/viewer/phase7/phase7-panel-open-command-default.png`
- 遗留事项：
  - 无（第七阶段闭环完成）。

- 时刻：2026-02-23 20:28:29 CST
- 完成内容：完成“Viewer 发行体验改造（第八阶段：信息分层减负与焦点收敛）”VRI8P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase8.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase8.project.md`。
  - 项目状态初始化：VRI8P0 完成，VRI8P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI8P1：收敛“下一步目标卡”与“新手引导卡”共存策略，去除重复提示。

- 时刻：2026-02-23 20:32:04 CST
- 完成内容：完成“Viewer 发行体验改造（第八阶段：信息分层减负与焦点收敛）”VRI8P1（引导提示去重策略）。
  - 在 `egui_right_panel_player_experience.rs` 新增 `should_show_player_goal_hint` 显示策略：
    - 仅在面板隐藏（`panel_hidden=true`）且当前步骤引导卡已收起时显示“下一步目标卡”；
    - 避免与“新手引导卡”同时展示同类目标信息。
  - 在 `render_player_experience_layers` 接入新策略，目标提示卡改为条件渲染。
  - 在 `egui_right_panel_tests.rs` 新增单测：
    - `player_goal_hint_visibility_requires_hidden_panel_and_dismissed_step`
  - 项目文档状态更新：VRI8P1 完成，VRI8P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_goal_hint_visibility_requires_hidden_panel_and_dismissed_step -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_onboarding_visibility_tracks_dismissed_step_only -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI8P2：改造任务 HUD 的自适应锚点与展开态紧凑模式。

- 时刻：2026-02-23 20:35:33 CST
- 完成内容：完成“Viewer 发行体验改造（第八阶段：信息分层减负与焦点收敛）”VRI8P2（任务 HUD 自适应锚点与紧凑模式）。
  - 在 `egui_right_panel_player_guide.rs` 调整任务 HUD 渲染策略：
    - 新增 `onboarding_visible` 入参；
    - 新增展开态紧凑模式（面板展开时隐藏冗余说明与奖励详情块，仅保留核心目标/进度/动作）；
    - 新增自适应锚点规则：展开态 `y=96`，隐藏态且引导可见 `y=214`，隐藏态默认 `y=136`。
  - 在 `egui_right_panel_player_experience.rs` 接入 `onboarding_visible` 计算与透传，并只在该步骤引导可见时渲染 onboarding 卡。
  - 新增单测：
    - `player_mission_hud_compact_mode_tracks_panel_visibility`
    - `player_mission_hud_anchor_avoids_onboarding_overlap`
  - 项目文档状态更新：VRI8P2 完成，VRI8P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_mission_hud_compact_mode_tracks_panel_visibility -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_mission_hud_anchor_avoids_onboarding_overlap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_mission_loop_snapshot_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI8P3：执行回归与 Web 闭环验收并完成文档收口。

- 时刻：2026-02-23 20:43:20 CST
- 完成内容：完成“Viewer 发行体验改造（第八阶段：信息分层减负与焦点收敛）”VRI8P3（回归 + Web 闭环 + 文档收口）。
  - 执行 `agent_world_viewer` 全量回归测试与 wasm 检查并通过：
    - `cargo test` 325 项通过；
    - wasm target `cargo check` 通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright）并采样 Player 关键态：
    - 隐藏默认态、隐藏聚焦态、展开紧凑态、再次收起态；
    - `window.__AW_TEST__` 可用，状态采样显示连接正常与 tick 推进正常。
  - Console 汇总：`Total messages: 12 (Errors: 0, Warnings: 2)`，未出现新增功能性错误。
  - 回写 phase8 设计文档与项目管理文档状态，阶段任务 VRI8P0~VRI8P3 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash \"$PWCLI\" open \"http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1\"`
  - `bash \"$PWCLI\" snapshot`
  - `bash \"$PWCLI\" eval '() => typeof window.__AW_TEST__ === \"object\"'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.runSteps(\"mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.6\")'`
  - `bash \"$PWCLI\" press Tab`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.getState()'`
  - `bash \"$PWCLI\" console`
  - `bash \"$PWCLI\" screenshot --filename output/playwright/viewer/phase8/phase8-panel-open-compact.png`
- 遗留事项：
  - 无（第八阶段闭环完成）。

- 时刻：2026-02-23 20:52:51 CST
- 完成内容：完成“Viewer 发行体验改造（第九阶段：指挥链路前置与顶层减噪）”VRI9P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase9.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase9.project.md`。
  - 项目状态初始化：VRI9P0 完成，VRI9P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI9P1：实现顶部布局预设条减噪策略（隐藏态移除 + 锚点重排）并补单测。

- 时刻：2026-02-23 20:55:24 CST
- 完成内容：完成“Viewer 发行体验改造（第九阶段：指挥链路前置与顶层减噪）”VRI9P1（顶部布局预设条减噪）。
  - 在 `egui_right_panel_player_guide.rs` 新增纯函数：
    - `should_show_player_layout_preset_strip`（隐藏态不显示布局预设条）；
    - `player_layout_preset_strip_anchor_y`（展开态锚点下移到 `58.0`）。
  - `render_player_layout_preset_strip` 接入显隐与锚点策略：
    - 面板隐藏时不渲染；
    - 面板展开时使用下移锚点，避免与顶部 compact HUD 同位叠压。
  - 在 `egui_right_panel_player_layout_tests.rs` 新增单测：
    - `player_layout_strip_visibility_follows_panel_hidden_state`;
    - `player_layout_strip_anchor_moves_below_compact_hud`。
  - 项目文档状态更新：VRI9P1 完成，VRI9P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_layout_strip_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI9P2：实现隐藏态任务 HUD“一键指挥 Agent”入口并补单测。

- 时刻：2026-02-23 20:58:23 CST
- 完成内容：完成“Viewer 发行体验改造（第九阶段：指挥链路前置与顶层减噪）”VRI9P2（隐藏态任务 HUD 一键指挥）。
  - 在 `egui_right_panel_player_guide.rs` 扩展任务 HUD 交互：
    - `render_player_mission_hud` 新增 `module_visibility` 入参；
    - 隐藏态新增“直接指挥 Agent / Command Agent”按钮；
    - 点击后直接应用 `PlayerLayoutPreset::Command`（展开面板并开启 Chat）。
  - 新增纯函数 `player_mission_hud_show_command_action`，将按钮显隐规则收敛为可测逻辑。
  - 在 `egui_right_panel_player_experience.rs` 接入新的 `render_player_mission_hud` 参数透传。
  - 在 `egui_right_panel_player_mission_tests.rs` 新增单测：
    - `player_mission_hud_command_action_only_visible_when_hidden`。
  - 项目文档状态更新：VRI9P2 完成，VRI9P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer player_mission_hud_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer activate_player_command_entry_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VRI9P3：执行回归与 Web 闭环验收并完成文档收口。

- 时刻：2026-02-23 21:05:45 CST
- 完成内容：完成“Viewer 发行体验改造（第九阶段：指挥链路前置与顶层减噪）”VRI9P3（回归 + Web 闭环 + 文档收口）。
  - 执行 `agent_world_viewer` 全量回归与 wasm 检查并通过。
  - 按 `testing-manual.md` S6 执行真实 Web 闭环（Playwright skill）：
    - 打开 `?test_api=1` 页面并验证 `window.__AW_TEST__`；
    - 执行 `runSteps(...)` 与 `Tab` 展开/收起；
    - 采样 `getState()`，状态为 `connectionStatus=connected`。
  - Console 汇总：`Total messages: 11 (Errors: 0, Warnings: 1)`。
  - 输出 phase9 验收截图：
    - `output/playwright/viewer/phase9/phase9-hidden-default.png`
    - `output/playwright/viewer/phase9/phase9-hidden-focused.png`
    - `output/playwright/viewer/phase9/phase9-panel-open-command.png`
    - `output/playwright/viewer/phase9/phase9-panel-hidden-after-toggle.png`
  - 回写 phase9 设计文档与项目管理文档，VRI9P0~VRI9P3 全部完成。
  - 关闭 Playwright 浏览器并清理 `world_viewer_live`/`run-viewer-web.sh` 进程，端口 `4173/5011` 已释放。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" snapshot`
  - `bash "$PWCLI" eval '() => typeof window.__AW_TEST__ === "object"'`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.6")'`
  - `bash "$PWCLI" press Tab`
  - `bash "$PWCLI" eval '() => window.__AW_TEST__.getState()'`
  - `bash "$PWCLI" console`
  - `bash "$PWCLI" screenshot --filename output/playwright/viewer/phase9/phase9-panel-open-command.png`
- 遗留事项：
  - 无（第九阶段闭环完成）。

- 时刻：2026-02-23 21:24:43 CST
- 完成内容：完成“Viewer 发行体验改造（第十阶段：新手流程闭环与认知减负）”VRI10P0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase10.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-gameplay-release-immersion-phase10.project.md`。
  - 项目状态初始化：VRI10P0 完成，VRI10P1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VRI10P1：修复教程进度跳步并强化第 4 步动作文案（含单测）。

- 时刻：2026-02-23 21:30:46 CST
- 完成内容：完成“Viewer 发行体验改造第十阶段”VRI10P1（教程闭环门槛 + 第4步动作文案可执行化）。
  - `PlayerGuideProgressSnapshot` 新增动作反馈门槛输入：`ExploreAction` 从“选中目标即完成”改为“选中目标 + 新反馈事件已出现”才完成，修复 `2/4 -> 4/4` 跳步。
  - `FeedbackToastState` 新增持久信号 `action_feedback_seen`：首轮历史事件仅建立基线，不触发完成；仅在基线后出现新事件时置位。
  - 第4步中英文提示改为可执行动作：明确“点击直接指挥 Agent 并发送一条指令后观察反馈”。
  - 任务 HUD 第4步按钮文案同步改为具体行动指令。
  - 回写第十阶段设计/项目文档状态：VRI10P1 完成，VRI10P2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_guide_progress_snapshot_tracks_step_completion`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer build_player_mission_loop_snapshot_reports_progress_and_objective`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer sync_feedback_toasts_skips_history_then_tracks_new_events_only`
- 遗留事项：
  - 执行 VRI10P2：隐藏态引导层减噪，降低多卡并发信息压力并做定向验证。

- 时刻：2026-02-23 21:35:35 CST
- 完成内容：完成“Viewer 发行体验改造第十阶段”VRI10P2（隐藏态引导层减噪）。
  - 新增 `should_render_hidden_panel_top_entry` 策略函数：玩家模式隐藏态不再渲染右上大入口卡，Director 模式保持原有入口。
  - `render_hidden_panel_entry` 改为玩家模式仅保留右侧边缘抽屉（含展开与直接指挥），降低隐藏态并行主卡数量。
  - 边缘抽屉指挥按钮文案统一复用“直接指挥/Command Now”，与任务 HUD 指挥入口保持一致语义。
  - 新增单测 `hidden_panel_top_entry_is_suppressed_in_player_mode`，锁定减噪策略，防止后续回归。
  - 回写第十阶段设计/项目文档状态：VRI10P2 完成，VRI10P3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer hidden_panel_top_entry_is_suppressed_in_player_mode`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer activate_player_command_entry_opens_panel_and_switches_to_command_layout`
- 遗留事项：
  - 执行 VRI10P3：全量回归与 Playwright 新手流程复测，确认第十阶段改造在实际 Web 闭环中的可用性。

- 时刻：2026-02-23 21:42:21 CST
- 完成内容：完成“Viewer 发行体验改造第十阶段”VRI10P3（回归 + Playwright 新手流程复测 + 文档收口）。
  - 执行 S5 回归：`agent_world_viewer` 全量单测与 wasm 编译检查通过。
  - 执行 S6 Web 闭环：启动 `world_viewer_live` 与 `run-viewer-web.sh`，使用 Playwright 按“隐藏态 -> 展开面板 -> 选择目标 -> 隐藏态复查”路径复测。
  - 复测结果：
    - 第4步引导文案已变为可执行动作（“点击直接指挥 Agent 并发送指令”）；
    - 选中目标后引导进度停留在 `3/4`（未再出现即时 `2/4 -> 4/4` 跳步）；
    - 玩家隐藏态右上大入口卡已移除，仅保留边缘抽屉 + 任务 HUD 指挥入口。
  - 控制台记录：`.playwright-cli/console-2026-02-23T13-41-21-606Z.log`（Errors: 0）。
  - Playwright 截图产物：
    - `output/playwright/viewer/phase10/step0-hidden-initial.png`
    - `output/playwright/viewer/phase10/step1-open-panel-tab.png`
    - `output/playwright/viewer/phase10/step2-selected-agent.png`
    - `output/playwright/viewer/phase10/step3-after-play-feedback.png`
    - `output/playwright/viewer/phase10/step4-hidden-no-top-card.png`
  - 回写第十阶段设计/项目文档状态：VRI10P3 完成，第十阶段任务全部闭环。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - Playwright CLI（S6）：`open/snapshot/eval/runSteps/press/screenshot/console/close`
- 遗留事项：
  - 无（第十阶段收口完成）。

- 时刻：2026-02-23 22:11:01 CST
- 完成内容：按用户请求使用 Playwright 复跑 Viewer 新手教程全流程并逐步截图，验证步骤合理性。
  - 先按 `llm_bootstrap + --topology single --viewer-no-consensus-gate` 运行，发现 `tick`/`event` 长时间停留 0，第 4 步无法形成反馈闭环。
  - 切换为 `triad_region_bootstrap + --topology single --no-node` 后，`sendControl("play")` 可驱动 tick 与事件增长，教程可从 `1/4 -> 4/4` 完整推进。
  - 最终截图（逐步覆盖）：
    - `output/playwright/viewer/tutorial-2026-02-23/final-step1-initial.png`
    - `output/playwright/viewer/tutorial-2026-02-23/final-step2-open-panel.png`
    - `output/playwright/viewer/tutorial-2026-02-23/final-step3-select-target.png`
    - `output/playwright/viewer/tutorial-2026-02-23/final-step4-after-feedback.png`
  - 终态观测：第 4 步已到 `4/4`，同时出现资源不足类反馈 toast（`操作受阻`），流程可感知“动作已执行并有反馈”。
  - 控制台汇总：`.playwright-cli/console-2026-02-23T14-09-58-102Z.log`（`Errors: 0`）。
  - 调试结束已关闭 Playwright 会话并清理 `world_viewer_live`/`run-viewer-web.sh`，端口 `4173/5011/5023` 已释放。
- 测试：
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- triad_region_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --no-node`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash "$PWCLI" --session tutorial20260223 open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1"`
  - `bash "$PWCLI" --session tutorial20260223 press Tab`
  - `bash "$PWCLI" --session tutorial20260223 eval '() => window.__AW_TEST__.runSteps("mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.6")'`
  - `bash "$PWCLI" --session tutorial20260223 eval '() => window.__AW_TEST__.sendControl("play")'`
  - `bash "$PWCLI" --session tutorial20260223 screenshot --filename output/playwright/viewer/tutorial-2026-02-23/final-step4-after-feedback.png`
  - `bash "$PWCLI" --session tutorial20260223 console`
  - `bash "$PWCLI" --session tutorial20260223 close`
- 遗留事项：
  - 建议后续把“`--topology single` 且默认内嵌 node”导致的新手流程卡在 `tick=0` 现象补充到手册/脚本默认参数，减少 QA 误判。
- 时刻：2026-02-23 14:20:47 CST
- 完成内容：完成“P2P/区块链链路安全硬化（2026-02-23）”T2（signed consensus signer 绑定完整性强制 + viewer 接线）。
  - `agent_world_node`：`PosNodeEngine::new` 在签名强制模式下新增配置约束：
    - `validator_signer_public_keys` 必须覆盖全部 validator；
    - 本地 validator 的 signer 公钥必须与本地复制签名 key 一致；
    - 不满足时启动前返回 `NodeError::InvalidConfig`，阻断不安全配置进入运行态。
  - `world_viewer_live`：完成 signer 映射接线，single/triad/triad_distributed 均改为：
    - 基于根 key + `node_id` 派生节点共识 signer key；
    - 自动生成完整 validator->signer 公钥映射并写入 `NodePosConfig`；
    - 复制签名 key 与 validator signer 绑定保持一致，避免签名强制模式下启动失败。
  - `agent_world_node` 测试：
    - 新增硬化用例：缺失完整 signer 映射拒绝启动、本地 signer 绑定不匹配拒绝启动；
    - 批量修正签名强制相关集成测试，统一补齐 signer 映射，避免“空映射”绕过路径。
  - `world_viewer_live` 测试：补充启动路径断言，校验自动生成的 `validator_signer_public_keys` 覆盖生效。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_node -p agent_world --bins`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --no-run`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node pos_engine_signature_enforced -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node pos_engine_rejects_signed_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_gossip_replication_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_replication_storage_challenge_gate_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_hardening:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live start_live_node_ -- --nocapture`
- 遗留事项：
  - 执行 T3：实现 replication 远端 writer allowlist 授权校验并补充拒绝路径测试。

- 时刻：2026-02-23 14:30:16 CST
- 完成内容：完成“P2P/区块链链路安全硬化（2026-02-23）”T3（replication 远端 writer allowlist 授权校验）。
  - `NodeReplicationConfig` 增加远端 writer allowlist 配置与规范化校验：
    - `with_remote_writer_allowlist`：显式配置授权 writer 公钥集合（32-byte hex，标准化为小写）；
    - `with_default_remote_writer_allowlist`：在未显式配置时支持注入默认授权集合。
  - `NodeRuntime::start` 增加启动接线：
    - 从 `pos_config.validator_signer_public_keys` 自动注入 replication 默认 writer allowlist；
    - 使 signed consensus 场景下 replication writer 授权默认闭环。
  - `ReplicationRuntime` 增加授权校验链路：
    - 远端消息在签名校验后要求 `record.writer_id` 命中 allowlist；
    - 未授权 writer 返回明确错误；
    - signed 模式下若 allowlist 为空则拒绝远端消息，避免放行回退。
  - 新增测试：
    - `replication::tests::validate_remote_message_for_observe_rejects_writer_outside_allowlist`
    - `replication::tests::validate_remote_message_for_observe_accepts_writer_in_allowlist`
    - `tests_hardening::runtime_replication_ingest_rejects_signed_writer_outside_allowlist`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --no-run`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node validate_remote_message_for_observe_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_replication_ingest_rejects_signed_writer_outside_allowlist -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_syncs_distfs_commit_files -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live start_live_node_starts_triad_topology_by_default -- --nocapture`
- 遗留事项：
  - 执行 T4：实现 fetch-commit/fetch-blob 请求签名鉴权（客户端签名 + 服务端验签）。

- 时刻：2026-02-23 14:42:12 CST
- 完成内容：完成“P2P/区块链链路安全硬化（2026-02-23）”T4（fetch 请求签名鉴权）。
  - `crates/agent_world_node/src/replication.rs`
    - `FetchCommitRequest`/`FetchBlobRequest` 增加请求方公钥与签名字段。
    - 新增 fetch 请求签名负载、签名构造与验签逻辑。
    - `NodeReplicationConfig` 增加 `authorize_fetch_commit_request` / `authorize_fetch_blob_request`，统一执行签名校验与 remote writer allowlist 授权。
    - `ReplicationRuntime` 增加 `build_fetch_commit_request` / `build_fetch_blob_request`，客户端请求自动带签名。
  - `crates/agent_world_node/src/lib.rs`
    - `register_replication_fetch_handlers` 接入 fetch 请求鉴权，未授权请求按 `ErrBadRequest` 拒绝。
    - `sync_replication_height_once` 与 storage challenge 网络取样改为调用 runtime 构建签名请求。
  - `crates/agent_world_node/src/tests.rs`/`tests_hardening.rs`
    - 更新 fetch 请求测试为带签名请求。
    - 新增 hardening 用例：`runtime_fetch_handlers_reject_unsigned_fetch_request_in_signed_mode`。
  - 项目文档状态更新：T4 完成，T5 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node fetch_commit_request_signs_with_runtime_signer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node authorize_fetch_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_fetch_handlers_serve_commit_and_blob -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_gap_sync_fetches_missing_commits -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_gap_sync_not_found_is_non_fatal -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_gap_sync_reports_error_after_retries_exhausted -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_fetch_handlers_reject_unsigned_fetch_request_in_signed_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T5：实现网络订阅有界缓存与 membership DHT 恢复默认策略收紧。

- 时刻：2026-02-23 14:49:47 CST
- 完成内容：完成“P2P/区块链链路安全硬化（2026-02-23）”T5（网络订阅有界缓存 + membership DHT 默认恢复策略收紧）。
  - `crates/agent_world_proto/src/distributed_net.rs`
    - 新增 `DEFAULT_SUBSCRIPTION_INBOX_MAX_MESSAGES` 与 `push_bounded_inbox_message`，超过容量时淘汰最旧消息。
    - `NetworkSubscription` 增加有界容量配置（默认 1024，最小 1），并补单测覆盖。
  - `crates/agent_world_net/src/network.rs` 与 `crates/agent_world_net/src/libp2p_net.rs`
    - 发布/接收消息写入 inbox 时统一走有界写入 helper，避免 topic inbox 无界增长。
  - `crates/agent_world_net/src/tests.rs`
    - 新增 `in_memory_publish_bounded_subscription_inbox_evicts_oldest_messages`，验证超限淘汰最旧消息。
  - `crates/agent_world_consensus/src/membership.rs`
    - `restore_membership_from_dht` 默认策略改为 `require_signature=true`（默认路径拒绝未签名快照）。
  - `crates/agent_world_consensus/src/membership_tests.rs`
    - 旧默认恢复测试调整为 `restore_membership_from_dht_rejects_unsigned_snapshot_by_default`。
  - 项目文档状态更新：T5 完成，T6 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto distributed_net::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net in_memory_publish_bounded_subscription_inbox_evicts_oldest_messages -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus restore_membership_from_dht_rejects_unsigned_snapshot_by_default -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 执行 T6：补齐阶段回归、完成文档收口与最终状态回写。

- 时刻：2026-02-23 14:56:54 CST
- 完成内容：完成“P2P/区块链链路安全硬化（2026-02-23）”T6（回归收口与文档闭环）。
  - 基于 T4/T5 提交门禁完成 required-tier 全量回归，确认安全改造与既有链路兼容。
  - 回写项目管理文档：T0~T6 全部完成，阶段正式收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（六项安全优化任务闭环完成）。

- 时刻：2026-02-23 15:24:12 CST
- 完成内容：完成“Rust 超限文件拆分（第二轮，2026-02-23）”T0（设计与项目管理文档建立）。
  - 新建设计文档：`doc/oversized-rust-file-splitting-round2-2026-02-23.md`。
  - 新建项目管理文档：`doc/oversized-rust-file-splitting-round2-2026-02-23.project.md`。
  - 明确本轮 5 个超限 Rust 文件拆分策略：优先抽离 `#[cfg(test)] mod tests` 到 `tests.rs`，保持行为不变。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_distfs --lib`
- 遗留事项：
  - 执行 T1：拆分 `crates/agent_world_distfs/src/challenge.rs` 测试模块并回归。

- 时刻：2026-02-23 15:26:11 CST
- 完成内容：完成“Rust 超限文件拆分（第二轮，2026-02-23）”T1（`challenge.rs` 测试模块拆分）。
  - `crates/agent_world_distfs/src/challenge.rs`：内联 `#[cfg(test)] mod tests { ... }` 改为 `#[cfg(test)] mod tests;`。
  - 新增 `crates/agent_world_distfs/src/challenge/tests.rs`，迁移原测试实现，保持 `use super::*;` 与断言语义不变。
  - 文件行数收口：`challenge.rs` 从 1217 行降至 790 行（<=1200）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs challenge::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：拆分 `crates/agent_world_consensus/src/pos.rs` 测试模块并回归。

- 时刻：2026-02-23 15:29:43 CST
- 完成内容：完成“Rust 超限文件拆分（第二轮，2026-02-23）”T2（`pos.rs` 测试模块拆分）。
  - `crates/agent_world_consensus/src/pos.rs`：内联测试模块替换为 `#[cfg(test)] mod tests;`。
  - 新增 `crates/agent_world_consensus/src/pos/tests.rs`，迁移原测试实现并保持测试命名空间不变。
  - 文件行数收口：`pos.rs` 从 1210 行降至 907 行（<=1200）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus pos::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：拆分 `crates/agent_world_consensus/src/membership_recovery/replay.rs` 测试模块并回归。

- 时刻：2026-02-23 15:33:20 CST
- 完成内容：完成“Rust 超限文件拆分（第二轮，2026-02-23）”T3（`membership_recovery/replay.rs` 拆分）。
  - `crates/agent_world_consensus/src/membership_recovery/replay.rs`：内联 `tests` 模块拆分为 `#[cfg(test)] mod tests;`，新增 `replay/tests.rs`。
  - 为满足 1200 行限制，进一步将末尾辅助函数 `sort_dead_letter_bucket` 抽离到 `replay/sort.rs`（行为不变）。
  - 文件行数收口：`replay.rs` 从 1218 行降至 1192 行（<=1200）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::replay::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T4：拆分 `crates/agent_world_consensus/src/membership_recovery/replay_archive_federated.rs` 测试模块并回归。

- 时刻：2026-02-23 15:36:04 CST
- 完成内容：完成“Rust 超限文件拆分（第二轮，2026-02-23）”T4（`replay_archive_federated.rs` 测试模块拆分）。
  - `crates/agent_world_consensus/src/membership_recovery/replay_archive_federated.rs`：内联 `tests` 模块替换为 `#[cfg(test)] mod tests;`。
  - 新增 `crates/agent_world_consensus/src/membership_recovery/replay_archive_federated/tests.rs`，保持测试路径与断言不变。
  - 文件行数收口：`replay_archive_federated.rs` 从 1201 行降至 1160 行（<=1200）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus membership_recovery::replay_archive_federated::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T5：拆分 `crates/agent_world_node/src/replication.rs` 测试模块并回归。

- 时刻：2026-02-23 15:38:50 CST
- 完成内容：完成“Rust 超限文件拆分（第二轮，2026-02-23）”T5（`replication.rs` 测试模块拆分）。
  - `crates/agent_world_node/src/replication.rs`：内联 `tests` 模块替换为 `#[cfg(test)] mod tests;`。
  - 新增 `crates/agent_world_node/src/replication/tests.rs`，迁移原测试代码，保持测试命名空间不变。
  - 文件行数收口：`replication.rs` 从 1330 行降至 1059 行（<=1200）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node replication::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T6：复核本轮目标文件行数、执行补充回归并更新文档/devlog收口。

- 时刻：2026-02-23 15:42:46 CST
- 完成内容：完成“Rust 超限文件拆分（第二轮，2026-02-23）”T6（复核与收口）。
  - 复核目标 5 个文件行数均满足约束（<=1200）：
    - `challenge.rs` 790
    - `pos.rs` 907
    - `membership_recovery/replay.rs` 1192
    - `membership_recovery/replay_archive_federated.rs` 1160
    - `replication.rs` 1059
  - 项目管理文档回写为 T0~T6 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_distfs -p agent_world_consensus -p agent_world_node`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs challenge::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node replication::tests:: -- --nocapture`
- 遗留事项：
  - 本轮目标已收口；仓库内其它历史超限文件（如 `crates/agent_world_node/src/lib.rs`）需在后续独立任务中继续拆分。

- 时刻：2026-02-23 16:50:29 CST
- 完成内容：完成“Rust 超限文件拆分（第三轮，2026-02-23）”T0（文档建立）。
  - 新建设计文档：`doc/oversized-rust-file-splitting-round3-2026-02-23.md`。
  - 新建项目管理文档：`doc/oversized-rust-file-splitting-round3-2026-02-23.project.md`。
  - 明确目标：一次性收口当前全部 22 个 Rust 超限文件。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
- 遗留事项：
  - 执行 T1：批量拆分 22 个超限 Rust 文件并通过编译。

- 时刻：2026-02-23 17:02:58 CST
- 完成内容：完成“Rust 超限文件拆分（第三轮，2026-02-23）”T1（22 个超限 Rust 文件批量拆分与编译通过）。
  - 对 22 个 `>1200` 行 Rust 文件完成结构拆分（`include!` 分段）；其中 3 个超长 `impl` 文件改为多 `impl` 分段文件并在顶层拼接，避免 `impl` 体内 `include!` 语法限制。
  - 对 `src/bin` 下拆分文件执行落位修正：将分段文件迁移至各自子目录并修正 `include!`/`#[path]` 路径，避免被 Cargo 识别为额外二进制目标。
  - 拆分后复核：排除 `target/third_party` 后全仓 Rust 文件无超限（`>1200`）项。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world -p agent_world_consensus -p agent_world_node`
- 遗留事项：
  - 执行 T2：完成定向回归并形成“Rust 超限文件 = 0”复核记录。

- 时刻：2026-02-23 17:10:18 CST
- 完成内容：完成“Rust 超限文件拆分（第三轮，2026-02-23）”T2（定向回归 + 超限复核）。
  - 执行定向编译回归并通过：`agent_world`、`agent_world_consensus`、`agent_world_node` 三个 crate 编译无错误。
  - 复核全仓 Rust 行数（排除 `target/third_party` 生成目录），确认无 `>1200` 行文件，达到“Rust 超限文件 = 0”。
  - 回写 round3 设计文档与项目管理文档状态：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world -p agent_world_consensus -p agent_world_node`
  - `find . -name '*.rs' -not -path './third_party/*' -not -path './target/*' -not -path './tools/wasm_build_suite/target/*' -print0 | xargs -0 wc -l | sort -nr | awk '$1>1200{print $1"\t"$2}'`
- 遗留事项：
  - 执行 T3：完成文档与日志收口并关闭 round3。

- 时刻：2026-02-23 17:13:00 CST
- 完成内容：完成“Rust 超限文件拆分（第三轮，2026-02-23）”T3（文档与阶段收口）。
  - 回写 round3 设计文档里程碑状态：M1/M2/M3/M4 全部完成。
  - 回写 round3 项目管理文档状态：T0/T1/T2/T3 全部完成，并标记阶段已收口。
  - 结论确认：本轮目标“全仓 Rust 超限文件清零（排除生成目录）”已达成。
- 测试：
  - 文档收口任务（代码回归已在 T1/T2 与提交门禁完成）。
- 遗留事项：
  - 无（round3 收口完成）。

- 时刻：2026-02-23 18:04:29 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯治理（2026-02-23）”T1（网络与入口背压，对应 1/2）。
  - `crates/agent_world_net/src/libp2p_net.rs`：
    - `command_tx` 从无界通道切换为有界 `mpsc::Sender`；新增 `command_buffer_capacity` 配置；所有命令发送统一收敛到 `enqueue_command`/`try_send_command`，避免无界堆积。
    - `published/errors/listening_addrs` 引入有界窗口（`max_published_messages`、`max_error_messages`、`max_listening_addrs`），超限裁剪最旧项。
    - `republish` 定时线程改为 `try_send` 最佳努力模式，队列拥塞时跳过 tick，断连时退出。
  - `crates/agent_world_net/src/libp2p_net/tests.rs`：新增有界窗口与队列断连错误语义测试。
  - `crates/agent_world_node/src/types.rs`：新增配置项 `max_pending_consensus_actions`、`max_consensus_action_payload_bytes` 与 builder 校验。
  - `crates/agent_world_node/src/node_runtime_core.rs`：`submit_consensus_action_payload_as_player` 增加 payload 大小与 pending 队列容量检查，超限显式拒绝。
  - `crates/agent_world_node/src/tests_action_payload.rs`：新增 oversized payload / queue saturation 拒绝用例。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T2：完成共识历史与 world runtime 队列/日志内存治理（对应 3/4），在保留可追溯信息前提下防止长期内存膨胀。

- 时刻：2026-02-23 18:21:03 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯治理（2026-02-23）”T2（共识与运行时内存治理，对应 3/4）。
  - `crates/agent_world_consensus/src/quorum.rs`：
    - `ConsensusConfig` 新增 `max_records_per_world`，并在 `QuorumConsensus` 内对每个 world 的记录做有界保留。
    - 裁剪策略仅清理已终态（非 Pending）旧记录，避免误删未决共识。
    - 快照读写新增上限字段，保证重启后策略可追溯一致。
  - `crates/agent_world_consensus/src/pos.rs`：
    - `PosConsensusConfig` 新增 `max_records_per_world` 与 `max_attestation_history_per_validator`。
    - 增加 world 级记录裁剪与 validator attestation history 有界保留。
    - 快照读写新增上限字段并保持向后兼容默认值。
  - `crates/agent_world/src/runtime/world/*`：
    - 新增 `WorldRuntimeMemoryLimits` 与 `WorldRuntimeBackpressureStats`（可序列化），记录被淘汰/阻塞统计，保证追溯元信息。
    - `pending_actions`、`pending_effects`、`inflight_effects`、`journal.events` 均增加有界治理与背压行为。
    - `gameplay_loop` 事件采集改为基于 event id 增量，避免日志裁剪后索引漂移。
    - snapshot/persistence 同步持久化 runtime 内存治理配置与统计。
  - 新增/更新测试覆盖：
    - Quorum/PoS 历史裁剪与 pending 保留。
    - runtime pending/inflight/journal 有界行为与 backpressure 统计。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --lib`
- 遗留事项：
  - 执行 T3：完成 dead-letter/metrics 长期膨胀治理与 wasm executor 磁盘缓存安全路径改造（对应 5/6）。

- 时刻：2026-02-23 18:35:28 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯治理（2026-02-23）”T3（Dead-letter 与 wasm cache 安全，对应 5/6）。
  - `crates/agent_world_consensus/src/membership_recovery/dead_letter.rs`：新增 `MembershipRevocationDeadLetterRetention`，对 in-memory dead-letter/metrics 采用有界保留；文件存储改为“活跃流 + archive 分段”策略，并采用流式压缩（内存占用与保留上限线性相关，避免按文件总行数线性增长）。
  - `crates/agent_world_consensus/src/membership_recovery/mod.rs` 与 `crates/agent_world_consensus/src/lib.rs`：导出 retention 配置类型，便于外部按 world/node 维度配置保留策略。
  - `crates/agent_world_wasm_executor/src/lib.rs`：移除 `unsafe wasmtime::Module::deserialize` 路径，磁盘缓存改为原始 wasm 字节（`.wasm`）并通过 `wasmtime::Module::new` 安全加载，损坏缓存自动删除并重建。
  - `crates/agent_world_consensus/src/membership_recovery_tests_split_part1.rs`：新增 dead-letter/metrics 保留上限与 archive 归档测试（含 in-memory 与 file store）。
  - 项目文档状态更新：T3 完成，T4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --lib --features wasmtime`
- 遗留事项：
  - 执行 T4：运行 required-tier 回归并完成文档最终收口。

- 时刻：2026-02-23 18:39:09 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯治理（2026-02-23）”T4（回归与文档收口）。
  - 通过提交门禁完成 required-tier 回归（含 viewer 相关必跑项），验证 T1~T3 的背压、有界保留、归档追溯与 wasm 安全加载改造未引入回归。
  - 回写设计文档状态：M0~M4 全部完成。
  - 回写项目管理文档状态：T0~T4 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（non-viewer 长稳治理任务 1~6 全部闭环）。

- 时刻：2026-02-23 19:20:59 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯冷归档硬化（1~6）”T0 建档。
  - 新建设计文档：`doc/nonviewer-longrun-traceable-memory-archive-hardening-2026-02-23.md`。
  - 新建项目文档：`doc/nonviewer-longrun-traceable-memory-archive-hardening-2026-02-23.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3/T4 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 Node 内存边界治理（pending actions/gossip peers/committed batches）与测试。

- 时刻：2026-02-23 19:33:44 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯冷归档硬化”T1（Node 内存边界治理 1/2/3）。
  - `NodeConfig` 新增并接线内存/peer 边界参数：
    - `max_engine_pending_consensus_actions`
    - `max_committed_action_batches`
    - `max_dynamic_gossip_peers`
    - `dynamic_gossip_peer_ttl_ms`
  - `PosNodeEngine` 合并 queued actions 时执行容量前置校验与后置守卫，防止引擎 pending map 无界增长。
  - `NodeRuntime` worker 主循环改为按引擎剩余容量有界出队，避免单 tick `mem::take` 全量灌入导致饱和；并对 `committed_action_batches` 施加热窗口上限（保留最新窗口）。
  - `GossipEndpoint` 改为静态 peer + 动态 peer book，动态 peer 引入 TTL 与容量上限，超限淘汰最旧 peer，过期 peer 自动剪枝。
  - 补齐/更新测试：
    - 引擎 pending 上限拒绝用例；
    - runtime 有界出队与 committed batch 窗口上限用例；
    - gossip 动态 peer 容量淘汰与 TTL 过期用例；
    - 兼容 `NodeGossipConfig` 新字段的现有测试构造；
    - 加固 1 个复制拒绝用例，避免时序脆弱导致假阴性。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_dequeues_actions_with_engine_capacity_limit`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node pos_engine_rejects_tick_when_engine_pending_limit_exceeded`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_committed_batches_respect_hot_window_limit`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node gossip_endpoint_enforces_dynamic_peer_capacity`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node gossip_endpoint_expires_dynamic_peers_by_ttl`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T2：完成 consensus 文件型日志热窗口 + CAS 冷归档，以及 dead-letter archive CAS 化。

- 时刻：2026-02-23 19:49:19 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯冷归档硬化”T2（Consensus 日志与 dead-letter 冷归档 4/5）。
  - 新增公共组件：`crates/agent_world_consensus/src/tiered_file_log.rs`，提供 JSONL 热窗口压缩、CAS 分段冷归档、cold refs 回放聚合能力。
  - `FileMembershipRevocationAlertSink`：从 append-only 单文件改为“热 JSONL + cold refs + CAS segment”，`list` 聚合冷热并保持追溯。
  - `FileMembershipAuditStore`：同样改为“热窗口 + CAS 冷归档 + refs”，`list` 支持冷热回放。
  - `FileMembershipRevocationDeadLetterReplayRollbackGovernanceRecoveryDrillAlertEventBus`：事件总线文件存储改为冷热分层，查询聚合冷热记录。
  - `FileMembershipRevocationAlertDeadLetterStore`：dead-letter 与 delivery-metrics 的 archive 从本地 `.archive.jsonl` 改为 `.archive.refs.jsonl + CAS segment`，避免 archive 文件无限膨胀。
  - 补充/更新单测：
    - `file_revocation_alert_sink_tiered_offload_lists_cold_and_hot_records`
    - `file_membership_audit_store_tiered_offload_lists_cold_and_hot_records`
    - `governance_recovery_drill_alert_event_bus_file_lists_cold_and_hot_records`
    - dead-letter archive 相关断言迁移到 refs+CAS 读取路径。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib membership_reconciliation_tests::file_revocation_alert_sink_tiered_offload_lists_cold_and_hot_records`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib membership_tests::file_membership_audit_store_tiered_offload_lists_cold_and_hot_records`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib membership_dead_letter_replay_archive_tests::governance_recovery_drill_alert_event_bus_file_lists_cold_and_hot_records`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib membership_recovery_tests::file_dead_letter_store_retention_compacts_records_to_archive`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib membership_recovery_tests::file_dead_letter_store_retention_compacts_metrics_to_archive`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 执行 T3：完成 node replication commit message 热窗口 + CAS 冷索引回放。

- 时刻：2026-02-23 19:55:32 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯冷归档硬化”T3（Node replication commit 冷归档 6）。
  - `crates/agent_world_node/src/replication.rs`：
    - `NodeReplicationConfig` 新增 `max_hot_commit_messages`（默认 `4096`）及 builder 校验。
    - `persist_commit_message` 写入热文件后执行热窗口裁剪：按高度保留最近 N 条 commit 消息。
    - 被裁剪的旧 commit 消息迁移到 `store/` CAS blob（内容哈希），并写入 `replication_commit_messages_cold_index.json`（height -> hash）。
    - `load_commit_message_from_root` 增加冷索引回退路径：热文件不存在时从 cold index + CAS 回放。
  - `crates/agent_world_node/src/replication/tests.rs`：
    - 新增 `load_commit_message_by_height_reads_from_cold_index_after_hot_prune`，验证热窗口裁剪后仍可通过 cold refs/CAS 追溯读取。
  - 项目文档状态更新：T3 完成，T4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node load_commit_message_by_height_reads_from_cold_index_after_hot_prune -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T4：运行 required-tier 回归并完成文档收口。

- 时刻：2026-02-23 19:58:47 CST
- 完成内容：完成“Non-Viewer 长稳运行内存安全与可追溯冷归档硬化”T4（回归与收口）。
  - 执行 required-tier 回归并通过，确认 1~6 项改造未引入回归。
  - 回写设计文档状态：M0~M4 全部完成。
  - 回写项目管理文档状态：T0~T4 全部完成，阶段收口。
- 测试：
  - `./scripts/ci-tests.sh required`
    - `env -u RUSTC_WRAPPER cargo fmt --all -- --check`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
    - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（non-viewer 长稳冷归档硬化任务 1~6 全部闭环）。

- 时刻：2026-02-23 20:28:33 CST
- 完成内容：完成“异构节点分布式存储最优稳定性改造（1000+ 节点）”T0 建档。
  - 新建设计文档：`doc/p2p/distfs-heterogeneous-node-optimal-stability-2026-02-23.md`。
  - 新建项目文档：`doc/p2p/distfs-heterogeneous-node-optimal-stability-2026-02-23.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：扩展 ProviderRecord 能力画像并保持兼容。

- 时刻：2026-02-23 20:34:45 CST
- 完成内容：完成“异构节点分布式存储最优稳定性改造”T1（Provider 能力画像扩展）。
  - `ProviderRecord` 新增 6 个可选能力字段：总容量、可用容量、在线率、挑战通过率、负载率、P50 读取延迟，并使用 serde `default + skip_serializing_if` 保持向后兼容。
  - 更新 `agent_world_net` 与 `agent_world_consensus` 全部 `ProviderRecord` 构造路径，旧路径统一以 `None` 默认值写入，避免行为变化。
  - 新增兼容测试：
    - `provider_record_deserializes_legacy_json_without_capability_fields`
    - `provider_record_omits_empty_capability_fields_in_json`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto distributed_dht::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus dht::tests::duration_millis_to_i64_saturating_clamps_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
- 遗留事项：
  - 执行 T2：实现 provider 评分排序与逐节点重试拉取策略。

- 时刻：2026-02-23 20:43:10 CST
- 完成内容：完成“异构节点分布式存储最优稳定性改造”T2（评分排序与重试拉取）。
  - 新增 `agent_world_net::provider_selection`：实现 `ProviderSelectionPolicy`（freshness/uptime/challenge/capacity/load/latency 六维加权评分、归一化、候选截断、去重）。
  - `DistributedClient` 增加 provider 选择策略并保持 `new` 接口兼容，新增 `new_with_provider_selection_policy` 便于策略注入。
  - `fetch_blob_from_dht` 升级为：先按评分排序，再逐 provider 单点重试，全部失败后回退到无 provider 拉取。
  - 补齐 `agent_world_net` 单测：
    - 排序：`provider_selection` 的能力优先与 legacy 兼容排序。
    - 重试：首选 provider 失败后自动尝试下一节点。
    - 回退：候选全部失败后回退无 provider 请求。
    - 兼容：缺失能力字段（legacy record）仍可参与排序与重试。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
- 遗留事项：
  - 执行 T3：完成跨 crate 回归、文档收口与最终日志。

- 时刻：2026-02-23 20:47:58 CST
- 完成内容：完成“异构节点分布式存储最优稳定性改造”T3（回归与收口）。
  - 按计划完成跨 crate 回归：`agent_world_net`、`agent_world_distfs`、`agent_world_consensus`、`agent_world_node` 全部通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，项目收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 无（本轮改造任务闭环完成）。

- 时刻：2026-02-23 20:54:59 CST
- 完成内容：完成“分布式存储去单机完整依赖改造”T0 建档。
  - 新建设计文档：`doc/p2p/distfs-no-single-full-node-assumption-2026-02-23.md`。
  - 新建项目管理文档：`doc/p2p/distfs-no-single-full-node-assumption-2026-02-23.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：落地严格 DHT 拉取，移除无 provider 回退。

- 时刻：2026-02-23 20:59:50 CST
- 完成内容：完成“分布式存储去单机完整依赖改造”T1（严格 DHT 拉取）。
  - `DistributedClient::fetch_blob_from_dht` 移除无 provider 与 provider 全失败时的 `fetch_blob` 回退路径。
  - 失败语义改为显式错误：
    - 无 provider：`WorldError::DistributedValidationFailed`；
    - provider 全失败：返回最后一次 provider 访问错误（无静默回退）。
  - 调整并补齐 `agent_world_net` 单测：
    - `client_fetch_blob_from_dht_fails_when_no_providers`
    - `client_fetch_blob_from_dht_fails_after_ranked_provider_failures`
    - 保留 provider 排序重试成功路径校验。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib client_fetch_blob_from_dht`
- 遗留事项：
  - 执行 T2：新增 provider 覆盖审计策略并接入 DHT 回放/启动相关链路约束，补齐失败/成功用例。

- 时刻：2026-02-23 21:06:06 CST
- 完成内容：完成“分布式存储去单机完整依赖改造”T2（provider 覆盖审计与接线）。
  - 新增 `agent_world_net::provider_distribution` 模块：
    - `ProviderDistributionPolicy`（默认 `min_replicas_per_blob=2`、`forbid_single_provider_full_coverage=true`）。
    - `audit_provider_distribution`：校验“每个 blob 最小副本数”与“禁止单 provider 全覆盖”。
  - 在 `DistributedClient` 新增批量 DHT 拉取入口：
    - `fetch_blobs_from_dht_with_distribution`（先审计再按 provider 拉取），将覆盖约束变成可执行链路前置条件。
  - 扩展/新增单测覆盖：
    - 副本不足拒绝。
    - 单 provider 全覆盖拒绝。
    - 分布覆盖放行。
    - 客户端批量拉取在预审计失败时拒绝，在有效分布时成功拉取。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
- 遗留事项：
  - 执行 T3：完成跨 crate 回归、设计/项目文档收口与日志闭环。

- 时刻：2026-02-23 21:11:10 CST
- 完成内容：完成“分布式存储去单机完整依赖改造”T3（回归与收口）。
  - 执行四包回归并通过：`agent_world_net`、`agent_world_distfs`、`agent_world_consensus`、`agent_world_node`。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，项目收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 无（本轮改造任务闭环完成）。

- 时刻：2026-02-23 21:16:04 CST
- 完成内容：完成“分布式存储自愈控制面”T0 建档。
  - 新建设计文档：`doc/p2p/distfs-self-healing-control-plane-2026-02-23.md`。
  - 新建项目管理文档：`doc/p2p/distfs-self-healing-control-plane-2026-02-23.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：落地副本修复/重平衡维护计划生成器与单测。

- 时刻：2026-02-23 21:21:42 CST
- 完成内容：完成“分布式存储自愈控制面”T1（维护计划生成器）。
  - 新增 `agent_world_net::replica_maintenance` 模块，定义维护策略、任务模型与维护计划结构。
  - 实现 `plan_replica_maintenance`，可生成 Repair/Rebalance 两类任务，并对缺失 source/target 的不可执行场景输出 `warnings`。
  - 在 `agent_world_net` 导出维护计划接口，便于后续 runtime 调度接线。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net replica_maintenance::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
- 遗留事项：
  - 执行 T2：实现维护计划执行器，成功发布 DHT 索引并补齐执行结果测试。

- 时刻：2026-02-23 21:27:48 CST
- 完成内容：完成“分布式存储自愈控制面”T2（维护执行器）。
  - 在 `agent_world_net::replica_maintenance` 新增执行层接口：
    - `ReplicaTransferExecutor`（任务传输抽象）。
    - `ReplicaMaintenanceReport` / `ReplicaMaintenanceFailedTask`（执行报告与失败项）。
    - `execute_replica_maintenance_plan`（顺序执行 repair+rebalance，成功后发布 target provider 到 DHT）。
  - 执行语义：
    - 传输成功且 DHT 发布成功记为成功任务。
    - 传输失败或发布失败均进入 `failed_tasks`，且不会记录成功。
  - 新增单测：
    - `execute_replica_maintenance_plan_publishes_target_provider_on_success`
    - `execute_replica_maintenance_plan_does_not_publish_on_transfer_failure`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net replica_maintenance::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
- 遗留事项：
  - 执行 T3：完成跨 crate 回归并回写设计/项目文档最终状态。

- 时刻：2026-02-23 21:31:07 CST
- 完成内容：完成“分布式存储自愈控制面”T3（回归与收口）。
  - 执行并通过四包回归：`agent_world_net`、`agent_world_distfs`、`agent_world_consensus`、`agent_world_node`。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目文档状态：T0~T3 全部完成，项目收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 无（本轮“分布式存储自愈控制面”任务闭环完成）。

- 时刻：2026-02-23 21:36:25 CST
- 完成内容：完成“分布式存储自愈定时轮询”T0 建档。
  - 新建设计文档：`doc/p2p/distfs-self-healing-polling-loop-2026-02-23.md`。
  - 新建项目文档：`doc/p2p/distfs-self-healing-polling-loop-2026-02-23.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：实现自愈维护定时轮询入口与单测。

- 时刻：2026-02-23 21:39:40 CST
- 完成内容：完成“分布式存储自愈定时轮询”T1（轮询能力实现）。
  - 在 `agent_world_net::replica_maintenance` 新增轮询模型：
    - `ReplicaMaintenancePollingPolicy`（`poll_interval_ms`）。
    - `ReplicaMaintenancePollingState`（`last_polled_at_ms`）。
    - `ReplicaMaintenanceRoundResult`（单轮执行结果）。
  - 新增 `run_replica_maintenance_poll`：
    - 未到轮询间隔返回 `Ok(None)`；
    - 到期执行 `plan_replica_maintenance + execute_replica_maintenance_plan`，返回 `Ok(Some(...))` 并更新轮询状态。
  - 新增校验：`poll_interval_ms > 0`。
  - 补齐单测：
    - `run_replica_maintenance_poll_runs_first_round_and_updates_state`
    - `run_replica_maintenance_poll_skips_when_interval_not_elapsed`
    - `run_replica_maintenance_poll_rejects_non_positive_interval`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net replica_maintenance::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
- 遗留事项：
  - 执行 T2：完成跨 crate 回归并回写设计/项目文档最终状态。

- 时刻：2026-02-23 21:45:32 CST
- 完成内容：完成“分布式存储自愈定时轮询”T2（回归与收口）。
  - 执行并通过四包回归：`agent_world_net`、`agent_world_distfs`、`agent_world_consensus`、`agent_world_node`。
  - 回写设计文档状态：M0~M2 全部完成。
  - 回写项目文档状态：T0~T2 全部完成，项目收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 无（本轮“分布式存储自愈定时轮询”任务闭环完成）。

- 时刻：2026-02-23 21:50:28 CST
- 完成内容：完成“分布式存储自愈轮询 Runtime 接线”T0 建档。
  - 新建设计文档：`doc/p2p/distfs-self-healing-runtime-polling-wiring-2026-02-23.md`。
  - 新建项目文档：`doc/p2p/distfs-self-healing-runtime-polling-wiring-2026-02-23.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 NodeRuntime 自愈轮询接线与单测。

- 时刻：2026-02-23 22:00:47 CST
- 完成内容：完成“分布式存储自愈轮询 Runtime 接线”T1（Runtime 接线实现）。
  - `NodeConfig` 新增 `NodeReplicaMaintenanceConfig` 与 `with_replica_maintenance` 校验入口（采样窗口、目标副本数、轮询间隔必须为正）。
  - `NodeRuntime` 增加可选 DHT 注入接口 `with_replica_maintenance_dht`，并在 worker tick 中接入维护轮询逻辑。
  - 新增 Runtime 轮询状态字段 `replica_maintenance_last_polled_at_ms`。
  - 新增 Node 侧执行器：仅执行 `target_provider_id == local_node_id` 任务；通过复制网络按 provider 请求 blob，校验 hash 后落入本地 CAS。
  - `ReplicationNetworkEndpoint` 增加 `request_json_with_providers`，`ReplicationRuntime` 增加 `store_blob_by_hash`。
  - 新增单测：
    - `config_rejects_non_positive_replica_maintenance_poll_interval`
    - `runtime_replica_maintenance_poll_executes_local_target_tasks`
    - `runtime_replica_maintenance_poll_skips_without_dht`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_replica_maintenance_poll_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
- 遗留事项：
  - 执行 T2：完成四包回归并收口设计/项目文档状态。

- 时刻：2026-02-23 22:09:40 CST
- 完成内容：完成“分布式存储自愈轮询 Runtime 接线”T2（回归与收口）。
  - 执行并通过四包回归：`agent_world_node`、`agent_world_net`、`agent_world_distfs`、`agent_world_consensus`。
  - 回写设计文档状态：M0~M2 全部完成。
  - 回写项目文档状态：T0~T2 全部完成，项目收口。
  - 补充 wasm 路径告警清理：将仅 host 使用的方法标记 `cfg(not(target_arch = "wasm32"))`，避免 wasm check 的 dead_code 告警。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
- 遗留事项：
  - 无（本轮“分布式存储自愈轮询 Runtime 接线”任务闭环完成）。

- 时刻：2026-02-23 22:45:49 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”文档修订任务（VVU-P0）。
  - 重写设计文档：`doc/viewer-visual-upgrade.md`，将定位调整为 Phase 10 后增量强化。
  - 对齐数据语义：将 Fragment/破损统一到 `fragment_budget` 口径，删除未定义 `remaining_estimate` 口径。
  - 补充模拟层改造设计：新增 Agent 速度/耗时移动的字段与行为语义（S1）。
  - 补充配置配套：新增视觉配置项清单与 `viewer_3d_config` 解析/兼容要求。
  - 新增项目管理文档：`doc/viewer-visual-upgrade.project.md`，拆解 VVU-P1~VVU-P7 后续任务。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 启动 VVU-P1：在模拟层补齐 Agent 运动学字段与默认序列化兼容。

- 时刻：2026-02-23 22:53:05 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”VVU-P1（模拟层 Agent 运动学字段与序列化兼容）。
  - `crates/agent_world/src/simulator/world_model.rs`
    - 新增 `AgentKinematics` 结构（`speed_cm_per_tick`、`move_target`、`move_started_at_tick`、`move_eta_tick`、`move_remaining_cm`）及默认值。
    - 在 `Agent` 上新增 `kinematics` 字段并加 `#[serde(default)]`，保持旧快照反序列化兼容。
    - `Agent::new` / `Agent::new_with_power` 默认注入 `AgentKinematics::default()`。
  - `crates/agent_world/src/simulator/mod.rs`
    - 导出 `AgentKinematics`，供模拟层/运行层统一使用。
  - `crates/agent_world/src/simulator/tests/persist.rs`
    - 新增 `snapshot_agent_kinematics_defaults_when_legacy_field_is_missing`，验证旧快照缺失 `kinematics` 字段时可默认恢复。
  - `doc/viewer-visual-upgrade.project.md`
    - 状态回写：VVU-P1 置为完成，下一阶段切换到 VVU-P2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world snapshot_agent_kinematics_defaults_when_legacy_field_is_missing -- --nocapture`
- 遗留事项：
  - 执行 VVU-P2：将 Agent 移动从瞬移改造为按 tick 的耗时推进，并补齐内核边界测试。

- 时刻：2026-02-23 23:06:51 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”VVU-P2（Agent 耗时移动改造与边界测试）。
  - `crates/agent_world/src/simulator/world_model.rs`
    - `AgentKinematics` 补充 `move_target_location_id`（`serde(default)`），并新增 `clear_motion_state` 统一清理移动态。
    - 默认 `speed_cm_per_tick` 调整为默认云空间尺度上限（`DEFAULT_CLOUD_WIDTH_CM + DEFAULT_CLOUD_DEPTH_CM + DEFAULT_CLOUD_HEIGHT_CM`），用于兼容既有“单步到达”行为预期，同时允许按 Agent 配置降速进入多 tick 推进。
  - `crates/agent_world/src/simulator/kernel/actions_impl_part1.rs`
    - `Action::MoveAgent` 从瞬移改为按 tick 推进：每次最多移动 `speed_cm_per_tick`，未到达则系统自动续发下一步移动动作。
    - 首段移动保留距离/速度/能量校验并一次性扣除移动电力；续段不重复扣费。
    - 非法速度（`<= 0`）改为显式拒绝（`RejectReason::InvalidAmount`）。
  - `crates/agent_world/src/simulator/tests/kernel_split_part1.rs`
    - 新增 `kernel_move_agent_progresses_over_multiple_ticks_when_speed_is_low`，验证低速下三 tick 分段到达语义。
    - 新增 `kernel_rejects_move_with_non_positive_agent_speed`，验证非法速度拒绝路径。
  - `doc/viewer-visual-upgrade.md`
    - 接口章节同步 `move_target_location_id` 字段，保证设计与实现一致。
  - `doc/viewer-visual-upgrade.project.md`
    - 状态回写：VVU-P2 置为完成，下一阶段切换到 VVU-P3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::kernel -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::persist::snapshot_agent_kinematics_defaults_when_legacy_field_is_missing -- --nocapture`
- 遗留事项：
  - 执行 VVU-P3：打通快照到 Viewer 的速度/方向数据链路，并落地方向与速度视觉反馈。

- 时刻：2026-02-23 23:23:08 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”VVU-P3（快照到 Viewer 的速度/方向链路与反馈落地）。
  - `crates/agent_world_viewer/src/main.rs`
    - `Viewer3dScene` 新增 `agent_kinematics` 缓存，打通快照层 Agent 运动学字段到渲染层。
  - `crates/agent_world_viewer/src/main_ui_runtime.rs`
    - `apply_events_to_scene` 调用接入当前快照，确保事件处理可读取最新 Agent 位置/运动学状态。
  - `crates/agent_world_viewer/src/scene_helpers.rs`
    - `spawn_agent_entity` 新增 `kinematics` 入参并写入场景缓存。
    - 新增 `resolve_agent_motion_visual` 与 `spawn_agent_motion_feedback`：
      - 根据 `move_target/move_target_location_id` 解析方向；
      - 根据 `speed_cm_per_tick` 映射速度反馈强度；
      - 在 Agent 节点增加方向指示体（`agent:direction_indicator:*`）与速度效果环（`agent:speed_effect:*`）。
    - `AgentMoved` 事件渲染改为以快照中的 `agent.pos` 为准，避免分段移动时被事件侧“瞬移到目标 Location”覆盖。
  - `crates/agent_world_viewer/src/scene_dirty_refresh.rs`
    - 脏刷新判定增加 `AgentKinematics` 变更条件，保证速度/方向反馈在运动学变化时可刷新。
  - `crates/agent_world_viewer/src/tests_scene_helpers.rs`
    - 新增 `spawn_agent_motion_feedback_test_system`，构造带运动学状态的 Agent。
  - `crates/agent_world_viewer/src/tests_scene_entities.rs`
    - 新增测试：
      - `spawn_agent_entity_renders_direction_and_speed_feedback_when_moving`
      - `spawn_agent_entity_skips_direction_and_speed_feedback_when_stationary`
  - `doc/viewer-visual-upgrade.project.md`
    - 状态回写：VVU-P3 置为完成，下一阶段切换到 VVU-P4。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_agent_entity_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer agent_needs_refresh_detects_module_and_location_delta -- --nocapture`
- 遗留事项：
  - 执行 VVU-P4：按 `fragment_budget` 落地 Location 破损映射，移除旧口径分支。

- 时刻：2026-02-23 23:28:38 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”VVU-P4（`fragment_budget` 破损映射与旧口径分支收口）。
  - `crates/agent_world_viewer/src/scene_helpers.rs`
    - 新增 `LocationDamageTier`（`Intact/Light/Heavy/Severe`）与 `location_damage_tier` 计算，完全基于 `fragment_budget` 剩余质量比映射破损档位。
    - `LocationMarker` 新增 `damage_tier` 字段，供渲染态与调试态直接读取。
    - `spawn_location_entity_with_radiation` 接入 `fragment_budget` 入参，统一由预算驱动破损视觉档位。
  - `crates/agent_world_viewer/src/scene_helpers_entities.rs`
    - `spawn_location_shell_details` 新增 `damage_tier` 入参：
      - 按破损档位调整核心壳体竖向形变；
      - 新增 `location:detail:damage:*` 覆盖层（轻/重/严重分别 1/2/3 层），使用 `chunk_exhausted_material` 强化破损可视化。
  - `crates/agent_world_viewer/src/scene_dirty_refresh.rs`
    - 脏刷新路径透传 `location.fragment_budget`，确保实时破损状态与预算一致。
  - `crates/agent_world_viewer/src/tests_scene_helpers.rs`
    - 新增 `spawn_location_damage_detail_test_system`，构造 severe 档位预算输入。
  - `crates/agent_world_viewer/src/tests_scene_entities.rs`
    - 新增 `spawn_location_entity_renders_fragment_budget_damage_overlays`，验证 severe 档位渲染 3 层 damage overlay 且 marker 记录 `LocationDamageTier::Severe`。
  - `crates/agent_world_viewer/src/scene_helpers_depletion_tests.rs`
    - 新增 `location_damage_tier_uses_fragment_budget_ratio_thresholds`，覆盖 0.2/0.5/0.8 分段阈值语义。
  - `doc/viewer-visual-upgrade.project.md`
    - 状态回写：VVU-P4 置为完成，下一阶段切换到 VVU-P5。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer location_damage_tier_uses_fragment_budget_ratio_thresholds -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_location_entity_ -- --nocapture`
- 遗留事项：
  - 执行 VVU-P5：完成材料差异化增强（重点收敛 Carbon/Composite 专属效果）。

- 时刻：2026-02-23 23:34:13 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”VVU-P5（Carbon/Composite 材料差异化增强）。
  - `crates/agent_world_viewer/src/scene_helpers_entities.rs`
    - `location_core_material` 移除 Carbon/Composite 复用分支：
      - `Carbon` 改为独立走 `chunk_exhausted_material` 主基调；
      - `Composite` 改为独立走 `chunk_generated_material` 主基调。
    - 在 `spawn_location_shell_details` 中新增专属细节层：
      - Carbon：`location:detail:carbon:grain:*`（2 层颗粒感覆盖）；
      - Composite：`location:detail:composite:layer:*`（2 层分层混合覆盖）。
  - `crates/agent_world_viewer/src/tests_scene_helpers.rs`
    - 新增 `spawn_location_carbon_material_detail_test_system` 与 `spawn_location_composite_material_detail_test_system`。
  - `crates/agent_world_viewer/src/tests_scene_entities.rs`
    - 新增测试：
      - `spawn_location_entity_carbon_material_has_dedicated_detail_layers`
      - `spawn_location_entity_composite_material_has_dedicated_detail_layers`
  - `doc/viewer-visual-upgrade.project.md`
    - 状态回写：VVU-P5 置为完成，下一阶段切换到 VVU-P6。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_location_entity_carbon_material_has_dedicated_detail_layers -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_location_entity_composite_material_has_dedicated_detail_layers -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_location_entity_renders_fragment_budget_damage_overlays -- --nocapture`
- 遗留事项：
  - 执行 VVU-P6：补齐新增视觉配置项解析与运行时兼容逻辑（含非法值回退测试）。

- 时刻：2026-02-23 23:51:39 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”VVU-P6（视觉配置解析与运行时兼容）。
  - `crates/agent_world_viewer/src/viewer_3d_config.rs`
    - 新增 `ViewerVisualEffectsConfig` / `ViewerVisualEffectsLevel`，补齐以下环境变量解析：
      - `AGENT_WORLD_VIEWER_VISUAL_EFFECTS`
      - `AGENT_WORLD_VIEWER_AGENT_VARIANT_PALETTE`
      - `AGENT_WORLD_VIEWER_AGENT_DIRECTION_INDICATOR`
      - `AGENT_WORLD_VIEWER_AGENT_SPEED_EFFECT`
      - `AGENT_WORLD_VIEWER_AGENT_TRAIL_ENABLED`
      - `AGENT_WORLD_VIEWER_LOCATION_RADIATION_GLOW`
      - `AGENT_WORLD_VIEWER_LOCATION_DAMAGE_VISUAL`
      - `AGENT_WORLD_VIEWER_ASSET_QUANTITY_VISUAL`
      - `AGENT_WORLD_VIEWER_ASSET_TYPE_COLOR`
    - 新增非法值回退逻辑：
      - `visual_effects` 仅接受 `minimal|standard|enhanced`；
      - `agent_variant_palette` 要求 4 个 `#RRGGBB` 颜色，缺项/非法值回退为 `None`；
      - 各布尔项非法值回退默认。
  - `crates/agent_world_viewer/src/scene_helpers.rs`
    - Agent 视觉反馈改为受配置门控：
      - `agent_direction_indicator` 控制方向箭头；
      - `agent_speed_effect` 控制速度环；
      - `agent_trail_enabled` 控制运动拖尾。
    - 快照资产实体接入数量/类型参数透传。
  - `crates/agent_world_viewer/src/scene_helpers_entities.rs`
    - Location 细节门控接入：
      - `location_radiation_glow` 控制 halo；
      - `location_damage_visual` 控制破损形变与 damage overlay。
    - Asset 细节增强接入：
      - `asset_quantity_visual` 显示数量环与标签数量信息；
      - `asset_type_color` 按资源类型（electricity/data）显示类型色环与标签类型信息。
  - `crates/agent_world_viewer/src/main_ui_runtime.rs`
    - `agent_variant_palette` 首色接入 Agent 模块标记材质，保障配置解析后可直接生效。
  - `crates/agent_world_viewer/src/viewer_3d_config_tests.rs`
    - 默认配置测试补齐 `visual` 字段断言。
  - `crates/agent_world_viewer/src/viewer_3d_config_profile_tests.rs`
    - 覆盖新增环境变量的正常解析、非法值回退与 `visual_effects` 档位+显式覆盖行为。
  - `crates/agent_world_viewer/src/tests_scene_entities.rs`
    - 新增运行时门控测试（方向/速度/拖尾、辐射 glow、破损 overlay）。
  - `doc/viewer-visual-upgrade.project.md`
    - 状态回写：VVU-P6 置为完成，下一阶段切换到 VVU-P7。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config_profile_tests -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer tests_scene_entities -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer defaults_match_rpa1_baseline -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VVU-P7：完成 required/full 回归、Playwright Web 闭环与性能收口。
- 时刻：2026-02-23 22:57:09 CST
- 完成内容：完成“world_viewer_live 发行锁定启动（P2P）”T0 建档。
  - 新建设计文档：`doc/p2p/world-viewer-live-release-locked-launch-2026-02-23.md`。
  - 新建项目文档：`doc/p2p/world-viewer-live-release-locked-launch-2026-02-23.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：实现 `--release-config` 锁定参数加载与启动接线。
