# 2026-02-20

## 时刻
- 2026-02-20 12:53:28 CST

## 完成内容
- 将未提交文档迁移至 `doc/game/`：
  - `game.md` → `doc/game/gameplay-top-level-design.md`
  - `game_eng.md` → `doc/game/gameplay-engineering-architecture.md`
- 修复 `doc/game/gameplay-engineering-architecture.md` 的 Markdown 围栏错误（不成对代码块）。
- 补齐顶层设计必备字段（目标、范围、接口/数据、里程碑、风险）。
- 补齐工程设计分册的范围、接口/数据、里程碑、风险。
- 新增顶层设计项目管理文档：`doc/game/gameplay-top-level-design.project.md`。

## 遗留事项
- 待进行可玩性设计评审，确认微/中/长循环的可验证指标。
- 待拆解工程落地任务并补充 `test_tier_required`/`test_tier_full` 测试矩阵。
- 日期：2026-02-20
- 时刻：2026-02-20 00:19:51 CST
- 完成内容：完成“P0/P1 缺口收口”T0 建档任务。
  - 新增设计文档：`doc/p2p/node-consensus-signer-binding-replication-hardening.md`。
  - 新增项目管理文档：`doc/p2p/node-consensus-signer-binding-replication-hardening.project.md`。
  - 项目文档状态初始化：T0 完成，T1~T4 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_node`
- 遗留事项：
  - 执行 T1：实现 P0 数据模型与校验链路。

- 时刻：2026-02-20 00:52:53 CST
- 完成内容：完成 T1（P0 数据模型与校验链路）
  - `NodePosConfig` 增加 `validator_signer_public_keys`，并提供 builder 配置接口。
  - `validated_pos_state` 增强 signer map 归一化与一致性校验（覆盖全集、未知项拦截、重复 signer 拦截、32-byte hex 校验）。
  - `PosNodeEngine` 持有 `validator_signers`，对 proposal/attestation/commit 入站消息增加 signer 身份绑定校验。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_hardening::config_rejects_duplicate_validator_signer_bindings -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_hardening::pos_engine_rejects_signed_proposal_when_signer_binding_mismatches_validator -- --nocapture`
- 遗留事项：
  - 执行 T2：补齐并稳定 P0 测试闭环。

- 时刻：2026-02-20 00:52:53 CST
- 完成内容：完成 T2（P0 测试补齐）
  - 新增 `tests_hardening.rs` 并接入 `lib.rs` 测试模块。
  - 覆盖 signer map 重复绑定拒绝、签名公钥与 validator 错绑拒绝两条核心断言。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_hardening:: -- --nocapture`
- 遗留事项：
  - 执行 T3：实现 P1 复制摄取和启动恢复硬化。

- 时刻：2026-02-20 00:52:53 CST
- 完成内容：完成 T3（P1 硬化实现）
  - `NodeRuntime::start` 对 PoS 状态恢复 `load` 错误改为显式失败返回，禁止静默忽略。
- `ReplicationRuntime` 新增 `validate_remote_message_for_observe`，并抽取远端消息处理的版本/world/self/signer/payload-hash 验证。
  - `ingest_network_replications` 改为：先安全验证再观测网络高度，连续高度才 apply 落库；失败消息聚合上抛。
  - 保持 gap-sync 兼容：高高度合法消息仍可提升 `network_committed_height` 触发补齐流程。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_gap_sync_fetches_missing_commits -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_gap_sync_reports_error_after_retries_exhausted -- --nocapture`
- 遗留事项：
  - 执行 T4：补齐 P1 测试并做全量回归。

- 时刻：2026-02-20 00:52:53 CST
- 完成内容：完成 T4（P1 测试与回归）
  - 新增 `runtime_start_fails_when_pos_state_snapshot_is_corrupted`，验证启动阶段错误显式失败。
  - 新增 `runtime_replication_ingest_reports_error_and_does_not_advance_network_height_on_invalid_message`，验证错误上抛与网络高度不误推进。
  - 为避免全套回归中的瞬时错误采样抖动，测试改为定时重放非法消息直到观测到 ingest rejection。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 无。

- 时刻：2026-02-20 11:22:17 CST
- 完成内容：完成分层测试收敛与遗留改动提交准备。
  - 完整补跑 S0~S7，确认核心链路与分布式子系统均可通过。
  - 复核并收敛 5 个未提交代码改动（builtin wasm fallback/toolchain 检测优化 + viewer 测试样例字段补齐）。
- 测试：
  - ./scripts/ci-tests.sh full
  - env -u RUSTC_WRAPPER cargo test -p agent_world_node
  - env -u RUSTC_WRAPPER cargo test -p agent_world_viewer
  - Playwright Web smoke（open/snapshot/console/screenshot/close）
- 遗留事项：
  - S6 仍有 fonts/ms-yahei.ttf 加载报错（web 控制台）。
  - S8 压测受磁盘容量影响；viewer-owr4-stress 未稳定跑通，llm-longrun-stress 本次仅跑到约 tick 108。

- 时刻：2026-02-20 11:46:32 CST
- 完成内容：完成“README 口径对齐：LLM P1/P2 生产级收口”T0 建档。
  - 新增设计文档：`doc/readme-llm-p1p2-production-closure.md`。
  - 新增项目管理文档：`doc/readme-llm-p1p2-production-closure.project.md`。
  - 项目文档状态初始化：T0 完成，T1~T4 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
- 遗留事项：
  - 执行 T1：收口 LLM tool 协议（注册/映射/提示词一致性）。

- 时刻：2026-02-20 11:54:53 CST
- 完成内容：完成 T1（LLM tool 协议收口）。
  - 在 OpenAI tool 注册中补齐 `module_lifecycle_status`。
  - 增加 tool 名 -> 模块名映射：`module_lifecycle_status -> module.lifecycle.status`。
  - 更新 LLM 单测断言：tool 列表数量/名称、函数调用映射覆盖新 tool。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required responses_tools_register_expected_function_names -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required response_function_call_maps_module_lifecycle_status_tool_name -- --nocapture`
- 遗留事项：
  - 执行 T2：Observation 快照扩展并接入 module/power/social 查询模块。

- 时刻：2026-02-20 12:11:01 CST
- 完成内容：完成 T2（Observation 快照扩展 + LLM 查询面扩展）。
  - `Observation` 扩展并接入 module lifecycle/module market/power market/social state 快照，`observe` 按稳定顺序输出。
  - LLM 查询模块扩展并落地：`power.order_book.status`、`module.market.status`、`social.state.status`。
  - `module.lifecycle.status` 改为严格读取 observation 快照；补齐筛选/limit 参数并同步 tool schema/模块参数说明。
  - 扩展 simulator 导出：新增 observation 快照类型 re-export，便于上层调用与测试构造。
  - 新增/更新 required-tier 单测：module lifecycle 观测优先、power/module/social 查询模块、tool 映射与 schema、kernel observe 快照覆盖。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required tests_part3_module_lifecycle:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required responses_tools_module_lifecycle_schema_declares_filter_and_limits -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required kernel_observe_includes_module_power_and_social_snapshots -- --nocapture`
- 遗留事项：
  - 执行 T3：实现 execution bridge 的 `SimulatorAction` 执行与审计持久化。

- 时刻：2026-02-20 12:13:55 CST
- 完成内容：完成 T3（execution bridge 支持 `SimulatorAction` 执行与审计记录）。
  - `NodeRuntimeExecutionDriver` 增加 simulator mirror 执行路径：commit 解码后区分 runtime/simulator payload，并对 simulator action 逐条执行 `WorldKernel` mirror。
  - execution record 新增 `simulator_mirror` 审计字段（action 数、拒绝数、mirror journal 长度、CAS 引用、state root）。
  - 新增 simulator mirror 持久化目录（由 execution world 目录派生），支持启动恢复加载与提交后落盘。
  - 替换旧测试语义：从“忽略 simulator payload”改为“处理并产出审计记录/持久化镜像”。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required node_runtime_execution_driver_processes_simulator_payload_envelope -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required execution_bridge::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T4：required-tier 回归、项目文档收口与最终提交。

- 时刻：2026-02-20 12:15:20 CST
- 完成内容：完成 T4（required-tier 回归、文档与 devlog 收口）。
  - 完成 LLM 查询面/observation 扩展与 execution bridge simulator mirror 的联合回归验证。
  - 项目管理文档更新为 T0~T4 全部完成。
  - 本轮 README 口径对齐任务收口，遗留项清空。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required tests_part3_module_lifecycle:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required execution_bridge::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required kernel_observe_includes_module_power_and_social_snapshots -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required responses_tools_register_expected_function_names -- --nocapture`
- 遗留事项：
  - 无。

- 时刻：2026-02-20 13:04:01 CST
- 完成内容：完成 MMD12（P0 两项复验与修复收口：TODO-28/TODO-29）。
  - 先修复编译阻塞：将 `collapse_multi_turn_payloads/parsed_turn_kind_name` 从 `AgentBehavior` trait impl 挪到 `LlmAgentBehavior` 固有 impl，恢复多段折叠逻辑可编译。
  - 复验 #1（同口径 120 tick）：`output/p0_verify_fix_2026-02-20_124508/report.json` 显示 `location_not_found=7`、`parse_errors=30`，确认 location 别名路径仍未收敛。
  - 补 `build_factory` guardrail：当请求 location 不可见时，优先回退推断当前位置（`distance_cm=0`，缺失则最近可见 location）；不可推断时保守回退 `harvest_radiation`。
  - 更新/新增单测：多段输出折叠语义、`mine_compound` 位置归一语义、`build_factory` 在“无 distance=0”场景下按最近可见位置归一。
  - 复验 #2（同口径 120 tick）：`output/p0_verify_fix2_2026-02-20_125633/report.json`，`location_not_found: 8 -> 0`、`parse_errors: 15 -> 0`、`decision_wait: 15 -> 0`，TODO-28/TODO-29 收口。
  - 回写文档：更新 `doc/world-simulator/llm-industrial-mining-debug-tools.md` 与 `.project.md`，新增 MMD12 设计与项目状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_collapses_multiple_tool_calls_in_single_turn -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_collapses_multi_segment_output_to_last_terminal_decision -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_normalizes_mine_compound_unknown_location_to_inferred_current_location -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_parse_mine_compound_action_defaults_to_self_owner -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_collapses_multi_json_output_to_terminal_decision_without_repair -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_collapses_mixed_multi_turn_output_to_last_terminal_decision -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_build_factory_normalizes_unknown_location_to_nearest_visible_when_current_unknown -- --nocapture`
  - `AGENT_WORLD_LLM_SYSTEM_PROMPT='你是工业闭环调度Agent。每轮只输出一个可执行 tool call 对应的 decision，不输出解释文本。优先形成稳定工业闭环，避免在同一耗尽矿点连续重试。' AGENT_WORLD_LLM_SHORT_TERM_GOAL='120 tick 内完成：1) build_factory(factory.power.radiation.mk1) 成功>=1；2) build_factory(factory.assembler.mk1) 成功>=1；3) schedule_recipe 成功覆盖 recipe.assembler.control_chip / recipe.assembler.motor_mk1 / recipe.assembler.logistics_drone 各>=1。覆盖完成后继续排产，禁止 wait/wait_ticks。恢复规则：electricity不足->harvest_radiation；hardware不足->mine_compound+refine_compound；factory_not_found->build_factory。' AGENT_WORLD_LLM_LONG_TERM_GOAL='维持 harvest_radiation -> mine_compound -> refine_compound -> build_factory -> schedule_recipe 的持续产出闭环，减少 move/mine 抖动和无效重试。' env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 120 --report-json output/p0_verify_fix_2026-02-20_124508/report.json`
  - `AGENT_WORLD_LLM_SYSTEM_PROMPT='你是工业闭环调度Agent。每轮只输出一个可执行 tool call 对应的 decision，不输出解释文本。优先形成稳定工业闭环，避免在同一耗尽矿点连续重试。' AGENT_WORLD_LLM_SHORT_TERM_GOAL='120 tick 内完成：1) build_factory(factory.power.radiation.mk1) 成功>=1；2) build_factory(factory.assembler.mk1) 成功>=1；3) schedule_recipe 成功覆盖 recipe.assembler.control_chip / recipe.assembler.motor_mk1 / recipe.assembler.logistics_drone 各>=1。覆盖完成后继续排产，禁止 wait/wait_ticks。恢复规则：electricity不足->harvest_radiation；hardware不足->mine_compound+refine_compound；factory_not_found->build_factory。' AGENT_WORLD_LLM_LONG_TERM_GOAL='维持 harvest_radiation -> mine_compound -> refine_compound -> build_factory -> schedule_recipe 的持续产出闭环，减少 move/mine 抖动和无效重试。' env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 120 --report-json output/p0_verify_fix2_2026-02-20_125633/report.json`
- 遗留事项：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent` 仍有 4 个与本轮 P0 修复无关的历史失败用例待后续处理：
    - `prompt_budget_truncates_history_before_drop`
    - `build_responses_request_payload_includes_tools_and_required_choice`
    - `build_responses_request_payload_includes_debug_tool_when_enabled`
    - `llm_agent_user_prompt_contains_memory_digest_section`
