- 时刻：2026-02-28 11:44:48 CST
- 完成内容：完成“M4 资源产业链可玩性优先强化”T0（建档）。
  - 新增设计文档：`doc/world-simulator/m4/m4-resource-product-system-playability-priority-hardening-2026-02-28.md`。
  - 新增项目管理文档：`doc/world-simulator/m4/m4-resource-product-system-playability-priority-hardening-2026-02-28.project.md`。
  - 项目状态设置为“进行中（T0 已完成，执行 T1）”。
- 测试：
  - test_tier_required（文档行数约束）：`wc -l doc/world-simulator/m4/m4-resource-product-system-playability-priority-hardening-2026-02-28.md doc/world-simulator/m4/m4-resource-product-system-playability-priority-hardening-2026-02-28.project.md`。
  - test_tier_required（设计文档结构）：`rg -n "目标|范围|接口 / 数据|里程碑|风险" doc/world-simulator/m4/m4-resource-product-system-playability-priority-hardening-2026-02-28.md`。
  - test_tier_required（项目文档结构）：`rg -n "任务拆解|依赖|状态" doc/world-simulator/m4/m4-resource-product-system-playability-priority-hardening-2026-02-28.project.md`。
- 遗留事项：
  - 执行 T1：补齐 `polymer_resin` 内置配方链路与 bootstrap/artifact 同步。

- 时刻：2026-02-28 11:55:56 CST
- 完成内容：完成“M4 资源产业链可玩性优先强化”T1（`polymer_resin` 配方链路 + bootstrap/artifact 同步）。
  - 新增内置模块 crate：`crates/agent_world_builtin_wasm_modules/m4_recipe_smelter_polymer_resin`（`Cargo.toml`/`Cargo.lock`/`src/lib.rs`）。
  - 更新 `crates/agent_world_wasm_store/src/lib.rs`、`crates/agent_world/src/runtime/mod.rs`：新增并导出 `M4_RECIPE_SMELT_POLYMER_RESIN_MODULE_ID`。
  - 更新 `crates/agent_world/src/runtime/world/bootstrap_economy.rs`：
    - bootstrap 模块清单新增 `m4.recipe.smelter.polymer_resin`；
    - 默认 `RecipeProfile` 新增 `recipe.smelter.polymer_resin`（`bootstrap` 阶段）。
  - 更新清单：
    - `crates/agent_world/src/runtime/world/artifacts/m4_builtin_module_ids.txt`
    - `crates/agent_world/src/runtime/world/artifacts/builtin_module_manifest_map.txt`
    - `crates/agent_world/src/runtime/world/artifacts/m4_builtin_modules.sha256`
    - `crates/agent_world/src/runtime/world/artifacts/m4_builtin_modules.identity.json`
  - 更新 `crates/agent_world/src/runtime/tests/economy_bootstrap.rs`：
    - 模块常量期望列表纳入新 recipe 模块；
    - 端到端链路测试改为先产出 `polymer_resin`，移除预置 `polymer_resin` 依赖。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`。
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::builtin_wasm_identity -- --nocapture`。
  - test_tier_full：`env -u RUSTC_WRAPPER cargo test -p agent_world --features "wasmtime test_tier_full" runtime::tests::economy_bootstrap -- --nocapture`。
  - test_tier_full：`./scripts/sync-m4-builtin-wasm-artifacts.sh --check`。
- 遗留事项：
  - 执行 T2：落地 `unlock_stage` 校验与 `TransferMaterial` 显式优先级。

- 时刻：2026-02-28 12:03:36 CST
- 完成内容：完成“M4 资源产业链可玩性优先强化”T2（`unlock_stage` 校验 + `TransferMaterial` 显式优先级）。
  - 更新 `crates/agent_world/src/runtime/events.rs`：`Action::TransferMaterial` 新增可选字段 `priority: Option<MaterialTransitPriority>`（`serde(default)`，兼容旧输入）。
  - 更新 `crates/agent_world/src/runtime/world/event_processing/action_to_event_core.rs`：物流优先级解析链路改为“显式输入 > material profile 默认优先级 > 关键词推断”。
  - 更新 `crates/agent_world/src/runtime/world/event_processing/action_to_event_economy.rs`：`ScheduleRecipe` 新增 `ProductProfile.unlock_stage` 校验，阶段不足时拒绝排产。
  - 更新 `crates/agent_world/src/runtime/tests/economy_priority_logistics.rs`：
    - 新增 `due_transits_allow_explicit_priority_override_for_non_urgent_material`；
    - 新增 `schedule_recipe_rejects_when_product_unlock_stage_exceeds_current_stage`。
  - 更新 `crates/agent_world/src/runtime/tests/economy.rs` 与既有物流测试调用点，补齐 `priority: None`。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`。
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy_priority_logistics -- --nocapture`。
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`。
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`。
- 遗留事项：
  - 执行 T3：落地 `maintenance_sink` 持续消耗并更新默认 profile 参数。

- 时刻：2026-02-28 12:12:44 CST
- 完成内容：完成“M4 资源产业链可玩性优先强化”T3（`maintenance_sink` 持续消耗接线 + 默认参数更新）。
  - 更新 `crates/agent_world/src/runtime/world/event_processing/action_to_event_economy.rs`：
    - 新增 `merge_recipe_consume_with_maintenance_sink`，将 `ProductProfile.maintenance_sink` 按产出数量折算后并入配方实际消耗；
    - `ScheduleRecipe` 的库存校验、账本回退、报价观测、bottleneck 推断、事件 `consume` 字段统一改为基于“合并后消耗”。
  - 更新 `crates/agent_world/src/runtime/world/bootstrap_economy.rs`：
    - M4 默认 `ProductProfile` 为中后期产品补齐 `maintenance_sink` 首版参数；
    - `factory_core` 额外接入 `alloy_plate` 维护消耗。
  - 更新 `crates/agent_world/src/runtime/tests/economy_priority_logistics.rs`：新增 `schedule_recipe_applies_product_maintenance_sink_to_consume`，验证维护消耗并入排产消耗。
  - 更新 `crates/agent_world/src/runtime/tests/economy_bootstrap.rs`：补充 `hardware_part` 初始库存并同步断言（`alloy_plate/hardware_part` 余额）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`。
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy_priority_logistics -- --nocapture`。
  - test_tier_full：`env -u RUSTC_WRAPPER cargo test -p agent_world --features "wasmtime test_tier_full" runtime::tests::economy_bootstrap -- --nocapture`。
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`。
- 遗留事项：
  - 执行 T4：完成项目文档状态收口并结项提交。

- 时刻：2026-02-28 12:15:42 CST
- 完成内容：完成“M4 资源产业链可玩性优先强化”T4（回归收口与结项）。
  - 更新项目管理文档：`doc/world-simulator/m4/m4-resource-product-system-playability-priority-hardening-2026-02-28.project.md`。
  - 状态收敛为“已完成（T0~T4）”，本轮任务结项。
- 测试：
  - 文档收口任务，无新增代码测试（T1~T3 已完成 required/full 回归）。
- 遗留事项：
  - 无（当前项目文档内任务已全部完成）。

