- 日期：2026-02-12
- 完成内容：新增《内核不变量回归与规则 Hook 基座》设计文档与项目管理文档：
  - `doc/world-simulator/kernel-rule-hook-foundation.md`
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`
- 完成内容：完成 KRH-1（内核动作行为基线回归测试），新增 `kernel_action_behavior_snapshot_stays_stable`，固定 `WorldKernel` 关键动作路径的事件快照基线：
  - `crates/agent_world/src/simulator/tests/kernel_rule_invariants.rs`
  - `crates/agent_world/src/simulator/tests/mod.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_action_behavior_snapshot_stays_stable -- --nocapture`
- 完成内容：回写项目管理文档状态：
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`（KRH-1 标记完成，KRH-2 进行中）
  - `doc/world-simulator.project.md`（新增 KRH 分组与状态）
- 遗留事项：继续推进 KRH-2，在 `WorldKernel::step` 接入 pre_action/post_action Hook（默认 no-op，行为不变）。
- 日期：2026-02-12
- 完成内容：完成 KRH-2（`WorldKernel::step` 接入 pre/post hook 脚手架，默认未注册为 no-op）：
  - `crates/agent_world/src/simulator/kernel/mod.rs`
  - `crates/agent_world/src/simulator/kernel/step.rs`
  - `crates/agent_world/src/simulator/kernel/persistence.rs`
- 完成内容：新增并通过 KRH-2 回归测试：
  - `kernel_rule_hooks_default_path_keeps_action_behavior`
  - `kernel_rule_hooks_run_in_registration_order`
  - `kernel_post_action_hook_receives_emitted_event`
  - `kernel_action_behavior_snapshot_stays_stable`
  - 测试命令：`env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule_hooks_default_path_keeps_action_behavior -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule_hooks_run_in_registration_order -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world kernel_post_action_hook_receives_emitted_event -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world kernel_action_behavior_snapshot_stays_stable -- --nocapture`
- 完成内容：更新 KRH 项目管理文档与总项目文档状态，标记 KRH-2 完成：
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：按当前保守策略暂不推进 KRH-3（规则决策结构与合并），等待下一步指令。
- 日期：2026-02-12
- 完成内容：完成 KRH-3（模拟器规则决策结构与合并）：
  - 新增 `KernelRuleCost`、`KernelRuleVerdict`、`KernelRuleDecision`、`KernelRuleDecisionMergeError`、`merge_kernel_rule_decisions`
  - `WorldKernel::step` 接入 pre-action 决策合并与 deny/modify/allow 执行路径
  - `RejectReason` 新增 `RuleDenied { notes }`
  - 代码文件：
    - `crates/agent_world/src/simulator/kernel/types.rs`
    - `crates/agent_world/src/simulator/kernel/mod.rs`
    - `crates/agent_world/src/simulator/kernel/step.rs`
    - `crates/agent_world/src/simulator/mod.rs`
- 完成内容：新增 KRH-3 测试并通过：
  - `crates/agent_world/src/simulator/tests/kernel_rule_decisions.rs`
  - `crates/agent_world/src/simulator/tests/mod.rs`
  - 兼容更新：`crates/agent_world/src/simulator/tests/kernel.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule_decisions -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_action_behavior_snapshot_stays_stable -- --nocapture`
- 完成内容：回写 KRH 项目管理文档与总项目文档，标记 KRH-3 完成：
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：继续推进 KRH-4（回归验证、文档与 devlog 收口）。
- 日期：2026-02-12
- 完成内容：完成 KRH-4（回归验证、文档与 devlog 收口）：
  - 执行并通过回归测试：`env -u RUSTC_WRAPPER cargo test -p agent_world`
  - 任务状态收口：`doc/world-simulator/kernel-rule-hook-foundation.project.md`（KRH-1~KRH-4 全部完成）
  - 总项目文档同步：`doc/world-simulator.project.md`
- 遗留事项：KRH 基座阶段已完成，后续是否进入下一阶段（规则 `cost` 生效 / wasm 规则执行器接线）待确认。
- 日期：2026-02-12
- 完成内容：启动 KWR（规则 Wasm 化就绪第二阶段）文档任务：
  - 新增设计文档：`doc/world-simulator/kernel-rule-wasm-readiness.md`
  - 新增项目管理文档：`doc/world-simulator/kernel-rule-wasm-readiness.project.md`
  - 总项目文档新增 KWR 分组并挂载任务：`doc/world-simulator.project.md`
- 遗留事项：继续推进 KWR-1（pre-action hook 上下文扩展）与 KWR-2 测试。
- 日期：2026-02-12
- 完成内容：完成 KWR-1（pre-action hook 上下文扩展）：
  - `add_pre_action_rule_hook` 接口签名调整为 `Fn(ActionId, &Action, &WorldKernel) -> KernelRuleDecision`
  - `WorldKernel::step` 调用 pre-action hook 时传入只读内核上下文
  - 同步更新规则相关测试闭包签名
  - 代码文件：
    - `crates/agent_world/src/simulator/kernel/mod.rs`
    - `crates/agent_world/src/simulator/kernel/step.rs`
    - `crates/agent_world/src/simulator/tests/kernel.rs`
    - `crates/agent_world/src/simulator/tests/kernel_rule_decisions.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule -- --nocapture`
- 完成内容：回写 KWR 项目管理文档与总项目文档状态，标记 KWR-1 完成：
  - `doc/world-simulator/kernel-rule-wasm-readiness.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：继续推进 KWR-2（基于上下文的规则测试：时间/模型状态读取）。
- 日期：2026-02-12
- 完成内容：完成 KWR-2（基于上下文的规则测试）：
  - 新增 `kernel_pre_action_rule_can_read_kernel_time_context`，验证 pre-hook 可读取 `kernel.time()` 并影响 allow/deny。
  - 新增 `kernel_pre_action_rule_can_read_model_state_context`，验证 pre-hook 可读取 `kernel.model()` 并基于 location 存在性执行 deny/modify。
  - 代码文件：
    - `crates/agent_world/src/simulator/tests/kernel_rule_decisions.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule -- --nocapture`
- 完成内容：回写 KWR 项目管理文档与总项目文档状态，标记 KWR-2 完成：
  - `doc/world-simulator/kernel-rule-wasm-readiness.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：KWR-3（回归验证与文档收口）待下一步指令。
- 日期：2026-02-12
- 完成内容：完成 KWR-3（回归验证与文档收口）：
  - 执行并通过回归测试：`env -u RUSTC_WRAPPER cargo test -p agent_world`
  - KWR 项目管理文档收口：`doc/world-simulator/kernel-rule-wasm-readiness.project.md`（KWR-0~KWR-3 全部完成）
  - 总项目文档同步：`doc/world-simulator.project.md`（KWR-3 标记完成并更新最近状态）
- 遗留事项：KWR 第二阶段已完成，后续是否进入下一阶段（规则 wasm 执行接线 / `KernelRuleCost` 生效）待确认。
- 完成内容：新增 `agent_world_proto` 抽离方案文档与项目管理文档：
  - `doc/world-runtime/agent-world-proto.md`
  - `doc/world-runtime/agent-world-proto.project.md`
- 完成内容：执行并通过编译检查：
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：继续完成 T2/T3（新建 crate、迁移协议类型与 trait、完成 runtime 适配与回归）。
- 日期：2026-02-12
- 完成内容：完成 T2（新建 `agent_world_proto` 并迁移协议类型与 trait）：
  - 新增 crate：`crates/agent_world_proto`
  - 迁移协议类型：`crates/agent_world_proto/src/distributed.rs`
  - 迁移 trait 定义：`crates/agent_world_proto/src/distributed_net.rs`、`crates/agent_world_proto/src/distributed_dht.rs`
  - `agent_world` 侧接入新 crate：workspace 与依赖更新，`runtime/distributed*.rs` 改为桥接/实现对接
- 完成内容：执行并通过检查与定向测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world -p agent_world_proto`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --lib in_memory_publish_delivers_to_subscribers`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --lib in_memory_dht_tracks_world_head`
- 遗留事项：继续完成 T3（项目文档收口、最终状态回写、补充回归确认并提交）。
