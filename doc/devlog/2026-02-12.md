- 日期：2026-02-12
- 完成内容：新增《内核不变量回归与规则 Hook 基座》设计文档与项目管理文档：
  - `doc/world-simulator/kernel-rule-hook-foundation.md`
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`
- 完成内容：完成 KRH-1（内核动作行为基线回归测试），新增 `kernel_action_behavior_snapshot_stays_stable`，固定 `WorldKernel` 关键动作路径的事件快照基线：
  - `crates/agent_world/src/simulator/tests/kernel_rule_invariants.rs`
  - `crates/agent_world/src/simulator/tests/mod.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_action_behavior_snapshot_stays_stable -- --nocapture`
- 完成内容：回写项目管理文档状态：
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`（KRH-1 标记完成，KRH-2 进行中）
  - `doc/world-simulator.project.md`（新增 KRH 分组与状态）
- 遗留事项：继续推进 KRH-2，在 `WorldKernel::step` 接入 pre_action/post_action Hook（默认 no-op，行为不变）。
- 日期：2026-02-12
- 完成内容：完成 KRH-2（`WorldKernel::step` 接入 pre/post hook 脚手架，默认未注册为 no-op）：
  - `crates/agent_world/src/simulator/kernel/mod.rs`
  - `crates/agent_world/src/simulator/kernel/step.rs`
  - `crates/agent_world/src/simulator/kernel/persistence.rs`
- 完成内容：新增并通过 KRH-2 回归测试：
  - `kernel_rule_hooks_default_path_keeps_action_behavior`
  - `kernel_rule_hooks_run_in_registration_order`
  - `kernel_post_action_hook_receives_emitted_event`
  - `kernel_action_behavior_snapshot_stays_stable`
  - 测试命令：`env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule_hooks_default_path_keeps_action_behavior -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule_hooks_run_in_registration_order -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world kernel_post_action_hook_receives_emitted_event -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world kernel_action_behavior_snapshot_stays_stable -- --nocapture`
- 完成内容：更新 KRH 项目管理文档与总项目文档状态，标记 KRH-2 完成：
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：按当前保守策略暂不推进 KRH-3（规则决策结构与合并），等待下一步指令。
- 日期：2026-02-12
- 完成内容：完成 KRH-3（模拟器规则决策结构与合并）：
  - 新增 `KernelRuleCost`、`KernelRuleVerdict`、`KernelRuleDecision`、`KernelRuleDecisionMergeError`、`merge_kernel_rule_decisions`
  - `WorldKernel::step` 接入 pre-action 决策合并与 deny/modify/allow 执行路径
  - `RejectReason` 新增 `RuleDenied { notes }`
  - 代码文件：
    - `crates/agent_world/src/simulator/kernel/types.rs`
    - `crates/agent_world/src/simulator/kernel/mod.rs`
    - `crates/agent_world/src/simulator/kernel/step.rs`
    - `crates/agent_world/src/simulator/mod.rs`
- 完成内容：新增 KRH-3 测试并通过：
  - `crates/agent_world/src/simulator/tests/kernel_rule_decisions.rs`
  - `crates/agent_world/src/simulator/tests/mod.rs`
  - 兼容更新：`crates/agent_world/src/simulator/tests/kernel.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule_decisions -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_action_behavior_snapshot_stays_stable -- --nocapture`
- 完成内容：回写 KRH 项目管理文档与总项目文档，标记 KRH-3 完成：
  - `doc/world-simulator/kernel-rule-hook-foundation.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：继续推进 KRH-4（回归验证、文档与 devlog 收口）。
- 日期：2026-02-12
- 完成内容：完成 KRH-4（回归验证、文档与 devlog 收口）：
  - 执行并通过回归测试：`env -u RUSTC_WRAPPER cargo test -p agent_world`
  - 任务状态收口：`doc/world-simulator/kernel-rule-hook-foundation.project.md`（KRH-1~KRH-4 全部完成）
  - 总项目文档同步：`doc/world-simulator.project.md`
- 遗留事项：KRH 基座阶段已完成，后续是否进入下一阶段（规则 `cost` 生效 / wasm 规则执行器接线）待确认。
- 日期：2026-02-12
- 完成内容：启动 KWR（规则 Wasm 化就绪第二阶段）文档任务：
  - 新增设计文档：`doc/world-simulator/kernel-rule-wasm-readiness.md`
  - 新增项目管理文档：`doc/world-simulator/kernel-rule-wasm-readiness.project.md`
  - 总项目文档新增 KWR 分组并挂载任务：`doc/world-simulator.project.md`
- 遗留事项：继续推进 KWR-1（pre-action hook 上下文扩展）与 KWR-2 测试。
- 日期：2026-02-12
- 完成内容：完成 KWR-1（pre-action hook 上下文扩展）：
  - `add_pre_action_rule_hook` 接口签名调整为 `Fn(ActionId, &Action, &WorldKernel) -> KernelRuleDecision`
  - `WorldKernel::step` 调用 pre-action hook 时传入只读内核上下文
  - 同步更新规则相关测试闭包签名
  - 代码文件：
    - `crates/agent_world/src/simulator/kernel/mod.rs`
    - `crates/agent_world/src/simulator/kernel/step.rs`
    - `crates/agent_world/src/simulator/tests/kernel.rs`
    - `crates/agent_world/src/simulator/tests/kernel_rule_decisions.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule -- --nocapture`
- 完成内容：回写 KWR 项目管理文档与总项目文档状态，标记 KWR-1 完成：
  - `doc/world-simulator/kernel-rule-wasm-readiness.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：继续推进 KWR-2（基于上下文的规则测试：时间/模型状态读取）。
- 日期：2026-02-12
- 完成内容：完成 KWR-2（基于上下文的规则测试）：
  - 新增 `kernel_pre_action_rule_can_read_kernel_time_context`，验证 pre-hook 可读取 `kernel.time()` 并影响 allow/deny。
  - 新增 `kernel_pre_action_rule_can_read_model_state_context`，验证 pre-hook 可读取 `kernel.model()` 并基于 location 存在性执行 deny/modify。
  - 代码文件：
    - `crates/agent_world/src/simulator/tests/kernel_rule_decisions.rs`
- 完成内容：执行并通过测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rule -- --nocapture`
- 完成内容：回写 KWR 项目管理文档与总项目文档状态，标记 KWR-2 完成：
  - `doc/world-simulator/kernel-rule-wasm-readiness.project.md`
  - `doc/world-simulator.project.md`
- 遗留事项：KWR-3（回归验证与文档收口）待下一步指令。
- 日期：2026-02-12
- 完成内容：完成 KWR-3（回归验证与文档收口）：
  - 执行并通过回归测试：`env -u RUSTC_WRAPPER cargo test -p agent_world`
  - KWR 项目管理文档收口：`doc/world-simulator/kernel-rule-wasm-readiness.project.md`（KWR-0~KWR-3 全部完成）
  - 总项目文档同步：`doc/world-simulator.project.md`（KWR-3 标记完成并更新最近状态）
- 遗留事项：KWR 第二阶段已完成，后续是否进入下一阶段（规则 wasm 执行接线 / `KernelRuleCost` 生效）待确认。
- 完成内容：新增 `agent_world_proto` 抽离方案文档与项目管理文档：
  - `doc/world-runtime/agent-world-proto.md`
  - `doc/world-runtime/agent-world-proto.project.md`
- 完成内容：执行并通过编译检查：
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：继续完成 T2/T3（新建 crate、迁移协议类型与 trait、完成 runtime 适配与回归）。
- 日期：2026-02-12
- 完成内容：完成 T2（新建 `agent_world_proto` 并迁移协议类型与 trait）：
  - 新增 crate：`crates/agent_world_proto`
  - 迁移协议类型：`crates/agent_world_proto/src/distributed.rs`
  - 迁移 trait 定义：`crates/agent_world_proto/src/distributed_net.rs`、`crates/agent_world_proto/src/distributed_dht.rs`
  - `agent_world` 侧接入新 crate：workspace 与依赖更新，`runtime/distributed*.rs` 改为桥接/实现对接
- 完成内容：执行并通过检查与定向测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world -p agent_world_proto`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --lib in_memory_publish_delivers_to_subscribers`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --lib in_memory_dht_tracks_world_head`
- 遗留事项：继续完成 T3（项目文档收口、最终状态回写、补充回归确认并提交）。
- 日期：2026-02-12
- 完成内容：完成 T3 收口（`agent_world` 侧适配回归与最终状态回写）：
  - 项目文档状态更新：`doc/world-runtime/agent-world-proto.project.md`（T3 标记完成，阶段改为全部完成）
  - 回归验证通过：`env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_module_fetch`
  - 补充修复：`crates/agent_world/tests/distributed_bootstrap.rs` 引入 `agent_world_proto` trait 作用域，修复全量测试下 trait 方法解析失败
  - 补充回归通过：`env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_bootstrap`
  - 编译检查通过：`env -u RUSTC_WRAPPER cargo check`
- 遗留事项：当前抽离目标已完成；后续如有新增跨 crate 协议抽象，可继续沉淀到 `agent_world_proto`。
- 完成内容：完成 OWR2-Client（Viewer Prompt Ops 交互闭环）实现：
  - 新增 Prompt 控制回执状态资源 `PromptControlUiState`（`crates/agent_world_viewer/src/prompt_control_state.rs`），接入 `poll_viewer_messages` 对 `PromptControlAck/Error` 的处理，避免业务错误将连接状态误判为断开（`crates/agent_world_viewer/src/main.rs`）。
  - Prompt Ops 面板接入真实请求链路：`preview/apply/rollback` 请求发送、回滚版本输入、在线/离线提示、服务端回执成功/失败消息展示（`crates/agent_world_viewer/src/prompt_ops_panel.rs`）。
  - Prompt Ops 面板新增“载入当前配置”、字段级差异预览（当前配置 vs 草稿）、审计区 `AgentPromptUpdated` 事件展示（tick/version/operation/fields/digest）。
  - 为满足单 Rust 文件行数约束，将 Prompt Ops 面板从 `egui_right_panel.rs` 拆分为独立模块 `prompt_ops_panel.rs`；`egui_right_panel.rs` 仅保留编排与公共区块。
  - 补充测试：
    - `crates/agent_world_viewer/src/prompt_control_state.rs`：回执状态资源行为测试。
    - `crates/agent_world_viewer/src/tests_prompt_control.rs`：`poll_viewer_messages` 的 ack/error 成功/失败路径测试。
    - `crates/agent_world_viewer/src/prompt_ops_panel.rs`：三态 patch 语义、审计过滤顺序、Agent 收集测试。
    - `crates/agent_world_viewer/src/egui_right_panel_tests.rs`：Prompt Ops 面板渲染断言更新。
- 完成内容：更新 OWR 文档状态：
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.project.md`：`OWR2-Client` 标记完成，阶段推进到 `OWR4`。
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.md`：新增 2026-02-12 实施进展与验证记录。
- 完成内容：执行并通过验证命令：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer prompt_control -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer prompt_ops -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：推进 OWR4（规模化稳定性）任务链路：事件窗口策略、对象增量刷新、自动降级策略、压测基线。

- 日期：2026-02-12
- 完成内容：完成 OWR4.1（事件窗口策略）实现：
  - 新增事件窗口策略模块 `crates/agent_world_viewer/src/event_window.rs`，提供滚动窗口 + 采样压缩器：事件流入时优先保留近期全量区，对旧事件按采样步长保留，窗口稳定在上限内。
  - 启动配置新增 OWR4.1 配置项（环境变量）并接入运行时：
    - `AGENT_WORLD_VIEWER_EVENT_WINDOW_SIZE`
    - `AGENT_WORLD_VIEWER_EVENT_WINDOW_RECENT`
    - `AGENT_WORLD_VIEWER_EVENT_SAMPLE_STRIDE`
  - `poll_viewer_messages` 的 `ViewerResponse::Event` 路径切换为策略化窗口写入；`decision_traces` 保持原有上限裁剪逻辑。
  - 补充测试：
    - `event_window.rs`：配置归一化、默认回退、采样窗口、纯滚动窗口测试。
    - `tests.rs`：新增 `poll_viewer_messages_applies_event_window_sampling_policy`，验证消息轮询入口在高事件流下按策略压缩。
- 完成内容：更新 OWR 文档状态：
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.project.md`：`OWR4.1` 标记完成，下一阶段更新为 `OWR4.2`。
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.md`：补充 OWR4.1 实施进展、配置项与验证记录。
- 完成内容：执行并通过验证命令：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续推进 OWR4 后续任务（`OWR4.2` 场景对象增量刷新、`OWR4.3` 自动降级策略、`OWR4.4` 压测脚本与模板、`OWR4.5` 跨版本基线）。

- 日期：2026-02-12
- 完成内容：完成 OWR4.2（场景对象增量刷新）实现：
  - 新增 `crates/agent_world_viewer/src/scene_dirty_refresh.rs`，实现“全量重建判定 + 脏区更新”：
    - 全量重建触发条件：首次快照、时间回退、空间配置变化、fragment 可见性变化；
    - 非上述情况走增量刷新：按对象级别刷新 location/agent/chunk，避免每 tick 全量销毁重建。
  - `update_3d_scene` 接入增量刷新路径；全量重建只在必要条件触发，其余 tick 走脏区更新。
  - `scene_helpers.rs` 中 `apply_events_to_scene` 改为基于 `last_event_id` 去重，不再按 `snapshot_time` 过滤事件时间，保证消息时序波动时增量应用稳定。
  - 对外暴露增量刷新所需 helper（`location_visual_radius_cm`、`agent_module_counts_in_snapshot`）用于脏区判断与更新。
  - 新增测试：
    - `scene_dirty_refresh::tests::scene_requires_full_rebuild_only_for_topology_or_time_regression`
    - `scene_dirty_refresh::tests::location_needs_refresh_detects_cached_delta`
    - `scene_dirty_refresh::tests::agent_needs_refresh_detects_module_and_location_delta`
- 完成内容：更新 OWR 文档状态：
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.project.md`：`OWR4.2` 标记完成，下一阶段调整为 `OWR4.3`。
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.md`：补充 OWR4.2 实施与验证记录。
- 完成内容：执行并通过验证命令：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续推进 OWR4 后续任务（`OWR4.3` 自动降级策略、`OWR4.4` 压测脚本与模板、`OWR4.5` 跨版本基线）。

- 日期：2026-02-12
- 完成内容：完成 OWR4.3（自动降级策略）实现：
  - 新增 `crates/agent_world_viewer/src/auto_degrade.rs`，实现基于渲染压力的自动降级状态机（带滞回）：
    - Level 1：压缩标签上限；
    - Level 2：继续压缩标签并关闭 heat overlay；
    - Level 3：继续压缩标签并关闭 flow overlay。
  - 支持压力回落后逐级恢复，并回放到进入降级前的基线开关/标签配置，避免降级策略把 UI 永久锁在低配档。
  - 新增环境变量 `AGENT_WORLD_VIEWER_AUTO_DEGRADE`（默认开启）控制策略开关。
  - 在 UI 启动链路接入 `AutoDegradeConfig/AutoDegradeState` 资源，并把 `update_auto_degrade_policy` 接入 `sample_render_perf_summary` 后的系统链。
  - 新增自动降级回归测试：
    - `auto_degrade_escalates_then_recovers_with_hysteresis`
    - `auto_degrade_restores_baseline_at_level_zero`
- 完成内容：更新 OWR 文档状态：
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.project.md`：`OWR4.3` 标记完成，下一阶段更新为 `OWR4.4`。
  - `doc/world-simulator/viewer-open-world-sandbox-readiness.md`：补充 OWR4.3 实施与验证记录。
- 完成内容：执行并通过验证命令：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续推进 OWR4 后续任务（`OWR4.4` 压测脚本与模板、`OWR4.5` 跨版本基线）。
