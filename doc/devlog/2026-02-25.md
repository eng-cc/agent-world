# 2026-02-25

- 时刻：2026-02-25 10:38:34 CST
- 完成内容：完成“Viewer WebGL Deferred 兼容降级”T0（设计建档）。
  - 新增设计文档：`doc/world-simulator/viewer-webgl-deferred-compat-2026-02-24.md`
  - 新增项目管理文档：`doc/world-simulator/viewer-webgl-deferred-compat-2026-02-24.project.md`
  - 项目状态：T0 完成，T1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：实现 wasm 路径关闭默认 deferred lighting 插件。

- 时刻：2026-02-25 10:43:37 CST
- 完成内容：完成“Viewer WebGL Deferred 兼容降级”T1（wasm 渲染兼容改造）。
  - `crates/agent_world_viewer/src/app_bootstrap.rs`：
    - 新增 `default_pbr_plugin_for_runtime()`，在 wasm 目标下将 `PbrPlugin.add_default_deferred_lighting_plugin` 设为 `false`。
    - `run_ui` 的 `DefaultPlugins` 配置接入该函数。
    - 新增单测 `default_pbr_plugin_for_runtime_tracks_target_compat_mode`。
  - 项目状态：T0/T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_pbr_plugin_for_runtime_tracks_target_compat_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 T2：Playwright 3D 闭环复验，确认不再出现 `copy_deferred_lighting_id_pipeline` panic。

- 时刻：2026-02-25 10:52:53 CST
- 完成内容：完成“Viewer WebGL Deferred 兼容降级”T2（定向回归验证）。
  - 新增回归总结：`output/playwright/viewer/webgl-3d-panic-fix-20260225-104748/summary.md`
  - Playwright 3D 用例结果：
    - `cameraMode` 从 `2d` 切至 `3d`，并在 step/play 后持续推进。
    - `apiAlive: true`，稳定等待后仍可访问测试 API。
    - 未复现 `copy_deferred_lighting_id_pipeline` panic。
  - 项目状态：T0/T1/T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer default_pbr_plugin_for_runtime_tracks_target_compat_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - Playwright 3D 回归产物：`output/playwright/viewer/webgl-3d-panic-fix-20260225-104748/check3d.txt`
- 遗留事项：
  - 执行 T3：回写最终状态并收口。

- 时刻：2026-02-25 10:54:33 CST
- 完成内容：完成“Viewer WebGL Deferred 兼容降级”T3（文档与日志收口）。
  - 更新项目管理文档：`doc/world-simulator/viewer-webgl-deferred-compat-2026-02-24.project.md`
  - 项目状态：T0/T1/T2/T3 全部完成。
- 测试：
  - 文档收口任务（无新增代码测试）。
- 遗留事项：
  - 无（本设计任务已收口）。

- 时刻：2026-02-25 12:20:35 CST
- 完成内容：完成“按 game-test.md 进行真实玩家游玩并填写可玩性卡片”任务。
  - 按 Web 闭环链路启动并接入：`world_viewer_live` + `run-viewer-web.sh` + Playwright CLI。
  - 完成实际游玩交互（模式切换、选中对象、播放/暂停控制、鼠标键盘基础操作）。
  - 产出测试卡片：`doc/playability_test_result/card_2026_02_25_12_20_02.md`。
  - 过程截图：`output/playwright/playability/20260225-120744/step0-home.png`、`step1-3d-location.png`、`step2-2d-agent.png`。
- 测试：
  - Playwright 实机闭环操作（非单元测试任务）。
- 遗留事项：
  - 如需批量评估，后续可按 `doc/playability_test_manual.md` 将多份卡片转为量化雷达图汇总。

- 时刻：2026-02-25 13:23:57 CST
- 完成内容：完成“按 game-test.md 真实玩家游玩并填写卡片（录屏版）”任务复测。
  - 使用 Playwright CLI 执行一轮真实游玩并启用 `video-start/video-stop` 录屏。
  - 产出录屏与证据：`output/playwright/playability/20260225-132109/`（含 `playthrough.webm` 与控制台日志）。
  - 新增测试卡片：`doc/playability_test_result/card_2026_02_25_13_22_15.md`。
  - 回写项目管理文档：`doc/game-test.project.md`（新增 T4 与第二次测试记录）。
- 测试：
  - Playwright Web 闭环实测（真实操作 + 录屏）：打开 Viewer、模式/选择/控制操作、截图、控制台采样、视频归档。
- 遗留事项：
  - Web 端存在 `copy_deferred_lighting_id_pipeline` 渲染 panic，导致 `window.__AW_TEST__.getState()` 长时间停留 `connecting/tick=0`；需后续修复后再进行可玩性复验。

- 时刻：2026-02-25 14:38:32 CST
- 完成内容：完成“作为开发者排查 game-test 不可玩原因”任务。
  - 基于 Playwright Web 闭环复现并确认：不可玩并非单点问题，存在两层故障链。
    - 基线故障：`copy_deferred_lighting_id_pipeline` 在 WebGL2 + SwiftShader 环境会触发 `wgpu` Validation Error，导致 wasm 中断。
    - 架构耦合：`CopyDeferredLightingIdPlugin` 与 `Core3d` render graph 存在硬耦合，单独禁用该插件会触发新的启动 panic（`Option::expect` -> `RuntimeError: unreachable`）。
  - 回写项目管理文档：`doc/game-test.project.md`（新增 T5 排查任务与证据路径）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer target_compat_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - Playwright 复现证据：
    - `output/playwright/viewer/webgl-deferred-disable-verify2-20260225-143042/`
    - `output/playwright/viewer/webgl-panic-locate-20260225-143645/`
- 遗留事项：
  - 需要设计“成对修正方案”（同时处理 pipeline 初始化与 Core3d graph 依赖），避免再次出现“修一处炸一处”的启动崩溃。

- 时刻：2026-02-25 16:43:20 CST
- 完成内容：完成“按 game-test.md 作为真实玩家游玩并填写卡片（用户追加轮次）”任务。
  - 按默认链路重跑：`world_viewer_live`（默认节点拓扑）+ `run-viewer-web.sh` + Playwright CLI。
  - 完成带录屏实操（模式切换、目标选中、播放/暂停、状态采样）。
  - 新增测试卡片：`doc/playability_test_result/card_2026_02_25_16_40_22.md`。
  - 产物归档：`output/playwright/playability/20260225-163706/`（含 `playthrough.webm`、截图、控制台日志、pids/meta）。
  - 回写项目管理文档：`doc/game-test.project.md`（新增 T6 与测试记录）。
- 测试：
  - Playwright Web 闭环实测（真实操作 + 录屏）：`output/playwright/playability/20260225-163706/playwright.log`
  - 控制台采样：`output/playwright/playability/20260225-163706/console_all_messages.log`（`Errors: 0, Warnings: 8`）
- 遗留事项：
  - 追加复测未出现启动崩溃，但 `window.__AW_TEST__.getState()` 中 `tick` 持续为 `0`，仍需后续定位“世界不推进”根因。

- 时刻：2026-02-25 16:53:04 CST
- 完成内容：完成“补提 game-test 可玩性相关文档并统一提交”任务。
  - 补提文档：`doc/game-test.md`、`doc/playability_test_card.md`、`doc/playability_test_manual.md`。
  - 与本次文档提交流程同步更新当日日志。
- 测试：
  - 文档任务（无代码变更，无新增测试执行）。
- 遗留事项：
  - 无。
- 时刻：2026-02-25 10:35:38 CST
- 完成内容：完成“P2P 长跑 180 分钟 Chaos 模板”C0（方案建档）。
  - 新建设计文档：`doc/testing/p2p-longrun-endurance-chaos-template-2026-02-25.md`。
  - 新建项目管理文档：`doc/testing/p2p-longrun-endurance-chaos-template-2026-02-25.project.md`。
  - 明确目标：提供可复用的大规模固定 `chaos-plan`，并与 continuous chaos 组成混合长跑策略。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 C1：新增 180 分钟 chaos-plan 模板文件并完成多动作分阶段编排。

- 时刻：2026-02-25 10:37:38 CST
- 完成内容：完成“P2P 长跑 180 分钟 Chaos 模板”C1（大规模固定模板落地）。
  - 新增模板：`doc/testing/chaos-plans/p2p-soak-endurance-full-chaos-v1.json`。
  - 模板覆盖 `180` 分钟窗口（`10800` 秒），总事件数 `190`：
    - `triad_distributed` 分钟级持续注入（`restart/pause/disconnect` + `sequencer/storage/observer` 轮换）。
    - `triad` 周期基线扰动事件。
- 测试：
  - `jq . doc/testing/chaos-plans/p2p-soak-endurance-full-chaos-v1.json`
  - `jq '.meta + {events_total:(.events|length)}' doc/testing/chaos-plans/p2p-soak-endurance-full-chaos-v1.json`
- 遗留事项：
  - 执行 C2：在 `testing-manual.md` S9 接入模板化命令，并补充语义边界说明。

- 时刻：2026-02-25 10:40:21 CST
- 完成内容：完成“P2P 长跑 180 分钟 Chaos 模板”C2（手册接线）。
  - `testing-manual.md` S9 新增可直接执行的 `180+` 分钟高覆盖命令：
    - 引用固定模板：`doc/testing/chaos-plans/p2p-soak-endurance-full-chaos-v1.json`
    - 叠加 continuous chaos（`restart/pause/disconnect`）形成混合注入。
  - 在 S9 说明中补充语义边界：
    - `soak_*` 属于长跑执行档位；
    - `test_tier_required/test_tier_full` 属于 Cargo feature 与核心测试分层，不同维度。
- 测试：
  - 行数检查：`wc -l testing-manual.md`（`499`，未超过 `500` 行限制）。
- 遗留事项：
  - 执行 C3：完成短窗可执行性验证并收口。

- 时刻：2026-02-25 10:44:28 CST
- 完成内容：完成“P2P 长跑 180 分钟 Chaos 模板”C3（验证与收口）。
  - 执行短窗可执行性验证（使用新模板 + continuous 混合注入）：
    - `run_dir`：`.tmp/p2p_longrun_full_template_c3/20260225-104201`
    - `summary.json` 校验：
      - `chaos_plan_events_total=1`
      - `chaos_continuous_events_total=3`
      - `chaos_events_total=4`
    - `chaos_events.log` 已验证模板事件 `td-000` 与 continuous 事件同时命中。
  - 文档状态回写：
    - `doc/testing/p2p-longrun-endurance-chaos-template-2026-02-25.md` 标记 M3 完成。
    - `doc/testing/p2p-longrun-endurance-chaos-template-2026-02-25.project.md` 标记 C3 完成并收口。
- 测试：
  - `./scripts/p2p-longrun-soak.sh --profile soak_smoke --duration-secs 130 --topologies triad_distributed --no-prewarm --startup-timeout-secs 12 --poll-interval-secs 2 --chaos-plan doc/testing/chaos-plans/p2p-soak-endurance-full-chaos-v1.json --chaos-continuous-enable --chaos-continuous-start-sec 20 --chaos-continuous-interval-secs 25 --chaos-continuous-max-events 3 --chaos-continuous-actions restart,pause,disconnect --chaos-continuous-seed 20260225 --out-dir .tmp/p2p_longrun_full_template_c3`
- 遗留事项：
  - 无。

- 时刻：2026-02-25 17:31:47 CST
- 完成内容：完成“Viewer 性能测试方法论能力补齐”T1（设计与项目建档）。
  - 新增设计文档：`doc/testing/viewer-performance-methodology-closure-2026-02-25.md`
  - 新增项目管理文档：`doc/testing/viewer-performance-methodology-closure-2026-02-25.project.md`
  - 项目状态：T1 完成，T2 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T2：增强 `scripts/viewer-owr4-stress.sh` 的性能采集、门禁与基线对比能力。

- 时刻：2026-02-25 17:52:54 CST
- 完成内容：完成“Viewer 性能测试方法论能力补齐”T2/T3（脚本实现 + 验证收口）。
  - `scripts/viewer-owr4-stress.sh`：
    - 新增性能档位与阈值参数：`--profile`、`--fps-target`、`--fps-min`、`--perf-budget-ms`、`--max-over-budget-pct`。
    - 新增可选基线回归对比：`--baseline-csv`、`--max-regression-pct`。
    - 新增 gate 执行开关：`--enforce-gate`（`overall_status=fail` 时返回非 0）。
    - 自动开启并采集 `perf_probe`，扩展 `metrics.csv` 字段（FPS/帧时/over_budget/auto_degrade/perf_samples/gate）。
    - 新增 `summary.json` 机器可读输出，并增强 `summary.md` 展示 gate 结果。
  - `crates/agent_world_viewer/src/app_bootstrap.rs`：headless 模式接入 `RenderPerfSummary/RenderPerfHistory` 与 `perf_probe` 调度。
  - `crates/agent_world_viewer/src/render_perf_summary.rs`：新增 `sample_headless_perf_summary`，在 headless 链路补齐帧时窗口采样与摘要输出。
  - 回写文档状态：
    - `doc/testing/viewer-performance-methodology-closure-2026-02-25.md`
    - `doc/testing/viewer-performance-methodology-closure-2026-02-25.project.md`
- 测试：
  - `bash -n scripts/viewer-owr4-stress.sh`
  - `./scripts/viewer-owr4-stress.sh --help`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer headless_auto_play_sends_play_once_after_connected -- --nocapture`
  - `./scripts/viewer-owr4-stress.sh --duration-secs 5 --tick-ms 200 --scenarios triad_region_bootstrap --no-prewarm --profile stress --enforce-gate --out-dir .tmp/viewer_owr4_stress_methodology_smoke`（验证 gate 失败返回非 0）
  - `./scripts/viewer-owr4-stress.sh --duration-secs 20 --tick-ms 200 --scenarios triad_region_bootstrap --no-prewarm --profile stress --out-dir .tmp/viewer_owr4_stress_methodology_smoke`
  - `./scripts/viewer-owr4-stress.sh --duration-secs 12 --tick-ms 200 --scenarios triad_region_bootstrap --no-prewarm --profile stress --baseline-csv .tmp/viewer_owr4_stress_methodology_smoke/20260225-174903/metrics.csv --enforce-gate --out-dir .tmp/viewer_owr4_stress_methodology_smoke`
- 遗留事项：
  - headless 采样口径主要反映 Viewer 主循环时序，不等价于真实 GPU 渲染帧；若需要渲染真实性能口径，后续应在 Web/UI 渲染链路补齐同口径自动采集与 gate。
