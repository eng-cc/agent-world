# 2026-02-14 任务日志（M4 经济模块在线求值接线）

## 日期
- 2026-02-14

## 完成内容
- 新增模块驱动经济动作：
  - `BuildFactoryWithModule`
  - `ScheduleRecipeWithModule`
- 在 `step_with_modules` 中新增模块驱动预处理阶段：
  - 先调用指定 WASM 模块获取建造决策/排产计划
  - 再转换为 `BuildFactory` / `ScheduleRecipe` 执行
- 新增经济模块求值桥接逻辑（`runtime/world/economy.rs`）：
  - 构造 `ModuleCallInput`（CBOR）并调用 `execute_module_call`
  - 解析模块 emit：
    - `economy.factory_build_decision`
    - `economy.recipe_execution_plan`
  - 对非法输出统一记录 `ModuleCallFailed(InvalidOutput)`
- 扩展动作标签与无模块路径拒绝语义：
  - `action.economy.build_factory_with_module`
  - `action.economy.schedule_recipe_with_module`
  - 在 `step`（无模块）路径下返回明确拒绝提示
- 新增并通过模块驱动经济测试：
  - `build_factory_with_module_uses_module_decision`
  - `schedule_recipe_with_module_uses_module_plan`
  - `schedule_recipe_with_module_rejects_when_module_denies`
- 文档回写：
  - `doc/m4-industrial-economy-wasm.md`
  - `doc/m4-industrial-economy-wasm.project.md`
  - `doc/world-simulator.md`
  - `doc/world-simulator.project.md`
- 验证命令：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

## 遗留事项
- 目前模块驱动动作由调用方指定 `module_id`；后续可增加“按工厂/配方标签自动选择模块”的路由策略。
- 仍缺少内置 wasm 经济示例工件（recipe/factory/product）的完整装载与场景回归。
