# 2026-02-26

- 时刻：2026-02-26 11:03:15 CST
- 完成内容：完成“Playwright 使用手册启动防抖与失败分级补充”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：新增启动前自检（端口监听、主页可达、URL 引号约束）、会话防抖与启动失败分级处置（`ERR_CONNECTION_REFUSED` / 渲染 panic / `connecting+tick=0` / URL `source` 解析错误）。
  - 更新 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T12，回写最近更新日期为 2026-02-26。
- 测试：
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/testing/systematic-application-testing-manual.project.md`
  - `rg -n "启动前自检|Fail Fast|ERR_CONNECTION_REFUSED|copy_deferred_lighting_id_pipeline|URL='http://" doc/testing/web-ui-playwright-closure-manual.md`
  - `rg -n "T12|最近更新：2026-02-26" doc/testing/systematic-application-testing-manual.project.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:17:37 CST
- 完成内容：完成“Playwright 手册路径口径与工程实际对齐”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：Playwright 示例改为仓库内 `.codex` 路径（`$REPO_ROOT/.codex/skills/playwright/scripts/playwright_cli.sh`），移除 `CODEX_HOME` 依赖。
  - 更新 `doc/viewer-manual.md`：同步改为仓库内 `.codex` 路径，并新增 wrapper 存在性检查。
  - 更新项目管理文档 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T13。
- 测试：
  - `rg -n "CODEX_HOME|REPO_ROOT|\.codex/skills/playwright/scripts/playwright_cli\.sh" doc/testing/web-ui-playwright-closure-manual.md doc/viewer-manual.md`
  - `rg -n "T13" doc/testing/systematic-application-testing-manual.project.md`
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/viewer-manual.md doc/testing/systematic-application-testing-manual.project.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:28:18 CST
- 完成内容：完成“Web 验收 GPU + headed 硬门禁命令补充”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：新增 `2.2) GPU + headed 硬门禁（验收必须）`，包含 `open "$URL" --headed` 与 `SwiftShader/software rendering` 关键字 fail-fast 判定命令。
  - 更新 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T14。
- 测试：
  - `rg -n "GPU \+ headed|open \"\$URL\" --headed|SwiftShader|software rendering|Failed to create WebGPU Context Provider" doc/testing/web-ui-playwright-closure-manual.md`
  - `rg -n "T14" doc/testing/systematic-application-testing-manual.project.md`
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/testing/systematic-application-testing-manual.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:54:13 CST
- 完成内容：按 `doc/game-test.md` 执行一轮“真实玩家”Playwright Web 闭环试玩并填写卡片。
  - 启动链路：`world_viewer_live` + `run-viewer-web.sh --address 127.0.0.1 --port 4173`。
  - 使用 Playwright headed + `video-start/video-stop` 完成实操，产物落盘到 `output/playwright/playability/20260226-114106/`（含 `playthrough.webm`、截图、控制台日志）。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_11_41_06.md`。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T8，补充本轮测试记录与风险。
- 测试：
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5010&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh eval "() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)"`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh eval "() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(10) ?? null); } catch (e) { return String(e); } }"`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `wc -l doc/playability_test_result/card_2026_02_26_11_41_06.md doc/game-test.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 本轮仍复现 `connectionStatus=connecting` + `tick=0`，并伴随 `WebSocket opening handshake timed out` 与 wasm panic（`assertion failed: old_size > 0`），可玩性闭环未恢复。

- 时刻：2026-02-26 13:04:19 CST
- 完成内容：完成“game-test 一键启动脚本 + 手册补充”任务，降低玩家测试因手工参数错误导致的假故障。
  - 新增 `scripts/run-game-test.sh`：固化推荐启动参数（含 `--web-bind`），并内置端口冲突 fail-fast、HTTP/WS 就绪检查、日志目录输出、`Ctrl+C` 自动清理。
  - 更新 `doc/game-test.md`：新增“一键启动（避免参数错误）”与 Playwright 进入游戏示例。
  - 更新 `doc/game-test.project.md`：新增并完成 T9，补充新脚本依赖与风险缓解说明。
- 测试：
  - `bash -n scripts/run-game-test.sh`
  - `./scripts/run-game-test.sh --help`
  - `timeout 45s ./scripts/run-game-test.sh`（验证端口占用 fail-fast，报错 `port 4173 is already in use`）
  - `timeout 120s ./scripts/run-game-test.sh --viewer-port 4373 --live-bind 127.0.0.1:5223 --web-bind 127.0.0.1:5211`（验证 ready 输出 URL 与超时终止后自动清理）
  - `ps -ef | rg 'world_viewer_live|run-viewer-web.sh|trunk serve --address 127.0.0.1 --port 4373' | rg -v rg || true`
  - `ss -ltn | rg '4373|5211|5223' || true`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 13:15:46 CST
- 完成内容：按用户请求基于 `doc/game-test.md` 再执行一轮“真实玩家”Playwright 闭环游玩并填写卡片。
  - 使用 `./scripts/run-game-test.sh --viewer-port 4473 --live-bind 127.0.0.1:5323 --web-bind 127.0.0.1:5311` 启动链路，完成 headed + 录屏实操。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_13_10_04.md`。
  - 产物落盘：`output/playwright/playability/20260226-131004/`（含 `playthrough.webm`、前后截图、控制台日志、启动日志）。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T10，补充本轮测试记录与风险。
- 测试：
  - `command -v npx >/dev/null 2>&1; echo $?`
  - `./scripts/run-game-test.sh --viewer-port 4473 --live-bind 127.0.0.1:5323 --web-bind 127.0.0.1:5311`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4473/?ws=ws://127.0.0.1:5311&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh snapshot`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press KeyW`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press KeyA`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press Space`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { window.__AW_TEST__?.setMode?.("3d"); return "ok"; } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
  - `ps -ef | rg 'world_viewer_live|run-viewer-web.sh|trunk serve --address 127.0.0.1 --port 4473' | rg -v rg || true`
  - `ss -ltn | rg '4473|5311|5323' || true`
  - `wc -l doc/playability_test_result/card_2026_02_26_13_10_04.md doc/game-test.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 本轮在 `connectionStatus=connected` 下仍出现 `tick=0` 不推进；`runSteps(20)` 会触发 `RuntimeError: unreachable` 与 wasm panic（`assertion failed: old_size > 0`），可玩性闭环仍未恢复。

- 时刻：2026-02-26 14:32:33 CST
- 完成内容：完成“viewer-web-playability-unblock-2026-02-26”文档建档任务。
  - 新增设计文档：`doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`。
  - 在项目文档中新增并完成 T0，后续进入 T1（web_test_api 入参契约修复）。
- 测试：
  - `wc -l doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`
  - `rg -n "目标|范围|接口/数据|里程碑|风险" doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md`
  - `rg -n "T0|T1|任务拆解|依赖|状态" doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`
- 遗留事项：
  - 按项目文档继续完成 T1~T4。

- 时刻：2026-02-26 15:06:59 CST
- 完成内容：完成 T1（web_test_api 入参契约修复，消除类型不匹配 panic）。
  - 更新 `crates/agent_world_viewer/src/web_test_api.rs`：
    - `runSteps/setMode/focus/select/sendControl` 统一改为 `JsValue` 入参解析，避免 `FnMut(String)` 在错误类型输入下触发 wasm `unreachable`。
    - `runSteps` 新增 number / `{count}` 兼容，映射为 `ViewerControl::Step { count }`；保留 string DSL 自动化步骤能力。
    - `sendControl` 对 action 非字符串场景改为稳定告警，不再潜在 panic。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `./scripts/run-game-test.sh --viewer-port 4673 --live-bind 127.0.0.1:5523 --web-bind 127.0.0.1:5511`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4673/?ws=ws://127.0.0.1:5511&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh console error`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - `run-game-test.sh` 的就绪探针仍会触发 `viewer web bridge error: WebSocket(Protocol(HandshakeIncomplete))`，在 T3 处理。

- 时刻：2026-02-26 15:27:54 CST
- 完成内容：完成 T2（wasm + Player 默认可推进）。
  - 更新 `crates/agent_world_viewer/src/headless.rs`：`headless_auto_play_once` 支持读取 `ViewerExperienceMode`，在 wasm 且 Player 模式下默认自动发送一次 `ViewerControl::Play`（未显式设置 `AGENT_WORLD_VIEWER_AUTO_PLAY` 时）。
  - 更新 `crates/agent_world_viewer/src/app_bootstrap.rs`：Player 默认右侧面板从隐藏改为显示；`show_controls` 默认改为 `true`，确保首次进入可见控制入口。
  - 同步更新 `app_bootstrap` 默认值相关测试断言。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `./scripts/run-game-test.sh --viewer-port 4773 --live-bind 127.0.0.1:5623 --web-bind 127.0.0.1:5611`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4773/?ws=ws://127.0.0.1:5611&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - 启动脚本 WS 就绪探针仍会触发 `viewer web bridge error: WebSocket(Protocol(HandshakeIncomplete))`，需在 T3 处理。

- 时刻：2026-02-26 15:40:36 CST
- 完成内容：完成 T3（修复 `run-game-test.sh` 的 WS 就绪探针，消除握手污染日志）。
  - 更新 `scripts/run-game-test.sh`：将 `wait_for_tcp_ready`（`/dev/tcp` 主动连接）替换为 `wait_for_tcp_listener_ready`（`lsof/ss` 被动监听探针），避免对 WS 端口发送非握手流量。
  - 保留无 `lsof/ss` 场景下的兼容告警，不阻塞脚本主流程。
- 测试：
  - `bash -n scripts/run-game-test.sh`
  - `rg -n "wait_for_tcp_listener_ready|wait_for_tcp_ready|/dev/tcp" scripts/run-game-test.sh`
  - `timeout 240s ./scripts/run-game-test.sh --viewer-port 4873 --live-bind 127.0.0.1:5723 --web-bind 127.0.0.1:5711 | tee /tmp/t3-run-game-test.out`
  - `rg -n "HandshakeIncomplete|viewer web bridge error|opening handshake timed out" output/playwright/playability/startup-20260226-153708/world_viewer_live.log`
  - `tail -n 40 output/playwright/playability/startup-20260226-153708/world_viewer_live.log`
  - `ps -ef | rg 'world_viewer_live llm_bootstrap|run-viewer-web.sh --address 127.0.0.1 --port 4873|run-game-test.sh --viewer-port 4873' | rg -v rg`
- 遗留事项：
  - 继续执行 T4 回归验证并收尾文档。

- 时刻：2026-02-26 15:59:21 CST
- 完成内容：完成 T4（回归验证与文档收尾）。
  - 执行 `agent_world_viewer` native/wasm 回归检查，确认构建与类型检查通过。
  - 使用 `run-game-test.sh` + Playwright 冒烟验证：
    - `connectionStatus=connected` 且 `tick` 从 `100` 增长到 `206`（默认自动推进生效）。
    - `runSteps(20)` 返回 `"null"`，未复现 `RuntimeError: unreachable` / `assertion failed: old_size > 0`。
    - 启动日志未再出现 `HandshakeIncomplete`。
  - 回写 `doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`，将 T4 标记完成并收敛状态为“已完成（T0~T4）”。
- 测试：
  - `command -v npx >/dev/null 2>&1; echo $?`
  - `bash -n scripts/run-game-test.sh`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `timeout 300s ./scripts/run-game-test.sh --viewer-port 5073 --live-bind 127.0.0.1:5923 --web-bind 127.0.0.1:5911 | tee /tmp/t4-run-game-test.out`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:5073/?ws=ws://127.0.0.1:5911&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `sleep 3; PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `rg -n "RuntimeError: unreachable|assertion failed: old_size > 0|HandshakeIncomplete|WebSocket opening handshake timed out" .playwright-cli/console-2026-02-26T07-53-55-416Z.log`
  - `rg -n "HandshakeIncomplete|viewer web bridge error|opening handshake timed out" output/playwright/playability/startup-20260226-155119/world_viewer_live.log`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - 仍可见 trunk 热更新通道的 `ERR_CONNECTION_REFUSED` 控制台噪声（不影响当前游玩闭环），后续如需可单独治理。

- 时刻：2026-02-26 16:33:16 CST
- 完成内容：按用户请求基于 `doc/game-test.md` 执行一轮“真实玩家”Playwright 闭环游玩并填写卡片。
  - 使用 `./scripts/run-game-test.sh --viewer-port 5273 --live-bind 127.0.0.1:6023 --web-bind 127.0.0.1:6011` 启动链路，完成 headed + 录屏实操。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_16_27_06.md`。
  - 产物落盘：`output/playwright/playability/20260226-162706/`（含 `playthrough.webm`、前后截图、控制台日志、启动日志）。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T11，补充本轮测试记录与状态。
- 测试：
  - `command -v npx >/dev/null 2>&1; echo $?`
  - `./scripts/run-game-test.sh --viewer-port 5273 --live-bind 127.0.0.1:6023 --web-bind 127.0.0.1:6011`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:5273/?ws=ws://127.0.0.1:6011&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
  - `ps -ef | rg 'world_viewer_live llm_bootstrap|run-viewer-web.sh --address 127.0.0.1 --port 5273|run-game-test.sh --viewer-port 5273' | rg -v rg || true`
  - `ss -ltn | rg '5273|6011|6023' || true`
- 遗留事项：
  - 本轮主链路可玩（`connected` + `tick` 增长 + `runSteps` 正常）；后续可优化玩家引导与 `sendControl` 入参提示，减少“输入被忽略”的困惑感。
- 时刻：2026-02-26 10:57:37 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T0 建档。
  - 新建设计文档：`doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.md`
  - 新建项目管理文档：`doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.project.md`
  - 任务拆解覆盖 P0-01~P0-08，明确 P0-03 口径为“移除峰谷，纯供需定价”。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：冻结 M4.4 供需电价模型定义并回写相关文档。

- 时刻：2026-02-26 11:08:46 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T1（P0-01）。
  - 在 `doc/world-simulator/m4/m4-power-system.md` 冻结 M4.4 纯供需定价模型公式。
  - 回写 `doc/world-simulator/m4/m4-power-system.project.md`，明确移除峰谷时段机制并纳入 required/full 测试口径。
  - 更新 `doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.project.md` 状态为 T2 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T2：实现动态电价并去除峰谷时段机制。

- 时刻：2026-02-26 11:21:44 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T2（P0-02/P0-03）。
  - 修改 `crates/agent_world/src/simulator/kernel/actions_impl_part2.rs`，将电价报价改为纯供需压力模型：`(requested/available - 1)`，并移除距离溢价参与。
  - 保留传输损耗/跨地点传输距离约束，仅移除其对“价格”的影响。
  - 更新 `crates/agent_world/src/simulator/tests/power.rs` 动态报价断言以匹配新口径。
  - 回写 `doc/world-simulator/m4/m4-power-system.project.md` 与闭环收口项目文档状态，推进至 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::power::power_buy_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::power::power_buy_zero_price_uses_dynamic_market_quote`
- 遗留事项：
  - 执行 T3：补齐电价/市场机制测试并纳入 test_tier_required/full。

- 时刻：2026-02-26 11:45:17 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T3（P0-04）。
  - 在 `crates/agent_world/src/simulator/tests/power.rs` 新增纯供需口径回归测试：
    - `power_buy_zero_price_equal_supply_keeps_base_price`
    - `power_order_keeps_open_when_quote_below_sell_limit`
  - 更新 `testing-manual.md`，补充电价/市场机制在 `test_tier_required/full` 的定向回归命令。
  - 回写 `doc/world-simulator/m4/m4-power-system.project.md` 与闭环收口项目文档状态，推进至 T4。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power::power_buy_zero_price_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power::power_order_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full simulator::tests::power:: -- --nocapture`
- 遗留事项：
  - 执行 T4：完成硬件生产/维护/折旧/回收闭环。

- 时刻：2026-02-26 12:04:56 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T4（P0-05）。
  - 在 runtime 经济链路新增工厂硬件闭环：
    - `Action::MaintainFactory` / `Action::RecycleFactory`
    - `DomainEvent::FactoryDurabilityChanged` / `FactoryMaintained` / `FactoryRecycled`
    - `FactoryState.durability_ppm` 持久化字段（默认 1,000,000）
  - 在 `step` 前置执行工厂折旧事件生成（按 `maintenance_per_tick` 衰减耐久），并在状态应用阶段落实维护消耗与回收返还。
  - 新增测试文件 `crates/agent_world/src/runtime/tests/economy_factory_lifecycle.rs`，补齐折旧/维护/回收/回收拒绝（有活跃配方）闭环测试。
  - 更新闭环项目管理文档状态到 T5。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy_factory_lifecycle:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy::build_factory_consumes_materials_and_completes_after_delay -- --nocapture`
- 遗留事项：
  - 执行 T5：完成数据获取/存储/交易/访问控制闭环。

- 时刻：2026-02-26 12:24:49 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T5（P0-06）。
  - 在 runtime 新增数据闭环动作与事件：
    - `Action::CollectData` / `GrantDataAccess` / `RevokeDataAccess`
    - `DomainEvent::DataCollected` / `DataAccessGranted` / `DataAccessRevoked`
  - 新增 `WorldState.data_access_permissions` 授权状态，并实现 `has_data_access_permission` 判定。
  - 在 `action_to_event_economy` 中落地：
    - 数据采集（耗电增数）
    - Data 资源转移授权校验（无授权拒绝跨 Agent Data 转移）
  - 在 `action_to_event_policy_contract` 中落地：
    - Data 合约成功结算前授权校验（无授权拒绝结算）
  - 新增测试 `crates/agent_world/src/runtime/tests/data_access_control.rs`，覆盖采集、转移授权、合约授权拒绝/成功路径。
  - 更新既有受影响测试（Data transfer overflow、Data contract settlement）以显式授予访问权限。
  - 回写闭环项目管理文档状态推进至 T6。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world data_access_control -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world emit_resource_transfer_overflow_keeps_balances_atomic -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world economic_contract_settlement_overflow_keeps_state_atomic -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world economic_contract_settlement_applies_tax_and_reputation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world economic_contract_success_reputation_reward_respects_stake_and_cap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::data_access_control:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full runtime::tests::data_access_control:: -- --nocapture`
- 遗留事项：
  - 执行 T6：完成合约任务与声誉系统反通胀/防刷策略收口。

- 时刻：2026-02-26 12:35:50 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T6（P0-07）。
  - 在合约结算链路新增反刷策略：
    - pair 级冷却：同一 pair 在冷却窗口内重复成功结算会被拒绝。
    - 声誉窗口上限：按主体维度统计窗口累计奖励，超过上限后窗口内奖励衰减到 0。
  - 在 `WorldState` 新增持久化状态：
    - `contract_pair_last_success_settled_at`
    - `reputation_reward_window_started_at`
    - `reputation_reward_window_accumulated`
  - 在 `action_to_event_policy_contract` 中接入冷却和窗口预算计算，按预算裁剪 `creator/counterparty` 声誉增量。
  - 在 `apply_domain_event_gameplay` 中对成功结算写回 pair 成功时间与窗口累计，形成状态闭环。
  - 在 `crates/agent_world/src/runtime/tests/gameplay_protocol_split_part2.rs` 新增回归：
    - `economic_contract_pair_cooldown_rejects_repeated_success_settlement`
    - `economic_contract_reputation_window_cap_decays_reward_to_zero_then_recovers`
  - 回写闭环项目管理文档状态推进至 T7。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::gameplay_protocol::economic_contract_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full runtime::tests::gameplay_protocol::economic_contract_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::data_access_control:: -- --nocapture`
- 遗留事项：
  - 执行 T7：完成禁区/配额/税费/电费治理最小规则。

- 时刻：2026-02-26 12:44:28 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T7（P0-08）。
  - 扩展治理策略最小字段：
    - `GameplayPolicyState.power_trade_fee_bps`
    - `GameplayPolicyState.forbidden_location_ids`
  - 扩展治理动作/事件 `UpdateGameplayPolicy` / `GameplayPolicyUpdated` 载荷，新增上述字段并在策略更新链路做归一化与上限校验。
  - 在 `MoveAgent` 路径接入禁区校验（按目标坐标映射 location key，命中 `forbidden_location_ids` 则拒绝）。
  - 在经济合约 `Electricity` 成功结算中叠加“电费 + 电力税”：
    - 计算口径：`electricity_tax_bps + power_trade_fee_bps`（上限钳制到 10000 bps）。
  - 新增治理回归测试：
    - `move_agent_is_denied_when_target_location_is_forbidden`
    - `economic_contract_electricity_settlement_applies_power_trade_fee_and_tax`
  - 回写闭环项目管理文档状态推进至 T8。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::gameplay_protocol:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 执行 T8：回归与收口（文档、devlog、测试）。

- 时刻：2026-02-26 12:50:23 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T8（回归与收口）。
  - 对 T0~T7 交付内容执行收口检查，确认项目管理文档任务已全部完成。
  - 更新 `doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.project.md` 状态为“已完成”。
  - 当日 devlog 收口，归档本轮 P0-01~P0-08 实施与测试轨迹。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - 本轮 T5/T6/T7 提交钩子均已完成 required 回归链路：
    - `agent_world --tests --features test_tier_required`
    - `agent_world_consensus --lib`
    - `agent_world_distfs --lib`
    - `agent_world_viewer`
    - `agent_world_viewer --target wasm32-unknown-unknown` 检查
- 遗留事项：
  - 无（本轮闭环任务全部完成）。

- 时刻：2026-02-26 13:20:00 CST
- 完成内容：完成“M4 工业模块文档口径校正”任务（仅文档）。
  - 修正 `doc/world-simulator/m4/m4-industrial-economy-wasm.project.md` 中旧 crate 名：`agent_world_builtin_wasm` -> `agent_world_builtin_wasm_modules`。
  - 同步将 E6 校验命令修正为当前流程命令：`./scripts/sync-m4-builtin-wasm-artifacts.sh --check`。
  - 更新项目文档状态“最近更新”为本次口径修正记录（2026-02-26）。
- 测试：
  - 文档一致性校验：`rg -n "agent_world_builtin_wasm\\b" doc/world-simulator/m4/*.md`
- 遗留事项：
  - 输出“模块模板化抽象（2）”与“bootstrap 清单驱动化（3）”设计方案（本轮不提交代码）。

- 时刻：2026-02-26 13:38:32 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T0 建档。
  - 新建设计文档：`doc/world-simulator/m4/m4-builtin-wasm-maintainability-2026-02-26.md`。
  - 新建项目管理文档：`doc/world-simulator/m4/m4-builtin-wasm-maintainability-2026-02-26.project.md`。
  - 任务拆解为 T1（模块模板化）与 T2（bootstrap 清单驱动化）两项代码任务。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 M4 Recipe/Product/Factory 模块模板化抽象。

- 时刻：2026-02-26 14:11:54 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T1（模块模板化抽象）。
  - 新增模板目录与三类共享模板：
    - `crates/agent_world_builtin_wasm_modules/_templates/m4_recipe_module_template.rs`
    - `crates/agent_world_builtin_wasm_modules/_templates/m4_product_module_template.rs`
    - `crates/agent_world_builtin_wasm_modules/_templates/m4_factory_module_template.rs`
  - 将 13 个 M4 模块 `src/lib.rs` 重构为“常量参数 + include 模板实现”，去除重复逻辑。
  - 同步刷新 M4 工件清单：
    - `crates/agent_world/src/runtime/world/artifacts/m4_builtin_modules.sha256`
    - `crates/agent_world/src/runtime/world/artifacts/m4_builtin_modules.identity.json`
  - 回写项目管理文档状态推进至 T2。
- 测试：
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh`
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime,test_tier_full runtime::tests::economy_bootstrap:: -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 bootstrap 清单驱动化与一致性护栏测试。

- 时刻：2026-02-26 14:24:12 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T2（bootstrap 清单驱动化）。
  - 重构 `crates/agent_world/src/runtime/world/bootstrap_economy.rs`：
    - 引入 `M4BootstrapModuleDescriptor` 与 `M4_BOOTSTRAP_MODULES` 描述符清单。
    - `install_m4_economy_bootstrap_modules` 改为按描述符循环安装，不再手工逐项 `ensure_bootstrap_module`。
    - 新增一致性护栏：描述符 `module_id` 列表必须与 `world/artifacts/m4_builtin_module_ids.txt` 一致，否则返回 `ModuleChangeInvalid`。
  - 精简 manifest 生成路径，统一由描述符驱动 `module_id/name/max_call_rate`。
  - 新增测试接线：`m4_builtin_module_ids_manifest_matches_runtime_constants` 额外校验 `m4_bootstrap_module_ids()` 与常量清单一致。
  - 回写项目管理文档状态推进至 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime,test_tier_full runtime::tests::economy_bootstrap:: -- --nocapture`
- 遗留事项：
  - 执行 T3：回归收口并完成本轮任务关闭。

- 时刻：2026-02-26 15:03:02 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T3（回归与收口）。
  - 确认 T0~T2 任务全部完成，项目管理文档状态更新为“已完成”。
  - 汇总本轮变更：
    - M4 模块入口模板化抽象（Recipe/Product/Factory）。
    - M4 bootstrap 改为描述符清单驱动，并新增描述符/清单一致性护栏。
- 测试：
  - T1 定向：`./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
  - T1/T2 定向：`env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime,test_tier_full runtime::tests::economy_bootstrap:: -- --nocapture`
  - 本次提交钩子 required 回归链路（agent_world/consensus/distfs/viewer/wasm check）通过。
- 遗留事项：
  - 无。
- 时刻：2026-02-26 11:07:53 CST
- 完成内容：完成“GitHub Pages 首页激进改造（2026-02-26）”T0（建档与基线）。
  - 新增设计文档：`doc/site/github-pages-home-radical-redesign-2026-02-26.md`。
  - 新增项目管理文档：`doc/site/github-pages-home-radical-redesign-2026-02-26.project.md`。
  - 项目管理文档标记任务 0 完成，并更新下一步为任务 1（实现阶段）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T1：完成首页 CN/EN 与共享样式的激进改造实现。

- 时刻：2026-02-26 11:37:28 CST
- 完成内容：完成“GitHub Pages 首页激进改造（2026-02-26）”T1（首页与样式实现）。
  - 视觉系统重写：`site/assets/styles.css`
    - 更换首页视觉语言为高对比赛博战术风，重做字体体系、色板、栅格、卡片层次、移动断点与动效节奏。
    - 保留文档中心页面依赖样式（`docs-*`、导航、按钮、基础排版）以维持站点整体可用。
  - 首页重写：`site/index.html`、`site/en/index.html`
    - 以“游戏战场叙事”重写 Hero 与中段内容，强化玩家决策与冲突感；引擎内容继续后置于 `#architecture`。
    - 保持 CN/EN 同构（同 section 顺序、同锚点、同 proof switcher 数据标记）。
    - 保持 `site/assets/app.js` 依赖的 `data-*` 与 section `id` 兼容。
  - 项目管理文档回写：`doc/site/github-pages-home-radical-redesign-2026-02-26.project.md` 标记任务 1 完成。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T2：完成验证收口与项目状态结项。

- 时刻：2026-02-26 11:47:10 CST
- 完成内容：完成“GitHub Pages 首页激进改造（2026-02-26）”T2（验证与收口）。
  - 执行收口校验：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`，结果通过。
  - 回写项目管理文档：`doc/site/github-pages-home-radical-redesign-2026-02-26.project.md`，标记任务 2 完成并更新整体状态为“已完成”。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 12:05:15 CST
- 完成内容：完成“GitHub Pages 首屏 CTA 收敛与文案校准（2026-02-26）”T0（建档与范围确认）。
  - 新增设计文档：`doc/site/github-pages-hero-cta-simplify-2026-02-26.md`。
  - 新增项目管理文档：`doc/site/github-pages-hero-cta-simplify-2026-02-26.project.md`。
  - 项目管理文档标记任务 0 完成，并更新下一步为任务 1（实现阶段）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T1：完成 CN/EN 首屏 CTA 收敛与主按钮文案重写。

- 时刻：2026-02-26 12:08:00 CST
- 完成内容：完成“GitHub Pages 首屏 CTA 收敛与文案校准（2026-02-26）”T1（实现与收口）。
  - 首页 Hero CTA 收敛：
    - `site/index.html`：首屏 CTA 从 4 个收敛为 2 个（主按钮 + 文档按钮）。
    - `site/en/index.html`：同步收敛为 2 个（保持中英文同构）。
  - 主按钮文案重写：
    - 中文由“30 秒进入首局”改为“试玩 / 观看演示”。
    - 英文由 “Enter a Match in 30 Seconds” 改为 “Try or Watch Demo”。
  - 项目管理文档回写：`doc/site/github-pages-hero-cta-simplify-2026-02-26.project.md` 标记任务 1 完成并结项。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 13:17:59 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T0（建档与基线）。
  - 新增设计文档：`doc/site/github-pages-home-conversion-i18n-screenshot-refresh-2026-02-26.md`。
  - 新增项目管理文档：`doc/site/github-pages-home-conversion-i18n-screenshot-refresh-2026-02-26.project.md`。
  - 项目管理文档标记任务 0 完成，下一步进入任务 1（首屏转化文案收敛）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T1：完成首页首屏转化文案收敛与中英一致性校准。

- 时刻：2026-02-26 13:23:24 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T1（首屏转化文案收敛）。
  - 更新 `site/index.html`：首屏与上手区文案改为“本地 3 步”真实门槛口径，补充首次构建耗时说明。
  - 更新 `site/en/index.html`：同步改为 `Local 3-Step` 口径，并补充首次构建说明。
  - 保持 section 锚点与 `data-*` 兼容，完成本地页面快检。
  - 回写项目管理文档：标记任务 1 完成。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T2：继续完成中英文一致性校准。

- 时刻：2026-02-26 13:25:37 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T2（中英文一致性校准）。
  - 更新 `site/index.html`：导航入口 `#demo` 文案由“立即开局”统一为“本地 3 步”。
  - 更新 `site/en/index.html`：导航入口 `#demo` 文案由 “Start Fast” 统一为 “3-Step Setup”。
  - 回写项目管理文档：标记任务 2 完成，下一步进入任务 3（截图刷新）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T3：按 Web 闭环重新采集并替换三张场景截图。

- 时刻：2026-02-26 13:52:12 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T3（游戏 UI 截图刷新）。
  - 先按 S6 执行 Web 闭环截图尝试（`run-viewer-web.sh + Playwright`），发现浏览器侧触发 `wgpu` pipeline panic（`copy_deferred_lighting_id_pipeline`），`__AW_TEST__.getState().connectionStatus` 持续 `connecting`，无法形成有效 Web 截图。
  - 按约定切换 fallback：使用 native 抓图链路（等价 `capture-viewer-frame` 过程，显式 `world_viewer_live --no-llm`）完成三场景抓图并保留证据：
    - `output/playwright/viewer/home-refresh-20260226-native/minimal/`
    - `output/playwright/viewer/home-refresh-20260226-native/twin_region_bootstrap/`
    - `output/playwright/viewer/home-refresh-20260226-native/triad_region_bootstrap/`
  - 已更新站点截图素材：
    - `site/assets/images/screenshots/minimal.webp`
    - `site/assets/images/screenshots/twin_region_bootstrap.webp`
    - `site/assets/images/screenshots/triad_region_bootstrap.webp`
- 测试：
  - test_tier_required（Web 闭环尝试）：`env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173` + Playwright `open/snapshot/eval(__AW_TEST__)`（记录失败证据）。
  - test_tier_required（fallback 闭环）：native 三场景抓图流程（`world_viewer_live --no-llm` + `agent_world_viewer` + `Xvfb/ffmpeg`）通过。
  - 产物校验：`ffprobe` 校验三张目标图均为 `2400x1600`、`yuv420p`。
- 遗留事项：
  - 执行 T4：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`，并完成项目文档收口。

- 时刻：2026-02-26 13:54:47 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T4（验证与收口）。
  - 执行并通过：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`。
  - 回写项目管理文档：`doc/site/github-pages-home-conversion-i18n-screenshot-refresh-2026-02-26.project.md`，标记任务 4 完成并更新整体状态为“已完成”。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 无。
