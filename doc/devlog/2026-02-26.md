# 2026-02-26

- 时刻：2026-02-26 11:03:15 CST
- 完成内容：完成“Playwright 使用手册启动防抖与失败分级补充”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：新增启动前自检（端口监听、主页可达、URL 引号约束）、会话防抖与启动失败分级处置（`ERR_CONNECTION_REFUSED` / 渲染 panic / `connecting+tick=0` / URL `source` 解析错误）。
  - 更新 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T12，回写最近更新日期为 2026-02-26。
- 测试：
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/testing/systematic-application-testing-manual.project.md`
  - `rg -n "启动前自检|Fail Fast|ERR_CONNECTION_REFUSED|copy_deferred_lighting_id_pipeline|URL='http://" doc/testing/web-ui-playwright-closure-manual.md`
  - `rg -n "T12|最近更新：2026-02-26" doc/testing/systematic-application-testing-manual.project.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:17:37 CST
- 完成内容：完成“Playwright 手册路径口径与工程实际对齐”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：Playwright 示例改为仓库内 `.codex` 路径（`$REPO_ROOT/.codex/skills/playwright/scripts/playwright_cli.sh`），移除 `CODEX_HOME` 依赖。
  - 更新 `doc/viewer-manual.md`：同步改为仓库内 `.codex` 路径，并新增 wrapper 存在性检查。
  - 更新项目管理文档 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T13。
- 测试：
  - `rg -n "CODEX_HOME|REPO_ROOT|\.codex/skills/playwright/scripts/playwright_cli\.sh" doc/testing/web-ui-playwright-closure-manual.md doc/viewer-manual.md`
  - `rg -n "T13" doc/testing/systematic-application-testing-manual.project.md`
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/viewer-manual.md doc/testing/systematic-application-testing-manual.project.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:28:18 CST
- 完成内容：完成“Web 验收 GPU + headed 硬门禁命令补充”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：新增 `2.2) GPU + headed 硬门禁（验收必须）`，包含 `open "$URL" --headed` 与 `SwiftShader/software rendering` 关键字 fail-fast 判定命令。
  - 更新 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T14。
- 测试：
  - `rg -n "GPU \+ headed|open \"\$URL\" --headed|SwiftShader|software rendering|Failed to create WebGPU Context Provider" doc/testing/web-ui-playwright-closure-manual.md`
  - `rg -n "T14" doc/testing/systematic-application-testing-manual.project.md`
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/testing/systematic-application-testing-manual.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:54:13 CST
- 完成内容：按 `doc/game-test.md` 执行一轮“真实玩家”Playwright Web 闭环试玩并填写卡片。
  - 启动链路：`world_viewer_live` + `run-viewer-web.sh --address 127.0.0.1 --port 4173`。
  - 使用 Playwright headed + `video-start/video-stop` 完成实操，产物落盘到 `output/playwright/playability/20260226-114106/`（含 `playthrough.webm`、截图、控制台日志）。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_11_41_06.md`。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T8，补充本轮测试记录与风险。
- 测试：
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5010&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh eval "() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)"`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh eval "() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(10) ?? null); } catch (e) { return String(e); } }"`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `wc -l doc/playability_test_result/card_2026_02_26_11_41_06.md doc/game-test.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 本轮仍复现 `connectionStatus=connecting` + `tick=0`，并伴随 `WebSocket opening handshake timed out` 与 wasm panic（`assertion failed: old_size > 0`），可玩性闭环未恢复。

- 时刻：2026-02-26 13:04:19 CST
- 完成内容：完成“game-test 一键启动脚本 + 手册补充”任务，降低玩家测试因手工参数错误导致的假故障。
  - 新增 `scripts/run-game-test.sh`：固化推荐启动参数（含 `--web-bind`），并内置端口冲突 fail-fast、HTTP/WS 就绪检查、日志目录输出、`Ctrl+C` 自动清理。
  - 更新 `doc/game-test.md`：新增“一键启动（避免参数错误）”与 Playwright 进入游戏示例。
  - 更新 `doc/game-test.project.md`：新增并完成 T9，补充新脚本依赖与风险缓解说明。
- 测试：
  - `bash -n scripts/run-game-test.sh`
  - `./scripts/run-game-test.sh --help`
  - `timeout 45s ./scripts/run-game-test.sh`（验证端口占用 fail-fast，报错 `port 4173 is already in use`）
  - `timeout 120s ./scripts/run-game-test.sh --viewer-port 4373 --live-bind 127.0.0.1:5223 --web-bind 127.0.0.1:5211`（验证 ready 输出 URL 与超时终止后自动清理）
  - `ps -ef | rg 'world_viewer_live|run-viewer-web.sh|trunk serve --address 127.0.0.1 --port 4373' | rg -v rg || true`
  - `ss -ltn | rg '4373|5211|5223' || true`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 13:15:46 CST
- 完成内容：按用户请求基于 `doc/game-test.md` 再执行一轮“真实玩家”Playwright 闭环游玩并填写卡片。
  - 使用 `./scripts/run-game-test.sh --viewer-port 4473 --live-bind 127.0.0.1:5323 --web-bind 127.0.0.1:5311` 启动链路，完成 headed + 录屏实操。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_13_10_04.md`。
  - 产物落盘：`output/playwright/playability/20260226-131004/`（含 `playthrough.webm`、前后截图、控制台日志、启动日志）。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T10，补充本轮测试记录与风险。
- 测试：
  - `command -v npx >/dev/null 2>&1; echo $?`
  - `./scripts/run-game-test.sh --viewer-port 4473 --live-bind 127.0.0.1:5323 --web-bind 127.0.0.1:5311`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4473/?ws=ws://127.0.0.1:5311&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh snapshot`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press KeyW`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press KeyA`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press Space`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { window.__AW_TEST__?.setMode?.("3d"); return "ok"; } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
  - `ps -ef | rg 'world_viewer_live|run-viewer-web.sh|trunk serve --address 127.0.0.1 --port 4473' | rg -v rg || true`
  - `ss -ltn | rg '4473|5311|5323' || true`
  - `wc -l doc/playability_test_result/card_2026_02_26_13_10_04.md doc/game-test.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 本轮在 `connectionStatus=connected` 下仍出现 `tick=0` 不推进；`runSteps(20)` 会触发 `RuntimeError: unreachable` 与 wasm panic（`assertion failed: old_size > 0`），可玩性闭环仍未恢复。

- 时刻：2026-02-26 14:32:33 CST
- 完成内容：完成“viewer-web-playability-unblock-2026-02-26”文档建档任务。
  - 新增设计文档：`doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`。
  - 在项目文档中新增并完成 T0，后续进入 T1（web_test_api 入参契约修复）。
- 测试：
  - `wc -l doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`
  - `rg -n "目标|范围|接口/数据|里程碑|风险" doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md`
  - `rg -n "T0|T1|任务拆解|依赖|状态" doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`
- 遗留事项：
  - 按项目文档继续完成 T1~T4。

- 时刻：2026-02-26 15:06:59 CST
- 完成内容：完成 T1（web_test_api 入参契约修复，消除类型不匹配 panic）。
  - 更新 `crates/agent_world_viewer/src/web_test_api.rs`：
    - `runSteps/setMode/focus/select/sendControl` 统一改为 `JsValue` 入参解析，避免 `FnMut(String)` 在错误类型输入下触发 wasm `unreachable`。
    - `runSteps` 新增 number / `{count}` 兼容，映射为 `ViewerControl::Step { count }`；保留 string DSL 自动化步骤能力。
    - `sendControl` 对 action 非字符串场景改为稳定告警，不再潜在 panic。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `./scripts/run-game-test.sh --viewer-port 4673 --live-bind 127.0.0.1:5523 --web-bind 127.0.0.1:5511`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4673/?ws=ws://127.0.0.1:5511&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh console error`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - `run-game-test.sh` 的就绪探针仍会触发 `viewer web bridge error: WebSocket(Protocol(HandshakeIncomplete))`，在 T3 处理。

- 时刻：2026-02-26 15:27:54 CST
- 完成内容：完成 T2（wasm + Player 默认可推进）。
  - 更新 `crates/agent_world_viewer/src/headless.rs`：`headless_auto_play_once` 支持读取 `ViewerExperienceMode`，在 wasm 且 Player 模式下默认自动发送一次 `ViewerControl::Play`（未显式设置 `AGENT_WORLD_VIEWER_AUTO_PLAY` 时）。
  - 更新 `crates/agent_world_viewer/src/app_bootstrap.rs`：Player 默认右侧面板从隐藏改为显示；`show_controls` 默认改为 `true`，确保首次进入可见控制入口。
  - 同步更新 `app_bootstrap` 默认值相关测试断言。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `./scripts/run-game-test.sh --viewer-port 4773 --live-bind 127.0.0.1:5623 --web-bind 127.0.0.1:5611`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4773/?ws=ws://127.0.0.1:5611&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - 启动脚本 WS 就绪探针仍会触发 `viewer web bridge error: WebSocket(Protocol(HandshakeIncomplete))`，需在 T3 处理。

- 时刻：2026-02-26 15:40:36 CST
- 完成内容：完成 T3（修复 `run-game-test.sh` 的 WS 就绪探针，消除握手污染日志）。
  - 更新 `scripts/run-game-test.sh`：将 `wait_for_tcp_ready`（`/dev/tcp` 主动连接）替换为 `wait_for_tcp_listener_ready`（`lsof/ss` 被动监听探针），避免对 WS 端口发送非握手流量。
  - 保留无 `lsof/ss` 场景下的兼容告警，不阻塞脚本主流程。
- 测试：
  - `bash -n scripts/run-game-test.sh`
  - `rg -n "wait_for_tcp_listener_ready|wait_for_tcp_ready|/dev/tcp" scripts/run-game-test.sh`
  - `timeout 240s ./scripts/run-game-test.sh --viewer-port 4873 --live-bind 127.0.0.1:5723 --web-bind 127.0.0.1:5711 | tee /tmp/t3-run-game-test.out`
  - `rg -n "HandshakeIncomplete|viewer web bridge error|opening handshake timed out" output/playwright/playability/startup-20260226-153708/world_viewer_live.log`
  - `tail -n 40 output/playwright/playability/startup-20260226-153708/world_viewer_live.log`
  - `ps -ef | rg 'world_viewer_live llm_bootstrap|run-viewer-web.sh --address 127.0.0.1 --port 4873|run-game-test.sh --viewer-port 4873' | rg -v rg`
- 遗留事项：
  - 继续执行 T4 回归验证并收尾文档。
