# 2026-02-26

- 时刻：2026-02-26 11:03:15 CST
- 完成内容：完成“Playwright 使用手册启动防抖与失败分级补充”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：新增启动前自检（端口监听、主页可达、URL 引号约束）、会话防抖与启动失败分级处置（`ERR_CONNECTION_REFUSED` / 渲染 panic / `connecting+tick=0` / URL `source` 解析错误）。
  - 更新 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T12，回写最近更新日期为 2026-02-26。
- 测试：
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/testing/systematic-application-testing-manual.project.md`
  - `rg -n "启动前自检|Fail Fast|ERR_CONNECTION_REFUSED|copy_deferred_lighting_id_pipeline|URL='http://" doc/testing/web-ui-playwright-closure-manual.md`
  - `rg -n "T12|最近更新：2026-02-26" doc/testing/systematic-application-testing-manual.project.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:17:37 CST
- 完成内容：完成“Playwright 手册路径口径与工程实际对齐”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：Playwright 示例改为仓库内 `.codex` 路径（`$REPO_ROOT/.codex/skills/playwright/scripts/playwright_cli.sh`），移除 `CODEX_HOME` 依赖。
  - 更新 `doc/viewer-manual.md`：同步改为仓库内 `.codex` 路径，并新增 wrapper 存在性检查。
  - 更新项目管理文档 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T13。
- 测试：
  - `rg -n "CODEX_HOME|REPO_ROOT|\.codex/skills/playwright/scripts/playwright_cli\.sh" doc/testing/web-ui-playwright-closure-manual.md doc/viewer-manual.md`
  - `rg -n "T13" doc/testing/systematic-application-testing-manual.project.md`
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/viewer-manual.md doc/testing/systematic-application-testing-manual.project.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:28:18 CST
- 完成内容：完成“Web 验收 GPU + headed 硬门禁命令补充”文档任务。
  - 更新 `doc/testing/web-ui-playwright-closure-manual.md`：新增 `2.2) GPU + headed 硬门禁（验收必须）`，包含 `open "$URL" --headed` 与 `SwiftShader/software rendering` 关键字 fail-fast 判定命令。
  - 更新 `doc/testing/systematic-application-testing-manual.project.md`：新增并完成 T14。
- 测试：
  - `rg -n "GPU \+ headed|open \"\$URL\" --headed|SwiftShader|software rendering|Failed to create WebGPU Context Provider" doc/testing/web-ui-playwright-closure-manual.md`
  - `rg -n "T14" doc/testing/systematic-application-testing-manual.project.md`
  - `wc -l doc/testing/web-ui-playwright-closure-manual.md doc/testing/systematic-application-testing-manual.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 11:54:13 CST
- 完成内容：按 `doc/game-test.md` 执行一轮“真实玩家”Playwright Web 闭环试玩并填写卡片。
  - 启动链路：`world_viewer_live` + `run-viewer-web.sh --address 127.0.0.1 --port 4173`。
  - 使用 Playwright headed + `video-start/video-stop` 完成实操，产物落盘到 `output/playwright/playability/20260226-114106/`（含 `playthrough.webm`、截图、控制台日志）。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_11_41_06.md`。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T8，补充本轮测试记录与风险。
- 测试：
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4173/?ws=ws://127.0.0.1:5010&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh eval "() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)"`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh eval "() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(10) ?? null); } catch (e) { return String(e); } }"`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-114106 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `wc -l doc/playability_test_result/card_2026_02_26_11_41_06.md doc/game-test.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 本轮仍复现 `connectionStatus=connecting` + `tick=0`，并伴随 `WebSocket opening handshake timed out` 与 wasm panic（`assertion failed: old_size > 0`），可玩性闭环未恢复。

- 时刻：2026-02-26 13:04:19 CST
- 完成内容：完成“game-test 一键启动脚本 + 手册补充”任务，降低玩家测试因手工参数错误导致的假故障。
  - 新增 `scripts/run-game-test.sh`：固化推荐启动参数（含 `--web-bind`），并内置端口冲突 fail-fast、HTTP/WS 就绪检查、日志目录输出、`Ctrl+C` 自动清理。
  - 更新 `doc/game-test.md`：新增“一键启动（避免参数错误）”与 Playwright 进入游戏示例。
  - 更新 `doc/game-test.project.md`：新增并完成 T9，补充新脚本依赖与风险缓解说明。
- 测试：
  - `bash -n scripts/run-game-test.sh`
  - `./scripts/run-game-test.sh --help`
  - `timeout 45s ./scripts/run-game-test.sh`（验证端口占用 fail-fast，报错 `port 4173 is already in use`）
  - `timeout 120s ./scripts/run-game-test.sh --viewer-port 4373 --live-bind 127.0.0.1:5223 --web-bind 127.0.0.1:5211`（验证 ready 输出 URL 与超时终止后自动清理）
  - `ps -ef | rg 'world_viewer_live|run-viewer-web.sh|trunk serve --address 127.0.0.1 --port 4373' | rg -v rg || true`
  - `ss -ltn | rg '4373|5211|5223' || true`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 13:15:46 CST
- 完成内容：按用户请求基于 `doc/game-test.md` 再执行一轮“真实玩家”Playwright 闭环游玩并填写卡片。
  - 使用 `./scripts/run-game-test.sh --viewer-port 4473 --live-bind 127.0.0.1:5323 --web-bind 127.0.0.1:5311` 启动链路，完成 headed + 录屏实操。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_13_10_04.md`。
  - 产物落盘：`output/playwright/playability/20260226-131004/`（含 `playthrough.webm`、前后截图、控制台日志、启动日志）。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T10，补充本轮测试记录与风险。
- 测试：
  - `command -v npx >/dev/null 2>&1; echo $?`
  - `./scripts/run-game-test.sh --viewer-port 4473 --live-bind 127.0.0.1:5323 --web-bind 127.0.0.1:5311`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4473/?ws=ws://127.0.0.1:5311&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh snapshot`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press KeyW`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press KeyA`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh press Space`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { window.__AW_TEST__?.setMode?.("3d"); return "ok"; } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-131004 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
  - `ps -ef | rg 'world_viewer_live|run-viewer-web.sh|trunk serve --address 127.0.0.1 --port 4473' | rg -v rg || true`
  - `ss -ltn | rg '4473|5311|5323' || true`
  - `wc -l doc/playability_test_result/card_2026_02_26_13_10_04.md doc/game-test.project.md doc/devlog/2026-02-26.md`
- 遗留事项：
  - 本轮在 `connectionStatus=connected` 下仍出现 `tick=0` 不推进；`runSteps(20)` 会触发 `RuntimeError: unreachable` 与 wasm panic（`assertion failed: old_size > 0`），可玩性闭环仍未恢复。

- 时刻：2026-02-26 14:32:33 CST
- 完成内容：完成“viewer-web-playability-unblock-2026-02-26”文档建档任务。
  - 新增设计文档：`doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`。
  - 在项目文档中新增并完成 T0，后续进入 T1（web_test_api 入参契约修复）。
- 测试：
  - `wc -l doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`
  - `rg -n "目标|范围|接口/数据|里程碑|风险" doc/world-simulator/viewer-web-playability-unblock-2026-02-26.md`
  - `rg -n "T0|T1|任务拆解|依赖|状态" doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`
- 遗留事项：
  - 按项目文档继续完成 T1~T4。

- 时刻：2026-02-26 15:06:59 CST
- 完成内容：完成 T1（web_test_api 入参契约修复，消除类型不匹配 panic）。
  - 更新 `crates/agent_world_viewer/src/web_test_api.rs`：
    - `runSteps/setMode/focus/select/sendControl` 统一改为 `JsValue` 入参解析，避免 `FnMut(String)` 在错误类型输入下触发 wasm `unreachable`。
    - `runSteps` 新增 number / `{count}` 兼容，映射为 `ViewerControl::Step { count }`；保留 string DSL 自动化步骤能力。
    - `sendControl` 对 action 非字符串场景改为稳定告警，不再潜在 panic。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `./scripts/run-game-test.sh --viewer-port 4673 --live-bind 127.0.0.1:5523 --web-bind 127.0.0.1:5511`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4673/?ws=ws://127.0.0.1:5511&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh console error`
  - `PLAYWRIGHT_CLI_SESSION=verify-t1-20260226-1500 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - `run-game-test.sh` 的就绪探针仍会触发 `viewer web bridge error: WebSocket(Protocol(HandshakeIncomplete))`，在 T3 处理。

- 时刻：2026-02-26 15:27:54 CST
- 完成内容：完成 T2（wasm + Player 默认可推进）。
  - 更新 `crates/agent_world_viewer/src/headless.rs`：`headless_auto_play_once` 支持读取 `ViewerExperienceMode`，在 wasm 且 Player 模式下默认自动发送一次 `ViewerControl::Play`（未显式设置 `AGENT_WORLD_VIEWER_AUTO_PLAY` 时）。
  - 更新 `crates/agent_world_viewer/src/app_bootstrap.rs`：Player 默认右侧面板从隐藏改为显示；`show_controls` 默认改为 `true`，确保首次进入可见控制入口。
  - 同步更新 `app_bootstrap` 默认值相关测试断言。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `./scripts/run-game-test.sh --viewer-port 4773 --live-bind 127.0.0.1:5623 --web-bind 127.0.0.1:5611`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:4773/?ws=ws://127.0.0.1:5611&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=verify-t2-autoplay-20260226-1523 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - 启动脚本 WS 就绪探针仍会触发 `viewer web bridge error: WebSocket(Protocol(HandshakeIncomplete))`，需在 T3 处理。

- 时刻：2026-02-26 15:40:36 CST
- 完成内容：完成 T3（修复 `run-game-test.sh` 的 WS 就绪探针，消除握手污染日志）。
  - 更新 `scripts/run-game-test.sh`：将 `wait_for_tcp_ready`（`/dev/tcp` 主动连接）替换为 `wait_for_tcp_listener_ready`（`lsof/ss` 被动监听探针），避免对 WS 端口发送非握手流量。
  - 保留无 `lsof/ss` 场景下的兼容告警，不阻塞脚本主流程。
- 测试：
  - `bash -n scripts/run-game-test.sh`
  - `rg -n "wait_for_tcp_listener_ready|wait_for_tcp_ready|/dev/tcp" scripts/run-game-test.sh`
  - `timeout 240s ./scripts/run-game-test.sh --viewer-port 4873 --live-bind 127.0.0.1:5723 --web-bind 127.0.0.1:5711 | tee /tmp/t3-run-game-test.out`
  - `rg -n "HandshakeIncomplete|viewer web bridge error|opening handshake timed out" output/playwright/playability/startup-20260226-153708/world_viewer_live.log`
  - `tail -n 40 output/playwright/playability/startup-20260226-153708/world_viewer_live.log`
  - `ps -ef | rg 'world_viewer_live llm_bootstrap|run-viewer-web.sh --address 127.0.0.1 --port 4873|run-game-test.sh --viewer-port 4873' | rg -v rg`
- 遗留事项：
  - 继续执行 T4 回归验证并收尾文档。

- 时刻：2026-02-26 15:59:21 CST
- 完成内容：完成 T4（回归验证与文档收尾）。
  - 执行 `agent_world_viewer` native/wasm 回归检查，确认构建与类型检查通过。
  - 使用 `run-game-test.sh` + Playwright 冒烟验证：
    - `connectionStatus=connected` 且 `tick` 从 `100` 增长到 `206`（默认自动推进生效）。
    - `runSteps(20)` 返回 `"null"`，未复现 `RuntimeError: unreachable` / `assertion failed: old_size > 0`。
    - 启动日志未再出现 `HandshakeIncomplete`。
  - 回写 `doc/world-simulator/viewer-web-playability-unblock-2026-02-26.project.md`，将 T4 标记完成并收敛状态为“已完成（T0~T4）”。
- 测试：
  - `command -v npx >/dev/null 2>&1; echo $?`
  - `bash -n scripts/run-game-test.sh`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `timeout 300s ./scripts/run-game-test.sh --viewer-port 5073 --live-bind 127.0.0.1:5923 --web-bind 127.0.0.1:5911 | tee /tmp/t4-run-game-test.out`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:5073/?ws=ws://127.0.0.1:5911&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `sleep 3; PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `rg -n "RuntimeError: unreachable|assertion failed: old_size > 0|HandshakeIncomplete|WebSocket opening handshake timed out" .playwright-cli/console-2026-02-26T07-53-55-416Z.log`
  - `rg -n "HandshakeIncomplete|viewer web bridge error|opening handshake timed out" output/playwright/playability/startup-20260226-155119/world_viewer_live.log`
  - `PLAYWRIGHT_CLI_SESSION=t4-smoke-20260226-1551 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - 仍可见 trunk 热更新通道的 `ERR_CONNECTION_REFUSED` 控制台噪声（不影响当前游玩闭环），后续如需可单独治理。

- 时刻：2026-02-26 21:21:12 CST
- 完成内容：完成主链 Token 分配机制 TAM-5（参数治理边界 + 生效延迟 + 提案审计事件）。
  - 在 runtime 主链 token 流程新增治理动作与审计事件：
    - `Action::UpdateMainTokenPolicy`
    - `DomainEvent::MainTokenPolicyUpdateScheduled`
  - 新增主链 token 参数边界校验与延迟生效调度状态：
    - `MainTokenScheduledPolicyUpdate`
    - `validate_main_token_config_bounds`
    - `WorldState.main_token_scheduled_policy_updates`
  - 将 epoch 增发与 fee 结算改为按“对应 epoch 的有效配置”解析，支持策略延迟生效后的确定性回放。
  - 补充 `runtime::tests::main_token` 用例，覆盖：
    - 策略更新审计事件与延迟生效；
    - 越界参数更新拒绝。
  - 回写项目管理文档 `doc/p2p/mainchain-token-allocation-mechanism.project.md`，将 TAM-5 标记完成并推进到 TAM-6。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::main_token:: -- --nocapture`
- 遗留事项：
  - 继续执行 TAM-6：NodePoints -> 主链 Token 桥接占位接口并接入结算路径。

- 时刻：2026-02-26 21:38:53 CST
- 完成内容：完成主链 Token 分配机制 TAM-6（NodePoints -> 主链 Token 桥接占位接口并接入结算路径）。
  - 扩展 `DomainEvent::NodePointsSettlementApplied`，新增主链 token 桥接审计字段：
    - `main_token_bridge_total_amount`
    - `main_token_bridge_distributions`
  - 在 `event_processing` 中接入桥接预算与分配计算：
    - 以同 epoch 的 `MainTokenEpochIssuanceRecord.node_service_reward_amount` 作为桥接预算上限；
    - 从 `MAIN_TOKEN_TREASURY_BUCKET_NODE_SERVICE_REWARD` 校验可用余额；
    - 按结算 `awarded_points` 比例做确定性分配（含余数确定性分配）。
  - 在 `WorldState` 结算应用路径落地桥接执行：
    - 扣减 `node_service_reward_pool`；
    - 入账节点主链 token 液态余额；
    - 增加主链 `circulating_supply`；
    - 记录 `main_token_node_points_bridge_records`（epoch 级审计）。
  - 新增资源查询接口：
    - `main_token_node_points_bridge_record(epoch_index)`
  - 新增/更新测试：
    - `reward_asset_settlement_action_applies_signed_records_via_step` 覆盖桥接执行与审计字段；
    - 新增 `reward_asset_settlement_action_rejects_when_main_token_bridge_treasury_insufficient` 覆盖余额不足拒绝。
  - 回写项目管理文档 `doc/p2p/mainchain-token-allocation-mechanism.project.md`，将 TAM-6 标记完成并推进到 TAM-7。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::reward_asset_settlement_action:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::main_token:: -- --nocapture`
- 遗留事项：
  - 继续执行 TAM-7：补齐 `test_tier_required` / `test_tier_full` 测试矩阵与回归脚本。

- 时刻：2026-02-26 16:33:16 CST
- 完成内容：按用户请求基于 `doc/game-test.md` 执行一轮“真实玩家”Playwright 闭环游玩并填写卡片。
  - 使用 `./scripts/run-game-test.sh --viewer-port 5273 --live-bind 127.0.0.1:6023 --web-bind 127.0.0.1:6011` 启动链路，完成 headed + 录屏实操。
  - 新增并填写卡片：`doc/playability_test_result/card_2026_02_26_16_27_06.md`。
  - 产物落盘：`output/playwright/playability/20260226-162706/`（含 `playthrough.webm`、前后截图、控制台日志、启动日志）。
  - 回写项目管理文档：`doc/game-test.project.md` 新增并完成 T11，补充本轮测试记录与状态。
- 测试：
  - `command -v npx >/dev/null 2>&1; echo $?`
  - `./scripts/run-game-test.sh --viewer-port 5273 --live-bind 127.0.0.1:6023 --web-bind 127.0.0.1:6011`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:5273/?ws=ws://127.0.0.1:6011&test_api=1" --headed`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh video-start`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => JSON.stringify(window.__AW_TEST__?.getState?.() ?? null)'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh eval '() => { try { return JSON.stringify(window.__AW_TEST__?.runSteps?.(20) ?? null); } catch (e) { return String(e); } }'`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh video-stop`
  - `PLAYWRIGHT_CLI_SESSION=playability-20260226-162706 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
  - `ps -ef | rg 'world_viewer_live llm_bootstrap|run-viewer-web.sh --address 127.0.0.1 --port 5273|run-game-test.sh --viewer-port 5273' | rg -v rg || true`
  - `ss -ltn | rg '5273|6011|6023' || true`
- 遗留事项：
  - 本轮主链路可玩（`connected` + `tick` 增长 + `runSteps` 正常）；后续可优化玩家引导与 `sendControl` 入参提示，减少“输入被忽略”的困惑感。
- 时刻：2026-02-26 10:57:37 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T0 建档。
  - 新建设计文档：`doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.md`
  - 新建项目管理文档：`doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.project.md`
  - 任务拆解覆盖 P0-01~P0-08，明确 P0-03 口径为“移除峰谷，纯供需定价”。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：冻结 M4.4 供需电价模型定义并回写相关文档。

- 时刻：2026-02-26 11:08:46 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T1（P0-01）。
  - 在 `doc/world-simulator/m4/m4-power-system.md` 冻结 M4.4 纯供需定价模型公式。
  - 回写 `doc/world-simulator/m4/m4-power-system.project.md`，明确移除峰谷时段机制并纳入 required/full 测试口径。
  - 更新 `doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.project.md` 状态为 T2 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T2：实现动态电价并去除峰谷时段机制。

- 时刻：2026-02-26 11:21:44 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T2（P0-02/P0-03）。
  - 修改 `crates/agent_world/src/simulator/kernel/actions_impl_part2.rs`，将电价报价改为纯供需压力模型：`(requested/available - 1)`，并移除距离溢价参与。
  - 保留传输损耗/跨地点传输距离约束，仅移除其对“价格”的影响。
  - 更新 `crates/agent_world/src/simulator/tests/power.rs` 动态报价断言以匹配新口径。
  - 回写 `doc/world-simulator/m4/m4-power-system.project.md` 与闭环收口项目文档状态，推进至 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::power::power_buy_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::power::power_buy_zero_price_uses_dynamic_market_quote`
- 遗留事项：
  - 执行 T3：补齐电价/市场机制测试并纳入 test_tier_required/full。

- 时刻：2026-02-26 11:45:17 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T3（P0-04）。
  - 在 `crates/agent_world/src/simulator/tests/power.rs` 新增纯供需口径回归测试：
    - `power_buy_zero_price_equal_supply_keeps_base_price`
    - `power_order_keeps_open_when_quote_below_sell_limit`
  - 更新 `testing-manual.md`，补充电价/市场机制在 `test_tier_required/full` 的定向回归命令。
  - 回写 `doc/world-simulator/m4/m4-power-system.project.md` 与闭环收口项目文档状态，推进至 T4。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power::power_buy_zero_price_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power::power_order_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full simulator::tests::power:: -- --nocapture`
- 遗留事项：
  - 执行 T4：完成硬件生产/维护/折旧/回收闭环。

- 时刻：2026-02-26 12:04:56 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T4（P0-05）。
  - 在 runtime 经济链路新增工厂硬件闭环：
    - `Action::MaintainFactory` / `Action::RecycleFactory`
    - `DomainEvent::FactoryDurabilityChanged` / `FactoryMaintained` / `FactoryRecycled`
    - `FactoryState.durability_ppm` 持久化字段（默认 1,000,000）
  - 在 `step` 前置执行工厂折旧事件生成（按 `maintenance_per_tick` 衰减耐久），并在状态应用阶段落实维护消耗与回收返还。
  - 新增测试文件 `crates/agent_world/src/runtime/tests/economy_factory_lifecycle.rs`，补齐折旧/维护/回收/回收拒绝（有活跃配方）闭环测试。
  - 更新闭环项目管理文档状态到 T5。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy_factory_lifecycle:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy::build_factory_consumes_materials_and_completes_after_delay -- --nocapture`
- 遗留事项：
  - 执行 T5：完成数据获取/存储/交易/访问控制闭环。

- 时刻：2026-02-26 12:24:49 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T5（P0-06）。
  - 在 runtime 新增数据闭环动作与事件：
    - `Action::CollectData` / `GrantDataAccess` / `RevokeDataAccess`
    - `DomainEvent::DataCollected` / `DataAccessGranted` / `DataAccessRevoked`
  - 新增 `WorldState.data_access_permissions` 授权状态，并实现 `has_data_access_permission` 判定。
  - 在 `action_to_event_economy` 中落地：
    - 数据采集（耗电增数）
    - Data 资源转移授权校验（无授权拒绝跨 Agent Data 转移）
  - 在 `action_to_event_policy_contract` 中落地：
    - Data 合约成功结算前授权校验（无授权拒绝结算）
  - 新增测试 `crates/agent_world/src/runtime/tests/data_access_control.rs`，覆盖采集、转移授权、合约授权拒绝/成功路径。
  - 更新既有受影响测试（Data transfer overflow、Data contract settlement）以显式授予访问权限。
  - 回写闭环项目管理文档状态推进至 T6。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world data_access_control -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world emit_resource_transfer_overflow_keeps_balances_atomic -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world economic_contract_settlement_overflow_keeps_state_atomic -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world economic_contract_settlement_applies_tax_and_reputation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world economic_contract_success_reputation_reward_respects_stake_and_cap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::data_access_control:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full runtime::tests::data_access_control:: -- --nocapture`
- 遗留事项：
  - 执行 T6：完成合约任务与声誉系统反通胀/防刷策略收口。

- 时刻：2026-02-26 12:35:50 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T6（P0-07）。
  - 在合约结算链路新增反刷策略：
    - pair 级冷却：同一 pair 在冷却窗口内重复成功结算会被拒绝。
    - 声誉窗口上限：按主体维度统计窗口累计奖励，超过上限后窗口内奖励衰减到 0。
  - 在 `WorldState` 新增持久化状态：
    - `contract_pair_last_success_settled_at`
    - `reputation_reward_window_started_at`
    - `reputation_reward_window_accumulated`
  - 在 `action_to_event_policy_contract` 中接入冷却和窗口预算计算，按预算裁剪 `creator/counterparty` 声誉增量。
  - 在 `apply_domain_event_gameplay` 中对成功结算写回 pair 成功时间与窗口累计，形成状态闭环。
  - 在 `crates/agent_world/src/runtime/tests/gameplay_protocol_split_part2.rs` 新增回归：
    - `economic_contract_pair_cooldown_rejects_repeated_success_settlement`
    - `economic_contract_reputation_window_cap_decays_reward_to_zero_then_recovers`
  - 回写闭环项目管理文档状态推进至 T7。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::gameplay_protocol::economic_contract_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full runtime::tests::gameplay_protocol::economic_contract_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::data_access_control:: -- --nocapture`
- 遗留事项：
  - 执行 T7：完成禁区/配额/税费/电费治理最小规则。

- 时刻：2026-02-26 12:44:28 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T7（P0-08）。
  - 扩展治理策略最小字段：
    - `GameplayPolicyState.power_trade_fee_bps`
    - `GameplayPolicyState.forbidden_location_ids`
  - 扩展治理动作/事件 `UpdateGameplayPolicy` / `GameplayPolicyUpdated` 载荷，新增上述字段并在策略更新链路做归一化与上限校验。
  - 在 `MoveAgent` 路径接入禁区校验（按目标坐标映射 location key，命中 `forbidden_location_ids` 则拒绝）。
  - 在经济合约 `Electricity` 成功结算中叠加“电费 + 电力税”：
    - 计算口径：`electricity_tax_bps + power_trade_fee_bps`（上限钳制到 10000 bps）。
  - 新增治理回归测试：
    - `move_agent_is_denied_when_target_location_is_forbidden`
    - `economic_contract_electricity_settlement_applies_power_trade_fee_and_tax`
  - 回写闭环项目管理文档状态推进至 T8。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::gameplay_protocol:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 执行 T8：回归与收口（文档、devlog、测试）。

- 时刻：2026-02-26 12:50:23 CST
- 完成内容：完成“M4 市场/硬件/数据/治理闭环收口”T8（回归与收口）。
  - 对 T0~T7 交付内容执行收口检查，确认项目管理文档任务已全部完成。
  - 更新 `doc/world-simulator/m4/m4-market-hardware-data-governance-closure-2026-02-26.project.md` 状态为“已完成”。
  - 当日 devlog 收口，归档本轮 P0-01~P0-08 实施与测试轨迹。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - 本轮 T5/T6/T7 提交钩子均已完成 required 回归链路：
    - `agent_world --tests --features test_tier_required`
    - `agent_world_consensus --lib`
    - `agent_world_distfs --lib`
    - `agent_world_viewer`
    - `agent_world_viewer --target wasm32-unknown-unknown` 检查
- 遗留事项：
  - 无（本轮闭环任务全部完成）。

- 时刻：2026-02-26 13:20:00 CST
- 完成内容：完成“M4 工业模块文档口径校正”任务（仅文档）。
  - 修正 `doc/world-simulator/m4/m4-industrial-economy-wasm.project.md` 中旧 crate 名：`agent_world_builtin_wasm` -> `agent_world_builtin_wasm_modules`。
  - 同步将 E6 校验命令修正为当前流程命令：`./scripts/sync-m4-builtin-wasm-artifacts.sh --check`。
  - 更新项目文档状态“最近更新”为本次口径修正记录（2026-02-26）。
- 测试：
  - 文档一致性校验：`rg -n "agent_world_builtin_wasm\\b" doc/world-simulator/m4/*.md`
- 遗留事项：
  - 输出“模块模板化抽象（2）”与“bootstrap 清单驱动化（3）”设计方案（本轮不提交代码）。

- 时刻：2026-02-26 13:38:32 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T0 建档。
  - 新建设计文档：`doc/world-simulator/m4/m4-builtin-wasm-maintainability-2026-02-26.md`。
  - 新建项目管理文档：`doc/world-simulator/m4/m4-builtin-wasm-maintainability-2026-02-26.project.md`。
  - 任务拆解为 T1（模块模板化）与 T2（bootstrap 清单驱动化）两项代码任务。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：完成 M4 Recipe/Product/Factory 模块模板化抽象。

- 时刻：2026-02-26 14:11:54 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T1（模块模板化抽象）。
  - 新增模板目录与三类共享模板：
    - `crates/agent_world_builtin_wasm_modules/_templates/m4_recipe_module_template.rs`
    - `crates/agent_world_builtin_wasm_modules/_templates/m4_product_module_template.rs`
    - `crates/agent_world_builtin_wasm_modules/_templates/m4_factory_module_template.rs`
  - 将 13 个 M4 模块 `src/lib.rs` 重构为“常量参数 + include 模板实现”，去除重复逻辑。
  - 同步刷新 M4 工件清单：
    - `crates/agent_world/src/runtime/world/artifacts/m4_builtin_modules.sha256`
    - `crates/agent_world/src/runtime/world/artifacts/m4_builtin_modules.identity.json`
  - 回写项目管理文档状态推进至 T2。
- 测试：
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh`
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime,test_tier_full runtime::tests::economy_bootstrap:: -- --nocapture`
- 遗留事项：
  - 执行 T2：完成 bootstrap 清单驱动化与一致性护栏测试。

- 时刻：2026-02-26 14:24:12 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T2（bootstrap 清单驱动化）。
  - 重构 `crates/agent_world/src/runtime/world/bootstrap_economy.rs`：
    - 引入 `M4BootstrapModuleDescriptor` 与 `M4_BOOTSTRAP_MODULES` 描述符清单。
    - `install_m4_economy_bootstrap_modules` 改为按描述符循环安装，不再手工逐项 `ensure_bootstrap_module`。
    - 新增一致性护栏：描述符 `module_id` 列表必须与 `world/artifacts/m4_builtin_module_ids.txt` 一致，否则返回 `ModuleChangeInvalid`。
  - 精简 manifest 生成路径，统一由描述符驱动 `module_id/name/max_call_rate`。
  - 新增测试接线：`m4_builtin_module_ids_manifest_matches_runtime_constants` 额外校验 `m4_bootstrap_module_ids()` 与常量清单一致。
  - 回写项目管理文档状态推进至 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime,test_tier_full runtime::tests::economy_bootstrap:: -- --nocapture`
- 遗留事项：
  - 执行 T3：回归收口并完成本轮任务关闭。

- 时刻：2026-02-26 15:03:02 CST
- 完成内容：完成“M4 内置 WASM 模块可维护性收口”T3（回归与收口）。
  - 确认 T0~T2 任务全部完成，项目管理文档状态更新为“已完成”。
  - 汇总本轮变更：
    - M4 模块入口模板化抽象（Recipe/Product/Factory）。
    - M4 bootstrap 改为描述符清单驱动，并新增描述符/清单一致性护栏。
- 测试：
  - T1 定向：`./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
  - T1/T2 定向：`env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime,test_tier_full runtime::tests::economy_bootstrap:: -- --nocapture`
  - 本次提交钩子 required 回归链路（agent_world/consensus/distfs/viewer/wasm check）通过。
- 遗留事项：
  - 无。
- 时刻：2026-02-26 11:07:53 CST
- 完成内容：完成“GitHub Pages 首页激进改造（2026-02-26）”T0（建档与基线）。
  - 新增设计文档：`doc/site/github-pages-home-radical-redesign-2026-02-26.md`。
  - 新增项目管理文档：`doc/site/github-pages-home-radical-redesign-2026-02-26.project.md`。
  - 项目管理文档标记任务 0 完成，并更新下一步为任务 1（实现阶段）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T1：完成首页 CN/EN 与共享样式的激进改造实现。

- 时刻：2026-02-26 11:37:28 CST
- 完成内容：完成“GitHub Pages 首页激进改造（2026-02-26）”T1（首页与样式实现）。
  - 视觉系统重写：`site/assets/styles.css`
    - 更换首页视觉语言为高对比赛博战术风，重做字体体系、色板、栅格、卡片层次、移动断点与动效节奏。
    - 保留文档中心页面依赖样式（`docs-*`、导航、按钮、基础排版）以维持站点整体可用。
  - 首页重写：`site/index.html`、`site/en/index.html`
    - 以“游戏战场叙事”重写 Hero 与中段内容，强化玩家决策与冲突感；引擎内容继续后置于 `#architecture`。
    - 保持 CN/EN 同构（同 section 顺序、同锚点、同 proof switcher 数据标记）。
    - 保持 `site/assets/app.js` 依赖的 `data-*` 与 section `id` 兼容。
  - 项目管理文档回写：`doc/site/github-pages-home-radical-redesign-2026-02-26.project.md` 标记任务 1 完成。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T2：完成验证收口与项目状态结项。

- 时刻：2026-02-26 11:47:10 CST
- 完成内容：完成“GitHub Pages 首页激进改造（2026-02-26）”T2（验证与收口）。
  - 执行收口校验：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`，结果通过。
  - 回写项目管理文档：`doc/site/github-pages-home-radical-redesign-2026-02-26.project.md`，标记任务 2 完成并更新整体状态为“已完成”。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 12:05:15 CST
- 完成内容：完成“GitHub Pages 首屏 CTA 收敛与文案校准（2026-02-26）”T0（建档与范围确认）。
  - 新增设计文档：`doc/site/github-pages-hero-cta-simplify-2026-02-26.md`。
  - 新增项目管理文档：`doc/site/github-pages-hero-cta-simplify-2026-02-26.project.md`。
  - 项目管理文档标记任务 0 完成，并更新下一步为任务 1（实现阶段）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T1：完成 CN/EN 首屏 CTA 收敛与主按钮文案重写。

- 时刻：2026-02-26 12:08:00 CST
- 完成内容：完成“GitHub Pages 首屏 CTA 收敛与文案校准（2026-02-26）”T1（实现与收口）。
  - 首页 Hero CTA 收敛：
    - `site/index.html`：首屏 CTA 从 4 个收敛为 2 个（主按钮 + 文档按钮）。
    - `site/en/index.html`：同步收敛为 2 个（保持中英文同构）。
  - 主按钮文案重写：
    - 中文由“30 秒进入首局”改为“试玩 / 观看演示”。
    - 英文由 “Enter a Match in 30 Seconds” 改为 “Try or Watch Demo”。
  - 项目管理文档回写：`doc/site/github-pages-hero-cta-simplify-2026-02-26.project.md` 标记任务 1 完成并结项。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 13:17:59 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T0（建档与基线）。
  - 新增设计文档：`doc/site/github-pages-home-conversion-i18n-screenshot-refresh-2026-02-26.md`。
  - 新增项目管理文档：`doc/site/github-pages-home-conversion-i18n-screenshot-refresh-2026-02-26.project.md`。
  - 项目管理文档标记任务 0 完成，下一步进入任务 1（首屏转化文案收敛）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T1：完成首页首屏转化文案收敛与中英一致性校准。

- 时刻：2026-02-26 13:23:24 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T1（首屏转化文案收敛）。
  - 更新 `site/index.html`：首屏与上手区文案改为“本地 3 步”真实门槛口径，补充首次构建耗时说明。
  - 更新 `site/en/index.html`：同步改为 `Local 3-Step` 口径，并补充首次构建说明。
  - 保持 section 锚点与 `data-*` 兼容，完成本地页面快检。
  - 回写项目管理文档：标记任务 1 完成。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T2：继续完成中英文一致性校准。

- 时刻：2026-02-26 13:25:37 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T2（中英文一致性校准）。
  - 更新 `site/index.html`：导航入口 `#demo` 文案由“立即开局”统一为“本地 3 步”。
  - 更新 `site/en/index.html`：导航入口 `#demo` 文案由 “Start Fast” 统一为 “3-Step Setup”。
  - 回写项目管理文档：标记任务 2 完成，下一步进入任务 3（截图刷新）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T3：按 Web 闭环重新采集并替换三张场景截图。

- 时刻：2026-02-26 13:52:12 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T3（游戏 UI 截图刷新）。
  - 先按 S6 执行 Web 闭环截图尝试（`run-viewer-web.sh + Playwright`），发现浏览器侧触发 `wgpu` pipeline panic（`copy_deferred_lighting_id_pipeline`），`__AW_TEST__.getState().connectionStatus` 持续 `connecting`，无法形成有效 Web 截图。
  - 按约定切换 fallback：使用 native 抓图链路（等价 `capture-viewer-frame` 过程，显式 `world_viewer_live --no-llm`）完成三场景抓图并保留证据：
    - `output/playwright/viewer/home-refresh-20260226-native/minimal/`
    - `output/playwright/viewer/home-refresh-20260226-native/twin_region_bootstrap/`
    - `output/playwright/viewer/home-refresh-20260226-native/triad_region_bootstrap/`
  - 已更新站点截图素材：
    - `site/assets/images/screenshots/minimal.webp`
    - `site/assets/images/screenshots/twin_region_bootstrap.webp`
    - `site/assets/images/screenshots/triad_region_bootstrap.webp`
- 测试：
  - test_tier_required（Web 闭环尝试）：`env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173` + Playwright `open/snapshot/eval(__AW_TEST__)`（记录失败证据）。
  - test_tier_required（fallback 闭环）：native 三场景抓图流程（`world_viewer_live --no-llm` + `agent_world_viewer` + `Xvfb/ffmpeg`）通过。
  - 产物校验：`ffprobe` 校验三张目标图均为 `2400x1600`、`yuv420p`。
- 遗留事项：
  - 执行 T4：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`，并完成项目文档收口。

- 时刻：2026-02-26 13:54:47 CST
- 完成内容：完成“GitHub Pages 首页转化文案与中英一致性收敛 + UI 截图刷新（2026-02-26）”T4（验证与收口）。
  - 执行并通过：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`。
  - 回写项目管理文档：`doc/site/github-pages-home-conversion-i18n-screenshot-refresh-2026-02-26.project.md`，标记任务 4 完成并更新整体状态为“已完成”。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 15:52:18 CST
- 完成内容：完成“GitHub Pages 用户视角问题修复（2026-02-26）”T0（建档与任务拆解）。
  - 新增设计文档：`doc/site/github-pages-user-perspective-fixes-2026-02-26.md`。
  - 新增项目管理文档：`doc/site/github-pages-user-perspective-fixes-2026-02-26.project.md`。
  - 项目管理文档标记任务 0 完成，下一步进入任务 1（导航与移动端可访问性修复）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T1：修复顶部导航 sticky、扩大移动端点击热区并补齐菜单 aria 状态同步。

- 时刻：2026-02-26 16:05:23 CST
- 完成内容：完成“GitHub Pages 用户视角问题修复（2026-02-26）”T1（导航与移动端可访问性修复）。
  - 更新 `site/assets/styles.css`：
    - 移除 `html/body` 的 `overflow-x: hidden`，修复顶部导航 sticky 在长滚动中失效的问题。
    - 扩大移动端菜单按钮与语言按钮点击热区（约 `44x44` / `40x40`）。
  - 更新 `site/assets/app.js`：
    - 菜单开合统一由 `setMenuOpen` 控制，补齐 `aria-expanded` 与 `aria-controls` 同步。
    - 关闭菜单逻辑统一用于点击导航项与 `Escape`。
  - 回写项目管理文档：`doc/site/github-pages-user-perspective-fixes-2026-02-26.project.md`，标记任务 1 完成。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - Web 回归（Playwright）：
    - 1280 宽滚动后 `.topbar` 保持 `top=0`（sticky 生效）。
    - 360 宽下菜单/语言按钮尺寸与菜单 `aria-expanded` 开合同步符合预期。
- 遗留事项：
  - 执行 T2：修复语言自动跳转完成标记写入时机，并优化字体加载策略。

- 时刻：2026-02-26 16:17:02 CST
- 完成内容：完成“GitHub Pages 用户视角问题修复（2026-02-26）”T2（语言与性能修复）。
  - 更新 `site/assets/app.js`：
    - 调整语言自动跳转逻辑，`/doc/cn|en/*` 路径不再提前写入 `agent_world_pages_lang_redirect_done_v1`。
    - 保持手动语言选择优先级不变，仅修正首次自动判定时机。
  - 更新 `site/assets/styles.css`：
    - 移除 `Noto Sans SC` 远程字体引入，保留系统中文字体 fallback。
    - 同步清理字体栈中的 `Noto Sans SC` 依赖。
  - 回写项目管理文档：`doc/site/github-pages-user-perspective-fixes-2026-02-26.project.md`，标记任务 2 完成。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - Web 回归（Playwright）：
    - 英文环境先访问 `doc/cn/index.html` 时 `redirect_done` 保持 `null`，随后访问 `/` 自动跳转 `/en/`。
    - 英文首页资源请求从此前高外链字体请求收敛到 4 个外部字体请求，`notoCount=0`。
- 遗留事项：
  - 执行 T3：完成验证收口、文档状态更新与最终日志。

- 时刻：2026-02-26 16:26:32 CST
- 完成内容：完成“GitHub Pages 用户视角问题修复（2026-02-26）”T3（验证与收口）。
  - 执行 Playwright 关键路径回归：
    - sticky：1280 宽滚动后 `.topbar` 保持 `top=0`。
    - 移动端：360 宽下菜单按钮 `44x44`、语言按钮 `40x40`，菜单开关时 `aria-expanded` 与 `data-open` 同步。
    - 语言逻辑：先访问 `doc/cn/index.html` 时 `redirect_done=null`，随后访问 `/` 自动跳转到 `/en/` 并写入 `redirect_done=1`。
    - 字体请求：英文首页外部字体请求收敛到 4 个，`notosanssc` 请求为 0。
  - 执行并通过：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`。
  - 回写项目管理文档：`doc/site/github-pages-user-perspective-fixes-2026-02-26.project.md`，标记任务 3 完成并结项。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - test_tier_required（Web 闭环）：Playwright 首页/文档/语言/移动端回归检查通过。
- 遗留事项：
  - 无。

- 时刻：2026-02-26 18:57:01 CST
- 完成内容：完成“Viewer Live LLM 事件触发决策门控（避免空跑）”任务。
  - 新增设计文档：`doc/world-simulator/viewer-live-llm-event-driven-trigger-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-live-llm-event-driven-trigger-2026-02-26.project.md`。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - `LiveWorld` 新增 `llm_decision_pending` 门控状态。
    - LLM 路径在无待触发时不再执行 `runner.tick()`；`reset` 后恢复初始待触发态。
    - 新增 `mark_llm_decision_pending()` 唤醒接口。
  - 更新 `crates/agent_world/src/viewer/live/consensus_bridge.rs`：
    - consensus 路径接入 LLM 门控。
    - 共识提交 action 应用后自动唤醒下一轮 LLM 决策。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：
    - `Play`、`Step`、`AgentChat` 成功、`PromptControl Apply/Rollback` 成功时唤醒 LLM 决策。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：
    - 新增 `live_world_llm_event_driven_gate_avoids_repeated_empty_ticks`，验证空结果不再重复累加空决策 tick。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world live_world_llm_event_driven_gate_avoids_repeated_empty_ticks -- --nocapture`
- 遗留事项：
  - 若后续需要进一步降载，可在播放循环层追加“长期空结果自动降频/暂停”。
- 时刻：2026-02-26 18:34:45 CST
- 完成内容：完成“WASM 沙箱安全补强”T0（建档与任务拆解）。
  - 新增设计文档：`doc/world-runtime/wasm-sandbox-security-hardening.md`。
  - 新增项目管理文档：`doc/world-runtime/wasm-sandbox-security-hardening.project.md`。
  - 项目管理文档标记 T0 完成，进入 T1（执行器硬化）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_executor --features wasmtime`
- 遗留事项：
  - 执行 T1：完成 fuel/epoch/memory limiter 三项执行器硬化。

- 时刻：2026-02-26 18:42:52 CST
- 完成内容：完成“WASM 沙箱安全补强”T1（执行器硬化）。
  - 更新 `crates/agent_world_wasm_executor/src/lib.rs`：
    - `max_gas=0` 统一兜底为 `config.max_fuel`，消除 fuel 无上限路径。
    - 引入 `EpochWatchdog` + `set_epoch_deadline(1)`，在 `max_call_ms` 超时后触发 `engine.increment_epoch()` 抢占中断。
    - `Trap::Interrupt` 与 `Trap::OutOfFuel` 统一映射 `Timeout`。
    - 接入 `StoreLimitsBuilder` + `Store::limiter`，对 `memory.grow` 执行期强约束。
  - 更新 `crates/agent_world_wasm_executor/Cargo.toml`：新增测试依赖 `wat`，用于构造无限循环 wasm 回归用例。
  - 回写项目管理文档：`doc/world-runtime/wasm-sandbox-security-hardening.project.md`，标记 T1 完成并进入 T2。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --features wasmtime`
- 遗留事项：
  - 执行 T2：补齐模块仓库存储加载时的工件哈希复验。

- 时刻：2026-02-26 18:46:31 CST
- 完成内容：完成“WASM 沙箱安全补强”T2（模块仓库加载完整性校验）。
  - 更新 `crates/agent_world/src/runtime/world/persistence.rs`：加载 `module_store` 工件时重算 `sha256`，与 `wasm_hash` 不一致则拒绝加载。
  - 更新 `crates/agent_world/src/runtime/tests/persistence.rs`：新增 `load_from_dir_rejects_tampered_module_artifact_bytes`，覆盖磁盘工件篡改路径。
  - 回写项目管理文档：`doc/world-runtime/wasm-sandbox-security-hardening.project.md`，标记 T2 完成并进入 T3。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world --lib load_from_dir_rejects_tampered_module_artifact_bytes`
- 遗留事项：
  - 执行 T3：收口测试、更新项目状态并完成最终结项。

- 时刻：2026-02-26 18:48:51 CST
- 完成内容：完成“WASM 沙箱安全补强”T3（测试补强、文档回写与收口）。
  - 更新 `crates/agent_world_wasm_executor/src/lib.rs`：补充 `requested_fuel` 在非 `wasmtime` 构建下的 `dead_code` 抑制，清理构建噪音。
  - 回写项目管理文档：`doc/world-runtime/wasm-sandbox-security-hardening.project.md`，标记 T3 完成，状态更新为“已完成”。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --features wasmtime`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world --lib load_from_dir_rejects_tampered_module_artifact_bytes`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 19:14:42 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 1”T0（建档）。
  - 新增设计文档：`doc/world-simulator/viewer-live-full-event-driven-phase1-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase1-2026-02-26.project.md`。
  - 项目状态更新为“进行 T1”。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 继续执行 T1/T2：主循环改为统一信号队列并接入播放脉冲事件。

- 时刻：2026-02-26 19:22:43 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 1”T1（统一主循环请求信号输入）。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：新增内部信号 `LiveLoopSignal`，`serve_stream` 通道统一为 `mpsc::channel::<LiveLoopSignal>()`。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：`read_requests` 改为发送 `LiveLoopSignal::Request`，完成请求入口统一。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase1-2026-02-26.project.md`，标记 T1 完成并进入 T2。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world live_world_llm_event_driven_gate_avoids_repeated_empty_ticks`
- 遗留事项：
  - 执行 T2：接入 `PlaybackPulse` 信号与阻塞 `recv()`，移除 `recv_timeout/elapsed` 轮询。

- 时刻：2026-02-26 19:27:19 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 1”T2（播放脉冲线程接线 + 主循环阻塞消费）。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - 新增 `LiveLoopSignal::PlaybackPulse`。
    - `serve_stream` 从 `recv_timeout` 改为阻塞 `rx.recv()`。
    - 移除 `last_tick.elapsed` 轮询逻辑，改为在 `PlaybackPulse` 分支内推进 `world.step()`。
    - 增加 `handle_playback_pulse` 处理函数，保持既有事件/快照/metrics 发射语义。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：
    - `ViewerLiveSession` 移除 `tick_interval` 字段（不再由 session 内轮询推进）。
    - 新增 `emit_playback_pulses` 线程函数，按 `tick_interval` 投递 `PlaybackPulse`。
    - `read_requests` 增加 `loop_running` 联动，连接断开时触发脉冲线程退出，避免线程滞留。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase1-2026-02-26.project.md`，标记 T2 完成并进入 T3。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests::`
- 遗留事项：
  - 执行 T3：补充/确认 live 关键语义回归覆盖并完成验证。

- 时刻：2026-02-26 19:30:45 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 1”T3（回归测试补强）。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：新增 `playback_pulse_thread_emits_and_stops_with_loop_flag`，覆盖 `PlaybackPulse` 发射与退出联动。
  - 回归验证 `viewer::live::tests` 全组（包含 play/pause/step/seek 相关 live 语义链路）。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase1-2026-02-26.project.md`，标记 T3 完成并进入 T4。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world playback_pulse_thread_emits_and_stops_with_loop_flag`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests::`
- 遗留事项：
  - 执行 T4：文档收口，明确“达到完全事件驱动”剩余改造点与后续阶段计划。

- 时刻：2026-02-26 19:36:44 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 1”T4（文档与日志收口）。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase1-2026-02-26.md`：新增“Phase 1 完成态”与“走向完全事件驱动的后续改造点”。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase1-2026-02-26.project.md`：标记 T4 完成，状态收敛为“已完成（T0~T4）”。
- 测试：
  - 文档任务，无新增代码测试（代码回归已在 T2/T3 完成）。
- 遗留事项：
  - 启动 Phase 2：按文档后续改造点推进“动态定时器 + mailbox 化 LLM 事件 + 统一事件总线 + 背压”。

- 时刻：2026-02-26 19:42:06 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 2”T0（建档）。
  - 新增设计文档：`doc/world-simulator/viewer-live-full-event-driven-phase2-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase2-2026-02-26.project.md`。
  - 项目状态设置为“进行 T0”。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：动态脉冲控制接线（暂停态零脉冲）。

- 时刻：2026-02-26 19:45:31 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 2”T1（动态脉冲控制接线）。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - `serve_stream` 接入 `PlaybackPulseControl`，请求处理后同步 `set_enabled(session.should_emit_event())`。
    - 连接退出时增加 `playback_control.notify()`，确保等待线程及时退出。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：
    - 新增 `PlaybackPulseControl`（`Mutex + Condvar`）内部控制器。
    - `emit_playback_pulses` 改为“enabled 才按间隔发脉冲”；disabled 时阻塞等待状态变更。
    - `read_requests` 在断开路径联动唤醒控制器，避免脉冲线程滞留。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：适配脉冲线程测试签名与控制器初始化。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase2-2026-02-26.project.md`，标记 T1 完成并进入 T2。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world playback_pulse_thread_emits_and_stops_with_loop_flag`
- 遗留事项：
  - 执行 T2：新增“暂停态零脉冲”回归测试并跑 live 测试组。

- 时刻：2026-02-26 19:56:31 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 2”T2（回归测试补强）。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：新增 `playback_pulse_thread_stays_idle_until_enabled`，覆盖“暂停态零脉冲 + 启用后发脉冲”语义。
  - 验证 `viewer::live::tests` 全组通过，确认 live 关键语义无回退。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase2-2026-02-26.project.md`，标记 T2 完成并进入 T3。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world playback_pulse_thread_stays_idle_until_enabled`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests::`
- 遗留事项：
  - 执行 T3：文档收口并确认 Phase 2 完成态。

- 时刻：2026-02-26 20:07:56 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 2”T3（文档与日志收口）。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase2-2026-02-26.md`：新增“Phase 2 完成态”与“Phase 3 入口”。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase2-2026-02-26.project.md`：标记 T3 完成，状态收敛为“已完成（T0~T3）”。
- 测试：
  - 文档任务，无新增代码测试（代码回归已在 T1/T2 完成）。
- 遗留事项：
  - 启动 Phase 3：推进 LLM mailbox 事件化与统一事件总线。

- 时刻：2026-02-26 20:24:20 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 3”T0（建档）。
  - 新增设计文档：`doc/world-simulator/viewer-live-full-event-driven-phase3-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase3-2026-02-26.project.md`。
  - 项目状态设置为“进行 T0”。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：接入 `LlmDecisionRequested` 事件与 mailbox 计数语义。

- 时刻：2026-02-26 20:33:16 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 3”T1（LLM mailbox 事件化接线）。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - 新增 `LiveLoopSignal::LlmDecisionRequested`，请求处理结果改为通过主循环信号投递唤醒 LLM。
    - `LiveWorld` 的 LLM 触发状态由布尔值改为 `llm_decision_mailbox` 计数。
    - 播放脉冲前增加 `should_step_on_playback_pulse()` 判定，LLM mailbox 为空时跳过 step，避免空跑。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：
    - `handle_request` 返回 `ViewerLiveRequestOutcome`，将“请求是否触发 LLM”以效果值返回给主循环。
    - `Play` / `AgentChat` / `PromptControl Apply|Rollback` 改为设置 `request_llm_decision`，不再在请求线程直改 world。
    - `Step` 保持同步推进语义：每次 step 前显式 `request_llm_decision()` 后立即执行 `world.step()`。
  - 更新 `crates/agent_world/src/viewer/live/consensus_bridge.rs`：
    - consensus LLM 路径接入 mailbox 计数消费/回填语义。
    - 共识提交 action 应用后通过 mailbox 唤醒后续 LLM 决策。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：
    - 测试改为调用 `request_llm_decision()`，清理旧兼容入口。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase3-2026-02-26.project.md`，标记 T1 完成并进入 T2。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：补充 mailbox 多请求语义与播放脉冲空跑门控的回归测试。

- 时刻：2026-02-26 20:37:23 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 3”T2（mailbox 语义回归测试补强）。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：
    - 新增 `live_world_llm_mailbox_preserves_multiple_requests`，验证 mailbox 多次请求会按计数逐次消费，不会被折叠成一次触发。
    - 新增 `live_world_playback_pulse_gate_tracks_llm_mailbox`，验证 LLM 非共识路径下 mailbox 为空时 `should_step_on_playback_pulse()` 为 false，避免空跑。
  - 回归执行 `viewer::live::tests` 全组，确认 live 关键语义（playback pulse、seek、prompt control、agent chat）无回退。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase3-2026-02-26.project.md`，标记 T2 完成并进入 T3。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：完成 Phase 3 文档收口并明确完全事件驱动的后续改造清单。

- 时刻：2026-02-26 20:50:04 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 3”T3（文档与日志收口）。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase3-2026-02-26.md`：
    - 新增“Phase 3 完成态”，总结 mailbox 事件化与 `LlmDecisionRequested` 主循环接线结果。
    - 新增“Phase 4 入口（完全事件驱动收敛）”，明确 Step/Seek 事件化、共识动作事件化、有界队列与背压治理三项后续改造点。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase3-2026-02-26.project.md`：
    - 标记 T3 完成，状态收敛为“已完成（T0~T3）”。
  - 本阶段（Phase 3）全部任务完成并结项。
- 测试：
  - 文档任务，无新增代码测试（代码回归已在 T1/T2 完成）。
- 遗留事项：
  - 启动 Phase 4：继续推进 Step/Seek 与共识回放的完全事件化改造。

- 时刻：2026-02-26 21:03:55 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 4”T0（建档）。
  - 新增设计文档：`doc/world-simulator/viewer-live-full-event-driven-phase4-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase4-2026-02-26.project.md`。
  - 项目状态设置为“进行 T1（Step/Seek 控制事件化）”。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：完成 `StepRequested/SeekRequested` 接线与请求处理 deferred effect 化。

- 时刻：2026-02-26 21:19:01 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 4”T1（Step/Seek 控制事件化接线）。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：
    - `ViewerLiveRequestOutcome` 新增 `deferred_control`。
    - 新增 `ViewerLiveDeferredControl::{Step, Seek}`。
    - `ViewerControl::Step/Seek` 不再在 `handle_request` 内直接变更 world，改为产出 deferred control effect。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - `LiveLoopSignal` 新增 `StepRequested`、`SeekRequested`。
    - 主循环在处理请求结果后投递对应控制信号。
    - 新增 `handle_step_request`、`handle_seek_request`，在主循环信号分支内执行 step/seek 与回包逻辑。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase4-2026-02-26.project.md`，标记 T1 完成并进入 T2。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：补充 Step/Seek deferred control 的行为回归测试。

- 时刻：2026-02-26 21:24:03 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 4”T2（Step/Seek 回归测试补强）。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：
    - 新增 `step_control_is_deferred_from_request_handler`，验证 `Step` 请求仅产出 deferred control，不在请求处理阶段推进 world。
    - 新增 `seek_control_is_deferred_from_request_handler`，验证 `Seek` 请求仅产出 deferred control，不在请求处理阶段推进 world。
    - 新增测试辅助 `test_writer_pair` 生成本地 `TcpStream` writer 用于 request handler 语义验证。
  - 回归执行 `viewer::live::tests` 全组，确认 live 基线语义与新增 Step/Seek 事件化语义一致。
  - 回写项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase4-2026-02-26.project.md`，标记 T2 完成并进入 T3。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：完成 Phase 4 文档收口并给出 Phase 5 入口（共识事件化 + 背压）。

- 时刻：2026-02-26 21:29:06 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 4”T3（文档与日志收口）。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase4-2026-02-26.md`：新增“Phase 4 完成态”与“Phase 5 入口（共识提交事件化 + 背压）”。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase4-2026-02-26.project.md`：标记 T3 完成，状态收敛为“已完成（T0~T3）”。
  - 本阶段（Phase 4）全部任务完成并结项。
- 测试：
  - 文档任务，无新增代码测试（代码回归已在 T1/T2 完成）。
- 遗留事项：
  - 启动 Phase 5：推进共识提交事件化与主循环有界背压治理。

- 时刻：2026-02-26 21:31:25 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 5”T0（建档）。
  - 新增设计文档：`doc/world-simulator/viewer-live-full-event-driven-phase5-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase5-2026-02-26.project.md`。
  - 项目状态设置为“进行 T1（共识提交事件化）”。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：实现 NodeRuntime 提交批次等待接口与 viewer 共识监听信号接线。

- 时刻：2026-02-26 21:55:38 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 5”T1（共识提交事件化接线）。
  - 更新 `crates/agent_world_node/src/lib.rs`、`crates/agent_world_node/src/node_runtime_core.rs`：
    - 新增 `NodeCommittedActionBatchesHandle`，支持等待 committed batch 到达（`wait_for_batches`）。
    - `committed_action_batches` 存储升级为 `Mutex + Condvar`，在提交入队和清空时发通知。
    - 新增 `NodeRuntime::committed_action_batches_handle()` 供外部监听线程使用。
  - 更新 `crates/agent_world/src/viewer/live/consensus_bridge.rs`：新增 `committed_batches_handle()`，暴露 runtime committed batch 等待句柄。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`、`crates/agent_world/src/viewer/live_split_part2.rs`：
    - 新增 `LiveLoopSignal::ConsensusCommitted`、`ConsensusDriveRequested`。
    - 新增共识提交监听线程 `emit_consensus_commit_signals`，由 committed batch 到达驱动主循环信号。
    - 共识模式下停用 `PlaybackPulse` 推进，改为共识提交信号和驱动信号推进；保留非共识模式脉冲链路。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world_node`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：主循环事件队列有界化与事件合并/过载计数背压。

- 时刻：2026-02-26 22:03:36 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 5”T2（主循环有界背压）。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - live 主循环信号通道由 `mpsc::channel` 改为有界 `mpsc::sync_channel`（容量 256）。
    - 为 `LlmDecisionRequested` / `ConsensusDriveRequested` 引入合并投递，避免重复入队。
    - 收包分支增加 coalesced 信号复位，并在连接结束时输出背压统计日志（merged/dropped）。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：
    - 新增 `LiveLoopBackpressure` 与 `LiveLoopBackpressureSnapshot`，记录合并/丢弃计数。
    - 新增 `enqueue_coalesced_signal`，统一 coalesced 信号投递与 `try_send` 丢弃计数。
    - `emit_playback_pulses`、`emit_consensus_commit_signals` 接入 coalesced 投递与背压计数。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：适配播放脉冲线程测试到 `sync_channel` 与新函数签名。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：新增共识提交信号链路与背压合并/丢弃语义回归测试。

- 时刻：2026-02-26 22:08:42 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 5”T3（回归测试补强）。
  - 更新 `crates/agent_world/src/viewer/live/tests.rs`：
    - 新增 `consensus_commit_signal_thread_emits_on_committed_batches`，覆盖共识提交到达驱动 `ConsensusCommitted` 信号链路。
    - 新增 `enqueue_coalesced_signal_merges_duplicate_llm_decision_requests`，覆盖 coalesced 合并语义。
    - 新增 `enqueue_coalesced_signal_drops_when_queue_is_full`，覆盖有界队列满载时的丢弃计数语义。
  - 更新项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase5-2026-02-26.project.md`，标记 T3 完成并进入 T4。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T4：完成 Phase 5 文档收口并明确 Phase 6 入口（非共识链路进一步去定时化）。

- 时刻：2026-02-26 22:10:59 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 5”T4（文档与日志收口）。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase5-2026-02-26.md`：新增“Phase 5 完成态”和“Phase 6 入口（非共识链路去定时化）”。
  - 更新 `doc/world-simulator/viewer-live-full-event-driven-phase5-2026-02-26.project.md`：标记 T4 完成，状态收敛为“已完成（T0~T4）”。
  - 本阶段（Phase 5）全部任务完成并结项。
- 测试：
  - 文档任务，无新增代码测试（代码回归已在 T1~T3 完成）。
- 遗留事项：
  - 启动 Phase 6：推进非共识链路去定时化与统一状态变更驱动。

- 时刻：2026-02-26 22:12:50 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 6”T0（建档）。
  - 新增设计文档：`doc/world-simulator/viewer-live-full-event-driven-phase6-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase6-2026-02-26.project.md`。
  - 项目状态设置为“进行 T1（非共识驱动事件化）”。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：接入 `NonConsensusDriveRequested`，去除非共识路径对固定 `PlaybackPulse` 的依赖。

- 时刻：2026-02-26 22:19:45 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 6”T1（非共识驱动事件化接线）。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - 新增 `LiveLoopSignal::NonConsensusDriveRequested`。
    - 非共识 LLM 路径由 `NonConsensusDriveRequested` 驱动推进；`LlmDecisionRequested` 在非共识路径下改为触发该信号。
    - `PlaybackPulse` 启停条件改为 `world.should_use_playback_pulse()`（仅非共识 script 路径使用）。
    - 新增 `handle_non_consensus_drive_requested`，按 mailbox 状态执行 step 并决定是否续驱动。
  - 更新 `crates/agent_world/src/viewer/live_split_part2.rs`：
    - 背压计数新增 `non_consensus_drive` 维度（merge/drop）。
    - `CoalescedSignalKind` 新增 `NonConsensusDriveRequested`。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：状态变更节流（有效推进后再发射 metrics/snapshot）并收敛非必要推送。

- 时刻：2026-02-26 22:23:30 CST
- 完成内容：完成“Viewer Live 完全事件驱动改造 Phase 6”T2（状态变更节流）。
  - 更新 `crates/agent_world/src/viewer/live_split_part1.rs`：
    - `emit_step_outcome` 新增 `emit_idle_metrics` 门控。
    - 共识/非共识驱动事件路径在“无事件且无决策痕迹”时不再推送 metrics，减少冗余空推送。
    - 手动控制路径（`Step`/`PlaybackPulse`）保持原有 metrics 推送语义。
  - 更新项目管理文档：`doc/world-simulator/viewer-live-full-event-driven-phase6-2026-02-26.project.md`，标记 T2 完成并进入 T3。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T3：补齐非共识驱动与 metrics 节流语义回归测试。
- 时刻：2026-02-26 19:35:00 +0800
- 完成内容：完成“零信任多节点治理与签名加固（2026-02-26）”T0（建档与任务拆解）。
  - 新增设计文档：`doc/world-runtime/zero-trust-governance-receipt-hardening-2026-02-26.md`。
  - 新增项目管理文档：`doc/world-runtime/zero-trust-governance-receipt-hardening-2026-02-26.project.md`。
  - 项目管理文档标记 T0 完成，当前阶段切换为 T1（P0 工件真实性链）。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
- 遗留事项：
  - 执行 T1：落地 artifact_identity 必填、禁止 unsigned，并在注册/加载路径统一验签与信任校验。

- 时刻：2026-02-26 19:53:14 +0800
- 完成内容：完成“zero-trust-governance-receipt-hardening-2026-02-26”T1（P0 工件真实性链）。
  - 更新 `crates/agent_world_wasm_abi/src/lib.rs`：扩展 `ModuleArtifactIdentity`（`signer_node_id`、`signature_scheme`），移除 `unsigned` 辅助，新增 `ed25519` 签名负载规范。
  - 更新 `crates/agent_world/src/runtime/world/base_layer.rs`：`artifact_identity` 改为运行时必填；拒绝 `unsigned:*`；新增 `ed25519` 验签与 `node_identity_bindings` 信任链校验。
  - 更新 `crates/agent_world/src/runtime/world/persistence.rs`：模块存储加载路径执行同一身份验签。
  - 更新 `crates/agent_world/src/runtime/builtin_wasm_identity_manifest.rs` 与 `crates/agent_world/src/runtime/world/artifacts/*_builtin_modules.identity.json`：内置模块身份改为按 `wasm_hash` 选择签名（`artifact_signatures`），支持多平台 hash 验签。
  - 更新 `crates/agent_world/src/runtime/world/mod.rs`：注入内置 signer 根信任绑定（`builtin.module.release.signer`）。
  - 更新测试：`crates/agent_world/src/runtime/tests/builtin_wasm_identity.rs`、`crates/agent_world/src/runtime/tests/modules_split_part1.rs`、`crates/agent_world_wasm_abi/src/lib.rs` 相关断言。
  - 回写项目管理文档 `doc/world-runtime/zero-trust-governance-receipt-hardening-2026-02-26.project.md`，标记 T1 完成并推进到 T2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_abi`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi module_artifact_identity_payload_and_prefix`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world builtin_identity_manifest_resolves_m1_entry`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world shadow_rejects_module_artifact_identity_signature_mismatch`
- 遗留事项：
  - 继续执行 T2：治理 `apply_proposal` 绑定共识最终性证书与多签门限，并实现原子提交语义。

- 时刻：2026-02-26 20:55:36 CST
- 完成内容：补齐“zero-trust-governance-receipt-hardening-2026-02-26”T1 收敛修复并完成全量回归。
  - 修复大批测试构造在 `artifact_identity` 强制验签后的失配问题：统一为签名身份 helper，并修正 `wasm_hash` move/变量错位导致的编译错误。
  - 新增测试共享 helper：`crates/agent_world/tests/common/mod.rs`，并接线相关 integration tests。
  - 在 `crates/agent_world/src/runtime/world/mod.rs` 增加测试特性下的测试 signer 信任绑定（`test.module.release.signer`），避免污染生产内置 signer 信任根。
  - 修复 `crates/agent_world/src/bin/world_viewer_live/execution_bridge.rs` 测试用模块清单：补充签名 `artifact_identity`，恢复 `node_runtime_execution_driver_commit_routes_modules_via_step_with_modules` 预期失败断言路径。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
- 遗留事项：
  - 继续执行 T2：治理 `apply_proposal` 绑定共识最终性证书与多签门限，并改为原子提交语义。

- 时刻：2026-02-26 21:29:35 CST
- 完成内容：完成“zero-trust-governance-receipt-hardening-2026-02-26”T3（P1 收据签名升级 + 共识锚定）。
  - 更新 `crates/agent_world/src/runtime/effect.rs`：扩展 `ReceiptSignature` 元数据（`signer_node_id/threshold/participants/consensus_height/receipts_root/participant_signatures`），新增 `SignatureAlgorithm::{Ed25519,ThresholdEd25519}`。
  - 更新 `crates/agent_world/src/runtime/signer.rs`：`ReceiptSigner` 从单一 HMAC 升级为三种模式（`hmac_sha256`、`ed25519`、`threshold_ed25519`），新增信任根校验、阈值签名参与者校验与锚定字段入签名负载。
  - 更新 `crates/agent_world/src/runtime/world/effects.rs`：在 `ingest_receipt` 路径计算 `consensus_height + receipts_root`，签名/验签均绑定该锚点，拒绝锚点漂移或不受信 signer。
  - 更新测试 `crates/agent_world/src/runtime/tests/effects.rs`：新增 `ed25519`/`threshold_ed25519` 正向用例与锚点失配拒绝用例。
  - 回写项目管理文档 `doc/world-runtime/zero-trust-governance-receipt-hardening-2026-02-26.project.md`，标记 T3 完成并推进 T4。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::effects:: --features test_tier_required`
- 遗留事项：
  - 继续执行 T4：将 Wasmtime trap 从统一 `Timeout` 拆分为 `OutOfFuel` 与 `Interrupted` 可观测错误码。

- 时刻：2026-02-26 21:47:59 CST
- 完成内容：完成“zero-trust-governance-receipt-hardening-2026-02-26”T5（回归测试、文档回写、收口）。
  - 执行四项加固相关定向回归：
    - 治理最终性与原子 apply（`runtime::tests::governance::`）。
    - 收据多签与锚定（`runtime::tests::effects::`）。
    - Wasmtime trap 可观测性拆分（`agent_world_wasm_executor --features wasmtime`）。
  - 回写项目管理文档 `doc/world-runtime/zero-trust-governance-receipt-hardening-2026-02-26.project.md`，标记 T5 完成并将状态更新为“已完成（T0~T5）”。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::governance:: --features test_tier_required`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::effects:: --features test_tier_required`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --features wasmtime`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 21:15:59 CST
- 完成内容：完成“zero-trust-governance-receipt-hardening-2026-02-26”T2（P0 治理与共识绑定 + 原子 apply）。
  - 更新 `crates/agent_world/src/runtime/governance.rs`：新增 `GovernanceFinalityCertificate`，引入提案/manifest hash/高度/门限/签名集合的数据结构与签名负载规范。
  - 更新 `crates/agent_world/src/runtime/world/governance.rs`：新增 `apply_proposal_with_finality` 与最终性证书验真，校验门限、多签签名、签名人信任根及 proposal/hash 一致性。
  - 调整 apply 顺序为“先验证与模块变更应用，再写 `ManifestUpdated`，最后写 `Governance::Applied`”，避免“Applied 已落盘但未完整生效”。
  - 更新 `crates/agent_world/src/runtime/world/mod.rs`：注入本地治理最终性 signer 信任绑定（用于默认流和测试流）。
  - 更新测试 `crates/agent_world/src/runtime/tests/governance.rs`：新增门限失配拒绝与事件顺序断言。
  - 回写项目管理文档 `doc/world-runtime/zero-trust-governance-receipt-hardening-2026-02-26.project.md`，标记 T2 完成并推进 T3。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::governance:: --features test_tier_required`
- 遗留事项：
  - 继续执行 T3：收据签名从单机 HMAC 升级到节点签名/阈值签名，并将收据根锚定到共识高度。

- 时刻：2026-02-26 21:44:21 CST
- 完成内容：完成“zero-trust-governance-receipt-hardening-2026-02-26”T4（P1 执行错误可观测性）。
  - 更新 `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleCallErrorCode` 新增 `OutOfFuel` 与 `Interrupted`，保留 `Timeout` 以兼容非 trap 超时路径。
  - 更新 `crates/agent_world_wasm_executor/src/lib.rs`：
    - `map_wasmtime_error` 改为 `Trap::OutOfFuel -> OutOfFuel`、`Trap::Interrupt -> Interrupted`。
    - 调整对应单元测试断言，并新增 `OutOfFuel` trap 映射测试。
    - `epoch watchdog` 无限循环用例改为断言 `Interrupted`，避免与 `Timeout` 混淆。
  - 回写项目管理文档 `doc/world-runtime/zero-trust-governance-receipt-hardening-2026-02-26.project.md`，标记 T4 完成并推进 T5。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --features wasmtime`
  - test_tier_required：`env -u RUSTC_WRAPPER cargo check -p agent_world`
- 遗留事项：
  - 继续执行 T5：完成本轮四项加固的回归验证、文档收口与最终结项。
- 时刻：2026-02-26 18:40:26 CST
- 完成内容：完成“GitHub Pages 质量门禁 + 文档镜像同步 + SEO 元信息加固”T0 建档。
  - 新建设计文档：。
  - 新建项目管理文档：。
  - 在项目文档中明确 T1~T4 任务拆解与当前状态（T1 进行中）。
- 测试：
  -   41 doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.md
  41 doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md
  82 total
  - 3:## 目标
8:## 范围
9:- 范围内
14:- 范围外
19:## 接口/数据
28:## 里程碑
35:## 风险
36:- 风险：手册正文长期仍可能漂移。
38:- 风险：链接检查脚本误报导致发布受阻。
40:- 风险：SEO 字段修改影响现有分享卡片。
  - 3:## 任务拆解
5:### T0 建档与基线
10:### T1 手册镜像路径修复与一致性检查
29:- [ ] 回写本项目管理文档状态
33:## 依赖
38:## 状态
39:- 当前阶段：进行中（T0 完成，T1 进行中）
40:- 最近更新：完成 T0 建档（2026-02-26）
41:- 下一步：执行 T1，修复手册镜像路径并落地一致性检查脚本。
- 遗留事项：
  - 按项目文档继续执行 T1：修复站内手册镜像路径并新增一致性检查脚本。

- 时刻：2026-02-26 18:40:41 CST
- 完成内容：完成“GitHub Pages 质量门禁 + 文档镜像同步 + SEO 元信息加固”T0 建档。
  - 新建设计文档：`doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.md`。
  - 新建项目管理文档：`doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md`。
  - 在项目文档中明确 T1~T4 任务拆解与当前状态（T1 进行中）。
- 测试：
  - `wc -l doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.md doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md`
  - `rg -n "目标|范围|接口/数据|里程碑|风险" doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.md`
  - `rg -n "T0|T1|任务拆解|依赖|状态|当前阶段" doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md`
- 遗留事项：
  - 按项目文档继续执行 T1：修复站内手册镜像路径并新增一致性检查脚本。

- 时刻：2026-02-26 18:57:22 CST
- 完成内容：完成“GitHub Pages 质量门禁 + 文档镜像同步 + SEO 元信息加固”T1（手册镜像路径修复与一致性检查）。
  - 更新 `site/doc/cn/viewer-manual.html` 与 `site/doc/en/viewer-manual.html`：Web 闭环示例改为 `REPO_ROOT/.codex` 路径并增加 wrapper 存在性检查。
  - 新增 `scripts/site-manual-sync-check.sh`：校验主手册与站内镜像的 Playwright 路径口径一致，并阻断旧 `CODEX_HOME` 口径。
  - 回写项目管理文档：`doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md`，标记 T1 完成并推进 T2。
- 测试：
  - `bash -n scripts/site-manual-sync-check.sh`
  - `./scripts/site-manual-sync-check.sh`
  - `rg -n "CODEX_HOME|\.codex/skills/playwright/scripts/playwright_cli\.sh|missing playwright cli wrapper" site/doc/cn/viewer-manual.html site/doc/en/viewer-manual.html doc/viewer-manual.md scripts/site-manual-sync-check.sh`
- 遗留事项：
  - 继续执行 T2：新增站内链接检查并接入 Pages workflow 发布前门禁。

- 时刻：2026-02-26 18:59:59 CST
- 完成内容：完成“GitHub Pages 质量门禁 + 文档镜像同步 + SEO 元信息加固”T2（Pages 发布门禁接入）。
  - 新增 `scripts/site-link-check.sh`：校验 `site/**/*.html` 的本地相对 `href/src` 引用有效性。
  - 更新 `.github/workflows/pages.yml`：新增部署前门禁步骤 `Run Site Quality Gates`，执行 `site-link-check` 与 `site-manual-sync-check`。
  - 扩展 Pages 触发路径：纳入 `scripts/site-link-check.sh`、`scripts/site-manual-sync-check.sh`、`doc/viewer-manual.md`。
  - 回写项目管理文档：`doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md`，标记 T2 完成并推进 T3。
- 测试：
  - `bash -n scripts/site-link-check.sh scripts/site-manual-sync-check.sh`
  - `./scripts/site-link-check.sh && ./scripts/site-manual-sync-check.sh`
  - `rg -n "Run Site Quality Gates|site-link-check.sh|site-manual-sync-check.sh|doc/viewer-manual.md" .github/workflows/pages.yml`
- 遗留事项：
  - 继续执行 T3：补齐首页 SEO/社交元信息并统一 OG 绝对 URL。

- 时刻：2026-02-26 19:08:16 CST
- 完成内容：完成“GitHub Pages 质量门禁 + 文档镜像同步 + SEO 元信息加固”T3（首页 SEO 元信息加固）。
  - 更新 `site/index.html` 与 `site/en/index.html`：新增 `og:url`、`twitter:title/description/image`、`theme-color`。
  - 将中英文首页 `og:image` 统一为绝对 URL（`https://eng-cc.github.io/agent-world/assets/images/og-cover.png`）。
  - 回写项目管理文档：`doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md`，标记 T3 完成并推进 T4。
- 测试：
  - `./scripts/site-link-check.sh && ./scripts/site-manual-sync-check.sh`
  - `rg -n "og:url|og:image|twitter:card|twitter:title|twitter:description|twitter:image|theme-color|canonical|hreflang" site/index.html site/en/index.html`
  - `rg -n "og:image\" content=\"(assets|\.\./assets)" site/index.html site/en/index.html || true`
- 遗留事项：
  - 继续执行 T4：完成回归验证、项目文档收口与最终提交。

- 时刻：2026-02-26 19:11:29 CST
- 完成内容：完成“GitHub Pages 质量门禁 + 文档镜像同步 + SEO 元信息加固”T4（回归验证与文档收口）。
  - 执行站点门禁脚本回归，确认链接检查与手册镜像一致性检查通过。
  - 执行本地 Pages 冒烟：静态服务下访问中英文首页，Playwright console `Errors: 0`。
  - 回写项目管理文档：`doc/site/github-pages-quality-gates-sync-seo-hardening-2026-02-26.project.md`，标记 T4 完成并结项。
- 测试：
  - `./scripts/site-link-check.sh`
  - `./scripts/site-manual-sync-check.sh`
  - `python3 -m http.server 8787 --directory site` + `PLAYWRIGHT_CLI_SESSION=pages-smoke-20260226-191051 ./.codex/skills/playwright/scripts/playwright_cli.sh open "http://127.0.0.1:8787/"`
  - `PLAYWRIGHT_CLI_SESSION=pages-smoke-20260226-191051 ./.codex/skills/playwright/scripts/playwright_cli.sh console error`
  - `PLAYWRIGHT_CLI_SESSION=pages-smoke-20260226-191051 ./.codex/skills/playwright/scripts/playwright_cli.sh goto "http://127.0.0.1:8787/en/"`
  - `PLAYWRIGHT_CLI_SESSION=pages-smoke-20260226-191051 ./.codex/skills/playwright/scripts/playwright_cli.sh console error`
  - `PLAYWRIGHT_CLI_SESSION=pages-smoke-20260226-191051 ./.codex/skills/playwright/scripts/playwright_cli.sh close`
- 遗留事项：
  - 无。

- 时刻：2026-02-26 19:37:24 CST
- 完成内容：完成“主链 Token 分配与发行机制”文档建档任务（TAM-0）。
  - 新建设计文档：`doc/p2p/mainchain-token-allocation-mechanism.md`（补齐创世分配、epoch 增发、销毁回收、治理边界与不变量草案）。
  - 新建项目管理文档：`doc/p2p/mainchain-token-allocation-mechanism.project.md`（拆解 TAM-0~TAM-8，当前状态推进到 TAM-1 待实现）。
- 测试：
  - `wc -l doc/p2p/mainchain-token-allocation-mechanism.md doc/p2p/mainchain-token-allocation-mechanism.project.md`
  - `rg -n "目标|范围|接口 / 数据|里程碑|风险" doc/p2p/mainchain-token-allocation-mechanism.md`
  - `rg -n "任务拆解|依赖|状态|TAM-0|TAM-1" doc/p2p/mainchain-token-allocation-mechanism.project.md`
- 遗留事项：
  - 进入 TAM-1：实现主链 Token 状态模型、快照字段与基础查询接口。

- 时刻：2026-02-26 19:53:32 CST
- 完成内容：完成“主链 Token 分配与发行机制”TAM-1（状态模型与快照字段）。
  - 新增 `crates/agent_world/src/runtime/main_token.rs`：定义 `MainTokenConfig`、通胀/分配/销毁策略、供应状态、账户余额、创世桶状态、epoch 增发记录等可序列化模型。
  - 更新 `crates/agent_world/src/runtime/state.rs`：将主链 Token 相关字段纳入 `WorldState` 并补默认值，快照/回放自动持久化。
  - 更新 `crates/agent_world/src/runtime/world/resources.rs`：补齐主链 Token 基础查询与基础写入接口（配置、供应、账户余额、创世桶、epoch 记录、金库余额）。
  - 新增 `crates/agent_world/src/runtime/tests/main_token.rs` 并接入 `runtime/tests/mod.rs`，覆盖默认查询与快照回放一致性。
  - 回写项目管理文档：`doc/p2p/mainchain-token-allocation-mechanism.project.md`（TAM-1 标记完成，下一步 TAM-2）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::main_token:: -- --nocapture`
- 遗留事项：
  - 进入 TAM-2：实现创世分配初始化与 vesting 领取动作闭环。

- 时刻：2026-02-26 20:22:31 CST
- 完成内容：完成“主链 Token 分配与发行机制”TAM-2（创世分配初始化 + vesting 领取动作闭环）。
  - 扩展 runtime 协议：
    - `Action::InitializeMainTokenGenesis` / `Action::ClaimMainTokenVesting`
    - `DomainEvent::MainTokenGenesisInitialized` / `DomainEvent::MainTokenVestingClaimed`
  - 在 `event_processing` 增加主链 Token 动作评估与预校验：
    - 创世分配比率和=10000、桶唯一性、空字段校验、按比例分配与余数确定性分配。
    - vesting 领取校验（recipient 绑定、可解锁额度、nonce 防重放、预执行拒绝路径）。
  - 在 `WorldState::apply_domain_event` 主路径落地状态应用：
    - 创世初始化写入供应状态、桶状态、受益人 `vested_balance`。
    - 领取时将 `vested_balance -> liquid_balance`，更新 `circulating_supply` 与 `main_token_claim_nonces`。
  - 更新事件标签与动作标签映射，补齐主链 Token 新事件/动作的可观测标签。
  - 更新测试 `crates/agent_world/src/runtime/tests/main_token.rs`：新增创世初始化与 vesting 领取（含 nonce 重放拒绝）闭环测试。
  - 回写项目管理文档：`doc/p2p/mainchain-token-allocation-mechanism.project.md`（TAM-2 标记完成，下一步 TAM-3）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::main_token:: -- --nocapture`
- 遗留事项：
  - 进入 TAM-3：实现 epoch 增发公式与分配执行（含余数确定性策略）。

- 时刻：2026-02-26 20:53:17 CST
- 完成内容：完成“主链 Token 分配与发行机制”TAM-3（epoch 增发公式与分配执行）。
  - 扩展 runtime 协议：新增 `Action::ApplyMainTokenEpochIssuance` 与 `DomainEvent::MainTokenEpochIssued`。
  - 在 `event_processing` 增加增发评估闭环：
    - 通胀率计算 `base + gain*(target-actual)` 并 clamp 到 `[min_rate_bps, max_rate_bps]`。
    - 单 epoch 增发按 `circulating_supply * rate_bps / (epochs_per_year * 10000)` 下取整。
    - 分配按 split bps 计算并将余数确定性归并到 `security_reserve`。
    - 支持 `max_supply` 上限裁剪与 epoch 重复防重放。
  - 在 `WorldState::apply_domain_event` 落地 `MainTokenEpochIssued`：
    - 更新 `total_supply` / `total_issued`。
    - 记录 `main_token_epoch_issuance_records`。
    - 写入四个协议金库桶余额（staking/node_service/ecosystem/security_reserve）。
  - 更新可观测标签映射与主链 Token 测试：新增增发公式、clamp、余数分配、重复 epoch 拒绝用例。
  - 回写项目管理文档：`doc/p2p/mainchain-token-allocation-mechanism.project.md`（TAM-3 标记完成，下一步 TAM-4）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::main_token:: -- --nocapture`
- 遗留事项：
  - 进入 TAM-4：实现 Gas/罚没/模块费用销毁与协议金库记账。

- 时刻：2026-02-26 21:04:14 CST
- 完成内容：完成“主链 Token 分配与发行机制”TAM-4（Gas/罚没/模块费用销毁与协议金库记账）。
  - 扩展 runtime 协议：
    - 新增 `MainTokenFeeKind`（`gas_base_fee` / `slash_penalty` / `module_fee`）。
    - 新增 `Action::SettleMainTokenFee` 与 `DomainEvent::MainTokenFeeSettled`。
  - 在 `event_processing` 增加费用结算评估：
    - 根据 `MainTokenBurnPolicy` 计算销毁比例（Gas/Slash/Module 分别取对应 bps）。
    - 输出 `burn_amount + treasury_amount = amount` 的确定性拆分。
    - 通过 preview apply 执行闭环校验与拒绝路径。
  - 在 `WorldState::apply_domain_event` 落地费用结算：
    - `circulating_supply` 按费用总额扣减。
    - `total_supply` 按 `burn_amount` 扣减，`total_burned` 递增。
    - 协议金库按费用类型记账到独立桶：
      - `gas_fee_treasury`
      - `slash_treasury`
      - `module_fee_treasury`
  - 更新事件/动作标签映射与主链 Token 测试：新增 Gas/罚没/模块费用三路销毁与金库记账用例。
  - 回写项目管理文档：`doc/p2p/mainchain-token-allocation-mechanism.project.md`（TAM-4 标记完成，下一步 TAM-5）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::main_token:: -- --nocapture`
- 遗留事项：
  - 进入 TAM-5：实现参数治理边界（范围校验、生效延迟、提案审计事件）。
