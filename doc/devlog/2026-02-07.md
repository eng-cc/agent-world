# 2026-02-07

- 日期确认：2026-02-07
- 完成内容：基于现有设计与实现完成“背景故事物理规律一致性”审查，形成分级问题清单（P0/P1/P2）与测试清单（T1-T4）。
- 完成内容：将《背景故事物理一致性修订清单（2026-02-07）》附加到 `doc/world-simulator.md`，明确 C1-C9 与里程碑（PC1-PC3）。
- 完成内容：更新 `doc/world-simulator.project.md`，新增“9. 背景故事物理一致性修订”任务分解，并标注 C1 为后续优先项。
- 遗留事项：尚未落地 C1-C9 代码与测试，下一任务优先执行 C1（统一碎片尺寸口径并同步文档/默认配置/场景约束）。
- 完成内容：执行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（用于任务收口校验）。
- 遗留事项：测试未完成，原因是当前环境无法解析 `index.crates.io`（依赖下载失败：`blake3`）。
- 完成内容：落地 C1（尺寸口径统一）：`AsteroidFragmentConfig::default` 调整为 `radius_min_cm=25_000`、`radius_max_cm=500_000`，与“直径 500m-10km”设定一致。
- 完成内容：新增回归测试 `init_default_fragment_radius_matches_story_scale`，防止默认口径回退。
- 完成内容：更新设计文档与项目管理文档状态（C1 置为已完成，下一优先项切换为 C2）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world init_default_fragment_radius_matches_story_scale -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C2（辐射源标度修订）与对应单元测试。
- 完成内容：更新 `doc/scripts/pre-commit.md`，明确“新克隆仓库/新 `.git` 环境需重新注册 pre-commit hook”，补充注册与校验命令。
- 完成内容：更新 `doc/scripts/pre-commit.project.md` 任务状态，登记该文档维护项已完成。
- 完成内容：落地 C2（辐射源标度修订）：`AsteroidFragmentConfig` 新增 `radiation_emission_scale` 与 `radiation_radius_exponent`，默认分别为 `1e-9` 与 `3.0`。
- 完成内容：将辐射发射估算改为可配置标度公式 `emission = radius_cm^exponent * scale * material_factor`，替换原线性近似。
- 完成内容：新增回归测试 `asteroid_fragment_emission_scales_with_radius_exponent`，验证半径翻倍时发射显著上升。
- 完成内容：更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 状态，C2 标记为已完成并切换下一优先项到 C3。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_emission_scales_with_radius_exponent -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C3（采集场模型对齐：近邻源 + 背景场，含距离项）。
# 任务日志
- 日期：2026-02-07
- 完成内容：新增 `world_llm_agent_demo` 可运行入口（`AgentRunner + LlmAgentBehavior`），默认场景 `llm_bootstrap`，支持 `--scenario/--ticks` 参数
- 完成内容：补充 `world_llm_agent_demo` 命令行解析单元测试（默认参数、别名场景、ticks 校验）
- 完成内容：更新 LLM 行为设计/项目管理文档与总项目管理文档状态，补充 README 运行说明
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo`
- 完成内容：运行验证 `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- --help`
- 完成内容：提交到 git（LLM demo 可运行闭环）
- 遗留事项：无
- 日期：2026-02-07
- 完成内容：viewer UI 新增 Agent 活动面板（按 Agent 展示位置、电力、最近动作）
- 完成内容：3D 视图新增世界背景参照（空间边界盒 + 地板网格）
- 完成内容：拆分 `agent_world_viewer` 代码结构（`main.rs`/`scene_helpers.rs`/`tests.rs`）并将 `main.rs` 控制在 1200 行以内
- 完成内容：更新可视化设计文档与项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：当前 live viewer 仍为内置脚本驱动，尚未切换到 LLM 决策驱动
- 日期：2026-02-07
- 完成内容：`world_viewer_live` 新增 `--llm` 参数，支持在线 viewer server 切换到 LLM 决策驱动（默认保留 script）
- 完成内容：`ViewerLiveServerConfig` 新增决策模式配置（script/llm）并接入 `LiveWorld` 双驱动实现
- 完成内容：新增/更新测试（`world_viewer_live` 参数解析、live config 模式切换、viewer_live_integration 回归）
- 完成内容：更新 LLM 与可视化设计文档/项目管理文档、README 在线运行说明
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world live_server_config_supports_llm_mode`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --test viewer_live_integration --features viewer_live_integration`
- 完成内容：运行验证 `timeout 4s env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --llm --bind 127.0.0.1:5019 --tick-ms 300`
- 完成内容：提交到 git（live viewer LLM 决策驱动）
- 遗留事项：LLM 模式的 live 集成测试尚未引入网络 Mock（当前仅验证启动链路）
- 日期：2026-02-07
- 完成内容：修复 viewer 多相机渲染歧义（3D/UI Camera 默认同 order）导致的 Camera order ambiguities 警告
- 完成内容：为 3D/2D 相机显式设置 `Camera.order`（3D=0, UI=1），避免 RenderTarget 优先级冲突
- 完成内容：更新可视化设计文档与项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 完成内容：提交到 git（viewer camera order 修复）
- 遗留事项：暂无
- 日期：2026-02-07
- 完成内容：修复 `agent_world_viewer` 3D 轨道相机交互失效问题，将输入从 `MouseMotion` 改为基于光标位置差值（cursor delta）
- 完成内容：新增 3D 交互映射（左键旋转、右键/中键平移、`Shift+左键` 平移、滚轮缩放），并限定仅在 3D 视口生效
- 完成内容：拆分相机控制到 `crates/agent_world_viewer/src/camera_controls.rs`，将 `main.rs` 控制在 1200 行以内
- 完成内容：新增相机控制单元测试（drag delta / orbit input）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：请在本地窗口环境手动验证鼠标与触控板交互体验
- 日期：2026-02-07
- 完成内容：在 `AGENTS.md` 增加“Agent 专用 UI 截图闭环调试”说明（Xvfb + ffmpeg + viewer/server）
- 完成内容：沉淀标准调试步骤（启动、抓图、读取、清理）与故障排查要点（黑屏/窗口坐标/首帧时机）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：后续可按需封装为脚本 `scripts/capture-viewer-frame.sh`
- 日期：2026-02-07
- 完成内容：新增 `scripts/capture-viewer-frame.sh`，封装 viewer 截图闭环调试（live server + Xvfb + viewer + root/window 截图）
- 完成内容：脚本默认每次调试前清空 `.tmp/`，并支持 `--keep-tmp` 保留临时产物
- 完成内容：新增 `doc/scripts/capture-viewer-frame.md` 与 `doc/scripts/capture-viewer-frame.project.md`，沉淀流程、参数与里程碑
- 完成内容：更新 `AGENTS.md`（优先脚本）与 `README.md`（脚本入口说明）
- 完成内容：更新 `.gitignore`，明确 `.tmp/` 不纳入 git 追踪
- 完成内容：运行验证 `./scripts/capture-viewer-frame.sh --help`
- 完成内容：运行验证 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5031 --tick-ms 300 --viewer-wait 3`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：后续可按需增加“多帧抓图”模式与自动输入注入能力
- 日期：2026-02-07
- 完成内容：按约定移除 `README.md` 中“Agent 调试截图（给 Codex）”重复说明，仅保留 `AGENTS.md` 作为 agent 调试流程入口
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：无
- 日期：2026-02-07
- 完成内容：新增 viewer 选中对象详情面板（Agent/Location），点击 3D 对象可显示详细信息（位置/资源/电力热状态/最近事件）
- 完成内容：为 LLM 模式打通决策 trace 链路：`LlmAgentBehavior` 采集输入输出，live server 下发 `ViewerResponse::DecisionTrace`
- 完成内容：详情面板接入最近 LLM 输入输出（`llm_input`/`llm_output`）及错误信息（`llm_error`/`parse_error`）
- 完成内容：新增/更新测试（LLM trace、协议 round-trip、viewer 详情文案、decision trace 消息收集）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`
- 遗留事项：若后续详情文本继续增长，可补“折叠/分页”与“多帧 trace 检索”
- 日期：2026-02-07
- 完成内容：在可视化相关设计文档中补充“希望通过可视化能以最直接的方式获取所有模拟相关的信息”原则（M5/M6/详情面板）
- 完成内容：在 `doc/world-simulator/visualization.md` 新增“现状缺口（信息直达视角）”清单，覆盖对象覆盖、时序定位、事件联动、LLM 诊断维度、世界覆盖层与信息导出
- 完成内容：更新可视化项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：按缺口清单推进 Asset/设施类对象详情与时间轴回看能力
- 日期：2026-02-07
- 完成内容：viewer 选中详情对象覆盖扩展到 Asset/PowerPlant/PowerStorage（含 3D marker、点击选中、详情文案）
- 完成内容：Asset 详情新增归属者信息与归属者相关事件；PowerPlant/PowerStorage 详情新增设施参数与电力事件
- 完成内容：更新可视化与详情面板设计文档/项目管理文档，修正信息直达缺口清单状态（仅剩 Chunk 详情）
- 完成内容：新增/更新 headless UI 测试（Asset 详情、PowerPlant 详情）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：补齐 Chunk 详情与时间轴回看能力

- 日期：2026-02-07
- 完成内容：viewer 选中详情补齐 Chunk 对象（3D marker、点击选中、详情文案）
- 完成内容：Chunk 详情新增坐标/状态/边界/预算摘要与 ChunkGenerated 事件显示
- 完成内容：更新可视化/详情面板设计文档与项目管理文档（对象覆盖缺口清零）
- 完成内容：新增 headless UI 测试（Chunk 详情）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：推进时间轴回看与对象-事件联动
- 日期：2026-02-07
- 完成内容：在线模式 `ViewerControl::Seek` 支持任意 tick（历史 tick 走 reset+replay，未来 tick 走前向推进）
- 完成内容：`LiveWorld` 新增 `seek_to_tick`，并增加不可达保护（连续停滞阈值后返回 error，避免无限循环）
- 完成内容：seek 完成后统一返回目标时刻 `Snapshot + Metrics`，并在不可达时追加错误消息
- 完成内容：补充 live seek 单元测试（前进 seek、回退 seek、无动作场景停滞保护）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态（时间轴语义与缺口清单）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world live_world_seek -- --nocapture`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --test viewer_live_integration --features viewer_live_integration`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
- 遗留事项：viewer UI 仍仅有 `Seek 0` 按钮，后续需补目标 tick 输入/时间轴拖拽
- 日期：2026-02-07
- 完成内容：viewer 顶部控制区新增时间轴 UI（`Timeline` 状态文本 + `-100/-10/-1/+1/+10/+100` 微调 + `Seek Target`）
- 完成内容：新增时间轴拖拽条（scrub bar），按住拖拽可连续设置目标 tick 并发送 seek
- 完成内容：新增 `crates/agent_world_viewer/src/timeline_controls.rs`，独立管理时间轴状态同步/输入处理/UI 渲染
- 完成内容：为保持单文件行数约束，将控制按钮处理下沉至 `timeline_controls`，`main.rs` 保持在 1200 行以内
- 完成内容：补充 headless UI 测试（时间轴按钮 seek、拖拽映射、状态文案/进度条渲染）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态（时间轴 UI 已落地）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：时间轴暂未展示关键事件密度与标签（错误/LLM 决策/资源峰值）
- 日期：2026-02-07
- 完成内容：viewer 时间轴新增关键事件标注摘要（`err/llm/peak` 计数 + 对应 tick 列表）
- 完成内容：viewer 时间轴新增事件密度 sparkline（按 tick 分桶）用于识别事件高密度区间
- 完成内容：新增资源峰值提取规则（`ResourceTransferred/RadiationHarvested/CompoundRefined/Power*` 权重）
- 完成内容：补充 `timeline_controls` 模块单元测试（关键事件提取、密度分布、tick 列表压缩）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态（时间轴关键标注已落地）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：时间轴标注尚未支持点击后联动跳转到事件列表上下文
- 日期：2026-02-07
- 完成内容：时间轴新增 `Jump Err/LLM/Peak` 标注联动按钮，点击后定位到下一关键 tick
- 完成内容：事件列表支持按目标 tick 显示上下文窗口，并高亮最近事件（`>>`）
- 完成内容：`update_ui` 接入 timeline 手动目标联动，使时间轴与事件上下文保持一致
- 完成内容：补充 `timeline_controls` 跳转逻辑单测与 `ui_text` 事件上下文摘要单测
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态（标注联动任务完成）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：后续可补“标注类别开关/筛选”与“点击事件反向定位对象”
- 日期：2026-02-07
- 完成内容：viewer 时间轴新增事件类别独立开关（Err/LLM/Peak），支持分别开/关关键标注
- 完成内容：时间轴关键标注跳转与摘要统计按类别开关过滤（禁用类别后不再计数/跳转）
- 完成内容：新增 `timeline_controls` 单元测试（类别开关切换、禁用类别下跳转保护）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：继续推进“事件与对象双向联动（事件定位对象、对象跳转事件上下文）”
- 日期：2026-02-07
- 完成内容：viewer 新增事件与对象双向联动入口（`Locate Focus Event Object` / `Jump Selection Events`）
- 完成内容：实现 `focus event -> 3D selection` 定位链路（含 Agent/Location/设施/Chunk/owner 映射与降级提示）
- 完成内容：实现 `selection -> timeline` 跳转链路（按对象筛选相关事件并跳转下一 tick）
- 完成内容：重构 3D 选中逻辑到 `selection_linking.rs`，并保留高亮行为
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态
- 完成内容：新增联动单元测试（映射、跳转、按钮行为）并通过 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：补充 LLM 诊断字段（模型、耗时、token、重试）
- 完成内容：落地 C3（采集场模型对齐）：`HarvestRadiation` 改为“近邻源贡献 + 远场背景 + radiation_floor”叠加，并引入距离项与介质吸收项。
- 完成内容：新增测试 `harvest_radiation_includes_nearby_sources_and_distance_decay` 与 `harvest_radiation_uses_background_floor_when_no_source`。
- 完成内容：调整既有测试 `harvest_radiation_adds_electricity` 的可用辐射断言，匹配 background floor 纳入后的口径。
- 完成内容：更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 状态，C3 标记完成并切换下一优先项到 C4。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world harvest_radiation_includes_nearby_sources_and_distance_decay -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world harvest_radiation_uses_background_floor_when_no_source -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C4（背景辐射守恒说明：`radiation_floor` 来源与边界）。
- 日期：2026-02-07
- 完成内容：落地 C4（背景辐射守恒说明）：`PhysicsConfig` 新增 `radiation_floor_cap_per_tick`（默认 5），将 `radiation_floor` 明确为外部背景通量并对 floor 贡献执行 `min(radiation_floor, radiation_floor_cap_per_tick)` 限幅。
- 完成内容：新增测试 `harvest_radiation_caps_background_floor_when_no_source`，覆盖“零源场景 floor 限幅”路径。
- 完成内容：更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 状态，C4 标记完成并切换下一优先项到 C5。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world harvest_radiation_caps_background_floor_when_no_source -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C5（运动学约束补齐：最大位移/速度上限）。
- 日期：2026-02-07
- 完成内容：落地 C5（运动学约束补齐）：`PhysicsConfig` 新增 `max_move_distance_cm_per_tick` 与 `max_move_speed_cm_per_s`（默认 10km/tick 与 1km/s，保守口径）。
- 完成内容：`MoveAgent` 增加双重约束校验（位移上限 + 速度上限），超限分别返回 `MoveDistanceExceeded` 与 `MoveSpeedExceeded`。
- 完成内容：新增测试 `kernel_rejects_move_beyond_max_distance_per_tick` 与 `kernel_rejects_move_beyond_max_speed`，覆盖 C5 两条拒绝路径。
- 完成内容：为长距离回放/viewer demo 用例显式配置更高移动上限，避免与新默认保守阈值冲突。
- 完成内容：更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 状态，C5 标记完成并切换下一优先项到 C6。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rejects_move_beyond_max_distance_per_tick -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world kernel_rejects_move_beyond_max_speed -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world action_chunk_generation_consumes_boundary_reservations -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world replay_from_snapshot_rebuilds_and_validates_chunk_generated_events -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world replay_with_budget_caps_keeps_chunk_generated_consistent -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C6（能耗参数重标定：`time_step_s`/`power_unit_j`/移动能耗联动）。
- 日期：2026-02-07
- 完成内容：落地 C6（能耗参数重标定）：将 `move_cost_per_km_electricity` 定义为参考口径（10s tick + 1kJ 电力单位）下的基准系数，并在 `WorldConfig::movement_cost` 中按 `time_step_s` 与 `power_unit_j` 自动缩放。
- 完成内容：`MoveAgent` 统一改为使用 `WorldConfig::movement_cost`，确保行动路径与 viewer 估算使用同一能耗口径。
- 完成内容：新增测试 `movement_cost_scales_with_time_step_and_power_unit` 与 `movement_cost_uses_calibrated_per_km_in_move_action`，覆盖参数联动与动作路径两条回归。
- 完成内容：更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 状态，C6 标记完成并切换下一优先项到 C7。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world movement_cost_scales_with_time_step_and_power_unit -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world movement_cost_uses_calibrated_per_km_in_move_action -- --nocapture`（通过）。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C7（热模型升级：与温差相关的散热模型）。
- 日期：2026-02-07
- 完成内容：落地 C7（热模型升级）：`PhysicsConfig` 新增 `thermal_dissipation_gradient_bps`，将散热从固定常数改为“热量占比 × 梯度系数”的温差相关模型。
- 完成内容：`process_power_tick` 改为按当前热量动态计算散热量，高热状态散热更快、低热状态散热更慢；散热使用饱和减法，避免出现负热量。
- 完成内容：新增测试 `power_tick_dissipates_more_heat_when_hotter` 与 `power_tick_thermal_dissipation_never_makes_heat_negative`。
- 完成内容：更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 状态，C7 标记完成并切换下一优先项到 C8。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world power_tick_dissipates_more_heat_when_hotter -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world power_tick_thermal_dissipation_never_makes_heat_negative -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world harvest_radiation_applies_thermal_penalty -- --nocapture`（通过）。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C8（成分与放射性分布校准）。
- 日期：2026-02-07
- 完成内容：落地 C8（成分与放射性分布校准）：`AsteroidFragmentConfig` 默认材质占比调整为 `52/8/18/18/4`（silicate/metal/ice/carbon/composite），将高放射候选（metal+composite）默认占比收敛到 12%。
- 完成内容：新增 `material_radiation_factors`（bps）配置并接入碎片发射计算链路；默认 `radiation_emission_scale` 下调到 `1e-12`，默认场景回归“多数可采但非普遍高危”。
- 完成内容：新增测试 `asteroid_fragment_default_mix_is_conservative_for_high_radiation_materials`、`asteroid_fragment_default_calibration_keeps_small_silicate_non_extreme`、`asteroid_fragment_default_calibration_preserves_high_radiation_outliers`、`init_default_fragment_radiation_distribution_is_conservative`。
- 完成内容：更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md`，将 C8 标记完成并切换下一优先项到 C9。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_default_mix_is_conservative_for_high_radiation_materials -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_default_calibration_keeps_small_silicate_non_extreme -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_default_calibration_preserves_high_radiation_outliers -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world init_default_fragment_radiation_distribution_is_conservative -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 C9（物理参数表固化：单位/范围/调参影响）。
- 日期：2026-02-07
- 完成内容：落地 C9（物理参数表固化）：在 `world_model` 新增 `PhysicsParameterSpec` 与 `physics_parameter_specs()`，固定 `PhysicsConfig` 全量参数的单位、推荐范围与调参影响。
- 完成内容：新增测试 `physics_parameter_specs_cover_serialized_physics_config_fields` 与 `physics_parameter_specs_define_units_ranges_and_default_coverage`，约束“字段覆盖、单位非空、范围有效、默认值在推荐区间内”。
- 完成内容：更新 `doc/world-simulator.md` 参数固化表（C9）与 C9 状态，补齐 `heat_factor` 的范围口径。
- 完成内容：更新 `doc/world-simulator.project.md` 状态，C9 标记完成并切换下一优先项到 T1。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world physics_parameter_specs_cover_serialized_physics_config_fields -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world physics_parameter_specs_define_units_ranges_and_default_coverage -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 T1（单调性测试：距离衰减/过热降效/移动能耗）。
- 日期：2026-02-07
- 完成内容：落地 T1（单调性测试补齐）：新增 `simulator/tests/monotonicity.rs`，覆盖“可采辐射随距离增加而下降”“过热后采集量不增加”“移动能耗随距离非递减”。
- 完成内容：更新 `doc/world-simulator.md` 回归清单，T1 标记完成并补充验收说明。
- 完成内容：更新 `doc/world-simulator.project.md` 状态，拆分为 `T1` 已完成、`T2-T4` 待完成，并切换下一优先项到 T2。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world harvest_radiation_available_decreases_with_distance -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world harvest_radiation_amount_does_not_increase_when_overheated -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world movement_cost_is_non_decreasing_with_distance -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 T2（守恒性测试：资源账本与加工/采集无凭空增益）。
- 日期：2026-02-07
- 完成内容：落地 T2（守恒性测试补齐）：新增 `simulator/tests/conservation.rs`，覆盖“fragment/chunk 预算边界保持 `0 <= remaining <= total`”与“采集+加工账本等式（无凭空增益）”。
- 完成内容：更新 `doc/world-simulator.md` 回归清单，T2 标记完成并补充验收说明。
- 完成内容：更新 `doc/world-simulator.project.md` 状态，拆分为 `T2` 已完成、`T3-T4` 待完成，并切换下一优先项到 T3。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world fragment_and_chunk_budgets_stay_within_total_bounds_after_consumption -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world harvest_and_refine_follow_resource_ledger_without_free_gain -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 T3（一致性测试：同 seed + 同动作序列在快照恢复与回放路径一致）。
- 日期：2026-02-07
- 完成内容：落地 T3（一致性测试补齐）：新增 `simulator/tests/consistency.rs`，覆盖“同 seed + 同动作序列”在 `replay_from_snapshot` 与 `from_snapshot` 路径下模型一致。
- 完成内容：更新 `doc/world-simulator.md` 回归清单，T3 标记完成并补充验收说明。
- 完成内容：更新 `doc/world-simulator.project.md` 状态，拆分为 `T3` 已完成、`T4` 待完成，并切换下一优先项到 T4。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world replay_from_snapshot_matches_same_seed_and_action_sequence -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：继续执行 T4（边界测试：极端参数下系统稳定性）。
- 日期：2026-02-07
- 完成内容：落地 T4（边界测试补齐）：新增 `simulator/tests/boundary_extremes.rs`，覆盖极端半径（`1cm`/`5_000_000cm`）、`spacing=0`、高密度配置与预算上限场景下的生成/初始化稳定性。
- 完成内容：更新 `doc/world-simulator.md` 回归清单，T4 标记完成，并将 PC3 里程碑状态更新为已完成。
- 完成内容：更新 `doc/world-simulator.project.md` 状态，T4 标记完成并声明“背景故事物理一致性清单已收口”。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_generator_handles_extreme_radius_density_and_spacing -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world world_init_survives_extreme_fragment_generation_with_budget_caps -- --nocapture`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 遗留事项：背景故事物理一致性修订清单（C1-C9、T1-T4）已完成，后续按 M4 主线推进。
- 日期：2026-02-07
- 完成内容：扩展 `AgentDecisionTrace` 诊断字段（`model/latency_ms/prompt_tokens/completion_tokens/total_tokens/retry_count`）
- 完成内容：`LlmAgentBehavior` 接入诊断采集（OpenAI 响应模型与 token usage + 请求耗时；当前重试计数为 0）
- 完成内容：viewer 详情面板新增诊断字段展示（Recent LLM I/O 下追加 model/latency/tokens/retries）
- 完成内容：更新可视化与详情面板设计文档/项目管理文档、总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world viewer_response_round_trip_decision_trace`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：补充世界覆盖层（chunk 探索态、资源热力图、电力/交易流）

- 日期：2026-02-07
- 完成内容：viewer 新增世界覆盖层控制与状态摘要（Chunk/Heat/Flow 三开关 + 状态文本）
- 完成内容：3D 场景接入 chunk 可见性切换、地点资源热力柱（electricity/hardware/data 强度映射）
- 完成内容：3D 场景接入电力/交易流向连线（基于近期 `PowerTransferred/ResourceTransferred` 事件）
- 完成内容：新增 `world_overlay.rs` 并补充单元测试（状态摘要、流向提取、开关按钮）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：继续推进“选中对象状态与 trace 的一键导出”

- 日期：2026-02-07
- 完成内容：viewer 顶部新增 `Export Selection`，支持一键导出当前选中对象状态与 trace
- 完成内容：新增 `selection_export.rs`，导出结构化 JSON（selection metadata + selection_state + related_events + decision_traces + details_text）
- 完成内容：导出目录默认 `.tmp/selection-exports/`，支持 `AGENT_WORLD_VIEWER_EXPORT_DIR` 覆盖
- 完成内容：补充导出功能单元测试（导出文档构建、按钮错误提示、文件写入）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：继续补齐“事件列表逐条点击定位对象”与“导出复制到剪贴板”

- 日期：2026-02-07
- 完成内容：事件面板新增可点击事件行（按 focus tick 上下文窗口展示）
- 完成内容：点击事件行可直接触发“时间轴跳转 + 3D 对象定位/高亮”（Click Event -> Select Object）
- 完成内容：复用事件主对象映射规则（Agent/Location/设施/Chunk/owner），并接入联动状态反馈文案
- 完成内容：新增 `event_click_list.rs` 模块，并与现有 `selection_linking` 映射逻辑打通
- 完成内容：新增单元测试（事件窗口聚焦、点击定位成功、无映射事件降级）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：可继续补“导出内容复制到剪贴板”与“事件列表多选筛选导出”

- 日期：2026-02-07
- 完成内容：按新要求移除 viewer JSON 导出能力（`selection_export.rs` 与 `Export Selection` UI）
- 完成内容：新增自动诊断结论面板（`Diagnosis`），问题时直接输出结论，无需人工分析
- 完成内容：诊断优先级落地（连接异常 > LLM 异常 > ActionRejected 原因归纳 > 健康态）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态（导出任务替换为结论直出）
- 完成内容：新增诊断单元测试并通过 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：后续可补“自动根因树 + 修复建议”

- 日期：2026-02-07
- 完成内容：新增出厂电力模块设计与项目文档：`doc/world-runtime/bootstrap-power-modules.md`、`doc/world-runtime/bootstrap-power-modules.project.md`。
- 完成内容：runtime 新增 `World::install_m1_power_bootstrap_modules`，通过治理链路安装 `m1.power.radiation_harvest` 与 `m1.power.storage` 两个预置模块。
- 完成内容：新增 builtin 电力模块实现（低效率辐射发电 + 基础储能/移动约束），并将实现拆分到 `crates/agent_world/src/runtime/builtin_modules/power_modules.rs`，确保 Rust 单文件不超过 1200 行。
- 完成内容：新增测试 `crates/agent_world/src/runtime/tests/power_bootstrap.rs`，覆盖安装激活、幂等、停用后重激活、辐射发电事件与连续移动受限。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo fmt`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::power_bootstrap -- --nocapture`（通过）。
- 遗留事项：下一步可将 simulator 侧“默认电力设施”语义下沉为剧情/场景层配置，避免与 runtime 模块产生双轨默认值。

- 日期：2026-02-07
- 完成内容：落地“默认电力设施语义下沉为场景配置”：新增 `doc/world-simulator/scenario-power-facility-baseline.md` 与 `doc/world-simulator/scenario-power-facility-baseline.project.md`。
- 完成内容：调整内置场景 JSON（`llm_bootstrap`、`twin_region_bootstrap`、`triad_region_bootstrap`、`asteroid_fragment_bootstrap`、`asteroid_fragment_twin_region_bootstrap`、`asteroid_fragment_triad_region_bootstrap`），移除默认 `power_plants/power_storages`。
- 完成内容：保留 `power_bootstrap` 作为显式设施场景，确保“设施存在”由场景文件显式声明而非默认注入。
- 完成内容：更新 `crates/agent_world/src/simulator/tests/init.rs` 断言与场景稳定性矩阵（非专项场景默认无设施）。
- 完成内容：更新 `doc/world-simulator/scenario-files.md` 场景测试矩阵描述（同步新的默认设施口径）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo fmt`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::init -- --nocapture`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world --test world_init_demo -- --nocapture`（通过）。
- 遗留事项：后续可按需补充“带设施”派生场景（如 `*_with_power_facilities`）用于 viewer 流向演示，避免与默认基线混淆。

- 日期：2026-02-07
- 完成内容：新增《WASM 模块驱动新事物的通用可视实体机制》设计与项目文档（`doc/world-simulator/module-visual-entities.md`、`doc/world-simulator/module-visual-entities.project.md`）。
- 完成内容：simulator 新增 `ModuleVisualEntity` 通用链路，接入 `WorldModel`、`WorldInitConfig`、`WorldScenarioSpec`、`Action`、`WorldEventKind` 与 replay（upsert/remove）。
- 完成内容：将 `init.rs` 中模块可视实体校验/插入逻辑拆分到 `init_module_visual.rs`，保持 Rust 单文件不超过 1200 行。
- 完成内容：viewer 新增模块可视实体通用渲染（snapshot + 增量事件），并在详情面板支持展示 `module_visual_entities` 基础信息。
- 完成内容：新增 `simulator/tests/module_visual.rs`，覆盖初始化锚点校验、内核 upsert/remove、快照回放一致性。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world -p agent_world_viewer`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::module_visual -- --nocapture`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过）。
- 遗留事项：后续可补齐“模块可视实体事件 -> 对象联动”在事件点击面板中的主目标映射。
- 完成内容：提交 git commit `83aadd5`（feat(viewer): add wasm module visual entities pipeline）。
- 日期：2026-02-07
- 完成内容：补齐模块可视实体事件联动：`ModuleVisualEntityUpserted/Removed` 可从事件列表直接定位到对应对象（Event Click -> Select Object）。
- 完成内容：`selection_linking` 资产目标查找支持 `module_visual_entities` 回退映射，模块可视实体可被联动聚焦。
- 完成内容：右侧信息区新增滚动条与滚轮滚动能力，长详情/长事件列表可连续浏览。
- 完成内容：为控制 Rust 文件行数，将 `selection_linking` 测试拆分到 `selection_linking/tests.rs`，保持主文件不超过 1200 行。
- 完成内容：新增/更新测试：`event_click_maps_module_visual_event_to_scene_entity`、`scroll_tests`（滚轮像素换算/右侧命中）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过）。
- 遗留事项：可按需将右侧滚动细化为“各信息块独立滚动”。
- 日期：2026-02-07
- 完成内容：排查并修复 viewer 右侧 UI 面板重叠根因：将“顶部固定区 + 下部详情区”从固定高度叠加改为 flex 增长 + 可滚动容器，避免 `height=100%` 与固定高度共存导致的覆盖。
- 完成内容：优化右侧布局与样式：统一卡片层级（背景/边框/间距），顶部控制区支持纵向滚动，详情区保持滚轮滚动浏览。
- 完成内容：优化窄面板排版：事件联动控制区、时间轴筛选/跳转/seek 按钮区改为 `flex_wrap` 可换行，避免按钮横向挤压重叠。
- 完成内容：新增 UI 回归测试 `selection_linking::tests::event_object_link_controls_use_wrapping_layout`，防止事件联动按钮区回退为不可换行布局。
- 完成内容：更新设计文档/项目管理文档与总项目管理文档状态（`viewer-selection-details*`、`visualization.project.md`、`world-simulator.project.md`）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过）。
- 遗留事项：后续可补充“顶部控制区/详情区独立折叠开关”和滚动条视觉主题定制。
- 日期：2026-02-07
- 完成内容：确认 `capture-viewer-frame.sh` 原实现仅适配 Linux（`Xvfb/xwininfo/ffmpeg`），在 macOS 上无法直接运行。
- 完成内容：补充跨平台截图设计与项目文档（`doc/scripts/capture-viewer-frame.md`、`doc/scripts/capture-viewer-frame.project.md`），新增 M4（平台分支实现）。
- 完成内容：重构 `scripts/capture-viewer-frame.sh` 为平台分支流程：Linux 继续使用 `Xvfb + xwininfo + ffmpeg`，macOS 使用 `screencapture + osascript`。
- 完成内容：macOS 分支支持窗口信息 best-effort 识别，若窗口信息不可读则降级为整屏截图回填 `window.png`，保证闭环产物完整。
- 完成内容：保持输出目录与文件命名兼容（`.tmp/screens/{root.png,window.png,window_line.txt,window_geom.txt}`）。
- 完成内容：运行 `bash -n scripts/capture-viewer-frame.sh`（通过）。
- 完成内容：运行 `./scripts/capture-viewer-frame.sh --help`（通过）。
- 遗留事项：后续可在 macOS 增加窗口聚焦与多显示器选择参数，减少整屏回退概率。
- 日期：2026-02-07
- 完成内容：确认 macOS 录屏权限被拒后，`screencapture` 方案抓到错误窗口，无法稳定产出 viewer UI 截图。
- 完成内容：新增 `internal_capture` 模块（`crates/agent_world_viewer/src/internal_capture.rs`），接入 Bevy `Screenshot::primary_window` + `save_to_disk`，支持自动截图并自动退出。
- 完成内容：viewer 支持环境变量驱动内置截图：`AGENT_WORLD_VIEWER_CAPTURE_PATH`、`AGENT_WORLD_VIEWER_CAPTURE_DELAY_SECS`、`AGENT_WORLD_VIEWER_CAPTURE_MAX_WAIT_SECS`。
- 完成内容：脚本 `capture-viewer-frame.sh` 的 macOS 分支改为“进程内截图”链路，不再依赖系统录屏权限；Linux 继续保持 `Xvfb + ffmpeg`。
- 完成内容：补充内置截图单元测试（配置解析、触发条件）并通过。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过）。
- 完成内容：运行 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5038 --tick-ms 300 --viewer-wait 8`（通过，成功产出 `.tmp/screens/window.png`）。
- 遗留事项：后续可补“多帧截图（启动后第 N 帧）”和“自动交互后截图”以提升 UI 回归覆盖。
- 日期：2026-02-07
- 完成内容：按最新 UI 评审意见落地顶部控制区折叠交互：新增 `panel_layout.rs`，提供 `Hide Top/Show Top` 按钮与 `TopPanelContainer` 显隐联动。
- 完成内容：右侧信息密度优化：`timeline/diagnosis/overlay` 等高密度文本区字号下调，`Seek Target` 文案收敛为 `Seek`，提升窄面板可读性。
- 完成内容：将顶部折叠状态纳入 viewer 资源状态（`RightPanelLayoutState`），并接入主更新循环处理交互。
- 完成内容：新增折叠交互单测（`panel_layout::tests::toggle_button_flips_layout_and_updates_label`）并通过。
- 完成内容：更新 `viewer-selection-details*`、`visualization.project.md`、`world-simulator.project.md` 文档状态到 M8。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，58 tests）。
- 完成内容：运行 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5039 --tick-ms 300 --viewer-wait 8`（通过，截图用于 UI 复核）。
- 遗留事项：后续可增加折叠状态持久化（启动记忆上次展开态）与分区级折叠（overlay/timeline 独立折叠）。
- 日期：2026-02-07
- 完成内容：viewer 右侧滚轮分流升级：右侧上半区（Top Controls）支持独立滚动，命中 top band 时优先滚动上半区，未命中则滚动下半区详情。
- 完成内容：新增 `button_feedback.rs`，控制按钮补齐 hover/pressed 视觉反馈，提升可点击性与交互感知。
- 完成内容：`Step` 控制新增等待态：请求发出后按钮文案显示 `Step ...`，并在 tick 前进或错误时自动清除 loading；pending 期间会阻止重复 step 请求。
- 完成内容：重构滚动逻辑到 `panel_scroll.rs`，并新增滚动命中与像素换算单测；补齐 Step loading 状态单测与按钮请求路径测试依赖。
- 完成内容：修复滚动系统 Bevy Query 冲突（B0001）：通过 `Without<T>` 显式拆分 top/bottom 滚动查询，保证运行时稳定。
- 完成内容：更新文档状态（`viewer-selection-details*`、`visualization.project.md`、`world-simulator.project.md`）到本轮 UI 交互优化里程碑。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，61 tests）。
- 完成内容：运行 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5042 --tick-ms 300 --viewer-wait 8`（通过，产出 `.tmp/screens/window.png` 用于 UI 复核）。
- 遗留事项：后续可将顶部滚动命中区从固定像素阈值升级为“按真实布局边界计算”，减少窗口尺寸变化时的经验参数依赖。
- 日期：2026-02-07
- 完成内容：修复右侧滚轮“上下半区随机串滚”问题：滚动命中从固定像素阈值改为基于 `ComputedNode + UiGlobalTransform` 的实际 UI 边界判定。
- 完成内容：光标坐标统一为 physical pixel（`physical_cursor_position`，并保留逻辑坐标回退乘 scale），避免高 DPI 下命中漂移。
- 完成内容：补充/更新 `panel_scroll` 单测，覆盖可见性与边界命中行为。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer panel_scroll -- --nocapture`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，60 tests）。
- 遗留事项：可继续补一条 UI 集成测试（模拟不同窗口缩放比）防止后续回归。
- 日期：2026-02-07
- 完成内容：新增《Viewer UI 多语言支持设计（中文 / 英文）》文档，路径 `doc/world-simulator/viewer-i18n.md`，明确目标、范围、接口/数据、里程碑与风险。
- 完成内容：新增对应项目管理文档 `doc/world-simulator/viewer-i18n.project.md`，完成 I18N 任务拆解、依赖与阶段状态定义。
- 完成内容：按产品要求将多语言策略调整为“仅界面切换，不提供命令行参数”，并明确默认语言为中文（`zh-CN`）。
- 完成内容：执行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer toggle_label_reflects_state -- --nocapture`（通过）。
- 遗留事项：I18N1-I18N10 尚未实现代码迁移，下一步优先执行 I18N1（默认中文 + UI 语言切换状态与 `UiLocale` / `UiI18n` 资源）。
- 日期：2026-02-07
- 完成内容：实现 viewer UI 多语言资源 `UiLocale/UiI18n`，默认中文（`zh-CN`），并新增界面切换按钮（中文/English）。
- 完成内容：顶部控制区新增语言切换入口，切换后同步刷新控制按钮、Top 标题、折叠按钮、时间轴按钮、联动按钮、覆盖层按钮文案。
- 完成内容：将状态/选择/摘要/事件/详情/诊断/时间轴/联动/覆盖层文本接入本地化渲染（`zh-CN` 与 `en-US`）。
- 完成内容：新增 `i18n.rs` 与 `ui_locale_text.rs` 并完成相关单元测试；补充 `panel_layout` 语言切换行为测试。
- 完成内容：代码结构调整：新增 `control_labels.rs`，将 `main.rs` 控制在 1200 行以内。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，65 tests）。
- 遗留事项：I18N9-I18N10 待完成（收口文档状态与提交）。
- 日期：2026-02-07
- 完成内容：修复 Bevy 运行时 `B0001` 查询冲突（`update_event_object_link_button_labels` 同时可变查询 `Text`）。
- 完成内容：将该系统改为 `ParamSet` 分离查询，消除 `Query<&mut Text>` 冲突导致的 panic。
- 完成内容：新增回归测试 `event_object_link_button_labels_follow_locale_without_query_conflict`，覆盖语言切换场景。
- 完成内容：运行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，66 tests）。
- 遗留事项：无。
- 日期：2026-02-07
- 完成内容：修复 viewer 中文显示为方块字问题：将 UI 与 3D 标签字体从 `DejaVuSans.ttf` 切换为 `ms-yahei.ttf`（`crates/agent_world_viewer/assets/fonts/ms-yahei.ttf`）。
- 完成内容：保持默认语言为中文（`UiI18n::default()`），本次仅修复字体资源与加载路径，不引入命令行参数。
- 完成内容：执行截图闭环调试 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5052 --tick-ms 300 --viewer-wait 8`，确认中文文本渲染正常。
- 完成内容：运行检查 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，66 tests）。
- 遗留事项：无。
- 日期：2026-02-07
- 完成内容：新增《3D 渲染物理准确性设计（尺寸对齐真实物理数据）》文档（`doc/world-simulator/rendering-physical-accuracy.md`），补齐目标、范围、接口/数据、里程碑、风险。
- 完成内容：新增对应项目管理文档（`doc/world-simulator/rendering-physical-accuracy.project.md`），拆解 RPA-1~RPA-8 任务与依赖。
- 完成内容：更新总项目管理文档（`doc/world-simulator.project.md`），增加“3D 渲染物理准确性”任务分册入口。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer --no-run`（通过）。
- 遗留事项：待进入实现阶段，下一优先项为 RPA-1（viewer 物理渲染配置结构落地）。
- 日期：2026-02-07
- 完成内容：落地 RPA-1：新增 `crates/agent_world_viewer/src/viewer_3d_config.rs`，定义 `ViewerPhysicalRenderConfig`（单位/精度/光照/曝光/辐射显示基线）与 `Viewer3dConfig` 统一资源。
- 完成内容：接入环境变量解析（`AGENT_WORLD_VIEWER_PHYSICAL_RENDER_ENABLED` 等）并加入合法性保护（正值约束、near/far 自动校正）。
- 完成内容：将场景坐标缩放统一切换为 `effective_cm_to_unit()`（支持物理模式 `1unit=1m` 与兼容模式共存），覆盖背景、地点、Agent、设施、资产、chunk、overlay。
- 完成内容：3D 相机接入 `camera_near_m/camera_far_m`，主光源强度接入 `irradiance = 1361/d^2` 与曝光参数（`exposure_ev100`）估算。
- 完成内容：新增配置单测（默认值、环境覆盖、非法值回退、尺度与辐照度计算）并通过。
- 完成内容：更新文档状态（`doc/world-simulator/rendering-physical-accuracy.project.md`、`doc/world-simulator.project.md`），标记 RPA-1 完成并切换下一优先项到 RPA-2。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，70 tests）。
- 遗留事项：下一步执行 RPA-2，将实体几何尺寸与 `radius_cm/height_cm` 进行全链路实尺度对齐。
- 日期：2026-02-07
- 完成内容：落地 RPA-2：Location 渲染尺寸改为由 `location.profile.radius_cm` 直接驱动（cm→m），不再固定 1.2u 标记大小。
- 完成内容：落地 RPA-2：Agent 渲染尺寸改为由 `agent.body.height_cm` 推导，并在 `Viewer3dScene` 维护 `agent_heights_cm` 以支持增量事件更新。
- 完成内容：将 `location_mesh` 改为单位球体并结合 `BaseScale` 动态缩放，保证选中高亮与恢复在实尺模式下仍一致。
- 完成内容：补充回归测试 `spawn_location_entity_uses_physical_radius_scale` 与 `spawn_agent_entity_uses_body_height_scale`，校验实体尺寸映射。
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，72 tests）。
- 完成内容：更新 `doc/world-simulator/rendering-physical-accuracy.project.md`，将 RPA-2 标记完成并切换下一优先项到 RPA-3。
- 遗留事项：下一步执行 RPA-3（floating origin + 裁剪面与大场景精度稳定性）。
