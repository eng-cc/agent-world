# 任务日志
- 日期：2026-02-07
- 完成内容：新增 `world_llm_agent_demo` 可运行入口（`AgentRunner + LlmAgentBehavior`），默认场景 `llm_bootstrap`，支持 `--scenario/--ticks` 参数
- 完成内容：补充 `world_llm_agent_demo` 命令行解析单元测试（默认参数、别名场景、ticks 校验）
- 完成内容：更新 LLM 行为设计/项目管理文档与总项目管理文档状态，补充 README 运行说明
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo`
- 完成内容：运行验证 `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- --help`
- 完成内容：提交到 git（LLM demo 可运行闭环）
- 遗留事项：无
- 日期：2026-02-07
- 完成内容：viewer UI 新增 Agent 活动面板（按 Agent 展示位置、电力、最近动作）
- 完成内容：3D 视图新增世界背景参照（空间边界盒 + 地板网格）
- 完成内容：拆分 `agent_world_viewer` 代码结构（`main.rs`/`scene_helpers.rs`/`tests.rs`）并将 `main.rs` 控制在 1200 行以内
- 完成内容：更新可视化设计文档与项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：当前 live viewer 仍为内置脚本驱动，尚未切换到 LLM 决策驱动
- 日期：2026-02-07
- 完成内容：`world_viewer_live` 新增 `--llm` 参数，支持在线 viewer server 切换到 LLM 决策驱动（默认保留 script）
- 完成内容：`ViewerLiveServerConfig` 新增决策模式配置（script/llm）并接入 `LiveWorld` 双驱动实现
- 完成内容：新增/更新测试（`world_viewer_live` 参数解析、live config 模式切换、viewer_live_integration 回归）
- 完成内容：更新 LLM 与可视化设计文档/项目管理文档、README 在线运行说明
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world live_server_config_supports_llm_mode`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world --test viewer_live_integration --features viewer_live_integration`
- 完成内容：运行验证 `timeout 4s env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --llm --bind 127.0.0.1:5019 --tick-ms 300`
- 完成内容：提交到 git（live viewer LLM 决策驱动）
- 遗留事项：LLM 模式的 live 集成测试尚未引入网络 Mock（当前仅验证启动链路）
- 日期：2026-02-07
- 完成内容：修复 viewer 多相机渲染歧义（3D/UI Camera 默认同 order）导致的 Camera order ambiguities 警告
- 完成内容：为 3D/2D 相机显式设置 `Camera.order`（3D=0, UI=1），避免 RenderTarget 优先级冲突
- 完成内容：更新可视化设计文档与项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 完成内容：提交到 git（viewer camera order 修复）
- 遗留事项：暂无
- 日期：2026-02-07
- 完成内容：修复 `agent_world_viewer` 3D 轨道相机交互失效问题，将输入从 `MouseMotion` 改为基于光标位置差值（cursor delta）
- 完成内容：新增 3D 交互映射（左键旋转、右键/中键平移、`Shift+左键` 平移、滚轮缩放），并限定仅在 3D 视口生效
- 完成内容：拆分相机控制到 `crates/agent_world_viewer/src/camera_controls.rs`，将 `main.rs` 控制在 1200 行以内
- 完成内容：新增相机控制单元测试（drag delta / orbit input）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：请在本地窗口环境手动验证鼠标与触控板交互体验
- 日期：2026-02-07
- 完成内容：在 `AGENTS.md` 增加“Agent 专用 UI 截图闭环调试”说明（Xvfb + ffmpeg + viewer/server）
- 完成内容：沉淀标准调试步骤（启动、抓图、读取、清理）与故障排查要点（黑屏/窗口坐标/首帧时机）
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：后续可按需封装为脚本 `scripts/capture-viewer-frame.sh`
- 日期：2026-02-07
- 完成内容：新增 `scripts/capture-viewer-frame.sh`，封装 viewer 截图闭环调试（live server + Xvfb + viewer + root/window 截图）
- 完成内容：脚本默认每次调试前清空 `.tmp/`，并支持 `--keep-tmp` 保留临时产物
- 完成内容：新增 `doc/scripts/capture-viewer-frame.md` 与 `doc/scripts/capture-viewer-frame.project.md`，沉淀流程、参数与里程碑
- 完成内容：更新 `AGENTS.md`（优先脚本）与 `README.md`（脚本入口说明）
- 完成内容：更新 `.gitignore`，明确 `.tmp/` 不纳入 git 追踪
- 完成内容：运行验证 `./scripts/capture-viewer-frame.sh --help`
- 完成内容：运行验证 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5031 --tick-ms 300 --viewer-wait 3`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：后续可按需增加“多帧抓图”模式与自动输入注入能力
- 日期：2026-02-07
- 完成内容：按约定移除 `README.md` 中“Agent 调试截图（给 Codex）”重复说明，仅保留 `AGENTS.md` 作为 agent 调试流程入口
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：无
- 日期：2026-02-07
- 完成内容：新增 viewer 选中对象详情面板（Agent/Location），点击 3D 对象可显示详细信息（位置/资源/电力热状态/最近事件）
- 完成内容：为 LLM 模式打通决策 trace 链路：`LlmAgentBehavior` 采集输入输出，live server 下发 `ViewerResponse::DecisionTrace`
- 完成内容：详情面板接入最近 LLM 输入输出（`llm_input`/`llm_output`）及错误信息（`llm_error`/`parse_error`）
- 完成内容：新增/更新测试（LLM trace、协议 round-trip、viewer 详情文案、decision trace 消息收集）
- 完成内容：更新可视化设计文档/项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world`
- 遗留事项：若后续详情文本继续增长，可补“折叠/分页”与“多帧 trace 检索”
- 日期：2026-02-07
- 完成内容：在可视化相关设计文档中补充“希望通过可视化能以最直接的方式获取所有模拟相关的信息”原则（M5/M6/详情面板）
- 完成内容：在 `doc/world-simulator/visualization.md` 新增“现状缺口（信息直达视角）”清单，覆盖对象覆盖、时序定位、事件联动、LLM 诊断维度、世界覆盖层与信息导出
- 完成内容：更新可视化项目管理文档与总项目管理文档状态
- 完成内容：运行测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：按缺口清单推进 Asset/设施类对象详情与时间轴回看能力
