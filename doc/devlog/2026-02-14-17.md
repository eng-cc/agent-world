# 2026-02-14 任务日志（M4 内置工业模块包与治理装载）

## 日期
- 2026-02-14

## 完成内容
- 在 `agent_world_builtin_wasm` 新增 M4 经济模块实现，覆盖三类模块：
  - 工厂模块：`m4.factory.miner.mk1`、`m4.factory.smelter.mk1`、`m4.factory.assembler.mk1`
  - 配方模块：`m4.recipe.smelter.*`、`m4.recipe.assembler.*`
  - 制成品模块：`m4.product.*`
- 新增 M4 模块运行时嵌入工件接线：
  - 新增 `runtime/m4_builtin_wasm_artifact.rs`
  - 新增 `runtime/world/artifacts/m4_builtin_module_ids.txt`
  - 新增 `runtime/world/artifacts/m4_builtin_modules/` 与哈希清单 `m4_builtin_modules.sha256`
- 新增治理安装入口：`World::install_m4_economy_bootstrap_modules(actor)`，支持 register + activate + 幂等重入。
- 新增 runtime 测试：
  - `m4_builtin_module_ids_manifest_matches_runtime_constants`
  - `install_m4_economy_bootstrap_modules_*`（注册激活、幂等、停用后重激活）
  - `m4_economy_modules_drive_resource_to_product_chain`（真实 WasmExecutor 闭环）
- 新增并接线 m4 工件同步脚本：
  - `scripts/sync-m4-builtin-wasm-artifacts.sh`
  - `scripts/ci-tests.sh` 增加 m4 工件一致性检查
- 同步更新 m1 工件（由于 builtin wasm 二进制更新导致 m1 哈希变化），确保 pre-commit 工件校验可通过。
- 文档回写：
  - `doc/m4-industrial-economy-wasm.md`
  - `doc/m4-industrial-economy-wasm.project.md`
  - `doc/world-simulator.md`
  - `doc/world-simulator.project.md`
- 验证命令：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_builtin_wasm`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime runtime::tests::economy_bootstrap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime runtime::tests::power_bootstrap::m1_builtin_module_ids_manifest_matches_runtime_constants -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`

## 遗留事项
- Product 模块目前已作为内置 wasm 工件与治理对象提供，但 `validate_product_state` 还未接入 runtime 主流程（尚未形成动作/事件闭环）。
- 当前 recipe/factory 由调用方显式传入 `module_id`；后续可增加按工厂标签、配方 ID 自动路由模块的策略。
