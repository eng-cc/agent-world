# 2026-02-14

## 完成内容
- 完成 R7-4：将 viewer 协议并入 `agent_world_proto`，并完成 server/viewer 双端适配。
  - 新增 `crates/agent_world_proto/src/viewer.rs`：
    - 承载 `VIEWER_PROTOCOL_VERSION`、`ViewerRequest`、`ViewerControl`、`ViewerStream`、`ViewerEventKind`、`ViewerResponse`、`PromptControl*` 等协议定义。
    - `ViewerResponse` / `PromptControlAck` 使用泛型承载 snapshot/event/trace/metrics/time，避免 `proto` 直接依赖 `agent_world::simulator`。
  - `crates/agent_world_proto/src/lib.rs` 新增 `pub mod viewer;`。
  - `crates/agent_world/src/viewer/protocol.rs` 改为协议桥接层：
    - 将 runtime 具体类型通过 type alias 绑定到 `agent_world_proto::viewer` 泛型协议。
    - 保留 `viewer_event_kind_matches` 作为 `ViewerEventKind -> WorldEventKind` 过滤匹配函数。
  - `crates/agent_world/src/viewer/live.rs` 与 `crates/agent_world/src/viewer/server.rs` 切换到桥接匹配函数（替代原 `ViewerEventKind::matches` 内置实现）。
- 文档更新：
  - `doc/world-runtime/distributed-hard-split-phase7.project.md`：标记 R7-4 完成。
  - `doc/world-runtime.project.md`：同步 R7 全局状态与下一步。
- 回归验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_proto`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto viewer::`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world viewer::protocol::tests::`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer tests_prompt_control::`

## 遗留事项
- 继续执行 R7-5：收敛 WASM ABI 边界，去除 `agent_world_net` 中重复 `ModuleManifest` 定义并统一到 ABI/proto。
