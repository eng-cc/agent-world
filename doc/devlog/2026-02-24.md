# 2026-02-24

- 时刻：2026-02-24 00:38:23 CST
- 完成内容：完成“Viewer 视觉升级（Phase 10 后增量强化）”VVU-P7（回归、Web 闭环与性能收口）。
  - 修复 `agent_world_node` 回归中的维护轮询测试时序不稳定：
    - 文件：`crates/agent_world_node/src/tests_split_part1.rs`
    - 用例：`runtime_replica_maintenance_poll_executes_local_target_tasks`
    - 调整为条件等待（`committed_height >= 2` + `published_records`），并把 `max_repairs_per_round` 从 `1` 提升到 `2`，去除 hash 顺序导致的单任务随机分支。
  - 全量回归收口：
    - `./scripts/ci-tests.sh required` 通过
    - `./scripts/ci-tests.sh full` 通过
  - Web 闭环（S6）收口：
    - 启动 `world_viewer_live` + `run-viewer-web.sh`
    - 使用 Playwright CLI 跑 `window.__AW_TEST__` 语义步骤（`runSteps/sendControl/getState`）
    - 断言 `connectionStatus`/`tick` 字段可读、`console error = 0`、`canvas` 存在且尺寸有效
    - 截图产物：`output/playwright/viewer/viewer-web.png`
  - 性能回归（S8）收口：
    - `./scripts/viewer-owr4-stress.sh --duration-secs 45 --tick-ms 120 --scenarios triad_region_bootstrap,llm_bootstrap`
    - 产物：`.tmp/viewer_owr4_stress/20260224-003609/summary.md`、`.tmp/viewer_owr4_stress/20260224-003609/metrics.csv`
  - 项目管理文档回写：`doc/viewer-visual-upgrade.project.md` 将 VVU-P7 标记完成并收口状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests::runtime_replica_maintenance_poll_executes_local_target_tasks -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node --lib`
  - `./scripts/ci-tests.sh required`
  - `./scripts/ci-tests.sh full`
  - Playwright Web smoke（按 `testing-manual.md` S6 命令链执行）
  - `./scripts/viewer-owr4-stress.sh --duration-secs 45 --tick-ms 120 --scenarios triad_region_bootstrap,llm_bootstrap`
- 遗留事项：
  - 无（VVU-P7 闭环）。
- 时刻：2026-02-24 00:01:17 CST
- 完成内容：完成“world_viewer_live `--no-llm` 关闭开关”T1（参数实现与测试）。
  - `crates/agent_world/src/bin/world_viewer_live/cli.rs`：新增 `--no-llm` 参数解析；更新 usage/help 文案为 `--llm|--no-llm`。
  - `crates/agent_world/src/bin/world_viewer_live/world_viewer_live_tests_split_part1.rs`：新增测试
    - `parse_options_disables_llm_mode`
    - `parse_options_llm_flags_follow_last_one_wins`
    - `parse_launch_options_release_config_respects_locked_no_llm`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
- 遗留事项：
  - 执行 T2：更新 Viewer 手册并完成定向回归。

- 时刻：2026-02-24 00:05:33 CST
- 完成内容：完成“world_viewer_live `--no-llm` 关闭开关”T2（手册更新与定向回归）。
  - `doc/viewer-manual.md`：补充默认 LLM 开启说明与 `--no-llm` 显式关闭用法，新增脚本回退启动示例。
  - `doc/p2p/world-viewer-live-no-llm-flag-2026-02-23.project.md`：状态更新为 T0/T1/T2 完成，T3 进行中。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`（77 passed）
- 遗留事项：
  - 执行 T3：回写设计/项目文档最终状态并完成收口提交。

- 时刻：2026-02-24 00:10:26 CST
- 完成内容：完成“world_viewer_live `--no-llm` 关闭开关”T3（文档与状态收口）。
  - `doc/p2p/world-viewer-live-no-llm-flag-2026-02-23.md`：里程碑状态更新为 M0/M1/M2/M3 全部完成。
  - `doc/p2p/world-viewer-live-no-llm-flag-2026-02-23.project.md`：任务状态更新为 T0/T1/T2/T3 全部完成。
- 测试：
  - test_tier_required：`env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`（77 passed）
- 遗留事项：
  - 无。

- 时刻：2026-02-24 14:15:43 CST
- 完成内容：完成“Viewer 通用聚焦目标（可扩展实体）”GFT（语法扩展 + resolver + 测试收口）。
  - 新增设计与项目管理文档：
    - `doc/world-simulator/viewer-generic-focus-targets.md`
    - `doc/world-simulator/viewer-generic-focus-targets.project.md`
  - `crates/agent_world_viewer/src/viewer_automation.rs`：
    - 将 target 从固定 `agent/location` 枚举扩展为通用 kind target（兼容旧语法）。
    - 新增通用语法支持：`first:<kind>`、`<kind>:<id>`，并保留 `first_agent/first_location` 兼容。
    - 新增统一 resolver 入口，接入 `asset/module_visual/power_plant/power_storage/chunk/fragment`。
    - `fragment` 聚焦规则：优先匹配 `frag-` 前缀；若不存在则回退到 location 首项。
  - 单元测试更新：
    - 更新 target 解析与 step 解析断言，覆盖新旧语法。
    - 新增 `resolve_target_entity_supports_extended_scene_kinds`，覆盖扩展实体类型解析。
  - 项目文档状态回写：`viewer-generic-focus-targets.project.md` 标记 GFT-0~GFT-6 完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_automation::tests:: -- --nocapture`（5 passed）
- 遗留事项：
  - 若后续新增实体类型，需要在 `viewer_automation` 的 kind resolver 中补映射后复跑定向测试。

- 时刻：2026-02-24 14:46:46 CST
- 完成内容：完成“Doc 目录结构与内容时效复核（Round 3）”R3-0~R3-3（分层迁移 + 老旧文档归档 + 索引修复）。
  - 新增 round3 治理文档：
    - `doc/doc-structure-freshness-review-round3-2026-02-24.md`
    - `doc/doc-structure-freshness-review-round3-2026-02-24.project.md`
    - `doc/doc-structure-freshness-review-round3-2026-02-24.result.md`
  - 新增目录：
    - `doc/nonviewer/`、`doc/nonviewer/archive/`
    - `doc/engineering/`、`doc/engineering/archive/`
  - 顶层文档下沉迁移：
    - world-simulator 专题：`indirect-control-*`、`resource-kind-*`、`viewer-visual-upgrade*`
    - nonviewer 活跃文档：`nonviewer-onchain-*`、`nonviewer-longrun-traceable-*`
    - engineering 活跃文档：`oversized-rust-file-splitting-round3-*`
  - 本轮归档并补告警头（归档日期 2026-02-24）：
    - `doc/nonviewer/archive/nonviewer-release-readiness-hardening*`
    - `doc/nonviewer/archive/nonviewer-longrun-memory-safety-traceability-2026-02-23*`
    - `doc/engineering/archive/oversized-rust-file-splitting*`
    - `doc/engineering/archive/oversized-rust-file-splitting-round2-2026-02-23*`
  - 更新索引：`doc/README.md` 新增 round3 治理入口与 nonviewer/engineering 目录说明；新增 `doc/nonviewer/README.md` 与 `doc/engineering/README.md`。
  - 回写项目文档状态：`doc/doc-structure-freshness-review-round3-2026-02-24.project.md` 标记 R3-0~R3-3 全部完成。
- 测试：
  - `rg` 定向扫描：迁移旧路径在非 `doc/devlog` 文档残留 = 0。
  - 文档约束扫描：`find doc -type f -name '*.md' ! -path 'doc/devlog/*' -print0 | xargs -0 wc -l`，超 500 行文档 = 0。
- 遗留事项：
  - 无（round3 收口）。

- 时刻：2026-02-24 17:26:20 CST
- 完成内容：完成“Viewer Web Test API `step` 控制补齐”任务（修复 Playwright 逐步模拟链路）。
  - 根因定位：`crates/agent_world_viewer/src/web_test_api.rs` 的 `parse_control_action` 仅支持 `play/pause/seek`，`sendControl("step")` 被当作无效动作丢弃。
  - 修复实现：
    - 新增 `parse_step_count`，支持：
      - `sendControl("step")`（默认 `count=1`）
      - `sendControl("step", number>=1)`
      - `sendControl("step", { count: number>=1 })`
    - 在 `parse_control_action` 增加 `"step" => ViewerControl::Step { count }` 分支。
  - 文档回写：
    - 新增设计文档：`doc/world-simulator/viewer-web-test-api-step-control-2026-02-24.md`
    - 新增项目文档：`doc/world-simulator/viewer-web-test-api-step-control-2026-02-24.project.md`
  - Web 闭环验证产物：
    - 逐步游玩截图：`output/playwright/viewer/user-guided-playthrough-power-readywait-20260224-171122/`
    - `step` 修复定向验证：`output/playwright/viewer/web-test-api-step-fix-20260224-172239/check.txt`
- 测试：
  - `test_tier_required`：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `test_tier_full`（Web 闭环）：
    - Playwright `__AW_TEST__.sendControl("step")` 定向验证（见 `check.txt`，`advanced=true`，`tick 0 -> 1`）
- 遗留事项：
  - LLM 模式下单步响应时延仍受外部模型调用影响（非本任务范围）；如需进一步缩短闭环时延，需另开任务优化超时/重试策略。
- 时刻：2026-02-24 15:43:23 CST
- 完成内容：完成“P2P/存储/共识在线长跑稳定性测试”T0（方案建档，暂不提交）。
  - 新建设计文档：`doc/testing/p2p-storage-consensus-longrun-online-stability-2026-02-24.md`。
  - 新建项目管理文档：`doc/testing/p2p-storage-consensus-longrun-online-stability-2026-02-24.project.md`。
  - 方案要点：
    - 新增 S9（non-viewer 分布式长跑）方向，覆盖 `triad`/`triad_distributed` 拓扑。
    - 以 `world_viewer_live` epoch 报表 JSON 为主证据源，定义共识推进、网络追平、DistFS challenge 成功率、资产不变量等门禁。
    - 规划 `test_tier_required`（20~30 分钟）与 `test_tier_full`（180 分钟及以上）分档执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：实现 `scripts/p2p-longrun-soak.sh` 最小闭环（启动/停止/超时/产物目录）。

- 时刻：2026-02-24 15:52:45 CST
- 完成内容：完成“P2P/存储/共识在线长跑稳定性测试方案术语去混淆”文档调整。
  - `doc/testing/p2p-storage-consensus-longrun-online-stability-2026-02-24.md`：
    - 将长跑档位从 `test_tier_required/test_tier_full` 改为长跑专用 `soak_smoke/soak_endurance/soak_release`。
    - 新增“命名边界”章节，明确 `soak_*` 与 Cargo feature、`test_tier_required/full`、CI required/full 语义隔离。
    - 同步更新里程碑、CI 接线与风险缓解中的档位命名。
  - `doc/testing/p2p-storage-consensus-longrun-online-stability-2026-02-24.project.md`：
    - T5 验证任务命名同步为 `soak_smoke/soak_endurance`。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：实现 `scripts/p2p-longrun-soak.sh` 最小闭环。
