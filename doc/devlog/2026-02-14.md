- 日期：2026-02-14
- 完成内容：启动 R4（WASM 运行时激进迁移 Phase 4）文档任务，新增设计文档 `doc/world-runtime/wasm-runtime-crate-split-phase4.md` 与项目管理文档 `doc/world-runtime/wasm-runtime-crate-split-phase4.project.md`。
- 完成内容：更新总设计文档 `doc/world-runtime.md` 分册索引与里程碑（新增 M10）。
- 完成内容：更新总项目文档 `doc/world-runtime.project.md`，新增 R4 任务段并回写阶段状态。
- 遗留事项：继续推进 R4-1（迁移模块清单与变更计划类型到 `agent_world_wasm_abi`）。
- 完成内容：完成 T96（继续激进下沉 runtime 逻辑，去掉 `distributed_head_follow` 路径包装）：
  - `crates/agent_world_net/src/head_tracking.rs`：
    - 新增 `HeadTracker`（world_id 过滤、best head 选择、冲突/重复/陈旧判定、apply 记录）与 `HeadUpdateDecision`，将纯状态机逻辑下沉到 split crate。
  - `crates/agent_world_net/src/head_follow.rs`：
    - 收敛为 `HeadTracker` + bootstrap 组合，删除重复的 head 比较/判定实现。
  - `crates/agent_world_net/src/lib.rs`：
    - 导出 `HeadTracker`/`HeadUpdateDecision`，并调整 runtime_bridge 下 `distributed_head_follow` 导出，避免重复导出冲突。
  - `crates/agent_world/src/runtime/distributed_head_follow.rs`：
    - 从 `#[path]` 同源包装改为 runtime 本地薄适配实现，复用 `agent_world_net::HeadTracker`，保留 `World` 引导语义和原对外 API（`HeadFollower`/`HeadUpdateDecision`）。
  - `doc/world-runtime/distributed-crate-split-net-consensus.project.md`：
    - 新增并标记 T96 完成，更新阶段状态与下一步。
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_head_follow`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_observer_sync`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net`
  - `./scripts/check-include-warning-baseline.sh`
- 遗留事项：继续下一阶段，优先把 `distributed_observer` / `distributed_observer_replay` 中可独立的状态编排逻辑下沉到 `agent_world_net`，进一步压缩 runtime 路径包装与别名层。

- 日期：2026-02-14
- 完成内容：完成 T97（继续激进下沉 observer 编排逻辑并去掉 runtime 路径包装）：
  - `crates/agent_world_net/src/head_sync.rs`：
    - 新增通用 observer flow 抽象：`HeadSyncResult` / `HeadSyncReport` / `HeadFollowReport`、`compose_head_sync_report`、`follow_head_sync`，统一 head 同步报告与 follow 循环编排。
  - `crates/agent_world_net/src/observer.rs`：
    - 收敛为复用 `head_sync` 抽象，删除本地重复的 report 组装与循环逻辑。
  - `crates/agent_world_net/src/lib.rs`：
    - 新增 `observer_flow` 导出入口，向 runtime 暴露可复用的 observer 编排能力。
  - `crates/agent_world/src/runtime/distributed_observer.rs`：
    - 从 `#[path]` 同源包装切换为 runtime 本地薄适配实现，复用 `agent_world_net::observer_flow`，保留原有 `ObserverClient` / `HeadSyncReport` / `HeadFollowReport` API。
  - `doc/world-runtime/distributed-crate-split-net-consensus.project.md`：
    - 新增并标记 T97 完成，更新阶段状态与下一步。
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_observer_sync`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_head_follow`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net`
  - `./scripts/check-include-warning-baseline.sh`
- 遗留事项：继续下一阶段，优先收敛 `distributed_observer_replay` 路径包装，并将其可独立校验编排抽象继续下沉到 `agent_world_net`。

- 日期：2026-02-14
- 完成内容：完成 T98（继续激进下沉 observer replay 编排逻辑并去掉 runtime 路径包装）：
  - `crates/agent_world_net/src/replay_flow.rs`：
    - 新增通用 replay 编排抽象 `load_manifest_and_segments`，统一 manifest/journal blob 拉取、完整性校验、分片落盘流程。
  - `crates/agent_world_net/src/observer_replay.rs`：
    - 收敛为复用 `replay_flow` 抽象，删除重复的 manifest/journal 解码与拉取循环逻辑。
  - `crates/agent_world_net/src/lib.rs`：
    - 新增 `observer_replay_flow` 导出入口，供 runtime 复用 replay 编排能力。
  - `crates/agent_world/src/runtime/distributed_observer_replay.rs`：
    - 从 `#[path]` 同源包装切换为 runtime 本地薄适配实现，复用 `agent_world_net::observer_replay_flow`，保留原有 `replay_validate_*` API。
  - `doc/world-runtime/distributed-crate-split-net-consensus.project.md`：
    - 新增并标记 T98 完成，更新阶段状态与下一步。
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_observer_sync`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_head_follow`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_bootstrap`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net`
  - `./scripts/check-include-warning-baseline.sh`
- 遗留事项：继续下一阶段，优先收敛剩余路径包装模块，并继续推进 `agent_world_net --features runtime_bridge` 的可编译闭环抽象。

- 日期：2026-02-14
- 完成内容：完成 T99（继续激进去除 runtime `distributed_bootstrap` 路径包装）：
  - `crates/agent_world/src/runtime/distributed_bootstrap.rs`：
    - 从 `#[path]` 同源包装切换为 runtime 本地薄适配实现。
    - 复用 runtime `distributed_observer_replay` 的 `replay_validate_with_head(_and_dht)` 结果组装 `World::from_snapshot`，保持 `bootstrap_world_from_head*` / `bootstrap_world_from_dht` 对外 API 与语义不变。
  - `doc/world-runtime/distributed-crate-split-net-consensus.project.md`：
    - 新增并标记 T99 完成，更新阶段状态与下一步。
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_bootstrap`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_observer_sync`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net`
  - `./scripts/check-include-warning-baseline.sh`
- 遗留事项：继续下一阶段，优先处理 `distributed_storage` / `distributed_validation` 的路径包装，推进 runtime 到 split crate 的直接依赖闭环。

- 日期：2026-02-14
- 完成内容：完成 T100（继续激进去除 `distributed_storage` / `distributed_validation` 路径包装）：
  - `crates/agent_world/src/runtime/distributed_storage.rs`：
    - 从 `#[path]` 包装切换为 runtime 本地实现，直接复用 proto 下沉的 `ExecutionWriteConfig` / `ExecutionWriteResult` 类型，保持 `store_execution_result` 运行时行为不变。
  - `crates/agent_world/src/runtime/distributed_validation.rs`：
    - 从 `#[path]` 包装切换为 runtime 本地实现，保留 `HeadValidationResult` 与 `assemble_*` / `validate_head_update` API，继续校验 snapshot/journal/hash 闭环。
  - `doc/world-runtime/distributed-crate-split-net-consensus.project.md`：
    - 新增并标记 T100 完成，更新阶段状态与下一步。
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_consistency`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_bootstrap`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test distributed_observer_sync`
  - `./scripts/check-include-warning-baseline.sh`
- 遗留事项：继续下一阶段，优先推进 `agent_world_net --features runtime_bridge` 在 storage/validation 方向的抽象闭环，减少 runtime 与 net 的重复实现面。


- 日期：2026-02-14
- 完成内容：完成 R4-1，将 `ModuleRole/ModuleManifest/ModuleChangeSet/ModuleActivation/ModuleDeactivation/ModuleUpgrade` 从 `crates/agent_world/src/runtime/modules.rs` 下沉到 `crates/agent_world_wasm_abi/src/lib.rs`，`agent_world` 改为通过 re-export 复用 ABI 定义。
- 完成内容：在 ABI crate 增补 `ModuleChangeSet::is_empty` 行为单元测试，验证迁移后接口可用性。
- 完成内容：执行回归测试 `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi -- --nocapture`、`env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::modules:: -- --nocapture`、`env -u RUSTC_WRAPPER cargo test -p agent_world --test module_lifecycle -- --nocapture`，结果通过。
- 完成内容：回写项目管理文档 `doc/world-runtime/wasm-runtime-crate-split-phase4.project.md` 与 `doc/world-runtime.project.md`，标记 R4 全部任务完成并收口。
- 遗留事项：无（等待下一轮迁移立项）。


# 日期
2026-02-14

# 完成内容
- 启动 WASM 运行时激进迁移 Phase 5，新增设计文档：`doc/world-runtime/wasm-runtime-crate-split-phase5.md`。
- 新增项目管理文档：`doc/world-runtime/wasm-runtime-crate-split-phase5.project.md`，拆解 R5-1 迁移任务。
- 更新总设计文档与总项目管理文档，登记 R5（M11）阶段入口与任务状态。

# 遗留事项
- 执行 R5-1：将 `ModuleRegistry/ModuleRecord/ModuleEvent/ModuleEventKind` 迁移至 `agent_world_wasm_abi` 并完成回归。


# 日期
2026-02-14

# 完成内容
- 完成 R5-1：将 `ModuleRegistry/ModuleRecord/ModuleEvent/ModuleEventKind` 迁移到 `agent_world_wasm_abi`。
- `agent_world` 的 `runtime::modules` 改为 re-export 上述类型，移除本地重复定义，保持外部导入兼容。
- 为 ABI crate 补充迁移后测试（`ModuleRegistry::record_key` 与 `ModuleEventKind` serde tag 格式）。
- 更新 R5 项目管理文档与总项目管理文档状态为已完成。
- 执行回归：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::modules:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test module_lifecycle -- --nocapture`

# 遗留事项
- 暂无（R5 全部任务完成）。


# 日期
2026-02-14

# 完成内容
- 启动 WASM 运行时激进迁移 Phase 6，新增设计文档：`doc/world-runtime/wasm-runtime-crate-split-phase6.md`。
- 新增项目管理文档：`doc/world-runtime/wasm-runtime-crate-split-phase6.project.md`，拆解 R6-1 任务。
- 更新总设计文档与总项目管理文档，登记 R6（M12）阶段入口与任务状态。

# 遗留事项
- 执行 R6-1：提取 `ModuleStore` 文件存储实现到独立 crate 并完成回归。


# 日期
2026-02-14

# 完成内容
- 完成 R6-1：新增 `agent_world_wasm_store` crate，承载 `ModuleStore` 文件持久化实现。
- 将 `agent_world` 的 `runtime::module_store` 改为轻量包装层，转调新 crate 并保持 `WorldError` 语义兼容。
- 更新 workspace 与 `agent_world` 依赖，接入新 crate。
- 补充 `agent_world_wasm_store` 单元测试（roundtrip + version mismatch）。
- 更新 R6 项目管理文档与总项目管理文档为已完成状态。
- 执行回归：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_store -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test module_store -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::persistence:: -- --nocapture`

# 遗留事项
- 暂无（R6 全部任务完成）。


# 日期
2026-02-14

# 完成内容
- 启动 R7（分布式能力彻底拆分）并新增设计文档：`doc/world-runtime/distributed-hard-split-phase7.md`。
- 新增项目管理文档：`doc/world-runtime/distributed-hard-split-phase7.project.md`，拆解 R7-1~R7-6 六个任务。
- 更新总设计文档与总项目管理文档，登记 R7 阶段入口与状态。
- 完成 R7-1：新增 `agent_world_distfs` crate（`BlobStore`/`LocalCasStore`、snapshot/journal 分片、组装校验）。
- `agent_world::runtime::blob_store` 与 `segmenter` 切换为复用 `agent_world_distfs`；补齐 proto/runtime 错误映射。

# 测试
- `env -u RUSTC_WRAPPER cargo check -p agent_world_distfs`
- `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs`
- `env -u RUSTC_WRAPPER cargo check -p agent_world`
- `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::segmenter::tests::`

# 遗留事项
- 执行 R7-2：删除 `agent_world` 内分布式实现文件并切换调用方到 `agent_world_net`/`agent_world_consensus`/`agent_world_distfs`/`agent_world_proto`。


# 2026-02-14

## 完成内容
- 完成 R7-2：从 `crates/agent_world` 彻底移除分布式实现路径。
  - 删除 `crates/agent_world/src/runtime/distributed*.rs`、`crates/agent_world/src/runtime/distributed_membership_sync/` 与 `crates/agent_world/src/runtime/libp2p_net.rs`。
  - 删除 `crates/agent_world/tests/distributed_*.rs` 分布式集成测试文件。
  - 收敛 `crates/agent_world/src/runtime/mod.rs`：移除分布式模块声明与分布式 re-export，仅保留 world runtime 核心能力。
  - 收敛 `crates/agent_world/src/lib.rs`：移除分布式 API 导出（network/dht/consensus/membership/libp2p 等）。
  - 移除 world 核心中的分布式 fetch 入口：
    - `crates/agent_world/src/runtime/world/governance.rs` 删除 `shadow_proposal_with_fetch` / `apply_proposal_with_fetch`。
    - `crates/agent_world/src/runtime/world/module_runtime.rs` 删除 `load_module_with_fetch` / `prefetch_active_modules_with_fetch` / `ensure_module_changes_with_fetch`。
  - 修正分布式协议类型引用：
    - `crates/agent_world/src/runtime/segmenter.rs` 改为直接使用 `agent_world_proto::distributed::SnapshotManifest`。
    - `crates/agent_world/src/runtime/error.rs` 改为直接使用 `agent_world_proto::distributed::DistributedErrorCode`。
  - 精简 `crates/agent_world/Cargo.toml`：移除 `agent_world_net`、`agent_world_consensus`、`libp2p`、`futures` 依赖与对应 feature。
- 文档更新：
  - `doc/world-runtime/distributed-hard-split-phase7.project.md`：标记 R7-2 完成，下一步切到 R7-3。
  - `doc/world-runtime.project.md`：标记 R7-2 完成并更新全局状态。
- 回归验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::segmenter::tests::`

## 遗留事项
- 继续执行 R7-3：拆分 `agent_world` facade，进一步按领域收敛对外导出边界。


# 2026-02-14

## 完成内容
- 完成 R7-3：拆分 `agent_world` 大 facade，收敛导出边界并清理跨层 re-export。
  - `crates/agent_world/src/lib.rs`：移除根级对 `runtime`/`simulator` 的大规模 `pub use`，仅保留模块入口与几何/模型基础导出。
  - 调用方改造为显式模块路径：
    - `crates/agent_world/src/bin/world_viewer_demo.rs`
    - `crates/agent_world/src/bin/world_viewer_live.rs`
    - `crates/agent_world/src/bin/world_init_demo.rs`
    - `crates/agent_world/tests/{module_lifecycle,module_store,module_input_cbor,module_state,module_subscription_filters,wasm_executor,viewer_live_integration,viewer_offline_integration}.rs`
    - `crates/agent_world_net/src/{bootstrap,observer_replay}.rs`
  - 集成测试中的 runtime 类型引用统一改为 `agent_world::runtime::*`（避免继续依赖根级跨层导出）。
- 文档更新：
  - `doc/world-runtime/distributed-hard-split-phase7.project.md`：标记 R7-3 完成并切换下一步到 R7-4。
  - `doc/world-runtime.project.md`：同步全局 R7 进度与状态。
- 回归验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --all-targets`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test module_lifecycle`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test viewer_offline_integration`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net`

## 遗留事项
- 继续执行 R7-4：viewer 协议并入 `agent_world_proto` 并完成 server/viewer 双端适配。


# 2026-02-14

## 完成内容
- 完成 R7-4：将 viewer 协议并入 `agent_world_proto`，并完成 server/viewer 双端适配。
  - 新增 `crates/agent_world_proto/src/viewer.rs`：
    - 承载 `VIEWER_PROTOCOL_VERSION`、`ViewerRequest`、`ViewerControl`、`ViewerStream`、`ViewerEventKind`、`ViewerResponse`、`PromptControl*` 等协议定义。
    - `ViewerResponse` / `PromptControlAck` 使用泛型承载 snapshot/event/trace/metrics/time，避免 `proto` 直接依赖 `agent_world::simulator`。
  - `crates/agent_world_proto/src/lib.rs` 新增 `pub mod viewer;`。
  - `crates/agent_world/src/viewer/protocol.rs` 改为协议桥接层：
    - 将 runtime 具体类型通过 type alias 绑定到 `agent_world_proto::viewer` 泛型协议。
    - 保留 `viewer_event_kind_matches` 作为 `ViewerEventKind -> WorldEventKind` 过滤匹配函数。
  - `crates/agent_world/src/viewer/live.rs` 与 `crates/agent_world/src/viewer/server.rs` 切换到桥接匹配函数（替代原 `ViewerEventKind::matches` 内置实现）。
- 文档更新：
  - `doc/world-runtime/distributed-hard-split-phase7.project.md`：标记 R7-4 完成。
  - `doc/world-runtime.project.md`：同步 R7 全局状态与下一步。
- 回归验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_proto`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto viewer::`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world viewer::protocol::tests::`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer tests_prompt_control::`

## 遗留事项
- 继续执行 R7-5：收敛 WASM ABI 边界，去除 `agent_world_net` 中重复 `ModuleManifest` 定义并统一到 ABI/proto。


# 2026-02-14

## 完成内容
- 完成 R7-5：收敛 WASM ABI 边界，移除 `agent_world_net` 内重复 `ModuleManifest` 定义。
  - `crates/agent_world_net/src/lib.rs`：删除本地 `ModuleManifest` 结构体，`modules` 模块改为直接复用 `agent_world_wasm_abi::{ModuleArtifact, ModuleManifest}`。
  - `crates/agent_world_net/src/tests.rs`：按 ABI 统一后的 `ModuleManifest` 字段补齐测试构造（`kind/role/interface_version/exports/subscriptions/required_caps/limits`），确保 DHT 拉取模块清单路径仍可正确反序列化。
- 文档更新：
  - `doc/world-runtime/distributed-hard-split-phase7.project.md`：标记 R7-5 完成，下一步切到 R7-6。
  - `doc/world-runtime.project.md`：同步 R7-5 完成状态与最近更新说明。
- 回归验证：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net`

## 遗留事项
- 继续执行 R7-6：拆分全部超 1200 行 Rust 文件并完成回归。


# 2026-02-14

## 完成内容
- 完成 R7-6：拆分全部超 1200 行 Rust 文件，并保持行为不变。
  - `crates/agent_world/src/simulator/llm_agent.rs`：抽离 OpenAI payload/响应解析相关函数到 `crates/agent_world/src/simulator/llm_agent/openai_payload.rs`。
  - `crates/agent_world/src/simulator/llm_agent/tests.rs`：拆分为主文件 + `tests_part2.rs`，保留辅助夹具在主文件，测试用例分段组织。
  - `crates/agent_world_viewer/src/tests.rs`：拆分为主文件 + `tests_scene_entities.rs` + `tests_selection_panels.rs`。
  - `crates/agent_world_viewer/src/scene_helpers.rs`：抽离实体生成与位置细节构造函数到 `scene_helpers_entities.rs`，主文件保留调用入口与公共 API。
  - `crates/agent_world_viewer/src/ui_text.rs`：抽离 owner/power activity 辅助函数到 `ui_text_activity.rs`。
- 行数约束复检：
  - 运行 `find crates -name '*.rs' -type f -print0 | xargs -0 wc -l | awk '$1>1200 {print ...}'`，结果无业务文件超 1200 行（仅 `wc` 的 `total` 聚合行）。
- 文档更新：
  - `doc/world-runtime/distributed-hard-split-phase7.project.md`：标记 R7-6 完成，R7 全任务完成。
  - `doc/world-runtime.project.md`：同步标记 R7-6 完成并更新阶段状态。
- 回归验证：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime simulator::llm_agent::tests::`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`

## 遗留事项
- R7 阶段任务已全部完成，待下一阶段拆分目标立项后继续。


# 2026-02-14 任务日志（R8-1 runtime sandbox 门面移除）

## 日期
- 2026-02-14

## 完成内容
- 删除 `crates/agent_world/src/runtime/sandbox.rs`，并在 `crates/agent_world/src/runtime/mod.rs` 移除 `mod sandbox` 与相关 re-export。
- 将 runtime/simulator/tests 中对 `ModuleCall* / ModuleOutput / ModuleSandbox` 的引用改为直接使用 `agent_world_wasm_abi`。
- 将测试中执行器类型引用显式收敛为 `agent_world_wasm_executor`（并修复 `ModuleEffectIntent` 导入与条件导入告警）。
- 新增 R8 设计与项目管理文档：
  - `doc/world-runtime/wasm-runtime-crate-split-phase8.md`
  - `doc/world-runtime/wasm-runtime-crate-split-phase8.project.md`
- 更新总览/总项目文档：
  - `doc/world-runtime.md`
  - `doc/world-runtime.project.md`
- 回归验证：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime`

## 遗留事项
- 后续可评估 R9：是否继续把 sandbox 相关高层封装进一步下沉为独立 crate 边界（当前仅完成 facade 移除）。


# 2026-02-14 任务日志（M4 工业社会经济 WASM 接口设计）

## 日期
- 2026-02-14

## 完成内容
- 新增 M4 工业社会经济系统详细设计文档：
  - `doc/m4-industrial-economy-wasm.md`
- 新增对应项目管理文档：
  - `doc/m4-industrial-economy-wasm.project.md`
- 回写总文档交叉引用与状态：
  - `doc/world-simulator.md`（新增 M4 工业链路 WASM 分册引用）
  - `doc/world-simulator.project.md`（登记 M4 工业链路分册任务并更新最近状态）
- 在 ABI 层新增 Recipe/Product/Factory 经济模块接口基础：
  - 新增 `crates/agent_world_wasm_abi/src/economy.rs`
  - 在 `crates/agent_world_wasm_abi/src/lib.rs` 引入并导出 economy 接口
  - 在 `crates/agent_world/src/runtime/modules.rs` 与 `crates/agent_world/src/runtime/mod.rs` 暴露新 ABI 类型
- 新增并通过 ABI 单元测试（序列化、拒绝路径、构建决策路径）：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
- 执行编译回归：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

## 遗留事项
- 后续需在 runtime 的 action/event 路由中落地 `build_factory` / `schedule_recipe` 的最小闭环执行（当前为接口基础与设计完成）。
- 后续需提供首批内置示例模块（建议至少 6 配方、4 制成品、3 工厂）用于场景验证与平衡性调参。


# 2026-02-14 任务日志（M4 工业社会经济 runtime 最小闭环）

## 日期
- 2026-02-14

## 完成内容
- runtime 新增经济动作与事件闭环：
  - 新动作：`BuildFactory`、`ScheduleRecipe`
  - 新事件：`FactoryBuildStarted`、`FactoryBuilt`、`RecipeStarted`、`RecipeCompleted`
  - 新拒绝原因：`InsufficientMaterial`、`FactoryNotFound`、`FactoryBusy`
- `WorldState` 新增工业经济状态：
  - `materials`（材料库存）
  - `factories`（已建工厂）
  - `pending_factory_builds`（建造队列）
  - `pending_recipe_jobs`（配方排产队列）
- 新增 tick 结算流程：在 `step/step_with_modules` 内自动处理到期建造和到期配方任务，触发完成事件并更新状态。
- 新增 runtime 材料库存 API（查询/设置/调整）与工厂/排产队列辅助查询。
- 新增定向测试文件：`crates/agent_world/src/runtime/tests/economy.rs`，覆盖：
  - 工厂建造延迟完成与建造成本扣减
  - 配方排产的输入与电力扣减、到期产出入账
  - 产线槽位占满时拒绝新排产
  - 材料不足时拒绝建造
- 文档回写：
  - `doc/m4-industrial-economy-wasm.md`
  - `doc/m4-industrial-economy-wasm.project.md`
  - `doc/world-simulator.md`
  - `doc/world-simulator.project.md`
- 验证命令：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

## 遗留事项
- 当前 `BuildFactory/ScheduleRecipe` 仍使用动作侧传入的 spec/plan；下一步需接入 wasm 模块在线评估流程（由模块返回 build/recipe 决策）。
- 当前材料库存为 world 级共享账本；后续可扩展为 owner/location 级多账本并接入物流约束。


# 2026-02-14 任务日志（M4 经济模块在线求值接线）

## 日期
- 2026-02-14

## 完成内容
- 新增模块驱动经济动作：
  - `BuildFactoryWithModule`
  - `ScheduleRecipeWithModule`
- 在 `step_with_modules` 中新增模块驱动预处理阶段：
  - 先调用指定 WASM 模块获取建造决策/排产计划
  - 再转换为 `BuildFactory` / `ScheduleRecipe` 执行
- 新增经济模块求值桥接逻辑（`runtime/world/economy.rs`）：
  - 构造 `ModuleCallInput`（CBOR）并调用 `execute_module_call`
  - 解析模块 emit：
    - `economy.factory_build_decision`
    - `economy.recipe_execution_plan`
  - 对非法输出统一记录 `ModuleCallFailed(InvalidOutput)`
- 扩展动作标签与无模块路径拒绝语义：
  - `action.economy.build_factory_with_module`
  - `action.economy.schedule_recipe_with_module`
  - 在 `step`（无模块）路径下返回明确拒绝提示
- 新增并通过模块驱动经济测试：
  - `build_factory_with_module_uses_module_decision`
  - `schedule_recipe_with_module_uses_module_plan`
  - `schedule_recipe_with_module_rejects_when_module_denies`
- 文档回写：
  - `doc/m4-industrial-economy-wasm.md`
  - `doc/m4-industrial-economy-wasm.project.md`
  - `doc/world-simulator.md`
  - `doc/world-simulator.project.md`
- 验证命令：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

## 遗留事项
- 目前模块驱动动作由调用方指定 `module_id`；后续可增加“按工厂/配方标签自动选择模块”的路由策略。
- 仍缺少内置 wasm 经济示例工件（recipe/factory/product）的完整装载与场景回归。


# 2026-02-14 任务日志（M4 内置工业模块包与治理装载）

## 日期
- 2026-02-14

## 完成内容
- 在 `agent_world_builtin_wasm` 新增 M4 经济模块实现，覆盖三类模块：
  - 工厂模块：`m4.factory.miner.mk1`、`m4.factory.smelter.mk1`、`m4.factory.assembler.mk1`
  - 配方模块：`m4.recipe.smelter.*`、`m4.recipe.assembler.*`
  - 制成品模块：`m4.product.*`
- 新增 M4 模块运行时嵌入工件接线：
  - 新增 `runtime/m4_builtin_wasm_artifact.rs`
  - 新增 `runtime/world/artifacts/m4_builtin_module_ids.txt`
  - 新增 `runtime/world/artifacts/m4_builtin_modules/` 与哈希清单 `m4_builtin_modules.sha256`
- 新增治理安装入口：`World::install_m4_economy_bootstrap_modules(actor)`，支持 register + activate + 幂等重入。
- 新增 runtime 测试：
  - `m4_builtin_module_ids_manifest_matches_runtime_constants`
  - `install_m4_economy_bootstrap_modules_*`（注册激活、幂等、停用后重激活）
  - `m4_economy_modules_drive_resource_to_product_chain`（真实 WasmExecutor 闭环）
- 新增并接线 m4 工件同步脚本：
  - `scripts/sync-m4-builtin-wasm-artifacts.sh`
  - `scripts/ci-tests.sh` 增加 m4 工件一致性检查
- 同步更新 m1 工件（由于 builtin wasm 二进制更新导致 m1 哈希变化），确保 pre-commit 工件校验可通过。
- 文档回写：
  - `doc/m4-industrial-economy-wasm.md`
  - `doc/m4-industrial-economy-wasm.project.md`
  - `doc/world-simulator.md`
  - `doc/world-simulator.project.md`
- 验证命令：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_builtin_wasm`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime runtime::tests::economy_bootstrap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime runtime::tests::power_bootstrap::m1_builtin_module_ids_manifest_matches_runtime_constants -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`

## 遗留事项
- Product 模块目前已作为内置 wasm 工件与治理对象提供，但 `validate_product_state` 还未接入 runtime 主流程（尚未形成动作/事件闭环）。
- 当前 recipe/factory 由调用方显式传入 `module_id`；后续可增加按工厂标签、配方 ID 自动路由模块的策略。


日期: 2026-02-14

完成内容:
1. 完成 M4-E7 Product 模块在线校验接线。
   - 在 `agent_world_wasm_abi` 新增 `ProductValidationRequest` 与 `ProductValidationDecision`。
   - 将 `ProductModuleApi` 统一为 `evaluate_product(req) -> ProductValidationDecision`。
   - runtime 新增动作 `ValidateProduct`、`ValidateProductWithModule`，并新增领域事件 `ProductValidated`。
   - 在 `step_with_modules` 中新增 Product 模块求值流程，解析 emit kind `economy.product_validation`，并将模块拒绝映射到 `ActionRejected(RuleDenied)`。
2. 补齐 runtime 回归测试。
   - `validate_product_with_module_uses_module_decision`
   - `validate_product_with_module_rejects_when_module_denies`
3. 回写文档。
   - 更新 `doc/m4-industrial-economy-wasm.md`（接口草案、动作/事件协议、当前实现进展）。
   - 更新 `doc/m4-industrial-economy-wasm.project.md`（E7 勾选完成，新增 E8 下一任务）。
   - 更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 的 M4 状态。
4. 测试与检查通过。
   - `cargo fmt --all`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime runtime::tests::economy -- --nocapture`
   - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

遗留事项:
1. E8: 将 Product 校验从“显式动作”推进为“配方完工自动触发 + 入账门禁”。
2. 设计并实现“产物 -> Product 模块”解析策略，支持内置规则与后续扩展。


日期: 2026-02-14

完成内容:
1. 完成 M4-E8「Product 校验自动闭环」。
   - 在 `step_with_modules` 的到期配方结算路径接入自动 Product 校验。
   - 新增 `process_due_economy_jobs_with_modules`，在 `RecipeCompleted` 入账前逐项校验产物。
   - 产物模块解析策略：优先命中内置 `m4.product.*` 显式映射，再回退到 `*.product.*.<product_kind>` 后缀匹配扩展模块。
   - 对 Product 模块调用请求做兼容封装（同时携带 `ProductValidationRequest` 与 legacy `kind/amount` 字段），兼容旧模块与新 ABI。
2. 实现入账门禁。
   - 若任一产物校验失败，记录 `ActionRejected(RuleDenied)`，并阻断该批次产物与副产物入库。
   - 配方任务仍会完成结算并从 pending 队列移除，避免重复重放同一失败任务。
3. 补充回归测试。
   - `schedule_recipe_with_module_auto_validates_outputs_before_commit`
   - `schedule_recipe_with_module_blocks_commit_when_product_validation_fails`
4. 回写文档。
   - 更新 `doc/m4-industrial-economy-wasm.md`（动作协议与自动校验进展）
   - 更新 `doc/m4-industrial-economy-wasm.project.md`（E8 勾选完成）
   - 更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 的 M4 状态
5. 测试通过。
   - `cargo fmt --all`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime runtime::tests::economy -- --nocapture`
   - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

遗留事项:
1. M4-E5 后续工作：完善玩家/AI 自定义经济模块的治理模板与提交规范（shadow 验证指标、审计输出模版）。
# 2026-02-14 任务日志（CI 测试分级 T2-T4）

## 日期
- 2026-02-14

## 完成内容
- 改造 `scripts/ci-tests.sh`：新增测试分级参数 `required/full`，并保留默认 `full` 以兼容旧调用。
- 调整 `scripts/pre-commit.sh`：提交钩子从全量切换为 `./scripts/ci-tests.sh required`。
- 调整 `.github/workflows/rust.yml`：
  - `push/pull_request` 仅跑 `required-gate`。
  - 新增每日定时 `schedule`（`0 3 * * *`）与手动触发 `workflow_dispatch` 跑 `full-regression`。
- 回写文档：
  - `doc/scripts/pre-commit.md`
  - `doc/testing/ci-test-coverage.md`
  - `doc/testing/ci-tiered-execution.project.md`
- 运行验证：
  - `bash -n scripts/ci-tests.sh scripts/pre-commit.sh`
  - `./scripts/ci-tests.sh invalid-tier`（参数校验）
  - `./scripts/ci-tests.sh required`

## 遗留事项
- 若后续需要进一步缩短 `required` 耗时，可在下一阶段引入按 crate/路径增量测试策略。


日期: 2026-02-14

完成内容:
1. 去除默认 pre-commit/CI 测试清单中的内置 wasm 二进制 hash 校验，避免频繁阻断业务改动。
   - 修改 `scripts/ci-tests.sh`：删除
     - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
     - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
2. 文档同步：
   - 更新 `doc/scripts/pre-commit.md`：说明默认链路已移除 hash 漂移检查，并保留手动校验入口。
   - 更新 `doc/scripts/pre-commit.project.md`：补充该任务完成状态。
   - 更新 `doc/testing/ci-test-coverage.md`：同步 CI 脚本覆盖口径变化。
   - 更新 `doc/testing/ci-test-coverage.project.md`：新增 T9 完成记录。
3. 快速验证通过：
   - `bash -n scripts/ci-tests.sh scripts/pre-commit.sh`
   - `env -u RUSTC_WRAPPER cargo check -p agent_world --all-targets`

遗留事项:
1. 若需发布前严格校验内置 wasm 工件漂移，可手动执行：
   - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
   - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
# 2026-02-14 任务日志（CI test case 粒度分级 T1）

## 日期
- 2026-02-14

## 完成内容
- 新增设计文档：`doc/testing/ci-testcase-tiering.md`。
- 新增项目管理文档：`doc/testing/ci-testcase-tiering.project.md`。
- 明确将 `required` 级别细化到 test case 粒度、`full` 维持重型回归。
- 运行验证：`env -u RUSTC_WRAPPER cargo check -p agent_world --quiet`。

## 遗留事项
- 待改造 `scripts/ci-tests.sh` 为 case 级 smoke 执行清单。
- 待回写现有测试文档与完成本轮验证。


日期: 2026-02-14

完成内容:
1. 完成 M4 材料多账本与物流约束任务1（多账本基础与迁移）。
   - 新增 `MaterialLedgerId`（world/agent/site/factory）。
   - `WorldState` 新增 `material_ledgers`，并保留 `materials` 兼容字段。
   - `World::new_with_state` 接入旧状态迁移：旧快照中的 `materials` 自动迁移到 `world` ledger。
2. 完成 runtime 账本路由改造（建造/配方）。
   - `BuildFactory` 支持优先从 builder ledger 扣料，不足时回退 world ledger。
   - `ScheduleRecipe` 支持优先从 factory 输入 ledger 扣料，不足时回退 world ledger。
   - 配方产物在“从 world 扣料”时回写 world ledger，保持旧行为兼容；否则写入 factory 输出 ledger（默认 site ledger）。
3. 完成账本 API 与状态字段扩展。
   - `resources.rs` 新增 ledger 级材料接口：`ledger_material_balance`、`set_ledger_material_balance`、`adjust_ledger_material_balance`、`transfer_material_between_ledgers`。
   - `FactoryState` / `RecipeJobState` / `FactoryBuildJobState` 增加 ledger 字段并加 serde 默认值，保障旧 journal/snapshot 兼容读取。
4. 完成文档与测试。
   - 新增设计文档：`doc/world-simulator/material-multi-ledger-logistics.md`。
   - 新增项目管理文档：`doc/world-simulator/material-multi-ledger-logistics.project.md`（任务1标记完成）。
   - 新增/更新测试：
     - `runtime::tests::basic::new_world_migrates_legacy_world_materials_into_material_ledgers`
     - `runtime::tests::economy::build_factory_prefers_builder_material_ledger_when_available`
     - `runtime::tests::economy::schedule_recipe_reads_and_writes_site_material_ledger`
5. 验证通过。
   - `cargo fmt --all`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::basic:: -- --nocapture`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy:: -- --nocapture`

遗留事项:
1. 任务2待做：新增 `TransferMaterial` 与在途物流队列，补齐距离/损耗/延迟/吞吐约束。
2. 任务3待做：ABI 增加 `available_inputs_by_ledger`，并完成场景与文档收口。


日期: 2026-02-14

完成内容:
1. 完成 M4 材料多账本与物流约束任务2（物流动作与约束）。
   - runtime 新增动作：`TransferMaterial`。
   - runtime 新增拒绝原因：
     - `MaterialTransferDistanceExceeded`
     - `MaterialTransitCapacityExceeded`
2. 新增物流领域事件与在途状态。
   - 新增事件：`MaterialTransferred`、`MaterialTransitStarted`、`MaterialTransitCompleted`。
   - `WorldState` 新增在途任务状态：`pending_material_transits`（`MaterialTransitJobState`）。
   - `step/step_with_modules` 新增在途任务结算：`process_due_material_transits`。
3. 落地物流约束参数（当前常量口径）。
   - 最大距离：`10_000 km`
   - 损耗率：`5 bps/km`
   - 速度：`100 km/tick`
   - 在途容量：`2`（并发 in-flight 任务）
4. 补齐动作路由与事件标签。
   - `module_runtime` 新增动作标签：`action.transfer_material`。
   - `module_runtime` 新增事件标签：`domain.material_transferred` / `domain.material_transit_started` / `domain.material_transit_completed`。
5. 回归测试新增并通过。
   - `transfer_material_distance_zero_moves_immediately`
   - `transfer_material_cross_site_creates_transit_and_applies_loss`
   - `transfer_material_rejects_when_distance_exceeds_limit`
   - `transfer_material_rejects_when_inflight_capacity_exceeded`
6. 验证通过。
   - `cargo fmt --all`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy:: -- --nocapture`

遗留事项:
1. 任务3待做：WASM ABI 增加 `available_inputs_by_ledger` 并接入 runtime 模块请求。
2. 补充场景与文档收口：在 `scenario-files` 追加物流瓶颈场景口径。


# 2026-02-14 任务日志（移除 ci-tests.sh 中硬编码 --test 清单）

## 日期
- 2026-02-14

## 完成内容
- 调整 `scripts/ci-tests.sh`：
  - `required` 改为 `cargo test -p agent_world --tests --features test_tier_required`。
  - `full` 改为 `cargo test -p agent_world --tests --features test_tier_full,wasmtime,viewer_live_integration`。
  - 删除脚本中的硬编码 `--test module_xxx` 列表，改为 feature 标签自动过滤。
- 为 integration test 文件补充 crate 级门控，避免无关 feature 下构建/警告噪音：
  - `#![cfg(any(feature = "test_tier_required", feature = "test_tier_full"))]`
  - `viewer_live_integration` 改为 `#![cfg(all(feature = "viewer_live_integration", feature = "test_tier_full"))]`
  - `wasm_executor` 改为 `#![cfg(all(feature = "wasmtime", feature = "test_tier_full"))]`
- 文档回写：
  - `doc/testing/ci-test-coverage.md`
  - `doc/testing/ci-testcase-tiering.md`
  - `doc/testing/ci-testcase-tiering.project.md`

## 验证
- `env -u RUSTC_WRAPPER cargo fmt --all`
- `./scripts/ci-tests.sh required`
- `./scripts/ci-tests.sh full`

## 遗留事项
- 目前 feature 标签分级主要覆盖 `agent_world` crate；后续可按同样模式扩展到其他 crate 的 tests。


日期: 2026-02-14

完成内容:
1. 完成 M4 材料多账本与物流约束任务3（ABI 兼容、场景与收口）。
   - `agent_world_wasm_abi` 新增可选字段：
     - `RecipeExecutionRequest.available_inputs_by_ledger`
     - `FactoryBuildRequest.available_inputs_by_ledger`
   - 保留 `available_inputs` 旧字段，实现新旧 ABI 双通路兼容。
2. runtime 模块请求接入多账本视图。
   - `runtime/world/economy.rs` 在工厂建造与配方求值请求中注入 `available_inputs_by_ledger`。
   - 保持既有 `available_inputs` 语义不变，兼容旧模块决策逻辑。
3. 补齐兼容回归测试。
   - ABI 侧新增测试：验证新字段 round-trip 与旧请求缺省反序列化兼容。
   - runtime 侧新增测试文件 `runtime/tests/economy_module_requests.rs`：
     - `build_factory_with_module_request_exposes_available_inputs_by_ledger`
     - `schedule_recipe_with_module_request_exposes_available_inputs_by_ledger`
   - 为满足“单个 Rust 文件不超过 1200 行”约束，将请求捕获相关测试拆分出 `economy.rs`。
4. 场景与项目文档收口。
   - 更新 `doc/world-simulator/scenario-files.md`，增加“物流瓶颈验证口径（2026-02-14）”。
   - 更新 `doc/world-simulator/material-multi-ledger-logistics.project.md`，任务3清单标记完成并更新状态。

验证:
1. `env -u RUSTC_WRAPPER cargo fmt --all`
2. `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi economy::tests:: -- --nocapture`
3. `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy_module_requests:: -- --nocapture`
4. `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy:: -- --nocapture`

遗留事项:
1. 当前三阶段任务已全部完成，后续可按需求继续细化物流网络（路由/拥塞/容量分层）与场景级自动化压测。


日期: 2026-02-14

完成内容:
1. 按测试分级流程巡检现有测试 case 与 feature 覆盖。
   - 执行 `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`。
   - 执行 `CI_VERBOSE=1 ./scripts/ci-tests.sh full`（覆盖 `test_tier_full`、`wasmtime`、`viewer_live_integration`、`agent_world_net/libp2p`）。
   - 执行 `env -u RUSTC_WRAPPER cargo test --workspace` 做跨 crate 回归抽查。
2. 测试结果均通过，未发现需要额外补齐的失败 feature。
3. 同步流程约束到 `AGENTS.md`：新增“所有测试都分 `test_tier_required` 或 `test_tier_full`”要求。
4. 更新 `doc/testing/ci-testcase-tiering.project.md`，补充 T4 巡检任务并标记完成。

遗留事项:
1. 当前巡检范围内无阻塞问题；若后续新增测试需继续遵循 tier feature 分级约束。


- 日期：2026-02-14
- 完成内容：新增《Viewer 工业风可视化缺口收敛》设计文档与项目管理文档，按缺口分组固化四个任务组（A=1+2，B=3，C=5+6，D=7）：
  - `doc/world-simulator/viewer-industrial-visual-closure.md`
  - `doc/world-simulator/viewer-industrial-visual-closure.project.md`
- 完成内容：回写总项目文档 `doc/world-simulator.project.md`，挂载工业风可视化分册入口，并新增 A/B/C/D 任务项。
- 遗留事项：继续执行 IVA（任务 A：产线可视化 + 物流网络可视化）并补齐测试、日志与提交。

- 日期：2026-02-14
- 完成内容：完成 IVA（任务 A：产线可视化 + 物流网络可视化）首版落地。
  - 新增工业摘要模块：`crates/agent_world_viewer/src/ui_text_industrial.rs`。
  - 产线摘要：聚合 `module_visual_entities` 与近期 `CompoundRefined/ModuleVisualEntityUpserted`，输出工厂/配方/制成品/物流可视实体与近期产出指标。
  - 物流路由：聚合近期 `ResourceTransferred/PowerTransferred`，输出活跃路由、传输事件、路由吞吐与损耗。
  - 右侧详情面板按需新增 `Industrial Ops` 区块（仅有工业信号时显示），避免影响现有默认信息流：
    - `crates/agent_world_viewer/src/egui_right_panel.rs`
    - `crates/agent_world_viewer/src/ui_text.rs`
  - 新增工业区块中英文本地化映射与单测：`crates/agent_world_viewer/src/ui_locale_text.rs`。
- 完成内容：更新项目文档状态：
  - `doc/world-simulator/viewer-industrial-visual-closure.project.md`（IVA.1~IVA.4 标记完成）
  - `doc/world-simulator.project.md`（工业风缺口收敛任务 A 标记完成）
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer ui_text_industrial -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer localize_industrial_ops_block_supports_zh -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：继续推进 IVB（任务 B：经营面板）并定义供需/成本/收益/库存健康口径。

- 日期：2026-02-14
- 完成内容：完成 IVB（任务 B：经营面板）首版落地。
  - 新增经营看板聚合模块：`crates/agent_world_viewer/src/ui_text_economy.rs`。
  - 供需指标：按 `ResourceTransferred/PowerTransferred/ActionRejected(InsufficientResource)` 聚合流量与缺口；按 snapshot 资源库存计算健康状态（stable/warn/critical）。
  - 成本与收益代理指标：`power trade settlement`、`refine electricity cost`、`power loss`、`outbound value proxy`、`margin proxy`。
  - 右侧详情区按需新增 `Economy Dashboard` 区块（仅存在经济信号时显示）：
    - `crates/agent_world_viewer/src/egui_right_panel.rs`
    - `crates/agent_world_viewer/src/ui_text.rs`
  - 新增经营看板本地化映射：`crates/agent_world_viewer/src/ui_locale_text.rs`。
- 完成内容：更新项目文档状态：
  - `doc/world-simulator/viewer-industrial-visual-closure.project.md`（IVB.1~IVB.3 标记完成）
  - `doc/world-simulator.project.md`（工业风缺口收敛任务 B 标记完成）
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer ui_text_economy -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer localize_economy_dashboard_block_supports_zh -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续推进 IVC（任务 C：多尺度导航 + 告警根因）。

- 日期：2026-02-14
- 完成内容：完成 IVC（任务 C：多尺度导航 + 告警根因）首版落地。
  - 新增运营导航聚合模块：`crates/agent_world_viewer/src/ui_text_ops_navigation.rs`。
  - 多尺度摘要：
    - 世界层：近期活动/告警事件计数。
    - 区域层：按 chunk 聚合热点（events/alerts）。
    - 节点层：按 agent/location 聚合热点分数。
  - 告警根因：聚合 `ActionRejected` 的根因类型 Top 列表。
  - 右侧详情区新增可开关导航区块（默认关闭，启用环境变量 `AGENT_WORLD_VIEWER_SHOW_OPS_NAV=1`）：
    - `crates/agent_world_viewer/src/egui_right_panel.rs`
    - `crates/agent_world_viewer/src/ui_text.rs`
  - 新增导航区块本地化映射：`crates/agent_world_viewer/src/ui_locale_text.rs`。
- 完成内容：更新项目文档状态：
  - `doc/world-simulator/viewer-industrial-visual-closure.project.md`（IVC.1~IVC.3 标记完成）
  - `doc/world-simulator.project.md`（工业风缺口收敛任务 C 标记完成）
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer ui_text_ops_navigation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer localize_ops_navigation_block_supports_zh -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：继续推进 IVD（任务 D：产品化表现层）。

- 日期：2026-02-14
- 完成内容：完成 IVD（任务 D：产品化表现层）收口。
  - 右侧详情区新增产品化表现层开关：`AGENT_WORLD_VIEWER_PRODUCT_STYLE`（默认关闭，不影响既有快照与交互）。
  - 产品化卡片抽离为独立模块 `crates/agent_world_viewer/src/egui_observe_section_card.rs`，并在 `egui_right_panel.rs` 接入，确保单文件不超过 1200 行。
  - 语义色板：按世界/活动/工业/经营/运营/详情/事件分配色调与强调色。
  - 动效开关：新增 `AGENT_WORLD_VIEWER_PRODUCT_STYLE_MOTION`，对工业/经营/运营/事件卡片提供轻量边框脉冲过渡。
  - 补充单测：环境开关解析与区块语义色调映射（`egui_right_panel_tests.rs`）。
- 完成内容：更新项目文档状态：
  - `doc/world-simulator/viewer-industrial-visual-closure.project.md`（IVD.1~IVD.3 标记完成）
  - `doc/world-simulator.project.md`（工业风缺口收敛任务 D 标记完成）
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `AGENT_WORLD_VIEWER_PRODUCT_STYLE=1 AGENT_WORLD_VIEWER_PRODUCT_STYLE_MOTION=1 ./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 90 --no-prewarm`
- 遗留事项：Viewer 工业风可视化缺口收敛 A~D 已完成，后续按新需求进入下一批可玩化任务。

- 日期：2026-02-14
- 完成内容：新增“Viewer 2D 可视化精修”文档与任务挂载，响应“2D 可视化还太简陋”问题。
  - 设计文档：`doc/world-simulator/viewer-2d-visual-polish.md`
  - 项目管理文档：`doc/world-simulator/viewer-2d-visual-polish.project.md`
  - 总项目文档挂载：`doc/world-simulator.project.md`
- 遗留事项：继续推进 V2D1（2D 地图符号层）并完成测试与提交。

- 日期：2026-02-14
- 完成内容：完成 V2D1（2D 地图符号层）落地。
  - Location 增加 2D 地图符号（平面底板 + 中心点）：`map2d:location:*`。
  - Agent 增加 2D 地图符号（底板 + 模块带 + 中心点）：`map2d:agent:*`。
  - 新增模式联动系统 `sync_two_d_map_marker_visibility`，实现 TwoD 显示 / ThreeD 隐藏。
  - 代码位置：
    - `crates/agent_world_viewer/src/scene_helpers.rs`
    - `crates/agent_world_viewer/src/scene_helpers_entities.rs`
    - `crates/agent_world_viewer/src/camera_controls.rs`
    - `crates/agent_world_viewer/src/app_bootstrap.rs`
- 完成内容：更新项目文档状态：
  - `doc/world-simulator/viewer-2d-visual-polish.project.md`（V2D1.1~V2D1.3 标记完成）
  - `doc/world-simulator.project.md`（2D 精修任务 1 标记完成）
- 完成内容：执行并通过验证：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer two_d_map_marker_visibility_follows_camera_mode -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_location_entity_renders_fine_grained_ring_details -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_agent_entity_renders_module_markers_up_to_cap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续推进 V2D2（标签可读性增强 + 截图闭环）。
