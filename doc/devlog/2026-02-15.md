- 日期：2026-02-15
- 完成内容：完成 V2D2（2D 标签可读性增强）。
  - 在 `crates/agent_world_viewer/src/label_lod.rs` 增加按 `ViewerCameraMode` 分支的 LOD 参数策略，2D 模式放宽可见距离、标签容量和遮挡配额，3D 模式保持既有策略。
  - 补充测试 `label_lod_params_two_d_are_more_permissive`，并在已有 label LOD 测试中显式注入 `ViewerCameraMode` 资源。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-2d-visual-polish.project.md`（V2D2.1~V2D2.3 勾选完成）
    - `doc/world-simulator.project.md`（Viewer 2D 可视化精修任务 2 勾选完成）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer label_lod -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer label_lod_params_two_d_are_more_permissive -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 90 --no-prewarm`
- 遗留事项：当前 Viewer 2D 可视化精修 V2D0~V2D2 已完成；如仍存在“2D 过于简陋”反馈，进入下一轮精修需求拆解（新增文档与任务）。

- 日期：2026-02-15
- 完成内容：新增 V2D3（流向层工业化表达）任务定义并挂载总项目文档。
  - 更新设计文档 `doc/world-simulator/viewer-2d-visual-polish.md`：补充 2D flow overlay 平面化、线宽增强、终点箭头头部设计。
  - 更新项目文档 `doc/world-simulator/viewer-2d-visual-polish.project.md`：新增 V2D3.1~V2D3.3 任务拆解。
  - 更新总项目文档 `doc/world-simulator.project.md`：新增“Viewer 2D 可视化精修任务 3”入口。
- 完成内容：执行并通过文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续执行 V2D3 代码落地（flow overlay 2D 参数分支 + 箭头头部），并补齐测试与截图闭环。

- 日期：2026-02-15
- 完成内容：完成 V2D3（2D 流向层工业化表达）代码落地。
  - 修改 `crates/agent_world_viewer/src/world_overlay.rs`：
    - `update_world_overlays_3d` 按 `ViewerCameraMode` 渲染 flow。
    - 2D 模式下将 flow 统一到平面高度并增强线宽。
    - 新增 flow 终点箭头头部渲染（`overlay:flow:arrow`），Power/Trade 复用现有材质语义色。
  - 新增单测：
    - `flow_render_profile_two_d_flattens_and_boosts_thickness`
    - `flow_arrow_transform_tip_matches_segment_target`
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-2d-visual-polish.project.md`（V2D3.1~V2D3.3 勾选完成）
    - `doc/world-simulator.project.md`（Viewer 2D 可视化精修任务 3 勾选完成）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer world_overlay::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 90 --no-prewarm`
- 遗留事项：当前 V2D0~V2D3 已完成；若仍需提升 2D 工业感，下一步建议增加“链路负载数字标注/节点聚类层级”任务。

- 日期：2026-02-15
- 完成内容：完成 Viewer 缩放上限放开，解决大场景下“无法拉远看全貌”问题。
  - 修改 `crates/agent_world_viewer/src/main.rs`：将 `ORBIT_MAX_RADIUS` 从 `300.0` 提升到 `5_000.0`。
  - 修改 `crates/agent_world_viewer/src/camera_controls.rs`：将 2D 正交缩放上限 `ORTHO_MAX_SCALE` 从 `8.0` 提升到 `128.0`。
  - 修改 `crates/agent_world_viewer/src/viewer_automation.rs`：同步自动化缩放上限 `AUTOMATION_ORTHO_MAX_SCALE` 到 `128.0`，保证截图闭环路径一致。
  - 新增测试：
    - `two_d_ortho_scale_supports_large_zoom_out`
    - `apply_orbit_input_zoom_out_clamps_to_expanded_max_radius`
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-open-world-sandbox-readiness.project.md`（新增并勾选 OWR3.8）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer camera_controls::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 120 --automation-steps "zoom=80" --no-prewarm`
- 遗留事项：当前闭环截图可稳定产出；若后续仍出现“全貌不完整”，建议在下一任务中增加“按场景包围盒自动初始缩放”策略，避免依赖手工缩放。

- 日期：2026-02-15
- 完成内容：完成缩放常量去重，改为单一来源。
  - 在 `crates/agent_world_viewer/src/main.rs` 新增共享常量：`ORTHO_MIN_SCALE`、`ORTHO_MAX_SCALE`。
  - 在 `crates/agent_world_viewer/src/camera_controls.rs` 移除本地 `ORTHO_*` 定义，改为引用父模块共享常量。
  - 在 `crates/agent_world_viewer/src/viewer_automation.rs` 移除 `AUTOMATION_ORTHO_*` 定义，自动化缩放改为与手动缩放共用 `ORTHO_*` 边界。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-open-world-sandbox-readiness.project.md`（新增并勾选 OWR3.9）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer camera_controls::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_automation::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：`agent_world_viewer` 仍存在既有未使用 import 警告（`selection_emphasis.rs`），与本任务无关，后续可单独清理。

- 日期：2026-02-15
- 完成内容：完成 QAG2/QAG3（Viewer 事件联动“快速定位 Agent”按钮）代码落地。
  - 修改 `crates/agent_world_viewer/src/selection_linking.rs`：新增 `quick_locate_agent_action`（优先定位当前选中 Agent，否则定位字典序首个 Agent），并补充按钮组件与标签刷新逻辑。
  - 修改 `crates/agent_world_viewer/src/egui_right_panel.rs`：在 Event Link 区新增“定位 Agent / Locate Agent”按钮并接入快速定位动作。
  - 修改 `crates/agent_world_viewer/src/ui_locale_text.rs`：新增 `quick_locate_agent_label`，并补充联动状态文案的中文映射。
  - 修改 `crates/agent_world_viewer/src/selection_linking/tests.rs`：新增快速定位行为测试，并更新事件联动按钮布局/标签测试覆盖。
  - 更新项目文档状态：`doc/world-simulator/viewer-agent-quick-locate.project.md`（QAG2~QAG4 勾选完成）。
- 完成内容：完成 QAG4/QAG5 回归与文档收口。
  - 更新 `doc/world-simulator.project.md`：勾选“Viewer 事件联动新增快速定位 Agent 按钮”。
  - 更新 `doc/world-simulator/viewer-agent-quick-locate.project.md`：QAG5 勾选完成，状态改为已完成。
  - 执行并通过回归验证（test_tier_required 本任务最小闭环）：
    - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer selection_linking::tests:: -- --nocapture`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer ui_locale_text -- --nocapture`
    - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - 提交钩子附带执行并通过：`env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`。
- 遗留事项：`agent_world_viewer` 仍有既有未使用 import 警告（`selection_emphasis.rs`），与本任务无关，后续可单独清理。

- 日期：2026-02-15
- 完成内容：补齐快速定位 Agent 按钮的旧 UI 系统调度接线。
  - 修改 `crates/agent_world_viewer/src/app_bootstrap.rs`：在 Update 链中接入 `selection_linking::handle_quick_locate_agent_button`。
  - 修改 `crates/agent_world_viewer/src/selection_linking.rs`：移除临时 `dead_code` 抑制属性。
  - 执行并通过回归：
    - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer selection_linking::tests:: -- --nocapture`
    - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：`agent_world_viewer` 仍有既有未使用 import 警告（`selection_emphasis.rs`），与本任务无关。

- 日期：2026-02-15
- 完成内容：新增“Viewer 2D/3D 可视化清晰度修复”文档与任务挂载。
  - 新增设计文档：`doc/world-simulator/viewer-2d-3d-clarity-fix.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-2d-3d-clarity-fix.project.md`。
  - 更新总项目文档：`doc/world-simulator.project.md`，新增清晰度修复任务 1~3 入口。
- 遗留事项：继续执行 CFX2（Location 尺度映射修复）并补齐测试与回归截图。

- 日期：2026-02-15
- 完成内容：完成 CFX2（Location 渲染尺度映射修复）。
  - 修改 `crates/agent_world_viewer/src/scene_helpers.rs`：Location 实体缩放从“米口径”改为按 `radius_cm * cm_to_unit` 的 world unit 映射，并增加渲染半径上下限钳制，避免 `llm_bootstrap` 场景中大体量碎片遮屏。
  - 新增测试：`location_render_radius_units_scales_by_world_units_and_clamps`。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-2d-3d-clarity-fix.project.md`（CFX2.1/CFX2.2 勾选完成）
    - `doc/world-simulator.project.md`（清晰度修复任务 1 勾选完成）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer location_render_radius_units_scales_by_world_units_and_clamps -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 120 --no-prewarm --keep-tmp`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 120 --automation-steps "mode=3d;wait=0.8" --no-prewarm --keep-tmp`
- 遗留事项：继续执行 CFX3（2D 自动聚焦缩放同步），解决 2D 自动聚焦半径变化未同步正交投影问题。

- 日期：2026-02-15
- 完成内容：完成 CFX3（2D 自动聚焦缩放同步）。
  - 修改 `crates/agent_world_viewer/src/camera_controls.rs`：将 2D 正交缩放同步函数提升为模块内可复用接口。
  - 修改 `crates/agent_world_viewer/src/auto_focus.rs`：2D 模式自动聚焦写入 `orbit.radius` 后，同步正交投影 `scale`；若投影类型异常则回填 2D 正交投影。
  - 新增测试：`apply_focus_to_camera_syncs_two_d_projection_scale_with_radius`。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-2d-3d-clarity-fix.project.md`（CFX3.1/CFX3.2 勾选完成）
    - `doc/world-simulator.project.md`（清晰度修复任务 2 勾选完成）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer apply_focus_to_camera_syncs_two_d_projection_scale_with_radius -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 120 --auto-focus-target first_fragment --auto-focus-radius 5000 --auto-focus-keep-2d --no-prewarm --keep-tmp`
- 遗留事项：继续执行 CFX4（默认信息密度收敛），并做最终截图回归对照收口。

- 日期：2026-02-15
- 完成内容：完成 CFX4（默认信息密度收敛与回归收口）。
  - 修改 `crates/agent_world_viewer/src/right_panel_module_visibility.rs`：调整右侧模块默认可见性，保留核心区块（controls/overview/event_link），默认收起 overlay/diagnosis/timeline/details。
  - 更新测试：`visibility_defaults_to_core_sections`，并保持持久化兼容用例通过。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-2d-3d-clarity-fix.project.md`（CFX4.1~CFX4.3 勾选完成，状态收口）
    - `doc/world-simulator.project.md`（清晰度修复任务 3 勾选完成）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer right_panel_module_visibility -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 120 --no-prewarm --keep-tmp`
- 遗留事项：清晰度修复 CFX1~CFX4 已完成；若后续仍有“3D 线框干扰”反馈，可新增“3D 世界网格默认隐藏/分级显示”任务。

- 日期：2026-02-15
- 完成内容：新增“Viewer 默认渲染 Frag 且不渲染 Location”设计与项目管理文档。
  - 新增设计文档：`doc/world-simulator/viewer-frag-default-rendering.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-frag-default-rendering.project.md`（FDR1 勾选完成，进入 FDR2）。
- 完成内容：执行文档任务回归检查。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续执行 FDR2/FDR3（代码改造与测试补齐）。

- 日期：2026-02-15
- 完成内容：完成 FDR2~FDR5（Viewer 默认渲染 Frag 且不渲染 Location）代码与文档收口。
  - 渲染路径改造：`location` 仅保留锚点实体（不再渲染外层 mesh/label 及 detail 子节点），`frag` 分块默认渲染，移除 frag 渲染开关与环境变量入口。
  - 选择与详情改造：新增 `FragmentElementMarker` 并接入 3D 选择链路；新增 `SelectionKind::Fragment`，详情面板新增 frag 分支，显示所属 `location`（ID 与名称）。
  - UI/配置改造：移除右侧面板 fragment 渲染开关；更新 overlay 配置结构与降级默认配置构造。
  - 测试更新：
    - 修复/更新 `tests_scene_entities` 以匹配“location 不可视、仅锚点”语义。
    - 新增 `rebuild_scene_spawns_fragments_by_default_without_location_mesh`。
    - 新增 `update_ui_populates_fragment_selection_details_with_owner_location`。
    - 修复 `egui_kittest_module_toggle_switches_visibility` 的默认状态断言。
  - 文档更新：`doc/viewer-manual.md` 移除 frag 开关/环境变量描述，更新为“默认渲染 frag + frag 详情显示所属 location”。
  - 项目文档状态：`doc/world-simulator/viewer-frag-default-rendering.project.md` 勾选 FDR2~FDR5 并标记完成。
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：`agent_world_viewer` 存在既有未使用代码/导入告警（location detail 旧渲染辅助与材质句柄），与本任务目标无冲突，后续可单独清理。

- 日期：2026-02-15
- 完成内容：完成 Viewer 编译告警清理（`agent_world_viewer` warning=0）。
  - 清理 `scene_helpers` / `scene_helpers_entities` 中已失效的 Location detail 遗留代码（未使用常量、函数与导入），保留当前“location 仅锚点 + frag 默认渲染”语义。
  - 清理 `selection_emphasis.rs` 未使用导入（仅保留运行时依赖，测试改为显式导入 `SelectionInfo/SelectionKind`）。
  - 清理 `Viewer3dAssets` 中未使用的 `location_material_library` 依赖链；同步精简 `material_library.rs` 中仅测试侧使用的旧 location 材质构建逻辑。
  - 同步更新测试构造：`tests_scene_entities.rs`、`tests_scene_grid.rs` 移除已删除字段初始化。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-frag-default-rendering.project.md`（新增并勾选 FDR6）
    - `doc/world-simulator.project.md`（新增并勾选 Viewer 编译告警清理项）
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：当前 `agent_world_viewer` 编译告警已清零；后续若重新引入 location 细节渲染，需以新任务重新设计并接入最小可验证测试。

- 日期：2026-02-15
- 完成内容：新增“Viewer Frag 实际比例与选中显示修复”文档与任务挂载。
  - 新增设计文档：`doc/world-simulator/viewer-frag-scale-selection-fix.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-frag-scale-selection-fix.project.md`（FSF1.1/FSF1.2 勾选完成）。
  - 更新总项目文档：`doc/world-simulator.project.md`，新增 frag 比例修复与选中显示修复任务入口。
- 完成内容：执行文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续执行 FSF2（frag 尺度线性映射 + 选中显示修复）并补齐测试回归。

- 日期：2026-02-15
- 完成内容：完成 FSF2（frag 实际比例与选中显示修复）代码落地。
  - 修改 `crates/agent_world_viewer/src/scene_helpers.rs`：`location_render_radius_units` 改为 `radius_cm * cm_to_unit` 线性映射，移除渲染钳制，确保 frag 尺寸比例与数据口径一致。
  - 修改 `crates/agent_world_viewer/src/location_fragment_render.rs`：frag 分块实体新增 `BaseScale`（取初始 `Transform.scale`），修复选中高亮后比例被覆盖、取消选中无法恢复的问题。
  - 修改测试：
    - `crates/agent_world_viewer/src/tests_scene_entities.rs`：`spawn_location_entity_uses_linear_anchor_radius_scale`。
    - `crates/agent_world_viewer/src/tests_scene_grid.rs`：新增 `rebuild_scene_fragment_entities_preserve_base_scale_for_selection_reset`。
    - `crates/agent_world_viewer/src/scene_helpers.rs`：更新尺度映射单测为无钳制口径。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-frag-scale-selection-fix.project.md`（FSF2~FSF4 勾选完成，状态收口）。
    - `doc/world-simulator.project.md`（frag 比例修复与选中显示修复勾选完成）。
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer location_render_radius_units_scales_by_world_units_without_clamp -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer rebuild_scene_fragment_entities_preserve_base_scale_for_selection_reset -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_location_entity_uses_linear_anchor_radius_scale -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：FSF1~FSF4 已完成；若后续仍有“超大 frag 首屏压画面”反馈，可新增“真实尺度 + 视图辅助层”任务，不回退数据比例。

- 日期：2026-02-15
- 完成内容：完成 FSF5（二次修复：误选与选中缩放）代码落地。
  - 修改 `crates/agent_world_viewer/src/selection_linking.rs`：`pick_3d_selection` 的 location 拾取改为 `With<Mesh3d>` 过滤，避免点击时误选不可见 location 锚点。
  - 修改 `crates/agent_world_viewer/src/scene_helpers.rs`：新增 `should_apply_scale_highlight`，对 `SelectionKind::Fragment` 返回 false。
  - 修改 `crates/agent_world_viewer/src/main.rs`、`crates/agent_world_viewer/src/selection_linking.rs`、`crates/agent_world_viewer/src/event_click_list.rs`：高亮逻辑按 `should_apply_scale_highlight` 分支，frag 选中不再缩放，保持真实比例。
  - 新增/更新测试：
    - `selection_linking::tests::apply_selection_does_not_scale_fragment_entity`
    - `scene_helpers::depletion_tests::should_apply_scale_highlight_skips_fragment`
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-frag-scale-selection-fix.project.md`（FSF5.1~FSF5.3 勾选完成）。
    - `doc/world-simulator.project.md`（新增并勾选 frag 二次修复项）。
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer apply_selection_does_not_scale_fragment_entity -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer should_apply_scale_highlight_skips_fragment -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：FSF1~FSF5 已完成；若仍出现“点击不稳定”，下一步建议把点选由“点到线距离”升级为“包围体射线命中”以进一步提升稳定性。

- 日期：2026-02-15
- 完成内容：完成 FSF6（frag 三次修复：去掉黄色 halo + Agent 量纲修正）代码落地。
  - 修改 `crates/agent_world_viewer/src/selection_emphasis.rs`：`SelectionKind::Fragment` 选中时不再显示 selection halo，并补充 `selection_emphasis_hides_halo_for_fragment_selection`。
  - 修改 `crates/agent_world_viewer/src/scene_helpers.rs`：Agent 几何尺寸（主体、模块环、标签偏移、附着位置）统一按 `effective_cm_to_unit` 映射至世界单位，修复与 frag/位置半径量纲不一致问题。
  - 修改 `crates/agent_world_viewer/src/scene_helpers_entities.rs`：2D Agent 地图标记的半径/厚度/偏移统一按世界单位缩放。
  - 修改 `crates/agent_world_viewer/src/tests_scene_entities.rs`：更新 Agent 尺寸与位置断言，按 `effective_cm_to_unit` 推导期望值，避免旧米制常量导致误判。
  - 更新项目文档状态：
    - `doc/world-simulator/viewer-frag-scale-selection-fix.project.md`（勾选 FSF6.1~FSF6.3，标记 FSF1~FSF6 已完成）
    - `doc/world-simulator.project.md`（勾选“Viewer Frag 三次修复”）
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：若后续反馈“真实尺度下目标过小导致点选难度上升”，建议新增“非侵入式辅助视觉层”任务（仅辅助显示，不改真实尺度）。

- 日期：2026-02-15
- 完成内容：完成 FSF7（相机缩放/裁剪量纲修复，恢复 Agent 放大可见性）代码落地。
  - 修改 `/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/camera_controls.rs`：
    - 新增 `orbit_min_radius(cm_to_unit)`，将 Orbit 最小半径按 `effective_cm_to_unit` 映射到世界单位，修复默认最小半径过大导致无法靠近 Agent。
    - 调整 `camera_projection_for_mode`：近裁剪面按世界单位缩放，远裁剪面按“物理 far 映射值 vs 世界视野兜底值”取较大值，避免放大时近裁剪吞掉小尺度实体。
    - 更新相机相关单测，新增 `camera_projection_scales_near_and_keeps_far_covering_world`、`orbit_min_radius_scales_with_world_units`。
  - 修改 `/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/auto_focus.rs`：
    - 自动聚焦/快捷聚焦半径下限改为米制语义再映射至世界单位，避免聚焦逻辑把相机强制拉回“公里级半径”。
  - 修改 `/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/viewer_automation.rs`：
    - automation `ZoomFactor` 使用动态最小半径口径，和手动缩放行为对齐。
  - 更新项目文档状态：
    - `/Users/scc/ccwork/agent-world/doc/world-simulator/viewer-frag-scale-selection-fix.project.md`（FSF7.1~FSF7.3 勾选完成）
    - `/Users/scc/ccwork/agent-world/doc/world-simulator.project.md`（勾选 Viewer Frag 四次修复）
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：若后续在超大场景中仍反馈“目标可见但点选困难”，建议新增“可选辅助描边/图标层”任务，不改真实几何尺度。

- 日期：2026-02-15
- 完成内容：完成 OVZ1（Viewer 全览图缩放切换）文档任务初始化。
  - 新增设计文档：`/Users/scc/ccwork/agent-world/doc/world-simulator/viewer-overview-map-zoom.md`。
  - 新增项目管理文档：`/Users/scc/ccwork/agent-world/doc/world-simulator/viewer-overview-map-zoom.project.md`（OVZ1.1/OVZ1.2 勾选）。
  - 更新总项目文档：`/Users/scc/ccwork/agent-world/doc/world-simulator.project.md`，挂载全览图任务入口。
- 完成内容：执行文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续执行 OVZ2/OVZ3（缩放层级状态机、可见性联动与测试收口）。

- 日期：2026-02-15
- 完成内容：完成 OVZ2/OVZ3（Viewer 全览图缩放切换）代码与回归。
  - 缩放层级机制：
    - 在 `/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/camera_controls.rs` 新增 `TwoDZoomTier`（`Detail/Overview`）与迟滞阈值判定（`sync_two_d_zoom_tier`）。
    - 2D 默认 orbit 半径改为细节态默认倍率（不再默认世界全宽视角）。
  - 全览图可见性联动：
    - `TwoDMapMarker` 改为仅在 `TwoD + Overview` 显示。
    - 新增 `DetailZoomEntity`（`/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/scene_helpers.rs`），在 `TwoD + Overview` 隐藏细节几何（Agent 细节与 frag 分块）。
    - `DetailZoomEntity` 接入 `spawn_agent_entity` 与 `/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/location_fragment_render.rs`。
  - 调度接入：
    - `/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/app_bootstrap.rs` 新增 `TwoDZoomTier` 资源并接入 `sync_two_d_zoom_tier/sync_two_d_map_marker_visibility/sync_detail_zoom_visibility` 系统顺序。
    - `/Users/scc/ccwork/agent-world/crates/agent_world_viewer/src/main.rs` 补充 `TwoDZoomTier` 导入供启动装配使用。
  - 测试更新：
    - 在 `camera_controls` 新增 `two_d_zoom_tier_switches_with_hysteresis`、`detail_zoom_visibility_hides_detail_entities_in_overview`，并更新 `two_d_map_marker_visibility_follows_zoom_tier`。
    - 全量 `agent_world_viewer` 测试从 211 增至 213，全部通过。
  - 项目文档更新：`/Users/scc/ccwork/agent-world/doc/world-simulator/viewer-overview-map-zoom.project.md` 勾选 OVZ2.1~OVZ3.2。
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：执行 OVZ4.1（总项目文档勾选与最终收口）。

- 日期：2026-02-15
- 完成内容：完成 OVZ3.3~OVZ3.5（全览图缩放切换后续修复）并收口“先放大后立刻变小”问题。
  - 修改 `crates/agent_world_viewer/src/auto_focus.rs`：启动自动聚焦完成后统一设置 `skip_next_mode_sync`，避免首帧 `sync_camera_mode` 把已聚焦半径回写为默认值。
  - 修改 `crates/agent_world_viewer/src/camera_controls.rs`：
    - 调整 2D Detail/Overview 阈值口径（基于 detail 半径倍数，含迟滞）。
    - `TwoDMapMarker` 改为仅在 `TwoD + Overview` 可见；新增 `sync_two_d_map_marker_scale`，在 Overview 按缩放级别放大标记层。
    - 新增/更新单测：`two_d_map_marker_scale_boosts_in_overview_and_resets_in_detail`、`two_d_map_marker_visibility_follows_zoom_tier`、`sync_camera_mode_two_d_projection_matches_orbit_radius`。
  - 修改 `crates/agent_world_viewer/src/scene_helpers_entities.rs`：回退 2D Agent 标记到物理口径（移除调试期超大半径），并为 map marker 挂载 `BaseScale`。
  - 修改 `crates/agent_world_viewer/src/main.rs`、`crates/agent_world_viewer/src/scene_helpers.rs`：为 scene root 与 location anchor 补齐 `Visibility`，修复层级可见性传播告警（B0004）。
  - 修改 `crates/agent_world_viewer/src/app_bootstrap.rs`：接入 `sync_two_d_map_marker_scale` 调度顺序。
  - 更新文档状态：
    - `doc/world-simulator/viewer-overview-map-zoom.md`
    - `doc/world-simulator/viewer-overview-map-zoom.project.md`（OVZ1~OVZ4 全部完成）
    - `doc/world-simulator.project.md`（勾选 Viewer 全览图缩放切换）
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5023 --tick-ms 300 --viewer-wait 12 --capture-max-wait 120 --no-prewarm --keep-tmp`
- 遗留事项：无；若后续需要进一步增强 Factorio 式全览交互（例如显式 minimap UI 或一键切层），可新开任务单独设计。

- 日期：2026-02-15
- 完成内容：完成 Agent frag 初始站位优化（放在数据初始化阶段）。
  - 新增设计文档：`doc/world-simulator/agent-frag-initial-spawn-position.md`。
  - 新增项目文档：`doc/world-simulator/agent-frag-initial-spawn-position.project.md`。
  - 修改 `crates/agent_world/src/simulator/init.rs`：Agent 出生候选改为“有 frag 时优先 frag”；frag 出生位通过初始化阶段直接写入“上方 + 约 50m”坐标。
  - 新增 `crates/agent_world/src/simulator/frag_spawn.rs`：封装 frag 出生偏移计算与边界降级（优先 50m，越界时降级到 20m，仍越界则回退中心）。
  - 新增测试 `crates/agent_world/src/simulator/tests/init_agent_frag_spawn.rs`，并在 `tests/mod.rs` 挂载。
  - 更新总项目文档：`doc/world-simulator.project.md` 挂载并勾选对应任务项。
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world init_agent_frag_spawn -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_bootstrap_seeds_fragments_and_resources -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
- 遗留事项：若后续希望“当前位置观测距离与 location_id 严格一致（当前地点 distance=0）”，可追加单独任务在 observation 层做一致性口径收敛。

- 日期：2026-02-15
- 完成内容：完成 Agent frag 初始站位 FSP4（二次修复：2D 视角遮挡）。
  - 修改 `crates/agent_world/src/simulator/frag_spawn.rs`：frag 出生方向改为严格正上方（`x/y` 与 frag 中心一致，仅抬升 `z`），优先 50m 表面间距，越界降级 20m，仍越界回退中心。
  - 修改 `crates/agent_world_viewer/src/scene_helpers.rs`：`agent_translation_for_render` 改为保留预计算径向距离 standoff，不再将 Agent 强制贴回 frag 表面。
  - 更新初始化测试 `crates/agent_world/src/simulator/tests/init_agent_frag_spawn.rs`：新增 `x/y` 对齐断言，确保“正上方”语义。
  - 新增 Viewer 测试：
    - `crates/agent_world_viewer/src/tests_scene_entities.rs`：`spawn_agent_entity_preserves_location_standoff_distance`
    - `crates/agent_world_viewer/src/tests.rs`：`spawn_agent_surface_standoff_test_system`
  - 更新文档：
    - `doc/world-simulator/agent-frag-initial-spawn-position.md`
    - `doc/world-simulator/agent-frag-initial-spawn-position.project.md`
    - `doc/world-simulator.project.md`
- 完成内容：执行并通过回归验证（test_tier_required 本任务最小闭环）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world init_agent_frag_spawn -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_agent_entity_attaches_to_location_surface -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer spawn_agent_entity_preserves_location_standoff_distance -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：若后续仍有个别场景遮挡，可追加“2D 模式下 Agent 标记层始终可见”任务，作为视觉兜底层与物理坐标并行。


- 日期：2026-02-15
- 完成内容：完成 WCM2/WCM3（Viewer 2D/3D WASD 相机移动）代码落地与回归。
  - 修改 `crates/agent_world_viewer/src/camera_controls.rs`：
    - 新增 `W/A/S/D` 输入轴解析，支持 2D/3D 相机平面移动（更新 `OrbitCamera.focus`）。
    - 新增 EGUI 键盘占用保护：当右侧文本输入占用键盘时，WASD 不触发相机移动。
    - 新增移动速度缩放与 Shift 加速分支。
  - 新增单测：
    - `wasd_axis_maps_pressed_keys`
    - `apply_keyboard_pan_two_d_moves_focus_on_horizontal_plane`
    - `apply_keyboard_pan_three_d_follows_camera_heading`
    - `apply_keyboard_pan_shift_boost_moves_faster`
  - 执行并通过 `test_tier_required` 最小闭环：
    - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer camera_controls::tests:: -- --nocapture`
    - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 完成内容：完成 WCM4 收口（文档与状态同步）。
  - 更新 `doc/viewer-manual.md`：补充 WASD 交互说明与生效边界（3D 视口 + 非文本输入）。
  - 更新项目管理文档：
    - `doc/world-simulator/viewer-wasd-camera-navigation.project.md`（WCM4 勾选完成，状态收口）
    - `doc/world-simulator.project.md`（WASD 任务总项勾选完成）
  - 执行并通过收口回归：
    - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：当前 WASD 导航功能已交付；如后续有“移动速度体感”反馈，可新增独立任务引入可配置速度档位。


- 日期：2026-02-15
- 完成内容：完成 CI 增加 `wasm32-unknown-unknown` target 的修复，解决 builtin wasm 工件校验路径在 CI 上可能因 target 缺失失败的问题。
  - 新增设计文档：`doc/testing/ci-wasm32-target-install.md`。
  - 新增项目管理文档：`doc/testing/ci-wasm32-target-install.project.md`，并在任务完成后回写为已完成状态。
  - 修改 `.github/workflows/rust.yml`：在 `required-gate` 与 `full-regression` 两个 job 中新增步骤 `rustup target add wasm32-unknown-unknown`。
- 完成内容：执行并通过最小闭环验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_builtin_wasm --target wasm32-unknown-unknown`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：当前任务无遗留；后续如 CI 继续引入新 target，应保持在 workflow 中显式安装依赖 target。


- 日期：2026-02-15
- 完成内容：完成 Wasm 构建一致性与模块身份升级（WIR-1~WIR-4）。
  - 新增设计/项目文档：
    - `doc/world-runtime/wasm-artifact-identity-reproducibility.md`
    - `doc/world-runtime/wasm-artifact-identity-reproducibility.project.md`
  - 固定 toolchain 并对齐 CI：
    - 新增 `rust-toolchain.toml`（`channel=1.92.0`，包含 `rustfmt` 与 `wasm32-unknown-unknown`）。
    - 更新 `.github/workflows/rust.yml`，在两个 job 中安装并切换到固定 Rust toolchain。
  - 模块身份升级（兼容模式）：
    - `crates/agent_world_wasm_abi/src/lib.rs` 新增 `ModuleArtifactIdentity`（`source_hash/build_manifest_hash/artifact_signature`）。
    - `ModuleManifest` 新增可选字段 `artifact_identity`（`Option` + serde 默认），保持旧 manifest 可反序列化。
    - runtime 校验增强：若声明 `artifact_identity`，必须完整且签名匹配当前 `wasm_hash`（当前校验 `unsigned:` 语义签名）。
  - bootstrap 模块身份接线：
    - `bootstrap_power.rs`、`bootstrap_economy.rs` 内置模块 manifest 默认写入 `artifact_identity`。
  - 测试补充：
    - `agent_world_wasm_abi` 新增 `module_artifact_identity_unsigned_signature_roundtrip`。
    - `agent_world` 新增：
      - `shadow_rejects_incomplete_module_artifact_identity`
      - `shadow_rejects_module_artifact_identity_signature_mismatch`
- 完成内容：执行并通过回归验证。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi module_artifact_identity_unsigned_signature_roundtrip -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world shadow_rejects_incomplete_module_artifact_identity -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world shadow_rejects_module_artifact_identity_signature_mismatch -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --tests --features test_tier_required`
- 遗留事项：
  - 当前 `artifact_signature` 采用 `unsigned:` 语义占位校验；后续需接入真实签名与密钥治理。
  - “节点先拉取构建结果，失败再本地编译”的网络闭环尚未落地协议实现，当前已在设计文档中定为下一阶段任务。


- 日期：2026-02-15
- 完成内容：完成 BWD-2~BWD-5（Builtin Wasm DistFS 存储与提交前校验）代码落地。
  - 脚本改造：
    - `scripts/sync-m1-builtin-wasm-artifacts.sh` 改为“build -> hash manifest 校验 -> DistFS 落盘（`.distfs/builtin_wasm/blobs/<sha256>.blob`）”，并保持 `--check` 作为提交前门禁入口。
    - `scripts/sync-m4-builtin-wasm-artifacts.sh` 同步改造为复用新行为。
  - 提交前链路改造：
    - `scripts/pre-commit.sh` 显式接入 `sync-m1/m4 --check`，并以 `CI_SKIP_BUILTIN_WASM_CHECKS=1` 调用 `scripts/ci-tests.sh required` 避免重复执行。
    - `scripts/ci-tests.sh` 增加 `CI_SKIP_BUILTIN_WASM_CHECKS` 开关，默认保持 CI 校验不变。
  - 运行时改造：
    - `crates/agent_world/src/runtime/m1_builtin_wasm_artifact.rs`
    - `crates/agent_world/src/runtime/m4_builtin_wasm_artifact.rs`
    - `crates/agent_world/src/runtime/world/bootstrap_power.rs`
    - `crates/agent_world/src/runtime/world/bootstrap_economy.rs`
    - 从 `include_bytes!` 嵌入改为“按 git 追踪 hash 清单从 DistFS blob 读取 + SHA-256 校验”。
  - git 追踪策略改造：
    - 移除 `crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules/*.wasm` 与 `m4_builtin_modules/*.wasm` 的 git 追踪。
    - 更新 `.gitignore`，忽略 `.distfs/` 与上述 wasm 路径。
- 完成内容：更新文档状态。
  - 更新 `doc/scripts/pre-commit.md`、`doc/scripts/pre-commit.project.md`（说明 pre-commit 已恢复 wasm 校验并接入 DistFS 落盘）。
  - 更新 `doc/world-runtime/builtin-wasm-distfs-storage.project.md`（BWD-2~BWD-6 勾选完成）。
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：当前任务无遗留；如后续需要将 DistFS blob 迁移到远端分发，可在新任务中扩展拉取与签名治理。


- 日期：2026-02-15
- 完成内容：完成 DAC-1（Builtin Wasm DistFS API 闭环）文档建模。
  - 新增设计文档：`doc/world-runtime/builtin-wasm-distfs-api-closure.md`。
  - 新增项目管理文档：`doc/world-runtime/builtin-wasm-distfs-api-closure.project.md`。
- 完成内容：执行并通过文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_distfs`
- 遗留事项：继续执行 DAC-2~DAC-5（distfs API 扩展、脚本与 runtime 接线、回归收口）。


- 日期：2026-02-15
- 完成内容：完成 DAC-2~DAC-4（Builtin Wasm DistFS API 闭环）代码落地。
  - 扩展 `agent_world_distfs`：
    - `crates/agent_world_distfs/src/lib.rs` 新增 `HashAlgorithm`（`Blake3`/`Sha256`）与 `LocalCasStore::new_with_hash_algorithm`。
    - `LocalCasStore` 的 `put/put_bytes` 改为按实例 hash 策略校验与写入。
    - 新增 `LocalCasStore::get_verified`，读取后按实例 hash 策略校验内容。
    - 新增测试 `cas_sha256_roundtrip_and_verify`。
  - 新增 DistFS hydrate 工具：
    - `crates/agent_world_distfs/src/bin/hydrate_builtin_wasm.rs`。
    - 按 `module_id -> sha256` manifest + built wasm 目录批量写入 DistFS blob（通过 `LocalCasStore::put`）。
  - 脚本接线：
    - `scripts/sync-m1-builtin-wasm-artifacts.sh` 改为调用 `hydrate_builtin_wasm` 完成 DistFS 写入（校验路径与同步路径统一）。
  - runtime 读取接线：
    - `crates/agent_world/src/runtime/m1_builtin_wasm_artifact.rs`
    - `crates/agent_world/src/runtime/m4_builtin_wasm_artifact.rs`
    - 改为通过 `LocalCasStore::new_with_hash_algorithm(..., HashAlgorithm::Sha256)` + `get_verified` 读取 builtin wasm。
    - `crates/agent_world/src/runtime/blob_store.rs`、`crates/agent_world/src/runtime/mod.rs` 同步导出 `HashAlgorithm`。
- 完成内容：更新项目管理文档状态。
  - 更新 `doc/world-runtime/builtin-wasm-distfs-api-closure.project.md`，勾选 DAC-2~DAC-5 并收口状态。
- 完成内容：执行并通过回归验证（test_tier_required）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `./scripts/sync-m4-builtin-wasm-artifacts.sh --check`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：当前任务无遗留；后续若 wasm 模块数量继续增长，可考虑将 hydrate 工具与 build suite 合并，减少脚本层 `cargo run` 次数。


- 日期：2026-02-15
- 完成内容：完成 WBR1（Viewer Bevy 浏览器运行路径）文档建模与总项目挂载。
  - 新增设计文档：`doc/world-simulator/viewer-bevy-web-runtime.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-bevy-web-runtime.project.md`。
  - 更新总项目文档：`doc/world-simulator.project.md`，新增浏览器运行路径任务入口。
- 完成内容：执行并通过文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续执行 WBR2~WBR4（wasm 兼容改造、Web 启动入口、回归收口）。


- 日期：2026-02-15
- 完成内容：完成 WBR2~WBR4（Viewer Bevy 浏览器运行路径）代码与入口接入。
  - `agent_world` wasm 兼容：
    - `crates/agent_world/src/simulator/llm_agent.rs`
    - `OpenAiChatCompletionClient::build_http_client` 在 `wasm32` 下不再调用 `reqwest::ClientBuilder::timeout`，修复 wasm 目标编译失败。
  - `agent_world_viewer` wasm 兼容：
    - `crates/agent_world_viewer/src/main.rs`
    - 新增 `cfg(target_arch = "wasm32")` Web 入口，浏览器端固定离线 UI；TCP 连接链路按 `cfg` 仅保留 native。
    - 同步收敛 wasm 下未使用路径：`app_bootstrap.rs`、`headless.rs`、`ui_state_types.rs`、`ui_text.rs`。
  - 新增 Web 启动入口：
    - `crates/agent_world_viewer/index.html`（trunk rust pipeline，`data-bin=agent_world_viewer`）。
    - `scripts/run-viewer-web.sh`（检查 `trunk` 与 wasm target 后执行 `trunk serve`）。
  - 文档更新：
    - `doc/viewer-manual.md` 增加浏览器模式启动说明。
    - `doc/world-simulator/viewer-bevy-web-runtime.project.md` 与 `doc/world-simulator.project.md` 更新为完成状态。
- 完成内容：执行并通过回归验证。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：浏览器在线连接 `world_viewer_live` 仍未接入；后续可新增 WebSocket/HTTP bridge 任务打通在线模式。


- 日期：2026-02-15
- 完成内容：完成 Viewer Web 路径的 Playwright 闭环验证与离线模式 panic 修复。
  - 触发与定位：
    - 使用 Playwright 打开 `http://127.0.0.1:4173`，console 捕获到 wasm panic：
      - `timeline_controls::handle_control_buttons` 在离线 Web 模式下强依赖 `Res<ViewerClient>`，资源不存在导致崩溃。
  - 修复实现：
    - `crates/agent_world_viewer/src/timeline_controls.rs`
    - `handle_control_buttons` 改为 `Option<Res<ViewerClient>>`，离线时跳过发送控制请求。
    - `handle_timeline_seek_submit` 改为 `Option<Res<ViewerClient>>`，离线时仅更新本地时间轴状态。
  - Playwright 闭环产物：
    - `output/playwright/viewer-web-home.png`（修复前验证）
    - `output/playwright/viewer-web-home-after-fix-restart.png`（修复后复测）
    - `.playwright-cli/console-2026-02-15T12-10-31-115Z.log`（error=0）
    - `.playwright-cli/console-2026-02-15T12-10-32-260Z.log`（仅 1 条 Chromium SRI warning）
- 完成内容：执行并通过回归验证。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - Playwright（Node 20）：open/snapshot/screenshot/console/eval 闭环验证通过
- 遗留事项：当前 Web 运行仍为离线模式；在线连接 `world_viewer_live` 需后续引入 WebSocket/HTTP bridge。


- 日期：2026-02-15
- 完成内容：完成 WCT1（Viewer Web 端闭环测试策略）文档建模。
  - 新增设计文档：`doc/world-simulator/viewer-web-closure-testing-policy.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-web-closure-testing-policy.project.md`。
  - 更新总项目文档：`doc/world-simulator.project.md`，挂载 WCT 任务入口。
- 完成内容：执行并通过文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续执行 WCT2~WCT3（批量迁移文档口径到 Web 默认 + 回归收口）。


- 日期：2026-02-15
- 完成内容：完成 WCT2（Viewer 闭环文档口径迁移到 Web 默认）。
  - 更新 `AGENTS.md`：Agent 闭环流程改为 `run-viewer-web.sh + Playwright`，`capture-viewer-frame.sh` 调整为 fallback。
  - 更新 `doc/viewer-manual.md`：截图闭环章节改为 Web 默认流程与验收口径。
  - 更新 `doc/scripts/capture-viewer-frame.md` 与 `doc/scripts/capture-viewer-frame.project.md`：明确 native fallback 定位。
  - 更新 `doc/world-simulator/viewer-bevy-web-runtime.md` 与 `doc/world-simulator/viewer-bevy-web-runtime.project.md`：补充“Web 默认闭环”策略约束。
  - 更新 `doc/world-simulator/viewer-web-closure-testing-policy.project.md`：WCT2.1~WCT2.4 标记完成。
- 完成内容：执行并通过文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：继续执行 WCT3（wasm check + Web 脚本 help + Playwright 闭环验证），并更新总项目状态与日志收口。


- 日期：2026-02-15
- 完成内容：完成 WCT3（Viewer Web 端闭环策略回归与收口）。
  - 执行并通过 wasm 最小回归：`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`。
  - 执行并通过 Web 脚本 help 校验：`./scripts/run-viewer-web.sh --help`。
  - 执行并通过 Playwright 闭环验证（使用 nvm Node 24）：
    - `open http://127.0.0.1:4173`
    - `snapshot`
    - `console error`（结果：`0 errors`）
    - `screenshot`
  - 闭环证据产物：
    - `output/playwright/viewer/viewer-web-wct3.png`
    - `output/playwright/viewer/snapshot.txt`
    - `output/playwright/viewer/console-error.log`
    - `output/playwright/viewer/screenshot.log`
- 完成内容：更新项目状态文档。
  - `doc/world-simulator/viewer-web-closure-testing-policy.project.md`：WCT3.1/WCT3.2 标记完成。
  - `doc/world-simulator.project.md`：`Viewer 闭环测试默认切换到 Web 端（Playwright）` 标记完成。
- 遗留事项：后续 Viewer 闭环任务统一走 Web 端；仅在 Web 无法复现或 native 图形链路问题时使用 `capture-viewer-frame` fallback。


- 日期：2026-02-15
- 完成内容：完成 WLB1（Viewer WebSocket/HTTP bridge）文档建模。
  - 新增设计文档：`doc/world-simulator/viewer-websocket-http-bridge.md`。
  - 新增项目管理文档：`doc/world-simulator/viewer-websocket-http-bridge.project.md`。
  - 更新总项目文档：`doc/world-simulator.project.md`，挂载 WLB 任务入口。
- 完成内容：执行并通过文档任务最小回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
- 遗留事项：继续执行 WLB2~WLB4（bridge 后端实现 + wasm 客户端接入 + 文档与闭环收口）。


- 日期：2026-02-15
- 完成内容：完成 WLB2（后端 WebSocket/HTTP bridge）。
  - 新增 `crates/agent_world/src/viewer/web_bridge.rs`：实现 `WebSocket <-> TCP line protocol` 双向桥接。
  - 更新 `crates/agent_world/src/viewer/mod.rs`：导出 `ViewerWebBridge*`。
  - 更新 `crates/agent_world/src/bin/world_viewer_live.rs`：新增 `--web-bind <addr>`，可同进程启动 bridge。
  - 更新 `crates/agent_world/Cargo.toml`：增加 `tungstenite` 依赖。
  - 更新 `doc/world-simulator/viewer-websocket-http-bridge.project.md`：WLB2 状态勾选完成。
- 完成内容：执行并通过 WLB2 回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
- 遗留事项：继续执行 WLB3（wasm WebSocket 客户端接入）并打通 Web 在线显示链路。


- 日期：2026-02-15
- 完成内容：完成 WLB3（Web Viewer wasm WebSocket 接入）。
  - 更新 `crates/agent_world_viewer/src/main.rs`：
    - wasm `main` 改为在线模式启动（不再固定 offline）。
    - 新增 WebSocket 客户端链路（open/message/error/close 回调 + 请求发送循环）。
    - 支持 URL 参数覆盖连接地址（`?ws=...` 或 `?addr=...`），默认 `ws://127.0.0.1:5011`。
  - 更新 `crates/agent_world_viewer/Cargo.toml`：新增 wasm 端依赖（`web-sys`/`wasm-bindgen`/`gloo-timers`/`getrandom(js)`）。
  - 更新 `doc/world-simulator/viewer-websocket-http-bridge.project.md`：WLB3 状态勾选完成。
- 完成内容：执行并通过 WLB3 回归。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：继续执行 WLB4（文档口径迁移 + live Web 闭环验证收口）。


# 开发日志（2026-02-15）

## 日期
- 2026-02-15

## 完成内容
- 完成 Viewer WebSocket/HTTP bridge 文档收口（WLB4）：
  - 更新 `AGENTS.md`，将闭环默认流程统一为 `live server (--web-bind) + Web Viewer + Playwright`。
  - 更新 `doc/viewer-manual.md`，补齐 `llm_bootstrap` Web 在线联调命令与 `?ws=` 页面访问方式。
  - 更新 `doc/world-simulator/viewer-bevy-web-runtime.md` 与 `.project.md`，同步当前 Web 在线连接口径，移除“默认离线”旧描述。
  - 更新 `doc/world-simulator/viewer-websocket-http-bridge.project.md`，将 WLB4 全部任务标记为完成。
  - 更新 `doc/world-simulator.project.md`，将“Viewer Web 在线 bridge 接入”标记为完成并刷新最近更新说明。
- 完成 Web 端在线闭环验证（Playwright）：
  - live server: `world_viewer_live llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300`
  - web viewer: `run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - Playwright: `open/snapshot/console/screenshot --filename`
  - 产物：
    - `output/playwright/viewer/viewer-web-live.png`
    - `output/playwright/viewer/snapshot-live.log`
    - `output/playwright/viewer/console-live.log`
- 执行回归检查：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`

## 遗留事项
- bridge 目前以本地开发为目标，后续可补充压力测试（长连接、断连重连、慢消费者）与多会话隔离策略。


- 日期：2026-02-15
- 完成内容：完成 BFC（Builtin Wasm 先拉取后编译回退）实现与 full 闭环测试。
  - 文档：
    - 新增 `doc/world-runtime/builtin-wasm-fetch-fallback-compile.md`
    - 新增 `doc/world-runtime/builtin-wasm-fetch-fallback-compile.project.md`
  - runtime 实现：
    - 新增 `crates/agent_world/src/runtime/builtin_wasm_materializer.rs`，实现 builtin wasm 装载顺序：
      1) 本地 distfs 命中；
      2) 网络拉取（`AGENT_WORLD_BUILTIN_WASM_FETCHER` / `AGENT_WORLD_BUILTIN_WASM_FETCH_URLS`）；
      3) 拉取失败回退本地编译（`AGENT_WORLD_BUILTIN_WASM_COMPILER` 或默认 `scripts/build-wasm-module.sh`）。
    - `m1_builtin_wasm_artifact.rs`、`m4_builtin_wasm_artifact.rs` 接入统一 materializer。
  - 测试：
    - 新增 `crates/agent_world/src/runtime/tests/builtin_wasm_materializer.rs`
    - 闭环覆盖 `fetch miss -> fallback compile -> 写回 distfs -> 校验可读`（`test_tier_full`）。
- 完成内容：执行并通过回归验证。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::power_bootstrap::install_power_bootstrap_modules_registers_and_activates --features "test_tier_full,wasmtime" -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::builtin_wasm_materializer::materializer_fetch_miss_falls_back_to_compile_and_caches_blob --features "test_tier_full,wasmtime" -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features "test_tier_full,wasmtime,viewer_live_integration" runtime::tests::builtin_wasm_materializer::materializer_fetch_miss_falls_back_to_compile_and_caches_blob -- --nocapture`
- 遗留事项：
  - 目前网络拉取优先通过环境变量注入（fetcher / URL），尚未绑定统一的 p2p artifact 协议实现。


- 日期：2026-02-15
- 完成内容：修复 Web Viewer 构建时 `reqwest::blocking` 在 `wasm32` 目标不可用导致的编译失败。
  - 复现命令：`env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - 报错位置：`crates/agent_world/src/runtime/builtin_wasm_materializer.rs`
  - 修复内容：
    - 对 `try_fetch_via_http` 增加条件编译：
      - `non-wasm32`：保留 `reqwest::blocking` HTTP 拉取逻辑与超时配置；
      - `wasm32`：返回 `Ok(None)`，跳过 blocking HTTP 拉取分支，仅保持可编译性与既有 fallback 行为。
    - 同步为仅在 `non-wasm32` 下声明 `BUILTIN_WASM_FETCH_URLS_ENV` / `BUILTIN_WASM_FETCH_TIMEOUT_MS_ENV` 与 `fetch_timeout` 相关项，消除 wasm 构建告警。
  - 文档更新：
    - 更新 `doc/world-runtime/builtin-wasm-fetch-fallback-compile.project.md`，新增 BFC-5 任务并标记完成。
- 完成内容：执行并通过回归验证。
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`（编译完成后手动中断）
- 遗留事项：
  - `wasm32` 下当前不执行 builtin wasm 的 blocking HTTP 拉取；若后续需要 Web 端在线拉取 artifact，可补充基于异步客户端的 wasm 兼容实现与闭环测试。


- 日期：2026-02-15
- 完成内容：将 Web Viewer 的 wasm32 编译门禁加入 pre-commit，防止 `run-viewer-web.sh` 类问题在提交后才暴露。
  - 脚本改动：
    - 更新 `scripts/pre-commit.sh`，在既有 `required` 流程后新增：
      - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - 文档回写：
    - 更新 `doc/scripts/pre-commit.md`：将 viewer wasm32 编译检查纳入 pre-commit 范围与执行步骤。
    - 更新 `doc/scripts/pre-commit.project.md`：新增任务项“pre-commit 增加 viewer wasm32 编译检查”并标记完成。
- 完成内容：执行并通过回归验证。
  - `./scripts/pre-commit.sh`
  - 关键结果：
    - `cargo fmt --all -- --check` 通过；
    - `cargo test -p agent_world --tests --features test_tier_required` 通过（354 passed）；
    - 新增的 `cargo check -p agent_world_viewer --target wasm32-unknown-unknown` 通过。
- 遗留事项：
  - 当前为“每次 pre-commit 均执行 viewer wasm32 check”，后续如需优化耗时，可按变更路径做条件触发（例如仅在 `agent_world` runtime/viewer 相关文件改动时执行）。


- 日期：2026-02-15
- 完成内容：完成 FRB1（Frag 资源平衡与新手友好生成）文档立项。
  - 新增设计文档：`doc/world-simulator/frag-resource-balance-onboarding.md`。
  - 新增项目管理文档：`doc/world-simulator/frag-resource-balance-onboarding.project.md`。
  - 设计明确了三项核心参数：`min_fragments_per_chunk`、`starter_core_radius_ratio`、`starter_core_density_multiplier`。
- 完成内容：执行并通过 `test_tier_required` 快速回归。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_default_mix_is_conservative_for_high_radiation_materials --features test_tier_required -- --nocapture`
- 遗留事项：
  - 进入 FRB2，实现生成器参数扩展与保底/分布逻辑。


- 日期：2026-02-15
- 完成内容：完成 FRB2（frag 资源平衡与新手友好生成）实现。
  - 配置扩展：`crates/agent_world/src/simulator/world_model.rs`
    - `AsteroidFragmentConfig` 新增：
      - `min_fragments_per_chunk`
      - `starter_core_radius_ratio`
      - `starter_core_density_multiplier`
    - `Default` 与 `sanitized` 已接入默认值与边界约束（含 `min <= max_fragments_per_chunk` 约束）。
  - 生成器改造：`crates/agent_world/src/simulator/asteroid_fragment.rs`
    - 体素采样阶段新增中心区密度倍率（基于 chunk 中心平面距离）。
    - 新增确定性保底补种流程，低密度场景下尽量达到 `min_fragments_per_chunk`。
    - 抽出 `try_place_fragment`/`sample_in_range`，统一候选投放逻辑。
  - 测试补充：`crates/agent_world/src/simulator/tests/asteroid_fragment.rs`
    - 新增保底数量测试。
    - 新增中心区分布偏置测试。
    - 新增配置 sanitize 边界测试。
- 完成内容：执行并通过定向回归（`test_tier_required`）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::asteroid_fragment:: --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::init:: --features test_tier_required -- --nocapture`
- 遗留事项：
  - 进入 FRB3：回写总项目文档与项目状态，完成收口提交。


- 日期：2026-02-15
- 完成内容：完成 FRB3 收口。
  - 回写总项目文档：`doc/world-simulator.project.md` 新增“16. Frag 资源平衡与新手友好生成（FRB）”并勾选完成项。
  - 回写 FRB 项目管理文档：`doc/world-simulator/frag-resource-balance-onboarding.project.md` 勾选 FRB3.1~FRB3.3，状态更新为“FRB（已完成）”。
- 完成内容：执行并通过收口回归。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::asteroid_fragment::asteroid_fragment_generator_biases_distribution_toward_core_zone --features test_tier_required -- --nocapture`
- 遗留事项：
  - 若后续接入在线经济调参，可在现有参数上继续迭代“按观测指标微调”的闭环（当前版本不含在线调参）。


- 日期：2026-02-15
- 完成内容：启动 FRB4（补种周期策略 + 资源类型分布策略）文档更新。
  - 更新设计文档：`doc/world-simulator/frag-resource-balance-onboarding.md`
    - 新增“每 100 tick 按上限 1% 运行期补种”机制。
    - 新增“不同资源类型分布策略（uniform / core_metal_rim_volatile）”接口说明。
    - 明确补种事件化与 replay 一致性约束。
  - 更新项目管理文档：`doc/world-simulator/frag-resource-balance-onboarding.project.md`
    - 新增 FRB4.1~FRB4.6 任务并标记 FRB4.1 完成。
- 完成内容：执行并通过 `test_tier_required` 快速回归。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world asteroid_fragment_default_mix_is_conservative_for_high_radiation_materials --features test_tier_required -- --nocapture`
- 遗留事项：
  - 进入 FRB4.2~FRB4.5 代码实现（配置扩展、运行期补种事件、分布策略与测试）。


- 日期：2026-02-15
- 完成内容：完成 FRB4.2~FRB4.5 代码实现与测试。
  - 配置扩展：`crates/agent_world/src/simulator/world_model.rs`
    - `AsteroidFragmentConfig` 新增：
      - `replenish_interval_ticks`（默认 `100`）
      - `replenish_percent_ppm`（默认 `10_000`，即 1%）
      - `material_distribution_strategy`（`uniform` / `core_metal_rim_volatile`）
    - `sanitized` 接入边界约束。
  - 运行期补种：
    - 新增 `crates/agent_world/src/simulator/kernel/fragment_replenish.rs`。
    - `WorldKernel::step` 接入周期补种钩子：当时间命中周期且 chunk frag 数低于上限时，按“上限的 1%（可配置）”补种。
    - 新增事件 `WorldEventKind::FragmentsReplenished`，并在 replay 侧接入回放应用，确保一致性。
  - 资源类型分布策略：
    - 修改 `crates/agent_world/src/simulator/asteroid_fragment.rs`：材质采样支持按分区策略动态权重。
    - `core_metal_rim_volatile`：中心偏 metal/composite，外缘偏 ice/carbon。
  - 测试更新：
    - `crates/agent_world/src/simulator/tests/asteroid_fragment.rs`
      - 新增分区材质偏置测试。
      - 扩展 sanitize 边界测试（补种周期与补种比例）。
    - `crates/agent_world/src/simulator/tests/kernel.rs`
      - 新增“每 100 tick 补 1%”运行期补种测试。
    - `crates/agent_world/src/simulator/tests/persist.rs`
      - 新增 `FragmentsReplenished` replay 一致性测试。
  - 项目文档进度：
    - `doc/world-simulator/frag-resource-balance-onboarding.project.md` 勾选 FRB4.2~FRB4.5。
- 完成内容：执行并通过定向回归（`test_tier_required`）。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::asteroid_fragment:: --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world step_replenishes_fragments_every_hundred_ticks_at_one_percent --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world replay_from_snapshot_applies_fragment_replenished_event --features test_tier_required -- --nocapture`
- 遗留事项：
  - FRB4.6：回写总项目文档并完成最终收口提交。


- 日期：2026-02-15
- 完成内容：完成 FRB4.6 收口。
  - 更新总项目文档：`doc/world-simulator.project.md`
    - FRB 分册新增“运行期补种（每 100 tick 补 1%）”“资源类型分布策略”“replay 接入”完成项。
    - 最近更新状态改为 FRB4 收口。
  - 更新 FRB 项目管理文档：`doc/world-simulator/frag-resource-balance-onboarding.project.md`
    - 勾选 FRB4.6，状态收口为“FRB（已完成）”。
- 完成内容：执行并通过收口回归。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world step_replenishes_fragments_every_hundred_ticks_at_one_percent --features test_tier_required -- --nocapture`
- 遗留事项：
  - 若后续要做在线调参，可在当前周期补种参数上叠加“库存/消耗比”动态调节策略（本轮未实现）。


- 日期：2026-02-15
- 完成内容：完成“Site 使用手册静态化（CN/EN）”前置文档任务。
  - 新增设计文档：`doc/site-manual-static-docs.md`。
  - 新增项目管理文档：`doc/site-manual-static-docs.project.md`。
  - 任务拆解明确两项执行任务：任务一（框架）、任务二（手册整理）。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 进入任务一，落地 `site/doc/cn|en` 静态文档框架与首页入口接入。


- 日期：2026-02-15
- 完成内容：完成任务一“静态文档框架”。
  - 新增文档目录页：
    - `site/doc/cn/index.html`
    - `site/doc/en/index.html`
  - 新增手册框架页（占位，待任务二填充正文）：
    - `site/doc/cn/viewer-manual.html`
    - `site/doc/en/viewer-manual.html`
  - 首页接入文档入口：
    - `site/index.html`
    - `site/en/index.html`
  - 样式扩展：`site/assets/styles.css`（`docs-*` 相关样式）
  - 交互修正：`site/assets/app.js` 增加 `/doc/cn|en` 路径重定向保护，避免首访语言跳转误改文档路径。
  - 项目管理文档回写：`doc/site-manual-static-docs.project.md`（任务一勾选完成）。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 进入任务二，按 `doc/viewer-manual.md` 整理中英文手册正文，并完成目录页状态回写。


- 日期：2026-02-15
- 完成内容：完成任务二“整理用户手册”。
  - 完成中文手册正文页：`site/doc/cn/viewer-manual.html`。
  - 完成英文手册正文页：`site/doc/en/viewer-manual.html`。
  - 目录页状态更新为已发布：
    - `site/doc/cn/index.html`
    - `site/doc/en/index.html`
  - 项目管理文档回写：`doc/site-manual-static-docs.project.md`（任务二勾选完成，状态改为已完成）。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 后续如 `doc/viewer-manual.md` 增加新交互或新命令，需要同任务同步到 `site/doc/cn|en`。


- 日期：2026-02-15
- 完成内容：完成“Viewer 使用手册内容搬迁”前置文档任务。
  - 新增设计文档：`doc/viewer-manual-content-migration-2026-02-15.md`。
  - 新增项目管理文档：`doc/viewer-manual-content-migration-2026-02-15.project.md`。
  - 明确搬迁来源与任务拆解（中文基线 -> 站点 CN/EN 同步）。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 开始任务 1，更新 `doc/viewer-manual.md` 的搬迁章节。


- 日期：2026-02-15
- 完成内容：完成任务 1（中文基线手册搬迁）。
  - 更新 `doc/viewer-manual.md`，新增并整合以下章节：
    - 自动步骤（Auto Select / Automation Steps）
    - 右侧面板模块显隐与本地缓存
    - 选中详情面板
    - 快速定位 Agent
    - 全览图缩放切换（2D）
    - 文本可选中/复制面板
    - UI 语言切换
    - native fallback 常用增强参数
  - 保持闭环策略口径：Web 默认，native fallback。
  - 回写项目文档：`doc/viewer-manual-content-migration-2026-02-15.project.md`（任务 1 勾选）。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 执行任务 2，同步站点手册 `site/doc/cn|en/viewer-manual.html`。


- 日期：2026-02-15
- 完成内容：完成任务 2（站点手册 CN/EN 同步）。
  - 更新 `site/doc/cn/viewer-manual.html`，与基线 `doc/viewer-manual.md` 对齐。
  - 更新 `site/doc/en/viewer-manual.html`，补齐与中文页一致的章节结构与内容：
    - 自动步骤（Auto Select / Automation Steps）
    - 右侧面板能力（模块显隐、详情面板、快速定位）
    - 全览图缩放切换（2D）
    - 文本可复制面板
    - UI 语言切换
    - native fallback 常用增强参数
  - 回写项目文档：`doc/viewer-manual-content-migration-2026-02-15.project.md`（任务 2/3 勾选并收口）。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 无。


- 日期：2026-02-15
- 完成内容：完成 LBA0 文档建模任务。
  - 新增设计文档：`doc/world-simulator/llm-build-chain-actions.md`。
  - 新增项目管理文档：`doc/world-simulator/llm-build-chain-actions.project.md`。
  - 更新总项目文档入口：`doc/world-simulator.project.md`（挂载 LLM 建造链路动作扩展任务）。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 进入 LBA1，扩展 `transfer_resource` / `refine_compound` 的 LLM 决策解析与测试。


- 日期：2026-02-15
- 完成内容：完成 LBA1（LLM 建造链路动作解析与接线）。
  - `crates/agent_world/src/simulator/llm_agent/decision_flow.rs`：新增 `transfer_resource` 与 `refine_compound` 决策解析，补充 owner/resource kind 解析与错误兜底。
  - `crates/agent_world/src/simulator/llm_agent/decision_flow.rs`：扩展 `serialize_decision_for_prompt`，支持新增动作回写。
  - `crates/agent_world/src/simulator/llm_agent/tests.rs`：新增合法/非法路径测试（transfer/refine + invalid kind）。
  - `doc/world-simulator/llm-build-chain-actions.project.md`：LBA1 状态回写。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent -- --nocapture`
- 遗留事项：
  - 进入 LBA2，更新 Prompt schema/模板文案并补齐对应断言。


- 日期：2026-02-15
- 完成内容：完成 LBA2（Prompt 约束与回归）。
  - `crates/agent_world/src/simulator/llm_agent/prompt_assembly.rs`：在 Decision JSON Schema 中新增 `transfer_resource`/`refine_compound` 动作定义、推荐模板与字段约束文案。
  - `crates/agent_world/src/simulator/llm_agent/tests_part2.rs`：补充 Prompt 内容断言，验证新动作提示词已进入用户提示。
  - `doc/world-simulator/llm-build-chain-actions.project.md`：LBA2 状态回写。
- 完成内容：执行并通过任务测试。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent -- --nocapture`
- 遗留事项：
  - 进入 LBA3，执行 `llm_bootstrap` Web 端闭环验证并产出截图/控制台结果。


- 日期：2026-02-15
- 完成内容：完成 LBA3（Web 闭环验证）。
  - 启动 live server：
    - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5123 --web-bind 127.0.0.1:5111 --tick-ms 300`
  - 启动 web viewer：
    - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4273`
  - 使用 Playwright wrapper 执行闭环：
    - `open http://127.0.0.1:4273/?ws=ws://127.0.0.1:5111`
    - `snapshot`
    - `console`
    - `screenshot --filename output/playwright/viewer/viewer-web-lba3.png`
- 完成内容：卡点与优化。
  - 卡点：首轮使用 `--llm` 启动 live server 时，因环境缺失 LLM 运行条件导致 WebSocket 建链失败，console 出现连接拒绝错误。
  - 优化：切换到 script 决策模式完成 Web 闭环链路验收，保证 `ws` 通道可连并达成验收口径。
- 完成内容：验收结果。
  - 页面加载成功（Title: `Agent World Viewer (Web)`）。
  - `console error=0`（warnings=1）。
  - 截图产物：`output/playwright/viewer/viewer-web-lba3.png`。
  - 控制台日志：`.playwright-cli/console-2026-02-15T15-38-51-793Z.log`。
  - 项目状态回写：`doc/world-simulator/llm-build-chain-actions.project.md`、`doc/world-simulator.project.md`。
- 遗留事项：
  - 在具备 `OPENAI_API_KEY` 的环境复跑 `--llm` 在线闭环，验证新增建造动作在真实 LLM 决策链路中的行为稳定性。
