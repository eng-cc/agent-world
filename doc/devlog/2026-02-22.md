# 2026-02-22

- 时刻：2026-02-22 08:56:27 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T0 建档。
  - 新建设计文档：`doc/nonviewer-onchain-auth-protocol-hardening.md`。
  - 新建项目管理文档：`doc/nonviewer-onchain-auth-protocol-hardening.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_proto --lib`
- 遗留事项：
  - 执行 T1：完成协议结构扩展与鉴权内核实现（签名 payload + ed25519 验签）。

- 时刻：2026-02-22 18:45:05 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T1（协议与鉴权内核）。
  - `agent_world_proto::viewer` 新增 `PlayerAuthProof` / `PlayerAuthScheme`，并扩展 `PromptControlApplyRequest` / `PromptControlRollbackRequest` / `AgentChatRequest` 的 `auth` 字段。
  - 新增 `crates/agent_world/src/viewer/auth.rs`：实现 canonical payload（含 patch 三态）+ ed25519 签名/验签工具，覆盖 prompt_control(apply/preview/rollback) 与 agent_chat。
  - 同步更新 `agent_world::viewer` 导出接口与受影响请求构造点（补齐 `auth: None` 兼容编译）。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world viewer::auth::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T2：live 链路接入强制验签与 nonce 防重放，并补持久化与回归测试。

- 时刻：2026-02-22 19:03:05 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T2（Live 服务端强制鉴权 + 防重放）。
  - `viewer/live` 请求链路接入强制 `auth proof` 校验，覆盖 `prompt_control preview/apply/rollback` 与 `agent_chat`，并补齐 `auth_proof_required`、`auth_signature_invalid`、`auth_nonce_replay` 等错误码路径。
  - `WorldModel` 新增 `player_auth_last_nonce`，`WorldKernel` 新增 nonce 消费/查询接口，服务端在验签通过后消费 nonce，拒绝重放。
  - 补充 live 测试：缺失 proof、签名篡改、nonce 重放拒绝；补充 persist 测试：snapshot roundtrip 保留 nonce 状态。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::persist:: -- --nocapture`
- 遗留事项：
  - 执行 T3：viewer 非视觉发送链路接入签名 proof（含 nonce 生成）并完成 required tier 回归与收口。

- 时刻：2026-02-22 19:11:27 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T3（客户端接入与收口）。
  - `agent_world_viewer` 非视觉发送链路（chat + prompt profile apply）接入签名 proof：从环境变量加载鉴权密钥，自动分配单调 nonce，附加 `PlayerAuthProof` 后再发送请求。
  - 新增 viewer 侧鉴权构建单测：覆盖 signer 解析、缺失密钥报错、chat/prompt_control 请求 proof 附加与可验签性。
  - 同步更新设计/项目文档状态：T0~T3 全部完成，项目收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer egui_right_panel::egui_right_panel_chat::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（本设计任务闭环完成）。

- 时刻：2026-02-22 19:18:03 CST
- 完成内容：补充 viewer 鉴权 nonce 启动同步修复（T3 后续稳定性加固）。
  - `agent_world_viewer` 在发送签名请求前，会从 snapshot 中读取当前玩家 `player_auth_last_nonce` 并将本地 nonce 游标提升到 `last_nonce + 1`，避免 viewer 进程重启后 nonce 回退触发服务端重放拒绝。
  - 补充单测 `sync_viewer_auth_nonce_from_state_tracks_persisted_nonce` 覆盖该同步逻辑。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer egui_right_panel::egui_right_panel_chat::tests:: -- --nocapture`
- 遗留事项：
  - 无。

- 时刻：2026-02-22 20:12:21 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T0 建档。
  - 新建设计文档：`doc/game/gameplay-beta-balance-hardening-2026-02-22.md`。
  - 新建项目管理文档：`doc/game/gameplay-beta-balance-hardening-2026-02-22.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3/T4 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：为治理投票增加权重上限并补测试。

- 时刻：2026-02-22 20:25:20 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T1（治理投票权重上限）。
  - 新增治理投票权重上限常量，并在 `CastGovernanceVote` 动作校验中拒绝超限票重。
  - 补充拒绝路径测试 `governance_vote_rejects_weight_above_cap`，验证超限投票被拒绝且投票状态不被写入。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::governance_vote_rejects_weight_above_cap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::governance_vote_recast_replaces_previous_tally -- --nocapture`
- 遗留事项：
  - 执行 T2：为 `UpdateGameplayPolicy` 增加治理授权门槛并补授权测试。

- 时刻：2026-02-22 20:35:06 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T2（策略更新治理授权）。
  - 新增 `UpdateGameplayPolicy` 的治理授权门槛：操作方必须有已通过提案历史，且该提案 `total_weight_at_finalize` 达到最小阈值。
  - 新增测试 `update_gameplay_policy_requires_governance_authorization` 覆盖未授权拒绝路径。
  - 为经济合约策略相关测试增加治理授权预热，并将事件断言改为按事件类型检索，避免受同 tick 其他生命周期事件影响。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::update_gameplay_policy_requires_governance_authorization -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_settlement_applies_tax_and_reputation -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_respects_policy_quota_and_block_list -- --nocapture`
- 遗留事项：
  - 执行 T3：完成合约成功结算声誉去通胀公式落地并更新断言测试。

- 时刻：2026-02-22 20:40:58 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T3（合约成功结算声誉去通胀）。
  - 成功结算声誉奖励由“直接等于 `reputation_stake`”改为“金额换算 + 质押约束 + 全局上限”模型，避免大额质押直接通胀。
  - 更新既有测试断言（成功结算声誉从 8 下调到 3），并新增 `economic_contract_success_reputation_reward_respects_stake_and_cap` 覆盖质押约束与上限约束两条路径。
  - 项目文档状态更新：T3 完成，T4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_settlement_applies_tax_and_reputation -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_success_reputation_reward_respects_stake_and_cap -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_expires_and_penalizes_reputation -- --nocapture`
- 遗留事项：
  - 执行 T4：跑 T1~T3 汇总回归并完成文档收口。

- 时刻：2026-02-22 20:45:28 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T4（收口）。
  - 执行 `gameplay_protocol` 定向全量回归，覆盖治理/战争/危机/合约全链路。
  - 回写设计文档中的落地参数（票权上限、治理授权阈值、声誉奖励公式与 cap）。
  - 回写项目管理文档状态：T0~T4 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 无（本设计任务闭环完成）。
