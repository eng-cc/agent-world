# 2026-02-22

- 时刻：2026-02-22 08:56:27 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T0 建档。
  - 新建设计文档：`doc/nonviewer-onchain-auth-protocol-hardening.md`。
  - 新建项目管理文档：`doc/nonviewer-onchain-auth-protocol-hardening.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_proto --lib`
- 遗留事项：
  - 执行 T1：完成协议结构扩展与鉴权内核实现（签名 payload + ed25519 验签）。

- 时刻：2026-02-22 18:45:05 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T1（协议与鉴权内核）。
  - `agent_world_proto::viewer` 新增 `PlayerAuthProof` / `PlayerAuthScheme`，并扩展 `PromptControlApplyRequest` / `PromptControlRollbackRequest` / `AgentChatRequest` 的 `auth` 字段。
  - 新增 `crates/agent_world/src/viewer/auth.rs`：实现 canonical payload（含 patch 三态）+ ed25519 签名/验签工具，覆盖 prompt_control(apply/preview/rollback) 与 agent_chat。
  - 同步更新 `agent_world::viewer` 导出接口与受影响请求构造点（补齐 `auth: None` 兼容编译）。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world viewer::auth::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 T2：live 链路接入强制验签与 nonce 防重放，并补持久化与回归测试。

- 时刻：2026-02-22 19:03:05 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T2（Live 服务端强制鉴权 + 防重放）。
  - `viewer/live` 请求链路接入强制 `auth proof` 校验，覆盖 `prompt_control preview/apply/rollback` 与 `agent_chat`，并补齐 `auth_proof_required`、`auth_signature_invalid`、`auth_nonce_replay` 等错误码路径。
  - `WorldModel` 新增 `player_auth_last_nonce`，`WorldKernel` 新增 nonce 消费/查询接口，服务端在验签通过后消费 nonce，拒绝重放。
  - 补充 live 测试：缺失 proof、签名篡改、nonce 重放拒绝；补充 persist 测试：snapshot roundtrip 保留 nonce 状态。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::persist:: -- --nocapture`
- 遗留事项：
  - 执行 T3：viewer 非视觉发送链路接入签名 proof（含 nonce 生成）并完成 required tier 回归与收口。

- 时刻：2026-02-22 19:11:27 CST
- 完成内容：完成“Non-Viewer 链上鉴权协议重构（生产级）”T3（客户端接入与收口）。
  - `agent_world_viewer` 非视觉发送链路（chat + prompt profile apply）接入签名 proof：从环境变量加载鉴权密钥，自动分配单调 nonce，附加 `PlayerAuthProof` 后再发送请求。
  - 新增 viewer 侧鉴权构建单测：覆盖 signer 解析、缺失密钥报错、chat/prompt_control 请求 proof 附加与可验签性。
  - 同步更新设计/项目文档状态：T0~T3 全部完成，项目收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer egui_right_panel::egui_right_panel_chat::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（本设计任务闭环完成）。

- 时刻：2026-02-22 22:06:18 CST
- 完成内容：完成“Runtime 无限时长运行：序列号滚动与数值防溢出”T3（回归与收口）。
  - 完成本次改动范围的定向回归：序列滚动（event/action）、快照兼容、资源聚合饱和、模块输出上限窄化、wasm executor 计数上限路径全部通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，项目收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world action_id_rolls_over_into_next_era -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world event_id_rolls_over_into_next_era -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world snapshot_json_without_era_fields_keeps_backward_compatibility -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world resource_delta_add_assign_saturates_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world resource_delta_deficits_saturates_abs_of_i64_min -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world adjust_resource_balance_saturates_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world resource_stock_add_saturates_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world module_output_limits_reject_excess -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor count_exceeds_limit_treats_usize_overflow_as_exceeded -- --nocapture`
- 遗留事项：
  - 无（本设计任务闭环完成）。

- 时刻：2026-02-22 21:25:32 CST
- 完成内容：完成“Runtime 无限时长运行：序列号滚动与数值防溢出”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-infinite-sequence-rollover.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-infinite-sequence-rollover.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：实现 runtime 四类 ID 的 era+seq 滚动分配并打通 snapshot 持久化兼容。

- 时刻：2026-02-22 21:46:16 CST
- 完成内容：完成“Runtime 无限时长运行：序列号滚动与数值防溢出”T1（序列滚动与持久化）。
  - `World` 内四类计数器（event/action/intent/proposal）新增 era 状态与统一滚动分配逻辑；当 seq 到达 `u64::MAX` 后下一个分配自动进入下一 era 并回到 `1`。
  - `Snapshot` 新增四类 era 字段，并在 `from_snapshot` 中兼容旧快照（缺省 era=0）。
  - 新增测试覆盖 action/event ID 滚动行为与 legacy snapshot（缺少 era 字段）反序列化兼容。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world action_id_rolls_over_into_next_era -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world event_id_rolls_over_into_next_era -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world snapshot_json_without_era_fields_keeps_backward_compatibility -- --nocapture`
- 遗留事项：
  - 执行 T2：完成关键数值加法与窄化转换的防溢出加固并补边界测试。

- 时刻：2026-02-22 21:58:46 CST
- 完成内容：完成“Runtime 无限时长运行：序列号滚动与数值防溢出”T2（数值防溢出加固）。
  - 关键数值加法改为饱和策略：`ResourceDelta::add_assign`、`ResourceDelta::deficits`、`World::adjust_resource_balance`、`ResourceStock::add`。
  - 模块输出计数上限校验改为 `u32::try_from` 语义（`usize` 无法窄化时直接按超限处理），覆盖 runtime 与 wasm executor 双路径。
  - `execution_storage` 中 `snapshot.state.time -> i64` 改为显式 `try_from` 校验并返回 `DistributedValidationFailed`。
  - 补充边界测试：资源聚合溢出饱和、`i64::MIN` 赤字绝对值饱和、`ResourceStock` 溢出饱和、`usize::MAX` 计数超限判定。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world resource_delta_add_assign_saturates_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world resource_delta_deficits_saturates_abs_of_i64_min -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world adjust_resource_balance_saturates_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world resource_stock_add_saturates_on_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world module_output_limits_reject_excess -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor count_exceeds_limit_treats_usize_overflow_as_exceeded -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net store_execution_result_rejects_snapshot_time_overflow -- --nocapture`
- 遗留事项：
  - 执行 T3：跑收口回归并完成文档状态与最终交付。

- 时刻：2026-02-22 19:18:03 CST
- 完成内容：补充 viewer 鉴权 nonce 启动同步修复（T3 后续稳定性加固）。
  - `agent_world_viewer` 在发送签名请求前，会从 snapshot 中读取当前玩家 `player_auth_last_nonce` 并将本地 nonce 游标提升到 `last_nonce + 1`，避免 viewer 进程重启后 nonce 回退触发服务端重放拒绝。
  - 补充单测 `sync_viewer_auth_nonce_from_state_tracks_persisted_nonce` 覆盖该同步逻辑。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer egui_right_panel::egui_right_panel_chat::tests:: -- --nocapture`
- 遗留事项：
  - 无。

- 时刻：2026-02-22 20:12:21 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T0 建档。
  - 新建设计文档：`doc/game/gameplay-beta-balance-hardening-2026-02-22.md`。
  - 新建项目管理文档：`doc/game/gameplay-beta-balance-hardening-2026-02-22.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3/T4 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：为治理投票增加权重上限并补测试。

- 时刻：2026-02-22 20:25:20 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T1（治理投票权重上限）。
  - 新增治理投票权重上限常量，并在 `CastGovernanceVote` 动作校验中拒绝超限票重。
  - 补充拒绝路径测试 `governance_vote_rejects_weight_above_cap`，验证超限投票被拒绝且投票状态不被写入。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::governance_vote_rejects_weight_above_cap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::governance_vote_recast_replaces_previous_tally -- --nocapture`
- 遗留事项：
  - 执行 T2：为 `UpdateGameplayPolicy` 增加治理授权门槛并补授权测试。

- 时刻：2026-02-22 20:35:06 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T2（策略更新治理授权）。
  - 新增 `UpdateGameplayPolicy` 的治理授权门槛：操作方必须有已通过提案历史，且该提案 `total_weight_at_finalize` 达到最小阈值。
  - 新增测试 `update_gameplay_policy_requires_governance_authorization` 覆盖未授权拒绝路径。
  - 为经济合约策略相关测试增加治理授权预热，并将事件断言改为按事件类型检索，避免受同 tick 其他生命周期事件影响。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::update_gameplay_policy_requires_governance_authorization -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_settlement_applies_tax_and_reputation -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_respects_policy_quota_and_block_list -- --nocapture`
- 遗留事项：
  - 执行 T3：完成合约成功结算声誉去通胀公式落地并更新断言测试。

- 时刻：2026-02-22 20:40:58 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T3（合约成功结算声誉去通胀）。
  - 成功结算声誉奖励由“直接等于 `reputation_stake`”改为“金额换算 + 质押约束 + 全局上限”模型，避免大额质押直接通胀。
  - 更新既有测试断言（成功结算声誉从 8 下调到 3），并新增 `economic_contract_success_reputation_reward_respects_stake_and_cap` 覆盖质押约束与上限约束两条路径。
  - 项目文档状态更新：T3 完成，T4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_settlement_applies_tax_and_reputation -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_success_reputation_reward_respects_stake_and_cap -- --nocapture && env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol::economic_contract_expires_and_penalizes_reputation -- --nocapture`
- 遗留事项：
  - 执行 T4：跑 T1~T3 汇总回归并完成文档收口。

- 时刻：2026-02-22 20:45:28 CST
- 完成内容：完成“Gameplay 内测数值加固（治理票权 + 策略授权 + 合约声誉去通胀）”T4（收口）。
  - 执行 `gameplay_protocol` 定向全量回归，覆盖治理/战争/危机/合约全链路。
  - 回写设计文档中的落地参数（票权上限、治理授权阈值、声誉奖励公式与 cap）。
  - 回写项目管理文档状态：T0~T4 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 无（本设计任务闭环完成）。
- 时刻：2026-02-22 20:28:16 CST
- 完成内容：完成“README P2 缺口收口：Node Replication 统一到 agent_world_net 网络栈”NUS-0（文档立项 + wasm32 定位补充）。
  - 新建设计文档：`doc/p2p/readme-p2-node-net-stack-unification.md`。
  - 新建项目管理文档：`doc/p2p/readme-p2-node-net-stack-unification.project.md`。
  - 在 `doc/p2p/node-wasm32-libp2p-compile-guard.md` 与 `crates/agent_world_node/src/libp2p_replication_network_wasm.rs` 明确：wasm32 节点网络不做 full node，仅保留占位与 unavailable 语义。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_node --lib`
- 遗留事项：
  - 执行 NUS-1：实现 node replication 复用 `agent_world_net::Libp2pNetwork` 并保留轮换重试/可控回退语义。

- 时刻：2026-02-22 20:44:36 CST
- 完成内容：完成“README P2 缺口收口：Node Replication 统一到 agent_world_net 网络栈”NUS-1/NUS-2/NUS-3（根因拆环 + 实现 + 回归收口）。
  - 根因拆环：
    - `crates/agent_world_net/Cargo.toml` 移除 `agent_world_net -> agent_world` 包级依赖边，并将 `runtime_bridge` 调整为保留名占位 feature，防止再次触发 `agent_world -> agent_world_node -> agent_world_net -> agent_world` 循环依赖。
    - `crates/agent_world_net/src/lib.rs` 收口 runtime bridge 相关导出，保持 net crate 为基础网络层。
  - 统一实现：
    - `crates/agent_world_node/src/libp2p_replication_network.rs` 改为封装 `agent_world_net::Libp2pNetwork`，保留 node 语义：
      - 多 peer 轮换请求；
      - 远端失败自动重试；
      - 无 peer 可控本地 handler 回退；
      - 远端错误响应按 `ErrorResponse` 解码并映射 `NetworkRequestFailed`。
    - `crates/agent_world_node/Cargo.toml` 新增 native 目标下对 `agent_world_net` 依赖。
  - 文档收口：
    - 更新 `doc/p2p/readme-p2-node-net-stack-unification.md`、`doc/p2p/readme-p2-node-net-stack-unification.project.md` 状态为完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_node --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node libp2p_replication_network -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --features libp2p --lib`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net --features runtime_bridge`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net --features "runtime_bridge,libp2p"`
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world start_live_node_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_pos_state_persists_across_restart -- --nocapture`
- 遗留事项：
  - 无（本设计任务闭环完成）。

- 时刻：2026-02-22 21:30:37 CST
- 完成内容：完成“Viewer Web 可操作性与舒适度加固（问题1/2/3）”VWU0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-web-usability-hardening-2026-02-22.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-web-usability-hardening-2026-02-22.project.md`。
  - 初始化任务状态：VWU0 完成，VWU1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VWU1：实现窄屏布局加固并补测试。

- 时刻：2026-02-22 21:43:55 CST
- 完成内容：完成“Viewer Web 可操作性与舒适度加固”VWU1（窄屏布局加固）。
  - `egui_right_panel` 新增窄屏紧凑布局判定与右侧总宽预算，限制双侧面板在窄屏条件下挤占主画布。
  - 当宽度不足时，聊天面板不再右侧并排，而是自动内联到主面板中，保证聊天功能可达且主视区仍可操作。
  - 新增/更新面板布局单测，覆盖紧凑模式阈值、主面板最小宽度、主/聊天面板预算上限。
  - 同步更新项目文档状态：VWU1 完成，VWU2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer egui_right_panel::tests:: -- --nocapture`
- 遗留事项：
  - 执行 VWU2：修复 websocket `onerror` 类型不匹配导致的 Web 运行时异常。

- 时刻：2026-02-22 21:46:54 CST
- 完成内容：完成“Viewer Web 可操作性与舒适度加固”VWU2（websocket onerror 类型修复）。
  - `WasmWsRuntime` 的 `_on_error` 回调类型从 `FnMut(ErrorEvent)` 调整为 `FnMut(Event)`，与浏览器 `WebSocket.onerror` 事件签名对齐。
  - onerror 回调改为安全提取 `ErrorEvent` 明细（可用时取 `message`，否则回退 `network error`），避免再触发二次 TypeError。
  - 同步更新项目文档状态：VWU2 完成，VWU3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VWU3：实现连接异常自动重连（退避）与更友好的状态文案。

- 时刻：2026-02-22 21:53:53 CST
- 完成内容：完成“Viewer Web 可操作性与舒适度加固”VWU3（自动重连 + 友好错误文案）。
  - 新增连接错误标准化：将 `websocket closed / connection refused / disconnected` 等底层错误映射为用户可理解文案（保留离线与业务错误原文）。
  - 新增 `attempt_viewer_reconnect`：对可重连错误执行指数退避自动重连，并将状态回切到 `Connecting`。
  - 自动重连系统接入 UI 与 headless 主循环。
  - 新增单测覆盖：可重连错误签名识别、错误文案映射、可重连/不可重连场景行为。
  - 同步更新项目文档状态：VWU3 完成，VWU4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer reconnect -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer friendly_connection_error_maps_transport_messages -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VWU4：完成 required 相关回归并确认无行为回退。

- 时刻：2026-02-22 21:57:41 CST
- 完成内容：完成“Viewer Web 可操作性与舒适度加固”VWU4（required 回归）。
  - 按 `testing-manual.md` 的 required 入口执行 `./scripts/ci-tests.sh required`，覆盖 `agent_world(test_tier_required)`、`agent_world_consensus`、`agent_world_distfs`、`agent_world_viewer` 与 wasm 目标编译检查。
  - 回归通过，未发现行为回退；VWU4 标记完成，项目状态推进到 VWU5。
- 测试：
  - `env -u RUSTC_WRAPPER ./scripts/ci-tests.sh required`
- 遗留事项：
  - 执行 VWU5：回顾设计文档与项目文档并完成收口提交。

- 时刻：2026-02-22 22:00:42 CST
- 完成内容：完成“Viewer Web 可操作性与舒适度加固”VWU5（文档回顾与收口）。
  - 回顾并更新设计文档里程碑状态，明确 M1~M5 全部完成。
  - 更新项目管理文档状态：VWU0~VWU5 全部打勾并标记已收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（本设计任务闭环完成）。

- 时刻：2026-02-22 22:10:31 CST
- 完成内容：完成“Viewer Rust 文件行数上限重构与 Web 闭环对比”VFL0 建档。
  - 新建设计文档：`doc/world-simulator/viewer-rust-file-line-cap-refactor-and-web-qa-2026-02-22.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-rust-file-line-cap-refactor-and-web-qa-2026-02-22.project.md`。
  - 初始化任务状态：VFL0 完成，VFL1 进行中。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 VFL1：完成低风险拆分并做首轮回归。

- 时刻：2026-02-22 22:21:51 CST
- 完成内容：完成“Viewer Rust 文件行数上限重构与 Web 闭环对比”VFL1（低风险拆分）。
  - `camera_controls.rs` 外移内联测试到 `camera_controls_tests.rs`，主文件降至 606 行。
  - `viewer_3d_config.rs` 外移内联测试到 `viewer_3d_config_tests.rs`，主文件降至 1044 行。
  - `tests.rs` 外移场景辅助构建函数到 `tests_scene_helpers.rs`，主文件降至 1076 行。
  - `selection_linking.rs` 下沉事件匹配逻辑到 `selection_linking_event_matchers.rs`，主文件降至 1134 行。
  - `egui_right_panel.rs` 下沉环境开关解析逻辑到 `egui_right_panel_env.rs`，主文件降至 1197 行。
  - 处理拆分后可见性回归（`env_toggle_enabled`、`event_matches_owner`）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer camera_controls::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer selection_linking::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer tests::update_ui_sets_status_and_events -- --nocapture`
- 遗留事项：
  - 执行 VFL2：完成 `egui_right_panel_chat.rs` 与 `main.rs` 的高体量拆分。

- 时刻：2026-02-22 22:33:29 CST
- 完成内容：完成“Viewer Rust 文件行数上限重构与 Web 闭环对比”VFL2（高体量拆分）。
  - `egui_right_panel_chat.rs` 拆分为：
    - `egui_right_panel_chat.rs`（主文件 935 行）
    - `egui_right_panel_chat_auth.rs`（鉴权/nonce 子模块）
    - `egui_right_panel_chat_presets.rs`（预设编辑子模块）
    - `egui_right_panel_chat_tests.rs`（测试外移）
  - `main.rs` 拆分为：
    - `main.rs`（主文件 915 行）
    - `main_connection.rs`（连接、收包、重连逻辑）
    - `main_ui_runtime.rs`（场景/UI 构建与更新系统）
  - 修复拆分中 `main_ui_runtime.rs` 末尾截断导致的括号不闭合问题。
  - 当前 `agent_world_viewer/src` 下所有 Rust 文件均已降至 1200 行以内。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer egui_right_panel_chat::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer tests::friendly_connection_error_maps_transport_messages -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VFL3：完成 viewer 全量回归并确认拆分后无行为回退。

- 时刻：2026-02-22 22:36:13 CST
- 完成内容：完成“Viewer Rust 文件行数上限重构与 Web 闭环对比”VFL3（viewer 全量回归）。
  - 执行 `agent_world_viewer` 全量单测与 wasm 目标编译检查，验证 VFL1/VFL2 拆分后无行为回退。
  - 结果：`agent_world_viewer` 287/287 通过，wasm check 通过。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VFL4：按 S6 跑 Web Playwright 闭环并产出对比证据。

- 时刻：2026-02-22 22:44:24 CST
- 完成内容：完成“Viewer Rust 文件行数上限重构与 Web 闭环对比”VFL4（S6 Playwright 闭环）。
  - 启动 live server 与 web viewer 后，按 S6 执行 Playwright 流程：`open/snapshot/eval/runSteps/sendControl/getState/console/screenshot`。
  - `window.__AW_TEST__` 可用，`getState()` 返回有效状态；语义动作 `mode=3d;focus=first_location;zoom=0.85;select=first_agent` 执行成功。
  - console 结果：`Errors = 0`，仅保留平台能力与 autoplay 限制相关 warning。
  - 产物：
    - 截图：`output/playwright/viewer/viewer-web-linecap-refactor-2026-02-22.png`
    - 摘要：`output/playwright/viewer/viewer-web-linecap-refactor-2026-02-22-summary.md`
    - console：`.playwright-cli/console-2026-02-22T14-43-47-030Z.log`
- 测试：
  - `source \"$HOME/.nvm/nvm.sh\" && nvm use 24`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_viewer_live -- llm_bootstrap --bind 127.0.0.1:5023 --web-bind 127.0.0.1:5011 --tick-ms 300 --topology single --viewer-no-consensus-gate`
  - `env -u NO_COLOR ./scripts/run-viewer-web.sh --address 127.0.0.1 --port 4173`
  - `bash \"$PWCLI\" open \"http://127.0.0.1:4173/?ws=ws://127.0.0.1:5011&test_api=1\"`
  - `bash \"$PWCLI\" snapshot`
  - `bash \"$PWCLI\" eval '() => typeof window.__AW_TEST__ === \"object\"'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.runSteps(\"mode=3d;focus=first_location;zoom=0.85;select=first_agent;wait=0.3\")'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.sendControl(\"pause\")'`
  - `bash \"$PWCLI\" eval '() => window.__AW_TEST__.getState()'`
  - `bash \"$PWCLI\" eval '() => { const s = window.__AW_TEST__.getState(); return !!s && typeof s.tick === \"number\" && typeof s.connectionStatus === \"string\"; }'`
  - `bash \"$PWCLI\" console`
  - `bash \"$PWCLI\" screenshot --filename output/playwright/viewer/viewer-web-linecap-refactor-2026-02-22.png`
- 遗留事项：
  - 执行 VFL5：回写收口状态并给出可操作性对比结论。

- 时刻：2026-02-22 22:47:27 CST
- 完成内容：完成“Viewer Rust 文件行数上限重构与 Web 闭环对比”VFL5（文档回写与收口）。
  - 回写设计文档：补齐里程碑状态与“重构前 vs 重构后”可操作性对比结论。
  - 回写项目管理文档：VFL0~VFL5 全部完成，任务收口。
  - 形成结论：本次重构清零超限文件且 Web 闭环无可操作性回退（`__AW_TEST__` 语义链路可用、console 无 error）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（本设计任务闭环完成）。
- 时刻：2026-02-22 22:12:14 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第一阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase1.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase1.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3/T4 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：把资源与规则关键算术从静默饱和改为显式溢出错误语义。

- 时刻：2026-02-22 22:17:37 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第一阶段）”T1（数值语义显式溢出）。
  - `ResourceStock::add` 从饱和加法改为 `checked_add`，新增 `StockError::Overflow`。
  - `ResourceDelta::add_assign` 改为可失败聚合，`merge_rule_decisions` 新增 `CostOverflow` 路径。
  - `World::adjust_resource_balance` / `apply_resource_delta` 改为可失败接口，调用链同步编译通过。
  - 补齐 simulator kernel/replay/social 对 `StockError::Overflow` 的拒绝分支映射。
  - 更新测试：
    - `resource_delta_add_assign_returns_overflow_error`
    - `adjust_resource_balance_rejects_overflow`
    - `resource_stock_add_rejects_overflow`
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::rules::tests::resource_delta_add_assign_returns_overflow_error -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::basic::adjust_resource_balance_rejects_overflow -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::basics::resource_stock_add_rejects_overflow -- --nocapture`
- 遗留事项：
  - 执行 T2：把三条高风险事件路径改造为先校验后提交，消除半提交状态。

- 时刻：2026-02-22 22:35:09 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第一阶段）”T2（状态转移原子性）。
  - `DomainEvent::ResourceTransferred` 改为先预计算双方 `ResourceStock`，通过后再统一写回，避免先扣后加失败导致半提交。
  - `DomainEvent::PowerRedeemed` 改为先校验并预计算节点 credit、储备、nonce 与目标电力余额，再统一提交，失败时不再污染账本。
  - `DomainEvent::EconomicContractSettled` 改为先校验/预计算 creator/counterparty/treasury/reputation，再统一提交，移除结算路径中的静默饱和。
  - 新增原子性回归测试：
    - `emit_resource_transfer_overflow_keeps_balances_atomic`
    - `reward_asset_redeem_power_overflow_keeps_state_atomic`
    - `economic_contract_settlement_overflow_keeps_state_atomic`
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::basic:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::reward_asset:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 执行 T3：把 `step_with_modules` 的资源 delta 溢出收敛为 `ActionRejected`，并确保 world 资源 delta 应用路径原子化。

- 时刻：2026-02-22 22:40:06 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第一阶段）”T3（执行流接线）。
  - `World::apply_resource_delta` 改为“先预计算后统一写入”，确保多资源变更在任一项溢出时不会出现部分提交。
  - `step_with_modules` 在规则成本应用失败时不再中断主循环，改为追加 `ActionRejected`（`RuleDenied`）并输出可观测原因。
  - 新增回归测试 `rule_decision_cost_overflow_rejected_without_partial_apply`，覆盖“溢出拒绝 + 账本不被部分扣减 + ActionRejected 可观测”。
  - 项目文档状态更新：T3 完成，T4 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::rules:: -- --nocapture`
- 遗留事项：
  - 执行 T4：完成阶段收口（测试回归证据归档与文档最终状态更新）。

- 时刻：2026-02-22 22:42:27 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第一阶段）”T4（回归与收口）。
  - 收口回归通过：原子性测试（`basic/reward_asset/gameplay_protocol`）与规则成本溢出拒绝测试（`rules`）全部通过。
  - pre-commit required tier 门禁在 T2/T3 两次提交中完整执行并通过（`agent_world --tests --features test_tier_required` + `agent_world_viewer wasm32 check`）。
  - 回写设计文档与项目管理文档状态：M0~M4、T0~T4 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::basic:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::reward_asset:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::gameplay_protocol:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::rules:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（本阶段任务闭环完成）。

- 时刻：2026-02-22 22:48:10 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第二阶段）”T0 建档。
  - 新建设计文档：`doc/world-runtime/runtime-numeric-correctness-phase2.md`。
  - 新建项目管理文档：`doc/world-runtime/runtime-numeric-correctness-phase2.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - 文档任务（无代码测试）。
- 遗留事项：
  - 执行 T1：将 Node Points 账本结算路径的静默饱和改为显式溢出错误并补原子性测试。

- 时刻：2026-02-22 22:55:47 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第二阶段）”T1（Node Points 显式溢出语义）。
  - `NodePointsLedger::settle_epoch` 改为 `Result` 返回，关键累加由 `saturating_*` 改为 `checked_*`，覆盖 award/cumulative/total_distributed/epoch_index 溢出。
  - 结算流程改为“先计算校验、后提交写入”，保证溢出失败时账本状态不被部分污染。
  - `NodePointsRuntimeCollector` 的 `observe/observe_snapshot/force_settle` 改为透传 `NodePointsError`，上层调用点补齐错误处理。
  - 新增边界测试：累计积分溢出、epoch 溢出、main+storage 总分发溢出，验证拒绝路径与原子性。
  - 项目文档状态更新：T1 完成，T2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::node_points::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::node_points_runtime::tests:: -- --nocapture`
- 遗留事项：
  - 执行 T2：将 Node PoS 的票权累加与 slot 递进改为显式溢出错误并补充拒绝路径测试。

- 时刻：2026-02-22 23:01:04 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第二阶段）”T2（Node PoS 显式溢出语义）。
  - `node_pos::insert_attestation` 改为先 `checked_add` 预计算，再写入 attestation，溢出时返回 `NodePosError` 且不污染 proposal。
  - `node_pos::propose_next_head` 的 `next_slot` 递进改为 `checked_add`，在 `u64::MAX` 边界显式失败。
  - 新增 core 单测覆盖：stake overflow 拒绝路径、slot overflow 拒绝路径，验证失败不污染状态。
  - 项目文档状态更新：T2 完成，T3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus insert_attestation_rejects_overflow_without_mutating_proposal -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus propose_next_head_rejects_slot_overflow_without_pending_mutation -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus pos_commit_requires_supermajority_stake -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_node --lib`
- 遗留事项：
  - 执行 T3：跑阶段收口回归并完成文档状态关闭。

- 时刻：2026-02-22 23:03:30 CST
- 完成内容：完成“Runtime 共识数值语义与原子状态转移硬化（15 点清单第二阶段）”T3（回归与收口）。
  - Phase2 关键改造（Node Points + Node PoS）在提交门禁中完成 required-tier 全量回归并通过。
  - 回写设计文档状态：M0~M3 全部完成。
  - 回写项目管理文档状态：T0~T3 全部完成，阶段收口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_consensus --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 无（第二阶段任务闭环完成）。
