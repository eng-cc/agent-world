# 2026-02-21

- 时刻：2026-02-21 00:03:49 CST
- 完成内容：完成“Runtime 超长文件拆分收敛（行数阈值治理）”任务。
  - 将 `crates/agent_world/src/runtime/state.rs` 的 `apply_domain_event` 超长逻辑按领域拆分到子模块：
    - `crates/agent_world/src/runtime/state/apply_domain_event_core.rs`
    - `crates/agent_world/src/runtime/state/apply_domain_event_gameplay.rs`
    - `crates/agent_world/src/runtime/state/apply_domain_event_governance_meta.rs`
  - 将 `crates/agent_world/src/runtime/world/event_processing.rs` 的 `action_to_event` 超长逻辑按领域拆分到子模块：
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_core.rs`
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_gameplay.rs`
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_policy_contract.rs`
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_economy.rs`
  - 主文件改为分发入口，保持业务语义不变，并将主文件行数降到阈值内：
    - `state.rs`: 951 行
    - `event_processing.rs`: 589 行
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 仓库内仍存在其他历史超长 Rust 文件（非本任务改动路径），需后续分批治理。

- 时刻：2026-02-21 00:17:17 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 1 的 VCR1-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase1-asset-pipeline.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase1-asset-pipeline.project.md`。
  - 项目状态初始化：VCR1-0 完成，VCR1-1 进行中，VCR1-2/VCR1-3 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR1-1：实现外部 mesh 配置结构与环境变量解析。

- 时刻：2026-02-21 00:25:44 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 1 的 VCR1-1 ~ VCR1-3。
  - `viewer_3d_config` 新增外部 mesh 覆盖配置：支持 agent/location/asset/power_plant/power_storage 五类 mesh 的环境变量路径解析。
  - `setup_3d_scene` 接入“外部 mesh 优先 + 内置几何兜底”装载策略，不影响默认行为。
  - 更新配置解析测试与新增空值兜底测试；更新 `doc/viewer-manual.md` 资产层外部 mesh 配置说明。
  - 项目文档 `doc/world-simulator/viewer-commercial-release-phase1-asset-pipeline.project.md` 回写为 VCR1 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 进入 Phase 2：引入首批真实美术资源包并建立视觉验收基线（截图矩阵/CI 门禁）。

- 时刻：2026-02-21 09:00:23 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md`。
  - 项目状态初始化：VCR2-0 完成，VCR2-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR2-1：实现视觉基线脚本并做本地验证。

- 时刻：2026-02-21 09:03:31 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-1（视觉基线脚本）。
  - 新增 `scripts/viewer-visual-baseline.sh`，增加 snapshot 基线文件存在性/非空校验。
  - 脚本执行 `cargo test -p agent_world_viewer egui_kittest_snapshot_`，形成可重复的 Viewer 视觉基线 gate 入口。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md` 状态为 VCR2-1 完成、VCR2-2 进行中。
- 测试：
  - `./scripts/viewer-visual-baseline.sh`
- 遗留事项：
  - 执行 VCR2-2：将 viewer 单测/wasm gate 与视觉基线脚本接入 `ci-tests.sh` 和 `.github/workflows/rust.yml`。

- 时刻：2026-02-21 09:07:54 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-2（CI 接入）。
  - `scripts/ci-tests.sh` 新增 `agent_world_viewer` 单测与 wasm check，并在 `required/full` 两个 tier 默认执行。
  - `.github/workflows/rust.yml` 的 `required-gate` 新增 `./scripts/viewer-visual-baseline.sh` 步骤，形成视觉基线 required gate。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md` 状态为 VCR2-2 完成、VCR2-3 进行中。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 执行 VCR2-3：更新 `testing-manual.md` 的 CI 覆盖口径并完成 Phase 2 收口。

- 时刻：2026-02-21 09:10:42 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-3（文档与状态收口）。
  - 更新 `testing-manual.md`：
    - 回写 `ci-tests.sh` 已纳入 viewer 单测与 wasm check 的事实口径；
    - 回写 `rust.yml` required-gate 已执行 `viewer-visual-baseline.sh`；
    - 收口已过时 TODO（`agent_world_viewer` 测试阻塞项标记完成并注明验收）。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md`，将 VCR2-3 标记为完成并将 Phase 2 状态回写为全部完成。
- 测试：
  - `./scripts/viewer-visual-baseline.sh`
- 遗留事项：
  - 可进入下一阶段：真实资产质量提升与 Viewer Web 闭环更高自动化覆盖。

- 时刻：2026-02-21 09:14:06 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md`。
  - 项目状态初始化：VCR3-0 完成，VCR3-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR3-1：实现材质风格覆盖配置结构与环境变量解析。

- 时刻：2026-02-21 09:18:25 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-1（材质风格覆盖配置解析）。
  - `viewer_3d_config` 新增 `ViewerExternalMaterialConfig` / `ViewerExternalMaterialSlotConfig` 资源与解析入口。
  - 新增 10 个颜色环境变量解析（`#RRGGBB`），覆盖 agent/location/asset/power_plant/power_storage 的 base/emissive 颜色。
  - `app_bootstrap` 接入 `resolve_viewer_external_material_config()` 并插入全局资源。
  - 补充 profile tests：有效值解析、非法值兜底、空值忽略。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md` 为 VCR3-1 完成、VCR3-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config_profile_tests:: -- --nocapture`
- 遗留事项：
  - 执行 VCR3-2：将外部颜色覆盖接入 `setup_3d_scene` 材质构建并补行为测试。

- 时刻：2026-02-21 09:28:30 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-2（材质覆盖接入场景构建并补测试）。
  - `setup_3d_scene` 接入 `ViewerExternalMaterialConfig`，agent/asset/power_plant/power_storage 的 base/emissive 颜色支持“外部覆盖优先、默认兜底”。
  - 新增颜色构建辅助逻辑：`resolve_srgb_slot_color`、`emissive_from_srgb_with_boost` 等，统一材质颜色分辨与 emissive boost 处理。
  - 为 location 壳层新增独立材质句柄（core/halo），避免与 chunk/world 材质复用时产生联动副作用；未配置 location 覆盖时保持原句柄回退，保证默认行为兼容。
  - 更新 `scene_helpers_entities` 的 location core/halo 取材逻辑，改为使用新增 location 专用材质句柄。
  - 补充单测覆盖：颜色槽位覆盖优先级、emissive 上限饱和、location 覆盖开关判定。
  - 同步更新 `tests_scene_entities.rs`、`tests_scene_grid.rs` 的 `Viewer3dAssets` 测试构造。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md` 状态为 VCR3-2 完成、VCR3-3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR3-3：更新 `doc/viewer-manual.md` 材质颜色环境变量说明并完成阶段收口。

- 时刻：2026-02-21 09:31:53 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-3（手册/状态/devlog 收口）。
  - 更新 `doc/viewer-manual.md`：补充外部材质颜色覆盖环境变量说明（10 个 `#RRGGBB` 项）与最小启动示例。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md`：将 VCR3-3 标记完成，并将 Phase 3 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - Phase 3 已收口；后续可进入纹理装载/后处理资产包阶段，并依托 Web 闭环与 snapshot 基线做回归。

- 时刻：2026-02-21 09:35:24 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md`。
  - 项目状态初始化：VCR4-0 完成，VCR4-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR4-1：实现贴图风格覆盖配置结构与环境变量解析。

- 时刻：2026-02-21 09:38:46 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-1（贴图风格覆盖配置解析）。
  - `viewer_3d_config` 新增 `ViewerExternalTextureConfig` / `ViewerExternalTextureSlotConfig` 资源与解析入口。
  - 新增 5 个贴图环境变量解析（base texture 资产路径），覆盖 agent/location/asset/power_plant/power_storage。
  - `app_bootstrap` 接入 `resolve_viewer_external_texture_config()` 并插入全局资源。
  - 补充 profile tests：有效值解析、空值忽略与回退。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md` 为 VCR4-1 完成、VCR4-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config_profile_tests:: -- --nocapture`
- 遗留事项：
  - 执行 VCR4-2：将外部贴图覆盖接入 `setup_3d_scene` 材质构建并补行为测试。

- 时刻：2026-02-21 09:44:10 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-2（外部贴图覆盖接入场景构建并补测试）。
  - `setup_3d_scene` 接入 `ViewerExternalTextureConfig`，为 agent/location/asset/power_plant/power_storage 材质增加 `base_color_texture` 可选覆盖（未配置保持默认行为）。
  - location 材质分支判定升级为“颜色覆盖或贴图覆盖任一命中即启用专用 core/halo 材质”，避免与 chunk/world 材质复用导致的样式联动副作用。
  - 新增辅助逻辑并补单测：贴图槽位覆盖判定、location 样式覆盖总判定（材质或贴图）。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md` 状态为 VCR4-2 完成、VCR4-3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR4-3：更新 `doc/viewer-manual.md` 的贴图环境变量说明并完成阶段收口。

- 时刻：2026-02-21 09:48:30 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-3（手册/状态/devlog 收口）。
  - 更新 `doc/viewer-manual.md`：补充外部基础贴图覆盖环境变量说明（5 个 `*_BASE_TEXTURE_ASSET`）与最小启动示例。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md`：将 VCR4-3 标记完成，并将 Phase 4 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - Phase 4 已收口；后续可进入 normal/ORM/emissive 贴图与材质热切换阶段设计。

- 时刻：2026-02-21 09:53:39 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md`。
  - 项目状态初始化：VCR5-0 完成，VCR5-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR5-1：实现高级贴图覆盖配置结构与环境变量解析。

- 时刻：2026-02-21 09:59:13 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-1（高级贴图覆盖配置解析）。
  - `viewer_3d_config` 扩展 `ViewerExternalTextureSlotConfig`：新增 `normal_texture_asset`、`metallic_roughness_texture_asset`、`emissive_texture_asset` 三类可选字段。
  - 新增 15 个环境变量解析入口，覆盖 agent/location/asset/power_plant/power_storage 五类实体的高级贴图通道。
  - 扩展 profile tests：覆盖高级贴图通道有效值解析与空值回退行为。
  - 同步修复 `tests.rs` 中 texture slot 测试构造，适配新增字段。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md` 状态为 VCR5-1 完成、VCR5-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config_profile_tests:: -- --nocapture`
- 遗留事项：
  - 执行 VCR5-2：将 normal/metallic_roughness/emissive 通道接入 `setup_3d_scene` 材质构建并补测试。

- 时刻：2026-02-21 10:13:54 CST
- 完成内容：完成“基础 CI 门禁移除 builtin wasm hash 校验”改造收口与拆分提交。
  - 更新 `scripts/ci-tests.sh`：从基础门禁移除 `sync-m1/m4/m5-builtin-wasm-artifacts.sh --check`。
  - 更新 `testing-manual.md`：同步 required/full 与 S0 口径，明确 builtin wasm hash 校验改为按需/独立 gate。
  - 新增文档：`doc/testing/ci-remove-builtin-wasm-hash-checks-from-base-gate.md` 与 `doc/testing/ci-remove-builtin-wasm-hash-checks-from-base-gate.project.md`。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 当前仅 `m1` 保持 multi-runner 独立 hash gate；`m4/m5` 后续如需同等保障可再补独立 workflow。

- 时刻：2026-02-21 10:19:36 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-2（高级贴图通道接入场景构建并补测试）。
  - `setup_3d_scene` 接入高级贴图 4 通道（`base_color_texture` / `normal_map_texture` / `metallic_roughness_texture` / `emissive_texture`），覆盖 agent/location/asset/power_plant/power_storage。
  - 新增 `ResolvedTextureSlot` 与 `resolve_texture_slot`，统一外部贴图槽位解析，保持未配置时默认行为不变。
  - location 样式覆盖判定扩展为“材质覆盖或任一贴图通道覆盖”，确保非 base 贴图也能触发 location 专用材质分支。
  - 扩展 `tests.rs`：补充贴图槽位覆盖判定与 location 样式触发用例（normal-only 场景）。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md` 状态为 VCR5-2 完成、VCR5-3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR5-3：更新 `doc/viewer-manual.md` 高级贴图环境变量说明并完成阶段收口。

- 时刻：2026-02-21 10:22:46 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-3（手册/状态/devlog 收口）。
  - 更新 `doc/viewer-manual.md`：补充高级贴图通道环境变量说明，新增 normal / metallic_roughness / emissive 三类覆盖入口（按 agent/location/asset/power_plant/power_storage 五类实体展开）。
  - 更新贴图运行示例：增加 agent 的 normal/metallic_roughness/emissive 最小组合示例，保持与 base 贴图覆盖同时可用。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md`：将 VCR5-3 标记完成，并将 Phase 5 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - Phase 5 已收口；下一步进入贴图资产热切换/材质变体预览阶段建档与任务拆解。

- 时刻：2026-02-21 10:26:40 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 6 的 VCR6-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase6-material-variant-preview.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase6-material-variant-preview.project.md`。
  - 项目状态初始化：VCR6-0 完成，VCR6-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR6-1：实现材质变体预设解析、`F8` 热切换与材质应用逻辑并补测试。

- 时刻：2026-02-21 10:31:18 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 6 的 VCR6-1（材质变体预设解析与运行时热切换）。
  - 新增材质变体预设：`default` / `matte` / `glossy`，并接入环境变量 `AGENT_WORLD_VIEWER_MATERIAL_VARIANT_PRESET` 启动解析。
  - `setup_3d_scene` 接入预设倍率（roughness/metallic）并保持默认值兼容。
  - 新增运行时热切换：`F8` 循环切换预设并即时应用到 agent/asset/power_plant/power_storage 材质。
  - 补充单测：预设解析、切换顺序、倍率方向、clamp 行为与材质字段更新行为。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase6-material-variant-preview.project.md` 状态为 VCR6-1 完成、VCR6-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR6-2：更新手册/状态/devlog 并完成 Phase 6 收口。
