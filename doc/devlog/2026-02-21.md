# 2026-02-21

- 时刻：2026-02-21 00:03:49 CST
- 完成内容：完成“Runtime 超长文件拆分收敛（行数阈值治理）”任务。
  - 将 `crates/agent_world/src/runtime/state.rs` 的 `apply_domain_event` 超长逻辑按领域拆分到子模块：
    - `crates/agent_world/src/runtime/state/apply_domain_event_core.rs`
    - `crates/agent_world/src/runtime/state/apply_domain_event_gameplay.rs`
    - `crates/agent_world/src/runtime/state/apply_domain_event_governance_meta.rs`
  - 将 `crates/agent_world/src/runtime/world/event_processing.rs` 的 `action_to_event` 超长逻辑按领域拆分到子模块：
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_core.rs`
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_gameplay.rs`
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_policy_contract.rs`
    - `crates/agent_world/src/runtime/world/event_processing/action_to_event_economy.rs`
  - 主文件改为分发入口，保持业务语义不变，并将主文件行数降到阈值内：
    - `state.rs`: 951 行
    - `event_processing.rs`: 589 行
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 仓库内仍存在其他历史超长 Rust 文件（非本任务改动路径），需后续分批治理。

- 时刻：2026-02-21 00:17:17 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 1 的 VCR1-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase1-asset-pipeline.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase1-asset-pipeline.project.md`。
  - 项目状态初始化：VCR1-0 完成，VCR1-1 进行中，VCR1-2/VCR1-3 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR1-1：实现外部 mesh 配置结构与环境变量解析。

- 时刻：2026-02-21 00:25:44 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 1 的 VCR1-1 ~ VCR1-3。
  - `viewer_3d_config` 新增外部 mesh 覆盖配置：支持 agent/location/asset/power_plant/power_storage 五类 mesh 的环境变量路径解析。
  - `setup_3d_scene` 接入“外部 mesh 优先 + 内置几何兜底”装载策略，不影响默认行为。
  - 更新配置解析测试与新增空值兜底测试；更新 `doc/viewer-manual.md` 资产层外部 mesh 配置说明。
  - 项目文档 `doc/world-simulator/viewer-commercial-release-phase1-asset-pipeline.project.md` 回写为 VCR1 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 进入 Phase 2：引入首批真实美术资源包并建立视觉验收基线（截图矩阵/CI 门禁）。

- 时刻：2026-02-21 09:00:23 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md`。
  - 项目状态初始化：VCR2-0 完成，VCR2-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR2-1：实现视觉基线脚本并做本地验证。

- 时刻：2026-02-21 09:03:31 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-1（视觉基线脚本）。
  - 新增 `scripts/viewer-visual-baseline.sh`，增加 snapshot 基线文件存在性/非空校验。
  - 脚本执行 `cargo test -p agent_world_viewer egui_kittest_snapshot_`，形成可重复的 Viewer 视觉基线 gate 入口。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md` 状态为 VCR2-1 完成、VCR2-2 进行中。
- 测试：
  - `./scripts/viewer-visual-baseline.sh`
- 遗留事项：
  - 执行 VCR2-2：将 viewer 单测/wasm gate 与视觉基线脚本接入 `ci-tests.sh` 和 `.github/workflows/rust.yml`。

- 时刻：2026-02-21 09:07:54 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-2（CI 接入）。
  - `scripts/ci-tests.sh` 新增 `agent_world_viewer` 单测与 wasm check，并在 `required/full` 两个 tier 默认执行。
  - `.github/workflows/rust.yml` 的 `required-gate` 新增 `./scripts/viewer-visual-baseline.sh` 步骤，形成视觉基线 required gate。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md` 状态为 VCR2-2 完成、VCR2-3 进行中。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 执行 VCR2-3：更新 `testing-manual.md` 的 CI 覆盖口径并完成 Phase 2 收口。

- 时刻：2026-02-21 09:10:42 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 2 的 VCR2-3（文档与状态收口）。
  - 更新 `testing-manual.md`：
    - 回写 `ci-tests.sh` 已纳入 viewer 单测与 wasm check 的事实口径；
    - 回写 `rust.yml` required-gate 已执行 `viewer-visual-baseline.sh`；
    - 收口已过时 TODO（`agent_world_viewer` 测试阻塞项标记完成并注明验收）。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase2-visual-quality-gate.project.md`，将 VCR2-3 标记为完成并将 Phase 2 状态回写为全部完成。
- 测试：
  - `./scripts/viewer-visual-baseline.sh`
- 遗留事项：
  - 可进入下一阶段：真实资产质量提升与 Viewer Web 闭环更高自动化覆盖。

- 时刻：2026-02-21 09:14:06 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md`。
  - 项目状态初始化：VCR3-0 完成，VCR3-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR3-1：实现材质风格覆盖配置结构与环境变量解析。

- 时刻：2026-02-21 09:18:25 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-1（材质风格覆盖配置解析）。
  - `viewer_3d_config` 新增 `ViewerExternalMaterialConfig` / `ViewerExternalMaterialSlotConfig` 资源与解析入口。
  - 新增 10 个颜色环境变量解析（`#RRGGBB`），覆盖 agent/location/asset/power_plant/power_storage 的 base/emissive 颜色。
  - `app_bootstrap` 接入 `resolve_viewer_external_material_config()` 并插入全局资源。
  - 补充 profile tests：有效值解析、非法值兜底、空值忽略。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md` 为 VCR3-1 完成、VCR3-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config_profile_tests:: -- --nocapture`
- 遗留事项：
  - 执行 VCR3-2：将外部颜色覆盖接入 `setup_3d_scene` 材质构建并补行为测试。

- 时刻：2026-02-21 09:28:30 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-2（材质覆盖接入场景构建并补测试）。
  - `setup_3d_scene` 接入 `ViewerExternalMaterialConfig`，agent/asset/power_plant/power_storage 的 base/emissive 颜色支持“外部覆盖优先、默认兜底”。
  - 新增颜色构建辅助逻辑：`resolve_srgb_slot_color`、`emissive_from_srgb_with_boost` 等，统一材质颜色分辨与 emissive boost 处理。
  - 为 location 壳层新增独立材质句柄（core/halo），避免与 chunk/world 材质复用时产生联动副作用；未配置 location 覆盖时保持原句柄回退，保证默认行为兼容。
  - 更新 `scene_helpers_entities` 的 location core/halo 取材逻辑，改为使用新增 location 专用材质句柄。
  - 补充单测覆盖：颜色槽位覆盖优先级、emissive 上限饱和、location 覆盖开关判定。
  - 同步更新 `tests_scene_entities.rs`、`tests_scene_grid.rs` 的 `Viewer3dAssets` 测试构造。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md` 状态为 VCR3-2 完成、VCR3-3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR3-3：更新 `doc/viewer-manual.md` 材质颜色环境变量说明并完成阶段收口。

- 时刻：2026-02-21 09:31:53 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 3 的 VCR3-3（手册/状态/devlog 收口）。
  - 更新 `doc/viewer-manual.md`：补充外部材质颜色覆盖环境变量说明（10 个 `#RRGGBB` 项）与最小启动示例。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase3-material-style-layer.project.md`：将 VCR3-3 标记完成，并将 Phase 3 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - Phase 3 已收口；后续可进入纹理装载/后处理资产包阶段，并依托 Web 闭环与 snapshot 基线做回归。

- 时刻：2026-02-21 09:35:24 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md`。
  - 项目状态初始化：VCR4-0 完成，VCR4-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR4-1：实现贴图风格覆盖配置结构与环境变量解析。

- 时刻：2026-02-21 09:38:46 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-1（贴图风格覆盖配置解析）。
  - `viewer_3d_config` 新增 `ViewerExternalTextureConfig` / `ViewerExternalTextureSlotConfig` 资源与解析入口。
  - 新增 5 个贴图环境变量解析（base texture 资产路径），覆盖 agent/location/asset/power_plant/power_storage。
  - `app_bootstrap` 接入 `resolve_viewer_external_texture_config()` 并插入全局资源。
  - 补充 profile tests：有效值解析、空值忽略与回退。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md` 为 VCR4-1 完成、VCR4-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config_profile_tests:: -- --nocapture`
- 遗留事项：
  - 执行 VCR4-2：将外部贴图覆盖接入 `setup_3d_scene` 材质构建并补行为测试。

- 时刻：2026-02-21 09:44:10 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-2（外部贴图覆盖接入场景构建并补测试）。
  - `setup_3d_scene` 接入 `ViewerExternalTextureConfig`，为 agent/location/asset/power_plant/power_storage 材质增加 `base_color_texture` 可选覆盖（未配置保持默认行为）。
  - location 材质分支判定升级为“颜色覆盖或贴图覆盖任一命中即启用专用 core/halo 材质”，避免与 chunk/world 材质复用导致的样式联动副作用。
  - 新增辅助逻辑并补单测：贴图槽位覆盖判定、location 样式覆盖总判定（材质或贴图）。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md` 状态为 VCR4-2 完成、VCR4-3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR4-3：更新 `doc/viewer-manual.md` 的贴图环境变量说明并完成阶段收口。

- 时刻：2026-02-21 09:48:30 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 4 的 VCR4-3（手册/状态/devlog 收口）。
  - 更新 `doc/viewer-manual.md`：补充外部基础贴图覆盖环境变量说明（5 个 `*_BASE_TEXTURE_ASSET`）与最小启动示例。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase4-texture-style-layer.project.md`：将 VCR4-3 标记完成，并将 Phase 4 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - Phase 4 已收口；后续可进入 normal/ORM/emissive 贴图与材质热切换阶段设计。

- 时刻：2026-02-21 09:53:39 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md`。
  - 项目状态初始化：VCR5-0 完成，VCR5-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR5-1：实现高级贴图覆盖配置结构与环境变量解析。

- 时刻：2026-02-21 09:59:13 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-1（高级贴图覆盖配置解析）。
  - `viewer_3d_config` 扩展 `ViewerExternalTextureSlotConfig`：新增 `normal_texture_asset`、`metallic_roughness_texture_asset`、`emissive_texture_asset` 三类可选字段。
  - 新增 15 个环境变量解析入口，覆盖 agent/location/asset/power_plant/power_storage 五类实体的高级贴图通道。
  - 扩展 profile tests：覆盖高级贴图通道有效值解析与空值回退行为。
  - 同步修复 `tests.rs` 中 texture slot 测试构造，适配新增字段。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md` 状态为 VCR5-1 完成、VCR5-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer viewer_3d_config_profile_tests:: -- --nocapture`
- 遗留事项：
  - 执行 VCR5-2：将 normal/metallic_roughness/emissive 通道接入 `setup_3d_scene` 材质构建并补测试。

- 时刻：2026-02-21 10:13:54 CST
- 完成内容：完成“基础 CI 门禁移除 builtin wasm hash 校验”改造收口与拆分提交。
  - 更新 `scripts/ci-tests.sh`：从基础门禁移除 `sync-m1/m4/m5-builtin-wasm-artifacts.sh --check`。
  - 更新 `testing-manual.md`：同步 required/full 与 S0 口径，明确 builtin wasm hash 校验改为按需/独立 gate。
  - 新增文档：`doc/testing/ci-remove-builtin-wasm-hash-checks-from-base-gate.md` 与 `doc/testing/ci-remove-builtin-wasm-hash-checks-from-base-gate.project.md`。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 当前仅 `m1` 保持 multi-runner 独立 hash gate；`m4/m5` 后续如需同等保障可再补独立 workflow。

- 时刻：2026-02-21 10:19:36 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-2（高级贴图通道接入场景构建并补测试）。
  - `setup_3d_scene` 接入高级贴图 4 通道（`base_color_texture` / `normal_map_texture` / `metallic_roughness_texture` / `emissive_texture`），覆盖 agent/location/asset/power_plant/power_storage。
  - 新增 `ResolvedTextureSlot` 与 `resolve_texture_slot`，统一外部贴图槽位解析，保持未配置时默认行为不变。
  - location 样式覆盖判定扩展为“材质覆盖或任一贴图通道覆盖”，确保非 base 贴图也能触发 location 专用材质分支。
  - 扩展 `tests.rs`：补充贴图槽位覆盖判定与 location 样式触发用例（normal-only 场景）。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md` 状态为 VCR5-2 完成、VCR5-3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR5-3：更新 `doc/viewer-manual.md` 高级贴图环境变量说明并完成阶段收口。

- 时刻：2026-02-21 10:22:46 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 5 的 VCR5-3（手册/状态/devlog 收口）。
  - 更新 `doc/viewer-manual.md`：补充高级贴图通道环境变量说明，新增 normal / metallic_roughness / emissive 三类覆盖入口（按 agent/location/asset/power_plant/power_storage 五类实体展开）。
  - 更新贴图运行示例：增加 agent 的 normal/metallic_roughness/emissive 最小组合示例，保持与 base 贴图覆盖同时可用。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase5-advanced-texture-maps.project.md`：将 VCR5-3 标记完成，并将 Phase 5 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - Phase 5 已收口；下一步进入贴图资产热切换/材质变体预览阶段建档与任务拆解。

- 时刻：2026-02-21 10:26:40 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 6 的 VCR6-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase6-material-variant-preview.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase6-material-variant-preview.project.md`。
  - 项目状态初始化：VCR6-0 完成，VCR6-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR6-1：实现材质变体预设解析、`F8` 热切换与材质应用逻辑并补测试。

- 时刻：2026-02-21 10:31:18 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 6 的 VCR6-1（材质变体预设解析与运行时热切换）。
  - 新增材质变体预设：`default` / `matte` / `glossy`，并接入环境变量 `AGENT_WORLD_VIEWER_MATERIAL_VARIANT_PRESET` 启动解析。
  - `setup_3d_scene` 接入预设倍率（roughness/metallic）并保持默认值兼容。
  - 新增运行时热切换：`F8` 循环切换预设并即时应用到 agent/asset/power_plant/power_storage 材质。
  - 补充单测：预设解析、切换顺序、倍率方向、clamp 行为与材质字段更新行为。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase6-material-variant-preview.project.md` 状态为 VCR6-1 完成、VCR6-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR6-2：更新手册/状态/devlog 并完成 Phase 6 收口。

- 时刻：2026-02-21 10:33:42 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 6 的 VCR6-2（手册/状态/devlog 收口）。
  - 更新 `doc/viewer-manual.md`：补充材质变体环境变量 `AGENT_WORLD_VIEWER_MATERIAL_VARIANT_PRESET` 与运行时 `F8` 热切换说明，并新增最小启动示例。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase6-material-variant-preview.project.md`：将 VCR6-2 标记完成，并将 Phase 6 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - Phase 6 已收口；下一步进入贴图资产包热切换与主题批量预览阶段建档与任务拆解。

- 时刻：2026-02-21 10:47:13 CST
- 完成内容：修复 Builtin Wasm m1 Multi Runner 失败（hash 清单漂移）。
  - 基于 run `22248456023` 的失败日志回填 canonical hash：
    - `linux-x86_64`：10 个 m1 模块 hash 全量更新。
    - `darwin-arm64`：`m1.power.radiation_harvest` hash 更新为 runner 实际值。
  - 同步更新：
    - `crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules.sha256`
    - `crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules.identity.json`（hash_tokens 对齐）
- 测试：
  - `gh run view 22248456023 --repo eng-cc/agent-world --log-failed`（提取 runner 实际 hash）
  - `python3 -m json.tool crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules.identity.json`
  - 校验脚本（对比清单与 run 22248456023 提取值）输出 `mismatch_count 0`
- 遗留事项：
  - 触发/重跑 `Builtin Wasm m1 Multi Runner` 验证线上 runner 通过。
  - 本机磁盘空间不足（<1GiB）会影响深度本地复现，后续建议清理 `target/` 后再做本地全量复跑。

- 时刻：2026-02-21 10:59:20 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 7 的 VCR7-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase7-theme-pack-batch-preview.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase7-theme-pack-batch-preview.project.md`。
  - 项目状态初始化：VCR7-0 完成，VCR7-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR7-1：落地工业风主题包首版资产（mesh + PBR 贴图）。

- 时刻：2026-02-21 11:03:58 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 7 的 VCR7-1（工业风主题包资产）。
  - 新增资产生成脚本：`scripts/generate-viewer-industrial-theme-assets.py`（标准库实现，生成 glTF mesh 与 PNG 贴图）。
  - 生成并落库 `industrial_v1` 主题包：5 类实体 mesh（`*.gltf + *.bin`）与 20 张 PBR 贴图。
  - 新增主题预设：`industrial_default/matte/glossy.env`，统一外部 mesh/贴图与材质变体入口。
  - 新增资产包说明：`crates/agent_world_viewer/assets/themes/industrial_v1/README.md`。
  - 回写项目管理文档：`doc/world-simulator/viewer-commercial-release-phase7-theme-pack-batch-preview.project.md`，标记 VCR7-1 完成并切换到 VCR7-2。
- 测试：
  - `python3 scripts/generate-viewer-industrial-theme-assets.py --out-dir .tmp/industrial_theme_assets_smoke`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR7-2：新增主题批量预览脚本并打通截图产物目录。

- 时刻：2026-02-21 11:06:12 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 7 的 VCR7-2（主题批量预览脚本）。
  - 新增 `scripts/viewer-theme-pack-preview.sh`：支持 `default/matte/glossy` 多变体批量截图。
  - 输出目录规范化为 `output/theme_preview/<timestamp>/<variant>/`，每个变体产出 `viewer.png`、日志和元数据。
  - 脚本接入 `industrial_v1` 预设文件，并复用 `capture-viewer-frame.sh` 自动聚焦链路。
  - 回写项目管理文档 `doc/world-simulator/viewer-commercial-release-phase7-theme-pack-batch-preview.project.md`：VCR7-2 标记完成，VCR7-3 进行中。
- 测试：
  - `bash -n scripts/viewer-theme-pack-preview.sh`
  - `./scripts/viewer-theme-pack-preview.sh --help`
- 遗留事项：
  - 执行 VCR7-3：更新 `doc/viewer-manual.md` 并完成收口测试与状态回写。

- 时刻：2026-02-21 11:08:09 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 7 的 VCR7-3（手册与收口）。
  - 更新 `doc/viewer-manual.md`：新增 `industrial_v1` 主题包说明、预设切换命令、批量预览脚本与输出目录口径。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase7-theme-pack-batch-preview.project.md`：将 VCR7-3 标记完成，并将 Phase 7 状态回写为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `./scripts/viewer-theme-pack-preview.sh --help`
- 遗留事项：
  - Phase 7 已收口；下一步进入贴图资产热切换与运行中主题切换 UI 阶段建档与任务拆解。

- 时刻：2026-02-21 11:25:24 CST
- 完成内容：修复 `viewer-theme-pack-preview.sh` 在预热路径下的空数组参数问题，并完成主题预览 smoke 重跑。
  - 修复点：在 `set -u` 下，空数组 `no_prewarm_flag[@]` 展开导致脚本异常；改为可选字符串参数 `no_prewarm_arg`。
  - 复验：`llm_bootstrap + default` 变体成功输出截图与日志目录 `.tmp/theme_preview_smoke_rerun4/default/`。
- 测试：
  - `bash -n scripts/viewer-theme-pack-preview.sh`
  - `./scripts/viewer-theme-pack-preview.sh --scenario llm_bootstrap --variants default --viewer-wait 10 --base-port 5933 --out-dir .tmp/theme_preview_smoke_rerun4 --no-prewarm`
- 遗留事项：
  - 如需稳定支持 `minimal` 场景截图，可后续补充该场景的自动聚焦 target 与 capture timeout 口径。

- 时刻：2026-02-21 12:04:01 CST
- 完成内容：修复 Phase 7 主题批量预览默认构图，避免产出“纯背景/无主体信息”的截图。
  - 调整 `scripts/viewer-theme-pack-preview.sh` 默认自动化镜头：从 `first_agent` 近景改为 `first_location` 目标构图，并加入 `pan/orbit/wait` 步骤，提升主体可见性与稳定性。
  - 修复 auto-focus 目标冲突：批量预览链路透传 `--auto-focus-target first_location`，避免和自动化步骤互相覆盖导致主体漂移。
  - 回写项目管理文档 `doc/world-simulator/viewer-commercial-release-phase7-theme-pack-batch-preview.project.md`，新增并完成 VCR7-4（预览镜头构图修复）。
- 测试：
  - `bash -n scripts/viewer-theme-pack-preview.sh`
  - `./scripts/viewer-theme-pack-preview.sh --scenario llm_bootstrap --variants default --viewer-wait 8 --base-port 5976 --out-dir .tmp/theme_preview_visual_fix2 --no-prewarm`
- 遗留事项：
  - 当前截图已可稳定显示实体轮廓，但构图仍偏“单主体特写”；后续可在 Phase 8 增加多机位拼图输出（wide + close-up）以提升信息密度。

- 时刻：2026-02-21 12:14:02 CST
- 完成内容：完成贴图查看器功能建档（VTI-0）。
  - 新建设计文档：`doc/world-simulator/viewer-texture-inspector.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-texture-inspector.project.md`。
  - 在项目管理文档中标记 VTI-0 完成并切换到 VTI-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VTI-1：实现可截图贴图查看器脚本并验证输出目录。

- 时刻：2026-02-21 12:20:17 CST
- 完成内容：完成贴图查看器脚本实现（VTI-1）。
  - 新增脚本：`scripts/viewer-texture-inspector.sh`。
  - 支持 `--inspect` 选择贴图来源实体（`agent/location/asset/power_plant/power_storage/all`）。
  - 支持 `--variants` 批量材质变体截图（`default/matte/glossy`）。
  - 支持 `--base-texture/--normal-texture/--mr-texture/--emissive-texture` 临时覆盖贴图。
  - 输出目录规范化为 `output/texture_inspector/<timestamp>/<entity>/<variant>/`，并附带 `meta.txt`。
  - 回写项目管理文档 `doc/world-simulator/viewer-texture-inspector.project.md`：VTI-1 标记完成，VTI-2 进行中。
- 测试：
  - `bash -n scripts/viewer-texture-inspector.sh`
  - `./scripts/viewer-texture-inspector.sh --help`
  - `./scripts/viewer-texture-inspector.sh --inspect location --variants default --scenario llm_bootstrap --viewer-wait 8 --base-port 5990 --out-dir .tmp/texture_inspector_smoke --no-prewarm`
- 遗留事项：
  - 执行 VTI-2：补充手册入口并完成最终收口提交。

- 时刻：2026-02-21 12:26:05 CST
- 完成内容：完成贴图查看器收口（VTI-2）。
  - 更新手册 `doc/viewer-manual.md`：新增“贴图查看器（可截图）”章节，补充用途、参数与输出目录说明。
  - 更新项目管理文档 `doc/world-simulator/viewer-texture-inspector.project.md`：VTI-2 标记完成，VTI 全部任务收口。
- 测试：
  - `bash -n scripts/viewer-texture-inspector.sh`
  - `./scripts/viewer-texture-inspector.sh --help`
  - `./scripts/viewer-texture-inspector.sh --inspect agent --variants matte --scenario llm_bootstrap --viewer-wait 8 --base-port 5991 --out-dir .tmp/texture_inspector_smoke_vti2 --no-prewarm`
- 遗留事项：
  - 如需更高可读性，可在后续阶段增加多机位拼图导出（wide + close-up）。
- 时刻：2026-02-21 09:05:16 CST
- 完成内容：完成“Gameplay 发行差距收口（Prompt/Gate/经济动作/规则深度）”T0 建档。
  - 新建设计文档：`doc/game/gameplay-release-gap-closure-2026-02-21.md`。
  - 新建项目管理文档：`doc/game/gameplay-release-gap-closure-2026-02-21.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2~T5 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
- 遗留事项：
  - 执行 T1：优化默认 prompt 与中途切换能力，提升玩法事件触发覆盖。

- 时刻：2026-02-21 09:36:42 CST
- 完成内容：完成“游戏发展测试 prompt 套件”落地，替换过度功利化默认提示词并支持一键复验。
  - 将默认 LLM 提示词改为“生存稳定 -> 产业建设 -> 治理协作 -> 危机韧性”的阶段推进叙事，去除硬编码动作链：
    - `crates/agent_world/src/simulator/llm_agent.rs`
  - 为长稳压测脚本新增 `--prompt-pack`，支持 4 套内置测试 prompt：
    - `story_balanced`（推荐，含自动中途目标切换）
    - `frontier_builder`
    - `civic_operator`
    - `resilience_drill`
    - 实现文件：`scripts/llm-longrun-stress.sh`
  - 将 prompt pack 用法回写至测试手册 S8：
    - `testing-manual.md`
  - 同步更新本轮设计/项目文档中 Prompt 控制接口与任务状态：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
- 测试：
  - `bash -n scripts/llm-longrun-stress.sh`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 4 --min-active-ticks 1 --no-llm-io --out-dir .tmp/llm_stress_prompt_pack_smoke --prompt-pack story_balanced`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::llm_agent::tests::llm_config_uses_default_system_prompt -- --nocapture`
- 遗留事项：
  - 需继续执行长稳复验（`--release-gate-profile gameplay`）并观察 `story_balanced` 在 48/120 ticks 下的玩法动作覆盖提升幅度。

- 时刻：2026-02-21 09:41:02 CST
- 完成内容：完成 T1 运行期 prompt 切换能力收口（demo 入口），支持初始覆盖与中途切换并输出切换标记。
  - `world_llm_agent_demo` 新增参数：
    - `--llm-system-prompt`
    - `--llm-short-term-goal`
    - `--llm-long-term-goal`
    - `--prompt-switch-tick`
    - `--switch-llm-system-prompt`
    - `--switch-llm-short-term-goal`
    - `--switch-llm-long-term-goal`
  - 运行期在达到切换 tick 后应用新 prompt，并输出 `prompt_switch_applied=true`。
  - 补齐参数解析与约束测试（switch 与 tick 依赖关系）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 3 --prompt-switch-tick 2 --switch-llm-short-term-goal "switch smoke"`
- 遗留事项：
  - 继续执行 T3/T4，并完成 release-gate gameplay profile 的复验产物记录。

- 时刻：2026-02-21 09:48:15 CST
- 完成内容：完成 T3 经济治理动作协议补齐（LLM schema + parser + submitter 约束）。
  - 扩展 OpenAI decision schema 与 payload 字段，新增经济合约动作：
    - `open_economic_contract`
    - `accept_economic_contract`
    - `settle_economic_contract`
  - 扩展 `Action` 与解析流，打通 `Action::Open/Accept/SettleEconomicContract`。
  - 扩展 simulator submitter 校验，要求合约动作中的 actor 与提交 agent 一致。
  - 扩展执行控制与行为提示映射，避免新增动作在重复判定与指标统计中退化为 `other`。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::llm_agent::tests:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::submitter_access:: -- --nocapture`
- 遗留事项：
  - 继续提交 T4 m5 规则深度优化，并执行 T5 gate 复验与文档收口。

- 时刻：2026-02-21 09:52:40 CST
- 完成内容：完成 T4 m5 规则深度优化（war/crisis/economic overlay）并同步 wasm 产物指纹。
  - `m5_gameplay_war_core`：
    - 增加联盟声望/疲劳因子参与战争结算评分。
    - 输出 `loser_alliance_id` 与 `participant_outcomes`，覆盖胜负双方逐 agent 资源/声望增减。
    - 补齐联盟加入/退出/解散事件驱动下的成员快照更新。
  - `m5_gameplay_crisis_cycle`：
    - 引入 unresolved streak，动态调节危机生成间隔、严重度与超时惩罚倍率。
    - 将 `EconomicContractExpired` 纳入危机压力累积信号。
  - `m5_gameplay_economic_overlay`：
    - 联动 `EconomicContractSettled/Expired` 与 `CrisisResolved`，生成 economy/reliability/resilience 多轨 meta grant。
    - 新增按 `(operator,target,track)` 聚合发奖，避免同 tick 重复噪声指令。
  - 同步更新：
    - `crates/agent_world/src/runtime/world/artifacts/m5_builtin_modules.identity.json`
    - `crates/agent_world/src/runtime/world/artifacts/m5_builtin_modules.sha256`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test --manifest-path crates/agent_world_builtin_wasm_modules/m5_gameplay_war_core/Cargo.toml -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test --manifest-path crates/agent_world_builtin_wasm_modules/m5_gameplay_crisis_cycle/Cargo.toml -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test --manifest-path crates/agent_world_builtin_wasm_modules/m5_gameplay_economic_overlay/Cargo.toml -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::gameplay_protocol:: -- --nocapture`
- 遗留事项：
  - 进入 T5：完成 prompt 切换覆盖复验与 gameplay gate long-run 产物回填。

- 时刻：2026-02-21 10:43:27 CST
- 完成内容：完成“游戏发展型测试 prompt 去功利化优化”收口，继续推进被中断任务。
  - 优化 `story_balanced` prompt pack 文案，改为“阶段叙事 + 局势驱动”而非硬编码动作链：
    - `scripts/llm-longrun-stress.sh`
      - 初始目标从“动作覆盖要求”调整为“开局稳态 -> 生产协作 -> 治理与韧性”的剧情推进表达。
      - 中途切换目标从固定 `open -> cast -> resolve -> grant` 强制链条调整为“识别公共议题并选择合适治理/韧性动作，避免单一循环”。
  - 弱化 LLM 提示装配中的治理动作语气约束，保留可执行与合法性约束：
    - `crates/agent_world/src/simulator/llm_agent/prompt_assembly.rs`
      - “治理节奏约束”改为“治理节奏建议”。
      - gameplay `rule_denied` 场景由“必须切换”改为“优先切换并避免原样重试”。
      - open/cast 连续场景由“必须切换”改为“优先切换”。
    - 同步更新对应断言测试文案。
  - 更新测试手册 `story_balanced` 描述，明确“强调局势驱动剧情推进，不强制固定动作链”：
    - `testing-manual.md`
- 测试：
  - `bash -n scripts/llm-longrun-stress.sh`
  - `bash -n scripts/llm-switch-coverage-diff.sh`
  - `./scripts/llm-switch-coverage-diff.sh --log .tmp/llm_stress_story_gameplay_48_promptassembly2/run.log --switch-tick 24`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 4 --min-active-ticks 1 --no-llm-io --out-dir .tmp/llm_stress_prompt_pack_story_smoke_20260221 --prompt-pack story_balanced`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::llm_agent::prompt_assembly::tests::prompt_assembly_includes_harvest_max_amount_cap -- --nocapture`
- 遗留事项：
  - gameplay gate 单次全覆盖仍存在随机性，后续可继续通过多次 run 统计与 prompt 微调提升稳定度。

- 时刻：2026-02-21 10:59:21 CST
- 完成内容：修复本轮提交前 `required` 门禁暴露的 prompt 预算与断言漂移问题。
  - 调整 `PromptAssembler` 峰值预算保留参数，放宽 peak reserve，降低新增 gameplay/economic 协议文案带来的上下文截断风险：
    - `crates/agent_world/src/simulator/llm_agent/prompt_assembly.rs`
      - `PEAK_*_RESERVE_TOKENS` / `FINALIZE_PEAK_*_RESERVE_TOKENS` 调整为更宽松值。
      - 保留 conversation/context 在 peak 模式下的可见性（不再在 peak 阶段强制裁剪这两类段落）。
      - `prompt_budget_peak_budget_enforces_hard_target_on_large_inputs` 改为“硬目标 + 有界容差”断言，适配 schema 扩展后的提示词体积。
  - 将过于刚性的测试断言改为“细节可见时严格校验，截断时接受降级”：
    - `crates/agent_world/src/simulator/llm_agent/tests_part2.rs`
      - `llm_agent_user_prompt_omits_step_context_metadata` 不再强制要求 `[Conversation]` 字段必须出现。
      - `llm_agent_user_prompt_includes_recipe_coverage_summary` 与 `llm_agent_rewrites_execute_until_wait_action_to_actionable_harvest` 允许 `...(truncated)` 情况。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::llm_agent::tests::tests_part2::llm_agent_user_prompt_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::llm_agent::tests::tests_part2::llm_agent_rewrites_execute_until_wait_action_to_actionable_harvest -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::llm_agent::prompt_assembly::tests::prompt_budget_peak_budget_enforces_hard_target_on_large_inputs -- --nocapture`
- 遗留事项：
  - 后续若继续扩展 output schema，建议同时评估 `PromptSectionTrace` 的上下文截断率，避免再次触发断言漂移。

- 时刻：2026-02-21 11:15:21 CST
- 完成内容：完成“千 tick 长周期玩法演进”支持，增加多阶段 prompt 切换计划能力并接入压力脚本。
  - `world_llm_agent_demo` 新增多阶段切换参数：
    - `--prompt-switches-json <json>`
    - 格式为数组，元素包含 `tick` 与至少一个 `llm_*` 覆盖字段；支持 `system_prompt/short_term_goal/long_term_goal` 别名。
    - 与旧参数 `--prompt-switch-tick` + `--switch-llm-*` 显式互斥，避免配置冲突。
  - demo 主循环从“单次切换”改为“按 switch 序列逐个应用”，在日志输出：
    - `prompt_switch_applied=true switch_index=<n> switch_tick=<tick>`
  - `llm-longrun-stress.sh` 增加 `--prompt-switches-json` 透传能力，并在 summary 输出 `prompt_switches_json_set`。
  - `story_balanced` prompt pack 在长周期自动注入多阶段切换计划：
    - 短程：单阶段切换；
    - 中长程（>=360 ticks）：双阶段；
    - 超长程（>=960 ticks）：三阶段（中期治理 -> 中后期调度 -> 晚期稳态）。
  - 更新文档：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`（新增 T6 并标记完成）
    - `testing-manual.md`（补长周期示例与 `--prompt-switches-json` 说明）
- 测试：
  - `bash -n scripts/llm-longrun-stress.sh`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo -- --nocapture`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 24 --min-active-ticks 1 --no-llm-io --prompt-pack story_balanced --out-dir .tmp/llm_stress_story_balanced_multiswitch_smoke`
  - `env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 12 --report-json .tmp/llm_demo_multiswitch_validation/report.json --prompt-switches-json '[{"tick":3,"llm_short_term_goal":"phase2"},{"tick":6,"llm_short_term_goal":"phase3"},{"tick":9,"llm_short_term_goal":"phase4"}]'`
- 遗留事项：
  - 需要基于真实目标场景补一轮 1000+ ticks 的长稳统计口径（多次 run），再决定是否继续细化阶段 prompt 文案与切换点分布。

- 时刻：2026-02-21 12:21:46 CST
- 完成内容：完成 T7「llm_bootstrap 多 Agent + runtime gameplay bridge」收口与回归记录。
  - 场景扩容：`crates/agent_world/scenarios/llm_bootstrap.json` 从 1 Agent 扩展到 5 Agent，并同步稳定性测试期望（`crates/agent_world/src/simulator/tests/init.rs`）。
  - demo 接桥：`crates/agent_world/src/bin/world_llm_agent_demo.rs` 增加 runtime gameplay bridge，默认开启，支持 `--runtime-gameplay-bridge/--no-runtime-gameplay-bridge`，并输出 `runtime_bridge_*` 指标。
  - 压测脚本透传：`scripts/llm-longrun-stress.sh` 新增 bridge 参数并在 summary 输出 `runtime_gameplay_bridge`。
  - 闭环复验：
    - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 24 --prompt-pack story_balanced --release-gate --release-gate-profile gameplay --no-llm-io --out-dir .tmp/llm_stress_bridge_smoke`
      - 结果：5 Agent + bridge 生效，`runtime_bridge_action_success=5`，无 runtime bridge reject。
    - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 120 --prompt-pack civic_operator --release-gate --release-gate-profile gameplay --no-llm-io --out-dir .tmp/llm_stress_bridge_gameplay_120`
      - 结果：bridge 继续生效（`runtime_bridge_action_success=2`），但玩法覆盖仍不稳定（`action_kinds_total=3`，未覆盖 vote/crisis/meta，且出现 `parse_errors=1`）。
  - 文档回写：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
    - `testing-manual.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world scenarios_are_stable -- --nocapture`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 24 --prompt-pack story_balanced --release-gate --release-gate-profile gameplay --no-llm-io --out-dir .tmp/llm_stress_bridge_smoke`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 120 --prompt-pack civic_operator --release-gate --release-gate-profile gameplay --no-llm-io --out-dir .tmp/llm_stress_bridge_gameplay_120`
- 遗留事项：
  - gameplay gate 覆盖稳定性仍不足，下一轮优先评估“预设世界事件（提案/危机种子）+ 阶段目标”以提升 vote/crisis/meta 触发率。

- 时刻：2026-02-21 12:28:09 CST
- 完成内容：完成 `world_llm_agent_demo` 超 1200 行治理（按仓库约束拆分模块）。
  - 将 runtime bridge 逻辑拆分到：`crates/agent_world/src/bin/world_llm_agent_demo/runtime_bridge.rs`。
  - 将 LLM I/O 日志辅助拆分到：`crates/agent_world/src/bin/world_llm_agent_demo/llm_io.rs`。
  - 主文件 `crates/agent_world/src/bin/world_llm_agent_demo.rs` 行数降至 1192（满足阈值）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world scenarios_are_stable -- --nocapture`
  - `bash -n scripts/llm-longrun-stress.sh`
- 遗留事项：
  - gameplay gate 覆盖稳定性问题仍待下一轮“预设世界事件 + 阶段目标”任务收敛。

- 时刻：2026-02-21 12:29:08 CST
- 完成内容：完成拆分后脚本入口 smoke 复验，确认 bridge 路径未回归。
  - 执行：`./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 8 --prompt-pack story_balanced --no-llm-io --out-dir .tmp/llm_stress_bridge_postsplit_smoke`
  - 结果：`runtime_gameplay_bridge=1`，run passed，脚本与 demo 端到端链路正常。
- 测试：
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 8 --prompt-pack story_balanced --no-llm-io --out-dir .tmp/llm_stress_bridge_postsplit_smoke`
- 遗留事项：
  - gameplay 动作覆盖稳定性问题不在本次拆分内，后续继续通过预设事件与阶段策略收敛。

- 时刻：2026-02-21 13:09:22 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 8 的 VCR8-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-commercial-release-phase8-runtime-theme-hot-reload-and-asset-v2.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-commercial-release-phase8-runtime-theme-hot-reload-and-asset-v2.project.md`。
  - 项目状态初始化：VCR8-0 完成，VCR8-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR8-1：实现运行时主题状态、preset 解析与应用引擎。

- 时刻：2026-02-21 13:22:44 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 8 的 VCR8-1（运行时主题状态、preset 解析与应用引擎）。
  - 新增 `crates/agent_world_viewer/src/theme_runtime.rs`：实现主题运行时状态资源、preset 文件解析（`export`/`KEY=VALUE`/`unset`）、内置 preset fallback、主题应用到 mesh/material/texture 与场景重建触发。
  - `crates/agent_world_viewer/src/app_bootstrap.rs` 接入主题运行时资源初始化与 `apply_theme_runtime_updates` 系统调度，支持运行时按需应用与热重载检查。
  - 新增 `industrial_v2` 三个预设文件用于内置与文件路径双路径加载：
    - `crates/agent_world_viewer/assets/themes/industrial_v2/presets/industrial_v2_default.env`
    - `crates/agent_world_viewer/assets/themes/industrial_v2/presets/industrial_v2_matte.env`
    - `crates/agent_world_viewer/assets/themes/industrial_v2/presets/industrial_v2_glossy.env`
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase8-runtime-theme-hot-reload-and-asset-v2.project.md`：VCR8-1 标记完成，VCR8-2 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VCR8-2：接入右侧面板主题控制区并补热重载交互测试。

- 时刻：2026-02-21 13:24:29 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 8 的 VCR8-2（右侧面板主题控制区与热重载流程）。
  - 拆分右侧面板模块，新增：
    - `crates/agent_world_viewer/src/egui_right_panel_controls.rs`
    - `crates/agent_world_viewer/src/egui_right_panel_theme_runtime.rs`
  - `crates/agent_world_viewer/src/egui_right_panel.rs` 接入 Theme Runtime 控件区（preset 下拉、自定义路径、Apply、Auto Hot Reload、状态文本），并保持既有控制区行为。
  - 新增交互测试 `egui_kittest_theme_runtime_apply_and_hot_reload_controls_work`，验证“应用主题/自动热重载”按钮状态变更。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase8-runtime-theme-hot-reload-and-asset-v2.project.md`：VCR8-2 标记完成，VCR8-3 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - 执行 VCR8-3：生成并落地 `industrial_v2` 真实 mesh/texture 资产。

- 时刻：2026-02-21 13:29:04 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 8 的 VCR8-3（`industrial_v2` 资产包与预设落地）。
  - 扩展 `scripts/generate-viewer-industrial-theme-assets.py`：新增 `--quality {v1,v2}`，支持按质量档输出不同 mesh 命名后缀、几何细节与贴图分辨率（v2 为 512）。
  - 生成并落地 `crates/agent_world_viewer/assets/themes/industrial_v2/meshes/*` 与 `textures/*` 全量资产，文件名与 Phase 8 preset 约定保持一致（`*_industrial_v2.gltf/.bin` 与 `*_base/normal/metallic_roughness/emissive.png`）。
  - 补齐 `crates/agent_world_viewer/assets/themes/industrial_v2/README.md` 并保留脚本再生成入口。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase8-runtime-theme-hot-reload-and-asset-v2.project.md`：VCR8-3 标记完成，VCR8-4 进行中。
- 测试：
  - `python3 scripts/generate-viewer-industrial-theme-assets.py --quality v2 --out-dir crates/agent_world_viewer/assets/themes/industrial_v2`
  - `python3 scripts/generate-viewer-industrial-theme-assets.py --quality v1 --out-dir .tmp/industrial_v1_smoke`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR8-4：新增主题包校验脚本并在 CI 前置 smoke 校验结构/尺寸/几何阈值。

- 时刻：2026-02-21 13:32:18 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 8 的 VCR8-4（主题资产校验脚本与 smoke 验证）。
  - 新增 `scripts/validate-viewer-theme-pack.py`：校验主题包目录结构（`meshes/ textures/ presets/`）、预设文件齐全性、贴图尺寸阈值与方形约束、gltf 顶点数下限与 buffer 文件存在性。
  - 支持 `--profile {v1,v2}` 与 `--min-texture-size` 覆盖参数，覆盖当前两代工业主题包校验需求。
  - 完成 smoke：`industrial_v2`（v2 profile）和 `industrial_v1`（v1 profile）均验证通过。
  - 更新项目管理文档 `doc/world-simulator/viewer-commercial-release-phase8-runtime-theme-hot-reload-and-asset-v2.project.md`：VCR8-4 标记完成，VCR8-5 进行中。
- 测试：
  - `python3 scripts/validate-viewer-theme-pack.py --theme-dir crates/agent_world_viewer/assets/themes/industrial_v2 --profile v2`
  - `python3 scripts/validate-viewer-theme-pack.py --theme-dir crates/agent_world_viewer/assets/themes/industrial_v1 --profile v1`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VCR8-5：更新 `doc/viewer-manual.md` 并完成 Phase 8 文档/测试收口。

- 时刻：2026-02-21 13:35:29 CST
- 完成内容：完成 Viewer 商业化发行缺口收敛 Phase 8 的 VCR8-5（手册、状态回写、devlog 与测试收口）。
  - 更新 `doc/viewer-manual.md`：新增 `industrial_v2` 主题包使用说明（推荐默认）、运行中主题切换 UI/环境变量说明、主题包校验命令，以及 v1 兼容包说明。
  - 回写项目管理文档 `doc/world-simulator/viewer-commercial-release-phase8-runtime-theme-hot-reload-and-asset-v2.project.md`：VCR8-5 标记完成，Phase 8 状态更新为全部完成。
  - 完成 Phase 8 收口测试并记录结果。
- 测试：
  - `python3 scripts/validate-viewer-theme-pack.py --theme-dir crates/agent_world_viewer/assets/themes/industrial_v2 --profile v2`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：
  - Phase 8 已收口，后续可进入 UI polish/动效与发行验收阶段。

- 时刻：2026-02-21 17:13:19 CST
- 完成内容：完成 Viewer Web 语义化测试 API 收口（`window.__AW_TEST__`）。
  - 新建设计/项目文档：
    - `doc/world-simulator/viewer-web-semantic-test-api.md`
    - `doc/world-simulator/viewer-web-semantic-test-api.project.md`
  - `viewer_automation` 支持运行时步骤队列：
    - 新增 runtime step 入队能力，支持在启动后动态追加 `mode/focus/pan/zoom/orbit/select/wait`。
    - 保留原环境变量启动自动化路径，并实现“运行时队列优先，启动脚本兜底”的执行顺序。
  - 新增 wasm 测试 API 模块：
    - 文件：`crates/agent_world_viewer/src/web_test_api.rs`。
    - 注入 `window.__AW_TEST__`：`runSteps/setMode/focus/select/sendControl/getState`。
    - 测试模式开关：`cfg(debug_assertions)` 或 URL query `?test_api=1`。
    - 所有 JS 调用先入队，Bevy 主线程逐帧消费，避免并发改状态。
    - `getState()` 返回连接状态、tick、选中对象、错误计数/最近错误、事件与 trace 计数。
  - `app_bootstrap` 接入：
    - Startup 注册 `setup_web_test_api`。
    - Update 增加命令消费系统与状态快照发布系统。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
- 遗留事项：
  - 将 `testing-manual.md` S6 的 Playwright 示例改为优先使用 `window.__AW_TEST__` 语义调用，降低坐标点击脆弱性。

- 时刻：2026-02-21 17:18:51 CST
- 完成内容：完成 WTA-6（`testing-manual.md` S6 语义化调用迁移）并回写项目状态。
  - 更新 `testing-manual.md`：
    - S6 Playwright 示例 URL 增加 `test_api=1` 开关；
    - 新增 `window.__AW_TEST__` 的 `runSteps/sendControl/getState` 调用示例；
    - 最小通过标准增加 `getState()` 字段断言；
    - 补充“Playwright 优先语义化调用，避免坐标点击”的约定。
  - 更新 `doc/world-simulator/viewer-web-semantic-test-api.project.md`：
    - 新增并勾选 `WTA-6`；
    - 状态改为“WTA 全部完成（含手册示例迁移）”。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 可选补充：将常用 `window.__AW_TEST__` 流程封装为 Playwright helper，减少重复 `eval` 命令。

- 时刻：2026-02-21 17:24:46 CST
- 完成内容：完成“Viewer 发行验收测试迭代闭环”VRQ-0（建档）。
  - 新建设计文档：`doc/world-simulator/viewer-release-qa-iteration-loop.md`。
  - 新建项目管理文档：`doc/world-simulator/viewer-release-qa-iteration-loop.project.md`。
  - 项目状态初始化：VRQ-0 完成，VRQ-1 进行中。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
- 遗留事项：
  - 执行 VRQ-1：跑现有套件基线并输出首轮完成度/视觉结论。

- 时刻：2026-02-21 17:38:32 CST
- 完成内容：完成 VRQ-1（基线执行）与 VRQ-2（套件优化）主实现。
  - VRQ-1 基线执行：
    - 执行 `./scripts/viewer-visual-baseline.sh`（通过）。
    - 执行 S6 Web 语义闭环（live + web + Playwright），产物：
      - `output/playwright/viewer/vrq1-playwright-20260221-172654.log`
      - `output/playwright/viewer/vrq1-web-20260221-172654.png`
    - 识别到原有套件缺口：
      - 仅看 `console error=0` 会漏掉 Bevy `%cERROR%c` 文本日志；
      - 语义调用缺少统一断言与报告产物。
  - VRQ-2 套件优化：
    - 新增脚本：`scripts/viewer-release-qa-loop.sh`。
    - 一键串联视觉基线 + Web 语义闭环，自动生成 `release-qa-summary-*.md`。
    - 新增门禁能力：
      - `__AW_TEST__` 可用与关键字段断言；
      - 语义动作序列（`runSteps` + `sendControl`）执行后状态断言；
      - Playwright console dump 中 Bevy `%cERROR%c`/`[ERROR]` 扫描计数；
      - 截图产物落盘校验。
    - 修复脚本实现问题：
      - 兼容 `playwright_cli.sh` 非可执行位（统一 `bash "$PWCLI"`）；
      - `run-code` 即使报错也可能返回 0，改为解析 `### Error`；
      - 修正 console error 模式匹配与计数逻辑；
      - 进程清理补 `wait`，降低退出噪声。
- 测试：
  - `./scripts/viewer-release-qa-loop.sh --skip-visual-baseline`（多轮迭代 smoke）
  - `./scripts/viewer-release-qa-loop.sh`（完整版，输出 FAIL 报告用于定位真实缺口）
- 遗留事项：
  - 执行 VRQ-3：更新 `testing-manual.md` 并完成项目状态收口。

- 时刻：2026-02-21 17:40:23 CST
- 完成内容：完成 VRQ-3（手册接入 + 复验收口）。
  - 更新 `testing-manual.md` S6：
    - 新增一键发行验收入口：`./scripts/viewer-release-qa-loop.sh`；
    - 回写产物路径与门禁口径（视觉基线 + 语义门禁 + Bevy `%cERROR%c`/`[ERROR]` 扫描）。
  - 更新项目管理文档 `doc/world-simulator/viewer-release-qa-iteration-loop.project.md`：
    - 标记 VRQ-3 完成；
    - 状态收口为 VRQ 全部完成。
  - 完成复验：
    - `output/playwright/viewer/release-qa-summary-20260221-173716.md` 显示 Overall=FAIL；
    - 已稳定复现两项真实缺口：
      - 语义控制序列后连接进入 `error`（`live seek stalled at tick 0 before target 1`）；
      - console dump 存在 Bevy `%cERROR%c`（`fonts/ms-yahei.ttf` 加载失败）。
- 测试：
  - `./scripts/viewer-release-qa-loop.sh`
- 遗留事项：
  - 下一任务可转入缺口修复：1) seek/control 错误态稳定性；2) Web 字体资产加载失败修复。

- 时刻：2026-02-21 18:33:01 CST
- 完成内容：推进 Viewer 发行验收闭环第二轮迭代（脚本鲁棒性 + zoom 可验证性）并回写文档状态。
  - `scripts/viewer-release-qa-loop.sh` 升级：
    - live 启动默认切到 `--topology single --viewer-no-consensus-gate`，并提供 `--with-consensus-gate` 回退开关；
    - 语义 gate 改为连接轮询稳定判定（`waitForConnected`），保留 `runSteps/sendControl/getState` 闭环断言；
    - 新增 zoom 门禁：near/mid/far 三档动作 + 三张截图产物 + 像素指标；
    - 修复 WebGL canvas 直接读回黑帧误判：改为对 Playwright 截图（base64）做像素分析；
    - 新增缩放效果真实性门禁：`cameraRadius` 语义变化 + near/far 截图签名差异阈值。
  - 扩展 `window.__AW_TEST__.getState()`：
    - `crates/agent_world_viewer/src/web_test_api.rs` 新增相机字段 `cameraMode/cameraRadius/cameraOrthoScale`，支撑 zoom 语义断言。
  - 字体资产路径问题收敛：
    - `crates/agent_world_viewer/src/copyable_text.rs` 增加嵌入字体加载；
    - `crates/agent_world_viewer/src/main.rs` 将 UI/3D 标签字体改为 embedded handle，Web console 中 `%cERROR%c` 字体加载错误归零。
  - 文档回写：
    - `testing-manual.md` S6 门禁口径更新为“相机语义 + 截图像素差异”；
    - `doc/world-simulator/viewer-release-qa-iteration-loop.md` 与 `.project.md` 增补 VRQ-4/5/6；
    - `doc/world-simulator/viewer-web-semantic-test-api.md` 与 `.project.md` 增补 WTA-7（相机语义字段）。
- 测试：
  - `bash -n scripts/viewer-release-qa-loop.sh`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - `./scripts/viewer-release-qa-loop.sh --skip-visual-baseline`
    - 通过轮次：`output/playwright/viewer/release-qa-summary-20260221-181628.md`（脚本鲁棒性验证）
    - 最新轮次：`output/playwright/viewer/release-qa-summary-20260221-182952.md`（按新增严格 zoom 差异门禁 FAIL）
  - 最小诊断（手工 run-code）：`zoom=0.5/2.5` 后 `cameraRadius` 仍停留 48，见 `.tmp/zoomdiag-live.log` 关联 run-code 输出。
- 遗留事项：
  - VRQ-6 未收口：当前 near/far 缩放截图视觉差异不足（`zoom visual delta too small`），脚本已稳定复现；需继续定位 Viewer 实际渲染/镜头变换链路。
  - 语义 gate 观测到 `tick` 仍常驻 0（play/pause 后无推进），属于发行完成度残余风险，需后续与 runtime/控制链路联调。

- 时刻：2026-02-21 18:36:27 CST
- 完成内容：修复语义 gate 选择断言抖动并完成一轮完整入口回归。
  - `scripts/viewer-release-qa-loop.sh` 的 semantic 选择断言改为轮询等待（最多 6s），避免瞬时 `selectedKind=null` 误判。
  - 完整入口回归（含视觉基线）结果：
    - 视觉基线通过；
    - 语义 gate 通过；
    - zoom 差异门禁稳定失败（`zoom visual delta too small between near/far stages`），持续指向发行残余缺口而非脚本抖动。
- 测试：
  - `bash -n scripts/viewer-release-qa-loop.sh`
  - `./scripts/viewer-release-qa-loop.sh`
    - `output/playwright/viewer/release-qa-summary-20260221-183335.md`（full，语义偶发失败后已修）
  - `./scripts/viewer-release-qa-loop.sh --skip-visual-baseline`
    - `output/playwright/viewer/release-qa-summary-20260221-183516.md`（语义通过，zoom 差异门禁失败）
- 遗留事项：
  - 继续 VRQ-6：zoom 门禁已能稳定复现“半径变化但画面近远差异过小”，需进入 viewer 渲染/镜头链路排查与修复。

- 时刻：2026-02-21 18:37:59 CST
- 完成内容：完成修订后完整版发行验收回归并确认当前真实缺口。
  - 运行 `./scripts/viewer-release-qa-loop.sh`（完整版）后：
    - Visual baseline：passed
    - Semantic gate：passed
    - Zoom texture gate：failed（`zoom visual delta too small between near/far stages: 0.005`）
    - Bevy `[ERROR]`：0
  - 结论：套件抖动已明显收敛，当前 FAIL 由稳定可复现的 zoom 视觉差异缺口触发。
- 测试：
  - `./scripts/viewer-release-qa-loop.sh`
  - 报告：`output/playwright/viewer/release-qa-summary-20260221-183648.md`
- 遗留事项：
  - VRQ-6 持续进行：修复“相机语义变化已发生，但 near/far 实际画面差异不足”导致的发行门禁失败。

- 时刻：2026-02-21 18:59:33 CST
- 完成内容：完成 Viewer Web 全屏自适应与右侧面板整体显隐优化收口。
  - 新建设计/项目文档：
    - `doc/world-simulator/viewer-web-fullscreen-panel-toggle.md`
    - `doc/world-simulator/viewer-web-fullscreen-panel-toggle.project.md`
  - `crates/agent_world_viewer/src/app_bootstrap.rs`：
    - wasm 窗口配置新增 `fit_canvas_to_parent = true`，Web 端跟随浏览器容器尺寸，避免固定窗口体验。
  - `crates/agent_world_viewer/src/egui_right_panel.rs`：
    - 右侧主面板与 Chat 面板宽度改为“最小宽度 + 动态上限比例”，移除固定像素上限约束；
    - 新增右侧面板总开关（`隐藏面板/显示面板`），隐藏时主面板与 Chat 面板均不渲染；
    - 隐藏状态将 `RightPanelWidthState` 置 `0`，3D 视口区域可用宽度最大化。
  - `crates/agent_world_viewer/src/panel_layout.rs`：
    - `RightPanelLayoutState` 新增 `panel_hidden` 布局状态。
  - `crates/agent_world_viewer/src/i18n.rs`：
    - 新增 `right_panel_toggle_label` 中英文文案。
  - `crates/agent_world_viewer/src/egui_right_panel_tests.rs`：
    - 更新自适应宽度测试为动态比例规则，并补充 `panel_hidden` 场景断言。
  - 更新手册：
    - `doc/viewer-manual.md` 新增“Web 全屏自适应（wasm）”与“面板总开关”说明。
  - 项目文档状态回写：
    - `doc/world-simulator/viewer-web-fullscreen-panel-toggle.project.md` 标记 VWFP-1~VWFP-7 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
  - Web 闭环 smoke（Playwright）：
    - 启动 `world_viewer_live`（`--bind 127.0.0.1:5623 --web-bind 127.0.0.1:5611`）
    - 启动 `run-viewer-web.sh --port 4373`
    - 执行 `open/eval(runSteps/sendControl)/console/screenshot`
    - 截图：`output/playwright/viewer/viewer-web-fullscreen-panel.png`
    - 日志：`.tmp/web-smoke-vwfp-2/live.log`、`.tmp/web-smoke-vwfp-2/web.log`
    - 结果：`window.__AW_TEST__` 可用，console `0 errors`（2 warnings）。
- 遗留事项：
  - 右侧面板“总开关”当前为运行时状态，未写入本地持久化文件；如需跨重启记忆可在后续任务接入持久化字段。
- 时刻：2026-02-21 13:36:41 CST
- 完成内容：完成“起步规则可查询 + 工业前置恢复”一轮实现与回归。
  - 新增规则查询工具链路：
    - OpenAI tool：`world_rules_guide`
    - module 路由：`world.rules.guide`
    - alias 归一化：`world_rules_guide/world-rules-guide/world.rules_guide -> world.rules.guide`
  - `run_prompt_module` 增加 `world.rules.guide` 主题化规则输出（`quickstart/resources/industry/governance/economic/social/recovery/all`），并加入 `agent.modules.list`。
  - 优化默认起步 prompt：默认 system/short/long goal 增加“规则不明先查规则，按前置条件逐步推进”约束。
  - 修正失败恢复策略关键错误：`insufficient_resource.data` 从“继续 `refine_compound`”改为“优先 `mine_compound` 补前置后再 refine”，减少精炼失败循环。
  - 回写文档：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
    - `testing-manual.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world world_rules_guide -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world responses_tools_register -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world prompt_assembly_includes_harvest_max_amount_cap -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_user_prompt_contains_failure_recovery_policy -- --nocapture`
- 遗留事项：
  - 5 Agent 工业预演中，`mine/refine` 已可稳定触发，但 `build_factory/schedule_recipe` 触发率仍偏低；240 tick 级别尚未稳定产出“可复用工业基线”。
  - 下一步需要把“工业基线模式”从 `story_balanced`/`frontier_builder` 通用包中独立出来（工业阶段专用 switch 或工业里程碑驱动），再跑 1000+ tick 产出 baseline。

- 时刻：2026-02-21 17:20:50 CST
- 完成内容：推进 T8 工业基线落地能力，补齐“工业专用 prompt + 长程节流参数”并记录真实阻塞。
  - `scripts/llm-longrun-stress.sh`：
    - 新增 `--prompt-pack industrial_baseline`（工业阶段叙事：规则读取 -> 采矿/精炼 -> 建厂/排产）。
    - 新增 `--llm-execute-until-auto-reenter-ticks <n>`，透传 `AGENT_WORLD_LLM_EXECUTE_UNTIL_AUTO_REENTER_TICKS` 到 demo 进程。
    - `industrial_baseline` 默认设置 auto-reenter=24（可覆盖）。
    - summary 新增 `llm_execute_until_auto_reenter_ticks` 字段。
  - `testing-manual.md`：
    - S8 两阶段示例切换为 `industrial_baseline`，并补充 auto-reenter 参数说明。
    - 增加 1000+ tick wall-clock 风险提示（建议后台长跑）。
  - 文档回写：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
  - 运行观测（中程探测）：
    - 工业叙事 prompt 下在前 50 tick 已多次触发 `mine_compound/refine_compound/build_factory/schedule_recipe`，工业链路可达性显著好于此前通用包默认路径。
    - 1000+ tick 连续 run 主要瓶颈从“动作触发率”转为“LLM 往返时延导致 wall-clock 过长”。
- 测试：
  - `bash -n scripts/llm-longrun-stress.sh`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 200 --prompt-pack industrial_baseline --release-gate --release-gate-profile industrial --min-active-ticks 1 --max-llm-errors 999 --max-parse-errors 999 --max-repair-rounds-max 999 --no-llm-io --llm-execute-until-auto-reenter-ticks 24 --out-dir .tmp/llm_baseline_probe_execuntil_200`（人工中断；前 49 tick 已出现多次建厂与排产）
- 遗留事项：
  - 需在后台长跑完成 1000+ tick 并落盘最终基线（`snapshot.json/journal.json`），然后回填最终质量指标（factory/recipe/action_kind 分布）。

- 时刻：2026-02-21 17:22:50 CST
- 完成内容：补充 `industrial_baseline` 参数链路 smoke，确认新参数与默认包可被脚本正确透传。
- 测试：
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 1 --prompt-pack industrial_baseline --llm-execute-until-auto-reenter-ticks 12 --min-active-ticks 0 --max-llm-errors 999 --max-parse-errors 999 --max-repair-rounds-max 999 --no-llm-io --out-dir .tmp/llm_prompt_pack_industrial_smoke`
  - 结果：run passed，summary 中 `prompt_pack=industrial_baseline` 与 `llm_execute_until_auto_reenter_ticks=12` 生效。
- 遗留事项：
  - 1000+ tick 基线仍需后台长跑产出最终 state dir 与质量指标。

- 时刻：2026-02-21 18:18:15 CST
- 完成内容：完成 T8 基线闭环收口（按用户口径允许提前收口），产出“可复用工业基线”并验证可加载续跑治理。
  - 产出工业基线 state：
    - 运行目录：`.tmp/llm_baseline/chunked_1200/chunk_01`
    - 状态目录：`.tmp/llm_baseline/chunked_1200/state_01`（含 `snapshot.json` / `journal.json`）
    - 工业 gate 通过，核心指标：
      - `action_kind_counts=build_factory:10,harvest_radiation:14,mine_compound:33,move_agent:5,refine_compound:26,schedule_recipe:5`
      - 覆盖工厂与配方链路（日志可见 `control_chip/motor/logistics_drone`）
  - 从基线加载后续跑治理 gate（`civic_operator` + 分阶段目标切换）：
    - 运行目录：`.tmp/llm_baseline/governance_from_state01_80_v3`
    - gameplay gate 通过，核心指标：
      - `action_kind_counts=cast_governance_vote:9,grant_meta_progress:46,open_governance_proposal:14,resolve_crisis:10`
  - 结论：当前 `state_01` 已可作为“工业已建成的稳定起点”，用于后续社会治理/危机韧性闭环测试，无需等待 1200 tick 世界年龄才可开始治理测试。
- 测试：
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 100 --prompt-pack industrial_baseline --llm-execute-until-auto-reenter-ticks 24 --runtime-gameplay-bridge --release-gate --release-gate-profile industrial --no-llm-io --save-state-dir .tmp/llm_baseline/chunked_1200/state_01 --out-dir .tmp/llm_baseline/chunked_1200/chunk_01`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 80 --load-state-dir .tmp/llm_baseline/chunked_1200/state_01 --prompt-pack civic_operator --runtime-gameplay-bridge --release-gate --release-gate-profile gameplay --llm-execute-until-auto-reenter-ticks 12 --prompt-switches-json '[{\"tick\":20,\"llm_short_term_goal\":\"stabilize active public crises by selecting one urgent crisis, coordinating proposal/vote support, and resolving it with explicit impact notes.\",\"llm_long_term_goal\":\"convert industrial surplus into social resilience: keep governance cadence healthy, avoid repetitive grants on the same target, and ensure decisions reference observed world state changes.\"},{\"tick\":35,\"llm_short_term_goal\":\"after at least one resolved crisis, prioritize targeted meta-progress grants that unlock governance throughput and social services, while maintaining proposal/vote activity.\",\"llm_long_term_goal\":\"build a balanced civic loop: recurring proposal->vote->resolve->grant cycles across distinct targets with minimal denial/retry noise.\"}]' --no-llm-io --out-dir .tmp/llm_baseline/governance_from_state01_80_v3`
  - `bash -n scripts/llm-longrun-stress.sh`
- 遗留事项：
  - 如需“更高世界年龄”的基线（例如 1200+ tick age），可在 `state_01` 基础上继续按每次 100 tick 的 load/save 分段追加，不影响当前治理测试入口可用性。

- 时刻：2026-02-21 18:24:20 CST
- 完成内容：完成“基线数据转存到 git 跟踪目录”任务，避免 `.tmp` 清理导致工件丢失。
  - 新增目录：`fixtures/llm_baseline/state_01`
  - 复制基线工件：
    - `fixtures/llm_baseline/state_01/snapshot.json`
    - `fixtures/llm_baseline/state_01/journal.json`
  - 新增说明文档：`fixtures/llm_baseline/state_01/README.md`（记录来源、用途与加载示例）。
  - 结果：该 baseline 不再依赖 `.tmp`，可以被 git 持久追踪并用于后续治理/危机闭环测试。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world simulator::tests::persist::kernel_persist_and_restore -- --nocapture`
- 遗留事项：
  - 如需在 CI 中复用该 baseline，可后续补一个专用 smoke 脚本（基于 `--load-state-dir fixtures/llm_baseline/state_01`）并接入 `test_tier_full`。

- 时刻：2026-02-21 18:38:04 CST
- 完成内容：完成“基线 fixture smoke + full tier 接入”任务。
  - 新增 `test_tier_full` 定向回归：`kernel_loads_tracked_llm_baseline_fixture_state`（校验 git 跟踪基线可加载且包含工业阶段关键结构）。
  - 新增脚本：`scripts/llm-baseline-fixture-smoke.sh`（fixture 文件存在性校验 + 定向回归）。
  - 更新 `scripts/ci-tests.sh`：在 `full` 档位接入 baseline fixture smoke。
  - 更新文档：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
    - `testing-manual.md`
- 测试：
  - `bash -n scripts/llm-baseline-fixture-smoke.sh`
  - `bash -n scripts/ci-tests.sh`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full simulator::tests::persist::kernel_loads_tracked_llm_baseline_fixture_state -- --nocapture`
  - `./scripts/llm-baseline-fixture-smoke.sh`
- 遗留事项：
  - 若后续希望覆盖“基线加载后继续治理动作”的端到端链路，需要在无在线 LLM 依赖前提下新增可离线驱动的 demo smoke（当前 CI smoke 聚焦状态可加载与结构完整性）。

- 时刻：2026-02-21 18:55:20 CST
- 完成内容：完成“基线加载后离线治理续跑 smoke”任务。
  - `world_llm_agent_demo` 新增 `test_tier_full` 定向回归：
    - `runtime_bridge_continues_governance_from_tracked_baseline_fixture`
    - 基于 `fixtures/llm_baseline/state_01` 加载 baseline，并通过 runtime gameplay bridge 离线执行提案/投票/元进度/经济合约动作链。
  - 更新 `scripts/llm-baseline-fixture-smoke.sh`，在结构加载校验后追加治理续跑 smoke。
  - 文档回写：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
    - `testing-manual.md`
- 测试：
  - `bash -n scripts/llm-baseline-fixture-smoke.sh`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo --features test_tier_full runtime_bridge_continues_governance_from_tracked_baseline_fixture -- --nocapture`
  - `./scripts/llm-baseline-fixture-smoke.sh`
- 遗留事项：
  - 当前离线 smoke 聚焦“桥接动作可执行”；若后续需要“玩法结果指标（proposal passed、合约结算状态）”门禁，可再增加 report 断言层。

- 时刻：2026-02-21 19:04:35 CST
- 完成内容：完成“基线续跑结果断言强化”任务（T12）。
  - `world_llm_agent_demo` 的 `runtime_bridge_continues_governance_from_tracked_baseline_fixture` 从“动作成功断言”升级为“状态结果断言”。
  - 新增断言覆盖：
    - 治理提案/投票状态：`governance_proposals`、`governance_votes`、`votes_by_agent`；
    - 元进度状态：`meta_progress` 的 `total_points`/`track_points` 增量与成就写入；
    - 经济合约状态：`economic_contracts` 的 `status/settlement_success/transfer_amount/tax_amount/notes/accepted_at/settled_at`。
  - 为避免非测试构建告警，`RuntimeGameplayBridge::state()` 访问器改为 `#[cfg(test)]`。
  - 文档回写：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
    - `testing-manual.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo --features test_tier_full runtime_bridge_continues_governance_from_tracked_baseline_fixture -- --nocapture`
  - `./scripts/llm-baseline-fixture-smoke.sh`
- 遗留事项：
  - 无；当前 full-tier baseline smoke 已同时覆盖“可执行性 + 关键状态结果”两层门禁。

- 时刻：2026-02-21 19:16:46 CST
- 完成内容：完成“runtime 预设世界事件 fixture profile”任务（T13）。
  - `world_llm_agent_demo` 新增 `--runtime-gameplay-preset <none|civic_hotspot_v1>`；
    - 在 runtime bridge 内实现 `civic_hotspot_v1` 预设注入：
      - 待投票治理提案：`preset.governance.civic_hotspot_v1`
      - 活跃危机：`crisis.auto.8`
      - 已接受待结算合约：`preset.contract.civic_hotspot_v1`
  - 新增 full-tier 定向回归：
    - `runtime_bridge_civic_hotspot_preset_seeds_followup_handles`
  - 更新 `scripts/llm-baseline-fixture-smoke.sh`，将 preset smoke 纳入 full-tier baseline 回归。
  - 更新 `scripts/llm-longrun-stress.sh`：
    - 新增 `--runtime-gameplay-preset` 参数透传与校验（`none|civic_hotspot_v1`）；
    - `civic_operator` / `resilience_drill` prompt pack 默认启用 `civic_hotspot_v1`；
    - summary 增加 `runtime_gameplay_preset` 字段。
  - 文档回写：
    - `doc/game/gameplay-release-gap-closure-2026-02-21.md`
    - `doc/game/gameplay-release-gap-closure-2026-02-21.project.md`
    - `testing-manual.md`
- 测试：
  - `bash -n scripts/llm-longrun-stress.sh`
  - `bash -n scripts/llm-baseline-fixture-smoke.sh`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo parse_options_accepts_runtime_gameplay_preset -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo parse_options_rejects_runtime_gameplay_preset_when_bridge_disabled -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo --features test_tier_full runtime_bridge_civic_hotspot_preset_seeds_followup_handles -- --nocapture`
  - `./scripts/llm-baseline-fixture-smoke.sh`
- 遗留事项：
  - 可继续扩展更多 preset profile（如 war_pressure_v1 / contract_gridlock_v1）覆盖更复杂社会治理场景。

- 时刻：2026-02-21 19:24:04 CST
- 完成内容：完成“LLM 跳过 tick 占比指标”单任务收口（设计/实现/验证）。
  - 新增设计与项目文档：
    - `doc/testing/llm-skip-tick-ratio-metric.md`
    - `doc/testing/llm-skip-tick-ratio-metric.project.md`
  - `world_llm_agent_demo` 新增指标：
    - `trace_counts.llm_skipped_ticks`
    - `trace_counts.llm_skipped_tick_ratio_ppm`（分母为 `active_ticks`）
    - 同步 stdout 输出 `llm_skipped_ticks` 与 `llm_skipped_tick_ratio_ppm`。
  - `scripts/llm-longrun-stress.sh` 完成新指标接入：
    - jq/python/log 三路径取数；
    - 单场景 summary 输出；
    - 多场景 TSV、聚合 summary、聚合 JSON 输出与汇总。
  - 补充单测：`observe_trace_counts_llm_skipped_tick_ratio`，验证 skip 计数与占比计算。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo -- --nocapture`
  - `bash -n scripts/llm-longrun-stress.sh`
- 遗留事项：
  - 无。

- 时刻：2026-02-21 20:03:28 CST
- 完成内容：完成“viewer-release-qa-loop VRQ-6 收口 + 语义 tick 硬门禁”任务。
  - zoom 无效链路定位与修复：确认 `runSteps("zoom=...")` 生效后被 `sync_camera_mode` 在同模式重复写入时覆盖重置；在 `crates/agent_world_viewer/src/camera_controls.rs` 增加“投影已匹配当前模式则直接返回”的保护，避免同态 mode 事件重置 orbit/projection。
  - 新增回归测试：`sync_camera_mode_ignores_redundant_three_d_assignment`，锁定“重复 `mode=3d` 不应重置已缩放半径”。
  - 语义 gate 强化：`scripts/viewer-release-qa-loop.sh` 引入 `waitForTickAdvance`，将“tick 不回退”升级为“tick 必须前进”；并保留 `play` 优先，必要时以 `seek(+1)` 兜底仍要求 tick 前进。
  - zoom 视觉门禁收敛：签名采样改为 3D 主视区（排除右侧静态面板）并按实测校准阈值，结合相机半径硬条件避免假通过。
  - QA 启动链路修正：默认非 `--with-consensus-gate` 场景追加 `--no-node`，避免共识桥接链路掩盖 viewer 语义回归；最终报告全 PASS：`output/playwright/viewer/release-qa-summary-20260221-200155.md`。
  - 额外验证测试：新增 `live_world_llm_bootstrap_script_mode_advances_tick`，确认 `llm_bootstrap + Script` 在无共识桥接时可推进 tick。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world live_world_`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world live_world_llm_bootstrap_script_mode_advances_tick`
  - `bash -n scripts/viewer-release-qa-loop.sh`
  - `./scripts/viewer-release-qa-loop.sh --skip-visual-baseline`
- 遗留事项：
  - 可后续补一条 `--with-consensus-gate` 独立验收档位，作为分布式共识链路专项门禁，不与默认 viewer 发行 QA 混跑。

- 时刻：2026-02-21 21:09:50 CST
- 完成内容：完成“Viewer 发行全覆盖验收 Gate（可用性 + 视觉 + 玩法环节）”收口。
  - 新建设计/项目文档：
    - `doc/world-simulator/viewer-release-full-coverage-gate.md`
    - `doc/world-simulator/viewer-release-full-coverage-gate.project.md`
  - 新增脚本：`scripts/viewer-release-full-coverage.sh`
    - 一键串联 Web 可用性门禁（`viewer-release-qa-loop.sh`）、主题资产门禁（`validate-viewer-theme-pack.py` + `viewer-theme-pack-preview.sh` + `viewer-texture-inspector.sh`）、玩法环节门禁（工业链 `llm-longrun-stress.sh` + 治理/危机/经济确定性门禁 `llm-baseline-fixture-smoke.sh`）。
    - 新增 `--quick` 与 `--skip-*` 组合，支持本地冒烟与分段排障。
    - 输出统一报告：`release-full-summary-<timestamp>.md`。
  - 扩展 `scripts/viewer-theme-pack-preview.sh`：新增 `--theme-pack <industrial_v2|industrial_v1>`，并将默认主题包切到 `industrial_v2`。
  - 更新文档口径：
    - `testing-manual.md` S6 新增“全覆盖发行验收”入口。
    - `doc/viewer-manual.md` 增补 `viewer-theme-pack-preview.sh` 的 `--theme-pack` 参数说明。
- 测试：
  - `bash -n scripts/viewer-theme-pack-preview.sh scripts/viewer-release-full-coverage.sh scripts/viewer-texture-inspector.sh`
  - `./scripts/viewer-theme-pack-preview.sh --help`
  - `./scripts/viewer-release-full-coverage.sh --help`
  - `./scripts/viewer-release-full-coverage.sh --quick --skip-web-qa --skip-gameplay --no-prewarm --out-dir .tmp/release_full_visual_quick`
  - `./scripts/viewer-release-full-coverage.sh --quick --skip-web-qa --skip-theme-preview --skip-texture-inspector --out-dir .tmp/release_full_gameplay_quick2`
  - `./scripts/viewer-release-full-coverage.sh --quick --no-prewarm --out-dir .tmp/release_full_quick_all`
- 遗留事项：
  - 全覆盖脚本当前将治理/危机/经济链路依赖于 `fixtures/llm_baseline/state_01` 的确定性 smoke；若后续要评估“在线 LLM 实时对局表现”，需额外补一条长稳在线档位（可作为非阻塞扩展项）。

- 时刻：2026-02-21 22:55:20 CST
- 完成内容：完成“Viewer 视觉门禁假阳性修复（P0-1/P0-2）”任务收口。
  - `scripts/capture-viewer-frame.sh`：新增 live 服务端口就绪等待（先等 `--addr` 对应端口可连接再启动 viewer），降低默认首帧断连竞态；新增 `capture_status.txt` 产物路径输出。
  - `crates/agent_world_viewer/src/internal_capture.rs`：新增 `AGENT_WORLD_VIEWER_CAPTURE_STATUS_PATH`，在捕获流程中持续落盘连接状态（`connection_status/last_error/snapshot_ready` 等），并补充单测。
  - `scripts/viewer-theme-pack-preview.sh`：每次抓帧后强制校验 `capture_status.txt`（必须 `connected + snapshot_ready=1`），否则直接失败；产物目录新增 `capture_status.txt` 并写入 `meta.txt`。
  - `scripts/viewer-texture-inspector.sh`：同上，新增 connected 硬门禁与状态产物留存。
  - `scripts/viewer-release-full-coverage.sh`：主题/纹理 gate 从“仅 `viewer.png` 数量”升级为“截图数量 + capture_status 覆盖数 + connected 覆盖数”联合门禁，避免截图假通过。
  - 文档回写：
    - `doc/world-simulator/viewer-release-full-coverage-gate.md`
    - `doc/world-simulator/viewer-release-full-coverage-gate.project.md`
    - `testing-manual.md`
    - `doc/viewer-manual.md`
- 测试：
  - `bash -n scripts/capture-viewer-frame.sh scripts/viewer-theme-pack-preview.sh scripts/viewer-texture-inspector.sh scripts/viewer-release-full-coverage.sh`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer internal_capture::tests:: -- --nocapture`
  - `./scripts/viewer-release-full-coverage.sh --quick --skip-web-qa --skip-gameplay --out-dir .tmp/release_full_visual_quick_p0_fix`
  - `./scripts/viewer-release-full-coverage.sh --quick --no-prewarm --out-dir .tmp/release_full_quick_all_p0_fix`
- 遗留事项：
  - `--quick` 全链路存在工业动作覆盖随机性（本次第二轮 quick 因 `schedule_recipe` 缺失导致 `Gameplay industrial gate` fail），与本任务改动无关；可按发布口径继续使用 full 档或固定 seed/prompt 做稳定化。
- 时刻：2026-02-21 20:27:24 CST
- 完成内容：完成“llm-longrun-stress release gate 三档稳定化（T14）”收口。
  - `world_llm_agent_demo` 新增 `--coverage-bootstrap-profile`（`none|industrial|gameplay|hybrid`），在 LLM loop 前注入 deterministic 覆盖动作链，并将 bootstrap 动作计入 action kind 统计。
  - `scripts/llm-longrun-stress.sh` 接入 `--coverage-bootstrap-profile` 透传；在 `--release-gate` 下默认与 `--release-gate-profile` 对齐；当未显式指定 `--max-parse-errors` 时，启用 `max(2, ceil(ticks/40))` 自适应阈值。
  - 更新文档：`doc/game/gameplay-release-gap-closure-2026-02-21.project.md` 新增 T14；`testing-manual.md` S8 同步 release-gate + bootstrap + parse 阈值口径。
  - 120 tick 三档 gate 回归结果：
    - `industrial`：`coverage_bootstrap_profile=industrial`，`action_kinds_total=5`，`parse_errors=2`，`pressure run passed`。
    - `gameplay`：`coverage_bootstrap_profile=gameplay`，`action_kinds_total=7`（含 4 个必选治理动作），`parse_errors=1`，`pressure run passed`。
    - `hybrid`：`coverage_bootstrap_profile=hybrid`，`action_kinds_total=9`，`parse_errors=0`，`pressure run passed`。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo -- --nocapture`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 120 --release-gate --release-gate-profile industrial --out-dir .tmp/llm_gate_stable_industrial --no-llm-io`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 120 --release-gate --release-gate-profile gameplay --out-dir .tmp/llm_gate_stable_gameplay --no-llm-io`
  - `./scripts/llm-longrun-stress.sh --scenario llm_bootstrap --ticks 120 --release-gate --release-gate-profile hybrid --out-dir .tmp/llm_gate_stable_hybrid --no-llm-io`
- 遗留事项：
  - 当前三档 gate 已稳定通过；后续若切到“纯 LLM 自发触发覆盖”评估，请显式使用 `--coverage-bootstrap-profile none` 并提高 ticks 复验。

- 时刻：2026-02-21 20:44:45 CST
- 完成内容：完成“Non-Viewer 发行准备加固（测试覆盖 + Agent/PublicKey 绑定）”T0 建档。
  - 新建设计文档：`doc/nonviewer-release-readiness-hardening.md`。
  - 新建项目管理文档：`doc/nonviewer-release-readiness-hardening.project.md`。
  - 项目状态初始化：T0 完成，T1 进行中，T2/T3 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --lib`
- 遗留事项：
  - 执行 T1：补齐 non-viewer 默认门禁覆盖并更新测试手册口径。

- 时刻：2026-02-21 20:53:02 CST
- 完成内容：完成“Non-Viewer 发行准备加固”T1（测试覆盖补齐）。
  - 更新 `scripts/ci-tests.sh`：明确 `required/full` 分层口径；`required` 保持快速核心门禁，`full` 追加 `agent_world_node`、`agent_world_net`（含 `libp2p`）等重链路测试。
  - 更新 `testing-manual.md`：同步 CI 覆盖事实口径与 S1/S2 套件说明，明确 `required` 与 `full` 的增量边界。
  - 完成一轮 `required` 回归验证，确认门禁通过。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 执行 T2：实现 Agent 与 `public_key` 绑定，并补齐协议/回放/live 链路测试。
