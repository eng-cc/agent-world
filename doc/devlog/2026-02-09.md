- 日期：2026-02-09
- 完成内容：补齐 `agent_world_viewer` 对 `AgentDecisionTrace` 新增字段 `llm_effect_intents`、`llm_effect_receipts` 的测试构造兼容（`diagnosis.rs`、`timeline_controls.rs`、`tests.rs`、`tests_selection_details.rs`）。
- 完成内容：更新 `selection_linking.rs` 对新增事件 `LlmEffectQueued`/`LlmReceiptAppended` 的目标映射与 Agent 匹配分支，恢复枚举匹配穷尽性并保持选择联动可用。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test`（通过，全仓测试通过，含 `agent_world_viewer` 84 tests）。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：新增《Viewer 文本可选中与复制能力设计》与项目管理文档（`doc/world-simulator/viewer-copyable-text.md`、`doc/world-simulator/viewer-copyable-text.project.md`）。
- 完成内容：`agent_world_viewer` 接入 `bevy_egui`，新增 `copyable_text.rs` 复制面板，聚合状态/选择/摘要/活动/详情/事件/诊断/联动/时间轴/覆盖层文本为可选中内容。
- 完成内容：Top Controls 新增“隐藏/显示复制窗”按钮，支持中英文文案切换并联动 `CopyableTextPanelState`。
- 完成内容：补充测试（`i18n.rs`、`panel_layout.rs`、`copyable_text.rs`），覆盖文案本地化与按钮开关行为。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，88 tests）。
- 遗留事项：可按需补充“复制内容分类筛选”与“一键复制当前分组”交互。
- 日期：2026-02-09
- 完成内容：按 UI 截图闭环流程复现并定位 `bevy_egui` 中文显示方块字问题（Bevy UI 正常、EGUI 异常）。
- 完成内容：在 `copyable_text.rs` 为 EGUI 注入 `ms-yahei.ttf`（`FontDefinitions` + `Proportional/Monospace` family），并将初始化改为一次性本地状态。
- 完成内容：去除复制面板文本 `monospace()` 强制样式，避免退回英文默认 monospace 字体导致 CJK 缺字。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5024 --tick-ms 300 --viewer-wait 8`，确认 EGUI 中文可读。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行定向测试（`copyable_text::tests::install_cjk_font_registers_font_and_priority`、`panel_layout::tests::copyable_panel_toggle_button_flips_state_and_label`、`i18n::tests::copyable_toggle_label_is_localized`，通过）。
- 遗留事项：可继续评估为 EGUI 单独保留 CJK monospace 字体（若后续需要严格等宽对齐展示）。
- 日期：2026-02-09
- 完成内容：补充复制面板中文标题纯逻辑测试 `copyable_text::tests::copy_panel_title_is_localized`，覆盖 `ZhCn/EnUs` 标题映射。
- 完成内容：小幅重构复制面板文案函数（`copy_panel_title` / `copy_panel_hint`）以支持可测试化并保持行为不变。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer copyable_text::tests::copy_panel_title_is_localized -- --exact`（通过）。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：新增《Viewer 右侧 2D UI 迁移到 bevy_egui（SidePanel）设计》与项目管理文档（`doc/world-simulator/viewer-egui-right-panel.md`、`doc/world-simulator/viewer-egui-right-panel.project.md`）。
- 完成内容：完成 ER3~ER8 的迁移任务拆解与依赖识别，为后续分步实施提供基线。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer copyable_text::tests::copy_panel_title_is_localized -- --exact`（通过）。
- 遗留事项：进入 ER3，落地 EGUI SidePanel 骨架并开始替换旧 Bevy UI 入口。
- 日期：2026-02-09
- 完成内容：落地 `bevy_egui::SidePanel::right` 右侧面板（`egui_right_panel.rs`），将顶部控制、状态/选择、覆盖层、诊断、事件联动、时间轴、可复制文本分组整合到 EGUI 面板。
- 完成内容：新增 `RightPanelWidthState` 运行时宽度同步，`update_3d_viewport`、`orbit_camera_controls`、`pick_3d_selection` 改为读取 EGUI 实际面板宽度，保持 3D 交互边界一致。
- 完成内容：抽取并复用联动/时间轴/事件点击 action（`selection_linking.rs`、`timeline_controls.rs`、`event_click_list.rs`），避免 UI 迁移时业务逻辑重复。
- 完成内容：在 `copyable_text.rs` 暴露 EGUI CJK 字体初始化方法，并在右侧面板初始化 `ms-yahei.ttf`，确认中文文本显示正常。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，90 tests）。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5025 --tick-ms 300 --viewer-wait 8`，确认右侧 EGUI panel 与中文渲染正常。
- 遗留事项：继续执行 ER6，清理旧 Bevy 2D 右侧面板相关系统注册与无用代码，收敛 dead_code 警告。
- 日期：2026-02-09
- 完成内容：执行 ER6 清理，移除旧 Bevy 右侧 UI 遗留代码路径（不再使用的按钮视觉/标签更新链路、复制浮窗渲染函数、旧滚动处理实现）。
- 完成内容：`button_feedback.rs` 收敛为 Step 加载状态核心逻辑；`copyable_text.rs` 收敛为 EGUI 右侧面板复用文案与字体初始化能力。
- 完成内容：`timeline_controls.rs` 与 `world_overlay.rs` 清理未使用字段/更新函数，`panel_layout.rs`、`panel_scroll.rs` 将仅用于单测的处理函数迁移到 `#[cfg(test)]`，消除主构建 dead_code/unused 警告。
- 完成内容：`main.rs` 移除旧 `control_labels` 引用与旧 UI 相关附着；`control_labels.rs` 已不再被编译路径使用（保留文件待后续可写策略允许时删除）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过，0 warnings）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，87 tests）。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --addr 127.0.0.1:5026 --tick-ms 300 --viewer-wait 8`，确认右侧 EGUI panel 正常。
- 遗留事项：`crates/agent_world_viewer/src/control_labels.rs` 文件体仍在仓库但已脱离编译路径，待允许删除文件时可清理。
- 日期：2026-02-09
- 完成内容：按迁移收尾要求物理删除遗留文件 `crates/agent_world_viewer/src/control_labels.rs`，避免仓库保留无用模块。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，87 tests）。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：新增《Viewer 可视化观察体验优化设计》与项目管理文档（`doc/world-simulator/viewer-observability-visual-optimization.md`、`doc/world-simulator/viewer-observability-visual-optimization.project.md`）。
- 完成内容：明确本轮优化方向为“观察导向”，不新增一键复制，优先提升面板直观总览能力与脚本场景预校验能力。
- 遗留事项：进入 VO3/VO4，实施脚本预校验与右侧面板布局优化。
- 日期：2026-02-09
- 完成内容：实施 P1：`scripts/capture-viewer-frame.sh` 新增场景白名单、别名映射（`triad`/`twin` 等）与参数预校验，非法场景可提前报错并给出可用列表。
- 完成内容：实施 P3（观察导向）：右侧面板增加总览指标（tick/事件数/轨迹数/观察模式），诊断/联动/时间轴默认直出；详情区文案从“复制”改为“观察/对比”，不新增一键复制。
- 完成内容：右侧面板默认宽度改为自适应（按窗口宽度比例并做上下限夹取），改善不同分辨率下的可视平衡。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，88 tests）。
- 完成内容：执行脚本验证：
  - 非法场景 `triad_bad` 返回校验错误（符合预期）；
  - 别名场景 `triad` 自动映射为 `triad_region_bootstrap` 并成功抓图。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：右侧总览新增颜色状态灯（连接/健康/观察模式），实现一眼判读当前系统状态。
- 完成内容：健康灯按 `ActionRejected` 事件数量分级（正常/告警/高风险），并补充对应单测。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`、`cargo check -p agent_world_viewer`、`cargo test -p agent_world_viewer`（通过，90 tests）。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario triad --addr 127.0.0.1:5036 --tick-ms 300 --viewer-wait 10`，验证状态灯显示正常。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：按“边改边看”闭环定位并修复 3D 半屏空白问题，移除 `update_3d_viewport` 对相机 viewport 的硬裁剪，改为全窗口渲染以避免右侧大面积未渲染区域。
- 完成内容：右侧 EGUI 面板宽度策略收敛（默认/最小/最大与比例同步下调），并对事件行与提示文案做截断/换行处理，避免长文本将面板挤到过宽。
- 完成内容：执行 `./scripts/capture-viewer-frame.sh --scenario triad --addr 127.0.0.1:5039 --tick-ms 300 --viewer-wait 10`、`--addr 127.0.0.1:5041`、`--addr 127.0.0.1:5042` 连续对比，确认 3D 区域占比提升（最终约 65% / 35%）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`、`env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，90 tests）、`env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 遗留事项：可继续将“状态明细”拆成固定高优先摘要 + 可折叠低频明细，进一步降低右侧纵向拥挤。
- 日期：2026-02-09
- 完成内容：为 `agent_world_viewer` 引入 `egui_kittest`（`crates/agent_world_viewer/Cargo.toml`），建立 EGUI 可交互 UI 测试基础套件。
- 完成内容：在 `egui_right_panel.rs` 新增 UI 套件用例，覆盖总览状态灯渲染（连接/健康/观察模式）、告警与手动观察态、时间轴过滤按钮点击后状态切换。
- 完成内容：保留并扩展现有纯逻辑断言（状态信号颜色、中文多字节截断、事件行预览长度上限），形成“逻辑 + UI 交互”双层回归。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`、`env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，99 tests）。
- 遗留事项：后续可补 `egui_kittest` snapshot 测试（按需启用 `wgpu`/`snapshot` features）做视觉回归。
- 日期：2026-02-09
- 完成内容：针对 `egui_kittest` 视觉回归引入时的版本冲突进行正向修复：保留 `egui_kittest 0.33.3`，仅启用 `snapshot`，并在测试侧引入本地 `egui-wgpu` renderer，避免启用 `wgpu` feature 时对 `eframe 0.33.3` 的硬依赖冲突。
- 完成内容：在 `egui_right_panel.rs` 新增 snapshot 回归测试（`viewer_overview_live`、`viewer_overview_manual_high_risk`），并落库基线图到 `crates/agent_world_viewer/tests/snapshots/`。
- 完成内容：为 snapshot 产物补 `.gitignore` 规则（忽略 `*.diff.png`、`*.new.png`），保留基线 `*.png`。
- 完成内容：执行 `UPDATE_SNAPSHOTS=true env -u RUSTC_WRAPPER cargo test -p agent_world_viewer egui_kittest_snapshot` 生成基线并通过；执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，101 tests）。
- 遗留事项：后续可按模块补更多 snapshot 场景（时间轴过滤开关组合、诊断错误态、中英文双语视图）。
- 日期：2026-02-09
- 完成内容：诊断并复现 `world_viewer_live --llm` 下 `agent-0` LLM 请求失败，确认根因为 `AGENT_WORLD_LLM_TIMEOUT_MS=8000` 导致请求在约 8s 超时并降级为 `Wait`。
- 完成内容：在 `OpenAiChatCompletionClient` 中实现端点规范化（兼容 `BASE_URL` 已包含 `/chat/completions` 的配置）与超时回退重试（首个超时后自动以 `30000ms` 重试一次）。
- 完成内容：补充单测：端点拼接兼容、低超时时启用重试、重试可恢复短超时请求。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`、`env -u RUSTC_WRAPPER cargo check -p agent_world`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent::tests`（通过，18 tests）。
- 完成内容：联调验证 `world_viewer_live --llm` 首 tick 可获得有效 LLM 决策（`llm_error=null`，不再误降级）。
- 遗留事项：若外部模型服务稳定耗时长期 >30s，仍建议按模型 SLA 调整 `AGENT_WORLD_LLM_TIMEOUT_MS`。
- 日期：2026-02-09
- 完成内容：使用 `./scripts/capture-viewer-frame.sh --scenario llm_bootstrap --llm --addr 127.0.0.1:5093 --tick-ms 300 --viewer-wait 25` 完成 UI 截图闭环验证（server/viewer 启动、截图落盘、日志留存）。
- 完成内容：通过 viewer 协议联调验证 LLM 决策链路：首个 `decision_trace` 中 `llm_error=null`、`parse_error=null`，并产出有效决策 `harvest_radiation`。
- 完成内容：闭环产物已写入 `.tmp/screens/`，协议联调日志位于 `.tmp/llm_loop_client.log`、`.tmp/llm_loop_server.log`。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：执行 live 控制链路“向前一步 + 向后一步”模拟（`step count=1` 后 `seek tick=0`），验证时间轴可回退到初始快照。
- 完成内容：回退后快照时间恢复为 `time=0`，`journal_len=0`，metrics 同步恢复到初始值。
- 完成内容：本次联调日志输出到 `.tmp/backstep_client.log`、`.tmp/backstep_server.log`。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：按“仅前进一步”要求执行 `step count=1`（未回退），验证 `llm_bootstrap --llm` 单轮中 LLM 连通生效。
- 完成内容：`decision_trace` 显示 `llm_output` 为有效 JSON，且 `llm_error=null`、`parse_error=null`；同轮产生 `RadiationHarvested` 事件并推进到 `snapshot time=1`。
- 完成内容：验证日志位于 `.tmp/step1_verify_client.log`、`.tmp/step1_verify_server.log`。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：新增《Viewer 双视角（2D/3D）切换设计》与项目管理文档（`doc/world-simulator/viewer-dual-view-2d-3d.md`、`doc/world-simulator/viewer-dual-view-2d-3d.project.md`）。
- 完成内容：在 `agent_world_viewer` 引入 `ViewerCameraMode`（默认 `TwoD`），启动即采用俯视 2D 全局视角，并支持运行时切换回 3D 透视视角。
- 完成内容：右侧 EGUI 顶部控制区新增视角切换按钮（`2D` / `3D`）及中英文字段（`视角` / `View`），切换后同步更新相机轨道预设与投影类型（Orthographic / Perspective）。
- 完成内容：将 Agent 材质主色改为更鲜艳配色（橙红），提升场景中目标可见性。
- 完成内容：补充测试：`camera_controls` 视角模式行为与投影断言、`i18n` 视角文案断言、`egui_kittest` 视角按钮切换状态断言、`main` 默认模式断言。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，107 tests）。
- 遗留事项：可按需补充 2D/3D 双视角截图基线（snapshot/脚本）用于视觉回归。
- 日期：2026-02-09
- 完成内容：按反馈修复默认 2D 画面“整体灰蓝”问题，重算 Orthographic `scale`（由过大常量改为按世界跨度与参考 viewport 推导），并将 2D `near` 调整为正值，恢复全局网格可读性。
- 完成内容：在 2D 模式隐藏 `world:floor` 与 `world:bounds` 背景面（保留网格与对象），去除蓝/黑底色干扰；3D 模式继续显示背景面。
- 完成内容：新增 `WorldFloorSurface` / `WorldBoundsSurface` 组件与 `sync_world_background_visibility` 系统，并补充定向测试 `world_background_visibility_follows_camera_mode`。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer camera_controls::tests::world_background_visibility_follows_camera_mode -- --exact`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario triad --addr 127.0.0.1:5060 --tick-ms 300 --viewer-wait 12`，确认 2D 底色已去除。
- 遗留事项：可按需继续把 2D 网格线亮度再降低一级，突出 Agent 点位。
- 日期：2026-02-09
- 完成内容：按反馈将 3D 视角也同步移除 `world:floor` / `world:bounds` 背景面，统一两种视角均不显示蓝黑底色。
- 完成内容：将背景显隐逻辑收敛为“始终隐藏背景面”，并更新对应测试为 `world_background_surfaces_are_always_hidden`。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer camera_controls::tests::world_background_surfaces_are_always_hidden -- --exact`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario triad --addr 127.0.0.1:5061 --tick-ms 300 --viewer-wait 12`，确认底色在当前视角下已移除。
- 遗留事项：可继续按需降低网格对比度或改为更浅灰细线，以进一步凸显 Agent。
- 日期：2026-02-09
- 完成内容：新增《LLM Prompt 组装重构与多步决策机制》设计文档，补充 Prompt 分段组装、预算裁剪、多步状态机（plan/module_call/decision_draft/final_decision）与 repair 策略（`doc/world-simulator/llm-prompt-multi-step-orchestration.md`）。
- 完成内容：新增对应项目管理文档，拆解 LMSO1~LMSO10 任务并明确下一步进入 Prompt 组装抽象改造（`doc/world-simulator/llm-prompt-multi-step-orchestration.project.md`）。
- 完成内容：在总项目管理文档补充该 LLM 任务线文档入口，保持 world-simulator 主文档索引一致（`doc/world-simulator.project.md`）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_system_prompt_contains_configured_goals`（通过，1 passed）。
- 遗留事项：按 LMSO3 开始实现 Prompt 组装层代码与测试。
- 日期：2026-02-09
- 完成内容：补充《LLM Prompt 组装重构与多步决策机制》中的“上下文长度与记忆平衡”专项设计，新增预算模型、记忆打分与分阶段注入策略、裁剪顺序与降级策略、可观测指标与验收基线（`doc/world-simulator/llm-prompt-multi-step-orchestration.md`）。
- 完成内容：同步更新项目管理文档，新增 LMSO2A 并细化 LMSO4A/LMSO4B（PromptBudget 与 MemorySelector）实现任务，明确后续编码入口（`doc/world-simulator/llm-prompt-multi-step-orchestration.project.md`）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_system_prompt_contains_configured_goals`（通过，1 passed）。
- 遗留事项：进入 LMSO3/LMSO4A，优先落地 PromptBudget 与记忆候选打分/去重实现。
- 日期：2026-02-09
- 完成内容：完成 LMSO3，新增 `llm_agent/prompt_assembly.rs`，落地 `PromptAssemblyInput/PromptSection/PromptAssemblyOutput` 与 `PromptAssembler`，将原硬编码 prompt 拼接迁移为结构化 section 组装。
- 完成内容：`LlmAgentBehavior` 接入 PromptAssembler，`system_prompt/user_prompt` 改为通过组装层生成，并补充 step context 与 memory digest 注入入口。
- 完成内容：补充单测：`llm_agent_user_prompt_contains_step_context_metadata`、`llm_agent_user_prompt_contains_memory_digest_section`，并保持原有目标拼接测试通过。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_user_prompt_contains_step_context_metadata`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_user_prompt_contains_memory_digest_section`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_system_prompt_contains_configured_goals`（通过）。
- 遗留事项：进入 LMSO4A，实现 PromptBudget 估算器与 section 级裁剪。
- 日期：2026-02-09
- 完成内容：完成 LMSO4A，在 `prompt_assembly.rs` 新增 `PromptBudget`（`context_window_tokens/reserved_output_tokens/safety_margin_tokens`）与 `effective_input_budget_tokens` 估算逻辑。
- 完成内容：在 Prompt 组装阶段接入预算生效：优先截断历史/记忆 section，并按低优先级顺序移除 `step_meta -> memory -> history`，最后在必要时截断 context，确保协议段保留。
- 完成内容：扩展 section trace 指标（`estimated_tokens/emitted_tokens/included`），便于后续观测预算命中与裁剪行为。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world prompt_assembly::tests`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_user_prompt_contains`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_system_prompt_contains_configured_goals`（通过）。
- 遗留事项：进入 LMSO4B，实现 MemorySelector（候选打分、去重、Top-K 打包）。
- 日期：2026-02-09
- 完成内容：完成 LMSO4B，在 `crates/agent_world/src/simulator/llm_agent/memory_selector.rs` 新增 `MemorySelector` 与 `MemorySelectorConfig`，实现短/长期记忆候选打分、去重与 Top-K 选择。
- 完成内容：`LlmAgentBehavior::user_prompt` 接入 MemorySelector 产出的记忆摘要，替换原始粗粒度 `context_summary` 注入，增强上下文长度与记忆质量平衡。
- 完成内容：补充单测覆盖 `top_k` 上限、重复内容去重、失败动作加权优先级，确保记忆筛选稳定可回归。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world memory_selector::tests`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_user_prompt_contains_memory_digest_section -- --exact`（通过）。
- 遗留事项：进入 LMSO5，补齐多步机制与 Prompt 预算/记忆筛选的配置化入口。
- 日期：2026-02-09
- 完成内容：完成 LMSO5，扩展 `LlmAgentConfig` 与配置读取，新增 `AGENT_WORLD_LLM_MAX_DECISION_STEPS`、`AGENT_WORLD_LLM_MAX_REPAIR_ROUNDS`、`AGENT_WORLD_LLM_PROMPT_MAX_HISTORY_ITEMS`、`AGENT_WORLD_LLM_PROMPT_PROFILE`，并引入 `compact/balanced` PromptProfile 映射预算与记忆筛选策略。
- 完成内容：Prompt 组装接线改造为按配置裁剪历史（`prompt_max_history_items`）并按 profile 选择 PromptBudget 与 MemorySelector 参数。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_config_`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_user_prompt_`（通过）。
- 遗留事项：进入 LMSO6，多步状态机主流程落地。
- 日期：2026-02-09
- 完成内容：完成 LMSO6，在 `LlmAgentBehavior::decide` 中落地阶段化状态机（`plan -> module_call* -> decision_draft -> final_decision`），并兼容直接输出最终 `decision` 的旧路径。
- 完成内容：新增 `plan/decision_draft` 解析分支，支持在阶段间切换与草案回退。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_supports_plan_module_draft_finalize_flow`（通过）。
- 遗留事项：进入 LMSO7，补齐 repair 分支与重试计数。
- 日期：2026-02-09
- 完成内容：完成 LMSO7，新增解析失败 repair 轮次控制，按 `max_repair_rounds` 自动追加修复提示重试，超限后降级并保留解析错误。
- 完成内容：`LlmDecisionDiagnostics.retry_count` 接入真实 repair 次数统计。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_repair_round_can_recover_invalid_output`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_emits_parse_error_in_trace`（通过）。
- 遗留事项：进入 LMSO8，扩展步骤级与 Prompt 段级 trace。
- 日期：2026-02-09
- 完成内容：完成 LMSO8，扩展 `AgentDecisionTrace` 新字段 `llm_step_trace` 与 `llm_prompt_section_trace`，记录每步输入摘要、输出摘要、状态与 section 裁剪命中情况。
- 完成内容：同步修正 viewer 协议回归测试与 runner trace 测试中的结构体构造。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world viewer_response_round_trip_decision_trace`、`env -u RUSTC_WRAPPER cargo test -p agent_world runner_persists_llm_effect_trace_to_kernel_journal`（通过）。
- 遗留事项：进入 LMSO9，补齐多步/repair/配置化相关测试矩阵。
- 日期：2026-02-09
- 完成内容：完成 LMSO9，新增/更新单测覆盖：多步流转、repair 恢复、Prompt 历史裁剪上限、新配置解析与非法 profile 校验，保持旧协议兼容断言通过。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_config_`（通过）。
- 遗留事项：进入 LMSO10，更新 README/config 示例并收口项目文档。
- 日期：2026-02-09
- 完成内容：完成 LMSO10，更新 `config.example.toml` 与 `README.md`，补充多步机制、repair、PromptProfile 与新配置项说明。
- 完成内容：更新项目管理文档状态，勾选 LMSO5~LMSO10 并同步下一步调优方向。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`、`env -u RUSTC_WRAPPER cargo check -p agent_world`（通过）。
- 遗留事项：后续可开展长跑场景压测，进一步调优 profile 预算阈值与 repair 轮次。
- 日期：2026-02-09
- 完成内容：按仓库约束将 `crates/agent_world/src/simulator/llm_agent.rs` 拆分为 `llm_agent/config_helpers.rs` 与 `llm_agent/decision_flow.rs`，将主文件控制在 1200 行以内（当前 1146 行）。
- 完成内容：拆分后执行 `env -u RUSTC_WRAPPER cargo fmt --all`、`env -u RUSTC_WRAPPER cargo check -p agent_world`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_config_`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_`（通过）。
- 遗留事项：无。
- 日期：2026-02-09
- 完成内容：新增压测回归 `llm_agent_long_run_stress_keeps_pipeline_stable`，在 240 tick 下模拟 `plan -> module_call -> decision_draft -> repair -> final_decision` 循环，并持续注入高密度观测与长记忆条目。
- 完成内容：压测断言覆盖：决策链路稳定、repair 每轮命中、Prompt section trace 非空、`llm_input` 长度受预算约束、总调用次数在预期区间内。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_long_run_stress_keeps_pipeline_stable`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_`（通过）。
- 遗留事项：后续可增加真实 `viewer_live --llm` 长跑脚本并将指标落盘用于跨版本对比。
- 日期：2026-02-09
- 完成内容：为 `world_llm_agent_demo` 增加 `--report-json <path>` 输出能力，新增运行汇总结构（决策分布、LLM 错误/解析错误、repair 次数、Prompt 输入长度、步骤统计）并落盘 JSON，便于脚本压测直接消费。
- 完成内容：新增 `scripts/llm-longrun-stress.sh`，支持真实 LLM 长跑压测（运行 demo、落盘 `report.json/run.log/summary.txt`、阈值断言、可配置输出目录与门限）。
- 完成内容：补充 `README.md` 示例，新增 `world_llm_agent_demo --report-json` 与 `scripts/llm-longrun-stress.sh` 的使用说明。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo`（通过，6 tests）。
- 完成内容：执行真实压测冒烟 `./scripts/llm-longrun-stress.sh --ticks 8 --out-dir .tmp/llm_stress_smoke --max-repair-rounds-max 8 --max-llm-errors 20 --max-parse-errors 20 --min-active-ticks 4`（通过）。
- 完成内容：执行真实长跑压测 `./scripts/llm-longrun-stress.sh --ticks 40 --out-dir .tmp/llm_stress_longrun --max-repair-rounds-max 8 --max-llm-errors 5 --max-parse-errors 5 --min-active-ticks 40`（通过；`active_ticks=40`、`llm_errors=0`、`parse_errors=0`、`repair_rounds_max=0`、`llm_input_chars_max=4578`）。
- 遗留事项：后续可增加 profile 对照压测（`compact` vs `balanced`）与更长 tick（例如 120+）的夜间自动基线任务。
- 日期：2026-02-09
- 完成内容：按“真实运行态压测需要可审计 LLM I/O”要求，给 `world_llm_agent_demo` 增加 `--print-llm-io` 开关，在每个 tick 的 trace 中输出 `llm_input` / `llm_output` / `llm_error` / `parse_error` 到 stdout（即压测 `run.log`）。
- 完成内容：更新 `scripts/llm-longrun-stress.sh` 默认开启 `--print-llm-io`，并新增 `--no-llm-io` 用于按需关闭日志噪声。
- 完成内容：更新 `README.md` 示例命令，明确 run.log 默认包含逐 tick LLM 输入输出，便于现场检查 prompt/输出质量。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo`（通过，7 tests）。
- 完成内容：执行 `./scripts/llm-longrun-stress.sh --ticks 3 --out-dir .tmp/llm_stress_io_check --max-llm-errors 5 --max-parse-errors 5 --max-repair-rounds-max 8 --min-active-ticks 3`，并在 `run.log` 中确认存在 `llm_input_begin/llm_output_begin` 区块（通过）。
- 遗留事项：后续可增加 `--llm-io-max-chars` 以限制单轮日志体积。
- 日期：2026-02-09
- 完成内容：完成 LMSO14，新增“反重复门控 + execute_until 持续执行动作”闭环：连续相同行动达到阈值后强制进入再规划路径，避免 LLM 在高压场景中复读。
- 完成内容：新增 `execute_until` 协议与运行态执行控制，支持“执行某动作直到事件发生”并在条件未满足时跳过 LLM 调用持续执行，条件命中后自动退出。
- 完成内容：新增配置 `AGENT_WORLD_LLM_FORCE_REPLAN_AFTER_SAME_ACTION`（`0` 关闭），并同步更新 Prompt 协议说明与反重复/探索导向指引。
- 完成内容：按文件体积约束新增 `llm_agent/behavior_loop.rs`、`llm_agent/execution_controls.rs`，保持核心文件在限制内。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_force_replan_after_repeated_actions`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_execute_until_continues_without_llm_until_event`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_prompt_contains_execute_until_and_exploration_guidance`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_config_reads_multistep_and_prompt_fields_from_env`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_`（通过）。
- 遗留事项：后续可补充 `execute_until` 的日志截断配置与更多 `until.event` 语义（例如库存/能量阈值）。

- 日期：2026-02-09
- 完成内容：完成 LMSO15：`execute_until` 支持多事件停止条件（`until.event_any_of` 与 `until.event` 的 `a|b` / `a,b` 兼容），并在运行态按“任一事件命中即停止”评估。
- 完成内容：增强解析容错：`decision_draft` 支持简写载荷（`decision` 为字符串时复用同层字段），LLM 输出改为提取“首个完整 JSON”以兼容多段输出。
- 完成内容：更新 Prompt 协议文案，明确 `execute_until` 的单事件/多事件写法，降低模型把枚举当字面串的概率。
- 完成内容：补充回归测试 `llm_parse_execute_until_accepts_event_any_of`、`llm_parse_decision_draft_accepts_shorthand_decision_payload`，并将持续执行测试改为覆盖 `new_visible_agent|new_visible_location` 场景。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_prompt_contains_execute_until_and_exploration_guidance`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_parse_execute_until_accepts_event_any_of`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_parse_decision_draft_accepts_shorthand_decision_payload`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_execute_until_continues_without_llm_until_event`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_`（通过）。
- 完成内容：执行真实压测 `./scripts/llm-longrun-stress.sh --ticks 8 --out-dir .tmp/llm_stress_lmso15_postfix --max-repair-rounds-max 8 --max-llm-errors 8 --max-parse-errors 8 --min-active-ticks 8`（通过；`parse_errors=0`，`repair_rounds_max=0`，`run.log` 可见 `event_any_of` 被模型正确采用）。
- 遗留事项：`llm_input_chars_max=14127` 偏高，后续可继续压缩反重复门控阶段的模块循环 Prompt 体积。
- 日期：2026-02-09
- 完成内容：更新可视化设计/项目文档，明确“chunk 可视化与背景网格合并”为统一 chunk lattice，网格按真实 chunk 尺寸（含边缘残块）生成。
- 完成内容：`agent_world_viewer` 将 chunk 可视对象由悬浮 cuboid marker 改为 chunk 边框网格线（每 chunk 4 条），并将背景网格步长对齐到 `CHUNK_SIZE_X_CM/CHUNK_SIZE_Y_CM`。
- 完成内容：`world_overlay` 的 chunk 开关改为控制 chunk 网格线显隐；`rebuild_scene_from_snapshot` 改为按 chunk 网格全量生成（未探索 chunk 也有网格），保留 generated/exhausted 状态染色。
- 完成内容：`selection_linking` 的 chunk 点击命中改为“射线与 chunk 网格平面包围矩形求交”，修复网格化后点距离命中不稳定问题。
- 完成内容：新增测试文件 `tests_scene_grid.rs`，补充背景网格线数量（6x6）与 chunk 网格实体数量（25 chunk / 100 线段）断言；新增 `selection_linking` 射线命中单测。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer`（通过）。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer`（通过，111 tests）。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario triad --addr 127.0.0.1:5110 --tick-ms 300 --viewer-wait 10`，确认网格显示与右侧覆盖层正常。
- 遗留事项：可继续增加 chunk 网格 legend（颜色说明）与视角相关线宽策略（2D/3D 分级）。
- 日期：2026-02-09
- 完成内容：继续实现“观察增强”：右侧覆盖层区新增 chunk 图例（未探索/已生成/已耗尽/背景网格）和线宽提示文案（按 2D/3D 展示 world/chunk 线宽）。
- 完成内容：网格线宽改为视角分级策略，新增 `GridLineKind/GridLineAxis/GridLineVisual`，在 `sync_camera_mode` 中同步刷新 world/chunk 网格线 scale（2D 更细、3D 更粗）。
- 完成内容：补充测试：`camera_controls::tests::grid_line_thickness_uses_mode_and_kind`、`ui_locale_text::tests::overlay_grid_line_width_hint_supports_zh`、`egui_right_panel::tests::egui_kittest_overlay_section_renders_chunk_legend_and_width_hint`。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all`、`cargo check -p agent_world_viewer`、`cargo test -p agent_world_viewer`（通过，114 tests）。
- 完成内容：执行截图闭环 `./scripts/capture-viewer-frame.sh --scenario triad --addr 127.0.0.1:5113 --tick-ms 300 --viewer-wait 10`，确认图例与线宽提示显示正常。
- 遗留事项：可继续补充“图例与 chunk 点击联动高亮”（点击图例项时临时强调对应状态 chunk）。

- 日期：2026-02-09
- 完成内容：完成 LMSO16，`world_llm_agent_demo` 新增 `--llm-io-max-chars <n>`，可对 `--print-llm-io` 输出的 `llm_input/llm_output` 做按字符截断，避免 run.log 在长跑时过大。
- 完成内容：截断输出附带 `...(truncated, total_chars=..., max_chars=...)` 标记，保留可审计性。
- 完成内容：`scripts/llm-longrun-stress.sh` 新增 `--llm-io-max-chars <n>` 并透传到 demo；`summary.txt` 新增 `llm_io_max_chars` 指标。
- 完成内容：更新 README 与设计/项目文档，补充日志体积治理策略与参数说明。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`、`env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_llm_agent_demo`（通过）。
- 完成内容：执行 `./scripts/llm-longrun-stress.sh --ticks 6 --out-dir .tmp/llm_stress_lmso16_trunc --llm-io-max-chars 600 --max-llm-errors 8 --max-parse-errors 8 --max-repair-rounds-max 8 --min-active-ticks 6`，并确认 `run.log` 出现 `(truncated, total_chars=..., max_chars=600)` 与 `summary.txt` 中 `llm_io_max_chars=600`（通过）。
- 遗留事项：后续可将 `llm_io_max_chars` 与 prompt profile 联动（例如 compact profile 默认更小阈值）。

- 日期：2026-02-09
- 完成内容：修复 Viewer 单步按钮在 LLM 调用失败后卡在“Step ... / 执行中”的问题：`StepControlLoadingState` 新增事件/decision trace 基线计数，收到新的事件或 trace（即使 tick 未前进）也会清理 pending。
- 完成内容：增强 Step 基线记录逻辑：发送 Step 时同时记录 `baseline_tick`、`baseline_event_count`、`baseline_trace_count`，并兼容 `metrics.total_ticks` 作为 tick 参考。
- 完成内容：补充回归测试 `track_step_loading_clears_pending_when_llm_trace_arrives_without_tick_advance`，覆盖“LLM 失败仅返回 trace、不推进 tick”场景。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`（通过）；执行 `env -u RUSTC_WRAPPER cargo test -p agent_world_viewer button_feedback::tests:: -- --nocapture`（通过，2 tests）。
- 遗留事项：可继续补充 EGUI 按钮级交互测试（点击 Step 后注入 Error/DecisionTrace 消息，断言按钮文案即时恢复）。

- 日期：2026-02-09
- 完成内容：修复 `agent_world_viewer` 的 `egui` snapshot 测试在 CI 无可用 `wgpu` 时直接失败的问题：将 `SnapshotRenderer::new` 改为 `try_new`，在渲染器初始化失败时输出 skip 原因并提前返回测试。
- 完成内容：`egui_kittest_snapshot_overview_live` 与 `egui_kittest_snapshot_overview_manual_high_risk` 接入降级分支，保证无图形设备环境不阻断 `cargo test` 主流程。
- 完成内容：更新测试覆盖设计/项目管理文档（`doc/testing/ci-test-coverage.md`、`doc/testing/ci-test-coverage.project.md`），补充“无 `wgpu` 环境降级”目标、里程碑与状态。
- 遗留事项：后续可在具备图形能力的专用环境（本地或独立 CI job）保留一次完整 snapshot 回归，以弥补降级 skip 场景下的视觉覆盖空洞。
- 完成内容：完成 LMSO17，按“真实调用可等待几分钟”要求将 `DEFAULT_LLM_TIMEOUT_MS` 从 `30000` 提升到 `180000`（3 分钟），降低慢响应场景误判超时。
- 完成内容：保留短超时自动回退策略：当显式配置超时小于默认值时，首次短超时请求失败后自动回退到默认超时再试一次。
- 完成内容：更新 `README.md` 与 `config.example.toml` 的默认超时说明，同步更新 LLM 设计/项目文档状态。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`、`env -u RUSTC_WRAPPER cargo test -p agent_world openai_client_enables_timeout_retry_when_timeout_below_default`、`env -u RUSTC_WRAPPER cargo test -p agent_world openai_client_timeout_retry_can_recover_short_timeout_request`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_config_`（通过）。
- 遗留事项：后续可增加 `AGENT_WORLD_LLM_TIMEOUT_RETRY_MS` 独立配置，进一步拆分首轮超时与重试超时策略。
- 日期：2026-02-09
- 完成内容：完成 LMSO18，为 `execute_until` 增加 `until.event` 扩展语义：`insufficient_electricity`、`thermal_overload`、`harvest_yield_below`、`harvest_available_below`。
- 完成内容：新增 `until.value_lte` 约束（阈值事件必填且非负），并在运行态基于 `ActionRejected`/`RadiationHarvested` 结果执行停止判定。
- 完成内容：联动更新 `behavior_loop` / Prompt 协议文案 / README：明确阈值事件写法、`until.event_any_of` 与 `"a|b"`/`"a,b"` 兼容语义。
- 完成内容：补充测试覆盖（解析 + 运行态）：`llm_parse_execute_until_accepts_threshold_event_with_value_lte`、`llm_parse_execute_until_rejects_threshold_event_without_value_lte`、`llm_agent_execute_until_stops_on_insufficient_electricity_reject_reason`、`llm_agent_execute_until_stops_on_thermal_overload_reject_reason`、`llm_agent_execute_until_stops_on_harvest_yield_threshold`、`llm_agent_execute_until_stops_on_harvest_available_threshold`。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_parse_execute_until_`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_execute_until_`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_prompt_contains_execute_until_and_exploration_guidance`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_`（通过）。
- 遗留事项：后续可在真实长跑中观察阈值事件命中频率，必要时补充“连续命中 N 次再停止”等去抖策略。
- 日期：2026-02-09
- 完成内容：完成 LMSO19，对 Prompt 注入链路增加 `Module History` 大结果压缩：当 `module_call` 返回 payload 过大时，改写为 `{truncated, original_chars, preview}`，降低后续轮次输入峰值。
- 完成内容：补充测试 `llm_agent_compacts_large_module_result_payload_for_prompt_history`，覆盖压缩逻辑。
- 完成内容：修复 `scripts/llm-longrun-stress.sh` 在无 `jq` 环境的指标提取回退：新增 Python 解析 `report.json`，并兼容 macOS bash（去除 `mapfile` 依赖）。
- 完成内容：真实压测对比（`--ticks 26`）：`llm_input_chars_max` 从 `.tmp/llm_stress_lmso18_26/report.json` 的 `20550` 降至 `.tmp/llm_stress_lmso19_26/report.json` 的 `7462`，`prompt_section_clipped` 从 `1` 降为 `0`。
- 完成内容：执行 `env -u RUSTC_WRAPPER cargo fmt --all -- --check`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_compacts_large_module_result_payload_for_prompt_history`、`env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_`、`./scripts/llm-longrun-stress.sh --ticks 4 --out-dir .tmp/llm_stress_lmso19_smoke --max-llm-errors 8 --max-parse-errors 8 --max-repair-rounds-max 8 --min-active-ticks 4 --llm-io-max-chars 800`、`./scripts/llm-longrun-stress.sh --ticks 26 --out-dir .tmp/llm_stress_lmso19_26 --max-llm-errors 8 --max-parse-errors 8 --max-repair-rounds-max 8 --min-active-ticks 26 --llm-io-max-chars 2000`（通过）。
- 遗留事项：目前输入峰值仍受 `Memory Digest` 中失败事件文本影响，后续可继续做失败事件模板化与重复折叠。
