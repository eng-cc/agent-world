# 2026-02-14 任务日志（M4 工业社会经济 runtime 最小闭环）

## 日期
- 2026-02-14

## 完成内容
- runtime 新增经济动作与事件闭环：
  - 新动作：`BuildFactory`、`ScheduleRecipe`
  - 新事件：`FactoryBuildStarted`、`FactoryBuilt`、`RecipeStarted`、`RecipeCompleted`
  - 新拒绝原因：`InsufficientMaterial`、`FactoryNotFound`、`FactoryBusy`
- `WorldState` 新增工业经济状态：
  - `materials`（材料库存）
  - `factories`（已建工厂）
  - `pending_factory_builds`（建造队列）
  - `pending_recipe_jobs`（配方排产队列）
- 新增 tick 结算流程：在 `step/step_with_modules` 内自动处理到期建造和到期配方任务，触发完成事件并更新状态。
- 新增 runtime 材料库存 API（查询/设置/调整）与工厂/排产队列辅助查询。
- 新增定向测试文件：`crates/agent_world/src/runtime/tests/economy.rs`，覆盖：
  - 工厂建造延迟完成与建造成本扣减
  - 配方排产的输入与电力扣减、到期产出入账
  - 产线槽位占满时拒绝新排产
  - 材料不足时拒绝建造
- 文档回写：
  - `doc/m4-industrial-economy-wasm.md`
  - `doc/m4-industrial-economy-wasm.project.md`
  - `doc/world-simulator.md`
  - `doc/world-simulator.project.md`
- 验证命令：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

## 遗留事项
- 当前 `BuildFactory/ScheduleRecipe` 仍使用动作侧传入的 spec/plan；下一步需接入 wasm 模块在线评估流程（由模块返回 build/recipe 决策）。
- 当前材料库存为 world 级共享账本；后续可扩展为 owner/location 级多账本并接入物流约束。
