- 日期：2026-02-19
- 时刻：2026-02-19 00:01:55 CST
- 完成内容：完成“将系统性应用测试手册迁移到项目根目录并提交”任务。
  - 将 `doc/testing/systematic-application-testing-manual.md` 迁移为 `systematic-application-testing-manual.md`。
  - 更新项目管理文档 `doc/testing/systematic-application-testing-manual.project.md` 中的设计文档路径、任务拆解（新增 T8）与状态时间。
  - 保持手册正文内容与 TODO 项不变，仅调整存放位置与引用口径。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 无（后续按手册 TODO-1/TODO-2 单独任务推进）。

- 日期：2026-02-19
- 时刻：2026-02-19 00:09:53 CST
- 完成内容：完成“AGENTS.md 测试章节迁移 + 文档引用收敛”任务。
  - 将 `AGENTS.md` 中“Agent 专用：UI Web 闭环调试”由长流程改为短入口与约束，避免双维护。
  - 将原章节中的 fallback 规则与推荐约定补充进 `testing-manual.md`（S6 补充约定）。
  - 更新项目管理文档 `doc/testing/systematic-application-testing-manual.project.md`，新增 T10 并回写状态说明。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 无（执行入口已统一，后续仅在 `testing-manual.md` 维护详细流程）。
- 时刻：2026-02-19 00:18:40 CST
- 完成内容：完成 README 生产级缺口收口（二次）T0 文档建档。
  - 新增设计文档：`doc/readme-prod-gap1245-wasm-repl-topology-player.md`。
  - 新增项目管理文档：`doc/readme-prod-gap1245-wasm-repl-topology-player.project.md`。
  - 项目管理文档状态初始化：T0 完成，T1~T5 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 执行 T1：默认构建启用 `wasmtime` 并补齐测试。

- 日期：2026-02-19
- 时刻：2026-02-19 00:21:33 CST
- 完成内容：完成 README 缺口收口 T1（默认构建启用 `wasmtime`）。
  - `crates/agent_world/Cargo.toml`：`default` feature 从空集调整为 `["wasmtime"]`，默认构建具备真实 WASM 执行能力。
  - `doc/readme-prod-gap1245-wasm-repl-topology-player.project.md`：回写 T1 状态为完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --features wasmtime`
- 遗留事项：
  - 执行 T2：实现 node libp2p replication request/handler 通道。

- 日期：2026-02-19
- 时刻：2026-02-19 00:41:02 CST
- 完成内容：完成 T2（node libp2p replication request/handler 通道）。
  - `crates/agent_world_node/src/libp2p_replication_network.rs`：
    - 接入 `request_response` 行为，与既有 `gossipsub` 并行运行。
    - `request` 实现为：有可达 peer 走远端 RR，无 peer 回退本地 handler。
    - `register_handler` 实现为线程内 handler 表注册，并用于本地 fallback 与远端请求处理。
    - 增加连接/监听状态与错误跟踪，支撑 RR 集成测试稳定等待。
    - 新增测试：本地 fallback、双节点 RR 互通。
  - `crates/agent_world_node/Cargo.toml`：补齐 `libp2p` features（`request-response`、`cbor`）。
  - `doc/readme-prod-gap1245-wasm-repl-topology-player.project.md`：回写 T2 完成，下一步切换到 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T3：实现跨主机 `triad_distributed` 拓扑并补齐 CLI/启动测试。

- 日期：2026-02-19
- 时刻：2026-02-19 00:47:13 CST
- 完成内容：完成 T3（跨主机 `triad_distributed` 拓扑）。
  - `crates/agent_world/src/bin/world_viewer_live/cli.rs`：
    - `--topology` 新增 `triad_distributed`。
    - 新增显式 triad 地址参数：`--triad-sequencer-gossip`、`--triad-storage-gossip`、`--triad-observer-gossip`。
    - 新增 `triad_distributed` 参数校验（节点启用、共识门控、三地址必填且互异、与 `--node-gossip-*` 互斥）。
  - `crates/agent_world/src/bin/world_viewer_live.rs`：
    - 新增 `start_triad_distributed_live_node`，单进程单角色启动（`--node-role` 决定角色）。
    - 三角色节点 ID 固定派生：`<node-id>-sequencer|storage|observer`，validator 集固定 `34/33/33`。
    - 新增可复用的 `attach_optional_replication_network`，`single` 与 `triad_distributed` 共享 libp2p replication 挂接路径。
  - `crates/agent_world/src/bin/world_viewer_live/world_viewer_live_tests.rs`：
    - 新增 `triad_distributed` 的 parse/startup/replication 注入测试。
  - `doc/readme-prod-gap1245-wasm-repl-topology-player.project.md`：回写 T3 完成，下一步切换到 T4。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
- 遗留事项：
  - 执行 T4：实现玩家节点身份模型下沉并补齐配置/动作/消息测试。

- 日期：2026-02-19
- 时刻：2026-02-19 00:26:54 CST
- 完成内容：完成 T1 收口修正（required-tier 稳定性）。
  - `crates/agent_world/src/runtime/tests/economy_bootstrap.rs`：将文件级条件从 `feature = "wasmtime"` 调整为 `all(feature = "wasmtime", feature = "test_tier_full")`，避免 default 开启 wasmtime 后重型 m4 用例进入 required-tier。
  - 保持 T1 目标不变：`agent_world` 默认构建启用 `wasmtime`。
- 测试：
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 执行 T2：实现 node libp2p replication request/handler 通道。

- 日期：2026-02-19
- 时刻：2026-02-19 01:02:03 CST
- 完成内容：完成 T4（玩家节点身份模型下沉，节点/动作/消息一致身份语义）。
  - `crates/agent_world_node/src/types.rs`：`NodeConfig` 增加 `player_id`（默认等于 `node_id`），`NodePosConfig` 增加 `validator_player_ids`，`NodeSnapshot` 增加 `player_id`。
  - `crates/agent_world_node/src/pos_validation.rs`：增强 POS 校验，要求 validator-player 一一绑定、禁止空绑定、禁止同玩家绑定多个 validator、禁止未知 validator 绑定。
  - `crates/agent_world_node/src/consensus_action.rs`：`NodeConsensusAction` 增加 `submitter_player_id`，action root 升级到 v2（含 player），并保留 v1 兼容校验。
  - `crates/agent_world_node/src/lib.rs`、`crates/agent_world_node/src/gossip_udp.rs`、`crates/agent_world_node/src/consensus_signature.rs`：proposal/attestation/commit 消息新增 `player_id`，签名负载纳入 `player_id`，引擎 ingest 增加 player-binding 一致性过滤。
  - `crates/agent_world_node/src/node_runtime_core.rs`：新增 `submit_consensus_action_payload_as_player`，强校验提交方 `player_id` 与节点配置一致。
  - `crates/agent_world/src/viewer/live/consensus_bridge.rs`：玩家提交路径改为调用 runtime 的按玩家提交接口；system/agent 维持原接口。
  - `crates/agent_world_node/src/tests.rs`、`crates/agent_world_node/src/tests_action_payload.rs`、`crates/agent_world/src/bin/world_viewer_live/execution_bridge.rs`、`crates/agent_world/src/runtime/node_points_runtime.rs`：补齐 player_id 相关测试与快照构造更新。
  - `doc/readme-prod-gap1245-wasm-repl-topology-player.project.md`：回写 T4 完成，下一步切换到 T5。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world viewer::live::tests::live_world_consensus_bridge_applies_only_committed_actions`
- 遗留事项：
  - 执行 T5：`env -u RUSTC_WRAPPER cargo check` 与 `CI_VERBOSE=1 ./scripts/ci-tests.sh required` 回归收口。

- 日期：2026-02-19
- 时刻：2026-02-19 01:13:03 CST
- 完成内容：完成 T5（全量回归验证与文档收口）。
  - 执行并通过 `env -u RUSTC_WRAPPER cargo check`（workspace）。
  - 执行并通过 `CI_VERBOSE=1 ./scripts/ci-tests.sh required`（包含 required-tier 测试和 wasm 产物一致性校验）。
  - `doc/readme-prod-gap1245-wasm-repl-topology-player.project.md`：回写 T5 完成，整体状态收口为完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 08:48:15 CST
- 完成内容：完成 README 缺口 3（安装目标语义）T0 文档建档。
  - 新增设计文档：`doc/readme-gap3-install-target-infrastructure.md`。
  - 新增项目管理文档：`doc/readme-gap3-install-target-infrastructure.project.md`。
  - 项目文档状态初始化：T0 完成，T1~T3 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T1：扩展 `ModuleInstallTarget` 与 action/event/state 类型。

- 日期：2026-02-19
- 时刻：2026-02-19 08:54:40 CST
- 完成内容：完成 README 缺口 3 收口 T1（安装目标类型与事件结构扩展）。
  - `crates/agent_world/src/simulator/types.rs`：新增 `ModuleInstallTarget`；新增动作 `InstallModuleToTargetFromArtifact`。
  - `crates/agent_world/src/simulator/world_model/module_market.rs`：`InstalledModuleState` 新增 `install_target`（默认兼容）。
  - `crates/agent_world/src/simulator/kernel/types.rs`、`crates/agent_world/src/runtime/events.rs`：`ModuleInstalled` 事件新增 `install_target`（`serde(default)` 兼容历史快照/回放）。
  - `crates/agent_world/src/runtime/world/module_runtime_labels.rs`、`crates/agent_world/src/runtime/world/event_processing.rs`、`crates/agent_world/src/runtime/world/module_actions.rs`、`crates/agent_world/src/simulator/kernel/actions.rs`、`crates/agent_world/src/simulator/kernel/step.rs`：补齐新动作分支与兼容路径。
  - `crates/agent_world/src/simulator/llm_agent/behavior_loop.rs`、`crates/agent_world/src/simulator/llm_agent/behavior_prompt.rs`：补齐新字段/新动作的模式匹配。
  - `doc/readme-gap3-install-target-infrastructure.project.md`：回写 T1 完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T2：实现 `location_infrastructure` 校验与 runtime/simulator 目标语义落库。

- 日期：2026-02-19
- 时刻：2026-02-19 09:08:37 CST
- 完成内容：完成 README 缺口 3 收口 T2（安装目标语义落地与 LLM 新动作入口）。
  - `crates/agent_world/src/simulator/kernel/module_lifecycle.rs`、`crates/agent_world/src/simulator/kernel/actions.rs`：
    - 新动作 `InstallModuleToTargetFromArtifact` 接入真实安装流程，不再退化为旧动作。
    - 新增安装目标统一处理：`SelfAgent` 与 `LocationInfrastructure`。
    - `LocationInfrastructure` 增加两条生产约束：目标 location 必须存在；安装者必须位于该 location。
  - `crates/agent_world/src/simulator/kernel/replay_module_lifecycle.rs`：回放路径补齐 `install_target` 校验与标准化，确保 replay 语义一致。
  - `crates/agent_world/src/runtime/world/module_actions.rs`：
    - 抽取统一安装处理函数，旧动作与新动作共享治理/注册/激活流程。
    - 新动作不再占位拒绝，`DomainEvent::ModuleInstalled` 正确记录 `install_target`。
  - `crates/agent_world/src/simulator/llm_agent/decision_flow.rs`、`crates/agent_world/src/simulator/llm_agent/decision_flow/action_parsers.rs`、`crates/agent_world/src/simulator/llm_agent/openai_payload.rs`、`crates/agent_world/src/simulator/llm_agent/prompt_assembly.rs`：
    - 新增 `install_module_to_target_from_artifact` 决策、schema 字段与解析规则。
    - 新增字段：`install_target_type`、`install_target_location_id`。
  - `crates/agent_world/src/simulator/llm_agent.rs`、`crates/agent_world/src/simulator/llm_agent/behavior_loop.rs`：
    - LLM 内部已知安装记录增加 `install_target`，`module.lifecycle.status` 输出可审计目标信息。
  - `doc/readme-gap3-install-target-infrastructure.project.md`：回写 T2 完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T3：补齐目标安装语义测试（simulator/runtime/llm）并完成回归收口。

- 日期：2026-02-19
- 时刻：2026-02-19 09:17:42 CST
- 完成内容：完成 README 缺口 3 收口 T3（测试补齐与回归收口）。
  - `crates/agent_world/src/simulator/tests/module_lifecycle.rs`：
    - 新增 `install_module_to_target_from_artifact` 成功用例（同 location 基础设施安装）。
    - 新增失败用例（目标 location 不存在、安装者与目标 location 不同位）。
    - 新增 legacy replay 兼容用例：历史 `module_installed` 事件缺失 `install_target` 时，回放默认 `SelfAgent`。
  - `crates/agent_world/src/runtime/tests/module_action_loop.rs`：
    - 新增 runtime 目标安装动作用例，验证 `DomainEvent::ModuleInstalled.install_target` 透传。
    - 新增 legacy 反序列化兼容用例：`DomainEvent::ModuleInstalled` 缺失 `install_target` 默认 `SelfAgent`。
  - `crates/agent_world/src/simulator/llm_agent/tests_part3_module_lifecycle.rs`：
    - 新增 LLM 解析失败用例：`install_target_type=location_infrastructure` 缺失 `install_target_location_id`。
  - `doc/readme-gap3-install-target-infrastructure.project.md`：回写 T3 完成，整体状态收口完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_lifecycle_install_to_location_infrastructure`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_lifecycle_replay_legacy_module_installed_defaults_install_target_to_self_agent`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required install_module_to_target_from_artifact_action_emits_target`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_installed_domain_event_legacy_payload_defaults_install_target`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_parse_install_module_to_target_from_artifact_rejects_missing_location_id`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 09:30:46 CST
- 完成内容：完成“基础设施模块执行引擎 + 编译 Sandbox 隔离”T0 文档建档。
  - 新增设计文档：`doc/readme-gap-infra-exec-compiler-sandbox.md`。
  - 新增项目管理文档：`doc/readme-gap-infra-exec-compiler-sandbox.project.md`。
  - 项目文档状态初始化：T0 完成，T1/T2/T3 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T1：实现基础设施模块执行引擎。

- 日期：2026-02-19
- 时刻：2026-02-19 09:35:42 CST
- 完成内容：完成 T1（基础设施模块执行引擎）。
  - `crates/agent_world/src/runtime/state.rs`：`WorldState` 新增 `installed_module_targets`，`ModuleInstalled` 事件应用时落库安装目标。
  - `crates/agent_world/src/runtime/world/module_tick_runtime.rs`：tick 路由按安装目标分流；`LocationInfrastructure` 使用 `origin.kind=infrastructure_tick` 与 `origin.id=<location_id>:<time>`。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增基础设施安装目标 tick 路由用例，验证 runtime 调用语义。
  - `doc/readme-gap-infra-exec-compiler-sandbox.project.md`：回写 T1 为完成，下一步切换 T2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required step_with_modules_routes_location_infrastructure_install_as_infrastructure_tick`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required install_module_to_target_from_artifact_action_emits_target`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required step_with_modules_routes_tick_lifecycle_with_wake_and_suspend`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T2：实现编译 Sandbox 隔离（源码包约束 + timeout + 最小化环境）。

- 日期：2026-02-19
- 时刻：2026-02-19 09:42:22 CST
- 完成内容：完成 T2（编译 sandbox 隔离）。
  - `crates/agent_world/src/runtime/module_source_compiler.rs`：新增源码包限制（文件数/单文件大小/总大小），支持环境变量覆盖；新增编译进程超时控制；编译命令改为最小环境白名单（`env_clear` + allowlist）；`TMPDIR/TMP/TEMP` 固定为工作目录内隔离 `tmp` 子目录。
  - `crates/agent_world/src/runtime/tests/module_action_loop.rs`：新增 required-tier 用例，覆盖“文件数超限拒绝”“编译超时拒绝”“环境白名单 + TMPDIR 隔离成功路径”；并保持既有编译成功/manifest 缺失场景兼容。
  - `doc/readme-gap-infra-exec-compiler-sandbox.project.md`：回写 T2 完成，下一步切换 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required compile_module_artifact_from_source_rejects_when_file_count_exceeds_limit`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required compile_module_artifact_from_source_rejects_when_compiler_times_out`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required compile_module_artifact_from_source_sanitizes_env_and_isolates_tmpdir`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required compile_module_artifact_from_source_registers_compiled_artifact`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required compile_module_artifact_from_source_rejects_when_manifest_path_missing_in_files`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T3：全仓 `cargo check` 与 required CI 回归收口。

- 日期：2026-02-19
- 时刻：2026-02-19 09:46:56 CST
- 完成内容：完成 T3（回归验证与收口）。
  - 执行并通过 workspace 级 `cargo check`。
  - 执行并通过 `required` 门禁脚本（含格式、内置 wasm 产物一致性、required-tier 测试、`agent_world_viewer` wasm32 check）。
  - `doc/readme-gap-infra-exec-compiler-sandbox.project.md`：回写 T3 完成，整体状态收口为完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 10:02:31 CST
- 完成内容：完成 README 资源模型口径修订 T0（文档建档）。
  - 新增设计文档：`doc/readme-resource-model-layering.md`。
  - 新增项目管理文档：`doc/readme-resource-model-layering.project.md`。
  - 项目管理文档状态初始化：T0 完成，T1 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T1：修订 `README.md` 资源口径并回归校验。

- 日期：2026-02-19
- 时刻：2026-02-19 10:04:57 CST
- 完成内容：完成 README 资源模型口径修订 T1（README 实改与项目状态收口）。
  - `README.md`：将资源叙述调整为“内建最小资源 + 模块扩展资源”分层。
  - `README.md`：明确当前内建资源为 `Electricity/Compound/Hardware/Data`，并说明算力/存储/带宽可由内建资源组合与模块规则共同表达。
  - `doc/readme-resource-model-layering.project.md`：回写 T1 完成，状态收口为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 10:10:25 CST
- 完成内容：完成 Compound/Hardware 硬迁移 T0（文档建档）。
  - 新增设计文档：`doc/resource-kind-compound-hardware-hard-migration.md`。
  - 新增项目管理文档：`doc/resource-kind-compound-hardware-hard-migration.project.md`。
  - 项目管理文档状态初始化：T0 完成，T1/T2 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T1：代码硬迁移（移除 `ResourceKind::Compound/Hardware`）。

- 日期：2026-02-19
- 时刻：2026-02-19 10:27:10 CST
- 完成内容：完成 Compound/Hardware 硬迁移 T1（代码硬迁移与 README/场景同步）。
  - `crates/agent_world/src/simulator/types.rs`：`ResourceKind` 收敛为 `Electricity | Data`，移除 `Compound/Hardware`。
  - `crates/agent_world/src/simulator/llm_agent/decision_flow.rs`：移除 `compound/hardware` 资源 kind 解析入口，仅保留 `electricity/data`。
  - `crates/agent_world/src/simulator/llm_agent/prompt_assembly.rs`：工具参数 schema 与恢复策略改为 `electricity/data` 口径（不再给出 compound/hardware kind）。
  - `crates/agent_world/scenarios/resource_bootstrap.json`、`crates/agent_world/scenarios/asteroid_fragment_bootstrap.json`：场景资源 kind 从 `hardware` 迁移到 `data`。
  - `README.md`：内建资源描述调整为仅 `Electricity/Data`，`Compound/Hardware` 改为 WASM 模块层定义。
  - `crates/agent_world_viewer/src/ui_text_economy.rs`、`crates/agent_world_viewer/src/ui_text_industrial.rs`、`crates/agent_world_viewer/src/world_overlay.rs`：viewer 统计口径迁移到双资源模型并清理重复 `Data` 分支。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --lib --features test_tier_required`
- 遗留事项：
  - 执行 T2：required 门禁回归与项目状态收口。

- 日期：2026-02-19
- 时刻：2026-02-19 10:28:38 CST
- 完成内容：完成 Compound/Hardware 硬迁移 T2（门禁回归与文档收口）。
  - 通过 required 门禁（格式、内置 wasm 产物一致性、required-tier 测试、`agent_world_viewer` wasm32 check）。
  - `doc/resource-kind-compound-hardware-hard-migration.project.md`：回写 T1/T2 完成，状态收口为全部完成。
  - 同步补记本日 devlog（本条）。
- 测试：
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 10:56:50 CST
- 完成内容：完成 Web 端定位口径修订（方案1：Viewer + 网关，不要求浏览器具备完整分布式节点能力）。
  - `README.md`：补充架构说明，明确 Web 端默认是 Viewer/间接控制客户端，通过 `world_viewer_live --web-bind` 桥接接入。
  - `doc/viewer-manual.md`：在适用范围、浏览器模式、Web 闭环章节补充角色边界说明，明确 Web 端不承担 gossip/replication/共识职责。
  - `doc/world-simulator/viewer-websocket-http-bridge.md`：目标与范围外新增边界说明，避免误解为浏览器端完整节点实现。
  - `doc/world-simulator/viewer-websocket-http-bridge.project.md`：新增 WLB6 文档口径澄清任务并回写状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 11:14:29 CST
- 完成内容：完成“LLM 工业闭环未收口稳定性项复现与评估（MMD10）”。
  - 阅读并对齐项目文档：`doc/world-simulator/llm-industrial-mining-debug-tools.project.md`（未收口项 TODO-21/26/27）。
  - 按 2026-02-18 同口径 prompt 执行 `llm_bootstrap --ticks 120` 完整复现，产物：
    - `output/llm_bootstrap/repro_mmd9_2026-02-19_110325/run.log`
    - `output/llm_bootstrap/repro_mmd9_2026-02-19_110325/report.json`
  - 完整样本结果：`action_failure=71`，其中 `rule_denied=42`、`facility_not_found=25`、`location_not_found=3`、`agent_already_at_location=1`；并出现多段 `---` 输出（7 次）、`llm_input_chars_max=60197`、`prompt_section_clipped=380`。
  - 执行二次复现（同口径）到 `tick=51` 后手动中断，失败模式一致：`rule_denied=12`、`facility_not_found=6`、`location_not_found=1`。
  - 评估结论：需要进入下一轮优化，优先级为 P0（TODO-26/27）> P1（location_id 归一）> P2（多段输出协议 + prompt 体积治理）。
  - 回写项目管理文档：新增 MMD10 复现摘要，更新状态与 TODO-21/26/27，新增 TODO-28/29。
- 测试：
  - `AGENT_WORLD_LLM_SYSTEM_PROMPT='你是工业闭环调度Agent。每轮只输出一个可执行 tool call 对应的 decision，不输出解释文本。优先形成稳定工业闭环，避免在同一耗尽矿点连续重试。' AGENT_WORLD_LLM_SHORT_TERM_GOAL='120 tick 内完成：1) build_factory(factory.power.radiation.mk1) 成功>=1；2) build_factory(factory.assembler.mk1) 成功>=1；3) schedule_recipe 成功覆盖 recipe.assembler.control_chip / recipe.assembler.motor_mk1 / recipe.assembler.logistics_drone 各>=1。覆盖完成后继续排产，禁止 wait/wait_ticks。恢复规则：electricity不足->harvest_radiation；hardware不足->mine_compound+refine_compound；factory_not_found->build_factory。' AGENT_WORLD_LLM_LONG_TERM_GOAL='维持 harvest_radiation -> mine_compound -> refine_compound -> build_factory -> schedule_recipe 的持续产出闭环，减少 move/mine 抖动和无效重试。' env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 120 --print-llm-io --llm-io-max-chars 1800 --report-json output/llm_bootstrap/repro_mmd9_2026-02-19_110325/report.json`
  - `AGENT_WORLD_LLM_SYSTEM_PROMPT='你是工业闭环调度Agent。每轮只输出一个可执行 tool call 对应的 decision，不输出解释文本。优先形成稳定工业闭环，避免在同一耗尽矿点连续重试。' AGENT_WORLD_LLM_SHORT_TERM_GOAL='120 tick 内完成：1) build_factory(factory.power.radiation.mk1) 成功>=1；2) build_factory(factory.assembler.mk1) 成功>=1；3) schedule_recipe 成功覆盖 recipe.assembler.control_chip / recipe.assembler.motor_mk1 / recipe.assembler.logistics_drone 各>=1。覆盖完成后继续排产，禁止 wait/wait_ticks。恢复规则：electricity不足->harvest_radiation；hardware不足->mine_compound+refine_compound；factory_not_found->build_factory。' AGENT_WORLD_LLM_LONG_TERM_GOAL='维持 harvest_radiation -> mine_compound -> refine_compound -> build_factory -> schedule_recipe 的持续产出闭环，减少 move/mine 抖动和无效重试。' env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 120 --report-json output/llm_bootstrap/repro_mmd9_b_2026-02-19_111015/report.json`（手动中断于 tick=51）
- 遗留事项：
  - 进入 MMD11：先做 TODO-26/TODO-27（factory_id 与 recipe/factory_kind guardrail 收敛），再收敛 TODO-28/TODO-29。

- 日期：2026-02-19
- 时刻：2026-02-19 11:42:01 CST
- 完成内容：完成 MMD11.1（TODO-26~29 文档增量设计与任务拆解）。
  - `doc/world-simulator/llm-industrial-mining-debug-tools.md`：新增《MMD11 增量优化（TODO-26 ~ TODO-29）》章节，补齐目标、范围、接口/数据、里程碑、风险。
  - `doc/world-simulator/llm-industrial-mining-debug-tools.project.md`：新增 MMD11.1~MMD11.4 任务拆解并更新状态到“进入 MMD11.2 实现阶段”。
- 测试：
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`（由提交钩子执行）
- 遗留事项：
  - 执行 MMD11.2：实现 guardrail 修复（factory/location 归一 + recipe/factory_kind 兼容改写）。

- 日期：2026-02-19
- 时刻：2026-02-19 12:03:46 CST
- 完成内容：完成 MMD11.2/MMD11.3（guardrail 修复 + required-tier 回归）。
  - `crates/agent_world/src/simulator/llm_agent/behavior_runtime_helpers.rs`：新增 recipe->factory_kind 推导、factory_kind->canonical_factory_id、缺失 recipe 依赖推导等运行时辅助方法。
  - `crates/agent_world/src/simulator/llm_agent/behavior_guardrails.rs`：
    - `schedule_recipe` 增加 factory kind 兼容前置检查，支持兼容工厂改写与缺厂时 `build_factory` 回退；
    - `build_factory` 增加 location 归一（未知 location 回退当前 location）、同位预检（异位先 `move_agent`）和兼容去重改写。
  - `crates/agent_world/src/simulator/llm_agent/behavior_prompt.rs`、`crates/agent_world/src/simulator/llm_agent/prompt_assembly.rs`：补齐 `rule_denied/location_not_found` reject reason 透传与恢复策略提示。
  - `crates/agent_world/src/simulator/llm_agent/tests_part2.rs`：
    - 补齐 MMD11 新 guardrail 预置场景（已知工厂）并修正脆弱断言；
    - 将部分易受 prompt 裁剪影响的断言收敛到稳定中间表示（history/observation JSON）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_reroutes_schedule_recipe --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_build_factory_normalizes_unknown_location_to_current_location --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_user_prompt_preserves_ --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent --features test_tier_required -- --nocapture`
- 遗留事项：
  - 执行 MMD11.4 在线复验并回写项目文档/结论。

- 日期：2026-02-19
- 时刻：2026-02-19 12:03:55 CST
- 完成内容：完成 MMD11.4 在线复验与文档回写。
  - 执行同 MMD10 口径 `llm_bootstrap --ticks 120`，产物：
    - `output/llm_bootstrap/mmd11_verify_2026-02-19_115519/run.log`
    - `output/llm_bootstrap/mmd11_verify_2026-02-19_115519/report.json`
  - 对比基线 `output/llm_bootstrap/repro_mmd9_2026-02-19_110325/report.json`：
    - 主拒绝项改善：`rule_denied: 42 -> 0`、`facility_not_found: 25 -> 0`、`action_failure: 71 -> 10`；
    - 新退化项：`location_not_found: 3 -> 10`、`parse_errors: 0 -> 60`、`decision_wait: 0 -> 60`、`prompt_section_clipped: 380 -> 1192`；
    - `run.log` 中多段 `---`：`7 -> 214`。
  - 更新 `doc/world-simulator/llm-industrial-mining-debug-tools.project.md`：
    - 勾选 MMD11.2/MMD11.3/MMD11.4；
    - 新增 MMD11 在线复验摘要与下一阶段优先级（TODO-29/TODO-28 提升为优先）。
- 测试：
  - `AGENT_WORLD_LLM_SYSTEM_PROMPT='你是工业闭环调度Agent。每轮只输出一个可执行 tool call 对应的 decision，不输出解释文本。优先形成稳定工业闭环，避免在同一耗尽矿点连续重试。' AGENT_WORLD_LLM_SHORT_TERM_GOAL='120 tick 内完成：1) build_factory(factory.power.radiation.mk1) 成功>=1；2) build_factory(factory.assembler.mk1) 成功>=1；3) schedule_recipe 成功覆盖 recipe.assembler.control_chip / recipe.assembler.motor_mk1 / recipe.assembler.logistics_drone 各>=1。覆盖完成后继续排产，禁止 wait/wait_ticks。恢复规则：electricity不足->harvest_radiation；hardware不足->mine_compound+refine_compound；factory_not_found->build_factory。' AGENT_WORLD_LLM_LONG_TERM_GOAL='维持 harvest_radiation -> mine_compound -> refine_compound -> build_factory -> schedule_recipe 的持续产出闭环，减少 move/mine 抖动和无效重试。' env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 120 --print-llm-io --llm-io-max-chars 1800 --report-json output/llm_bootstrap/mmd11_verify_2026-02-19_115519/report.json`
- 遗留事项：
  - 进入下一轮：优先收敛 TODO-29（多段输出协议 + prompt 体积治理），随后复核 TODO-28（location 归一）。

- 日期：2026-02-19
- 时刻：2026-02-19 12:42:56 CST
- 完成内容：完成 README 世界设定章节摘要化并统一细则入口任务。
  - 新增设计文档：`doc/readme-world-config-summary-link.md`。
  - 新增项目管理文档：`doc/readme-world-config-summary-link.project.md`。
  - `README.md`：将 `# 一、世界设定（Default World Configuration）` 从细节条目收敛为摘要，并统一指向 `world-rule.md` 作为细则文档。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 12:50:04 CST
- 完成内容：完成 README 章节 2/3/5 细则收敛到 `world-rule.md`（不提交）。
  - 新增设计文档：`doc/readme-sim-wasm-sandbox-consolidation.md`。
  - 新增项目管理文档：`doc/readme-sim-wasm-sandbox-consolidation.project.md`。
  - `world-rule.md`：补齐并整合了模拟机制细则（行动闭环、记忆关系、制度演化与多玩家磨合）、WASM 模块开发/部署/运行周期细则、开放沙盒涌现细则。
  - `README.md`：`# 二、模拟机制`、`# 三、WASM 模块运行机制`、`# 五、开放沙盒特性` 收敛为摘要，并统一指向 `world-rule.md`。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 12:53:51 CST
- 完成内容：完成 README `# 一`~`# 六` 导航化整合（不提交）。
  - 新增设计文档：`doc/readme-section1-6-navigation-consolidation.md`。
  - 新增项目管理文档：`doc/readme-section1-6-navigation-consolidation.project.md`。
  - `README.md`：将 1~6 统一为“摘要 + 细则入口”的一致结构，并在章节顶部集中声明文档分工（世界规则/运行说明/测试手册）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 12:56:53 CST
- 完成内容：完成 README 章节层级修正（章节标题改为二级）。
  - `README.md`：`世界设定与运行机制补充说明` 与 `一~六` 章节标题由一级改为二级；各节 `摘要` 由二级改为三级，层级关系与目录语义一致。
  - `doc/readme-section1-6-navigation-consolidation.project.md`：新增并完成 T3（层级规范修正）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 12:58:39 CST
- 完成内容：完成未提交设计/项目管理文档合并（3 组合并为 1 组）。
  - 新增统一设计文档：`doc/readme-world-rules-consolidation.md`。
  - 新增统一项目管理文档：`doc/readme-world-rules-consolidation.project.md`。
  - 删除并并入的文档：
    - `doc/readme-world-config-summary-link.md`
    - `doc/readme-world-config-summary-link.project.md`
    - `doc/readme-sim-wasm-sandbox-consolidation.md`
    - `doc/readme-sim-wasm-sandbox-consolidation.project.md`
    - `doc/readme-section1-6-navigation-consolidation.md`
    - `doc/readme-section1-6-navigation-consolidation.project.md`
- 时刻：2026-02-19 12:21:54 CST
- 完成内容：完成“Builtin Wasm Canonical 构建环境固化（Docker/容器化路线停止推进）”收口标记。
  - `doc/scripts/builtin-wasm-canonical-build-environment.md`：文档标题改为“已终止”，新增终止说明，明确 Docker/Podman 容器化 canonical builder 路线不再推进，并指向 nightly build-std 替代路线。
  - `doc/scripts/builtin-wasm-canonical-build-environment.project.md`：将 CBE-3~CBE-9 统一标记为“已取消（2026-02-19）”，状态改为“已终止”。
  - 代码残留检查：检索后未发现已落地的 Docker/容器化 canonical builder 代码或脚本（仅存在文档方案描述）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 13:15:38 CST
- 完成内容：完成 WASM 主链路收口任务 T0（文档建档）。
  - 新增设计文档：`doc/readme-gap-wasm-live-persistence-instance-upgrade.md`。
  - 新增项目管理文档：`doc/readme-gap-wasm-live-persistence-instance-upgrade.project.md`。
  - 项目状态初始化：T0 完成，T1~T4 待执行（进入 T1）。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T1：live/bridge 主循环切换到 `step_with_modules` 并补 required-tier 端到端测试。

- 日期：2026-02-19
- 时刻：2026-02-19 13:22:54 CST
- 完成内容：完成 README WASM 主链路收口 T1（live/bridge 主循环切换到 `step_with_modules` + required-tier e2e 用例）。
  - `crates/agent_world/src/bin/world_viewer_live/execution_bridge.rs`：
    - `NodeRuntimeExecutionDriver` 注入并持有 `ModuleSandbox`，默认使用 `WasmExecutor`。
    - `on_commit` 的执行步从 `step()` 切换到 `step_with_modules(&mut sandbox)`，确保 committed action 回放后触发模块执行管线。
    - `bridge_committed_heights(...)` 增加 sandbox 参数并切换到模块执行步。
    - 补充 required-tier 用例 `node_runtime_execution_driver_commit_routes_modules_via_step_with_modules`，通过注入失败 sandbox 断言 commit 路径确实经由模块执行。
  - `crates/agent_world/src/bin/world_viewer_live.rs`：reward runtime bridge 路径新增 `WasmExecutor` 实例并传入 `bridge_committed_heights(...)`，与 live 驱动保持同口径。
  - `doc/readme-gap-wasm-live-persistence-instance-upgrade.project.md`：回写 T1 完成，阶段切换到 T2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live node_runtime_execution_driver_commit_routes_modules_via_step_with_modules`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live bridge_committed_heights_persists_records_and_state`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live execution_bridge::tests::`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T2：将 `save_to_dir/load_from_dir` 默认路径升级为 module store 闭环（兼容旧目录）。

- 日期：2026-02-19
- 时刻：2026-02-19 13:29:26 CST
- 完成内容：完成 README WASM 主链路收口 T2（默认持久化包含 module store + 旧目录兼容加载）。
  - `crates/agent_world/src/runtime/world/persistence.rs`：
    - `save_to_dir` 默认追加 `save_module_store_to_dir`，模块 registry/meta/artifact 与快照/journal 同步落盘。
    - `load_from_dir` 默认在快照恢复后执行 module store hydrate；`load_from_dir_with_modules` 与 `save_to_dir_with_modules` 改为兼容委托默认入口。
    - `load_module_store_from_dir` 增加“无 registry 文件直接 no-op”逻辑，保持旧目录（无 module store）可加载。
  - `crates/agent_world/src/runtime/tests/persistence.rs`：
    - 新增 `persist_and_restore_world_defaults_to_module_store_roundtrip`，验证默认 save/load 可恢复 module artifact bytes 并可 `load_module`。
    - 新增 `load_from_dir_without_module_store_keeps_legacy_compatibility`，验证删除 module store 后仍可从旧目录加载（模块 registry 保留，artifact bytes 缺失行为可观测）。
  - `doc/readme-gap-wasm-live-persistence-instance-upgrade.project.md`：回写 T2 完成，阶段切换到 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required persist_and_restore_world_defaults_to_module_store_roundtrip`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required load_from_dir_without_module_store_keeps_legacy_compatibility`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full world_save_to_dir_with_modules_roundtrip`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T3：实现模块实例化模型（`instance_id + owner + target`）并替换 `module_id` 全局单实例语义。

- 日期：2026-02-19
- 时刻：2026-02-19 13:46:54 CST
- 完成内容：完成 README WASM 主链路收口 T3（模块实例化模型：`instance_id + owner + target`）。
  - `crates/agent_world/src/runtime/state.rs`：新增 `ModuleInstanceState` 与 `WorldState.module_instances/next_module_instance_id`；`ModuleInstalled` 事件落库实例信息（owner、target、module/version/hash、active、installed_at），并兼容老事件 `instance_id` 缺失回落。
  - `crates/agent_world/src/runtime/events.rs`：`DomainEvent::ModuleInstalled` 新增 `instance_id`、`wasm_hash`（`serde(default)` 兼容旧 payload）。
  - `crates/agent_world/src/runtime/world/module_actions.rs`：安装动作生成实例 ID；支持同 `module_id@version` 已注册时重复安装（manifest 一致可复用，不再被重复 register 阻塞），实现多实例并行安装路径。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`、`crates/agent_world/src/runtime/world/module_tick_runtime.rs`：
    - 新增 active instance 收集逻辑，action/event/tick 路由优先按实例执行；legacy（无实例）保留 `module_id` fallback。
    - reducer `module_states` 与 tick schedule 按 `instance_id` 键控，实现同 `module_id` 实例状态隔离。
  - `crates/agent_world/src/runtime/world/event_processing.rs`：`ModuleInstalled` 应用后按实例同步 tick schedule。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增 required-tier 用例 `step_with_modules_routes_same_module_id_as_isolated_instances`，验证同 `module_id` 双实例独立调度与状态隔离。
  - `crates/agent_world/src/runtime/tests/module_action_loop.rs`：更新安装事件断言（`instance_id` / `wasm_hash`）。
  - `doc/readme-gap-wasm-live-persistence-instance-upgrade.project.md`：回写 T3 完成，阶段切换到 T4。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required step_with_modules_routes_same_module_id_as_isolated_instances`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::modules::`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::module_action_loop::`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 执行 T4：新增 `upgrade_module` 对外动作（from->to、接口兼容校验、治理审计与测试）。

- 日期：2026-02-19
- 时刻：2026-02-19 13:58:19 CST
- 完成内容：完成 README WASM 主链路收口 T4（对外 `upgrade_module` 动作 + 接口兼容门禁 + 治理审计 + 测试）。
  - `crates/agent_world/src/runtime/events.rs`：新增 `Action::UpgradeModuleFromArtifact` 与 `DomainEvent::ModuleUpgraded`（含 `instance_id`、`from_module_version`、`to_module_version`、`proposal_id`、`manifest_hash`、fee 字段）。
  - `crates/agent_world/src/runtime/world/module_actions.rs`：新增升级主流程，校验 owner/instance/from->to/module_id、一致性接口门禁（`interface_version`、exports、subscriptions、ABI contract、required caps），并接入治理闭环（`propose -> shadow -> approve -> apply`）后落审计事件。
  - `crates/agent_world/src/runtime/state.rs`：应用 `ModuleUpgraded` 事件时更新实例版本与 wasm_hash，并校验 owner/module/from_version 一致性。
  - `crates/agent_world/src/runtime/world/event_processing.rs`、`crates/agent_world/src/runtime/world/module_runtime_labels.rs`：补齐新动作/新事件标签与调度同步路径。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：修正模块变更校验，将 `upgrade` 目标版本纳入 planned records，支持 `upgrade + activate` 同事务闭环。
  - `crates/agent_world/src/runtime/tests/module_action_loop.rs`：新增 required-tier 用例：
    - `upgrade_module_from_artifact_action_updates_instance_and_emits_audit_event`
    - `upgrade_module_from_artifact_rejects_incompatible_interface`
  - `doc/readme-gap-wasm-live-persistence-instance-upgrade.project.md`：回写 T4 完成，项目状态收口为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required upgrade_module_from_artifact`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::module_action_loop::`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：
  - 无。

- 日期：2026-02-19
- 时刻：2026-02-19 15:54:30 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T0 文档建档。
  - 新增设计文档：`doc/p2p/production-runtime-gap1234568-closure.md`。
  - 新增项目管理文档：`doc/p2p/production-runtime-gap1234568-closure.project.md`。
  - 项管状态初始化：T0 完成，T1~T7 待执行。
- 测试：
  - 无（文档任务）。
- 遗留事项：
  - 执行 T1：共识提交-执行强绑定 + 默认投票策略收口。

- 日期：2026-02-19
- 时刻：2026-02-19 16:03:59 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T1（共识提交-执行强绑定 + 默认投票策略收口）。
  - `crates/agent_world_node/src/lib.rs`：
    - 共识主循环调整为“先执行后落账”：提交路径改为先 `apply_committed_execution` 再 `apply_decision`，避免提交高度先于执行高度落账。
    - sequencer 角色在 committed 路径强制要求 execution hook，缺失时返回执行错误并拒绝推进 committed height。
    - 默认自动投票关闭后，主循环仅对本地 validator 自动投票（不再代投所有 validator）。
  - `crates/agent_world_node/src/types.rs`：
    - `NodeConfig::new` 默认 `auto_attest_all_validators=false`，与生产网络行为一致。
  - `crates/agent_world/src/bin/world_viewer_live/cli.rs`：
    - CLI 默认对齐：`node_auto_attest_all_validators=false`。
    - 新增显式开启参数 `--node-auto-attest-all`，保留显式关闭参数 `--node-no-auto-attest-all`（默认）。
  - `crates/agent_world_node/src/tests.rs`、`crates/agent_world_node/src/tests_action_payload.rs`、`crates/agent_world/src/bin/world_viewer_live/world_viewer_live_tests.rs`：
    - 更新默认行为断言，新增 sequencer 缺失 execution hook 拒绝提交用例，补齐已有复制/网络用例在新提交-执行绑定下的执行 hook 前置。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
- 遗留事项：
  - 执行 T2：writer epoch failover（Gap 5）。

- 日期：2026-02-19
- 时刻：2026-02-19 16:13:46 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T2（writer epoch failover）。
  - `crates/agent_world_distfs/src/replication.rs`：
    - `FileReplicationRecord` 新增 `writer_epoch`（`serde(default=1)`），`SingleWriterReplicationGuard` 新增 `writer_epoch`（默认 1，兼容旧快照）。
    - 落地 epoch 复制规则：
      - 同 writer 同 epoch：`sequence` 严格递增。
      - writer 切换：`writer_epoch` 必须提升且首条 `sequence=1`。
      - 同 writer epoch 提升：允许序列重置，首条 `sequence=1`。
    - 新增 `build_replication_record_with_epoch`，保留 `build_replication_record` 兼容入口（默认 epoch=1）。
    - 补充 failover/epoch-reset/legacy-json 兼容测试。
  - `crates/agent_world_node/src/replication.rs`：
    - 本地写入路径改为生成 `(writer_epoch, sequence)`，writer 切换时自动提升 epoch 并从 `sequence=1` 开始。
    - `LocalWriterState` 新增 `writer_epoch`（兼容旧状态，首次写入自动种子 epoch），保证跨重启与 failover 下记录序关系可校验。
    - 远端复制应用路径改为 epoch+sequence 去重，移除旧的“固定单 writer”预检查，交由 DistFS guard 统一校验。
  - `crates/agent_world_node/src/tests.rs`：
    - 新增 `runtime_network_replication_accepts_writer_failover_with_epoch_rotation`，覆盖 sequencer 切换时 observer 端 guard 的 writer/epoch 旋转。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_distfs replication::tests::`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T3：replication block exchange 协议与 handler（Gap 1/2）。

- 日期：2026-02-19
- 时刻：2026-02-19 16:22:08 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T3（replication block exchange 协议与 handler）。
  - `crates/agent_world_node/src/replication.rs`：
    - 新增协议常量：
      - `"/aw/node/replication/fetch-commit/1.0.0"`
      - `"/aw/node/replication/fetch-blob/1.0.0"`
    - 新增请求/响应结构：`FetchCommitRequest/Response`、`FetchBlobRequest/Response`。
    - 本地复制写入与远端复制应用后，持久化 `GossipReplicationMessage` sidecar（按高度索引），支持按高度回取 commit。
    - 新增从 replication root 读取 commit/blob 的 helper，供 request/response handler 复用。
  - `crates/agent_world_node/src/lib.rs`：
    - `NodeRuntime::start` 在存在 replication network + replication config 时注册 fetch handlers。
    - `fetch-commit` handler：按 `world_id+height` 返回 commit message（`found/message`）。
    - `fetch-blob` handler：按 `content_hash` 返回 blob（`found/blob`）。
  - `crates/agent_world_node/src/tests.rs`：
    - `TestInMemoryNetwork` 支持 `request/register_handler` 闭环。
    - 新增 `runtime_network_replication_fetch_handlers_serve_commit_and_blob`，覆盖两条协议端到端取回。
  - `crates/agent_world_node/src/network_bridge.rs`：
    - 新增 `request_json` 便捷方法，为后续网络补洞同步主路径提供统一请求入口。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_fetch_handlers_serve_commit_and_blob`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T4：网络优先补洞同步主路径（Gap 1/2）。

- 日期：2026-02-19
- 时刻：2026-02-19 16:41:59 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T4（网络优先补洞同步主路径）。
  - `crates/agent_world_node/src/lib.rs`：
    - `PosNodeEngine::tick` 接入 replication network 缺口补齐流程（`sync_missing_replication_commits`）。
    - 新增 replication commit payload 视图解析，网络 ingest 先观测网络头再决定是否落地，避免高位消息直接推进本地 guard 导致低位缺口无法补齐。
    - 新增顺序补洞主循环：按高度调用 `fetch-commit` + `fetch-blob`，仅在目标高度消息成功持久化后推进 `committed_height`。
    - 新增 `record_synced_replication_height`，统一同步后的本地高度/next_height/last_block_hash 状态推进。
  - `crates/agent_world_node/src/tests.rs`：
    - 新增 `runtime_network_replication_gap_sync_fetches_missing_commits`：只注入高位 replication 消息，验证观察者可通过 request/response 协议顺序补齐缺失 commit。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node -- --nocapture`
- 遗留事项：
  - 执行 T5：存储挑战纳入共识门控（Gap 6）。

- 日期：2026-02-19
- 时刻：2026-02-19 16:46:04 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T5（存储挑战纳入共识门控）。
  - `crates/agent_world_node/src/lib.rs`：
    - 在 `broadcast_local_replication` 提交复制前增加 `enforce_storage_challenge_gate`。
    - 门控策略：
      - 本地 `probe_storage_challenges` 失败即拒绝本次提交复制；
      - 启用 replication network 时，追加 `fetch-blob` 网络校验，要求远端 blob 哈希与本地内容一致。
  - `crates/agent_world_node/src/replication.rs`：
    - 新增 `probe_storage_challenges` 封装（默认 probe 配置）。
    - 新增 `latest_replicated_content_hash`，为网络 blob challenge 提供被校验对象。
  - `crates/agent_world_node/src/tests.rs`：
    - 新增 `runtime_replication_storage_challenge_gate_blocks_on_local_probe_failure`。
    - 新增 `runtime_replication_storage_challenge_gate_blocks_on_network_blob_mismatch`。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node -- --nocapture`
- 遗留事项：
  - 执行 T6：默认分布式网络集成收口（Gap 8）。

- 日期：2026-02-19
- 时刻：2026-02-19 16:49:50 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T6（默认分布式网络集成收口）。
  - `crates/agent_world/src/bin/world_viewer_live.rs`：
    - `attach_optional_replication_network` 升级为“默认启用 replication libp2p 网络”；未显式传 `--node-repl-libp2p-*` 时也会根据 topology/role 自动生成 listen 与 bootstrap peers。
    - triad / triad_distributed 默认网络地址按 gossip 地址派生（端口偏移 `+100`），single 默认监听 `/ip4/127.0.0.1/tcp/0`。
    - triad 启动路径对三角色 runtime 全量挂接 replication network，并将主 sequencer 的网络句柄暴露到 `LiveNodeHandle.reward_network`。
  - `crates/agent_world/src/bin/world_viewer_live/cli.rs`：
    - 放开 `--node-repl-topic` 在无显式 `--node-repl-libp2p-*` 时的校验阻断（配合默认网络链路）。
    - triad 下继续禁止显式 `--node-repl-libp2p-*` 覆盖，避免与内建拓扑派生冲突。
  - `crates/agent_world/src/bin/world_viewer_live/world_viewer_live_tests.rs`：
    - 调整 CLI/topic 预期；新增默认网络启用断言（single/triad/triad_distributed 启动后 `reward_network.is_some()`）。
  - `crates/agent_world_net/Cargo.toml`：
    - 默认 feature 改为 `default = ["self_tests", "libp2p"]`，构建默认优先生产网络能力路径。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_net --lib -- --nocapture`
- 遗留事项：
  - 执行 T7：全量回归（`cargo check` + required-tier）并完成文档收口。

- 日期：2026-02-19
- 时刻：2026-02-19 16:54:07 CST
- 完成内容：完成 Gap 1/2/3/4/5/6/8 生产级收口 T7（回归验证与文档/devlog 收口）。
  - 执行并通过 `env -u RUSTC_WRAPPER cargo check`，确认当前改动集在默认开发配置下可编译。
  - 执行并通过 `./scripts/ci-tests.sh required`，包含 `fmt --check`、内置 wasm 工件一致性检查与 `test_tier_required` 主套件。
  - 更新 `doc/p2p/production-runtime-gap1234568-closure.project.md`：T7 勾选完成，状态切换为“已完成”。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 无（本轮 Gap 1/2/3/4/5/6/8 已完成收口）。

- 日期：2026-02-19
- 时刻：2026-02-19 22:06:49 CST
- 完成内容：完成“README 分布式计算与存储生产级收口（Gap 1/2/3/4/5）”T0 文档建档。
  - 新增设计文档：`doc/readme-gap-distributed-prod-hardening-gap12345.md`。
  - 新增项目管理文档：`doc/readme-gap-distributed-prod-hardening-gap12345.project.md`。
  - 项目管理文档状态初始化：T0 完成，T1~T6 待执行。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_node`
- 遗留事项：
  - 执行 T1：`agent_world_node` 复用 `agent_world_consensus` PoS 内核（提议者选择/阈值判定）并补测试。

- 日期：2026-02-19
- 时刻：2026-02-19 22:20:53 CST
- 完成内容：完成 README 分布式计算与存储生产级收口（Gap 1/2/3/4/5）T1（PoS 内核复用收口）。
  - `crates/agent_world_proto/src/distributed_pos.rs`：新增共享 PoS 内核（supermajority 阈值计算、状态判定、加权提议者选择、slot->epoch 映射）。
  - `crates/agent_world_consensus/src/pos.rs`：提议者选择/阈值判定/epoch 计算切换到 `agent_world_proto::distributed_pos`，保留一致错误语义映射。
  - `crates/agent_world_node/src/pos_schedule.rs`、`crates/agent_world_node/src/pos_validation.rs`：复用同一共享内核，消除 node 与 consensus 算法漂移风险。
  - `crates/agent_world_consensus/src/lib.rs`：补齐 `decide_pos_status` 对外导出。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_proto distributed_pos::`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_consensus`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T2：存储挑战门控升级为多样本网络验证与匹配阈值。

- 日期：2026-02-19
- 时刻：2026-02-19 22:34:18 CST
- 完成内容：完成 README 分布式计算与存储生产级收口（Gap 1/2/3/4/5）T2（存储挑战门控多样本验证与阈值）。
  - `crates/agent_world_node/src/lib.rs`：`enforce_storage_challenge_gate` 升级为网络多样本校验；按最近复制内容采样（默认 3），并执行动态阈值判定（`required=min(2, samples)`，至少 1）。
  - `crates/agent_world_node/src/replication.rs`：新增 `recent_replicated_content_hashes`，按最近高度逆序抽样去重的 content hash，为网络挑战门控提供样本输入。
  - `crates/agent_world_node/src/tests.rs`：
    - 现有网络 mismatch 用例增强为同时断言“阈值未达标 + 哈希不匹配”语义。
    - 新增“达到阈值时允许持续提交”回归，覆盖 2/3 匹配通过路径。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_replication_storage_challenge_gate_`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T3：gap sync 升级为分高度重试与错误可观测。

- 日期：2026-02-19
- 时刻：2026-02-19 22:41:56 CST
- 完成内容：完成 README 分布式计算与存储生产级收口（Gap 1/2/3/4/5）T3（gap sync 重试与可观测性）。
  - `crates/agent_world_node/src/lib.rs`：
    - `sync_missing_replication_commits` 从“首错即停/静默 break”升级为“按高度重试（默认 3 次）+ 最终错误上抛”。
    - 新增 `GapSyncHeightOutcome` 与 `sync_replication_height_once`，细分 `NotFound`（非致命）与各类协议/载荷/持久化错误（可观测）。
    - 对“目标高度未找到（found=false）”保持增量语义：停止本轮补洞但不报 fatal error。
  - `crates/agent_world_node/src/tests.rs`：新增并通过以下回归。
    - `runtime_network_replication_gap_sync_not_found_is_non_fatal`
    - `runtime_network_replication_gap_sync_reports_error_after_retries_exhausted`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node runtime_network_replication_gap_sync_`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T4：DistFS sidecar 恢复失败审计落盘并补测试。

- 日期：2026-02-19
- 时刻：2026-02-19 22:46:57 CST
- 完成内容：完成 README 分布式计算与存储生产级收口（Gap 1/2/3/4/5）T4（DistFS sidecar 恢复失败审计）。
  - `crates/agent_world/src/runtime/world/persistence.rs`：
    - 新增审计文件 `distfs.recovery.audit.json` 写入逻辑。
    - sidecar 恢复成功时记录 `status=distfs_restored`。
    - sidecar 恢复失败并回退 JSON 时记录 `status=fallback_json` 与 `reason`。
    - 审计写入错误不阻塞主流程（恢复/回退仍可继续）。
  - `crates/agent_world/src/runtime/tests/persistence.rs`：
    - `persist_writes_distfs_sidecar_and_restores_without_json_files` 新增对恢复审计文件断言。
    - `load_from_dir_falls_back_to_json_when_distfs_sidecar_is_invalid` 新增对回退审计文件断言。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::persistence::persist_writes_distfs_sidecar_and_restores_without_json_files`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::persistence::load_from_dir_falls_back_to_json_when_distfs_sidecar_is_invalid`
- 遗留事项：
  - 执行 T5：`triad_distributed` 最小引导与 gossip 自动发现收口。

- 日期：2026-02-19
- 时刻：2026-02-19 22:57:20 CST
- 完成内容：完成 README 分布式计算与存储生产级收口（Gap 1/2/3/4/5）T5（triad_distributed 最小引导 + gossip 自动发现）。
  - `crates/agent_world/src/bin/world_viewer_live/cli.rs`：`triad_distributed` 参数校验升级为按 `--node-role` 的最小引导语义；sequencer 仅要求自身 bind，storage/observer 角色要求 sequencer bootstrap。
  - `crates/agent_world/src/bin/world_viewer_live.rs`：`start_triad_distributed_live_node` 与默认 replication 网络地址推导复用同一最小引导解析逻辑，sequencer 可零静态 peer 启动。
  - `crates/agent_world_node/src/gossip_udp.rs`、`crates/agent_world_node/src/lib.rs`：UDP gossip 接入来源地址学习（仅对通过世界/版本/签名路径的消息生效），动态加入广播 peer 集。
  - `crates/agent_world/src/bin/world_viewer_live/world_viewer_live_tests.rs`、`crates/agent_world_node/src/tests.rs`：补齐 triad_distributed 最小引导与 gossip 自动发现回归测试。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node gossip_endpoint_learns_inbound_peer_for_followup_broadcasts -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live triad_distributed -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node gossip_ -- --nocapture`
- 遗留事项：
  - 执行 T6：`env -u RUSTC_WRAPPER cargo check` + required-tier 定向测试并完成文档收口。

- 日期：2026-02-19
- 时刻：2026-02-19 23:02:52 CST
- 完成内容：完成 README 分布式计算与存储生产级收口（Gap 1/2/3/4/5）T6（回归验证与文档/devlog 收口）。
  - 执行并通过 `env -u RUSTC_WRAPPER cargo check`，确认当前改动集在工作区默认配置下可编译。
  - 执行并通过与本次改动直接相关的 required-tier 定向测试，覆盖 triad_distributed 最小引导与 gossip 自动发现路径。
  - 更新项目管理文档 `doc/readme-gap-distributed-prod-hardening-gap12345.project.md`：T6 勾选完成，状态切换为“已完成”。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node gossip_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live --features test_tier_required triad_distributed -- --nocapture`
- 遗留事项：
  - 无（本轮 Gap 1/2/3/4/5 已完成收口）。

- 日期：2026-02-19
- 时刻：2026-02-19 23:15:14 CST
- 完成内容：完成 README P1 缺口收口（分布式网络主路径生产化）T0 文档建档。
  - 新增设计文档：`doc/p2p/readme-p1-network-production-hardening.md`。
  - 新增项目管理文档：`doc/p2p/readme-p1-network-production-hardening.project.md`。
  - 项管状态初始化：T0 完成，T1~T3 待执行（进入 T1）。
- 测试：
  - 无（文档任务）。
- 遗留事项：
  - 执行 T1：实现 libp2p request 多 peer 轮换重试 + 无 peer 可控回退策略并补测试。
