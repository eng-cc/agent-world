- 日期：2026-02-18
- 时刻：2026-02-18 09:33:54 CST
- 完成内容：完成 AOSA-1（ABI/Schema 合约约束增强）。
  - 新增设计/项目管理文档：
    - `doc/world-runtime/wasm-agent-os-alignment-hardening.md`
    - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`
  - `crates/agent_world_wasm_abi/src/lib.rs`：新增 `ModuleAbiContract`，并在 `ModuleManifest` 引入 `abi_contract` 默认字段。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：新增 ABI 合约校验（`abi_version` 支持版本校验、输入/输出 schema 配对与非空校验）。
  - 全仓 `ModuleManifest` 构造点补齐 `abi_contract: ModuleAbiContract::default()`，保持兼容。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增 ABI 合约拒绝路径测试（版本不支持、schema 配对缺失）。
  - `crates/agent_world/src/runtime/modules.rs`、`crates/agent_world/src/runtime/mod.rs`：补齐 `ModuleAbiContract` 导出。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-1 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_store`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required shadow_rejects_`
- 遗留事项：
  - 继续执行 AOSA-2：接入 `cap_slot -> cap_ref` 绑定与模块输出解析。

- 日期：2026-02-18
- 时刻：2026-02-18 09:38:20 CST
- 完成内容：完成 AOSA-2（cap slot 绑定）。
  - `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleEffectIntent` 新增可选 `cap_slot`。
  - `crates/agent_world_wasm_sdk/src/lib.rs`：SDK wire `ModuleEffectIntent` 同步新增可选 `cap_slot`。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：
    - 输出处理支持 `cap_slot -> cap_ref` 解析。
    - 若 slot 未绑定、slot 与 `cap_ref` 冲突、或解析后 cap 不在 `required_caps`，统一按 `CapsDenied` 拒绝。
    - `abi_contract.cap_slots` 增加 manifest 校验（slot/cap 非空、且 cap 必须属于 `required_caps`）。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增 slot 成功路径与拒绝路径测试，并补充 cap slot manifest 约束测试。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-2 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_sdk --features wire`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required cap_slot`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
- 遗留事项：
  - 继续执行 AOSA-3：接入 pure 模块策略插件链路。

- 日期：2026-02-18
- 时刻：2026-02-18 09:43:53 CST
- 完成内容：完成 AOSA-3（pure 模块策略插件链路）。
  - `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleAbiContract` 新增 `policy_hooks`。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：
    - 模块调用链路拆分为 raw call + output processing。
    - 在 effect 入队前执行 pure policy hooks 链：
      - 通过 pure 模块 `call` 接口接收策略输入（source/effect/cap 信息）；
      - 约定 `policy.allow` / `policy.deny` emit 表示判定；
      - deny 或异常统一转 `PolicyDenied`。
    - 对 hook 输出施加约束（禁止 state/effects、多 emit）。
    - 对 hook 声明施加 shadow 校验（非空、禁止自引用）。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增 pure policy allow/deny 闭环测试。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-3 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required pure_policy_hook`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
- 遗留事项：
  - 继续执行 AOSA-5：增强 `ModuleContext` 元信息并贯通 event/action/economy 路径。

- 日期：2026-02-18
- 时刻：2026-02-18 09:48:20 CST
- 完成内容：完成 AOSA-5（`ModuleContext` 元信息增强）。
  - `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleContext` 新增可选字段：
    - `stage`、`manifest_hash`、`journal_height`、`module_version`、`module_kind`、`module_role`。
  - `crates/agent_world_wasm_sdk/src/lib.rs`：SDK `wire::ModuleContext` 同步新增可选元信息字段（向后兼容）。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：
    - event/action/module_policy 路径填充新元信息字段；
    - 增加 `subscription_stage_label/module_kind_label/module_role_label` 辅助映射。
  - `crates/agent_world/src/runtime/world/economy.rs`：economy action wasm 调用路径填充新元信息字段。
  - `crates/agent_world/src/simulator/kernel/mod.rs`：模拟器 pre_action wasm 调用路径填充 stage 与兼容空元信息。
  - `crates/agent_world/tests/module_input_cbor.rs`：扩展输入断言，覆盖新增 context 字段（event/action/pure）。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-5 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_sdk --features wire`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test module_input_cbor --features test_tier_full`
- 遗留事项：
  - 继续执行 AOSA-6：WasmExecutor 磁盘编译缓存。

- 日期：2026-02-18
- 时刻：2026-02-18 09:53:30 CST
- 完成内容：完成 AOSA-6（`WasmExecutor` 磁盘编译缓存）。
  - `crates/agent_world_wasm_executor/src/lib.rs`：
    - `WasmExecutorConfig` 新增 `compiled_cache_dir: Option<PathBuf>`，可配置磁盘缓存目录。
    - `WasmExecutor` 新增可选 `compiled_disk_cache`，初始化时按执行器配置构建引擎指纹目录。
    - `compile_module_cached` 新增磁盘缓存读写链路：内存缓存未命中时尝试从磁盘反序列化命中；编译成功后将序列化产物写入磁盘缓存。
    - 新增 `DiskCompiledModuleCache`（key 清洗、按引擎指纹分目录）与相关 helper。
    - 磁盘缓存读取失败或反序列化失败时自动删除损坏文件并回退到重新编译。
  - 新增测试：
    - `wasm_executor_disk_cache_hits_when_memory_cache_disabled`
    - `wasm_executor_disk_cache_recovers_from_corruption`
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-6 状态并标记五项任务全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_executor --features wasmtime`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --features wasmtime`
- 遗留事项：
  - 当前五项任务已全部完成；后续按新需求再开启下一轮对齐任务。

- 日期：2026-02-18
- 时刻：2026-02-18 10:23:32 CST
- 完成内容：完成“required 接入 m1 builtin wasm hash 校验”任务。
  - 新增设计文档：`doc/testing/ci-required-m1-wasm-hash-check.md`。
  - 新增项目管理文档：`doc/testing/ci-required-m1-wasm-hash-check.project.md`。
  - `scripts/ci-tests.sh`：
    - `run_required_gate_checks` 增加 m1 校验钩子；
    - 在 `CI=true` 或 `AGENT_WORLD_FORCE_M1_WASM_CHECK=1` 时执行 `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`；
    - 非 CI 默认跳过并打印提示，避免本地环境差异导致 required 全流程阻塞。
  - 项目管理文档回写：任务状态更新为已完成。
- 测试：
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`（通过）
  - `CI=true ./scripts/ci-tests.sh required`（触发 m1 校验分支；在本机因 `m1.rule.move` hash 与清单不一致失败，符合当前环境现状）
- 遗留事项：
  - 如需在本机也强制执行 m1 校验，可使用 `AGENT_WORLD_FORCE_M1_WASM_CHECK=1 ./scripts/ci-tests.sh required`；
  - 当前本机 m1 校验失败项：`m1.rule.move`（built `8aec...` vs manifest `7e64...`）。

- 日期：2026-02-18
- 时刻：2026-02-18 10:31:47 CST
- 完成内容：完成“required 本地提交前强制执行 m1 wasm hash 校验”收口任务。
  - `scripts/ci-tests.sh`：
    - `run_required_builtin_wasm_checks` 改为无条件执行 `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`；
    - `required/full` 均通过 `run_required_gate_checks` 覆盖 m1 校验。
  - 文档更新：
    - `doc/testing/ci-required-m1-wasm-hash-check.md`：口径改为“本地与 CI 均强制执行”；
    - `doc/testing/ci-required-m1-wasm-hash-check.project.md`：任务拆解与状态回写为完成。
  - 执行 `./scripts/sync-m1-builtin-wasm-artifacts.sh`，同步当前 m1 hash 清单（`m1.rule.move` 更新为 `8aec...`）并完成 DistFS hydration。
- 测试：
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`（通过）
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`（通过，包含 m1 校验）
- 遗留事项：
  - 观察 GitHub Actions `required-gate` 在 Ubuntu runner 的 m1 校验是否与本次同步后的清单一致。

- 日期：2026-02-18
- 时刻：2026-02-18 10:53:37 CST
- 完成内容：完成“required-gate 跨平台 m1 wasm hash 兼容修复（CI 失败收口）”任务。
  - `scripts/sync-m1-builtin-wasm-artifacts.sh`：
    - manifest 解析支持 `module_id hash1 hash2 ...`；
    - `--check` 改为 built hash 命中任一 hash 即通过；
    - 非 `--check` 同步模式改为“合并已有 hash + 当前构建 hash 并去重”，不再覆盖单值。
  - `crates/agent_world_distfs/src/bin/hydrate_builtin_wasm.rs`：
    - 支持多 hash manifest；
    - hydration 使用 built wasm 实际 sha256 作为入库 key；
    - 若 built hash 不在 manifest 允许列表则报错。
  - `crates/agent_world/src/runtime/builtin_wasm_materializer.rs`：
    - `load_builtin_wasm_with_fetch_fallback` 改为接收候选 hash 列表；
    - DistFS 命中 / fetch fallback / compile fallback 全部支持“任一候选 hash”匹配。
  - `crates/agent_world/src/runtime/m1_builtin_wasm_artifact.rs`、`crates/agent_world/src/runtime/m4_builtin_wasm_artifact.rs`：builtin manifest 解析改为 hash 列表。
  - `crates/agent_world/src/runtime/tests/builtin_wasm_materializer.rs`：测试改为断言实际产物 hash 属于 manifest 候选集合。
  - `crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules.sha256`：补充 Linux runner hash，与现有 macOS hash 并存。
  - 文档回写：
    - `doc/testing/ci-required-m1-wasm-hash-check.md`
    - `doc/testing/ci-required-m1-wasm-hash-check.project.md`
- 测试：
  - `bash -n scripts/sync-m1-builtin-wasm-artifacts.sh`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full materializer_fetch_miss_falls_back_to_compile_and_caches_blob -- --exact`
- 遗留事项：
  - 观察 GitHub Actions `required-gate`（Ubuntu runner）在本次多 hash 清单下是否恢复通过。

- 日期：2026-02-18
- 时刻：2026-02-18 11:10:39 CST
- 完成内容：完成“builtin wasm 构建确定性护栏”任务。
  - 新增设计/项目管理文档：
    - `doc/testing/wasm-build-determinism-guard.md`
    - `doc/testing/wasm-build-determinism-guard.project.md`
  - `scripts/build-wasm-module.sh`：
    - 新增 deterministic guard（默认启用）并强制 canonical 输入：
      - `AGENT_WORLD_WASM_TOOLCHAIN=nightly-2025-12-11`
      - `AGENT_WORLD_WASM_TARGET=wasm32-unknown-unknown`
      - `AGENT_WORLD_WASM_BUILD_STD=1`
      - `AGENT_WORLD_WASM_BUILD_STD_COMPONENTS=std,panic_abort`
      - `AGENT_WORLD_WASM_BUILD_STD_FEATURES=`（空）
    - 拦截继承环境变量以避免本地/CI 漂移（`RUSTFLAGS`、`CARGO_ENCODED_RUSTFLAGS`、`CARGO_BUILD_RUSTFLAGS`、`CARGO_TARGET_DIR`、`RUSTC_BOOTSTRAP` 等）。
    - 统一导出复现友好环境：`CARGO_INCREMENTAL=0`、`SOURCE_DATE_EPOCH=0`、`TZ=UTC`、`LANG/LC_ALL=C`。
  - `tools/wasm_build_suite/src/lib.rs`：
    - `cargo metadata` 与 `cargo build` 增加 `--locked`。
    - 新增 workspace 编译期拦截：默认拒绝 workspace 本地 package 含 `build.rs(custom-build)` 或 `proc-macro` 目标，防止编译期环境/时间/主机信息耦合进入 wasm 模块构建链路。
    - 新增对应单元测试（reject build.rs、allow external proc-macro）。
  - 为 `--locked` 场景补齐模板 lockfile：
    - `tools/wasm_build_suite/templates/minimal_module/Cargo.lock`
- 测试：
  - `bash -n scripts/build-wasm-module.sh`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test --manifest-path tools/wasm_build_suite/Cargo.toml`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 继续观察 CI 上 Linux runner 在新的 deterministic guard 下是否稳定复现 m1/m4 hash 清单。

- 日期：2026-02-18
- 时刻：2026-02-18 11:21:27 CST
- 完成内容：完成“builtin wasm 清单策略收敛为每平台 1 个 canonical hash”任务。
  - 新增设计/项目管理文档：
    - `doc/testing/wasm-platform-canonical-hash-manifest.md`
    - `doc/testing/wasm-platform-canonical-hash-manifest.project.md`
  - `scripts/sync-m1-builtin-wasm-artifacts.sh`：
    - 清单 token 解析支持 `platform=hash`（兼容 legacy 裸 hash）；
    - `--check` 在 keyed 模式下改为仅校验当前平台 canonical hash；
    - 同步模式在 keyed 模式下仅更新当前平台 hash，不再追加任意新 hash；
    - 增加平台集合约束与重复平台校验（默认 `darwin-arm64,linux-x86_64`，可由 `AGENT_WORLD_WASM_CANONICAL_PLATFORMS` 覆盖）。
  - `crates/agent_world/src/runtime/m1_builtin_wasm_artifact.rs`、`crates/agent_world/src/runtime/m4_builtin_wasm_artifact.rs`：清单 token 解析支持 `platform=hash`（兼容 legacy）。
  - `crates/agent_world_distfs/src/bin/hydrate_builtin_wasm.rs`：manifest 解析支持 `platform=hash` token。
  - `crates/agent_world/src/runtime/tests/builtin_wasm_materializer.rs`：测试清单解析支持 `platform=hash` token。
  - `crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules.sha256`：迁移为 keyed 格式（`darwin-arm64=... linux-x86_64=...`）。
- 测试：
  - `bash -n scripts/sync-m1-builtin-wasm-artifacts.sh`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full materializer_fetch_miss_falls_back_to_compile_and_caches_blob -- --exact`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 后续若需要支持新平台（如 `linux-arm64`）需先将平台键加入 `AGENT_WORLD_WASM_CANONICAL_PLATFORMS` 并补齐对应 canonical hash。

- 日期：2026-02-18
- 时刻：2026-02-18 11:35:13 CST
- 完成内容：完成 MMD9.1（TODO-22）`execute_until` 动作匹配补齐，修复 `mine_compound/refine_compound` 路径在动作失败后仍继续 auto step 的问题。
  - 代码：`crates/agent_world/src/simulator/llm_agent/execution_controls.rs`
  - 变更：`actions_same` 新增 `mine_compound/refine_compound` 匹配，并放宽 `harvest_radiation/schedule_recipe` 对参数差异的匹配（保留关键标识匹配），确保 `update_from_action_result` 能准确消费拒绝回执。
- 完成内容：补齐 required-tier 回归测试并通过。
  - 测试文件：`crates/agent_world/src/simulator/llm_agent/tests_part2.rs`
  - 新增用例：`llm_agent_execute_until_stops_on_action_rejected_for_mine_compound`
- 完成内容：更新 MMD9 增量文档与项目状态，标记 MMD9.1 完成。
  - 文档：
    - `doc/world-simulator/llm-industrial-mining-debug-tools.md`
    - `doc/world-simulator/llm-industrial-mining-debug-tools.project.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_execute_until_stops_on_ --features test_tier_required -- --nocapture`
- 遗留事项：
  - 继续执行 MMD9.2（TODO-23）：补 `schedule_recipe` 工厂-配方兼容校验与 kernel 回归。

- 日期：2026-02-18
- 时刻：2026-02-18 11:42:06 CST
- 完成内容：完成 MMD9.2（TODO-23）`schedule_recipe` 工厂-配方兼容校验，阻断 power factory 调度 assembler recipe。
  - 代码：`crates/agent_world/src/simulator/kernel/actions.rs`
  - 变更：`RecipePlan` 增加 `required_factory_kind`，`Action::ScheduleRecipe` 在配方解析后新增工厂类型匹配校验；当前 assembler 配方统一要求 `factory.assembler.mk1`。
- 完成内容：补齐 kernel 回归测试并通过。
  - 测试文件：`crates/agent_world/src/simulator/tests/kernel.rs`
  - 新增用例：`schedule_recipe_rejects_incompatible_factory_kind`
- 完成内容：更新项目管理文档状态，标记 MMD9.2 与 TODO-23 完成。
  - 文档：`doc/world-simulator/llm-industrial-mining-debug-tools.project.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world schedule_recipe_ --features test_tier_required -- --nocapture`
- 遗留事项：
  - 继续执行 MMD9.3（TODO-24）：增加采矿失败记忆优先级，减少耗尽矿点重复重试。

- 日期：2026-02-18
- 时刻：2026-02-18 11:47:30 CST
- 完成内容：完成 MMD9.3（TODO-24）采矿失败记忆优先级改造，降低连续失败矿点的重复重试概率。
  - 代码：
    - `crates/agent_world/src/simulator/llm_agent.rs`
    - `crates/agent_world/src/simulator/llm_agent/behavior_loop.rs`
  - 变更：
    - 新增矿点失败 streak 记忆（带时间窗口裁剪），并在 `find_alternative_mine_location` 候选排序中引入失败惩罚优先级；
    - `mine_compound` 成功时清理 streak，耗尽失败时累积 streak 并写入诊断 note（包含 `failure_streak`）。
- 完成内容：补齐回归测试并通过。
  - 测试文件：`crates/agent_world/src/simulator/llm_agent/tests_part2.rs`
  - 新增用例：`llm_agent_prioritizes_mine_alternative_with_lower_failure_streak`
- 完成内容：更新项目管理文档状态，标记 MMD9.3 与 TODO-24 完成。
  - 文档：`doc/world-simulator/llm-industrial-mining-debug-tools.project.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_prioritizes_mine_alternative_with_lower_failure_streak --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world depleted_location --features test_tier_required -- --nocapture`
- 遗留事项：
  - 继续执行 MMD9.4（TODO-25）：guardrail 改写后同步重建 `execute_until.until` 条件并在线抽样复核。

- 日期：2026-02-18
- 时刻：2026-02-18 12:00:03 CST
- 完成内容：完成 MMD9.4（TODO-25）`execute_until` guardrail 改写后 `until` 条件重建，抑制动作类型切换后的自动执行抖动。
  - 代码：
    - `crates/agent_world/src/simulator/llm_agent.rs`
    - `crates/agent_world/src/simulator/llm_agent/execution_controls.rs`
  - 变更：
    - 新增 `default_execute_until_conditions_for_action`，统一按动作类型推导默认 `until` 条件；
    - `apply_execute_until_guardrails` 在 action 类型被改写时自动重建 `until_conditions`（例如 mine->move 时补 `arrive_target` 语义停止条件）。
- 完成内容：补齐回归测试并通过。
  - 测试文件：`crates/agent_world/src/simulator/llm_agent/tests_part2.rs`
  - 新增用例：`llm_agent_rebuilds_execute_until_until_when_mine_is_guardrail_rewritten_to_move`
- 完成内容：完成非 debug 在线抽样复核（120 tick）。
  - 命令：`AGENT_WORLD_LLM_SYSTEM_PROMPT='你是工业闭环调度Agent。每轮只输出一个可执行 tool call 对应的 decision，不输出解释文本。优先形成稳定工业闭环，避免在同一耗尽矿点连续重试。' AGENT_WORLD_LLM_SHORT_TERM_GOAL='120 tick 内完成：1) build_factory(factory.power.radiation.mk1) 成功>=1；2) build_factory(factory.assembler.mk1) 成功>=1；3) schedule_recipe 成功覆盖 recipe.assembler.control_chip / recipe.assembler.motor_mk1 / recipe.assembler.logistics_drone 各>=1。覆盖完成后继续排产，禁止 wait/wait_ticks。恢复规则：electricity不足->harvest_radiation；hardware不足->mine_compound+refine_compound；factory_not_found->build_factory。' AGENT_WORLD_LLM_LONG_TERM_GOAL='维持 harvest_radiation -> mine_compound -> refine_compound -> build_factory -> schedule_recipe 的持续产出闭环，减少 move/mine 抖动和无效重试。' env -u RUSTC_WRAPPER cargo run -p agent_world --bin world_llm_agent_demo -- llm_bootstrap --ticks 120 --report-json output/llm_bootstrap/mmd9_opt_all_factory_all_products_2026-02-18_115214/report.json`
  - 产物：
    - `output/llm_bootstrap/mmd9_opt_all_factory_all_products_2026-02-18_115214/run.log`
    - `output/llm_bootstrap/mmd9_opt_all_factory_all_products_2026-02-18_115214/report.json`
  - 指标：
    - `active_ticks=120`
    - `action_success=96`、`action_failure=24`
    - `parse_errors=0`、`llm_errors=0`
    - `execute_until_continue=23`（对比旧样本 `user_all_factory_all_finished_codex_2026-02-17_185133` 的 33 有所下降）
  - 覆盖结果（`run.log`）：
    - 工厂成功：`factory.power.radiation.mk1=1`、`factory.assembler.mk1=1`
    - recipe 成功：`recipe.assembler.control_chip=2`、`recipe.assembler.motor_mk1=1`、`recipe.assembler.logistics_drone=2`
- 完成内容：更新项目管理文档状态，标记 MMD9.4 与 TODO-25 完成，并记录新观测 TODO-26/27。
  - 文档：`doc/world-simulator/llm-industrial-mining-debug-tools.project.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world execute_until_ --features test_tier_required -- --nocapture`
- 遗留事项：
  - MMD9 已完成；后续可继续处理 TODO-21/26/27（采矿失败压降与 factory 选择误差收敛）。

- 日期：2026-02-18
- 时刻：2026-02-18 12:18:11 CST
- 完成内容：完成 README 对齐收口任务 T0（P0/P1 设计与项目管理文档初始化）。
  - 新增设计文档：`doc/readme-p0-p1-closure.md`。
  - 新增项目管理文档：`doc/readme-p0-p1-closure.project.md`。
  - 项目管理文档已拆解 T1~T4 并标记当前阶段为 T1。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_node`
- 遗留事项：
  - 执行 T1：扩展 node commit/gossip/replication 执行哈希绑定并补齐测试。

- 日期：2026-02-18
- 时刻：2026-02-18 12:22:22 CST
- 完成内容：完成 T1（P0）共识提交与执行状态绑定改造。
  - `crates/agent_world_node/src/gossip_udp.rs`：`GossipCommitMessage` 新增 `execution_block_hash/execution_state_root` 可选字段。
  - `crates/agent_world_node/src/consensus_signature.rs`：commit 签名载荷纳入执行哈希字段，防止提交后执行哈希被篡改。
  - `crates/agent_world_node/src/lib.rs`：
    - commit 广播与 replication 广播统一携带当前高度执行哈希绑定；
    - peer commit ingest 增加执行哈希字段一致性检查；
    - `PeerCommittedHead` 记录执行哈希，便于网络侧观测。
  - `crates/agent_world_node/src/replication.rs`：`ReplicatedCommitPayload` 新增执行哈希字段，并在本地 commit 复制消息构造时落盘。
  - `crates/agent_world_node/src/tests.rs`：新增 3 个测试：
    - `commit_signature_covers_execution_hashes`
    - `pos_engine_ingests_commit_execution_hashes`
    - `replication_commit_payload_includes_execution_hashes`
  - `doc/readme-p0-p1-closure.project.md`：回写 T1 状态为完成，推进到 T2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 执行 T2：实现 viewer live 共识执行高度门控（默认开启）。

- 日期：2026-02-18
- 时刻：2026-02-18 12:28:06 CST
- 完成内容：完成 T2（P1-A）viewer live 共识执行高度门控。
  - `crates/agent_world/src/viewer/live.rs`：
    - `ViewerLiveServerConfig` 新增 `consensus_gate_max_tick`；
    - server 主循环增加 `can_step_for_consensus` 门控，超前于门控高度时不再推进本地 world step；
    - `LiveWorld` 新增可选门控状态与 `new_with_consensus_gate` 构造路径。
  - `crates/agent_world/src/bin/world_viewer_live.rs`：
    - 新增 `ConsensusGateWorker`，周期读取 embedded node snapshot，将允许 tick 高度同步到 viewer；
    - 启动/停止流程接入门控 worker，viewer config 注入门控引用。
  - `crates/agent_world/src/bin/world_viewer_live/cli.rs`：
    - 新增 `viewer_consensus_gate` 选项（默认开启）；
    - 新增 `--viewer-no-consensus-gate` 调试开关；
    - `--no-node` 时自动关闭门控（显式进入非共识调试模式）。
  - `crates/agent_world/src/viewer/live/tests.rs`：新增 `live_world_consensus_gate_limits_step_budget`。
  - `crates/agent_world/src/bin/world_viewer_live/world_viewer_live_tests.rs`：补充 CLI 门控选项测试与默认断言。
  - `doc/readme-p0-p1-closure.project.md`：回写 T2 状态为完成，推进到 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required live_world_consensus_gate_limits_step_budget`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required world_viewer_live_tests::parse_options_`
- 遗留事项：
  - 执行 T3：新增 runtime 内模块部署/安装动作闭环（Deploy + Install）。

- 日期：2026-02-18
- 时刻：2026-02-18 12:38:52 CST
- 完成内容：完成 T3（P1-B）runtime 模块部署/安装动作闭环。
  - `crates/agent_world/src/runtime/events.rs`：新增动作 `DeployModuleArtifact` / `InstallModuleFromArtifact`，新增领域事件 `ModuleArtifactDeployed` / `ModuleInstalled`。
  - `crates/agent_world/src/runtime/world/module_actions.rs`：新增 `try_apply_runtime_module_action`，复用既有 `register_module_artifact + propose/shadow/approve/apply` 治理链路打通安装闭环；失败统一回落 `ActionRejected`。
  - `crates/agent_world/src/runtime/world/event_processing.rs`：新增新动作兜底拒绝分支（避免绕开 runtime 动作闭环）。
  - `crates/agent_world/src/runtime/world/step.rs`：`step` 与 `step_with_modules` 接入 runtime 模块动作专门分支，普通动作维持原有 `action_to_event` 路径。
  - `crates/agent_world/src/runtime/world/module_runtime.rs` / `crates/agent_world/src/runtime/world/module_runtime_labels.rs`：补充新动作/事件 kind label，并拆分标签逻辑文件保证单文件行数约束。
  - `crates/agent_world/src/runtime/state.rs`：新增事件状态应用分支，维护 agent `last_active`。
  - `crates/agent_world/src/runtime/world/mod.rs`：注册新增 runtime world 子模块。
  - 新增测试文件 `crates/agent_world/src/runtime/tests/module_action_loop.rs`（5 个用例），`crates/agent_world/src/runtime/tests/mod.rs` 注册测试模块。
  - `doc/readme-p0-p1-closure.project.md`：回写 T3 状态为完成，推进到 T4。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::modules::apply_module_changes_registers_and_activates`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required runtime::tests::economy_module_requests::build_factory_with_module_request_exposes_available_inputs_by_ledger`
- 遗留事项：
  - 执行 T4：完成回归 `cargo check` 与文档收口。

- 日期：2026-02-18
- 时刻：2026-02-18 12:44:51 CST
- 完成内容：完成 T4（README 对齐收口回归与文档闭环）。
  - 执行全量编译回归：`env -u RUSTC_WRAPPER cargo check`。
  - 执行 node 回归：`env -u RUSTC_WRAPPER cargo test -p agent_world_node`（覆盖 T1 的 commit/execution 绑定测试）。
  - 结合 T3 提交前门禁（required-tier）结果，确认 `agent_world` required 测试与 wasm target check 均通过。
  - `doc/readme-p0-p1-closure.project.md`：回写 T4 状态为完成，项目阶段更新为 T0~T4 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
- 遗留事项：
  - 无（README 对齐 P0/P1 收口完成，等待新需求）。

- 日期：2026-02-18
- 时刻：2026-02-18 13:11:51 CST
- 完成内容：完成 README 高优先级缺口收口任务 T0（文档初始化）。
  - 新增设计文档：`doc/readme-gap12-market-closure.md`。
  - 新增项目管理文档：`doc/readme-gap12-market-closure.project.md`。
  - 项目管理文档已拆解 T1~T3 并将当前阶段推进到 T1。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
- 遗留事项：
  - 执行 T1：Runtime 模块交易闭环（上架/购买动作 + 事件 + 状态 + 测试）。

- 日期：2026-02-18
- 时刻：2026-02-18 13:19:29 CST
- 完成内容：完成 README 缺口收口任务 T1（Runtime 模块交易闭环）。
  - `crates/agent_world/src/runtime/events.rs`：新增动作 `ListModuleArtifactForSale` / `BuyModuleArtifact`，新增事件 `ModuleArtifactListed` / `ModuleArtifactSaleCompleted`。
  - `crates/agent_world/src/runtime/state.rs`：新增 `module_artifact_owners`、`module_artifact_listings` 与 `ModuleArtifactListingState`，接入上架/成交状态迁移与资源结算。
  - `crates/agent_world/src/runtime/world/module_actions.rs`：新增上架/购买动作执行逻辑，并在 `InstallModuleFromArtifact` 增加 owner 已登记时的安装者约束。
  - `crates/agent_world/src/runtime/world/event_processing.rs`、`crates/agent_world/src/runtime/world/module_runtime_labels.rs`：补齐新动作兜底拒绝与审计标签。
  - `crates/agent_world/src/runtime/tests/module_action_loop.rs`：新增模块交易成功与拒绝路径测试（越权上架、余额不足购买、非 owner 安装）。
  - `doc/readme-gap12-market-closure.project.md`：回写 T1 状态为完成并推进到 T2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
- 遗留事项：
  - 执行 T2：Simulator 动态电价闭环（报价 + 自动定价 + 价格带护栏）。

- 日期：2026-02-18
- 时刻：2026-02-18 13:21:37 CST
- 完成内容：完成 README 缺口收口任务 T2（Simulator 动态电价闭环）。
  - `crates/agent_world/src/simulator/power.rs`：扩展 `PowerConfig` 市场参数；`PowerTransferred` 增加 `quoted_price_per_pu` 与 `settlement_amount` 字段。
  - `crates/agent_world/src/simulator/world_model.rs`：接入新增市场参数 sanitize 逻辑，保证配置边界稳定。
  - `crates/agent_world/src/simulator/kernel/actions.rs`：`transfer_power` 接入动态报价（供需 + 距离）、自动定价（`price_per_pu=0`）、显式价格带护栏与成交结算值输出。
  - `crates/agent_world/src/simulator/tests/power.rs`：新增自动报价成功与超带宽报价拒绝测试用例。
  - `doc/readme-gap12-market-closure.project.md`：回写 T2 状态为完成并推进到 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power -- --nocapture`
- 遗留事项：
  - 执行 T3：全量回归（`cargo check` + 定向测试）并收口文档状态。

- 日期：2026-02-18
- 时刻：2026-02-18 13:23:25 CST
- 完成内容：完成 README 缺口收口任务 T3（回归与文档收口）。
  - 执行全仓编译回归：`env -u RUSTC_WRAPPER cargo check`。
  - 执行定向回归：
    - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power -- --nocapture`
  - `doc/readme-gap12-market-closure.project.md`：回写 T3 状态为完成，项目阶段更新为 T0~T3 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power -- --nocapture`
- 遗留事项：
  - 无（README 高优先级缺口 1/2 已完成收口）。

- 日期：2026-02-18
- 时刻：2026-02-18 13:35:11 CST
- 完成内容：完成 README 二期差距收口任务 T0（模块生命周期 + 单一订单簿撮合）文档初始化。
  - 新增设计文档：`doc/readme-gap34-lifecycle-orderbook-closure.md`。
  - 新增项目管理文档：`doc/readme-gap34-lifecycle-orderbook-closure.project.md`。
  - 项目管理文档已拆解 T1~T3 并推进到 T1。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world`
- 遗留事项：
  - 执行 T1：Runtime 生命周期闭环 + 成本模型（动作/事件/状态/测试）。

- 日期：2026-02-18
- 时刻：2026-02-18 13:43:24 CST
- 完成内容：完成 README 二期差距收口任务 T1（Runtime 生命周期闭环 + 成本模型）。
  - `crates/agent_world/src/runtime/events.rs`：新增动作 `DelistModuleArtifact` / `DestroyModuleArtifact`；新增事件 `ModuleArtifactDelisted` / `ModuleArtifactDestroyed`；为 `ModuleArtifactDeployed` / `ModuleInstalled` / `ModuleArtifactListed` 增加模块动作费用字段（`fee_kind`/`fee_amount`，带 `serde(default)` 兼容）。
  - `crates/agent_world/src/runtime/world/module_actions.rs`：新增生命周期动作执行逻辑（撤销上架、销毁）；新增费用计算与余额校验；销毁时增加“活跃模块引用保护”，并清理 artifact bytes/cache。
  - `crates/agent_world/src/runtime/state.rs`：新增模块动作费用结算（操作者扣费 + 世界资源池入账）；接入新事件状态迁移（delist/destroy）。
  - `crates/agent_world/src/runtime/world/event_processing.rs`、`crates/agent_world/src/runtime/world/module_runtime_labels.rs`：补齐新动作兜底拒绝与审计标签。
  - `crates/agent_world/src/runtime/tests/module_action_loop.rs`：扩展费用断言，新增 delist/destroy 成功与拒绝路径测试。
  - `doc/readme-gap34-lifecycle-orderbook-closure.project.md`：回写 T1 完成并推进到 T2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
- 遗留事项：
  - 执行 T2：单一订单簿撮合（模块 + 电力）与一致性测试。

- 日期：2026-02-18
- 时刻：2026-02-18 14:06:10 CST
- 完成内容：完成 README 二期差距收口任务 T2（单一订单簿撮合：模块 + 电力 + 重放一致性）。
  - Runtime（`crates/agent_world/src/runtime`）：
    - 收敛未完成订单簿改动并补齐编译/借用一致性；
    - 新增模块买单动作闭环：`PlaceModuleArtifactBid` / `CancelModuleArtifactBid`；
    - 扩展成交/挂单事件关联字段：`order_id` / `sale_id` / `listing_order_id` / `bid_order_id`；
    - 落地 listing 自动撮合（按 `price desc -> order_id asc`）并补齐状态约束。
  - Simulator（`crates/agent_world/src/simulator`）：
    - 新增电力订单簿动作：`PlacePowerOrder` / `CancelPowerOrder`；
    - 新增订单簿状态：`PowerOrderBookState`（`next_order_id` + `open_orders`）；
    - 新增订单簿事件：`PowerOrderPlaced` / `PowerOrderCancelled` + `PowerOrderFill`；
    - 内核撮合实现价格优先/时间优先，成交仍通过 `PowerTransferred` 语义结算；
    - 回放路径新增订单簿事件应用与一致性校验（含 fill/cancel/open order 变更约束）。
  - 测试：
    - `module_action_loop`：模块生命周期+撮合回归通过；
    - 新增 `power` 用例覆盖挂单/撤单/撮合与价格/时间优先级；
    - 新增 `consistency` 用例覆盖订单簿事件重放一致性。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required power_order_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required replay_from_snapshot_matches_power_orderbook_sequence -- --nocapture`
- 遗留事项：
  - 执行 T3：回归验证（`cargo check` + 定向 required tests）并回写文档/devlog。

- 日期：2026-02-18
- 时刻：2026-02-18 14:11:09 CST
- 完成内容：完成 README 二期差距收口任务 T3（回归验证与文档收口）。
  - 回归验证执行完成：
    - `env -u RUSTC_WRAPPER cargo check`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
    - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power -- --nocapture`
  - `doc/readme-gap34-lifecycle-orderbook-closure.project.md`：回写 T3 状态为完成，阶段更新为 T0~T3 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required simulator::tests::power -- --nocapture`
- 遗留事项：
  - 无（README 二期高优先级差距 3/4 已完成收口）。

- 日期：2026-02-18
- 时刻：2026-02-18 14:46:12 CST
- 完成内容：完成“间接控制链路 + WASM Tick 生命周期 + 长期记忆持久化”T0 文档任务。
  - 新增设计文档：`doc/indirect-control-tick-lifecycle-long-term-memory.md`
  - 新增项目管理文档：`doc/indirect-control-tick-lifecycle-long-term-memory.project.md`
  - 任务拆解已标注 T1/T2/T3/T4 待执行，下一步进入 T1（间接控制链路）。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：实现 submitter 授权与 viewer player 绑定，补齐拒绝路径测试。

- 日期：2026-02-18
- 时刻：2026-02-18 14:57:20 CST
- 完成内容：完成 T1（间接控制链路 submitter 授权 + viewer player 绑定）。
  - `crates/agent_world/src/simulator/types.rs`：`ActionEnvelope` 增加 `submitter` 字段，新增 `ActionSubmitter`（默认 `System`，兼容旧快照）。
  - `crates/agent_world/src/simulator/kernel/step.rs`：新增 `submit_action_from_system/agent/player`，并在 `step()` 前执行 submitter 授权校验；玩家直提动作拒绝、agent 身份动作做 owner/agent_id 约束。
  - `crates/agent_world/src/simulator/runner.rs`：LLM runner 改为以 `agent` 身份提交动作。
  - `crates/agent_world/src/simulator/world_model.rs`、`crates/agent_world/src/simulator/kernel/mod.rs`、`crates/agent_world/src/simulator/kernel/types.rs`、`crates/agent_world/src/simulator/kernel/replay.rs`：新增并持久化 `agent_player_bindings` 与 `AgentPlayerBound` 事件。
  - `crates/agent_world_proto/src/viewer.rs`、`crates/agent_world/src/viewer/live.rs`：`prompt_control` 改为要求 `player_id`；apply/rollback/chat 增加 player-agent 绑定与一致性校验；`updated_by` 与 `player_id` 一致性校验。
  - `crates/agent_world/src/simulator/tests/submitter_access.rs`、`crates/agent_world/src/viewer/live/tests.rs`、`crates/agent_world/src/simulator/tests/persist.rs`：补充 submitter 拒绝、player 绑定冲突与 replay 持久化回放测试。
  - `doc/indirect-control-tick-lifecycle-long-term-memory.project.md`：回写 T1 状态为完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_proto`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world submitter_access --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world prompt_control_preview_rejects_unbound_player_when_agent_already_bound --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world replay_from_snapshot_applies_agent_player_bound_event --features test_tier_required`
- 遗留事项：
  - 继续执行 T2：实现 wasm `Tick` 生命周期按需调度（wake/suspend）。

- 日期：2026-02-18
- 时刻：2026-02-18 15:18:14 CST
- 完成内容：完成 T2（WASM tick 生命周期按需调度）。
  - ABI/Router：
    - `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleSubscriptionStage` 新增 `Tick`，`ModuleOutput` 新增可选 `tick_lifecycle`（`WakeAfterTicks`/`Suspend`）。
    - `crates/agent_world_wasm_router/src/lib.rs`：补齐 Tick stage 组合校验。
  - Runtime：
    - `crates/agent_world/src/runtime/world/module_tick_runtime.rs`：新增模块 tick 调度器（到期路由、激活同步、停用移除）。
    - `crates/agent_world/src/runtime/world/step.rs`：每个世界 tick 末尾执行 `route_tick_to_modules`。
    - `crates/agent_world/src/runtime/world/module_runtime.rs`、`mod.rs`、`persistence.rs`、`snapshot.rs`：接入调度表状态并持久化 `module_tick_schedule`。
    - `crates/agent_world/src/runtime/world/module_runtime_labels.rs`：补齐 `tick` 阶段标签。
  - SDK/模块与测试：
    - `crates/agent_world_wasm_sdk/src/lib.rs`、`crates/agent_world_wasm_executor/src/lib.rs` 及内置 wasm 模块同步 `tick_lifecycle` 字段。
    - 新增/更新 `crates/agent_world/src/runtime/tests/modules.rs` 与 router 测试，覆盖 wake/suspend 与 stage 约束。
    - 同步 builtin wasm hash 清单：`m1_builtin_modules.sha256`、`m4_builtin_modules.sha256`。
  - 文档：
    - `doc/indirect-control-tick-lifecycle-long-term-memory.project.md` 回写 T2 完成状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world step_with_modules_routes_tick_lifecycle_with_wake_and_suspend --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_router validate_subscription_stage_rejects_invalid_combinations`
- 遗留事项：
  - 执行 T3：实现长期记忆导出/恢复与 live 回写持久化闭环。

- 日期：2026-02-18
- 时刻：2026-02-18 15:27:20 CST
- 完成内容：完成 T3（长期记忆持久化：导出/恢复 + live 同步 + 持久化）。
  - `crates/agent_world/src/simulator/world_model.rs`：
    - 新增 `agent_long_term_memories`（`agent_id -> Vec<LongTermMemoryEntry>`）并启用默认/空映射兼容序列化。
  - `crates/agent_world/src/simulator/memory.rs`：
    - 新增长期记忆 `export_entries/restore_entries`；
    - 恢复逻辑包含 `importance` 归一化、`last_accessed` 修正、容量裁剪与 `next_id` 重建；
    - `AgentMemory` 新增长期记忆导出/恢复封装方法。
  - `crates/agent_world/src/simulator/llm_agent.rs`：
    - `LlmAgentBehavior` 新增长期记忆导出/恢复接口。
  - `crates/agent_world/src/simulator/kernel/mod.rs`：
    - 新增 `set_agent_long_term_memory` 与 `long_term_memory_for_agent`，用于内核模型读写长期记忆。
  - `crates/agent_world/src/viewer/live.rs`：
    - LLM driver 构建阶段从 `WorldModel` 恢复长期记忆；
    - 每次 LLM tick 后将 runner 内长期记忆回写到 `WorldModel`，纳入 snapshot 持久化状态。
  - 测试补齐：
    - `crates/agent_world/src/simulator/tests/memory.rs`：新增长期记忆导出恢复/next_id 回归；
    - `crates/agent_world/src/simulator/llm_agent/tests_part2.rs`：新增 behavior 导出恢复回归；
    - `crates/agent_world/src/simulator/tests/persist.rs`：新增 snapshot roundtrip 长期记忆保真回归；
    - `crates/agent_world/src/viewer/live/tests.rs`：新增 live 恢复/回写路径回归。
  - 文档：
    - `doc/indirect-control-tick-lifecycle-long-term-memory.project.md` 回写 T3 完成状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required long_term_memory_export_restore_roundtrip_preserves_entries_and_next_id`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required agent_memory_restores_long_term_entries`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_long_term_memory_can_export_and_restore`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required kernel_snapshot_roundtrip_preserves_agent_long_term_memories`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required restore_behavior_long_term_memory_from_model_applies_persisted_entries`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required sync_llm_runner_long_term_memory_writes_back_to_world_model`
- 遗留事项：
  - 执行 T4：回归验证（`cargo check` + 定向 tests）并完成文档收口。

- 日期：2026-02-18
- 时刻：2026-02-18 15:29:24 CST
- 完成内容：完成 T4（回归验证与文档收口）。
  - 回归验证：
    - `cargo check` 全仓通过；
    - 定向覆盖三条主链路：
      - 间接控制链路：`submitter_access`；
      - wasm tick 生命周期链路：`step_with_modules_routes_tick_lifecycle_with_wake_and_suspend`；
      - 长期记忆 live 回写链路：`sync_llm_runner_long_term_memory_writes_back_to_world_model`。
  - 文档收口：
    - `doc/indirect-control-tick-lifecycle-long-term-memory.project.md` 标记 T4 完成，阶段状态改为全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required submitter_access`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required step_with_modules_routes_tick_lifecycle_with_wake_and_suspend`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required sync_llm_runner_long_term_memory_writes_back_to_world_model`
- 遗留事项：
  - 无（本轮 T0~T4 全部完成）。

- 日期：2026-02-18
- 时刻：2026-02-18 18:05:35 CST
- 完成内容：完成“Rust 超限文件拆分”T0 文档任务。
  - 新增设计文档：`doc/oversized-rust-file-splitting.md`
  - 新增项目管理文档：`doc/oversized-rust-file-splitting.project.md`
  - 任务拆解覆盖 T1~T3（`llm_agent.rs` 拆分、`viewer/live.rs` 拆分、统一回归收口）。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：拆分 `crates/agent_world/src/simulator/llm_agent.rs` 并做定向回归。

- 日期：2026-02-18
- 时刻：2026-02-18 18:08:42 CST
- 完成内容：完成“Rust 超限文件拆分”T1（`llm_agent.rs` 拆分）。
  - `crates/agent_world/src/simulator/llm_agent.rs`：
    - 新增子模块声明：`behavior_prompt`、`behavior_guardrails`、`behavior_runtime_helpers`；
    - 主文件保留类型定义与构造/入口方法，行数降至 883（<=1200）。
  - 新增文件：
    - `crates/agent_world/src/simulator/llm_agent/behavior_prompt.rs`
    - `crates/agent_world/src/simulator/llm_agent/behavior_guardrails.rs`
    - `crates/agent_world/src/simulator/llm_agent/behavior_runtime_helpers.rs`
  - 说明：
    - 将原 `LlmAgentBehavior` 大段实现按职责迁移到三组 `impl` 文件；
    - 为跨子模块调用一致性，将迁移方法统一为 `pub(super)` 可见性；
    - 未调整外部 API 与行为语义。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_repair_round_can_recover_invalid_output`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_long_term_memory_can_export_and_restore`
- 遗留事项：
  - 执行 T2：拆分 `crates/agent_world/src/viewer/live.rs` 并做定向回归。

- 日期：2026-02-18
- 时刻：2026-02-18 18:11:33 CST
- 完成内容：完成“Rust 超限文件拆分”T2（`viewer/live.rs` 拆分）。
  - `crates/agent_world/src/viewer/live.rs`：
    - 新增 `mod live_helpers;` 并通过 `use live_helpers::*;` 接入辅助函数；
    - 将 prompt/player 校验、profile digest、LLM memory 同步等 helper 迁移到子模块；
    - 主文件行数降至 1173（<=1200）。
  - 新增文件：
    - `crates/agent_world/src/viewer/live/live_helpers.rs`（203 行）。
  - 说明：
    - helper 函数统一改为 `pub(super)`，仅对 `viewer::live` 模块内可见；
    - 对外 server 行为与协议不变。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required prompt_control_preview_reports_fields_and_next_version`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required restore_behavior_long_term_memory_from_model_applies_persisted_entries`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required sync_llm_runner_long_term_memory_writes_back_to_world_model`
- 遗留事项：
  - 执行 T3：统一回归（`cargo check` + 定向 tests）并收口文档。

- 日期：2026-02-18
- 时刻：2026-02-18 18:13:23 CST
- 完成内容：完成“Rust 超限文件拆分”T3（统一回归与文档收口）。
  - 回归验证：
    - 全仓 `cargo check` 通过；
    - 定向覆盖 `llm_agent` 与 `viewer/live` 关键回归用例通过。
  - 文档收口：
    - `doc/oversized-rust-file-splitting.project.md` 标记 T3 完成并更新整体状态为已完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_repair_round_can_recover_invalid_output`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required prompt_control_preview_reports_fields_and_next_version`
- 遗留事项：
  - 无（本轮拆分任务 T0~T3 全部完成）。

- 日期：2026-02-18
- 时刻：2026-02-18 18:53:02 CST
- 完成内容：完成 README 缺口 1/2/3 收口任务的 T0（文档阶段）。
  - 新增设计文档：`doc/readme-gap123-runtime-consensus-metering.md`。
  - 新增项目管理文档：`doc/readme-gap123-runtime-consensus-metering.project.md`。
  - 明确三项实现边界：世界内编译、共识动作载荷、WASM 按次计费。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 开始执行 T1：实现 `CompileModuleArtifactFromSource` 并补齐 required 测试。

- 日期：2026-02-18
- 时刻：2026-02-18 19:01:05 CST
- 完成内容：完成 README 缺口收口三期 T1（世界内 Rust->WASM 编译闭环）。
  - Runtime 新增 `Action::CompileModuleArtifactFromSource` 与 `ModuleSourcePackage`。
  - 新增 `crates/agent_world/src/runtime/module_source_compiler.rs`：
    - source package 路径校验（拒绝绝对路径/非法组件）；
    - 支持 `AGENT_WORLD_MODULE_SOURCE_COMPILER` 自定义编译命令；
    - 默认回退 `scripts/build-wasm-module.sh`。
  - `runtime/world/module_actions.rs`：接入 compile action，完成编译、artifact 注册、扣费与拒绝路径。
  - `runtime/world/event_processing.rs`、`runtime/world/module_runtime_labels.rs`：补齐新 action 路由/标签。
  - `runtime/tests/module_action_loop.rs`：新增 compile 成功路径与 manifest 缺失拒绝路径测试。
  - `doc/readme-gap123-runtime-consensus-metering.project.md`：回写 T1 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required compile_module_artifact_from_source_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_action_loop -- --nocapture`
- 遗留事项：
  - 开始执行 T2：共识层携带有序动作载荷，并将提交动作透传给 execution hook。

- 日期：2026-02-18
- 时刻：2026-02-18 19:17:43 CST
- 完成内容：完成 README 缺口收口三期 T2（共识动作载荷链路贯通）。
  - `agent_world_node` 新增 `NodeConsensusAction` 与 `action_root` 计算/校验：
    - 新文件 `crates/agent_world_node/src/consensus_action.rs`；
    - `NodeRuntime` 支持 `submit_consensus_action_payload(action_id, payload_cbor)`，主循环按 tick 合并排队动作；
    - `PosNodeEngine` 提案阶段携带有序动作并将 `action_root` 纳入区块哈希；
    - 拒绝决议会将动作重新并回 pending，提交/提案消息均做 `action_root` 校验。
  - 共识传播链路补齐动作字段：
    - `gossip_udp` 的 proposal/commit 消息新增 `action_root` + `actions`（含 `serde(default)` 兼容）；
    - `consensus_signature` 将动作字段纳入 proposal/commit 签名载荷；
    - `replication` 提交 payload 写入 `action_root` + `actions`。
  - 执行层贯通：
    - `NodeExecutionCommitContext` 新增 `action_root` 与 `committed_actions`；
    - `world_viewer_live` 执行桥在 commit 时校验连续高度与 `action_root`，按提交动作 CBOR 解码为 runtime `Action` 并注入 world 后再 `step()`。
  - 测试与结构整理：
    - 新增 `crates/agent_world_node/src/tests_action_payload.rs`；
    - 覆盖 execution hook 收到有序动作、非法 action_id 拒绝；
    - 将 `role_parse_roundtrip`、`config_rejects_invalid_pos_config` 迁移到新测试文件，`tests.rs` 控制在 1198 行。
  - 项目文档：`doc/readme-gap123-runtime-consensus-metering.project.md` 标记 T2 完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --bin world_viewer_live`
- 遗留事项：
  - 开始执行 T3：实现 WASM 模块按次计费、可审计计费事件与余额不足拒绝。

- 日期：2026-02-18
- 时刻：2026-02-18 19:29:03 CST
- 完成内容：完成 README 缺口收口三期 T3（WASM 模块按次计费 + 可审计事件 + 余额不足拒绝）。
  - Runtime 计费事件：
    - 在 `crates/agent_world/src/runtime/world_event.rs` 新增 `ModuleRuntimeChargeEvent` 与 `WorldEventBody::ModuleRuntimeCharged`。
    - `audit` 增加 `AuditEventKind::ModuleRuntimeCharged`，`module_runtime_labels` 增加 `module.runtime_charged` 标签。
  - 模块调用计费链路：
    - `execute_module_call` 将输入字节长度传入输出处理路径；
    - 在 `process_module_output` 中引入计费前置检查：按公式计算 compute/data 与 electricity 费用；
    - 仅当 artifact owner 可解析为现存 agent 时执行扣费；
    - 余额不足直接落 `ModuleCallFailed`，并阻断 `ModuleStateUpdated/EffectQueued/ModuleEmitted`。
  - 回放与落账：
    - `event_processing` 新增 `ModuleRuntimeCharged` 回放分支；
    - 新文件 `crates/agent_world/src/runtime/world/module_runtime_metering.rs` 负责扣费落账（agent 扣减 + treasury 入账）与计费计算。
  - 结构约束处理：
    - 将计费实现拆分到 `module_runtime_metering.rs`，避免 `module_runtime.rs` 超过 1200 行（当前 1169 行）。
  - 新增 required 测试：
    - `crates/agent_world/src/runtime/tests/module_runtime_metering.rs`
      - 计费成功路径（事件字段/账户扣减/treasury 入账）
      - 余额不足拒绝路径（仅 `ModuleCallFailed`，不落输出）
    - `crates/agent_world/src/runtime/tests/mod.rs` 注册新测试模块。
  - 项目文档：`doc/readme-gap123-runtime-consensus-metering.project.md` 标记 T3 完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_runtime_metering -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_call_ -- --nocapture`
- 遗留事项：
  - 开始执行 T4：进行收口回归验证并完成本轮文档收口。

- 日期：2026-02-18
- 时刻：2026-02-18 19:31:11 CST
- 完成内容：完成 README 缺口收口三期 T4（回归验证与文档收口）。
  - 回归验证：
    - 全仓 `cargo check` 通过；
    - 按缺口链路执行定向 required tests：
      - 缺口 1：`compile_module_artifact_from_source_*`；
      - 缺口 2：`tests_action_payload::*`；
      - 缺口 3：`module_runtime_metering*`。
  - 文档收口：
    - `doc/readme-gap123-runtime-consensus-metering.project.md` 标记 T4 完成并更新整体状态为已完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required compile_module_artifact_from_source_ -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_node tests_action_payload:: -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required module_runtime_metering -- --nocapture`
- 遗留事项：
  - 无（本轮 README 缺口 1/2/3 的 T0~T4 全部完成）。

- 日期：2026-02-18
- 时刻：2026-02-18 20:09:12 CST
- 完成内容：完成社会系统生产级方案 T1（数据结构与协议扩展）。
  - `crates/agent_world/src/simulator/social.rs`：新增社会领域核心结构（fact/edge/challenge/stake/lifecycle）。
  - `crates/agent_world/src/simulator/types.rs`：新增 `PublishSocialFact/ChallengeSocialFact/AdjudicateSocialFact/RevokeSocialFact/DeclareSocialEdge` 动作。
  - `crates/agent_world/src/simulator/kernel/types.rs`：新增 `SocialFact*` / `SocialEdge*` 事件类型。
  - `crates/agent_world/src/simulator/world_model.rs`：新增社会状态字段（facts/edges/next ids/stake pool）。
  - `crates/agent_world/src/simulator/mod.rs`、`crates/agent_world/src/simulator/llm_agent/behavior_prompt.rs`：补齐导出与 action 名称映射。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：进入 T2，补齐 kernel 执行语义与生命周期。

- 日期：2026-02-18
- 时刻：2026-02-18 20:10:15 CST
- 完成内容：完成社会系统生产级方案 T2（kernel 动作处理与生命周期）。
  - 新增 `crates/agent_world/src/simulator/kernel/social.rs`：实现发布/质疑/仲裁/撤销/声明关系边、stake 结算与到期维护。
  - `crates/agent_world/src/simulator/kernel/actions.rs`：接入新动作分发。
  - `crates/agent_world/src/simulator/kernel/step.rs`：接入提交者权限校验与 `maintain_social_lifecycle()` 调度。
  - `crates/agent_world/src/simulator/kernel/mod.rs`：注册 social kernel 模块。
  - `crates/agent_world_viewer/src/selection_linking.rs`：补齐 social 事件目标解析，保证 viewer target wasm check 通过。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：进入 T3，补齐 replay social 事件闭环。

- 日期：2026-02-18
- 时刻：2026-02-18 20:11:06 CST
- 完成内容：完成社会系统生产级方案 T3（replay 对应逻辑）。
  - `crates/agent_world/src/simulator/kernel/replay.rs`：新增 `SocialFactPublished/Challenged/Adjudicated/Revoked/Expired` 与 `SocialEdgeDeclared/Expired` 回放分支。
  - 通过 `replay_social_*` helper 对齐 online 与 replay 状态机行为。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：进入 T4，补齐 social 行为与回放测试。

- 日期：2026-02-18
- 时刻：2026-02-18 20:11:47 CST
- 完成内容：完成社会系统生产级方案 T4（测试补齐）。
  - 新增 `crates/agent_world/src/simulator/tests/social.rs`：覆盖证据校验、stake 结算（Confirm/Retract）、TTL 过期与 backing edge 失效。
  - 新增 `crates/agent_world/src/simulator/tests/social_persist.rs`：覆盖 snapshot replay 下 adjudication/revoke/expiry 一致性。
  - `crates/agent_world/src/simulator/tests/mod.rs`：注册新测试模块。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world social_ --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo fmt --all -- --check`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_viewer --target wasm32-unknown-unknown`
- 遗留事项：进入 T5，更新项目文档与 devlog 收口。

- 日期：2026-02-18
- 时刻：2026-02-18 20:12:48 CST
- 完成内容：完成社会系统生产级方案 T5（项目文档与日志收口）。
  - `doc/world-simulator/social-fact-ledger-declarative-reputation.project.md`：回写 T1~T5 全部完成。
  - `doc/devlog/2026-02-18.md`：追加 T1~T5 任务日志，记录时刻、内容、测试与遗留事项。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
- 遗留事项：无（本期 T0~T5 全部完成）。

- 日期：2026-02-18
- 时刻：2026-02-18 21:54:26 CST
- 完成内容：完成“系统性应用测试手册（Human/AI 通用）”文档任务并收口。
  - 新增设计文档：`doc/testing/systematic-application-testing-manual.md`。
  - 新增项目管理文档：`doc/testing/systematic-application-testing-manual.project.md`。
  - 手册明确 L0/L1/L2/L3 分层测试模型、required/full 映射、Web 闭环与 native fallback 边界、证据产物规范、失败分诊流程与结果记录模板。
  - 目标口径：人类与 AI Agent 均可按同一剧本完成“足够充分”的整应用测试。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 后续可按真实缺陷复盘持续调整 L3 UI smoke 用例配额与断言粒度。

- 日期：2026-02-18
- 时刻：2026-02-18 22:05:02 CST
- 完成内容：按“针对仓库当前设计与实现做分层测试”要求，重构系统性测试手册。
  - 重写 `doc/testing/systematic-application-testing-manual.md`：
    - 新增“当前实现分布（agent_world/viewer/node/net/consensus/distfs）”基线；
    - 新增“CI 现状与缺口”事实口径；
    - 将分层细化为 L0~L5，并落地到 S0~S8 套件命令；
    - 新增“改动路径 -> 必跑套件”针对性矩阵；
    - 补齐 Human/AI 共用执行剧本、充分度标准与失败分诊。
  - 更新 `doc/testing/systematic-application-testing-manual.project.md`：回写盘点、重写、矩阵化与收口任务状态。
- 测试：
  - `./scripts/ci-tests.sh required`
- 遗留事项：
  - 当前手册已覆盖“整应用充分测试”策略；后续可按真实故障统计继续收敛 S8 压测阈值与 S6 UI 闭环断言项。
- 时刻：2026-02-18 20:31:23 CST
- 完成内容：完成 README 生产级三点收口任务 T0（文档初始化）。
  - 新增设计文档：`doc/readme-prod-closure-llm-distfs-consensus.md`。
  - 新增项目管理文档：`doc/readme-prod-closure-llm-distfs-consensus.project.md`。
  - 项目管理文档拆解 T1~T4，当前阶段推进至 T1。
- 测试：
  - 文档任务，无代码测试。
- 遗留事项：
  - 执行 T1：扩展 LLM 决策主链路（市场/制度动作）并补齐 required tests。

- 日期：2026-02-18
- 时刻：2026-02-18 20:51:00 CST
- 完成内容：完成 README 生产级三点收口任务 T1（LLM 决策主链路扩展：市场/制度动作）。
  - `crates/agent_world/src/simulator/llm_agent/decision_flow.rs`：扩展 `agent_submit_decision` 解析，新增并校验以下动作：
    - 市场动作：`buy_power/sell_power/place_power_order/cancel_power_order`。
    - 制度动作：`publish_social_fact/challenge_social_fact/adjudicate_social_fact/revoke_social_fact/declare_social_edge`。
    - 补充 stake/adjudication/ttl/confidence/range 等字段解析与错误信息。
  - `crates/agent_world/src/simulator/llm_agent/openai_payload.rs`：扩展 decision tool 参数 schema（决策 enum + 新字段），并将超大 schema 改为静态 JSON 解析以避免 `serde_json::json!` 递归展开上限。
  - `crates/agent_world/src/simulator/llm_agent/prompt_assembly.rs`：扩展输出 schema 文案与约束，覆盖市场/制度动作模板与参数边界规则。
  - `crates/agent_world/src/simulator/llm_agent/execution_controls.rs`：补齐 `action_signature/actions_same` 对新增动作与 `transfer_resource` 的匹配，避免 `execute_until` 对这些动作无法正确消费执行结果。
  - 测试补齐：
    - `crates/agent_world/src/simulator/llm_agent/tests.rs`：新增市场/制度动作成功路径与关键拒绝路径测试；新增 decision tool schema 覆盖测试。
    - `crates/agent_world/src/simulator/llm_agent/tests_part2.rs`：新增 parse 级别市场/制度动作成功/失败测试，并扩展 prompt 包含项断言。
  - 文档回写：`doc/readme-prod-closure-llm-distfs-consensus.project.md` 标记 T1 完成，阶段切换到 T2。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_parse_`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_parse_`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required prompt_assembly_includes_harvest_max_amount_cap`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required decision_tool_schema_includes_market_and_social_actions`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required llm_agent_prompt_contains_execute_until_and_exploration_guidance`
- 遗留事项：
  - 执行 T2：接入 DistFS-first 持久化主路径（写 sidecar + 优先恢复 + JSON fallback）。

- 日期：2026-02-18
- 时刻：2026-02-18 21:04:56 CST
- 完成内容：完成 T2（DistFS 默认持久化主路径）。
  - `crates/agent_world/src/runtime/world/persistence.rs`：
    - `save_to_dir` 保留 `snapshot.json/journal.json` 兼容写入后，默认追加 DistFS sidecar 写入（`snapshot.manifest.json`、`journal.segments.json`）与 `.distfs-state/` CAS。
    - 增加分段后 assemble 自检：`assemble_snapshot/assemble_journal` 验证恢复结果与内存快照/日志一致，不一致返回 `DistributedValidationFailed`。
    - `load_from_dir` 改为优先 DistFS sidecar 恢复，sidecar 缺失或损坏自动回退 legacy JSON。
  - `crates/agent_world/src/runtime/tests/persistence.rs`：新增回归用例覆盖 sidecar 产物写入、删除 JSON 后恢复、sidecar 损坏时 JSON 兜底。
  - `doc/readme-prod-closure-llm-distfs-consensus.project.md`：回写 T2 完成并切换当前阶段为 T3。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::persistence`
- 遗留事项：
  - 开始执行 T3：live 生产默认 triad 拓扑与 CLI/拓扑测试。

- 日期：2026-02-18
- 时刻：2026-02-18 21:12:42 CST
- 完成内容：完成 T3（live 生产默认拓扑 triad）。
  - `crates/agent_world/src/bin/world_viewer_live/cli.rs`：
    - 增加 `--topology <single|triad>`（默认 `triad`）与 `--triad-gossip-base-port`（默认 5500）。
    - 增加 triad 约束：拒绝 `triad + --no-node`、`triad + --viewer-no-consensus-gate`，并拒绝 triad 下手工 `--node-validator/--node-gossip-*/--node-repl-*` 覆盖。
  - `crates/agent_world/src/bin/world_viewer_live.rs`：
    - `start_live_node` 按拓扑分支启动：`single` 保持旧行为；`triad` 默认启动 `sequencer/storage/observer` 三节点。
    - triad 自动构建 validator 集（34/33/33 stake）与 full-mesh gossip。
    - viewer 共识门控与 reward runtime 统一绑定主节点（sequencer）。
    - 停机流程支持多节点优雅停止。
  - `crates/agent_world/src/bin/world_viewer_live/world_viewer_live_tests.rs`：
    - 更新原有 single 路径测试（显式 `--topology single`）。
    - 新增 triad 默认启动测试与 triad 约束拒绝测试。
  - `doc/readme-prod-closure-llm-distfs-consensus.project.md`：回写 T3 完成并切换阶段到 T4。
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world world_viewer_live_tests`
- 遗留事项：
  - 执行 T4：全量回归（`cargo check` + 定向 tests）并完成最终收口。

- 日期：2026-02-18
- 时刻：2026-02-18 21:14:40 CST
- 完成内容：完成 T4（回归验证与文档收口）。
  - 回归验证通过：
    - 全仓 `cargo check`。
    - T1 定向：LLM 市场/制度动作 schema 覆盖测试。
    - T2 定向：runtime persistence DistFS sidecar 与 JSON fallback 测试。
    - T3 定向：world_viewer_live triad/single CLI 与拓扑测试。
  - `doc/readme-prod-closure-llm-distfs-consensus.project.md`：回写 T4 完成，状态切换为 T0~T4 全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required decision_tool_schema_includes_market_and_social_actions`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::persistence`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world world_viewer_live_tests`
- 遗留事项：
  - 无（README 三点收口任务已全部完成）。
