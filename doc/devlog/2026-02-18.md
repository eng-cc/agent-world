- 日期：2026-02-18
- 时刻：2026-02-18 09:33:54 CST
- 完成内容：完成 AOSA-1（ABI/Schema 合约约束增强）。
  - 新增设计/项目管理文档：
    - `doc/world-runtime/wasm-agent-os-alignment-hardening.md`
    - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`
  - `crates/agent_world_wasm_abi/src/lib.rs`：新增 `ModuleAbiContract`，并在 `ModuleManifest` 引入 `abi_contract` 默认字段。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：新增 ABI 合约校验（`abi_version` 支持版本校验、输入/输出 schema 配对与非空校验）。
  - 全仓 `ModuleManifest` 构造点补齐 `abi_contract: ModuleAbiContract::default()`，保持兼容。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增 ABI 合约拒绝路径测试（版本不支持、schema 配对缺失）。
  - `crates/agent_world/src/runtime/modules.rs`、`crates/agent_world/src/runtime/mod.rs`：补齐 `ModuleAbiContract` 导出。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-1 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_store`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_net`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required shadow_rejects_`
- 遗留事项：
  - 继续执行 AOSA-2：接入 `cap_slot -> cap_ref` 绑定与模块输出解析。

- 日期：2026-02-18
- 时刻：2026-02-18 09:38:20 CST
- 完成内容：完成 AOSA-2（cap slot 绑定）。
  - `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleEffectIntent` 新增可选 `cap_slot`。
  - `crates/agent_world_wasm_sdk/src/lib.rs`：SDK wire `ModuleEffectIntent` 同步新增可选 `cap_slot`。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：
    - 输出处理支持 `cap_slot -> cap_ref` 解析。
    - 若 slot 未绑定、slot 与 `cap_ref` 冲突、或解析后 cap 不在 `required_caps`，统一按 `CapsDenied` 拒绝。
    - `abi_contract.cap_slots` 增加 manifest 校验（slot/cap 非空、且 cap 必须属于 `required_caps`）。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增 slot 成功路径与拒绝路径测试，并补充 cap slot manifest 约束测试。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-2 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_sdk --features wire`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required cap_slot`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
- 遗留事项：
  - 继续执行 AOSA-3：接入 pure 模块策略插件链路。

- 日期：2026-02-18
- 时刻：2026-02-18 09:43:53 CST
- 完成内容：完成 AOSA-3（pure 模块策略插件链路）。
  - `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleAbiContract` 新增 `policy_hooks`。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：
    - 模块调用链路拆分为 raw call + output processing。
    - 在 effect 入队前执行 pure policy hooks 链：
      - 通过 pure 模块 `call` 接口接收策略输入（source/effect/cap 信息）；
      - 约定 `policy.allow` / `policy.deny` emit 表示判定；
      - deny 或异常统一转 `PolicyDenied`。
    - 对 hook 输出施加约束（禁止 state/effects、多 emit）。
    - 对 hook 声明施加 shadow 校验（非空、禁止自引用）。
  - `crates/agent_world/src/runtime/tests/modules.rs`：新增 pure policy allow/deny 闭环测试。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-3 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_required pure_policy_hook`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_abi`
- 遗留事项：
  - 继续执行 AOSA-5：增强 `ModuleContext` 元信息并贯通 event/action/economy 路径。

- 日期：2026-02-18
- 时刻：2026-02-18 09:48:20 CST
- 完成内容：完成 AOSA-5（`ModuleContext` 元信息增强）。
  - `crates/agent_world_wasm_abi/src/lib.rs`：`ModuleContext` 新增可选字段：
    - `stage`、`manifest_hash`、`journal_height`、`module_version`、`module_kind`、`module_role`。
  - `crates/agent_world_wasm_sdk/src/lib.rs`：SDK `wire::ModuleContext` 同步新增可选元信息字段（向后兼容）。
  - `crates/agent_world/src/runtime/world/module_runtime.rs`：
    - event/action/module_policy 路径填充新元信息字段；
    - 增加 `subscription_stage_label/module_kind_label/module_role_label` 辅助映射。
  - `crates/agent_world/src/runtime/world/economy.rs`：economy action wasm 调用路径填充新元信息字段。
  - `crates/agent_world/src/simulator/kernel/mod.rs`：模拟器 pre_action wasm 调用路径填充 stage 与兼容空元信息。
  - `crates/agent_world/tests/module_input_cbor.rs`：扩展输入断言，覆盖新增 context 字段（event/action/pure）。
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-5 状态。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world --features test_tier_required`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_sdk --features wire`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --test module_input_cbor --features test_tier_full`
- 遗留事项：
  - 继续执行 AOSA-6：WasmExecutor 磁盘编译缓存。

- 日期：2026-02-18
- 时刻：2026-02-18 09:53:30 CST
- 完成内容：完成 AOSA-6（`WasmExecutor` 磁盘编译缓存）。
  - `crates/agent_world_wasm_executor/src/lib.rs`：
    - `WasmExecutorConfig` 新增 `compiled_cache_dir: Option<PathBuf>`，可配置磁盘缓存目录。
    - `WasmExecutor` 新增可选 `compiled_disk_cache`，初始化时按执行器配置构建引擎指纹目录。
    - `compile_module_cached` 新增磁盘缓存读写链路：内存缓存未命中时尝试从磁盘反序列化命中；编译成功后将序列化产物写入磁盘缓存。
    - 新增 `DiskCompiledModuleCache`（key 清洗、按引擎指纹分目录）与相关 helper。
    - 磁盘缓存读取失败或反序列化失败时自动删除损坏文件并回退到重新编译。
  - 新增测试：
    - `wasm_executor_disk_cache_hits_when_memory_cache_disabled`
    - `wasm_executor_disk_cache_recovers_from_corruption`
  - `doc/world-runtime/wasm-agent-os-alignment-hardening.project.md`：回写 AOSA-6 状态并标记五项任务全部完成。
- 测试：
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo check -p agent_world_wasm_executor --features wasmtime`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world_wasm_executor --features wasmtime`
- 遗留事项：
  - 当前五项任务已全部完成；后续按新需求再开启下一轮对齐任务。

- 日期：2026-02-18
- 时刻：2026-02-18 10:23:32 CST
- 完成内容：完成“required 接入 m1 builtin wasm hash 校验”任务。
  - 新增设计文档：`doc/testing/ci-required-m1-wasm-hash-check.md`。
  - 新增项目管理文档：`doc/testing/ci-required-m1-wasm-hash-check.project.md`。
  - `scripts/ci-tests.sh`：
    - `run_required_gate_checks` 增加 m1 校验钩子；
    - 在 `CI=true` 或 `AGENT_WORLD_FORCE_M1_WASM_CHECK=1` 时执行 `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`；
    - 非 CI 默认跳过并打印提示，避免本地环境差异导致 required 全流程阻塞。
  - 项目管理文档回写：任务状态更新为已完成。
- 测试：
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`（通过）
  - `CI=true ./scripts/ci-tests.sh required`（触发 m1 校验分支；在本机因 `m1.rule.move` hash 与清单不一致失败，符合当前环境现状）
- 遗留事项：
  - 如需在本机也强制执行 m1 校验，可使用 `AGENT_WORLD_FORCE_M1_WASM_CHECK=1 ./scripts/ci-tests.sh required`；
  - 当前本机 m1 校验失败项：`m1.rule.move`（built `8aec...` vs manifest `7e64...`）。

- 日期：2026-02-18
- 时刻：2026-02-18 10:31:47 CST
- 完成内容：完成“required 本地提交前强制执行 m1 wasm hash 校验”收口任务。
  - `scripts/ci-tests.sh`：
    - `run_required_builtin_wasm_checks` 改为无条件执行 `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`；
    - `required/full` 均通过 `run_required_gate_checks` 覆盖 m1 校验。
  - 文档更新：
    - `doc/testing/ci-required-m1-wasm-hash-check.md`：口径改为“本地与 CI 均强制执行”；
    - `doc/testing/ci-required-m1-wasm-hash-check.project.md`：任务拆解与状态回写为完成。
  - 执行 `./scripts/sync-m1-builtin-wasm-artifacts.sh`，同步当前 m1 hash 清单（`m1.rule.move` 更新为 `8aec...`）并完成 DistFS hydration。
- 测试：
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`（通过）
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`（通过，包含 m1 校验）
- 遗留事项：
  - 观察 GitHub Actions `required-gate` 在 Ubuntu runner 的 m1 校验是否与本次同步后的清单一致。

- 日期：2026-02-18
- 时刻：2026-02-18 10:53:37 CST
- 完成内容：完成“required-gate 跨平台 m1 wasm hash 兼容修复（CI 失败收口）”任务。
  - `scripts/sync-m1-builtin-wasm-artifacts.sh`：
    - manifest 解析支持 `module_id hash1 hash2 ...`；
    - `--check` 改为 built hash 命中任一 hash 即通过；
    - 非 `--check` 同步模式改为“合并已有 hash + 当前构建 hash 并去重”，不再覆盖单值。
  - `crates/agent_world_distfs/src/bin/hydrate_builtin_wasm.rs`：
    - 支持多 hash manifest；
    - hydration 使用 built wasm 实际 sha256 作为入库 key；
    - 若 built hash 不在 manifest 允许列表则报错。
  - `crates/agent_world/src/runtime/builtin_wasm_materializer.rs`：
    - `load_builtin_wasm_with_fetch_fallback` 改为接收候选 hash 列表；
    - DistFS 命中 / fetch fallback / compile fallback 全部支持“任一候选 hash”匹配。
  - `crates/agent_world/src/runtime/m1_builtin_wasm_artifact.rs`、`crates/agent_world/src/runtime/m4_builtin_wasm_artifact.rs`：builtin manifest 解析改为 hash 列表。
  - `crates/agent_world/src/runtime/tests/builtin_wasm_materializer.rs`：测试改为断言实际产物 hash 属于 manifest 候选集合。
  - `crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules.sha256`：补充 Linux runner hash，与现有 macOS hash 并存。
  - 文档回写：
    - `doc/testing/ci-required-m1-wasm-hash-check.md`
    - `doc/testing/ci-required-m1-wasm-hash-check.project.md`
- 测试：
  - `bash -n scripts/sync-m1-builtin-wasm-artifacts.sh`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full materializer_fetch_miss_falls_back_to_compile_and_caches_blob -- --exact`
- 遗留事项：
  - 观察 GitHub Actions `required-gate`（Ubuntu runner）在本次多 hash 清单下是否恢复通过。

- 日期：2026-02-18
- 时刻：2026-02-18 11:10:39 CST
- 完成内容：完成“builtin wasm 构建确定性护栏”任务。
  - 新增设计/项目管理文档：
    - `doc/testing/wasm-build-determinism-guard.md`
    - `doc/testing/wasm-build-determinism-guard.project.md`
  - `scripts/build-wasm-module.sh`：
    - 新增 deterministic guard（默认启用）并强制 canonical 输入：
      - `AGENT_WORLD_WASM_TOOLCHAIN=nightly-2025-12-11`
      - `AGENT_WORLD_WASM_TARGET=wasm32-unknown-unknown`
      - `AGENT_WORLD_WASM_BUILD_STD=1`
      - `AGENT_WORLD_WASM_BUILD_STD_COMPONENTS=std,panic_abort`
      - `AGENT_WORLD_WASM_BUILD_STD_FEATURES=`（空）
    - 拦截继承环境变量以避免本地/CI 漂移（`RUSTFLAGS`、`CARGO_ENCODED_RUSTFLAGS`、`CARGO_BUILD_RUSTFLAGS`、`CARGO_TARGET_DIR`、`RUSTC_BOOTSTRAP` 等）。
    - 统一导出复现友好环境：`CARGO_INCREMENTAL=0`、`SOURCE_DATE_EPOCH=0`、`TZ=UTC`、`LANG/LC_ALL=C`。
  - `tools/wasm_build_suite/src/lib.rs`：
    - `cargo metadata` 与 `cargo build` 增加 `--locked`。
    - 新增 workspace 编译期拦截：默认拒绝 workspace 本地 package 含 `build.rs(custom-build)` 或 `proc-macro` 目标，防止编译期环境/时间/主机信息耦合进入 wasm 模块构建链路。
    - 新增对应单元测试（reject build.rs、allow external proc-macro）。
  - 为 `--locked` 场景补齐模板 lockfile：
    - `tools/wasm_build_suite/templates/minimal_module/Cargo.lock`
- 测试：
  - `bash -n scripts/build-wasm-module.sh`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `env -u RUSTC_WRAPPER cargo test --manifest-path tools/wasm_build_suite/Cargo.toml`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 继续观察 CI 上 Linux runner 在新的 deterministic guard 下是否稳定复现 m1/m4 hash 清单。

- 日期：2026-02-18
- 时刻：2026-02-18 11:21:27 CST
- 完成内容：完成“builtin wasm 清单策略收敛为每平台 1 个 canonical hash”任务。
  - 新增设计/项目管理文档：
    - `doc/testing/wasm-platform-canonical-hash-manifest.md`
    - `doc/testing/wasm-platform-canonical-hash-manifest.project.md`
  - `scripts/sync-m1-builtin-wasm-artifacts.sh`：
    - 清单 token 解析支持 `platform=hash`（兼容 legacy 裸 hash）；
    - `--check` 在 keyed 模式下改为仅校验当前平台 canonical hash；
    - 同步模式在 keyed 模式下仅更新当前平台 hash，不再追加任意新 hash；
    - 增加平台集合约束与重复平台校验（默认 `darwin-arm64,linux-x86_64`，可由 `AGENT_WORLD_WASM_CANONICAL_PLATFORMS` 覆盖）。
  - `crates/agent_world/src/runtime/m1_builtin_wasm_artifact.rs`、`crates/agent_world/src/runtime/m4_builtin_wasm_artifact.rs`：清单 token 解析支持 `platform=hash`（兼容 legacy）。
  - `crates/agent_world_distfs/src/bin/hydrate_builtin_wasm.rs`：manifest 解析支持 `platform=hash` token。
  - `crates/agent_world/src/runtime/tests/builtin_wasm_materializer.rs`：测试清单解析支持 `platform=hash` token。
  - `crates/agent_world/src/runtime/world/artifacts/m1_builtin_modules.sha256`：迁移为 keyed 格式（`darwin-arm64=... linux-x86_64=...`）。
- 测试：
  - `bash -n scripts/sync-m1-builtin-wasm-artifacts.sh`
  - `env -u RUSTC_WRAPPER cargo fmt --all`
  - `./scripts/sync-m1-builtin-wasm-artifacts.sh --check`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --features test_tier_full materializer_fetch_miss_falls_back_to_compile_and_caches_blob -- --exact`
  - `CI_VERBOSE=1 ./scripts/ci-tests.sh required`
- 遗留事项：
  - 后续若需要支持新平台（如 `linux-arm64`）需先将平台键加入 `AGENT_WORLD_WASM_CANONICAL_PLATFORMS` 并补齐对应 canonical hash。

- 日期：2026-02-18
- 时刻：2026-02-18 11:35:13 CST
- 完成内容：完成 MMD9.1（TODO-22）`execute_until` 动作匹配补齐，修复 `mine_compound/refine_compound` 路径在动作失败后仍继续 auto step 的问题。
  - 代码：`crates/agent_world/src/simulator/llm_agent/execution_controls.rs`
  - 变更：`actions_same` 新增 `mine_compound/refine_compound` 匹配，并放宽 `harvest_radiation/schedule_recipe` 对参数差异的匹配（保留关键标识匹配），确保 `update_from_action_result` 能准确消费拒绝回执。
- 完成内容：补齐 required-tier 回归测试并通过。
  - 测试文件：`crates/agent_world/src/simulator/llm_agent/tests_part2.rs`
  - 新增用例：`llm_agent_execute_until_stops_on_action_rejected_for_mine_compound`
- 完成内容：更新 MMD9 增量文档与项目状态，标记 MMD9.1 完成。
  - 文档：
    - `doc/world-simulator/llm-industrial-mining-debug-tools.md`
    - `doc/world-simulator/llm-industrial-mining-debug-tools.project.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world llm_agent_execute_until_stops_on_ --features test_tier_required -- --nocapture`
- 遗留事项：
  - 继续执行 MMD9.2（TODO-23）：补 `schedule_recipe` 工厂-配方兼容校验与 kernel 回归。

- 日期：2026-02-18
- 时刻：2026-02-18 11:42:06 CST
- 完成内容：完成 MMD9.2（TODO-23）`schedule_recipe` 工厂-配方兼容校验，阻断 power factory 调度 assembler recipe。
  - 代码：`crates/agent_world/src/simulator/kernel/actions.rs`
  - 变更：`RecipePlan` 增加 `required_factory_kind`，`Action::ScheduleRecipe` 在配方解析后新增工厂类型匹配校验；当前 assembler 配方统一要求 `factory.assembler.mk1`。
- 完成内容：补齐 kernel 回归测试并通过。
  - 测试文件：`crates/agent_world/src/simulator/tests/kernel.rs`
  - 新增用例：`schedule_recipe_rejects_incompatible_factory_kind`
- 完成内容：更新项目管理文档状态，标记 MMD9.2 与 TODO-23 完成。
  - 文档：`doc/world-simulator/llm-industrial-mining-debug-tools.project.md`
- 测试：
  - `env -u RUSTC_WRAPPER cargo test -p agent_world schedule_recipe_ --features test_tier_required -- --nocapture`
- 遗留事项：
  - 继续执行 MMD9.3（TODO-24）：增加采矿失败记忆优先级，减少耗尽矿点重复重试。
