日期: 2026-02-14

完成内容:
1. 完成 M4-E8「Product 校验自动闭环」。
   - 在 `step_with_modules` 的到期配方结算路径接入自动 Product 校验。
   - 新增 `process_due_economy_jobs_with_modules`，在 `RecipeCompleted` 入账前逐项校验产物。
   - 产物模块解析策略：优先命中内置 `m4.product.*` 显式映射，再回退到 `*.product.*.<product_kind>` 后缀匹配扩展模块。
   - 对 Product 模块调用请求做兼容封装（同时携带 `ProductValidationRequest` 与 legacy `kind/amount` 字段），兼容旧模块与新 ABI。
2. 实现入账门禁。
   - 若任一产物校验失败，记录 `ActionRejected(RuleDenied)`，并阻断该批次产物与副产物入库。
   - 配方任务仍会完成结算并从 pending 队列移除，避免重复重放同一失败任务。
3. 补充回归测试。
   - `schedule_recipe_with_module_auto_validates_outputs_before_commit`
   - `schedule_recipe_with_module_blocks_commit_when_product_validation_fails`
4. 回写文档。
   - 更新 `doc/m4-industrial-economy-wasm.md`（动作协议与自动校验进展）
   - 更新 `doc/m4-industrial-economy-wasm.project.md`（E8 勾选完成）
   - 更新 `doc/world-simulator.md` 与 `doc/world-simulator.project.md` 的 M4 状态
5. 测试通过。
   - `cargo fmt --all`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world runtime::tests::economy -- --nocapture`
   - `env -u RUSTC_WRAPPER cargo test -p agent_world --features wasmtime runtime::tests::economy -- --nocapture`
   - `env -u RUSTC_WRAPPER cargo check -p agent_world --features wasmtime`

遗留事项:
1. M4-E5 后续工作：完善玩家/AI 自定义经济模块的治理模板与提交规范（shadow 验证指标、审计输出模版）。
# 2026-02-14 任务日志（CI 测试分级 T2-T4）

## 日期
- 2026-02-14

## 完成内容
- 改造 `scripts/ci-tests.sh`：新增测试分级参数 `required/full`，并保留默认 `full` 以兼容旧调用。
- 调整 `scripts/pre-commit.sh`：提交钩子从全量切换为 `./scripts/ci-tests.sh required`。
- 调整 `.github/workflows/rust.yml`：
  - `push/pull_request` 仅跑 `required-gate`。
  - 新增每日定时 `schedule`（`0 3 * * *`）与手动触发 `workflow_dispatch` 跑 `full-regression`。
- 回写文档：
  - `doc/scripts/pre-commit.md`
  - `doc/testing/ci-test-coverage.md`
  - `doc/testing/ci-tiered-execution.project.md`
- 运行验证：
  - `bash -n scripts/ci-tests.sh scripts/pre-commit.sh`
  - `./scripts/ci-tests.sh invalid-tier`（参数校验）
  - `./scripts/ci-tests.sh required`

## 遗留事项
- 若后续需要进一步缩短 `required` 耗时，可在下一阶段引入按 crate/路径增量测试策略。
