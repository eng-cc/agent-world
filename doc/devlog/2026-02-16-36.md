- 日期：2026-02-16
- 完成内容：修复 Viewer WebSocket bridge 仅首连可用、页面刷新后无法重连的问题。
  - 更新 `crates/agent_world/src/viewer/web_bridge.rs`：
    - bridge 断连退出时显式 `shutdown(Shutdown::Both)` upstream socket，并 `join` 上游读线程，避免上游会话被悬挂占用。
    - `run()` 中 listener `accept` 错误改为记录后继续，避免瞬时网络错误导致 bridge 进程退出。
    - 收到 `Close` 帧时将 `ConnectionClosed/AlreadyClosed` 视为正常关闭路径，避免误判错误。
    - 新增测试 `bridge_allows_reconnect_after_websocket_refresh`，覆盖“首连接断开后可继续二次连接转发”。
  - 更新 `doc/world-simulator/viewer-websocket-http-bridge.md`：补充 `ws disconnect -> upstream cleanup` 连接回收约束。
  - 更新 `doc/world-simulator/viewer-websocket-http-bridge.project.md`：新增 WLB5（连接稳定性修复）并标记完成。
  - 更新 `doc/world-simulator.project.md`：登记“Viewer Web bridge 刷新重连稳定性修复”已完成。
- 完成内容：执行并通过回归验证。
  - `env -u RUSTC_WRAPPER cargo test -p agent_world bridge_allows_reconnect_after_websocket_refresh --features test_tier_required -- --nocapture`
  - `env -u RUSTC_WRAPPER cargo test -p agent_world --tests --features test_tier_required`
- 遗留事项：可后续补充 bridge 慢消费者与并发连接压力测试，验证极端网络抖动下的稳定性。
# 2026-02-16 任务日志（Node 主循环基础模块：DNM-2）

## 日期
- 2026-02-16

## 完成内容
- 新增独立 crate：`/Users/scc/.codex/worktrees/ee97/agent-world/crates/node`（包名 `node`）。
- 在 `node` crate 落地最小主循环基础能力：
  - `NodeRole`（`sequencer/storage/observer`）及字符串解析。
  - `NodeConfig`（`node_id/world_id/tick_interval/role`）及配置校验。
  - `NodeRuntime` 生命周期接口（`start/stop/snapshot`）。
  - `NodeSnapshot` 运行态快照（运行状态、tick 数、最后 tick 时间）。
  - `NodeError` 错误类型。
- 新增单元测试，覆盖角色解析、启动停止、重复启动拒绝。
- 更新 workspace 成员，接入 `crates/node`。
- 回写项目管理文档，标记 DNM-2 完成并推进到 DNM-3。

## 测试
- `env -u RUSTC_WRAPPER cargo test -p node`

## 遗留事项
- 继续执行 DNM-3：在 `world_viewer_live` 启动流程接入节点自动启动，并补齐 CLI 参数解析测试。
