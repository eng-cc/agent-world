# Viewer Web 可操作性与舒适度加固（2026-02-22）

## 目标
- 修复 Web Viewer 在窄屏条件下主画布被右侧双面板挤压的问题，确保最小可操作画布宽度。
- 修复 websocket 错误回调类型不匹配导致的前端运行时异常，避免二次噪声错误。
- 为连接异常提供自动重连与更友好的状态文案，降低用户排障成本并提升连续使用体验。

## 范围
- 仅修改 `crates/agent_world_viewer` 的 UI 面板布局、websocket 错误处理与连接恢复逻辑。
- 仅覆盖问题 1/2/3：
  - 1）窄屏双面板可操作性问题。
  - 2）WebSocket `onerror` 类型错误问题。
  - 3）连接失败后恢复能力与提示文案问题。
- 不包含主题美术风格重做、功能模块增删、协议字段变更。

## 接口/数据
- 新增右侧面板“窄屏紧凑模式”判定与总宽预算逻辑：
  - 输入：`available_width`、模块显隐状态。
  - 输出：是否启用侧边聊天面板、主面板最大宽度、实际占用宽度。
- 调整 websocket 错误回调签名：
  - 从 `ErrorEvent` 宽泛假设，改为 `Event` + 可选 `ErrorEvent` 安全提取。
- 新增连接恢复状态：
  - 重连状态（尝试次数、下次尝试时刻、最后一次可重连错误签名）。
  - 错误文案标准化方法（技术错误 -> 用户可理解文案）。

## 里程碑
- M1：完成设计与任务拆解文档。
- M2：完成窄屏布局优化 + 单元测试。
- M3：完成 websocket 错误回调修复 + wasm 编译检查。
- M4：完成自动重连与友好提示 + 连接相关测试。
- M5：完成回归测试、项目文档状态回写与 devlog 收口。

## 里程碑状态（2026-02-22 收口）
- [x] M1：设计与任务拆解完成。
- [x] M2：窄屏布局优化与相关测试完成。
- [x] M3：websocket `onerror` 类型修复与 wasm 检查完成。
- [x] M4：自动重连与友好错误提示完成，并补连接行为测试。
- [x] M5：required 回归、项目文档与 devlog 收口完成。

## 风险
- 自动重连可能在服务端短时间不可用时引发频繁重建连接；需使用退避策略并设最大间隔。
- 紧凑模式隐藏侧边聊天后，聊天可见性路径变化；需确保聊天模块仍可在主面板内访问。
- 错误文案标准化若匹配过度，可能掩盖底层问题细节；应保留原始错误兜底。
