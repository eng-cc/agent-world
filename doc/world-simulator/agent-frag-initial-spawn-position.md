# Agent World Simulator：Agent Frag 初始站位优化（设计文档）

## 目标
- Agent 初始位置优先生成在 `frag` 附近，缩短开局采矿路径。
- Agent 初始坐标在数据初始化阶段直接生成于 `frag` 上方，并与 `frag` 表面保持约 50m 间距。
- 在 2D 视角下减少 Agent 与 frag 的重叠遮挡，提高开局可见性。
- 保持确定性：同 seed、同场景输入，生成同样的出生地点与坐标。

## 范围

### In Scope
- 调整 `build_world_model` 出生候选地点策略：当世界中存在 `frag-*` 地点时，优先从 `frag` 集合选取出生地点。
- 在初始化阶段为出生在 frag 的 Agent 生成偏移坐标（上方 + 约 50m 表面间距）。
- 边界保护：当理想坐标越界时，采用确定性降级策略，在空间边界内尽量满足“上方 + 间距”目标。
- 补充初始化测试，覆盖 frag 优先出生和坐标偏移语义。

### Out of Scope
- 运行时移动/采矿规则重构。
- Viewer 渲染层位置补偿逻辑。
- 非 frag 场景下的出生策略大改。

## 接口 / 数据
- 不新增外部配置字段，复用现有 `WorldInitConfig` 与 `LocationProfile.radius_cm`。
- 内部规则：
  - frag 判定：`location_id` 以 `frag-` 前缀开头。
  - frag 出生目标距离：`center_distance = radius_cm + 5_000cm`（约 50m 表面间距）。
  - 方向策略：以“向上分量优先”的确定性方向生成（基于 seed/agent index 派生），同时保留少量水平分量避免重叠。
  - 越界降级：在不破坏确定性的前提下递减间距/上仰角，仍不可用则回退到 frag 中心。

## 里程碑
- FSP1：设计文档与项目管理文档落地。
- FSP2：初始化逻辑改造（frag 优先 + 站位偏移）。
- FSP3：测试回归、文档收口与开发日志更新。

## 风险
- Agent `location_id` 与几何坐标不完全重合时，观测距离可能与“地点归属”语义出现偏差。
- 极端边界（超大半径 frag 靠近边缘）下，50m 目标可能需要降级。
- 出生点从 region 转为 frag 可能影响既有场景的开局行为节奏，需要通过测试稳定约束。
