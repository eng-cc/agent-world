# Viewer 发行体验改造（第九阶段：指挥链路前置与顶层减噪）

## 目标
- 继续降低 Player 首屏 UI 压力，消除顶部叠层竞争，让世界画面保持第一视觉焦点。
- 保证“玩家随时可指挥 Agent”是隐藏态下的一步操作，不需要先进入中间层再找 Chat。
- 在保留布局预设能力的同时，把其从“常驻干扰”改成“展开态高级能力”。

## 范围
- `crates/agent_world_viewer` Player 模式体验层调整：
  - 顶部布局预设条从隐藏态移除，仅在面板展开态展示，并下移锚点避免与顶部 HUD 叠压。
  - 在任务 HUD（隐藏态）增加“直接指挥 Agent”动作，点击后直接切到 Command 预设（展开面板+打开 Chat）。
  - 增加纯函数测试覆盖，确保新显示策略与一键指挥策略可回归验证。
- 不改动 Director 模式行为。

## 非目标
- 不改动仿真协议、事件语义、后端链路。
- 不改动 `third_party`。
- 不在本阶段引入重资产特效系统与复杂动画框架。

## 接口/数据

### 复用状态
- `RightPanelLayoutState`：决定面板隐藏/展开状态，驱动“布局预设条显隐”和“任务 HUD 指挥动作”显隐。
- `RightPanelModuleVisibilityState`：用于应用 Command 预设时切换 Chat/Timeline/Details 可见性。
- `PlayerGuideStep` 与 `PlayerGuideProgressSnapshot`：维持任务目标与动作按钮的语义一致性。

### 新增/调整行为
- 顶部布局预设条策略：
  - 隐藏态不显示。
  - 展开态显示，并使用下移锚点避免与 compact HUD 同层竞争。
- 隐藏态任务 HUD 策略：
  - 新增“直接指挥 Agent”按钮。
  - 点击后直接应用 `PlayerLayoutPreset::Command`，保证 Chat 入口一步可达。

## 里程碑
- M1：第九阶段建档完成（设计 + 项管）。
- M2：顶部布局预设条减噪策略完成并有单测覆盖。
- M3：隐藏态任务 HUD 一键指挥入口完成并有单测覆盖。
- M4：回归测试、Web 闭环验收与文档收口完成。

## 风险
- 风险 1：隐藏态移除布局预设条后，玩家可能不易发现“布局切换”能力。
  - 对策：该能力保留在展开态，且隐藏态强调“直接指挥 Agent”主路径。
- 风险 2：新增任务 HUD 按钮过多导致操作犹豫。
  - 对策：仅在隐藏态显示“直接指挥 Agent”，展开态不重复显示。
- 风险 3：布局锚点调整引入新的 UI 叠压。
  - 对策：把显隐/锚点规则抽成纯函数并补充定向单测。
