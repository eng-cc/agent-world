# M4 产业链借鉴点（结合当前实现现状，2026-02-27）

## 目标
- 基于当前 `agent_world` 已落地机制，整理一份可直接进入实现排期的产业链借鉴清单。
- 借鉴重点不做“概念对照”，而是落到当前代码可接入的数据结构、动作、事件与测试口径。
- 给出优先级与分阶段落地路径，避免一次性扩链导致复杂度失控。

## 当前现状基线

### 1) 资源分层现状（已落地）
- 内建资源已收敛为最小集合：`Electricity`、`Data`（`simulator::ResourceKind`）。
- 产业资源已转为材料字符串账本表达（`runtime::material_ledgers`），由模块定义语义。
- 这意味着当前架构已经具备“核心资源稳定 + 产业资源可扩展”的分层基础。

### 2) 工业链路现状（已落地）
- M4 已形成最小闭环：`矿料 -> 冶炼/装配 -> 终端制成品`。
- 内置模块链路已包含：
  - 工厂：`m4.factory.{miner,smelter,assembler}.mk1`
  - 配方：`iron_ingot/copper_wire/gear/control_chip/motor_mk1/logistics_drone`
  - 产物校验：`iron_ingot/control_chip/motor_mk1/logistics_drone`
- `ScheduleRecipeWithModule` 已接入“配方求值 + 自动 Product 校验 + 入账门禁”。

### 3) 物流与空间约束现状（已落地）
- 多账本模型已支持 `world/agent/site/factory` 四类账本。
- `TransferMaterial` 已具备距离、损耗、在途延迟、并发上限约束：
  - 最大距离 `10_000 km`
  - 损耗 `5 bps/km`
  - 速度 `100 km/tick`
  - 在途上限 `2`
- 该约束已经把“是否跨区生产”变成真实策略问题。

### 4) 经济制度现状（已落地）
- 电力市场已改为纯供需定价口径。
- 工厂维护/折旧/回收闭环存在。
- 数据采集与访问控制、合约结算、防刷与治理税费已接线。

### 5) 当前主要缺口（面向下一阶段）
- 产业链深度偏浅：终端品数量和中间件层级仍少，瓶颈竞争不明显。
- 物流策略深度不足：在途上限和损耗已存在，但缺少“优先级/时效承诺/运力类型”差异。
- 市场联动不足：材料价格与运输风险、治理策略、稀缺区域尚未形成强耦合反馈。
- 新手到规模化的节奏层次不足：存在闭环，但“开局引导 -> 中期扩产 -> 后期博弈”分层不够清晰。

## 范围

### In Scope
- 提炼可直接对接当前 runtime/simulator 的产业链借鉴点。
- 输出 P0/P1/P2 优先级与最小实现切口。
- 给出每个借鉴点的接口增量建议与验收口径。

### Out of Scope
- 本文档不直接提交代码实现。
- 不新增跨服结算与复杂金融衍生品。
- 不在本轮重构 viewer 大版本交互。

## 接口 / 数据

### A. 现有接口锚点（保持不变）
- Action：`BuildFactoryWithModule`、`ScheduleRecipeWithModule`、`ValidateProductWithModule`、`TransferMaterial`
- DomainEvent：`Factory*`、`Recipe*`、`ProductValidated`、`MaterialTransit*`
- State：`material_ledgers`、`pending_recipe_jobs`、`pending_material_transits`、`gameplay_policy`

### B. 借鉴点对应的最小增量接口建议

| 借鉴点 | 最小接口增量 | 验收事件/状态 |
| --- | --- | --- |
| 共享中间件瓶颈 | 在 `FactoryModuleSpec/RecipeExecutionPlan` 增加可选 `bottleneck_tags` | 产线拒绝率、排队长度、缺料分布 |
| 运输优先级 | `TransferMaterial` 增加 `priority`（标准/紧急） | `MaterialTransitStarted` 携带优先级与预计 SLA |
| 产线耗损与回收 | `RecipeCompleted` 增加可选 `wear_delta`/`recycle_hint` | 工厂耐久变化与回收产率关联 |
| 区域稀缺度驱动 | chunk/location 增加材料稀缺度快照字段 | 同配方跨区域成本差可观测 |
| 市场联动 | 为材料交易补充报价事件（可先只做观测） | 价格、运损、税费三元联动曲线 |
| 新手节奏引导 | 增加“阶段目标”状态（非强制） | 阶段达成率与卡点分布 |

## 里程碑

### M0（本轮，已完成）
- 完成“当前现状基线 + 借鉴点 + 接口增量 + 优先级”文档化。

### M1（P0：2 周）
- 建立“共享中间件瓶颈 + 运输优先级”最小闭环。
- 目标：同一批材料在不同任务间产生真实抢占与等待。

### M2（P1：2~3 周）
- 建立“产线耗损/回收 + 区域稀缺差异”闭环。
- 目标：让“在哪里生产、是否本地回收”成为持续决策。

### M3（P2：2~3 周）
- 建立“材料市场观测 + 治理联动 + 阶段引导”闭环。
- 目标：把经济、治理、玩家目标引导串成可量化反馈环。

## 可借鉴点清单（按优先级）

### P0-1 共享中间件竞争
- 借鉴点：多条终端链共享少量关键中间件，形成天然瓶颈与策略博弈。
- 结合现状：当前已有 `iron_ingot/copper_wire/control_chip/motor_mk1`，可直接指定 1~2 个为全链共同依赖。
- 最小落地：先不加新品类，只调整现有配方依赖图并补冲突测试。

### P0-2 物流时效分层
- 借鉴点：同样的运输动作，按优先级和 SLA 形成成本/时效权衡。
- 结合现状：当前已有在途与损耗，补充优先级即可形成调度深度。
- 最小落地：`TransferMaterial.priority` + 在途队列排序策略 + SLA 观测日志。

### P1-1 产线耗损与回收耦合
- 借鉴点：高吞吐带来更高维护/报废压力，形成长期资源回收循环。
- 结合现状：已有 `FactoryDurabilityChanged` 与 `FactoryRecycled`，仅需把配方执行强度和耐久变化关联。
- 最小落地：按配方批次/复杂度追加耐久折损系数。

### P1-2 区域稀缺度驱动的选址
- 借鉴点：不同区域对不同材料友好，迫使玩家构建跨区供应链。
- 结合现状：已有 fragment/chunk 预算与补给机制，可叠加“材料产率偏置”。
- 最小落地：先做两类区域偏置并固化在 scenario。

### P2-1 市场与治理联动
- 借鉴点：价格不只由供需决定，还受运输损耗、税费、风险区影响。
- 结合现状：供需定价、税费、禁区已在；缺的是材料侧报价观测。
- 最小落地：先增加观测事件，不先做复杂撮合。

### P2-2 阶段化目标引导
- 借鉴点：把开局生存、中期扩产、后期博弈目标显式化，降低新手断档。
- 结合现状：已有 frag 新生机制与 LLM 行为守卫，可加轻量阶段状态。
- 最小落地：仅做“阶段达成提示 + 卡点指标”，不强制脚本化玩法。

## 风险
- 规则耦合风险：产业、物流、治理同步改动容易放大回归面。
- 经济失衡风险：瓶颈过强会导致早期停摆；过弱则无法形成策略深度。
- 观测不足风险：没有统一指标会导致“改了但无法判断是否更好”。
- 测试成本风险：跨模块闭环用例增长快，需要明确 required/full 分层。

## 推荐验收口径（供后续阶段复用）
- `test_tier_required`：
  - 共享中间件冲突与拒绝路径。
  - 运输优先级排序与 SLA 基本正确性。
- `test_tier_full`：
  - 端到端多工厂、多账本、跨区运输、治理税费联合回归。
  - 长跑场景下的耐久/回收/库存守恒与事件可回放一致性。
