# Viewer 3D 精致化与性能优化设计

## 目标
- 将当前偏“调试风格”的 3D 画面升级为更稳定、层次更清晰、视觉更统一的观察界面。
- 在不牺牲现有可观测性（事件、诊断、联动）的前提下，降低渲染与 UI 同帧负载，提高复杂场景下帧稳定性。
- 建立“画质与性能可配置”的分层能力（调试档、默认档、高质量档），避免后续优化只能二选一。

## 现状与问题（针对当前实现）
- 对象渲染以基础几何体+基础材质为主，空间层次（远近、光影、重点对象）不够明显。
- 标签与覆盖层在对象数量上升时信息密度偏高，影响阅读且增加渲染压力。
- 世界网格/Chunk 线框按实体逐条构建，场景规模增大时实体数量和 draw call 成本上升。
- 缺少统一性能预算与可视化采样指标，优化效果不易量化回归。

## 范围

### 范围内
- 视觉精致化：光照、材质、对象层级、选中反馈、标签可读性与遮挡策略。
- 性能优化：场景实体组织、覆盖层渲染策略、标签/线框 LOD、更新节流与增量刷新。
- 质量分档：引入运行时画质档位与参数集（默认兼容当前行为）。
- 性能可观测：帧时间、关键系统耗时、对象计数、覆盖层开销摘要。

### 范围外
- 不引入复杂外部美术资产管线（高模/贴图烘焙/动画资源生产）。
- 不修改 viewer 协议主结构和 simulator 物理内核逻辑。
- 不在本阶段引入跨客户端协同渲染或云端流式渲染。

## 接口 / 数据

### 1) 渲染质量配置（Viewer 侧）
- 新增 `ViewerRenderQualityConfig`（草案）：
  - `profile`: `Debug | Balanced | High`
  - `enable_dynamic_shadows`: 是否启用动态阴影
  - `label_distance_fade`: 标签距离淡出阈值
  - `overlay_lod_distance`: 覆盖层远距降级阈值
  - `max_visible_labels`: 同屏标签上限（超限按优先级裁剪）
  - `line_render_mode`: `EntityLines | BatchedLines`
- 环境变量覆盖（草案）：`AGENT_WORLD_VIEWER_RENDER_PROFILE`、`AGENT_WORLD_VIEWER_MAX_VISIBLE_LABELS` 等。

### 2) 场景视觉分层
- 对象层次：将 Agent、Location、设施、覆盖层拆分视觉层级，统一色彩与亮度约束。
- 选中反馈：从“仅缩放”扩展为“缩放 + 轮廓/光晕 + 信息聚焦”。
- 标签策略：
  - 近景显示完整标签；
  - 中景缩略标签；
  - 远景隐藏或聚合统计；
  - 被遮挡对象标签降权。

### 3) 性能采样与预算
- 新增 `ViewerPerfBudget`（草案）：
  - `frame_time_ms_p95`
  - `max_draw_calls`
  - `max_world_entities`
- 在 UI 总览中增加渲染采样摘要：`avg/p95 frame ms`、对象数、标签数、覆盖层开关成本。
- 与现有截图闭环脚本联动，补充“同场景多档位”快照对比入口。

### 4) 数据更新策略
- 保持 `WorldSnapshot + WorldEvent` 协议不变。
- 对渲染层增加“脏区更新”标记：
  - 对象 transform/material 变化才更新；
  - 覆盖层按事件类型触发局部重算；
  - 非关键 UI 摘要按节流周期刷新。

## 里程碑
- **VPP-1（基线与量化）**
  - 建立性能基线脚本与场景样本（`triad_p2p_bootstrap`、`llm_bootstrap`）。
  - 明确预算：默认档 `p95 frame <= 22ms`（典型开发机），并记录对象规模。
- **VPP-2（视觉精致化）**
  - 完成统一光照与材质参数整理。
  - 完成对象层级、选中反馈、标签显示策略升级。
- **VPP-3（渲染性能优化）**
  - 完成线框/覆盖层批处理改造与 LOD。
  - 完成高频 UI/覆盖层更新节流与脏区刷新。
- **VPP-4（分档与回归）**
  - 完成 `Debug/Balanced/High` 档位接入与默认档验证。
  - 完成测试、截图闭环、文档收口和项目状态更新。

## 验收口径（首版）
- 视觉：在同一场景下，关键对象（Agent/Location/设施）可在单屏快速区分，选中目标可在 1 次点击后稳定聚焦。
- 性能：默认档在 `llm_bootstrap` 连续运行时，帧时间抖动显著低于现状（以基线记录对比，目标 p95 降低 ≥20%）。
- 稳定性：2D/3D 切换、时间轴联动、右侧面板功能不退化，现有测试集通过。

## 风险
- 视觉增强过度导致信息噪声上升：需以“可观察性优先”约束视觉效果强度。
- 批处理改造可能影响拾取与选中语义：需先保留兼容路径，分阶段替换。
- 性能收益受硬件差异影响明显：需固定场景、固定档位、固定统计窗口对比。
- 主文件继续膨胀接近上限：实施中需同步模块拆分，避免单文件超过规范阈值。
